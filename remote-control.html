<!DOCTYPE html>
<html lang="en">
<head>

  <!-- PWA -->
<link rel="manifest" href="/IPTV-/manifest.webmanifest">
<meta name="theme-color" content="#000000">

<!-- App icons (Android + desktop) -->
<link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png">

<!-- iOS Add to Home Screen -->
<link rel="apple-touch-icon" sizes="180x180" href="/IPTV-/icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="IPTV Remote">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>IPTV Remote — Dealership Scoped (5 Channels)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { background: #000; color: #fff; font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }

    /* Simple Login */
    .login { width: 100%; max-width: 280px; text-align: center; }
    .login h1 { font-size: 42px; margin-bottom: 40px; }
    .login input { width: 100%; padding: 15px; margin-bottom: 15px; background: #111; border: none; border-radius: 12px; color: #fff; font-size: 16px; text-align: center; }
    .login input::placeholder { color: #444; }
    .login button { width: 100%; padding: 15px; background: #fff; color: #000; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }

    /* Remote Control */
    .remote { display: none; width: 100%; max-width: 320px; background: #111; border-radius: 40px; padding: 30px 25px 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
    .remote.active { display: block; }

    /* Power + Display */
    .power { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .power-btn { width: 100px; height: 30px; border-radius: 24px; background: #d32f2f; border: none; font-size: 14px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .power-btn:active { background: #b71c1c; }
    .display-name { font-size: 16px; color: #999; cursor: pointer; }

    /* Screen */
    .screen { background: #000; border: 2px solid #222; border-radius: 20px; padding: 25px; margin-bottom: 30px; text-align: center; }
    .channel-number { font-size: 50px; font-weight: 500; line-height: 1; color: #0f0; font-family: 'Courier New', monospace; }

    /* Numpad (5 channels) */
    .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
    .num-btn { aspect-ratio: 1.5; background: #222; border: none; border-radius: 15px; color: #ffffff; font-size: 25px; font-weight: 900; cursor: pointer; position: relative; }
    .num-btn:active { background: #333; transform: scale(0.95); }
    .num-btn span { display: block; font-size: 10px; margin-top: 2px; color: #666; text-transform: uppercase; letter-spacing: 1px; }

    /* Volume & Channel */
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
    .control-group { text-align: center; }
    .control-label { font-size: 15px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .control-btns { display: flex; flex-direction: column; gap: 10px; }
    .ctrl-btn { padding: 12px; background: #222; border: none; border-radius: 10px; color: #fff; font-size: 25px; cursor: pointer; }
    .ctrl-btn:active { background: #333; }

    /* Mute Button */
    .mute-btn { width: 100%; padding: 15px; background: #222; border: none; border-radius: 15px; color: #ffffff; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; margin-bottom: 20px; }
    .mute-btn:active { background: #333; }
    .mute-btn.muted { background: #d32f2f; color: #fff; }

    /* Display Selector */
    .displays { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; background: rgba(0,0,0,0.9); border-radius: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .displays.show { opacity: 1; pointer-events: all; }
    .display-btn { padding: 8px 16px; background: #222; border: none; border-radius: 10px; color: #bbb; font-size: 12px; cursor: pointer; }
    .display-btn.active { background: #0f0; color: #000; }

    /* Toast */
    .toast { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: #0f0; color: #000; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="login" id="login">
    <img src="https://i.ibb.co/LzJwPhjg/ICON-IPTV.png" alt="Logo" style="width:100px; height:auto;">
    <input type="email" id="email" placeholder="Email" autocomplete="email" />
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
    <button onclick="signIn()">ENTER</button>
  </div>

  <!-- Remote -->
  <div class="remote" id="remote">
    <div class="power">
      <button class="power-btn" onclick="powerOff()">Sign out</button>
      <div class="display-name" id="currentDisplay" onclick="showDisplays()">DISPLAY</div>
    </div>

    <div class="screen">
      <div class="channel-number" id="channelDisplay">1</div>
    </div>

    <!-- First 5 channels only -->
    <div class="numpad">
      <button class="num-btn" onclick="setChannel(1)">1<span>News</span></button>
      <button class="num-btn" onclick="setChannel(2)">2<span>Sports</span></button>
      <button class="num-btn" onclick="setChannel(3)">3<span>Cooking</span></button>
      <button class="num-btn" onclick="setChannel(4)">4<span>Nature</span></button>
      <button class="num-btn" onclick="setChannel(5)">5<span>Kids</span></button>
    </div>

    <div class="controls">
      <div class="control-group">
        <div class="control-label">VOL</div>
        <div class="control-btns">
          <button class="ctrl-btn" onclick="volUp()">+</button>
          <button class="ctrl-btn" onclick="volDown()">−</button>
        </div>
      </div>
      <div class="control-group">
        <div class="control-label">CH</div>
        <div class="control-btns">
          <button class="ctrl-btn" onclick="chUp()">▲</button>
          <button class="ctrl-btn" onclick="chDown()">▼</button>
        </div>
      </div>
    </div>

    <button class="mute-btn" id="muteBtn" onclick="toggleMute()">MUTE</button>
  </div>

  <!-- Display selector (built dynamically) -->
  <div class="displays" id="displays"></div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- UI helper ---
    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1500);
    }

    // --- State ---
    let dealershipId = null;
    let displayIds = [];
    let currentDisplay = null;
    let currentChannel = 1;
    let volume = 50;
    let muted = false;

    // --- Auth ---
    window.signIn = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try { await signInWithEmailAndPassword(auth, email, password); }
      catch (e) { console.error(e); toast('Invalid login'); }
    };

    window.powerOff = () => { signOut(auth); };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('remote').classList.add('active');
        await afterLogin(user);
      } else {
        document.getElementById('login').style.display = 'block';
        document.getElementById('remote').classList.remove('active');
        document.getElementById('displays').innerHTML = '';
        document.getElementById('currentDisplay').textContent = 'DISPLAY';
        currentDisplay = null;
      }
    });

    // --- After login: resolve dealership and load its TVs ---
    async function afterLogin(user) {
      const uSnap = await get(ref(db, `user/${user.uid}`));
      const u = uSnap.val() || {};
      dealershipId = u.dealershipId ?? u.dealership; // temporary fallback
      if (!dealershipId) { toast('No dealership assigned'); return; }

      // Load displays for this dealership (singular path 'dealership/')
      onValue(ref(db, `dealership/${dealershipId}/displays`), (snap) => {
        const map = snap.val() || {};
        displayIds = Object.keys(map).filter(k => map[k]);
        renderDisplayButtons(displayIds);
        if (!currentDisplay || !displayIds.includes(currentDisplay)) {
          currentDisplay = displayIds[0] || null;
          document.getElementById('currentDisplay').textContent = currentDisplay || 'NO TV';
        }
      });
    }

    function renderDisplayButtons(ids) {
      const wrap = document.getElementById('displays');
      wrap.innerHTML = '';
      ids.forEach((id) => {
        const btn = document.createElement('button');
        btn.className = 'display-btn' + (id === currentDisplay ? ' active' : '');
        btn.textContent = id;
        btn.onclick = () => switchDisplay(id, btn);
        wrap.appendChild(btn);
      });
    }

    window.showDisplays = () => {
      const displays = document.getElementById('displays');
      displays.classList.add('show');
      setTimeout(() => displays.classList.remove('show'), 3000);
    };

    window.switchDisplay = (id, btn) => {
      currentDisplay = id;
      document.getElementById('currentDisplay').textContent = id;
      document.querySelectorAll('.display-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      document.getElementById('displays').classList.remove('show');
      toast(id);
    };

    // --- Channel & volume ---
    window.setChannel = async (ch) => {
      currentChannel = ch;
      document.getElementById('channelDisplay').textContent = ch;
      await updateDisplay();
      toast(`CH ${ch}`);
    };

    window.chUp = () => {
      if (!displayIds.length) return;
      currentChannel = currentChannel >= 5 ? 1 : currentChannel + 1; // wrap 1..5
      setChannel(currentChannel);
    };

    window.chDown = () => {
      if (!displayIds.length) return;
      currentChannel = currentChannel <= 1 ? 5 : currentChannel - 1; // wrap 1..5
      setChannel(currentChannel);
    };

    window.volUp = async () => {
      if (!displayIds.length) return;
      volume = Math.min(100, volume + 10);
      await updateDisplay();
      toast(`VOL ${volume}`);
    };

    window.volDown = async () => {
      if (!displayIds.length) return;
      volume = Math.max(0, volume - 10);
      await updateDisplay();
      toast(`VOL ${volume}`);
    };

    window.toggleMute = async () => {
      if (!displayIds.length) return;
      muted = !muted;
      document.getElementById('muteBtn').classList.toggle('muted', muted);
      await updateDisplay();
      toast(muted ? 'MUTED' : 'UNMUTED');
    };

    // --- Write to selected TV ---
    async function updateDisplay() {
      if (!currentDisplay) { toast('Select a TV'); return; }
      const state = { channel: currentChannel, volume, muted, timestamp: Date.now() };
      await set(ref(db, `displays/${currentDisplay}`), state);
    }

    // Enter to login
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') signIn();
    });
  </script>
</body>
</html>
