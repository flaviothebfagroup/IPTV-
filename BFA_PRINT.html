<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Signage - Live</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:#000;color:#fff;overflow:hidden;height:100vh;width:100vw}
    .video-container{position:absolute;inset:0;background:#000}
    video{width:100%;height:100%;object-fit:cover;background:#000}
    .loading-overlay{position:absolute;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .3s}
    .loading-overlay.active{opacity:1;pointer-events:all}
    .spinner{width:60px;height:60px;border:4px solid rgba(255,255,255,.1);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .channel-info{position:absolute;top:20px;left:20px;background:rgba(0,0,0,.6);backdrop-filter:blur(16px);padding:12px 18px;border-radius:12px;border:1px solid rgba(255,255,255,.12);opacity:0;transform:translateY(-12px);transition:.35s;z-index:50}
    .channel-info.show{opacity:1;transform:translateY(0)}
    .channel-name{font-size:22px;font-weight:700;margin-bottom:4px}
    .channel-number{font-size:13px;opacity:.85}
    .status-bar{position:absolute;bottom:20px;right:20px;background:rgba(0,0,0,.7);backdrop-filter:blur(16px);padding:10px 16px;border-radius:999px;display:flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.12);font-size:13px;z-index:50}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#43e97b}
    .status-dot.disc{background:#f5576c}
    .display-id{position:absolute;bottom:20px;left:20px;background:rgba(255,255,255,.06);backdrop-filter:blur(16px);padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.12);font-size:12px;z-index:50}
    .error{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(245,87,108,.1);border:1px solid rgba(245,87,108,.3);padding:18px 24px;border-radius:12px;display:none;z-index:200;text-align:center}
    .error.show{display:block}
    .transition{position:absolute;inset:0;background:#000;z-index:90;opacity:0;pointer-events:none;transition:opacity .3s}
    .transition.on{opacity:1}
    /* tiny diag strip so you can SEE mismatches */
    .diag{position:absolute;top:20px;right:20px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:10px;font-size:11px;line-height:1.3;opacity:.8;z-index:60;max-width:42ch}
  </style>
</head>
<body>
  <div class="video-container"><video id="video" autoplay muted playsinline></video></div>
  <div class="loading-overlay" id="loading"><div class="spinner"></div></div>
  <div class="channel-info" id="cinfo"><div class="channel-name" id="cname">News</div><div class="channel-number">LIVE • CH <span id="cnum">1</span></div></div>
  <div class="status-bar"><div class="status-dot" id="sdot"></div><span id="slabel">Connecting…</span><span>•</span><span id="clock">00:00</span></div>
  <div class="display-id">Display: <strong id="did">—</strong></div>
  <div class="error" id="err"><div style="color:#f5576c;font-weight:700;margin-bottom:6px">Stream error</div><div id="errmsg">Trying again…</div></div>
  <div class="transition" id="x"></div>
  <div class="diag" id="diag">—</div>

  <!-- HLS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>

  <script>
    // ===== CONFIG — CHANGE ONLY THESE TWO LINES =====
    const CONFIG = {
      displayId: 'BFA_PRINT',          // e.g. GW-001 / KF-001 / BFA_PRINT
      dealershipId: 'BFA_PRINT', // must equal /displays/{displayId}/dealership
      channels: [
        { id:1, name:'News',   url:'https://citynewsregional.akamaized.net/hls/live/1024052/Regional_Live_7/Video-2Mbps.m3u8' },
        { id:2, name:'Sports', url:'http://fl5.moveonjoy.com/TSN_5/index.m3u8' },
        { id:3, name:'Cooking',url:'https://gusto-xumo.amagi.tv/playlist.m3u8' },
        { id:4, name:'Nature', url:'https://aegis-cloudfront-1.tubi.video/dc8bda97-ce9e-4091-b4e8-11254dea4da6/playlist.m3u8' },
        { id:5, name:'Kids',   url:'https://c0c65b821b3542c3a4dca92702f59944.mediatailor.us-east-1.amazonaws.com/v1/master/04fd913bb278d8775298c26fdca9d9841f37601f/RakutenTV-eu_BabySharkTV/playlist.m3u8' }
      ]
    };
    // ================================================

    let currentChannel = 1, hls=null, retries=0;
    const V=document.getElementById('video'), L=document.getElementById('loading'), X=document.getElementById('x');
    const Sdot=document.getElementById('sdot'), Slabel=document.getElementById('slabel');
    const Cname=document.getElementById('cname'), Cnum=document.getElementById('cnum');
    const Did=document.getElementById('did'), Err=document.getElementById('err'), Emsg=document.getElementById('errmsg'), Diag=document.getElementById('diag');

    Did.textContent = CONFIG.displayId;
    function clock(){ const n=new Date(); document.getElementById('clock').textContent=n.toLocaleTimeString('en-CA',{hour:'2-digit',minute:'2-digit',hour12:false}); }
    setInterval(clock,1000); clock();

    function showLoading(b){ L.classList.toggle('active', b); if(!b) Err.classList.remove('show'); }
    function transition(b){ X.classList.toggle('on', b); }

    function updateChannelInfo(ch){ Cname.textContent = ch.name; Cnum.textContent = ch.id; const c=document.getElementById('cinfo'); c.classList.add('show'); setTimeout(()=>c.classList.remove('show'),4000); }

    function loadChannel(n){
      const ch = CONFIG.channels.find(x=>x.id===n); if(!ch) return;
      currentChannel = n; updateChannelInfo(ch); transition(true);
      setTimeout(()=>{ 
        if (Hls.isSupported()){
          if(hls) hls.destroy();
          hls = new Hls({ enableWorker:true, lowLatencyMode:true });
          hls.loadSource(ch.url); hls.attachMedia(V);
          hls.on(Hls.Events.MANIFEST_PARSED, ()=> V.play().catch(()=>{}) );
          hls.on(Hls.Events.ERROR, (_,data)=>{ if(data.fatal){ Err.classList.add('show'); Emsg.textContent='Reconnecting…'; setTimeout(()=>loadChannel(currentChannel), 3000);} });
        } else if (V.canPlayType('application/vnd.apple.mpegurl')) {
          V.src = ch.url; V.play().catch(()=>{});
        } else {
          Err.classList.add('show'); Emsg.textContent='HLS not supported';
        }
        setTimeout(()=>transition(false),250);
      },200);
    }
    V.addEventListener('loadstart',()=>showLoading(true));
    V.addEventListener('canplay', ()=>showLoading(false));
    V.addEventListener('stalled', ()=>showLoading(true));
    loadChannel(1);
  </script>

  <!-- Firebase (Anon auth + secure realtime listen) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // Sign in anonymously (must be enabled in console)
    signInAnonymously(auth).catch(console.error);

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;

      // Write this device's profile so rules know its dealership
      try {
        await set(ref(db, `user/${user.uid}`), {
          role: 'device',
          name: CONFIG.displayId,
          dealershipId: CONFIG.dealershipId,
          createdAt: Date.now()
        });
      } catch(e){ console.warn('device profile write', e); }

      // Ensure /displays/{id}/dealership exists (one-time safety)
      try {
        const snap = await get(ref(db, `displays/${CONFIG.displayId}/dealership`));
        if (!snap.exists()) {
          await set(ref(db, `displays/${CONFIG.displayId}/dealership`), CONFIG.dealershipId);
        }
      } catch(e){ console.warn('ensure display dealership', e); }

      // Little diagnostic so you can SEE mismatches
      try {
        const a = (await get(ref(db, `user/${user.uid}/dealershipId`))).val();
        const b = (await get(ref(db, `displays/${CONFIG.displayId}/dealership`))).val();
        Diag.textContent = `Device dealership: ${a} • Display dealership: ${b} • ${a===b?'MATCH ✅':'MISMATCH ❌'}`;
      } catch(e){ Diag.textContent = 'Diag read error'; }

      // Realtime: react to remote updates
      const dref = ref(db, `displays/${CONFIG.displayId}`);
      onValue(dref, (snap)=>{
        const v = snap.val(); if(!v) return;
        // channel
        if (typeof v.channel === 'number' && v.channel !== window.currentChannel) {
          loadChannel(v.channel);
        }
        // volume/mute
        if (v.volume !== undefined || v.muted !== undefined) {
          const video = document.getElementById('video');
          if (v.volume !== undefined) { window.currentVolume = v.volume; video.volume = v.volume/100; }
          if (v.muted  !== undefined) { window.isMuted = v.muted; video.muted = !!v.muted; if(!v.muted){ video.play().catch(()=>{});} }
        }
        Sdot.classList.remove('disc'); Slabel.textContent='Connected';
      }, (err)=>{
        console.warn('listener error', err);
        Sdot.classList.add('disc'); Slabel.textContent='Disconnected';
      });
    });
  </script>
</body>
</html>
