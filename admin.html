<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BFA IPTV ‚Äî Admin</title>

  <!-- PWA bits (keep your existing icons/manifest paths if different) -->
  <link rel="manifest" href="/IPTV-/manifest.webmanifest" />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png" />
  <link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0c;--fg:#fff;--muted:#9a9aa0;--panel:#121214;--border:rgba(255,255,255,.14);
      --accent:#ff9500;--tile:#17171a;--tileActive:#1d1d21;--shadow:0 18px 48px rgba(0,0,0,.45);
      --ok:#22c55e;--warn:#f59e0b;--err:#ef4444
    }
    body.light{--bg:#f5f5f7;--fg:#111;--muted:#6e6e73;--panel:#fff;--border:rgba(0,0,0,.12);--tile:#f2f2f7;--tileActive:#eaeaef;--shadow:0 14px 36px rgba(0,0,0,.10)}
    *{box-sizing:border-box} html,body{height:100%} body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;margin:0}
    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .btn{height:34px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer}
    .btn.primary{border-color:var(--accent);color:var(--accent);background:transparent}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .page{display:none}.page.active{display:block}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:16px;box-shadow:var(--shadow)}
    .crumb{display:inline-flex;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--tile);margin-bottom:12px;cursor:pointer}
    .tile{display:flex;flex-direction:column;gap:8px;min-height:110px;padding:16px;border:1px solid var(--border);border-radius:18px;background:var(--tile);cursor:pointer}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;margin:10px 0}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .row3{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin:10px 0}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;margin:10px 0}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .input,.select{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
    .btn.solid{padding:12px;border-radius:12px;background:var(--accent);border:0;color:#000;font-weight:900;cursor:pointer}
    .btn.danger{border-color:#ff6b6b;color:#ff6b6b}
    .list{margin:8px 0 0;padding:0;list-style:none}
    .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px;margin:8px 0;background:var(--tile);border:1px solid var(--border);border-radius:12px;flex-wrap:wrap}
    .tag{padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:#999}.dot.ok{background:var(--ok)}.dot.err{background:var(--err)}
    .vol{display:flex;align-items:center;gap:8px}.vol input[type=range]{width:140px;accent-color:var(--accent)}
    .user-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
    .user-card{background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
    .toast.show{opacity:1}.toast.err{background:#ff453a;color:#fff}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <div id="brandLogo" style="width:34px;height:34px;border-radius:10px;background:#222 center/cover no-repeat;border:1px solid var(--border)"></div>
      <div style="font-weight:900">BFA IPTV ‚Äî Admin</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span id="adminEmail" style="color:var(--muted);font-size:12px"></span>
      <button id="themeBtn"  class="btn">‚òÄÔ∏é/üåô</button>
      <button id="reloadBtn" class="btn">Reload</button>
      <a href="admin-2.html" class="btn primary" style="text-decoration:none">Advanced / Backups</a>
      <button id="syncBtn" class="btn primary">Sync ‚Üí GitHub</button>
      <button id="settingsBtn" class="btn primary">Settings</button>
      <button id="signOutBtn" class="btn primary">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Login -->
    <div id="loginBox" class="card" style="max-width:520px;margin:40px auto;display:none">
      <h2 style="margin:0 0 12px">Admin Sign In</h2>
      <div class="row2">
        <div><div class="label">Email</div><input id="email" class="input" type="email" placeholder="you@company.com" autocomplete="email" /></div>
        <div><div class="label">Password</div><input id="password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" /></div>
      </div>
      <div class="row2">
        <button id="loginBtn" class="btn solid">Sign in</button>
        <button id="resetBtn" class="btn">Send reset link</button>
      </div>
      <div style="font-size:12px;color:var(--muted)">Requires <b>role: "admin"</b> in <code>/user/{uid}</code>.</div>
    </div>

    <!-- Not admin -->
    <div id="notAdmin" class="card" style="display:none;max-width:720px;margin:40px auto">
      <h2>Not authorized</h2>
      <div style="color:var(--muted);font-size:12px">Ask an admin to set your role to <b>admin</b> in the database.</div>
    </div>

    <!-- HOME -->
    <div id="home" class="page">
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
        <div class="tile" data-page="dealers"><b>Dealerships</b><span style="color:var(--muted);font-size:12px">Add ‚Ä¢ rename (migrate) ‚Ä¢ delete</span></div>
        <div class="tile" data-page="displays"><b>Displays</b><span style="color:var(--muted);font-size:12px">Live ‚Ä¢ channel ‚Ä¢ volume</span></div>
        <div class="tile" data-page="users"><b>Users</b><span style="color:var(--muted);font-size:12px">Create ‚Ä¢ roles ‚Ä¢ duplicates</span></div>
        <div class="tile" data-page="links"><b>Links</b><span style="color:var(--muted);font-size:12px">Quick access</span></div>
        <div class="tile" data-page="analytics"><b>Analytics</b><span style="color:var(--muted);font-size:12px">Now ‚Ä¢ channels ‚Ä¢ dealers</span></div>
        <div class="tile" data-page="schedule"><b>Schedule</b><span style="color:var(--muted);font-size:12px">Installs ‚Ä¢ reminders</span></div>
      </div>
    </div>

    <!-- Dealerships -->
    <div id="page-dealers" class="page">
      <div class="crumb" data-home>‚Üê Home</div>
      <div class="card">
        <h2 style="margin:0 0 8px">Dealerships</h2>
        <div class="row2" style="margin-top:10px">
          <div><div class="label">New dealership name</div><input id="dealerName" class="input" placeholder="e.g., Genesis Winnipeg" /></div>
          <div style="display:flex;align-items:end;gap:8px"><button id="addDealerBtn" class="btn solid">Add</button><button id="dealersReload" class="btn">Reload</button></div>
        </div>
        <div style="color:var(--muted);font-size:12px">Creates <code>/dealership/{id}</code> and <code>/dealershipPublic/{id}</code>. ID is from name.</div>
        <ul id="dealerList" class="list" style="margin-top:10px"></ul>
        <div id="dealerEmpty" style="display:none;color:var(--muted);border:1px dashed var(--border);padding:10px;border-radius:12px;text-align:center">No dealerships.</div>
      </div>
    </div>

    <!-- Displays -->
    <div id="page-displays" class="page">
      <div class="crumb" data-home>‚Üê Home</div>
      <div class="card">
        <h2 style="margin:0 0 8px">Displays</h2>
        <div class="row3">
          <div><div class="label">Dealership</div><select id="dealerForDisplays" class="select"><option value="">Select dealership‚Ä¶</option></select></div>
          <div><div class="label">Optional display ID</div><input id="newDisplayId" class="input" placeholder="Auto if empty (e.g., GW-002)" /></div>
          <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap"><button id="addDisplayBtn" class="btn solid">Add TV</button></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
          <button id="bulkMute" class="btn">Mute all</button>
          <button id="bulkUnmute" class="btn">Unmute all</button>
          <button id="bulkCh1" class="btn">All ‚Üí CH1</button>
          <button id="displaysReload" class="btn">Reload</button>
          <button id="jumpUsers" class="btn primary">Manage Users</button>
        </div>
        <ul id="displayList" class="list"></ul>
        <div id="displayEmpty" style="display:none;color:var(--muted);border:1px dashed var(--border);padding:10px;border-radius:12px;text-align:center">Pick a dealership to list TVs.</div>
      </div>
    </div>

    <!-- Users -->
    <div id="page-users" class="page">
      <div class="crumb" data-home>‚Üê Home</div>
      <div class="card">
        <h2 style="margin:0 0 8px">Users</h2>
        <div class="row4">
          <div><div class="label">Email <span style="color:var(--muted)">(optional for device)</span></div><input id="userEmail" class="input" placeholder="user@email.com" /></div>
          <div><div class="label">Name</div><input id="userName" class="input" placeholder="Full Name" /></div>
          <div><div class="label">Role</div><select id="userRole" class="select"><option value="user">user</option><option value="admin">admin</option><option value="device">device</option></select></div>
          <div><div class="label">Dealership</div><select id="userDealer" class="select"><option value="">Dealership‚Ä¶</option></select></div>
        </div>
        <div class="row2"><button id="createUserBtn" class="btn solid">Create User</button><button id="inviteUserBtn" class="btn">Send Reset (existing)</button></div>
        <div class="row3">
          <div><div class="label">Search</div><input id="userSearch" class="input" placeholder="Search name or email‚Ä¶" /></div>
          <div><div class="label">Filter dealership</div><select id="filterDealer" class="select"><option value="">All dealerships</option></select></div>
          <div><div class="label">Filter role</div><select id="filterRole" class="select"><option value="">All roles</option><option value="admin">admin</option><option value="device">device</option><option value="user">user</option><option value="disabled">disabled</option></select></div>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin:8px 0;flex-wrap:wrap">
          <button id="findDupBtn" class="btn">Find duplicates</button>
          <button id="deleteDupBtn" class="btn danger">Delete selected duplicates</button>
          <span style="color:var(--muted);font-size:12px">Duplicates = device users with same name in a dealership. Green = <b>active now</b>.</span>
        </div>
        <div id="dupBox" class="card" style="display:none;margin-bottom:10px">
          <h3 style="margin:0 0 6px">Duplicate candidates</h3>
          <div id="dupList" class="list"></div>
          <div id="dupEmpty" style="display:none;color:var(--muted);font-size:12px">No duplicates found.</div>
        </div>

        <div><h3>Admins (<span id="countAdmins">0</span>)</h3><div class="user-grid" id="gridAdmins"></div></div>
        <div><h3>Device Users (<span id="countDevices">0</span>)</h3><div class="user-grid" id="gridDevices"></div></div>
        <div><h3>Regular Users (<span id="countUsers">0</span>)</h3><div class="user-grid" id="gridUsers"></div></div>
        <div><h3>Disabled (<span id="countDisabled">0</span>)</h3><div class="user-grid" id="gridDisabled"></div></div>
        <div id="userEmpty" style="display:none;color:var(--muted);border:1px dashed var(--border);padding:10px;border-radius:12px;text-align:center">No users.</div>
      </div>
    </div>

    <!-- Links -->
    <div id="page-links" class="page">
      <div class="crumb" data-home>‚Üê Home</div>
      <div class="card">
        <h2 style="margin:0 0 8px">Apps / Quick Links</h2>
        <div class="row3">
          <div><div class="label">Title</div><input id="qlTitle" class="input" placeholder="e.g., Firebase ‚Äî Database" /></div>
          <div><div class="label">URL</div><input id="qlHref" class="input" placeholder="https://..." /></div>
          <div style="display:flex;align-items:end"><button id="qlAddBtn" class="btn solid" style="width:100%">Add Link</button></div>
        </div>
        <div class="row2">
          <div><div class="label">Emoji (optional)</div><input id="qlEmoji" class="input" placeholder="üî• ‚úÖ üìÅ ‚Ä¶" /></div>
          <div><div class="label">Logo image URL (optional)</div><input id="qlImg" class="input" placeholder="https://.../logo.png" /></div>
        </div>
        <div class="row">
          <div><div class="label">Description (optional)</div><input id="qlDesc" class="input" placeholder="Short label under the title" /></div>
          <div style="display:flex;align-items:end"><button id="qlResetBtn" class="btn" style="width:100%">Reset to defaults</button></div>
        </div>
        <div id="appsGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px"></div>
        <div id="qlStorageNote" style="margin-top:6px;font-size:12px;color:var(--muted)">Loading‚Ä¶</div>
      </div>
    </div>

    <!-- Analytics -->
    <div id="page-analytics" class="page">
      <div class="crumb" data-home>‚Üê Home</div>
      <div class="card">
        <h2 style="margin:0 0 8px">Analytics ‚Äî right now</h2>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:8px 0">
          <div class="item" style="border:0;background:var(--tile)"><div style="color:var(--muted);font-size:12px">Active TVs</div><b id="statActive" style="font-size:22px">0</b></div>
          <div class="item" style="border:0;background:var(--tile)"><div style="color:var(--muted);font-size:12px">Offline</div><b id="statOffline" style="font-size:22px">0</b></div>
          <div class="item" style="border:0;background:var(--tile)"><div style="color:var(--muted);font-size:12px">Top Channel</div><b id="statTopCh" style="font-size:22px">‚Äî</b></div>
          <div class="item" style="border:0;background:var(--tile)"><div style="color:var(--muted);font-size:12px">Avg Volume / Muted</div><b id="statVolMuted" style="font-size:22px">0 ‚Ä¢ 0%</b></div>
        </div>
        <h3 style="margin:10px 0 6px">Channel mix</h3>
        <div id="anaChBars"></div>
        <h3 style="margin:16px 0 6px">Most active dealerships</h3>
        <div id="anaDealerBars"></div>
      </div>
    </div>

    <!-- Schedule (local) -->
    <div id="page-schedule" class="page">
      <div class="crumb" data-home>‚Üê Home</div>
      <div class="card">
        <h2 style="margin:0 0 8px">Schedule / Reminders (local)</h2>
        <div class="row2">
          <div><div class="label">Date / time</div><input id="schWhen" class="input" type="datetime-local" /></div>
          <div><div class="label">Destination / address (optional)</div><input id="schDest" class="input" placeholder="Location / notes‚Ä¶" /></div>
        </div>
        <div class="row2">
          <div><div class="label">Note</div><input id="schNote" class="input" placeholder="Installation / visit / reminder‚Ä¶" /></div>
          <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
            <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="schCreateAssets" /><span style="font-size:12px">Create assets now (dealership + display)</span></label>
            <button id="schAdd" class="btn solid">Add</button>
          </div>
        </div>
        <div id="schAssets" style="display:none">
          <div class="row3">
            <div><div class="label">Dealership name</div><input id="schDealerName" class="input" placeholder="e.g., Genesis Winnipeg"/></div>
            <div><div class="label">Dealership ID (auto if empty)</div><input id="schDealerId" class="input" placeholder="genesiswinnipeg"/></div>
            <div><div class="label">Display ID (auto if empty)</div><input id="schDisplayId" class="input" placeholder="GW-001"/></div>
          </div>
        </div>
        <ul id="schList" class="list"></ul>
        <div id="schEmpty" style="display:none;color:var(--muted);border:1px dashed var(--border);padding:10px;border-radius:12px;text-align:center">No reminders.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Settings dialog -->
  <dialog id="settingsDlg" style="border:0;padding:0;border-radius:18px;max-width:720px;width:96vw">
    <form method="dialog" class="card" style="margin:0">
      <h2>Settings</h2>
      <div class="row2">
        <div><div class="label">GitHub Owner</div><input id="ghOwner" class="input" placeholder="org-or-user" /></div>
        <div><div class="label">Repo</div><input id="ghRepo" class="input" placeholder="repo" /></div>
      </div>
      <div class="row3">
        <div><div class="label">Branch</div><input id="ghBranch" class="input" placeholder="main" /></div>
        <div><div class="label">Path</div><input id="ghPath" class="input" placeholder="config/iptv-config.json" /></div>
        <div><div class="label">Token</div><input id="ghToken" class="input" type="password" placeholder="fine-grained token (contents:write)" /></div>
      </div>
      <div class="row2"><button class="btn" value="cancel">Close</button><button id="saveSettingsBtn" class="btn solid" value="default">Save</button></div>
    </form>
  </dialog>

  <!-- ===== App Script (module) ===== -->
  <script type="module">
    import { initializeApp, deleteApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, signOut, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, get, set, update, remove, onValue, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ========= CONFIG =========
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };
    const LOGO_URL = "https://flaviothebfagroup.github.io/IPTV-/icons/icon-512.png";
    const DEFAULT_LINKS = [
      { emoji:'üî•', title:'Firebase ‚Äî Overview', href:'https://console.firebase.google.com/project/iptv-bfa/overview', desc:'Console home' },
      { emoji:'üóÑÔ∏è', title:'Firebase ‚Äî Database', href:'https://console.firebase.google.com/project/iptv-bfa/database/iptv-bfa-default-rtdb/data', desc:'Realtime DB data' },
      { emoji:'üë§', title:'Firebase ‚Äî Auth', href:'https://console.firebase.google.com/project/iptv-bfa/authentication/users', desc:'Users & providers' },
      { emoji:'üêô', title:'GitHub Repo', href:'https://github.com/flaviothebfagroup/IPTV-', desc:'Source code' },
      { emoji:'üåê', title:'GitHub Pages (Remote)', href:'https://flaviothebfagroup.github.io/IPTV-/remote-control.html', desc:'Open remote' },
      { emoji:'üìß', title:'Gmail', href:'https://mail.google.com/mail/u/0/#inbox', desc:'Primary inbox' },
      { emoji:'üìß', title:'Outlook', href:'https://outlook.office.com/mail/', desc:'Office 365 inbox' },
      { emoji:'‚úÖ', title:'Trello ‚Äî Digital Team', href:'https://trello.com/b/jHjTIrZG/digital-team', desc:'Board' },
      { emoji:'üéõÔ∏è', title:'BSN.cloud', href:'https://app.bsn.cloud/#/dashboard', desc:'BrightSign dashboard' },
      { emoji:'üñ•Ô∏è', title:'Signagelive', href:'https://login.signagelive.com/', desc:'CMS login' },
      { emoji:'üìÅ', title:'Google Drive', href:'https://drive.google.com/drive/u/0/', desc:'My Drive' }
    ];

    // ========= helpers / UI =========
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const toast = (msg, err=false)=>{ const t=$('#toast'); t.textContent=msg; t.className='toast show'+(err?' err':''); setTimeout(()=>t.classList.remove('show'),2200); };
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const esc = s => String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    // theme + logo
    document.body.classList.toggle('light', (localStorage.getItem('iptv_theme')||'light')==='light');
    $('#themeBtn').onclick = ()=>{ const light=!document.body.classList.contains('light'); document.body.classList.toggle('light',light); localStorage.setItem('iptv_theme', light?'light':'dark'); };
    $('#brandLogo').style.backgroundImage = `url("${LOGO_URL}")`;

    // nav
    function showHome(){ $$('.page').forEach(p=>p.classList.remove('active')); $('#home').classList.add('active'); window.scrollTo(0,0); }
    function showPage(id){ $$('.page').forEach(p=>p.classList.remove('active')); $(`#page-${id}`).classList.add('active'); window.scrollTo(0,0); }
    $('#home').addEventListener('click', e=>{ const p=e.target.closest('.tile')?.dataset?.page; if(p) showPage(p); });
    $$('.crumb[data-home]').forEach(c=> c.addEventListener('click', showHome));

    // auth
    $('#loginBtn').onclick = doLogin;
    $('#resetBtn').onclick = async ()=>{
      const email=$('#email').value.trim(); if(!email) return toast('Enter email',true);
      try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(e){ toast(e.message||'Reset failed',true); }
    };
    $('#signOutBtn').onclick = ()=>signOut(auth);
    $('#reloadBtn').onclick = reloadAll;

    async function doLogin(){
      const email=$('#email').value.trim(), pass=$('#password').value;
      if(!email||!pass) return toast('Fill email & password', true);
      try{ await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth,email,pass); }
      catch(e){ toast(e.message||'Sign-in failed', true); }
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ $('#adminEmail').textContent=''; $$('.page').forEach(p=>p.classList.remove('active')); $('#notAdmin').style.display='none'; $('#loginBox').style.display='block'; return; }
      $('#adminEmail').textContent = user.email || user.uid;
      const s = await get(ref(db,`user/${user.uid}`)); const u = s.val()||{};
      if(u.role!=='admin'){ $('#loginBox').style.display='none'; $('#notAdmin').style.display='block'; $$('.page').forEach(p=>p.classList.remove('active')); return; }
      $('#loginBox').style.display='none'; $('#notAdmin').style.display='none'; showHome(); await reloadAll();
    });

    // settings + GH sync
    const LS_GH='iptv_admin_gh'; const gh = JSON.parse(localStorage.getItem(LS_GH)||'{}');
    function openSettings(){ $('#ghOwner').value=gh.owner||''; $('#ghRepo').value=gh.repo||''; $('#ghBranch').value=gh.branch||'main'; $('#ghPath').value=gh.path||'config/iptv-config.json'; $('#ghToken').value=gh.token||''; $('#settingsDlg').showModal(); }
    function saveSettings(){ gh.owner=$('#ghOwner').value.trim(); gh.repo=$('#ghRepo').value.trim(); gh.branch=$('#ghBranch').value.trim()||'main'; gh.path=$('#ghPath').value.trim()||'config/iptv-config.json'; gh.token=$('#ghToken').value.trim(); localStorage.setItem(LS_GH,JSON.stringify(gh)); toast('Settings saved'); }
    $('#settingsBtn').onclick=openSettings; $('#saveSettingsBtn').onclick=(e)=>{ e.preventDefault(); saveSettings(); $('#settingsDlg').close(); };

    async function ghFetch(url, opts){ const r=await fetch(url,opts); const t=await r.text(); let j; try{ j=t?JSON.parse(t):{}; }catch{ j={raw:t}; } if(!r.ok) throw new Error((j?.message||r.statusText)+` (HTTP ${r.status})`); return j; }
    async function exportToGitHub(){
      try{
        const gh=JSON.parse(localStorage.getItem('iptv_admin_gh')||'{}');
        if(!gh.owner||!gh.repo||!gh.branch||!gh.path||!gh.token) return toast('Open Settings and fill GitHub fields',true);
        await ghFetch(`https://api.github.com/repos/${gh.owner}/${gh.repo}`,{headers:{'Authorization':`Bearer ${gh.token}`,'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'}});
        const payload = await snapshot();
        const content  = btoa(unescape(encodeURIComponent(JSON.stringify(payload,null,2))));
        const base     = `https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/${encodeURIComponent(gh.path)}`;
        const headers  = {'Authorization':`Bearer ${gh.token}`,'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28','Content-Type':'application/json'};
        let sha;
        try{ const ex=await ghFetch(`${base}?ref=${encodeURIComponent(gh.branch)}`,{headers}); sha=ex.sha; }catch(e){ if(!String(e.message).includes('404')) throw e; }
        await ghFetch(base,{method:'PUT',headers,body:JSON.stringify({message: sha?`update: ${gh.path}`:`create: ${gh.path}`, content, branch:gh.branch, sha})});
        toast('Synced to GitHub ‚úîÔ∏é');
      }catch(e){
        alert(`GitHub sync failed:\n\n${e.message}\n\nChecklist:\n‚Ä¢ Token: fine-grained with ‚ÄúContents: Read and write‚Äù\n‚Ä¢ Repo selected in token\n‚Ä¢ Owner/Repo/Branch/Path exact`);
        toast('Sync failed',true);
      }
    }
    const b64=s=>btoa(unescape(encodeURIComponent(s)));
    $('#syncBtn').onclick=exportToGitHub;

    // reload all shared data
    async function reloadAll(){
      await refreshDealers(); await refreshUsers(); await quickLinksLoadRender(); await loadAnalytics();
      const did=$('#dealerForDisplays').value; if(did) await watchDisplays(did);
    }

    // ===== DEALERSHIPS =====
    function makeDealerId(name){ const base=(name||'').toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,24); return base || ('dealer_'+Date.now()); }
    async function countDisplaysForDealer(did){
      let n=0; try{ const m=await get(ref(db,`dealership/${did}/displays`)); if(m.exists()) n=Object.keys(m.val()||{}).length;
      if(n===0){ const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(did)); const q=await get(qRef); if(q.exists()) n=Object.keys(q.val()||{}).length; } }catch{}
      return n;
    }
    async function createDealership(name){
      const id=makeDealerId(name);
      await set(ref(db,`dealership/${id}`),{name,createdAt:Date.now(),createdBy:auth.currentUser?.email||'admin',displays:{}});
      await set(ref(db,`dealershipPublic/${id}`),{name});
    }
    async function migrateDealerId(oldId,newId,currentName){
      const exists=await get(ref(db,`dealership/${newId}`)); if(exists.exists()) throw new Error('Target ID exists');
      const [dealerSnap,pubSnap,dispSnap,usersSnap]=await Promise.all([
        get(ref(db,`dealership/${oldId}`)).catch(()=>({exists:()=>false,val:()=>null})),
        get(ref(db,`dealershipPublic/${oldId}`)).catch(()=>({exists:()=>false,val:()=>null})),
        get(query(ref(db,'displays'),orderByChild('dealership'),equalTo(oldId))).catch(()=>({val:()=>({})})),
        get(ref(db,'user')).catch(()=>({val:()=>({})}))
      ]);
      if(!dealerSnap.exists() && !pubSnap.exists()) throw new Error('Old dealership not found');
      const oldDealer=dealerSnap.val()||{}; const pubName=(pubSnap.val()?.name)||currentName||oldDealer.name||newId;
      const displays=dispSnap.val()||{}; const usersMap=usersSnap.val()||{};
      const updates={};
      updates[`dealership/${newId}`]={...oldDealer,name:pubName};
      updates[`dealershipPublic/${newId}`]={name:pubName};
      const idx={}; Object.keys(displays).forEach(did=>{ idx[did]=true; updates[`displays/${did}/dealership`]=newId; updates[`displays/${did}/timestamp`]=Date.now(); });
      updates[`dealership/${newId}/displays`]=idx;
      Object.entries(usersMap).forEach(([uid,u])=>{ if(u?.dealershipId===oldId){ updates[`user/${uid}/dealershipId`]=newId; updates[`user/${uid}/dealershipName`]=pubName; }});
      updates[`dealership/${oldId}`]=null; updates[`dealershipPublic/${oldId}`]=null;
      await update(ref(db),updates);
    }

    $('#addDealerBtn').onclick = async ()=>{
      const name=$('#dealerName').value.trim(); if(!name) return toast('Enter a name',true);
      try{ await createDealership(name); $('#dealerName').value=''; await refreshDealers(true); toast('Dealership added'); }catch{ toast('Create failed',true); }
    };
    $('#dealersReload').onclick=()=>refreshDealers(true);

    async function refreshDealers(keep=false){
      const list=$('#dealerList'); list.innerHTML='';
      const selDisp=$('#dealerForDisplays'), selUsers=$('#userDealer'), selFilt=$('#filterDealer');
      const prevD=selDisp.value, prevU=selUsers.value, prevF=selFilt.value;

      let map={}; try{ const pub=await get(ref(db,'dealershipPublic')); if(pub.exists()) map=pub.val(); }catch{}
      if(!map||!Object.keys(map).length){ try{ const d=await get(ref(db,'dealership')); if(d.exists()){ const raw=d.val(); for(const id of Object.keys(raw)) map[id]={name:raw[id]?.name||id}; } }catch{} }

      const ids=Object.keys(map||{}).sort();
      $('#dealerEmpty').style.display = ids.length? 'none':'block';
      selDisp.innerHTML='<option value="">Select dealership‚Ä¶</option>'; selUsers.innerHTML='<option value="">Dealership‚Ä¶</option>'; selFilt.innerHTML='<option value="">All dealerships</option>';

      for(const id of ids){
        const name=map[id]?.name||id; const count=await countDisplaysForDealer(id);
        const li=document.createElement('li'); li.className='item';
        li.innerHTML=`<div><b>${esc(name)}</b> <span class="tag">${esc(id)}</span> <span style="color:var(--muted);font-size:12px">${count} TV${count===1?'':'s'}</span></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" data-goto-displays="${id}">Displays</button>
          <button class="btn" data-goto-users="${id}">Users</button>
          <button class="btn" data-editname="${id}" data-name="${esc(name)}">Edit Name</button>
          <button class="btn" data-rename="${id}" data-name="${esc(name)}">Rename ID</button>
          <button class="btn danger" data-del="${id}">Delete</button>
        </div>`;
        list.appendChild(li);
        ['dealerForDisplays','userDealer','filterDealer'].forEach(sel=>{ const o=document.createElement('option'); o.value=id; o.textContent=name; document.getElementById(sel).appendChild(o); });
      }

      list.querySelectorAll('[data-goto-displays]').forEach(btn=> btn.onclick=()=>{ $('#dealerForDisplays').value=btn.dataset.gotoDisplays; showPage('displays'); watchDisplays($('#dealerForDisplays').value,true); });
      list.querySelectorAll('[data-goto-users]').forEach(btn=> btn.onclick=()=>{ $('#filterDealer').value=btn.dataset.gotoUsers; showPage('users'); refreshUsers(); });

      list.querySelectorAll('[data-editname]').forEach(btn=> btn.onclick=async ()=>{
        const id=btn.dataset.editname; const cur=btn.dataset.name; const next=prompt('Public display name', cur||''); if(!next||next===cur) return;
        try{ await set(ref(db,`dealershipPublic/${id}`),{name:next}); try{ await update(ref(db,`dealership/${id}`),{name:next}); }catch{} toast('Name updated'); await refreshDealers(true); }catch{ toast('Update failed',true); }
      });

      list.querySelectorAll('[data-rename]').forEach(btn=> btn.onclick=async ()=>{
        const oldId=btn.dataset.rename; const currentName=btn.dataset.name; const newId=prompt('New dealership ID (letters/numbers only):', oldId);
        if(!newId||newId===oldId) return; if(!/^[a-z0-9]+$/i.test(newId)) return toast('Use only letters/numbers',true);
        if(!confirm(`Migrate ${oldId} ‚Üí ${newId}? Displays and users will be updated.`)) return;
        try{ await migrateDealerId(oldId,newId,currentName); toast('Dealer ID renamed'); await refreshDealers(false); $('#dealerForDisplays').value=newId; if($('#page-displays').classList.contains('active')) await watchDisplays(newId,true); }catch(e){ toast(e.message||'Rename failed',true); }
      });

      list.querySelectorAll('[data-del]').forEach(btn=> btn.onclick=async ()=>{
        const id=btn.dataset.del; const count=await countDisplaysForDealer(id);
        if(count>0) return alert(`This dealership still has ${count} display(s). Remove them first or migrate.`);
        if(!confirm(`Delete ${id}?`)) return;
        try{ await remove(ref(db,`dealership/${id}`)); await remove(ref(db,`dealershipPublic/${id}`)); toast('Deleted'); await refreshDealers(); }catch{ toast('Delete failed',true); }
      });

      if(keep){ selDisp.value=prevD||''; selUsers.value=prevU||''; selFilt.value=prevF||''; if(selDisp.value) await watchDisplays(selDisp.value);} else { $('#displayList').innerHTML=''; $('#displayEmpty').style.display='block'; }
    }

    // ===== DISPLAYS =====
    let displaysUnsub=null;
    $('#dealerForDisplays').onchange = e=>watchDisplays(e.target.value);
    $('#displaysReload').onclick = ()=>{ const did=$('#dealerForDisplays').value; if(did) watchDisplays(did,true); };
    $('#jumpUsers').onclick = ()=>{ const did=$('#dealerForDisplays').value; showPage('users'); if(did){ $('#filterDealer').value=did; refreshUsers(); } };

    async function watchDisplays(did,forceOnce=false){
      const ul=$('#displayList'); ul.innerHTML=''; if(!did){ $('#displayEmpty').style.display='block'; if(displaysUnsub) displaysUnsub(); displaysUnsub=null; return; }
      $('#displayEmpty').style.display='none'; if(displaysUnsub){ displaysUnsub(); displaysUnsub=null; }

      const render=(map)=>{
        ul.innerHTML=''; const ids=Object.keys(map||{}).sort(); if(!ids.length){ $('#displayEmpty').style.display='block'; return; }
        const now=Date.now();
        ids.forEach(id=>{
          const st=map[id]||{}; const last=Math.max(st.lastSeenAt||0,st.timestamp||0,st.lastActiveAt||0); const online=last&&(now-last)<120000;
          const li=document.createElement('li'); li.className='item';
          li.innerHTML=`<div><b>${esc(id)}</b> <span class="tag">${esc(did)}</span> <span style="font-size:12px;display:inline-flex;gap:6px;align-items:center">${online?'<i class="dot ok"></i>Online':'<i class="dot err"></i>Offline'}</span>
            <div style="color:var(--muted);font-size:12px">CH ${st.channel??1} ‚Ä¢ VOL ${st.volume??0} ‚Ä¢ ${st.muted?'Muted':'Unmuted'}</div></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <select data-id="${id}" class="select small chsel">${[1,2,3,4,5].map(n=>`<option value="${n}" ${n===(st.channel||1)?'selected':''}>CH ${n}</option>`).join('')}</select>
              <div class="vol"><span style="color:var(--muted);font-size:12px">VOL</span><input type="range" min="0" max="100" value="${st.volume??0}" data-id="${id}" class="vslider"></div>
              <button class="btn" data-id="${id}" data-muted="${!!st.muted}">${st.muted?'Unmute':'Mute'}</button>
              <button class="btn danger" data-remove="${id}">Remove</button>
            </div>`;
          ul.appendChild(li);
        });
        ul.querySelectorAll('.chsel').forEach(el=> el.onchange = async e=>{ const id=e.target.dataset.id; await writeDisplay(id,{channel:parseInt(e.target.value,10)}); });
        const debounced=debounce(async (id,val)=>{ await writeDisplay(id,{volume:val}); },160);
        ul.querySelectorAll('.vslider').forEach(el=> el.oninput = e=>{ debounced(e.target.dataset.id, parseInt(e.target.value,10)); });
        ul.querySelectorAll('button[data-id]').forEach(el=> el.onclick = async ()=>{ const id=el.dataset.id; const cur=el.getAttribute('data-muted')==='true'; await writeDisplay(id,{muted:!cur}); });
        ul.querySelectorAll('button[data-remove]').forEach(el=> el.onclick = async ()=>{ const id=el.dataset.remove; if(!confirm(`Remove ${id}?`)) return; await remove(ref(db,`dealership/${did}/displays/${id}`)).catch(()=>{}); await remove(ref(db,`displays/${id}`)).catch(()=>{}); toast('Display removed'); });
      };

      const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(did));
      const off=onValue(qRef,s=>render(s.val()||{}),err=>console.warn(err)); displaysUnsub=()=>off();
      if(forceOnce){ const once=await get(qRef); render(once.val()||{}); }
    }

    async function writeDisplay(id,patch){
      try{ const s=await get(ref(db,`displays/${id}`)); const cur=s.val()||{}; await update(ref(db,`displays/${id}`),{...patch,dealership:cur.dealership||$('#dealerForDisplays').value||null,timestamp:Date.now()}); toast(`${id}: updated`); }
      catch{ toast('Write denied',true); }
    }
    $('#bulkMute').onclick = ()=>bulkWrite({muted:true});
    $('#bulkUnmute').onclick = ()=>bulkWrite({muted:false});
    $('#bulkCh1').onclick = ()=>bulkWrite({channel:1});
    async function bulkWrite(patch){ const did=$('#dealerForDisplays').value; if(!did) return toast('Pick a dealership',true); try{ const q=query(ref(db,'displays'),orderByChild('dealership'),equalTo(did)); const s=await get(q); const map=s.val()||{}; await Promise.all(Object.keys(map).map(id=>writeDisplay(id,patch))); toast('Applied to all TVs'); }catch{ toast('Bulk failed',true); } }
    $('#addDisplayBtn').onclick = async ()=>{
      const did=$('#dealerForDisplays').value; if(!did) return toast('Pick a dealership',true);
      let id=$('#newDisplayId').value.trim();
      if(!id){ const friendly=(await get(ref(db,`dealershipPublic/${did}`))).val()?.name||did; const pref=initialsFromName(friendly); const existing=await collectDisplays(did); let n=nextSuffix(existing,pref); id=`${pref}-${String(n).padStart(3,'0')}`; }
      try{ await set(ref(db,`dealership/${did}/displays/${id}`),true); await update(ref(db,`displays/${id}`),{channel:1,volume:0,muted:true,dealership:did,timestamp:Date.now()}); $('#newDisplayId').value=''; toast('Display added'); }catch{ toast('Add failed',true); }
    };
    async function collectDisplays(did){ const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(did)); const s=await get(qRef); return Object.keys(s.val()||{}); }
    function initialsFromName(name){ const raw=(name||'').trim(); if(!raw) return 'DS'; let parts=raw.match(/[A-Z√Ä-√ñ√ò-√ù][a-z√†-√∂√∏-√ø]*/g)||raw.match(/[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]+/g)||[]; let a=parts[0]||'', b=parts[1]||''; let p=(a? a[0]:'')+(b? b[0]:''); if(p.length<2 && a.length>=2) p=a.slice(0,2); return p.toUpperCase(); }
    function nextSuffix(list,pref){ let max=0; list.forEach(id=>{ const m=id.match(new RegExp('^'+pref+'-(\\d{3})$')); if(m){ const n=parseInt(m[1],10); if(n>max) max=n; }}); return max+1; }

    // ===== USERS =====
    $('#inviteUserBtn').onclick = async ()=>{ const email=$('#userEmail').value.trim(); if(!email) return toast('Enter email',true); try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(e){ toast(e.message||'Reset failed',true); } };
    $('#createUserBtn').onclick = createUserAdminSafe;
    $('#userSearch').addEventListener('input', debounce(refreshUsers,200)); $('#filterDealer').onchange=refreshUsers; $('#filterRole').onchange=refreshUsers;

    async function createUserAdminSafe(){
      const email=$('#userEmail').value.trim(); const name=$('#userName').value.trim(); const role=$('#userRole').value; const did=$('#userDealer').value;
      if(!name||!role||!did) return toast('Fill name, role and dealership',true);
      let dname=did; try{ const p=await get(ref(db,`dealershipPublic/${did}`)); if(p.exists()) dname=p.val()?.name||did; }catch{}
      // device without email: DB-only
      if(role==='device' && !email){
        try{ const uid=`dev_${Math.random().toString(36).slice(2,10)}${Date.now().toString(36)}`; let displays=[]; const ds=await get(ref(db,`dealership/${did}/displays`)); if(ds.exists()) displays=Object.keys(ds.val()||{}); await set(ref(db,`user/${uid}`),{email:null,name,role,dealershipId:did,dealershipName:dname,displays,createdAt:Date.now(),updatedAt:Date.now()}); toast('Device user created'); $('#userEmail').value=''; $('#userName').value=''; await refreshUsers(); return; }catch{ return toast('Create device failed',true); }
      }
      if(!email) return toast('Email required for non-device users',true);
      const tempName='admin-helper-'+Date.now(); const tempApp=initializeApp(firebaseConfig,tempName); const tempAuth=getAuth(tempApp);
      try{
        const tmpPass=Math.random().toString(36).slice(2)+Math.random().toString(36).toUpperCase().slice(2);
        const cred=await createUserWithEmailAndPassword(tempAuth,email,tmpPass); const uid=cred.user.uid;
        let displays=[]; const ds=await get(ref(db,`dealership/${did}/displays`)); if(ds.exists()) displays=Object.keys(ds.val()||{});
        await set(ref(db,`user/${uid}`),{email,name,role,dealershipId:did,dealershipName:dname,displays,createdAt:Date.now()});
        try{ await sendPasswordResetEmail(tempAuth,email); }catch{}
        toast('User created + reset sent'); await refreshUsers();
      }catch(e){
        const msg=String(e.code||''); if(msg.includes('auth/email-already-in-use')) toast('Email already exists ‚Äî use ‚ÄúSend Reset (existing)‚Äù',true);
        else if(msg.includes('auth/operation-not-allowed')) toast('Enable Email/Password provider in Firebase Auth',true);
        else toast(e.message||'Create failed',true);
      }finally{ try{ await signOut(getAuth(tempApp)); }catch{} try{ await deleteApp(tempApp);}catch{} }
    }

    async function loadDealersMap(){
      let map={}; try{ const pub=await get(ref(db,'dealershipPublic')); if(pub.exists()) map=Object.fromEntries(Object.entries(pub.val()).map(([k,v])=>[k,v?.name||k])); }catch{}
      if(!Object.keys(map).length){ try{ const d=await get(ref(db,'dealership')); if(d.exists()) map=Object.fromEntries(Object.entries(d.val()).map(([k,v])=>[k,v?.name||k])); }catch{} }
      const selF=$('#filterDealer'), selU=$('#userDealer'); const prevF=selF.value, prevU=selU.value; selF.innerHTML='<option value="">All dealerships</option>'; selU.innerHTML='<option value="">Dealership‚Ä¶</option>';
      for(const [id,name] of Object.entries(map).sort((a,b)=>a[1].localeCompare(b[1]))){ const f=document.createElement('option'); f.value=id; f.textContent=name; selF.appendChild(f); const u=document.createElement('option'); u.value=id; u.textContent=name; selU.appendChild(u); }
      selF.value=prevF||''; selU.value=prevU||''; return map;
    }

    async function refreshUsers(){
      const search=($('#userSearch').value||'').toLowerCase(); const fDid=$('#filterDealer').value; const fRole=$('#filterRole').value; const dealers=await loadDealersMap();
      let allDisplays={}; try{ const s=await get(ref(db,'displays')); if(s.exists()) allDisplays=s.val()||{}; }catch{}
      const now=Date.now(); const isDisplayActive=v=>{ const last=Math.max(v.lastSeenAt||0,v.lastActiveAt||0,v.timestamp||0); return last&&((now-last)<120000); };
      const userActive=u=>{ const ids=Array.isArray(u.displays)?u.displays:[]; if(ids.length) return ids.some(id=>allDisplays[id]&&isDisplayActive(allDisplays[id])); return Object.values(allDisplays).some(v=>v.dealership===u.dealershipId&&isDisplayActive(v)); };

      let map={}; try{ const u=await get(ref(db,'user')); if(u.exists()) map=u.val(); }catch{}
      const rows=Object.entries(map).map(([uid,v])=>({uid,...v}));
      const filtered=rows.filter(r=>{ if(fDid&&r.dealershipId!==fDid) return false; if(fRole&&(r.role||'user')!==fRole) return false; if(search && !((r.email||'').toLowerCase().includes(search)||(r.name||'').toLowerCase().includes(search))) return false; return true; });

      const groups={admin:[],device:[],user:[],disabled:[]};
      filtered.forEach(r=>{ const role=(r.role||'user'); if(role==='admin') groups.admin.push(r); else if(role==='device') groups.device.push(r); else if(role==='disabled') groups.disabled.push(r); else groups.user.push(r); });
      $('#countAdmins').textContent=groups.admin.length; $('#countDevices').textContent=groups.device.length; $('#countUsers').textContent=groups.user.length; $('#countDisabled').textContent=groups.disabled.length;
      $('#userEmpty').style.display=(groups.admin.length+groups.device.length+groups.user.length+groups.disabled.length)?'none':'block';

      const renderGroup=(arr,gridId)=>{
        const grid=document.getElementById(gridId); grid.innerHTML='';
        arr.sort((a,b)=> (a.dealershipName||a.dealershipId||'').localeCompare(b.dealershipName||b.dealershipId||'') || (a.email||'').localeCompare(b.email||''));
        arr.forEach(r=>{
          const dealer=r.dealershipName||r.dealershipId||'‚Äî'; const isDev=(r.role==='device'); const active=isDev?userActive(r):false;
          const card=document.createElement('div'); card.className='user-card';
          card.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
              <div class="user-name" title="Click to rename" data-rename="${r.uid}">${isDev?`<i class="dot ${active?'ok':'err'}" title="${active?'Active now':'Inactive'}"></i>`:''} ${esc(r.name||'No name')}</div>
              <span class="tag">${esc(r.role||'user')}</span>
            </div>
            <div style="color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap">
              <span>${esc(r.email||'')}</span><span class="tag">${esc(dealer)}</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <select data-uid="${r.uid}" class="select roleSel">${['user','admin','device','disabled'].map(v=>`<option value="${v}" ${v===(r.role||'user')?'selected':''}>${v}</option>`).join('')}</select>
              <select data-uid="${r.uid}" class="select dealerSel">${Object.entries(dealers).map(([id,nm])=>`<option value="${id}" ${id===(r.dealershipId||'')?'selected':''}>${nm}</option>`).join('')}</select>
              <button class="btn" data-reset="${esc(r.email||'')}">Reset password</button>
            </div>`;
          grid.appendChild(card);
        });
        grid.querySelectorAll('[data-rename]').forEach(el=> el.onclick=async ()=>{ const uid=el.dataset.rename; const current=(el.textContent||'').trim(); const next=prompt('New name', current||''); if(!next||next===current) return; try{ await update(ref(db,`user/${uid}`),{name:next}); el.innerHTML=el.innerHTML.replace(current,esc(next)); toast('Name updated'); }catch{ toast('Update failed',true); } });
        grid.querySelectorAll('.roleSel').forEach(sel=> sel.onchange=async e=>{ const uid=e.target.dataset.uid; const role=e.target.value; try{ await update(ref(db,`user/${uid}`),{role}); toast('Role updated'); await refreshUsers(); }catch{ toast('Update failed',true); }});
        grid.querySelectorAll('.dealerSel').forEach(sel=> sel.onchange=async e=>{ const uid=e.target.dataset.uid; const did=e.target.value; const name=dealers[did]||did; try{ await update(ref(db,`user/${uid}`),{dealershipId:did,dealershipName:name}); toast('Moved'); }catch{ toast('Move failed',true); }});
        grid.querySelectorAll('[data-reset]').forEach(btn=> btn.onclick=async ()=>{ const email=btn.dataset.reset; if(!email) return toast('No email',true); try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch{ toast('Reset failed',true); } });
      };

      renderGroup(groups.admin,'gridAdmins'); renderGroup(groups.device,'gridDevices'); renderGroup(groups.user,'gridUsers'); renderGroup(groups.disabled,'gridDisabled');
    }

    // duplicates (device) with active indicator
    const DUP_SEL = new Set();
    $('#findDupBtn').onclick = async ()=>{
      DUP_SEL.clear(); $('#dupList').innerHTML='';
      let allDisplays={}; try{ const s=await get(ref(db,'displays')); if(s.exists()) allDisplays=s.val()||{}; }catch{}
      const now=Date.now(); const isDisplayActive=v=>{ const last=Math.max(v.lastSeenAt||0,v.lastActiveAt||0,v.timestamp||0); return last&&((now-last)<120000); };
      const userActive=u=>{ const ids=Array.isArray(u.displays)?u.displays:[]; if(ids.length) return ids.some(id=>allDisplays[id]&&isDisplayActive(allDisplays[id])); return Object.values(allDisplays).some(v=>v.dealership===u.dealershipId&&isDisplayActive(v)); };

      let map={}; try{ const u=await get(ref(db,'user')); if(u.exists()) map=u.val(); }catch{}
      const rows=Object.entries(map).map(([uid,v])=>({uid,...v})).filter(r=> (r.role==='device')&&r.name&&r.dealershipId);
      const groups={}; rows.forEach(r=>{ const key=(r.dealershipId||'')+'|'+(r.name||'').toLowerCase().trim(); if(!groups[key]) groups[key]=[]; groups[key].push(r); });
      let any=false;
      for(const [key,arr] of Object.entries(groups)){
        if(arr.length<=1) continue; any=true;
        const [did,name]=key.split('|'); const holder=document.createElement('div'); holder.className='item';
        const inner=arr.map(r=>{ const active=userActive(r); return `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-uid="${r.uid}"/><span>${active?'<i class="dot ok" title="Active now"></i>':'<i class="dot err" title="Inactive"></i>'} ${esc(r.name)} <span class="tag">${esc(did)}</span> <span class="tag">${active?'Likely active':'Likely unused'}</span></span></label>`; }).join('<br/>');
        holder.innerHTML=`<div><b>‚Äú${esc(name)}‚Äù in ${esc(did)}</b><div style="color:var(--muted);font-size:12px">Select old/unused ones and delete</div></div><div>${inner}</div>`;
        $('#dupList').appendChild(holder);
      }
      $('#dupBox').style.display='block'; $('#dupEmpty').style.display=any?'none':'block';
      $('#dupList').querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.onchange=()=>{ const uid=cb.dataset.uid; if(cb.checked) DUP_SEL.add(uid); else DUP_SEL.delete(uid); });
    };
    $('#deleteDupBtn').onclick = async ()=>{ if(!DUP_SEL.size) return toast('Pick duplicates to delete'); if(!confirm(`Delete ${DUP_SEL.size} selected user(s)?`)) return;
      try{ await Promise.all(Array.from(DUP_SEL).map(uid=>remove(ref(db,`user/${uid}`)).catch(()=>{}))); DUP_SEL.clear(); toast('Deleted'); $('#dupBox').style.display='none'; await refreshUsers(); }catch{ toast('Delete failed',true); } };

    // ===== LINKS =====
    const LINKS_DB_PATH='admin/quickLinks'; let quickLinks=[], quickLinksSource='db';
    $('#qlAddBtn').onclick = async ()=>{ const title=$('#qlTitle').value.trim(), href=$('#qlHref').value.trim(); const emoji=$('#qlEmoji').value.trim(), img=$('#qlImg').value.trim(), desc=$('#qlDesc').value.trim(); if(!title||!href) return toast('Title and URL are required',true); quickLinks.push({title,href,emoji,img,desc}); await quickLinksSave(); clearQlForm(); renderApps(); toast('Link added'); };
    $('#qlResetBtn').onclick = async ()=>{ quickLinks=[...DEFAULT_LINKS]; await quickLinksSave(true); renderApps(); toast('Links reset'); };
    function clearQlForm(){ ['#qlTitle','#qlHref','#qlEmoji','#qlImg','#qlDesc'].forEach(s=>$(s).value=''); }
    async function quickLinksLoadRender(){ try{ const s=await get(ref(db,LINKS_DB_PATH)); if(s.exists()){ quickLinks=Object.values(s.val()); quickLinksSource='db'; $('#qlStorageNote').textContent='Links are synced from database.'; } else throw new Error('empty'); }catch{ try{ quickLinks=JSON.parse(localStorage.getItem('admin_quick_links')||'[]'); if(!quickLinks.length) quickLinks=[...DEFAULT_LINKS]; quickLinksSource='local'; $('#qlStorageNote').textContent='Links are stored locally on this device.'; }catch{ quickLinks=[...DEFAULT_LINKS]; quickLinksSource='local'; $('#qlStorageNote').textContent='Links are stored locally on this device.'; } } renderApps(); }
    async function quickLinksSave(forceLocal=false){ if(forceLocal||quickLinksSource==='local'){ localStorage.setItem('admin_quick_links',JSON.stringify(quickLinks)); quickLinksSource='local'; $('#qlStorageNote').textContent='Links are stored locally on this device.'; return; } try{ const data={}; quickLinks.forEach((l,i)=>data[i]=l); await set(ref(db,LINKS_DB_PATH),data); quickLinksSource='db'; $('#qlStorageNote').textContent='Links are synced from database.'; }catch{ localStorage.setItem('admin_quick_links',JSON.stringify(quickLinks)); quickLinksSource='local'; $('#qlStorageNote').textContent='Links are stored locally on this device.'; } }
    function renderApps(){ const grid=$('#appsGrid'); grid.innerHTML=''; quickLinks.forEach((l,i)=>{ const a=document.createElement('a'); a.href=l.href; a.target='_blank'; a.rel='noopener noreferrer'; a.style.cssText='display:flex;gap:12px;align-items:center;padding:12px;border:1px solid var(--border);border-radius:16px;background:var(--tile);text-decoration:none;color:inherit'; const left=l.img? `<div style="width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:url('${l.img}') center/cover no-repeat"></div>`:`<div style="width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:var(--tileActive);border:1px solid var(--border);font-size:20px">${esc(l.emoji||'üîó')}</div>`; a.innerHTML=`${left}<div style="display:flex;flex-direction:column;gap:2px"><div style="font-weight:800">${esc(l.title||'Link')}</div><div style="font-size:12px;color:var(--muted)">${esc(l.desc||'')}</div></div><button type="button" class="btn danger" data-remove="${i}" style="margin-left:auto">√ó</button>`; grid.appendChild(a); }); grid.querySelectorAll('button[data-remove]').forEach(btn=> btn.onclick=(e)=>{ e.preventDefault(); e.stopPropagation(); const i=parseInt(btn.dataset.remove,10); quickLinks.splice(i,1); quickLinksSave(); renderApps(); toast('Link removed'); }); }

    // ===== Analytics (snapshot) =====
    function barRow(label,value,total){ const pct=total?Math.round((value/total)*100):0; const row=document.createElement('div'); row.className='item'; row.innerHTML=`<div><b>${esc(label)}</b><div style="height:10px;background:var(--tileActive);border:1px solid var(--border);border-radius:999px;overflow:hidden"><i style="display:block;height:100%;background:linear-gradient(90deg,var(--accent),#ffb866);width:${pct}%"></i></div></div><div style="color:var(--muted);font-size:12px">${value} ‚Ä¢ ${pct}%</div>`; return row; }
    async function loadAnalytics(){
      const s=await get(ref(db,'displays')); const map=s.val()||{}; const ids=Object.keys(map); const now=Date.now();
      let online=0,offline=0,volSum=0,volN=0,mutedCount=0; const channelCounts={},dealerCounts={};
      ids.forEach(id=>{ const v=map[id]||{}; const last=Math.max(v.lastSeenAt||0,v.timestamp||0,v.lastActiveAt||0); const on=last&&((now-last)<120000); on?online++:offline++; const ch=(v.channel||1); channelCounts[ch]=(channelCounts[ch]||0)+1; const d=(v.dealership||'‚Äî'); dealerCounts[d]=(dealerCounts[d]||0)+1; if(typeof v.volume==='number'){ volSum+=v.volume; volN++; } if(v.muted===true) mutedCount++; });
      const avgVol=volN?Math.round(volSum/volN):0; const topCh=Object.entries(channelCounts).sort((a,b)=>b[1]-a[1])[0]?.[0]||'‚Äî'; const mutedPct=ids.length?Math.round((mutedCount/ids.length)*100):0;
      $('#statActive').textContent=online; $('#statOffline').textContent=offline; $('#statTopCh').textContent=topCh; $('#statVolMuted').textContent=`${avgVol} ‚Ä¢ ${mutedPct}%`;
      const chWrap=$('#anaChBars'); chWrap.innerHTML=''; const chT=Object.values(channelCounts).reduce((a,b)=>a+b,0); Object.entries(channelCounts).sort((a,b)=>a[0]-b[0]).forEach(([ch,n])=> chWrap.appendChild(barRow('Channel '+ch,n,chT)));
      const dWrap=$('#anaDealerBars'); dWrap.innerHTML=''; const dT=Object.values(dealerCounts).reduce((a,b)=>a+b,0); Object.entries(dealerCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(([d,n])=> dWrap.appendChild(barRow(d,n,dT)));
    }

    // ===== Schedule (local) + asset creation =====
    const LS_SCH='iptv_admin_schedule'; const schedule=JSON.parse(localStorage.getItem(LS_SCH)||'[]');
    $('#schCreateAssets').onchange = e=> $('#schAssets').style.display = e.target.checked ? 'block':'none';
    function saveSchedule(){ localStorage.setItem(LS_SCH,JSON.stringify(schedule)); renderSchedule(); }
    function renderSchedule(){ const ul=$('#schList'); ul.innerHTML=''; if(!schedule.length){ $('#schEmpty').style.display='block'; return; } $('#schEmpty').style.display='none'; schedule.sort((a,b)=>a.when.localeCompare(b.when)); schedule.forEach((r,i)=>{ const li=document.createElement('li'); li.className='item'; li.innerHTML=`<div><b>${new Date(r.when).toLocaleString()}</b><div style="color:var(--muted);font-size:12px">${esc(r.note||'')}</div>${r.dest?`<div style="color:var(--muted);font-size:12px">üìç ${esc(r.dest)}</div>`:''}${r.assets?`<div style="color:var(--muted);font-size:12px">Assets: ${esc(r.assets)}</div>`:''}</div><button class="btn danger" data-del="${i}">Delete</button>`; ul.appendChild(li); }); ul.querySelectorAll('button[data-del]').forEach(btn=> btn.onclick=()=>{ const i=parseInt(btn.dataset.del,10); schedule.splice(i,1); saveSchedule(); }); }
    renderSchedule();

    $('#schAdd').onclick = async ()=>{
      const when=$('#schWhen').value; const note=$('#schNote').value.trim(); const dest=$('#schDest').value.trim(); const make=$('#schCreateAssets').checked;
      if(!when||!note) return toast('Pick date/time and note',true);
      let assetsMsg='';
      if(make){
        let dName=$('#schDealerName').value.trim(); let dId=$('#schDealerId').value.trim(); let displayId=$('#schDisplayId').value.trim();
        if(!dName&&!dId) return toast('Enter dealership name or id',true); if(!dId) dId=makeDealerId(dName||('dealer_'+Date.now()));
        const exists=await get(ref(db,`dealershipPublic/${dId}`));
        if(!exists.exists()){ await set(ref(db,`dealershipPublic/${dId}`),{name:dName||dId}); await set(ref(db,`dealership/${dId}`),{name:dName||dId,createdAt:Date.now(),createdBy:auth.currentUser?.email||'admin',displays:{}}); }
        if(!displayId){ const friendly=(await get(ref(db,`dealershipPublic/${dId}`))).val()?.name||dId; const pref=initialsFromName(friendly); const existing=await collectDisplays(dId); let n=nextSuffix(existing,pref); displayId=`${pref}-${String(n).padStart(3,'0')}`; }
        await set(ref(db,`dealership/${dId}/displays/${displayId}`),true); await update(ref(db,`displays/${displayId}`),{channel:1,volume:0,muted:true,dealership:dId,timestamp:Date.now()});
        assetsMsg=`${dId} ‚Ä¢ ${displayId}`; $('#schDealerName').value=''; $('#schDealerId').value=''; $('#schDisplayId').value='';
      }
      schedule.push({when,note,dest,assets:assetsMsg}); saveSchedule();
      $('#schWhen').value=''; $('#schNote').value=''; $('#schDest').value=''; $('#schCreateAssets').checked=false; $('#schAssets').style.display='none'; toast('Scheduled');
    };

    // snapshot (shared with GH sync)
    function compactUsers(u){ const out={}; Object.entries(u||{}).forEach(([uid,v])=>{ out[uid]={email:v.email||null,name:v.name||null,role:v.role||'user',dealershipId:v.dealershipId||null,dealershipName:v.dealershipName||null}; }); return out; }
    async function snapshot(){ const [dPub,disp,usr]=await Promise.all([ get(ref(db,'dealershipPublic')).catch(()=>({val:()=>null})), get(ref(db,'displays')).catch(()=>({val:()=>null})), get(ref(db,'user')).catch(()=>({val:()=>null})) ]); return { meta:{generatedAt:new Date().toISOString(),by:auth.currentUser?.email||'admin',format:'iptv-bfa@1'}, dealersPublic:dPub?.val?.()||{}, displays:disp?.val?.()||{}, users:compactUsers(usr?.val?.()||{}) }; }

    // init
    showHome();
  </script>
</body>
</html>
