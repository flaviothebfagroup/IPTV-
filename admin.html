<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BFA IPTV — Admin</title>

<!-- (optional) PWA bits -->
<link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
<meta name="theme-color" content="#ffffff"/>
<link rel="icon" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
<link rel="icon" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
<link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

<style>
  /* ===== Light, monochrome + orange accent ===== */
  :root{
    --bg:#f7f8fa; --fg:#0b0b0c; --muted:#6f6f76; --card:#ffffff; --panel:#ffffff;
    --border:rgba(0,0,0,.12); --accent:#ff9500; --ok:#16a34a; --err:#dc2626;
    --r:20px; --gap:14px; --pad:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,system-ui,'SF Pro Display',sans-serif}

  /* Shell + topbar */
  .shell{max-width:1140px;margin:0 auto;padding:var(--pad)}
  .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:#eee center/cover no-repeat;border:1px solid var(--border)}
  .title{font-weight:900;letter-spacing:.2px}
  .btn{height:34px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--fg);cursor:pointer;font-weight:700}
  .btn.primary{border-color:var(--accent);color:var(--accent);background:transparent}
  .btn.danger{border-color:var(--err);color:var(--err)}
  .muted{color:var(--muted);font-size:12px}

  /* ===== HOME (Bento) ===== */
  .home{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
  @media (min-width:920px){ .home{grid-template-columns:repeat(3,1fr)} }
  .app-btn{
    position:relative; display:grid; place-items:center; aspect-ratio:1/1;
    background:var(--card); border:1px solid var(--border); border-radius:22px; cursor:pointer;
    transition:transform .18s ease,border-color .18s ease,box-shadow .18s ease, background .18s ease;
    view-transition-name: tile;
  }
  .app-btn:hover{transform:translateY(-2px); border-color:var(--accent); box-shadow:0 12px 28px rgba(0,0,0,.08)}
  .app-btn.grow{transform:scale(1.06); box-shadow:0 0 0 2px rgba(255,149,0,.25)}
  .app-ico{width:44px;height:44px}
  .app-title{margin-top:8px;font-weight:900}
  .app-sub{font-size:12px;color:var(--muted)}

  /* ===== PAGES ===== */
  .pages{position:relative;overflow:hidden}
  .page{display:none; opacity:0; transform:translateX(16px); transition:opacity .22s ease, transform .22s ease}
  .page.show{display:block; opacity:1; transform:translateX(0)}
  .page-head{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
  .page-title{font-weight:900}
  .flow-dots{display:flex;gap:6px}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--border)}
  .dot.on{background:var(--accent)}

  /* Layout + cards + inputs */
  .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
  @media (min-width:920px){ .grid.two{grid-template-columns:1fr 1fr} .grid.three{grid-template-columns:1fr 1fr 1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:var(--pad)}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;margin:8px 0}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:8px 0}
  @media (max-width:760px){ .row,.row2,.row3{grid-template-columns:1fr}}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .input,.select,.textarea{width:100%;padding:12px;background:#fff;border:1px solid var(--border);border-radius:12px;color:var(--fg);outline:none}
  .textarea{min-height:88px;resize:vertical}
  .list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
  .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--border);border-radius:14px;background:#fff;flex-wrap:wrap}
  .tag{padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:11px;color:var(--muted)}
  .inline-edit{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .inline-edit .input{max-width:220px}

  .online{display:inline-flex;align-items:center;gap:6px;font-size:12px}
  .dotstat{width:8px;height:8px;border-radius:50%;background:#bbb}
  .ok{background:var(--ok)} .err{background:var(--err)}
  .vol{display:flex;align-items:center;gap:8px}
  .vol input[type="range"]{width:140px;accent-color:var(--accent)}
  @media (max-width:560px){ .vol input[type="range"]{width:100%} }

  /* Calendar */
  .cal-head{display:flex;align-items:center;justify-content:space-between;margin:6px 0}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{font-size:11px;color:var(--muted);text-align:center}
  .day{height:72px;padding:8px;border:1px solid var(--border);border-radius:12px;background:#fff;display:flex;flex-direction:column;gap:6px;cursor:pointer}
  .day.today{outline:2px solid var(--accent)}
  .day .n{font-weight:800}
  .pill{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid var(--border);font-size:10px;color:var(--muted);max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  /* Charts (Insights) */
  .chart-wrap{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px}
  canvas{display:block;width:100%;height:220px}

  /* Auth */
  .auth{max-width:560px;margin:10px auto 0}

  /* Toast */
  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
  .toast.show{opacity:1}
  .toast.err{background:#ff3b30;color:#fff}
</style>
</head>
<body>
<div class="shell">
  <div class="top">
    <div class="brand">
      <div id="brandLogo" class="logo"></div>
      <div class="title">BFA IPTV — Admin</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span id="who" class="muted"></span>
      <button id="reloadBtn" class="btn">Reload</button>
      <button id="signOutBtn" class="btn primary">Sign out</button>
    </div>
  </div>

  <!-- ===== AUTH ===== -->
  <div id="authPane" class="auth card" style="display:none">
    <div class="row2">
      <div><div class="label">Email</div><input id="email" class="input" placeholder="you@company.com"/></div>
      <div><div class="label">Password</div><input id="password" type="password" class="input" placeholder="••••••••"/></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="loginBtn" class="btn primary">Sign in</button>
      <button id="resetBtn" class="btn">Send reset link</button>
      <span class="muted">Your user must have <b>role: "admin"</b> in <code>/user/{uid}</code>.</span>
    </div>
  </div>

  <!-- ===== HOME (6 tiles) ===== -->
  <div id="home" class="home">
    <div class="app-btn" data-go="dealers">
      <svg class="app-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="8" width="18" height="12" rx="2"/><path d="M7 20v-6h4v6M13 20v-4h4v4"/><path d="M3 10h18M7 8V4h10v4"/></svg>
      <div class="app-title">Dealerships</div>
      <div class="app-sub">Create • rename</div>
    </div>
    <div class="app-btn" data-go="displays">
      <svg class="app-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="12" rx="2"/><path d="M8 20h8M12 16v4"/></svg>
      <div class="app-title">Displays</div>
      <div class="app-sub">Channel • volume</div>
    </div>
    <div class="app-btn" data-go="users">
      <svg class="app-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
      <div class="app-title">Users</div>
      <div class="app-sub">Invite • duplicates</div>
    </div>
    <div class="app-btn" data-go="calendar">
      <svg class="app-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/></svg>
      <div class="app-title">Calendar</div>
      <div class="app-sub">Installations</div>
    </div>
    <div class="app-btn" data-go="links">
      <svg class="app-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7l1.5-1.5"/></svg>
      <div class="app-title">Links</div>
      <div class="app-sub">Quick access</div>
    </div>
    <div class="app-btn" data-go="insights">
      <svg class="app-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="4" y="10" width="3" height="10" rx="1"/><rect x="10.5" y="6" width="3" height="14" rx="1"/><rect x="17" y="3" width="3" height="17" rx="1"/></svg>
      <div class="app-title">Insights</div>
      <div class="app-sub">Usage & health</div>
    </div>
  </div>

  <!-- ===== PAGES (swipeable) ===== -->
  <div class="pages" id="pages">

    <!-- Dealers -->
    <section id="page-dealers" class="page">
      <div class="page-head">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" data-back>◀ Home</button>
          <div class="page-title">Dealerships</div>
        </div>
        <div class="flow-dots">
          <i class="dot on"></i><i class="dot"></i><i class="dot"></i><i class="dot"></i><i class="dot"></i><i class="dot"></i>
        </div>
      </div>
      <div class="grid two">
        <div class="card">
          <div class="row">
            <div>
              <div class="label">Add dealership (public name)</div>
              <input id="dealerName" class="input" placeholder="e.g., Genesis Winnipeg"/>
            </div>
            <div style="display:flex;align-items:end"><button id="addDealerBtn" class="btn primary">Add</button></div>
          </div>
          <div class="muted">Creates <code>/dealership/{id}</code> and <code>/dealershipPublic/{id}</code>. ID is derived from the name (letters/numbers).</div>
        </div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <b>All dealerships</b>
            <span class="tag"><span id="dealerCount">0</span></span>
          </div>
          <ul id="dealerList" class="list" style="margin-top:8px"></ul>
          <div id="dealerEmpty" class="muted">No dealerships.</div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px">
        <button class="btn primary" data-next="displays">Next ▶</button>
      </div>
    </section>

    <!-- Displays -->
    <section id="page-displays" class="page">
      <div class="page-head">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" data-back>◀ Home</button>
          <div class="page-title">Displays</div>
        </div>
        <div class="flow-dots"><i class="dot on"></i><i class="dot on"></i><i class="dot"></i><i class="dot"></i><i class="dot"></i><i class="dot"></i></div>
      </div>
      <div class="grid two">
        <div class="card">
          <div class="row3">
            <div><div class="label">Dealership</div><select id="dispDealer" class="select"><option value="">Select…</option></select></div>
            <div><div class="label">Optional display ID</div><input id="newDisplayId" class="input" placeholder="Auto if empty (e.g., GW-002)"/></div>
            <div style="display:flex;align-items:end"><button id="addDisplayBtn" class="btn primary">Add TV</button></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
            <button id="bulkMute" class="btn">Mute all</button>
            <button id="bulkUnmute" class="btn">Unmute all</button>
            <button id="bulkCh1" class="btn">All → CH1</button>
          </div>
        </div>
        <div class="card">
          <b>Screens</b>
          <ul id="displayList" class="list" style="margin-top:8px"></ul>
          <div id="displayEmpty" class="muted">Pick a dealership to list TVs.</div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button class="btn" data-prev="dealers">◀ Back</button>
        <button class="btn primary" data-next="users">Next ▶</button>
      </div>
    </section>

    <!-- Users -->
    <section id="page-users" class="page">
      <div class="page-head">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" data-back>◀ Home</button>
          <div class="page-title">Users</div>
        </div>
        <div class="flow-dots"><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot"></i><i class="dot"></i><i class="dot"></i></div>
      </div>
      <div class="grid two">
        <div class="card">
          <div class="row3">
            <div><div class="label">Email</div><input id="userEmail" class="input" placeholder="user@email.com"/></div>
            <div><div class="label">Name</div><input id="userName" class="input" placeholder="Full name"/></div>
            <div><div class="label">Role</div><select id="userRole" class="select"><option value="user">user</option><option value="admin">admin</option><option value="device">device</option></select></div>
          </div>
          <div class="row2">
            <div><div class="label">Dealership</div><select id="userDealer" class="select"><option value="">Dealership…</option></select></div>
            <div style="display:flex;align-items:end;gap:8px">
              <button id="createUserBtn" class="btn primary">Create</button>
              <button id="inviteUserBtn" class="btn">Send reset (existing)</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="row3">
            <div><div class="label">Search</div><input id="userSearch" class="input" placeholder="name or email…"/></div>
            <div><div class="label">Dealership</div><select id="filterDealer" class="select"><option value="">All</option></select></div>
            <div><div class="label">Role</div><select id="filterRole" class="select"><option value="">All</option><option value="admin">admin</option><option value="device">device</option><option value="user">user</option><option value="disabled">disabled</option></select></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
            <button id="findDupBtn" class="btn">Suggest duplicate device users</button>
            <button id="disableDupBtn" class="btn" disabled>Disable suggested</button>
          </div>
          <div class="muted" style="margin:6px 0">Admins (<span id="countAdmins">0</span>) • Devices (<span id="countDevices">0</span>) • Users (<span id="countUsers">0</span>) • Disabled (<span id="countDisabled">0</span>)</div>
          <div class="list" id="dupList" style="display:none"></div>
          <div id="dupEmpty" class="muted" style="display:none">No duplicates.</div>
          <div class="list" id="userList"></div>
          <div id="userEmpty" class="muted">No users.</div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button class="btn" data-prev="displays">◀ Back</button>
        <button class="btn primary" data-next="calendar">Next ▶</button>
      </div>
    </section>

    <!-- Calendar with Reminders -->
    <section id="page-calendar" class="page">
      <div class="page-head">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" data-back>◀ Home</button>
          <div class="page-title">Calendar — Installations</div>
        </div>
        <div class="flow-dots"><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot"></i><i class="dot"></i></div>
      </div>
      <div class="grid two">
        <div class="card">
          <div class="cal-head">
            <button id="calPrev" class="btn">◀</button>
            <div><b id="calMonthLabel">Month YYYY</b></div>
            <button id="calNext" class="btn">▶</button>
          </div>
          <div class="cal-grid" id="calDow"></div>
          <div class="cal-grid" id="calDays"></div>
        </div>
        <div class="card">
          <div class="page-title" style="font-weight:800">Events on <span id="selDateLabel">—</span></div>
          <div class="row3">
            <div><div class="label">Title</div><input id="evTitle" class="input" placeholder="Installation — showroom TV"/></div>
            <div><div class="label">Dealership</div><select id="evDealer" class="select"><option value="">—</option></select></div>
            <div><div class="label">Time</div><input id="evTime" class="input" type="time"/></div>
          </div>
          <div class="row2">
            <div><div class="label">Notes</div><textarea id="evNotes" class="textarea" placeholder="Address, contact, equipment, etc."></textarea></div>
            <div>
              <div class="label">Reminder (minutes before)</div>
              <input id="evRemMin" class="input" type="number" min="0" step="5" placeholder="30"/>
              <button id="addEventBtn" class="btn primary" style="margin-top:10px;width:100%">Add</button>
            </div>
          </div>
          <ul id="evList" class="list"></ul>
          <div id="evEmpty" class="muted">No events.</div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button class="btn" data-prev="users">◀ Back</button>
        <button class="btn primary" data-next="links">Next ▶</button>
      </div>
    </section>

    <!-- Links (Quick Access) -->
    <section id="page-links" class="page">
      <div class="page-head">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" data-back>◀ Home</button>
          <div class="page-title">Links</div>
        </div>
        <div class="flow-dots"><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot"></i></div>
      </div>
      <div class="grid two">
        <div class="card">
          <div class="row3">
            <div><div class="label">Title</div><input id="qlTitle" class="input" placeholder="Firebase — Database"/></div>
            <div><div class="label">URL</div><input id="qlHref" class="input" placeholder="https://..."/></div>
            <div style="display:flex;align-items:end"><button id="qlAddBtn" class="btn primary" style="width:100%">Add</button></div>
          </div>
          <div class="row2">
            <div><div class="label">Emoji (optional)</div><input id="qlEmoji" class="input" placeholder="🔗"/></div>
            <div><div class="label">Logo URL (optional)</div><input id="qlImg" class="input" placeholder="https://.../logo.png"/></div>
          </div>
          <div class="row">
            <div><div class="label">Description (optional)</div><input id="qlDesc" class="input" placeholder="Short label under the title"/></div>
            <div style="display:flex;align-items:end"><button id="qlResetBtn" class="btn" style="width:100%">Reset defaults</button></div>
          </div>
        </div>
        <div class="card">
          <b>Quick Links</b>
          <div id="appsGrid" class="list" style="margin-top:8px"></div>
          <div class="muted" id="qlStorageNote">Loading…</div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button class="btn" data-prev="calendar">◀ Back</button>
        <button class="btn primary" data-next="insights">Next ▶</button>
      </div>
    </section>

    <!-- Insights (Charts) -->
    <section id="page-insights" class="page">
      <div class="page-head">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" data-back>◀ Home</button>
          <div class="page-title">Insights</div>
        </div>
        <div class="flow-dots"><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i><i class="dot on"></i></div>
      </div>
      <div class="grid two">
        <div class="card">
          <div class="row">
            <div>
              <div class="label">Dealership (for breakdown)</div>
              <select id="insDealer" class="select"><option value="">All</option></select>
            </div>
            <div style="display:flex;align-items:end"><button id="insReload" class="btn">Refresh</button></div>
          </div>
          <div class="chart-wrap"><canvas id="chChannels" width="640" height="220"></canvas></div>
          <div class="muted" id="insNote" style="margin-top:6px">Shows current channel distribution across displays. “Changes” requires optional logging.</div>
        </div>
        <div class="card">
          <div class="row2">
            <div class="item" style="background:#fff">
              <div><b id="statOnline">0</b><div class="muted">Online now</div></div>
            </div>
            <div class="item" style="background:#fff">
              <div><b id="statTotal">0</b><div class="muted">Total displays</div></div>
            </div>
          </div>
          <div class="row2">
            <div class="item" style="background:#fff">
              <div><b id="statChanges">0</b><div class="muted">Channel changes (today)</div></div>
            </div>
            <div class="item" style="background:#fff">
              <div><b id="statTop">—</b><div class="muted">Most played channel</div></div>
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-start;margin-top:10px">
        <button class="btn" data-prev="links">◀ Back</button>
      </div>
    </section>

  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp, deleteApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import {
    getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword,
    onAuthStateChanged, sendPasswordResetEmail, signOut, createUserWithEmailAndPassword
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import {
    getDatabase, ref, get, set, update, remove, onValue, query, orderByChild, equalTo, push
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
    authDomain: "iptv-bfa.firebaseapp.com",
    databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
    projectId: "iptv-bfa",
    storageBucket: "iptv-bfa.firebasestorage.app",
    messagingSenderId: "838790935867",
    appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getDatabase(app);
  const LOGO_URL = "https://flaviothebfagroup.github.io/IPTV-/icons/icon-512.png";

  // ===== Utils =====
  const $ = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  const toast=(m,e=false)=>{const t=$("#toast");t.textContent=m;t.className="toast show"+(e?" err":"");setTimeout(()=>t.classList.remove('show'),1800);}
  const html=(s)=>String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const deb=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
  const todayISO=()=>{const d=new Date();const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const dy=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dy}`};

  // Brand
  $('#brandLogo').style.backgroundImage = `url("${LOGO_URL}")`;

  // ===== FLOW NAV (with swipe + view transitions) =====
  const ORDER = ['dealers','displays','users','calendar','links','insights'];
  function goHome(){ $('#home').style.display='grid'; $$('.page').forEach(p=>p.classList.remove('show')); }
  function goTo(key){
    const run=()=>{ $('#home').style.display='none'; $$('.page').forEach(p=>p.classList.remove('show')); const el=document.getElementById(`page-${key}`); if(el){ el.classList.add('show'); el.scrollIntoView({behavior:'smooth',block:'start'}); } };
    if (document.startViewTransition){ document.startViewTransition(()=>run()); } else { run(); }
    currentKey = key;
  }
  let currentKey = null;

  // Home buttons with grow/morph
  $$('.app-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key=btn.getAttribute('data-go');
      btn.classList.add('grow');
      setTimeout(()=>{ btn.classList.remove('grow'); goTo(key); }, 140);
    });
  });
  // In-page flow buttons
  $$('[data-back]').forEach(b=> b.addEventListener('click', goHome));
  $$('[data-next]').forEach(b=> b.addEventListener('click', ()=> goTo(b.getAttribute('data-next'))));
  $$('[data-prev]').forEach(b=> b.addEventListener('click', ()=> goTo(b.getAttribute('data-prev'))));

  // Swipe left/right across pages
  (()=>{
    const host = $('#pages');
    let sx=0, sy=0, tracking=false;
    host.addEventListener('pointerdown', e=>{ tracking=true; sx=e.clientX; sy=e.clientY; host.setPointerCapture(e.pointerId); });
    host.addEventListener('pointerup', e=>{
      if(!tracking) return; tracking=false;
      const dx=e.clientX-sx, dy=e.clientY-sy;
      if(Math.abs(dx)>60 && Math.abs(dx)>Math.abs(dy)){
        const idx = ORDER.indexOf(currentKey||'dealers');
        if(dx<0 && idx < ORDER.length-1) goTo(ORDER[idx+1]);
        if(dx>0 && idx > 0) goTo(ORDER[idx-1]);
      }
    });
    host.addEventListener('pointercancel', ()=>{ tracking=false; });
  })();

  // ===== AUTH =====
  $('#reloadBtn').addEventListener('click', reloadAll);
  $('#signOutBtn').addEventListener('click', ()=>signOut(auth));
  $('#loginBtn').addEventListener('click', doLogin);
  $('#resetBtn').addEventListener('click', async ()=>{
    const email=$('#email').value.trim(); if(!email) return toast('Enter email',true);
    try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(e){ console.error(e); toast('Reset failed', true); }
  });
  async function doLogin(){
    const email=$('#email').value.trim(), pass=$('#password').value;
    if(!email||!pass) return toast('Fill email & password', true);
    try{ await setPersistence(auth,browserLocalPersistence); await signInWithEmailAndPassword(auth,email,pass); }
    catch(e){ console.error(e); toast('Sign-in failed', true); }
  }
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      $('#who').textContent=''; $('#authPane').style.display='block';
      return;
    }
    $('#authPane').style.display='none';
    $('#who').textContent=user.email||user.uid;
    let role=''; try{ const s=await get(ref(db,`user/${user.uid}`)); role=(s.val()||{}).role||''; }catch(e){}
    if(role!=='admin'){ toast('Not an admin', true); $('#authPane').style.display='block'; return; }
    await reloadAll();
  });
  async function reloadAll(){
    await loadDealers(); await buildDisplaysDealerSelect(); await loadUsers(); buildCalendar(); await quickLinksLoadRender(); await refreshInsights();
  }

  // ===== Dealers =====
  const dealerIdFromName = (name)=> (name||'').toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,24) || ('dealer_'+Date.now());
  $('#addDealerBtn').addEventListener('click', async ()=>{
    const name=$('#dealerName').value.trim(); if(!name) return toast('Name?',true);
    const id=dealerIdFromName(name);
    try{
      await set(ref(db,`dealership/${id}`), { name, createdAt:Date.now(), displays:{} });
      await set(ref(db,`dealershipPublic/${id}`), { name });
      $('#dealerName').value=''; toast('Created'); await loadDealers();
    }catch(e){ console.error(e); toast('Create failed', true); }
  });

  async function loadDealers(){
    let map={};
    try{ const p=await get(ref(db,'dealershipPublic')); if(p.exists()) map=p.val(); }catch(e){}
    if(!Object.keys(map).length){
      try{ const d=await get(ref(db,'dealership')); if(d.exists()){ const raw=d.val(); Object.keys(raw).forEach(id=> map[id]={name:raw[id]?.name||id}); } }catch(e){}
    }
    const list=$('#dealerList'); list.innerHTML='';
    const ids=Object.keys(map).sort();
    $('#dealerCount').textContent=ids.length;
    $('#dealerEmpty').style.display = ids.length? 'none':'block';
    for(const id of ids){
      const name=map[id]?.name||id;
      const li=document.createElement('li'); li.className='item';
      li.innerHTML=`
        <div class="inline-edit">
          <b>${html(name)}</b> <span class="tag">${html(id)}</span>
          <input class="input" style="display:none" data-edit-name="${id}" value="${html(name)}"/>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn" data-act="editname" data-id="${id}">✎ Edit name</button>
          <button class="btn" data-act="open" data-id="${id}">Open Displays</button>
          <button class="btn" data-act="rename" data-id="${id}" data-name="${html(name)}">Rename ID</button>
          <button class="btn danger" data-act="delete" data-id="${id}">Delete</button>
        </div>`;
      list.appendChild(li);
    }
    // wire actions
    list.querySelectorAll('button[data-act="editname"]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-id'); const input=list.querySelector(`input[data-edit-name="${id}"]`);
        if(!input) return; input.style.display='inline-block'; input.focus();
        input.addEventListener('keydown', async (e)=>{
          if(e.key==='Enter'){ const newName=input.value.trim(); if(!newName) return; try{ await set(ref(db,`dealershipPublic/${id}`), { name:newName }); await update(ref(db,`dealership/${id}`), { name:newName }); toast('Name updated'); await loadDealers(); }catch(err){ console.error(err); toast('Update failed', true); } }
          if(e.key==='Escape'){ input.style.display='none'; }
        }, {once:true});
      });
    });
    list.querySelectorAll('button[data-act="rename"]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const oldId=b.getAttribute('data-id'); const cur=b.getAttribute('data-name');
        const newId=prompt('New dealership ID (letters/numbers only):', oldId);
        if(!newId||newId===oldId||!/^[a-z0-9]+$/i.test(newId)) return;
        if(!confirm(`Migrate ${oldId} → ${newId}? Displays & users will be updated.`)) return;
        try{ await migrateDealerId(oldId,newId,cur); toast('Renamed'); await loadDealers(); }catch(e){ console.error(e); toast('Rename failed', true); }
      });
    });
    list.querySelectorAll('button[data-act="open"]').forEach(b=>{
      b.addEventListener('click', ()=>{ goTo('displays'); $('#dispDealer').value=b.getAttribute('data-id'); watchDisplays($('#dispDealer').value); });
    });
    list.querySelectorAll('button[data-act="delete"]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-id');
        if(!confirm(`Delete ${id}?`)) return;
        const count = await countDisplaysForDealer(id);
        if(count>0){ alert(`This dealership still has ${count} display(s). Remove or migrate first.`); return; }
        try{ await remove(ref(db,`dealership/${id}`)); await remove(ref(db,`dealershipPublic/${id}`)); toast('Deleted'); await loadDealers(); }
        catch(e){ console.error(e); toast('Delete failed', true); }
      });
    });

    // refresh selects (users, displays, calendar, insights)
    const selects = [$('#userDealer'), $('#filterDealer'), $('#dispDealer'), $('#evDealer'), $('#insDealer')];
    selects.forEach(sel=>{
      if(!sel) return;
      const keep = sel.value;
      sel.innerHTML = sel.id==='filterDealer' ? '<option value="">All</option>' :
                      sel.id==='dispDealer' ? '<option value="">Select…</option>' :
                      '<option value="">—</option>';
      ids.forEach(did=>{
        const opt=document.createElement('option'); opt.value=did; opt.textContent=map[did].name||did; sel.appendChild(opt);
      });
      sel.value = keep || sel.value;
    });
  }

  async function migrateDealerId(oldId,newId,name){
    const exists=await get(ref(db,`dealership/${newId}`)); if(exists.exists()) throw new Error('Target exists');
    const pubName=name || (await get(ref(db,`dealershipPublic/${oldId}`))).val()?.name || oldId;
    await set(ref(db,`dealershipPublic/${newId}`), { name:pubName });

    const idxSnap=await get(ref(db,`dealership/${oldId}/displays`)); const idxMap=idxSnap.val()||{};
    if(Object.keys(idxMap).length) await set(ref(db,`dealership/${newId}/displays`), idxMap);

    const qRef=query(ref(db,'displays'), orderByChild('dealership'), equalTo(oldId));
    const ds=await get(qRef); const dispMap=ds.val()||{};
    for(const did of Object.keys(dispMap)){ await update(ref(db,`displays/${did}`), { dealership:newId, timestamp:Date.now() }); }

    const us=await get(ref(db,'user')); const users=us.val()||{};
    for(const uid of Object.keys(users)){ if(users[uid]?.dealershipId===oldId){ await update(ref(db,`user/${uid}`), { dealershipId:newId, dealershipName:pubName }); } }

    await remove(ref(db,`dealership/${oldId}`));
    await remove(ref(db,`dealershipPublic/${oldId}`));
  }
  async function countDisplaysForDealer(did){
    let n=0;
    try{ const m=await get(ref(db,`dealership/${did}/displays`)); if(m.exists()) n=Object.keys(m.val()||{}).length;
      if(n===0){ const qRef=query(ref(db,'displays'), orderByChild('dealership'), equalTo(did)); const s=await get(qRef); if(s.exists()) n=Object.keys(s.val()||{}).length; }
    }catch(e){}
    return n;
  }

  // ===== Displays =====
  let displaysUnsub=null;
  async function buildDisplaysDealerSelect(){ $('#dispDealer').removeEventListener?.('change', onDispDealerChange); $('#dispDealer').addEventListener('change', onDispDealerChange); }
  async function onDispDealerChange(e){ watchDisplays(e.target.value); }

  async function watchDisplays(did){
    const list=$('#displayList'); list.innerHTML='';
    if(!did){ $('#displayEmpty').style.display='block'; if(displaysUnsub) displaysUnsub(); displaysUnsub=null; return; }
    $('#displayEmpty').style.display='none';
    if(displaysUnsub){ displaysUnsub(); displaysUnsub=null; }

    const render=(map)=>{
      list.innerHTML='';
      const ids=Object.keys(map||{}).sort();
      if(!ids.length){ $('#displayEmpty').style.display='block'; return; }
      const now=Date.now();
      ids.forEach(id=>{
        const st=map[id]||{};
        const online=(st.lastSeenAt && (now-st.lastSeenAt)<60000) || (st.timestamp && (now-st.timestamp)<120000);
        const li=document.createElement('li'); li.className='item';
        li.innerHTML=`
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;min-width:240px">
            <b>${html(id)}</b> <span class="tag">${html(did)}</span>
            <span class="online"><i class="dotstat ${online?'ok':'err'}"></i>${online?'online':'offline'}</span>
            <span class="muted">CH ${st.channel ?? 1} • VOL ${st.volume ?? 0} • ${st.muted?'Muted':'Unmuted'}</span>
          </div>
          <div class="vol">
            <select data-id="${id}" class="select chsel">${[1,2,3,4,5].map(n=>`<option value="${n}" ${n===(st.channel||1)?'selected':''}>CH ${n}</option>`).join('')}</select>
            <span class="muted">VOL</span><input type="range" min="0" max="100" value="${st.volume ?? 0}" data-id="${id}" class="vslider"/>
            <button class="btn" data-mute="${id}" data-state="${!!st.muted}">${st.muted?'Unmute':'Mute'}</button>
            <button class="btn danger" data-del="${id}">Remove</button>
          </div>`;
        list.appendChild(li);
      });

      list.querySelectorAll('.chsel').forEach(el=> el.addEventListener('change', async (e)=>{ const id=e.target.getAttribute('data-id'); const ch=parseInt(e.target.value,10); await writeDisplay(id,{channel:ch}); }));
      const debWrite=deb(async (id,val)=>{ await writeDisplay(id,{volume:val}); }, 160);
      list.querySelectorAll('.vslider').forEach(el=> el.addEventListener('input',(e)=>{ const id=e.target.getAttribute('data-id'); debWrite(id, parseInt(e.target.value,10)); }));
      list.querySelectorAll('button[data-mute]').forEach(btn=> btn.addEventListener('click', async ()=>{ const id=btn.getAttribute('data-mute'); const cur=btn.getAttribute('data-state')==='true'; await writeDisplay(id,{muted:!cur}); }));
      list.querySelectorAll('button[data-del]').forEach(btn=> btn.addEventListener('click', async ()=>{ const id=btn.getAttribute('data-del'); if(!confirm(`Remove ${id}?`)) return; try{ await remove(ref(db,`dealership/${did}/displays/${id}`)); await remove(ref(db,`displays/${id}`)); toast('Removed'); }catch(e){ console.error(e); toast('Remove failed', true); }}));
    };

    const qRef=query(ref(db,'displays'), orderByChild('dealership'), equalTo(did));
    const off=onValue(qRef, s=>render(s.val()||{}), err=>console.warn(err));
    displaysUnsub=()=>off();
  }

  async function writeDisplay(id, patch){
    try{
      const snap=await get(ref(db,`displays/${id}`)); const cur=snap.val()||{};
      await update(ref(db,`displays/${id}`), { ...patch, dealership: cur.dealership || $('#dispDealer').value || null, timestamp: Date.now() });
      toast(`${id}: updated`);
    }catch(e){ console.error(e); toast('Write denied', true); }
  }
  $('#bulkMute').addEventListener('click', ()=>bulkWrite({muted:true}));
  $('#bulkUnmute').addEventListener('click', ()=>bulkWrite({muted:false}));
  $('#bulkCh1').addEventListener('click', ()=>bulkWrite({channel:1}));
  async function bulkWrite(patch){
    const did=$('#dispDealer').value; if(!did) return toast('Pick a dealership',true);
    const qRef=query(ref(db,'displays'), orderByChild('dealership'), equalTo(did));
    const s=await get(qRef); const map=s.val()||{}; for(const id of Object.keys(map)){ await writeDisplay(id,patch); }
    toast('Applied to all TVs');
  }
  $('#addDisplayBtn').addEventListener('click', async ()=>{
    const did=$('#dispDealer').value; if(!did) return toast('Pick a dealership',true);
    let id=$('#newDisplayId').value.trim();
    if(!id){
      const friendly=(await get(ref(db,`dealershipPublic/${did}`))).val()?.name||did;
      const pref=initialsFromName(friendly); const list=await collectDisplays(did); const next=nextSuffix(list,pref); id=`${pref}-${String(next).padStart(3,'0')}`;
    }
    try{
      await set(ref(db,`dealership/${did}/displays/${id}`), true);
      await update(ref(db,`displays/${id}`), { channel:1, volume:0, muted:true, dealership:did, timestamp:Date.now() });
      $('#newDisplayId').value=''; toast('Display added');
    }catch(e){ console.error(e); toast('Add failed', true); }
  });
  async function collectDisplays(did){ const qRef=query(ref(db,'displays'), orderByChild('dealership'), equalTo(did)); const s=await get(qRef); return Object.keys(s.val()||{}); }
  function initialsFromName(name){ const raw=(name||'').trim(); if(!raw) return 'DS'; const m=raw.match(/[A-Za-zÀ-ÖØ-öø-ÿ]+/g)||[]; let a=m[0]||'', b=m[1]||''; let p=(a[0]||'')+(b[0]||''); if(p.length<2&&a.length>=2)p=a.slice(0,2); return p.toUpperCase(); }
  function nextSuffix(list,pref){ let max=0; list.forEach(id=>{ const m=id.match(new RegExp('^'+pref+'-(\\d{3})$')); if(m){ const n=parseInt(m[1],10); if(n>max)max=n; } }); return max+1; }

  // ===== Users (with duplicate suggestion) =====
  $('#inviteUserBtn').addEventListener('click', async ()=>{
    const email=$('#userEmail').value.trim(); if(!email) return toast('Enter email',true);
    try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(e){ console.error(e); toast('Reset failed', true); }
  });
  $('#createUserBtn').addEventListener('click', createUserAdminSafe);
  $('#userSearch').addEventListener('input', ()=>loadUsers());
  $('#filterDealer').addEventListener('change', ()=>loadUsers());
  $('#filterRole').addEventListener('change', ()=>loadUsers());

  async function createUserAdminSafe(){
    const email=$('#userEmail').value.trim(), name=$('#userName').value.trim(), role=$('#userRole').value, did=$('#userDealer').value;
    if(!email||!name||!role||!did) return toast('Fill all fields', true);
    const tempName='admin-helper-'+Date.now(); const tempApp=initializeApp(firebaseConfig,tempName); const tempAuth=getAuth(tempApp);
    try{
      const tmpPass=Math.random().toString(36).slice(2)+Math.random().toString(36).toUpperCase().slice(2);
      const cred=await createUserWithEmailAndPassword(tempAuth,email,tmpPass); const uid=cred.user.uid;
      let dname=did; try{ const p=await get(ref(db,`dealershipPublic/${did}`)); if(p.exists()) dname=p.val()?.name||did; }catch(e){}
      let displays=[]; const ds=await get(ref(db,`dealership/${did}/displays`)); if(ds.exists()) displays=Object.keys(ds.val()||{});
      await set(ref(db,`user/${uid}`), { email,name,role,dealershipId:did,dealershipName:dname,displays,createdAt:Date.now() });
      await sendPasswordResetEmail(tempAuth,email);
      toast('User created + reset sent'); await loadUsers();
    }catch(e){ console.error(e); toast('Create failed', true); }
    finally{ try{ await signOut(tempAuth);}catch(e){} try{ await deleteApp(tempApp);}catch(e){} }
  }

  let dupSuggestion=[];
  $('#findDupBtn').addEventListener('click', suggestDupDevices);
  $('#disableDupBtn').addEventListener('click', disableSuggestedDup);
  async function suggestDupDevices(){
    $('#dupList').style.display='block'; $('#dupEmpty').style.display='block'; $('#dupEmpty').textContent='Scanning…';
    try{
      const snap=await get(ref(db,'user')); const map=snap.val()||{};
      const byName={};
      Object.entries(map).forEach(([uid,v])=>{
        if((v.role||'')==='device'){ const k=(v.name||'').trim().toLowerCase(); if(!k) return; (byName[k]=byName[k]||[]).push({uid,...v}); }
      });
      dupSuggestion = [];
      Object.values(byName).forEach(list=>{
        if(list.length>1){ list.sort((a,b)=>(b.updatedAt||b.createdAt||0)-(a.updatedAt||a.createdAt||0)); dupSuggestion.push({keep:list[0], remove:list.slice(1)}); }
      });
      renderDupList();
    }catch(e){ console.error(e); $('#dupEmpty').textContent='Scan failed.'; }
  }
  async function disableSuggestedDup(){
    if(!dupSuggestion.length) return;
    let changed=0;
    for(const g of dupSuggestion){
      for(const r of g.remove){ try{ await update(ref(db,`user/${r.uid}`), { role:'disabled', disabledAt:Date.now() }); changed++; }catch(e){ console.warn('disable fail', r.uid, e); } }
    }
    toast(`Disabled ${changed} duplicates`);
    dupSuggestion=[]; renderDupList(); await loadUsers();
  }
  function renderDupList(){
    const list=$('#dupList'); list.innerHTML='';
    if(!dupSuggestion.length){ $('#dupEmpty').style.display='block'; $('#dupEmpty').textContent='No duplicates.'; $('#disableDupBtn').disabled=true; return; }
    $('#dupEmpty').style.display='none'; $('#disableDupBtn').disabled=false;
    dupSuggestion.forEach(g=>{
      const li=document.createElement('div'); li.className='item';
      const remove = g.remove.map(r=>`${html(r.name||'device')} — <span class="muted">${html(r.email||r.uid)}</span>`).join('<br/>');
      li.innerHTML=`<div><b>${html(g.keep.name||'device')}</b> <span class="tag">keep</span><div class="muted">${html(g.keep.email||g.keep.uid)}</div></div><div class="muted">Duplicates to disable:<br/>${remove}</div>`;
      list.appendChild(li);
    });
  }

  async function loadUsers(){
    const search = ($('#userSearch').value||'').toLowerCase();
    const fDid = $('#filterDealer').value; const fRole=$('#filterRole').value;

    let map={}; try{ const s=await get(ref(db,'user')); if(s.exists()) map=s.val(); }catch(e){}
    const rows = Object.entries(map).map(([uid,v])=>({uid,...v}));

    const filtered = rows.filter(r=>{
      if(fDid && r.dealershipId!==fDid) return false;
      if(fRole && (r.role||'user')!==fRole) return false;
      if(search && !((r.email||'').toLowerCase().includes(search) || (r.name||'').toLowerCase().includes(search))) return false;
      return true;
    });

    const counts={admin:0,device:0,user:0,disabled:0};
    filtered.forEach(r=> counts[r.role||'user'] = (counts[r.role||'user']||0)+1);
    $('#countAdmins').textContent=counts.admin||0;
    $('#countDevices').textContent=counts.device||0;
    $('#countUsers').textContent=counts.user||0;
    $('#countDisabled').textContent=counts.disabled||0;

    const list=$('#userList'); list.innerHTML='';
    $('#userEmpty').style.display = filtered.length? 'none':'block';

    filtered.sort((a,b)=> (a.dealershipName||a.dealershipId||'').localeCompare(b.dealershipName||b.dealershipId||'') || (a.email||'').localeCompare(b.email||''));

    list.innerHTML = filtered.map(r=>{
      const dealer=r.dealershipName||r.dealershipId||'—';
      return `
      <div class="item">
        <div style="display:flex;flex-direction:column;gap:4px;min-width:240px">
          <b>${html(r.name||'No name')}</b>
          <div class="muted">${html(r.email||'')}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span class="tag">${html(r.role||'user')}</span>
            <span class="tag">${html(dealer)}</span>
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn" data-act="reset" data-email="${html(r.email||'')}">Reset</button>
          <button class="btn" data-act="role" data-uid="${r.uid}">Role</button>
          <button class="btn" data-act="move" data-uid="${r.uid}">Move</button>
          <button class="btn ${ (r.role==='disabled')?'':'danger' }" data-act="toggle" data-uid="${r.uid}" data-role="${r.role||'user'}">${(r.role==='disabled')?'Enable':'Disable'}</button>
        </div>
      </div>`;
    }).join('');

    list.querySelectorAll('button[data-act="reset"]').forEach(b=>{
      b.addEventListener('click', async ()=>{ const email=b.getAttribute('data-email'); if(!email) return; try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(e){ console.error(e); toast('Reset failed', true); }});
    });
    list.querySelectorAll('button[data-act="role"]').forEach(b=>{
      b.addEventListener('click', async ()=>{ const uid=b.getAttribute('data-uid'); const role=prompt('Role: admin, user, device','user'); if(!role) return; try{ await update(ref(db,`user/${uid}`),{role}); toast('Updated'); await loadUsers(); }catch(e){ console.error(e); toast('Update failed', true); }});
    });
    list.querySelectorAll('button[data-act="move"]').forEach(b=>{
      b.addEventListener('click', async ()=>{ const uid=b.getAttribute('data-uid'); const did=prompt('New dealership ID'); if(!did) return; let name=did; try{ const p=await get(ref(db,`dealershipPublic/${did}`)); if(p.exists()) name=p.val()?.name||did; }catch(e){}; try{ await update(ref(db,`user/${uid}`),{dealershipId:did, dealershipName:name}); toast('Moved'); }catch(e){ console.error(e); toast('Move failed', true); }});
    });
    list.querySelectorAll('button[data-act="toggle"]').forEach(b=>{
      b.addEventListener('click', async ()=>{ const uid=b.getAttribute('data-uid'); const role=b.getAttribute('data-role')||'user'; const next = role==='disabled'?'user':'disabled'; try{ await update(ref(db,`user/${uid}`),{role:next, disabledAt:next==='disabled'?Date.now():null}); toast(next==='disabled'?'Disabled':'Enabled'); await loadUsers(); }catch(e){ console.error(e); toast('Change failed', true); }});
    });
  }

  // ===== Calendar + Reminders (local) =====
  const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const calDow = document.getElementById('calDow'); const calDays = document.getElementById('calDays');
  DOW.forEach(d=>{ const el=document.createElement('div'); el.className='dow'; el.textContent=d; calDow.appendChild(el); });

  let cur = new Date(); cur.setDate(1);
  let selectedDayISO = todayISO();
  document.getElementById('selDateLabel').textContent = selectedDayISO;
  document.getElementById('calPrev').addEventListener('click', ()=>{ cur.setMonth(cur.getMonth()-1); buildCalendar(); });
  document.getElementById('calNext').addEventListener('click', ()=>{ cur.setMonth(cur.getMonth()+1); buildCalendar(); });
  document.getElementById('addEventBtn').addEventListener('click', addCalendarEvent);

  function buildCalendar(){
    const y=cur.getFullYear(), m=cur.getMonth();
    document.getElementById('calMonthLabel').textContent = cur.toLocaleString('default',{month:'long',year:'numeric'});
    calDays.innerHTML='';
    const firstDow = new Date(y,m,1).getDay();
    const daysInMonth = new Date(y,m+1,0).getDate();
    for(let i=0;i<firstDow;i++){ const pad=document.createElement('div'); calDays.appendChild(pad); }
    for(let d=1; d<=daysInMonth; d++){
      const dt = new Date(y,m,d);
      const iso = dt.toISOString().slice(0,10);
      const el = document.createElement('div'); el.className='day'+(iso===todayISO()?' today':''); el.dataset.iso=iso;
      el.innerHTML = `<div class="n">${d}</div><div class="chips" id="chips-${iso}" style="display:flex;gap:4px;flex-wrap:wrap"></div>`;
      el.addEventListener('click', ()=> selectDate(iso));
      calDays.appendChild(el);
      loadEventChips(iso);
    }
    selectDate(selectedDayISO);
  }
  async function loadEventChips(iso){
    const wrap = document.getElementById(`chips-${iso}`); if(!wrap) return;
    wrap.innerHTML='';
    try{ const s=await get(ref(db,`admin/calendar/${iso}`)); const map=s.val()||{}; Object.values(map).slice(0,3).forEach(e=>{ const p=document.createElement('span'); p.className='pill'; p.textContent=(e.title||'Event'); wrap.appendChild(p); }); }catch(e){}
  }
  async function selectDate(iso){
    selectedDayISO = iso; document.getElementById('selDateLabel').textContent = iso;
    document.getElementById('evList').innerHTML=''; document.getElementById('evEmpty').style.display='block';
    try{
      const s=await get(ref(db,`admin/calendar/${iso}`)); const map=s.val()||{}; const list=document.getElementById('evList'); const ids=Object.keys(map);
      document.getElementById('evEmpty').style.display = ids.length? 'none':'block';
      ids.forEach(id=>{
        const ev=map[id];
        const li=document.createElement('li'); li.className='item';
        const timeStr = ev.time || '';
        const bell = ev.remindAt ? '🔔' : '';
        li.innerHTML=`<div style="display:flex;flex-direction:column;gap:4px;min-width:220px">
            <b>${html(ev.title||'Event')} ${bell}</b>
            <div class="muted">${html(ev.dealer||'')} ${timeStr?('• '+timeStr):''}</div>
            <div class="muted">${html(ev.notes||'')}</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn" data-remind="${id}">Reminder</button>
            <button class="btn danger" data-del="${id}">Delete</button>
          </div>`;
        list.appendChild(li);
      });
      list.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{ const id=btn.getAttribute('data-del'); try{ await remove(ref(db,`admin/calendar/${iso}/${id}`)); toast('Event deleted'); selectDate(iso); loadEventChips(iso); }catch(e){ console.error(e); toast('Delete failed', true); } });
      });
      list.querySelectorAll('button[data-remind]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.getAttribute('data-remind');
          const evSnap=await get(ref(db,`admin/calendar/${iso}/${id}`)); const ev=evSnap.val()||{};
          if(!ev.time){ return toast('Add a time first', true); }
          const remindMin = Number(prompt('Minutes before to remind?', String(ev.remMin||30)))||30;
          const [hh,mm] = String(ev.time).split(':').map(x=>parseInt(x,10)||0);
          const when = new Date(`${iso}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
          when.setMinutes(when.getMinutes()-remindMin);
          await update(ref(db,`admin/calendar/${iso}/${id}`), { remMin:remindMin, remindAt: when.getTime() });
          scheduleLocalReminder(ev.title||'Event', iso, when.getTime());
          toast('Reminder set');
          selectDate(iso);
        });
      });
    }catch(e){}
  }
  async function addCalendarEvent(){
    const title=$('#evTitle').value.trim(); if(!title) return toast('Title? ',true);
    const dealer=$('#evDealer').value; const notes=$('#evNotes').value.trim(); const time=$('#evTime').value.trim();
    const remMin= Number($('#evRemMin').value||0);
    try{
      let remindAt=null;
      if(time && remMin>0){
        const [hh,mm]=time.split(':').map(x=>parseInt(x,10)||0);
        const when = new Date(`${selectedDayISO}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
        when.setMinutes(when.getMinutes()-remMin); remindAt= when.getTime();
      }
      const refPush = await push(ref(db,`admin/calendar/${selectedDayISO}`), { title, dealer, notes, time: time||null, remMin: remMin||null, remindAt, createdAt:Date.now(), createdBy:auth.currentUser?.email||'admin' });
      $('#evTitle').value=''; $('#evNotes').value=''; $('#evTime').value=''; $('#evRemMin').value='';
      toast('Added'); selectDate(selectedDayISO); loadEventChips(selectedDayISO);
      if(remindAt){ scheduleLocalReminder(title, selectedDayISO, remindAt); }
    }catch(e){ console.error(e); toast('Add failed', true); }
  }

  // Local reminders (works while tab is open; optional Web Notifications)
  const localTimers = new Map();
  async function scheduleLocalReminder(title, iso, whenMs){
    if(Notification && Notification.permission==='default'){ try{ await Notification.requestPermission(); }catch(e){} }
    const key = `${iso}:${title}:${whenMs}`;
    if(localTimers.has(key)){ clearTimeout(localTimers.get(key)); localTimers.delete(key); }
    const delay = Math.max(0, whenMs-Date.now());
    const t = setTimeout(()=>{
      try{
        if(Notification && Notification.permission==='granted'){
          new Notification('IPTV — Reminder', { body: `${title} (${iso})` });
        }else{
          toast(`Reminder: ${title}`, false);
        }
      }catch(e){ toast(`Reminder: ${title}`, false); }
      localTimers.delete(key);
    }, delay);
    localTimers.set(key,t);
  }

  // ===== Links (Quick Access) =====
  const DEFAULT_LINKS = [
    { emoji:'🔥', title:'Firebase — Overview', href:'https://console.firebase.google.com/project/iptv-bfa/overview', desc:'Console home' },
    { emoji:'🗄️', title:'Firebase — Database', href:'https://console.firebase.google.com/project/iptv-bfa/database/iptv-bfa-default-rtdb/data', desc:'Realtime DB data' },
    { emoji:'👤', title:'Firebase — Auth', href:'https://console.firebase.google.com/project/iptv-bfa/authentication/users', desc:'Users & providers' },
    { emoji:'🐙', title:'GitHub Repo', href:'https://github.com/flaviothebfagroup/IPTV-', desc:'Source code' }
  ];
  const LINKS_DB_PATH = 'admin/quickLinks';
  let quickLinks=[], quickLinksSource='db';

  $('#qlAddBtn').addEventListener('click', async ()=>{
    const title=$('#qlTitle').value.trim(); const href=$('#qlHref').value.trim();
    const emoji=$('#qlEmoji').value.trim(); const img=$('#qlImg').value.trim(); const desc=$('#qlDesc').value.trim();
    if(!title||!href) return toast('Title & URL', true);
    quickLinks.push({title,href,emoji,img,desc});
    await quickLinksSave();
    ['#qlTitle','#qlHref','#qlEmoji','#qlImg','#qlDesc'].forEach(s=>$(s).value='');
    renderApps();
    toast('Link added');
  });
  $('#qlResetBtn').addEventListener('click', async ()=>{
    quickLinks=[...DEFAULT_LINKS]; await quickLinksSave(true); renderApps(); toast('Links reset');
  });

  async function quickLinksLoadRender(){
    try{
      const s=await get(ref(db, LINKS_DB_PATH));
      if(s.exists()){ quickLinks=Object.values(s.val()); quickLinksSource='db'; $('#qlStorageNote').textContent='Links are synced from database.'; }
      else throw new Error('empty');
    }catch(e){
      try{
        quickLinks = JSON.parse(localStorage.getItem('admin_quick_links')||'[]');
        if(!quickLinks.length) quickLinks=[...DEFAULT_LINKS];
        quickLinksSource='local'; $('#qlStorageNote').textContent='Links stored locally (no DB permission).';
      }catch(_){
        quickLinks=[...DEFAULT_LINKS]; quickLinksSource='local'; $('#qlStorageNote').textContent='Links stored locally.';
      }
    }
    renderApps();
  }
  async function quickLinksSave(forceLocal=false){
    if(forceLocal || quickLinksSource==='local'){
      localStorage.setItem('admin_quick_links', JSON.stringify(quickLinks));
      quickLinksSource='local'; $('#qlStorageNote').textContent='Links stored locally (no DB permission).'; return;
    }
    try{ const data={}; quickLinks.forEach((l,i)=>data[i]=l); await set(ref(db,LINKS_DB_PATH), data); quickLinksSource='db'; $('#qlStorageNote').textContent='Links are synced from database.'; }
    catch(e){ localStorage.setItem('admin_quick_links', JSON.stringify(quickLinks)); quickLinksSource='local'; $('#qlStorageNote').textContent='Links stored locally (no DB permission).'; }
  }
  function renderApps(){
    const grid=$('#appsGrid'); grid.innerHTML='';
    quickLinks.forEach((l,idx)=>{
      const row=document.createElement('div'); row.className='item';
      row.innerHTML = `
        <a href="${l.href}" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit">
          ${ l.img ? `<div style="width:32px;height:32px;border:1px solid var(--border);border-radius:8px;background:#fff center/cover no-repeat;background-image:url('${l.img}')"></div>` :
                      `<div style="width:32px;height:32px;border:1px solid var(--border);border-radius:8px;display:grid;place-items:center;background:#fff">${html(l.emoji||'🔗')}</div>` }
          <div style="display:flex;flex-direction:column">
            <b>${html(l.title||'Link')}</b>
            <span class="muted" style="font-size:12px">${html(l.desc||'')}</span>
          </div>
        </a>
        <button class="btn danger" data-remove="${idx}">Remove</button>`;
      grid.appendChild(row);
    });
    grid.querySelectorAll('button[data-remove]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const i=parseInt(btn.getAttribute('data-remove'),10); quickLinks.splice(i,1); await quickLinksSave(); renderApps(); toast('Link removed');
      });
    });
  }

  // ===== Insights =====
  $('#insReload').addEventListener('click', refreshInsights);
  async function refreshInsights(){
    const did = $('#insDealer').value || null;
    let map={}; try{ const s= await get(ref(db,'displays')); if(s.exists()) map=s.val(); }catch(e){}
    const ids = Object.keys(map||{});
    // metrics
    const now=Date.now();
    let online=0,total=ids.length;
    const counts={1:0,2:0,3:0,4:0,5:0};
    ids.forEach(id=>{
      const d=map[id]||{};
      if(did && d.dealership!==did) return;
      if((d.lastSeenAt && (now-d.lastSeenAt)<60000) || (d.timestamp && (now-d.timestamp)<120000)) online++;
      const ch = (typeof d.channel==='number')? d.channel : 1; if(counts[ch]!=null) counts[ch]++;
    });
    $('#statOnline').textContent=online;
    $('#statTotal').textContent=did ? ids.filter(id=>map[id]?.dealership===did).length : total;
    // optional change counter (if you later write logs under /analytics/channelChanges/yyyy-mm-dd)
    let changes = 0;
    try{
      const day=todayISO();
      const cs = await get(ref(db,`analytics/channelChanges/${day}${did?('/'+did):''}`));
      if(cs.exists()){ const v=cs.val(); if(typeof v==='number') changes=v; else if(typeof v==='object'){ changes = Object.values(v).reduce((a,b)=>a+(+b||0),0);} }
    }catch(e){}
    $('#statChanges').textContent=changes;

    // most played
    const pairs = Object.entries(counts); pairs.sort((a,b)=>b[1]-a[1]);
    $('#statTop').textContent = pairs[0][1] ? `CH ${pairs[0][0]}` : '—';

    drawBarChart('chChannels', counts);
  }
  function drawBarChart(canvasId, counts){
    const c = document.getElementById(canvasId); if(!c) return; const ctx = c.getContext('2d');
    const W=c.width, H=c.height; ctx.clearRect(0,0,W,H);
    const keys=[1,2,3,4,5]; const vals=keys.map(k=>counts[k]||0); const max=Math.max(1,...vals);
    const pad=24; const barW=(W - pad*2) / keys.length * 0.6; const gap=(W - pad*2) / keys.length * 0.4;
    const base=H-30;
    // axis
    ctx.strokeStyle='rgba(0,0,0,0.15)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,base); ctx.lineTo(W-pad,base); ctx.stroke();
    // bars
    const maxVal=Math.max(...vals); const maxIndex = vals.indexOf(maxVal);
    keys.forEach((k,i)=>{
      const v=vals[i]; const x=pad + i*((barW+gap)) + gap/2; const h=(v/max)*(H-60);
      ctx.fillStyle = (i===maxIndex)? '#ff9500' : '#0b0b0c';
      ctx.fillRect(x, base-h, barW, h);
      // labels
      ctx.fillStyle='#0b0b0c'; ctx.font='12px system-ui'; ctx.textAlign='center';
      ctx.fillText(`CH ${k}`, x+barW/2, base+14);
      ctx.fillText(String(v), x+barW/2, base-h-6);
    });
  }

  // ===== helpers used earlier =====
  async function migrateDealerId(oldId,newId,name){ /* (already defined above) */ }
  async function countDisplaysForDealer(did){ /* (already defined above) */ }

  // ===== Init =====
  buildCalendar(); // draw DOW
  goHome(); // default view
</script>
</body>
</html>