<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Digital Signage — Player</title>
  <style>
    :root{ --bg:#000; --fg:#fff; --muted:#b3b3b3; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.15); --accent:#ff9500; --ok:#22c55e; --err:#ef4444; }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{ background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif; overflow:hidden; position:relative; }
    .video-container{position:absolute; inset:0; background:#000}
    video{width:100%; height:100%; object-fit:cover; background:#000}
    .loading-overlay{ position:absolute; inset:0; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity .25s; }
    .loading-overlay.active{opacity:1; pointer-events:auto}
    .spinner{ width:54px; height:54px; border-radius:50%; border:3px solid rgba(255,255,255,.15); border-top-color:#fff; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .channel-info{ position:absolute; top:18px; left:18px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 14px; z-index:50; opacity:0; transform:translateY(-8px); transition:opacity .25s, transform .25s; }
    .channel-info.show{opacity:1; transform:translateY(0)}
    .channel-name{font-weight:800}
    .channel-sub{font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center}
    .live-dot{width:8px;height:8px;border-radius:50%; background:var(--accent); box-shadow:0 0 0 0 rgba(255,149,0,.7); animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,149,0,.7)} 70%{box-shadow:0 0 0 8px rgba(255,149,0,0)} 100%{box-shadow:0 0 0 0 rgba(255,149,0,0)}}
    .status-bar{ position:absolute; right:18px; bottom:18px; display:flex; gap:10px; align-items:center; background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-size:12px; z-index:50; }
    .status-dot{width:10px;height:10px;border-radius:50%; background:var(--ok)}
    .status-dot.disconnected{background:var(--err)}
    .divider{opacity:.45}
    .display-id{ position:absolute; left:18px; bottom:18px; z-index:50; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-size:12px; color:#fff; }
    .error-message{ position:absolute; inset:auto 50% 50% auto; transform:translate(50%,-50%); background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.4); color:#fff; padding:14px 18px; border-radius:14px; display:none; z-index:80; text-align:center; }
    .error-message.show{display:block}
    .error-title{font-weight:800; margin-bottom:4px; color:var(--err)}
    .error-text{font-size:12px; color:#fff}
    .transition-overlay{position:absolute; inset:0; background:#000; z-index:40; opacity:0; pointer-events:none; transition:opacity .25s}
    .transition-overlay.active{opacity:1}
    .volume-control{ position:absolute; left:50%; bottom:100px; transform:translateX(-50%); display:flex; align-items:center; gap:12px; z-index:70; background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .2s; }
    .volume-control.show{opacity:1; pointer-events:auto}
    .vol-btn{ width:40px; height:40px; border-radius:50%; border:1px solid var(--border); background:transparent; color:#fff; font-size:18px; cursor:pointer; }
    .vol-track{width:160px; height:8px; border-radius:6px; background:rgba(255,255,255,.12); position:relative; overflow:hidden; border:1px solid var(--border)}
    .vol-fill{position:absolute; left:0; top:0; bottom:0; width:0%; background:var(--accent)}
    .vol-percent{font-weight:800; min-width:46px; text-align:right}
    .vol-icon{width:22px;height:22px; display:block}
    .bar{opacity:0; transition:opacity .15s}
    .icon-muted .bar, .icon-level-0 .bar{opacity:0}
    .icon-level-1 #bar1{opacity:1}
    .icon-level-2 #bar1, .icon-level-2 #bar2{opacity:1}
    .icon-level-3 #bar1, .icon-level-3 #bar2, #bar3{opacity:1}
    .icon-muted #x1, .icon-muted #x2{opacity:1}
    #x1,#x2{opacity:0; stroke:var(--err); stroke-width:2; stroke-linecap:round}
    .volume-float{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.92); border:1px solid var(--border); color:#fff; padding:26px 36px; border-radius:18px; font-weight:900; font-size:40px; z-index:90; animation:fadeHud 1.8s ease forwards; }
    @keyframes fadeHud{0%{opacity:0; transform:translate(-50%,-50%) scale(.96)} 15%{opacity:1; transform:translate(-50%,-50%) scale(1)} 85%{opacity:1} 100%{opacity:0}}
    @media (prefers-reduced-motion:reduce){ .transition-overlay,.channel-info,.loading-overlay{transition:none} }
  </style>
</head>

<body>
  <!-- Volume HUD -->
  <div class="volume-control" id="volumeHud" aria-live="polite">
    <button class="vol-btn" id="muteBtn" title="Mute/Unmute" aria-label="Mute/Unmute">
      <svg id="volSvg" class="vol-icon icon-muted" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 10v4h4l5 4V6l-5 4H3Z"></path>
        <path id="bar1" class="bar" d="M16 9a3 3 0 0 1 0 6"></path>
        <path id="bar2" class="bar" d="M18.5 7a6 6 0 0 1 0 10"></path>
        <path id="bar3" class="bar" d="M21 5a9 9 0 0 1 0 14"></path>
        <line id="x1" x1="2" y1="2" x2="22" y2="22"></line>
        <line id="x2" x1="22" y1="2" x2="2" y2="22"></line>
      </svg>
    </button>
    <button class="vol-btn" id="volDown" title="Volume down" aria-label="Volume down">−</button>
    <div class="vol-track"><div class="vol-fill" id="volFill"></div></div>
    <button class="vol-btn" id="volUp" title="Volume up" aria-label="Volume up">+</button>
    <div class="vol-percent" id="volPct">0%</div>
  </div>

  <div class="video-container">
    <video id="videoPlayer" autoplay playsinline></video>
  </div>

  <div class="loading-overlay" id="loading"><div class="spinner"></div></div>

  <div class="channel-info" id="channelInfo">
    <div class="channel-name" id="chName">Channel</div>
    <div class="channel-sub"><span class="live-dot"></span><span>LIVE • CH <span id="chNum">1</span></span></div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="statusDot" title="Connection"></div>
    <span id="statusText">Connected</span>
    <span class="divider">•</span>
    <span id="clock">00:00</span>
  </div>

  <div class="display-id">Display: <b id="displayId">—</b></div>

  <div class="error-message" id="errToast">
    <div class="error-title">Stream Unavailable</div>
    <div class="error-text" id="errText">Reconnecting…</div>
  </div>

  <div class="transition-overlay" id="fade"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>

  <script>
    /* ================== CONFIG (Admin will inject) ================== */
    var CONFIG = {
      displayId: 'Claude',
      dealershipName: 'Claude',
      channels: [
        { id:1, name:'News',     url:'https://citynewsregional.akamaized.net/hls/live/1024052/Regional_Live_7/Video-2Mbps.m3u8', type:'hls' },
        { id:2, name:'Olympics', url:'https://dai.google.com/linear/hls/pa/event/sfQoQ_zET42kay3DTlOY6Q/stream/7f09666c-3b35-4a7a-a175-dc6a73e6ac4e:CHS/variant/f3814d1565b9b6d1500e7dd4fe87beef/bandwidth/3102000.m3u8', type:'hls' },
        { id:3, name:'Cooking',  url:'https://gusto-xumo.amagi.tv/playlist.m3u8', type:'hls' },
        { id:4, name:'Nature',   url:'https://aegis-cloudfront-1.tubi.video/6d6d0f24-8445-4b4c-bdf6-44f9e38beaa4/playlist.m3u8', type:'hls' },
        { id:5, name:'Kids',     url:'https://c0c65b821b3542c3a4dca92702f59944.mediatailor.us-east-1.amazonaws.com/v1/master/04fd913bb278d8775298c26fdca9d9841f37601f/RakutenTV-eu_BabySharkTV/playlist.m3u8', type:'hls' }
      ]
    };

    var CORS_PROXY_BASE = '';

    /* ================== Player logic ================== */
    var hls = null;
    window.currentChannel = 1;
    window.currentVolume  = 0;
    window.isMuted        = true;
    var lastVolume = 50;

    function $(id) {
      return document.getElementById(id);
    }
    
    var _hudTimer = null;
    var _attempt = { useProxy:false, enableWorker:true, triedNative:false, tries:0 };

    document.addEventListener('DOMContentLoaded', function() {
      $('displayId').textContent = CONFIG.displayId;
      initVideo(); 
      initVolumeUI(); 
      tickClock(); 
      setInterval(tickClock, 1000);
      loadChannel(1);
    });

    function initVideo() {
      var v = $('videoPlayer');
      v.volume = 0;
      v.muted  = true;
      v.addEventListener('loadstart', function() { showLoading(true); });
      v.addEventListener('canplay', function() { showLoading(false); });
      v.addEventListener('stalled', function() { showLoading(true); });
      v.addEventListener('error', onVideoError);

      v.addEventListener('playing', function() {
        if (!window.isMuted) forceUnmute(v);
      });

      $('volUp').onclick = function() { volumeUp(); };
      $('volDown').onclick = function() { volumeDown(); };
      $('muteBtn').onclick = function() { toggleMute(); };
    }

    function initVolumeUI() {
      var sv = localStorage.getItem('displayVolume');
      var sm = localStorage.getItem('displayMuted');
      if (sv !== null) { 
        window.currentVolume = parseInt(sv, 10); 
        lastVolume = window.currentVolume || 50; 
      }
      if (sm !== null) { 
        window.isMuted = (sm === 'true'); 
      }
      var v = $('videoPlayer'); 
      v.volume = (window.currentVolume || 0) / 100; 
      v.muted = !!window.isMuted; 
      renderVolumeUI();
    }

    function renderVolumeUI() {
      var pct = Math.max(0, Math.min(100, window.currentVolume | 0));
      $('volPct').textContent = pct + '%';
      $('volFill').style.width = pct + '%';
      var svg = $('volSvg');
      svg.classList.remove('icon-muted', 'icon-level-0', 'icon-level-1', 'icon-level-2', 'icon-level-3');
      if (window.isMuted || pct === 0) {
        svg.classList.add('icon-muted');
      } else if (pct > 0 && pct <= 33) {
        svg.classList.add('icon-level-1');
      } else if (pct > 33 && pct <= 66) {
        svg.classList.add('icon-level-2');
      } else {
        svg.classList.add('icon-level-3');
      }
      localStorage.setItem('displayVolume', window.currentVolume);
      localStorage.setItem('displayMuted', window.isMuted);
    }

    function showVolumeHud(temp) {
      var hud = $('volumeHud');
      hud.classList.add('show');
      if (_hudTimer) clearTimeout(_hudTimer);
      if (temp !== false) {
        _hudTimer = setTimeout(function() {
          hud.classList.remove('show');
        }, 3000);
      }
    }

    function hideVolumeHud() {
      $('volumeHud').classList.remove('show');
      if (_hudTimer) clearTimeout(_hudTimer);
      _hudTimer = null;
    }

    function flashVolumeFloat() {
      var existing = document.querySelector('.volume-float');
      if (existing) existing.remove();
      
      var div = document.createElement('div');
      div.className = 'volume-float';
      div.textContent = (window.isMuted ? 'MUTE' : window.currentVolume + '%');
      document.body.appendChild(div);
      
      setTimeout(function() {
        div.remove();
      }, 1800);
    }

    function setVolume(n) {
      window.currentVolume = Math.max(0, Math.min(100, n | 0));
      var v = $('videoPlayer');
      v.volume = window.currentVolume / 100;
      if (window.currentVolume > 0 && window.isMuted) {
        window.isMuted = false;
        v.muted = false;
      }
      renderVolumeUI();
      flashVolumeFloat();
    }

    function volumeUp() {
      setVolume(window.currentVolume + 5);
      showVolumeHud();
    }

    function volumeDown() {
      setVolume(window.currentVolume - 5);
      showVolumeHud();
    }

    function mute() {
      if (!window.isMuted) lastVolume = window.currentVolume || 50;
      window.isMuted = true;
      var v = $('videoPlayer');
      v.muted = true;
      renderVolumeUI();
      flashVolumeFloat();
    }

    function unmute() {
      window.isMuted = false;
      var v = $('videoPlayer');
      v.muted = false;
      if (window.currentVolume === 0) {
        window.currentVolume = lastVolume;
        v.volume = window.currentVolume / 100;
      }
      forceUnmute(v);
      renderVolumeUI();
      flashVolumeFloat();
    }

    function toggleMute() {
      if (window.isMuted) {
        unmute();
      } else {
        mute();
      }
      showVolumeHud();
    }

    function forceUnmute(v) {
      v.muted = false;
      v.volume = (window.currentVolume || 0) / 100;
      if (v.paused) {
        v.play().catch(function() {});
      }
    }

    function tickClock() {
      var d = new Date();
      var h = d.getHours();
      var m = d.getMinutes();
      var ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      m = m < 10 ? '0' + m : m;
      $('clock').textContent = h + ':' + m + ' ' + ampm;
    }

    function setStatus(ok, msg) {
      var dot = $('statusDot');
      var txt = $('statusText');
      if (ok) {
        dot.classList.remove('disconnected');
        txt.textContent = 'Connected';
      } else {
        dot.classList.add('disconnected');
        txt.textContent = msg || 'Disconnected';
      }
    }

    function showLoading(show) {
      var ld = $('loading');
      if (show) {
        ld.classList.add('active');
      } else {
        ld.classList.remove('active');
      }
    }

    function showError(msg) {
      var toast = $('errToast');
      $('errText').textContent = msg;
      toast.classList.add('show');
      setTimeout(function() {
        toast.classList.remove('show');
      }, 3500);
    }

    function updateChannelInfo(ch) {
      $('chName').textContent = ch.name || 'Channel';
      $('chNum').textContent = ch.id;
      var info = $('channelInfo');
      info.classList.add('show');
      setTimeout(function() {
        info.classList.remove('show');
      }, 4000);
    }

    function onVideoError(e) {
      console.log('[video] error event', e);
      showError('Playback error — retrying…');
      retrySoon();
    }

    function retrySoon() {
      setTimeout(function() {
        loadChannel(window.currentChannel);
      }, 2000);
    }

    function destroyHls() {
      if (hls) {
        try {
          hls.destroy();
        } catch (ex) {}
        hls = null;
      }
    }

    function httpsifyAny(url) {
      if (!url) return url;
      if (url.indexOf('http://') === 0) return 'https://' + url.substring(7);
      return url;
    }

    function loadChannel(n) {
      var ch = CONFIG.channels.find(function(c) { return c.id === n; });
      if (!ch) {
        showError('Channel not found');
        return;
      }

      var v = $('videoPlayer');
      showLoading(true);
      destroyHls();

      _attempt = { useProxy: false, enableWorker: true, triedNative: false, tries: 0 };

      if (typeof Hls !== 'undefined' && Hls.isSupported()) {
        hls = new Hls({
          enableWorker: _attempt.enableWorker,
          lowLatencyMode: false,
          backBufferLength: 30,
          maxBufferLength: 30,
          maxMaxBufferLength: 60
        });

        var finalUrl = _attempt.useProxy ? (CORS_PROXY_BASE + encodeURIComponent(ch.url)) : httpsifyAny(ch.url);

        hls.loadSource(finalUrl);
        hls.attachMedia(v);

        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          v.play().then(function() {
            v.volume = (window.currentVolume || 0) / 100;
            v.muted = !!window.isMuted;
            setTimeout(function() {
              if (!window.isMuted) forceUnmute(v);
            }, 200);
            showLoading(false);
          }).catch(function() {
            showError('Playback blocked — retrying…');
            retrySoon();
          });
        });

        hls.on(Hls.Events.ERROR, function(event, data) {
          if (data.fatal) {
            console.log('[hls] fatal', data.type, data.details);
            
            if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
              if (!_attempt.useProxy && CORS_PROXY_BASE) {
                _attempt.useProxy = true;
                console.log('[hls] retry with proxy');
                loadChannel(n);
                return;
              }
              hls.startLoad();
              return;
            }

            if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
              hls.recoverMediaError();
              return;
            }

            if (!_attempt.triedNative) {
              _attempt.triedNative = true;
              console.log('[hls] fallback native');
              destroyHls();
              v.src = httpsifyAny(ch.url);
              v.play().then(function() {
                showLoading(false);
              }).catch(function() {});
              return;
            }

            showError('Stream error (model limitation for this URL)');
            showLoading(false);
          }
        });

      } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
        v.src = httpsifyAny(ch.url);
        v.play().then(function() {
          v.volume = (window.currentVolume || 0) / 100;
          v.muted = !!window.isMuted;
          setTimeout(function() {
            if (!window.isMuted) forceUnmute(v);
          }, 200);
          showLoading(false);
        }).catch(function() {
          showError('Playback blocked — retrying…');
          retrySoon();
        });

      } else {
        showError('HLS not supported');
        showLoading(false);
      }

      updateChannelInfo(ch);
      window.currentChannel = n;
    }

    window.setStatus = setStatus;
    window.loadChannel = loadChannel;
    window.applyVolumeSettings = function(volume, muted) {
      if (typeof volume === 'number') setVolume(volume);
      if (typeof muted === 'boolean') {
        if (muted) {
          mute();
        } else {
          unmute();
        }
      }
    };
  </script>

  <!-- ✅ FIREBASE (COMPAT, NON-MODULE) — works on stricter XD236 engines -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    (function() {
      var firebaseConfig = {
        apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
        authDomain: "iptv-bfa.firebaseapp.com",
        databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
        projectId: "iptv-bfa",
        storageBucket: "iptv-bfa.firebasestorage.app",
        messagingSenderId: "838790935867",
        appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
      };

      var displayId = CONFIG.displayId;
      var dealershipName = CONFIG.dealershipName;
      var EMBED = /\bembed=1\b/i.test(location.search) || (window.top !== window.self);

      function asInt(v) {
        if (typeof v === 'number') return Number.isFinite(v) ? v : null;
        if (typeof v === 'string') {
          var n = parseInt(v, 10);
          return Number.isFinite(n) ? n : null;
        }
        return null;
      }
      
      function asBool(v) {
        if (typeof v === 'boolean') return v;
        if (typeof v === 'string') return v.toLowerCase() === 'true';
        if (typeof v === 'number') return v !== 0;
        return null;
      }

      try { 
        firebase.initializeApp(firebaseConfig); 
      } catch (e) {}

      var auth = firebase.auth();
      var db = firebase.database();

      auth.setPersistence(EMBED ? firebase.auth.Auth.Persistence.NONE
                                : firebase.auth.Auth.Persistence.LOCAL).catch(function() {});

      auth.signInAnonymously().catch(function(e) {
        console.log('[auth] anon failed', e);
        window.setStatus(false, 'anon auth failed');
      });

      auth.onAuthStateChanged(function(user) {
        if (!user) return;

        try {
          db.ref('user/' + user.uid).update({
            role: 'device',
            name: displayId,
            dealershipId: dealershipName,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            createdAt: firebase.database.ServerValue.TIMESTAMP
          });
        } catch (e) {}

        var mapPaths = [
          dealershipName + '/displays/' + displayId,
          'dealership/' + dealershipName + '/displays/' + displayId,
          'dealerships/' + dealershipName + '/displays/' + displayId
        ];
        
        mapPaths.forEach(function(p) {
          try { 
            db.ref(p).set(true); 
          } catch (e) {}
        });

        var dref = db.ref('displays/' + displayId);
        
        dref.on('value', function(snap) {
          var d = snap.val();
          if (!d) return;

          var ch = asInt(d.channel);
          if (ch && ch !== window.currentChannel) window.loadChannel(ch);

          var vol = asInt(d.volume);
          var mut = asBool(d.muted);
          if (vol !== null || mut !== null) {
            if (vol !== null) window.applyVolumeSettings(vol, window.isMuted);
            if (mut !== null) window.applyVolumeSettings(window.currentVolume, mut);
          }

          window.setStatus(true, '');
        }, function(err) {
          console.log('[listener] error', err);
          window.setStatus(false, 'listener error');
        });

        if (EMBED) return;

        try {
          dref.once('value').then(function(s) {
            if (!s.exists()) {
              return dref.update({
                channel: 1,
                volume: 50,
                muted: true,
                dealership: dealershipName,
                timestamp: firebase.database.ServerValue.TIMESTAMP
              });
            }
          }).catch(function() {});
        } catch (e) {}

        function beat() {
          dref.update({
            lastSeenAt: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
          }).catch(function() {});
        }
        
        beat();
        setInterval(beat, 15000);
      });
    })();
  </script>
</body>
</html>
