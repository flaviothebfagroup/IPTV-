<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Digital Signage — Player</title>
  <style>
    :root{ --bg:#000; --fg:#fff; --muted:#b3b3b3; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.15); --accent:#ff9500; --ok:#22c55e; --err:#ef4444; }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{ background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif; overflow:hidden; position:relative; }
    .video-container{position:absolute; inset:0; background:#000}
    video{width:100%; height:100%; object-fit:cover; background:#000}
    .loading-overlay{ position:absolute; inset:0; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity .25s; }
    .loading-overlay.active{opacity:1; pointer-events:auto}
    .spinner{ width:54px; height:54px; border-radius:50%; border:3px solid rgba(255,255,255,.15); border-top-color:#fff; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .channel-info{ position:absolute; top:18px; left:18px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 14px; z-index:50; opacity:0; transform:translateY(-8px); transition:opacity .25s, transform .25s; }
    .channel-info.show{opacity:1; transform:translateY(0)}
    .channel-name{font-weight:800}
    .channel-sub{font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center}
    .live-dot{width:8px;height:8px;border-radius:50%; background:var(--accent); box-shadow:0 0 0 0 rgba(255,149,0,.7); animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,149,0,.7)} 70%{box-shadow:0 0 0 8px rgba(255,149,0,0)} 100%{box-shadow:0 0 0 0 rgba(255,149,0,0)}}
    .status-bar{ position:absolute; right:18px; bottom:18px; display:flex; gap:10px; align-items:center; background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-size:12px; z-index:50; }
    .status-dot{width:10px;height:10px;border-radius:50%; background:var(--ok)}
    .status-dot.disconnected{background:var(--err)}
    .divider{opacity:.45}
    .display-id{ position:absolute; left:18px; bottom:18px; z-index:50; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-size:12px; color:#fff; }
    .error-message{ position:absolute; inset:auto 50% 50% auto; transform:translate(50%,-50%); background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.4); color:#fff; padding:14px 18px; border-radius:14px; display:none; z-index:80; text-align:center; }
    .error-message.show{display:block}
    .error-title{font-weight:800; margin-bottom:4px; color:var(--err)}
    .error-text{font-size:12px; color:#fff}
    .transition-overlay{position:absolute; inset:0; background:#000; z-index:40; opacity:0; pointer-events:none; transition:opacity .25s}
    .transition-overlay.active{opacity:1}
    .volume-control{ position:absolute; left:50%; bottom:100px; transform:translateX(-50%); display:flex; align-items:center; gap:12px; z-index:70; background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .2s; }
    .volume-control.show{opacity:1; pointer-events:auto}
    .vol-btn{ width:40px; height:40px; border-radius:50%; border:1px solid var(--border); background:transparent; color:#fff; font-size:18px; cursor:pointer; }
    .vol-track{width:160px; height:8px; border-radius:6px; background:rgba(255,255,255,.12); position:relative; overflow:hidden; border:1px solid var(--border)}
    .vol-fill{position:absolute; left:0; top:0; bottom:0; width:0%; background:var(--accent)}
    .vol-percent{font-weight:800; min-width:46px; text-align:right}
    .vol-icon{width:22px;height:22px; display:block}
    .bar{opacity:0; transition:opacity .15s}
    .icon-muted .bar, .icon-level-0 .bar{opacity:0}
    .icon-level-1 #bar1{opacity:1}
    .icon-level-2 #bar1, .icon-level-2 #bar2{opacity:1}
    .icon-level-3 #bar1, .icon-level-3 #bar2, #bar3{opacity:1}
    .icon-muted #x1, .icon-muted #x2{opacity:1}
    #x1,#x2{opacity:0; stroke:var(--err); stroke-width:2; stroke-linecap:round}
    .volume-float{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.92); border:1px solid var(--border); color:#fff; padding:26px 36px; border-radius:18px; font-weight:900; font-size:40px; z-index:90; animation:fadeHud 1.8s ease forwards; }
    @keyframes fadeHud{0%{opacity:0; transform:translate(-50%,-50%) scale(.96)} 15%{opacity:1; transform:translate(-50%,-50%) scale(1)} 85%{opacity:1} 100%{opacity:0}}
    @media (prefers-reduced-motion:reduce){ .transition-overlay,.channel-info,.loading-overlay{transition:none} }

    /* hidden debug panel (only when ?debug=1) */
    .dbg{ position:absolute; top:12px; right:12px; width:min(520px, calc(100vw - 24px));
      background:rgba(0,0,0,.78); border:1px solid rgba(255,255,255,.18); border-radius:14px;
      padding:10px 12px; z-index:999; font:12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      display:none; white-space:pre-wrap; word-break:break-word;
    }
    .dbg.show{display:block}
  </style>
</head>

<body>
  <!-- Volume HUD -->
  <div class="volume-control" id="volumeHud" aria-live="polite">
    <button class="vol-btn" id="muteBtn" title="Mute/Unmute" aria-label="Mute/Unmute">
      <svg id="volSvg" class="vol-icon icon-muted" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 10v4h4l5 4V6l-5 4H3Z"></path>
        <path id="bar1" class="bar" d="M16 9a3 3 0 0 1 0 6"></path>
        <path id="bar2" class="bar" d="M18.5 7a6 6 0 0 1 0 10"></path>
        <path id="bar3" class="bar" d="M21 5a9 9 0 0 1 0 14"></path>
        <line id="x1" x1="2" y1="2" x2="22" y2="22"></line>
        <line id="x2" x1="22" y1="2" x2="2" y2="22"></line>
      </svg>
    </button>
    <button class="vol-btn" id="volDown" title="Volume down" aria-label="Volume down">−</button>
    <div class="vol-track"><div class="vol-fill" id="volFill"></div></div>
    <button class="vol-btn" id="volUp" title="Volume up" aria-label="Volume up">+</button>
    <div class="vol-percent" id="volPct">0%</div>
  </div>

  <!-- IMPORTANT: keep UI the same; add muted/playsinline attrs for stricter autoplay engines -->
  <div class="video-container">
    <video id="videoPlayer"
           autoplay
           playsinline
           webkit-playsinline
           muted
           crossorigin="anonymous"></video>
  </div>

  <div class="loading-overlay" id="loading"><div class="spinner"></div></div>

  <div class="channel-info" id="channelInfo">
    <div class="channel-name" id="chName">Channel</div>
    <div class="channel-sub"><span class="live-dot"></span><span>LIVE • CH <span id="chNum">1</span></span></div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="statusDot" title="Connection"></div>
    <span id="statusText">Connected</span>
    <span class="divider">•</span>
    <span id="clock">00:00</span>
  </div>

  <div class="display-id">Display: <b id="displayId">—</b></div>

  <div class="error-message" id="errToast">
    <div class="error-title">Stream Unavailable</div>
    <div class="error-text" id="errText">Reconnecting…</div>
  </div>

  <div class="transition-overlay" id="fade"></div>

  <div class="dbg" id="dbg"></div>

  <!-- hls.js loader with fallbacks (fixes XD236 cases where cdnjs fails) -->
  <script>
    (function(){
      var sources = [
        "https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js",
        "https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js",
        "https://unpkg.com/hls.js@1.4.12/dist/hls.min.js"
      ];

      function fireReady(){
        try{
          var ev = (typeof Event === "function") ? new Event("hlsjs:ready") : (function(){ var e=document.createEvent("Event"); e.initEvent("hlsjs:ready", true, true); return e; })();
          document.dispatchEvent(ev);
        }catch(_){}
      }

      function load(i){
        if (window.Hls) return fireReady();
        if (i >= sources.length) { window.__HLS_LOAD_FAILED__ = true; return fireReady(); }
        var s = document.createElement("script");
        s.src = sources[i];
        s.async = true;
        s.onload = function(){ fireReady(); };
        s.onerror = function(){ load(i+1); };
        document.head.appendChild(s);
      }

      load(0);
    })();
  </script>

  <script>
    /* ================== CONFIG (Admin will inject) ================== */
    const CONFIG = {
      displayId: 'BFA_PRINT',
      dealershipName: 'BFA_PRINT',
      channels: [
        { id:1, name:'News',     url:'https://citynewsregional.akamaized.net/hls/live/1024052/Regional_Live_7/Video-2Mbps.m3u8', type:'hls' },
        { id:2, name:'Olympics', url:'https://dai.google.com/linear/hls/pa/event/sfQoQ_zET42kay3DTlOY6Q/stream/7f09666c-3b35-4a7a-a175-dc6a73e6ac4e:CHS/variant/f3814d1565b9b6d1500e7dd4fe87beef/bandwidth/3102000.m3u8', type:'hls' },
        { id:3, name:'Cooking',  url:'https://gusto-xumo.amagi.tv/playlist.m3u8', type:'hls' },
        { id:4, name:'Nature',   url:'https://aegis-cloudfront-1.tubi.video/6d6d0f24-8445-4b4c-bdf6-44f9e38beaa4/playlist.m3u8', type:'hls' },
        { id:5, name:'Kids',     url:'https://c0c65b821b3542c3a4dca92702f59944.mediatailor.us-east-1.amazonaws.com/v1/master/04fd913bb278d8775298c26fdca9d9841f37601f/RakutenTV-eu_BabySharkTV/playlist.m3u8', type:'hls' }

        /* CONTROL TEST (optional): known good HLS for hls.js testing:
           { id:99, name:'TEST (Mux)', url:'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8', type:'hls' }
        */
      ]
    };

    /* OPTIONAL proxy (only if you later decide to use one):
       CORS_PROXY_BASE = 'https://YOUR-WORKER.workers.dev/?url='
    */
    const CORS_PROXY_BASE = '';

    /* ================== Player logic ================== */
    let hls = null;
    window.currentChannel = 1;
    window.currentVolume  = 0;
    window.isMuted        = true;
    let   lastVolume      = 50;

    const $ = (id)=>document.getElementById(id);
    let _hudTimer=null;

    const DEBUG = /\bdebug=1\b/i.test(location.search);
    function dlog(){
      if(!DEBUG) return;
      const s = Array.from(arguments).join(' ');
      const el = $('dbg');
      el.classList.add('show');
      el.textContent = (el.textContent ? (el.textContent + "\n") : "") + s;
    }
    function dset(txt){
      if(!DEBUG) return;
      const el = $('dbg');
      el.classList.add('show');
      el.textContent = txt;
    }

    // retry state
    let _attempt = { tries:0, enableWorker:true, usedProxy:false, mode:'native-first' };

    document.addEventListener('DOMContentLoaded', ()=>{
      $('displayId').textContent = CONFIG.displayId;
      initVideo(); initVolumeUI(); tickClock(); setInterval(tickClock, 1000);

      // Wait until hls loader finishes (success OR fail), then boot playback.
      document.addEventListener('hlsjs:ready', ()=>{
        dlog('Hls loaded:', !!window.Hls, 'loadFailed:', !!window.__HLS_LOAD_FAILED__);
        boot();
      }, { once:true });

      // safety: if event never fires, boot anyway
      setTimeout(()=>{ try{ boot(); }catch(_){} }, 3000);
    });

    let _booted = false;
    function boot(){
      if(_booted) return;
      _booted = true;
      showEnv();
      loadChannel(1);
    }

    function showEnv(){
      const v = $('videoPlayer');
      dlog('UA:', navigator.userAgent);
      dlog('canPlay m3u8:', !!v.canPlayType && (v.canPlayType('application/vnd.apple.mpegurl') || ''));
      dlog('MediaSource:', typeof window.MediaSource !== 'undefined');
    }

    function initVideo(){
      const v=$('videoPlayer');

      // keep autoplay safe: start muted, then we can unmute later
      v.volume = 0;
      v.muted  = true;

      v.addEventListener('loadstart', ()=> showLoading(true));
      v.addEventListener('canplay',   ()=> showLoading(false));
      v.addEventListener('playing',   ()=> { showLoading(false); hideError(); dlog('event: playing'); });
      v.addEventListener('stalled',   ()=> { showLoading(true); dlog('event: stalled'); });
      v.addEventListener('error',     ()=> { onVideoError(); });

      $('volUp').onclick   = ()=> volumeUp();
      $('volDown').onclick = ()=> volumeDown();
      $('muteBtn').onclick = ()=> toggleMute();
    }

    function initVolumeUI(){
      const sv=localStorage.getItem('displayVolume');
      const sm=localStorage.getItem('displayMuted');
      if(sv!==null){ window.currentVolume=parseInt(sv,10); lastVolume=window.currentVolume||50; }
      if(sm!==null){ window.isMuted=(sm==='true'); }
      const v=$('videoPlayer');
      v.volume=(window.currentVolume||0)/100;
      v.muted=!!window.isMuted;
      renderVolumeUI();
    }

    function renderVolumeUI(){
      const pct=Math.max(0,Math.min(100,window.currentVolume|0));
      $('volFill').style.width=pct+'%';
      $('volPct').textContent=(window.isMuted||pct===0)?'0%':(pct+'%');
      const cls=window.isMuted||pct===0?'icon-muted':pct<30?'icon-level-1':pct<70?'icon-level-2':'icon-level-3';
      $('volSvg').className.baseVal='vol-icon '+cls;
    }

    function showVolumeHudBubble(text){
      const b=document.createElement('div'); b.className='volume-float'; b.textContent=text; document.body.appendChild(b);
      setTimeout(()=>{ b.remove(); }, 1800);
    }
    function flashVolumeHud(){
      const hud=$('volumeHud');
      hud.classList.add('show');
      clearTimeout(_hudTimer);
      _hudTimer=setTimeout(()=>hud.classList.remove('show'), 1500);
    }

    function toggleMute(){ window.isMuted ? mute() : unmute(); }

    function forceUnmute(v){
      v.muted = false;
      v.defaultMuted = false;
      v.removeAttribute('muted');
      v.volume = (window.currentVolume || 50) / 100;
    }

    function mute(){
      const v=$('videoPlayer');
      window.isMuted=true;
      v.muted=true;
      localStorage.setItem('displayMuted','true');
      renderVolumeUI(); flashVolumeHud(); showVolumeHudBubble('MUTED');
    }

    function unmute(){
      const v=$('videoPlayer');
      if(window.currentVolume===0){ window.currentVolume=lastVolume||50; v.volume=window.currentVolume/100; }
      window.isMuted=false;
      forceUnmute(v);
      v.play().catch(()=>{});
      localStorage.setItem('displayMuted','false');
      renderVolumeUI(); flashVolumeHud(); showVolumeHudBubble(`${window.currentVolume|0}%`);
    }

    function setVolume(vol){
      vol=Math.max(0,Math.min(100,vol|0));
      const v=$('videoPlayer');
      window.currentVolume=vol;
      if(vol>0) lastVolume=vol;
      v.volume=vol/100;
      if(vol===0){ window.isMuted=true; v.muted=true; localStorage.setItem('displayMuted','true'); }
      localStorage.setItem('displayVolume',String(vol));
      renderVolumeUI(); flashVolumeHud(); showVolumeHudBubble(window.isMuted?'MUTED':`${vol}%`);
    }
    function volumeUp(){ if(window.isMuted) unmute(); setVolume(window.currentVolume+10); }
    function volumeDown(){ setVolume(window.currentVolume-10); }

    function showError(msg){ $('errText').textContent=msg; $('errToast').classList.add('show'); dlog('ERROR:', msg); }
    function hideError(){ $('errToast').classList.remove('show'); }
    function showLoading(f){ const el=$('loading'); if(f){ el.classList.add('active'); } else { el.classList.remove('active'); hideError(); } }
    function setStatus(connected,msg){
      const dot=$('statusDot'),txt=$('statusText');
      dot.classList.toggle('disconnected',!connected);
      txt.textContent=connected?'Connected':('Disconnected'+(msg?` — ${msg}`:''));
    }
    function tickClock(){ $('clock').textContent=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'}); }
    function updateChannelInfo(ch){
      $('chName').textContent=ch.name||('Channel '+ch.id);
      $('chNum').textContent=ch.id;
      const box=$('channelInfo');
      box.classList.add('show');
      clearTimeout(box._t);
      box._t=setTimeout(()=>box.classList.remove('show'),4000);
    }

    function httpsifyAny(u){
      return (location.protocol === 'https:' && /^http:\/\//i.test(u)) ? u.replace(/^http:/i,'https:') : u;
    }
    function maybeProxy(u){
      return (CORS_PROXY_BASE && _attempt.usedProxy) ? (CORS_PROXY_BASE + encodeURIComponent(u)) : u;
    }
    function cleanedUrl(u){
      return maybeProxy(httpsifyAny(u));
    }

    function destroyHls(){
      if(!hls) return;
      try{ hls.destroy(); }catch(e){}
      hls = null;
    }

    function onVideoError(){
      const v = $('videoPlayer');
      const err = v && v.error ? ('code '+v.error.code) : 'unknown';
      showError('Playback error ('+err+') — retrying…');
      retrySoon();
    }

    function retrySoon(){
      const maxTries = 6;
      if(_attempt.tries >= maxTries){
        showError('Stream failed on this device. Likely codec/format or blocked source.');
        showLoading(false);
        return;
      }
      setTimeout(()=> loadChannel(window.currentChannel, true), 1200);
    }

    function buildHls(){
      const H = window.Hls;
      if(!H) return null;

      // loader wrapper upgrades urls + optional proxy per request
      const DefaultLoader = H.DefaultConfig.loader;
      function WrappedLoader(config){
        DefaultLoader.call(this, config);
      }
      WrappedLoader.prototype = Object.create(DefaultLoader.prototype);
      WrappedLoader.prototype.constructor = WrappedLoader;
      WrappedLoader.prototype.load = function(context, config, callbacks){
        try{
          if(context && context.url) context.url = cleanedUrl(context.url);
        }catch(_){}
        return DefaultLoader.prototype.load.call(this, context, config, callbacks);
      };

      return new H({
        enableWorker: _attempt.enableWorker,
        lowLatencyMode: false,     // compatibility-first for signage engines
        backBufferLength: 30,
        manifestLoadingTimeOut: 20000,
        fragLoadingTimeOut: 20000,
        levelLoadingTimeOut: 20000,
        loader: WrappedLoader
      });
    }

    async function inspectManifestOnce(url){
      if(!DEBUG) return;
      try{
        const res = await fetch(url, { cache: 'no-store' });
        const txt = await res.text();
        const first = txt.split('\n').slice(0, 40).join('\n');
        const codecsMatch = txt.match(/CODECS="([^"]+)"/i);
        const hasMap = /#EXT-X-MAP/i.test(txt);
        const hasKey = /#EXT-X-KEY/i.test(txt);
        dlog('manifest fetch ok:', res.status);
        dlog('CODECS:', codecsMatch ? codecsMatch[1] : '(none found)');
        dlog('EXT-X-MAP (fMP4/CMAF):', hasMap);
        dlog('EXT-X-KEY (encrypted):', hasKey);
        dlog('---manifest head---\n' + first + '\n---end---');
      }catch(e){
        dlog('manifest fetch FAILED:', (e && e.message) ? e.message : e);
      }
    }

    function loadChannel(n, isRetry=false){
      const ch=CONFIG.channels.find(c=>c.id===n); if(!ch) return;
      const v=$('videoPlayer');

      if(!isRetry){
        _attempt = { tries:0, enableWorker:true, usedProxy:false, mode:'native-first' };
      } else {
        _attempt.tries++;
      }

      showLoading(true);
      destroyHls();

      try{ v.pause(); }catch(e){}
      try{ v.removeAttribute('src'); v.load(); }catch(e){}

      const directUrl = httpsifyAny(ch.url);
      const hlsUrl    = cleanedUrl(ch.url);

      updateChannelInfo(ch);
      window.currentChannel=n;

      // DEBUG: show current state
      if(DEBUG){
        dset('');
        dlog('--- loadChannel', n, ch.name, '---');
        dlog('Hls present:', !!window.Hls, 'Hls loadFailed:', !!window.__HLS_LOAD_FAILED__);
        dlog('directUrl:', directUrl);
        dlog('hlsUrl:', hlsUrl);
        inspectManifestOnce(directUrl);
      }

      // 1) Native-first attempt (helps XD236 builds where MSE/hls.js is flaky)
      let nativeDone = false;
      const nativeTimeoutMs = 2500;

      function nativeSuccess(){
        if(nativeDone) return;
        nativeDone = true;
        dlog('native: success');
        v.volume = (window.currentVolume||0)/100;
        v.muted  = !!window.isMuted;
        setTimeout(()=>{ if(!window.isMuted) forceUnmute(v); }, 200);
        showLoading(false);
      }

      function nativeFail(reason){
        if(nativeDone) return;
        nativeDone = true;
        dlog('native: fail', reason || '');
        // go to hls.js
        startHlsJs();
      }

      const onNativeCanPlay = ()=> nativeSuccess();
      const onNativeError   = ()=> { cleanupNative(); nativeFail('video error'); };

      function cleanupNative(){
        v.removeEventListener('canplay', onNativeCanPlay);
        v.removeEventListener('error', onNativeError);
      }

      v.addEventListener('canplay', onNativeCanPlay, { once:true });
      v.addEventListener('error', onNativeError, { once:true });

      try{
        v.src = directUrl;
        // ensure muted autoplay for first play
        v.muted = true;
        v.play().catch(()=>{ /* ignore; timeout will decide */ });
      }catch(e){
        cleanupNative();
        nativeFail('exception');
        return;
      }

      setTimeout(()=>{
        cleanupNative();
        // if it started playing or has data, treat as success
        if(!nativeDone){
          if(!v.error && (v.readyState >= 2)) nativeSuccess();
          else nativeFail('timeout');
        }
      }, nativeTimeoutMs);

      // 2) hls.js fallback
      function startHlsJs(){
        // If no hls.js, we're done.
        if(!window.Hls){
          showError('HLS engine not available on this device (hls.js failed to load).');
          showLoading(false);
          return;
        }

        // reset video src before attaching MSE
        try{ v.pause(); }catch(e){}
        try{ v.removeAttribute('src'); v.load(); }catch(e){}

        hls = buildHls();
        if(!hls){
          showError('HLS init failed.');
          showLoading(false);
          return;
        }

        dlog('hls.js: starting (worker='+_attempt.enableWorker+', proxy='+_attempt.usedProxy+')');

        hls.attachMedia(v);

        hls.on(window.Hls.Events.MEDIA_ATTACHED, ()=>{
          try{ hls.loadSource(hlsUrl); }catch(e){ showError('Load failed — retrying…'); retrySoon(); }
        });

        hls.on(window.Hls.Events.MANIFEST_PARSED, ()=>{
          v.play().then(()=>{
            v.volume = (window.currentVolume||0)/100;
            v.muted  = true; // keep autoplay safe
            setTimeout(()=>{ if(!window.isMuted) forceUnmute(v); }, 250);
            showLoading(false);
          }).catch(()=>{});
        });

        hls.on(window.Hls.Events.ERROR, (evt, data)=>{
          if(!data) return;

          dlog('hls.js error:', data.type, data.details || '', 'fatal=', !!data.fatal);

          // non-fatal recoveries
          if(!data.fatal){
            return;
          }

          // fatal recovery ladder:
          // A) MEDIA_ERROR recover
          if(data.type === window.Hls.ErrorTypes.MEDIA_ERROR){
            try{
              dlog('hls.js: recoverMediaError()');
              hls.recoverMediaError();
              return;
            }catch(_){}
          }

          // B) retry without worker
          if(_attempt.enableWorker){
            _attempt.enableWorker = false;
            showError('Retrying (compat mode)…');
            return retrySoon();
          }

          // C) retry via proxy if configured
          if(CORS_PROXY_BASE && !_attempt.usedProxy){
            _attempt.usedProxy = true;
            showError('Retrying via proxy…');
            return retrySoon();
          }

          // D) give up
          showError('Stream error. This source is likely blocked/codec/format unsupported on XD236.');
          showLoading(false);
        });
      }
    }

    /* Expose for Firebase listener */
    window.setStatus = setStatus;
    window.loadChannel = loadChannel;
    window.applyVolumeSettings = function(volume,muted){
      if(typeof volume==='number') setVolume(volume);
      if(typeof muted==='boolean') muted?mute():unmute();
    };
  </script>

  <!-- Firebase (module) for the player) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, update, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};

    const EMBED = /\bembed=1\b/i.test(location.search) || (window.top !== window.self);
    const app   = initializeApp(firebaseConfig, EMBED ? 'embed' : undefined);
    const auth  = getAuth(app);
    if(EMBED){ setPersistence(auth, inMemoryPersistence).catch(()=>{}); }
    const db    = getDatabase(app);

    signInAnonymously(auth).catch(e=>{ console.error('[auth]',e); window.setStatus(false,'anon auth failed'); });

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      const displayId      = CONFIG.displayId;
      const dealershipName = CONFIG.dealershipName;

      if(EMBED){
        const dref=ref(db,`displays/${displayId}`);
        onValue(dref,(snap)=>{
          const d=snap.val(); if(!d) return;
          if(typeof d.channel==='number' && d.channel!==window.currentChannel) window.loadChannel(d.channel);
          if(d.volume!==undefined || d.muted!==undefined) window.applyVolumeSettings(d.volume, d.muted);
          window.setStatus(true,'');
        },(err)=>{ console.error('[listener]',err); window.setStatus(false,'listener error'); });
        return;
      }

      try{
        await update(ref(db,`user/${user.uid}`),{
          role:'device',
          name:displayId,
          dealershipId:dealershipName,
          updatedAt:Date.now(),
          createdAt:Date.now()
        });
      }catch(e){}

      try{
        const dRef=ref(db,`displays/${displayId}`); const snap=await get(dRef);
        if(!snap.exists()){
          await update(dRef,{ channel:1, volume:50, muted:true, dealership:dealershipName, timestamp:Date.now() });
        }
      }catch(e){}

      const dref=ref(db,`displays/${displayId}`);
      onValue(dref,(snap)=>{
        const d=snap.val(); if(!d) return;
        if(typeof d.channel==='number' && d.channel!==window.currentChannel) window.loadChannel(d.channel);
        if(d.volume!==undefined || d.muted!==undefined) window.applyVolumeSettings(d.volume, d.muted);
        window.setStatus(true,'');
      },(err)=>{ console.error('[listener]',err); window.setStatus(false,'listener error'); });

      try{
        const hbRef=ref(db,`displays/${displayId}`);
        const beat=async()=>{ try{ await update(hbRef,{ lastSeenAt:Date.now(), updatedAt:Date.now() }); }catch(e){} };
        beat(); setInterval(beat, 15000);
      }catch(e){}
    });
  </script>
</body>
</html>
