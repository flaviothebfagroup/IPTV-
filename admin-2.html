<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BFA IPTV — Advanced / Backups</title>
  <style>
    :root{--bg:#0b0b0c;--fg:#fff;--muted:#9a9aa0;--panel:#121214;--border:rgba(255,255,255,.14);--accent:#ff9500;--tile:#17171a;--ok:#22c55e;--err:#ef4444}
    body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;margin:0}
    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));border-bottom:1px solid var(--border)}
    .btn{height:34px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer}
    .btn.solid{background:var(--accent);border:0;color:#000}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:16px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .input{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px}
    .list{margin:8px 0 0;padding:0;list-style:none}
    .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px;margin:8px 0;background:var(--tile);border:1px solid var(--border);border-radius:12px;flex-wrap:wrap}
    .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
    .toast.show{opacity:1}.toast.err{background:#ff453a;color:#fff}
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;gap:10px;align-items:center"><a href="admin.html" class="btn" style="text-decoration:none">← Back to Admin</a><b>Advanced / Backups</b></div>
    <div style="display:flex;gap:8px"><button id="downloadBtn" class="btn">Download backup (JSON)</button></div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px">Restore from JSON</h2>
      <div class="row2">
        <div><input id="fileRestore" type="file" accept="application/json" class="input"></div>
        <div><button id="btnPreviewRestore" class="btn solid" style="width:100%">Preview restore</button></div>
      </div>

      <div id="restorePreview" class="card" style="display:none;margin-top:8px">
        <h3 style="margin:0 0 8px">Restore preview (select what to apply)</h3>

        <div class="item">
          <div><b>Add</b><div style="color:var(--muted);font-size:12px">New keys that will be created.</div></div>
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="selAllAdd"> Select all</label>
        </div>
        <div id="diffAdd" class="list"></div>

        <div class="item" style="margin-top:8px">
          <div><b>Update</b><div style="color:var(--muted);font-size:12px">Existing keys that will change.</div></div>
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="selAllUpd"> Select all</label>
        </div>
        <div id="diffUpd" class="list"></div>

        <div class="item" style="margin-top:8px">
          <div><b>Remove</b><div style="color:var(--muted);font-size:12px">Keys present now but missing in the file.</div></div>
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="selAllRem"> Select all</label>
        </div>
        <div id="diffRem" class="list"></div>

        <div class="row2" style="margin-top:10px">
          <button id="btnApplyRestore" class="btn solid">Apply selected</button>
          <button id="btnCancelRestore" class="btn">Cancel</button>
        </div>
      </div>

      <div class="item" style="margin-top:10px">
        <div><b>Notes</b>
          <div style="color:var(--muted);font-size:12px;margin-top:6px">
            • “Users” are merged safely on add/update (we won’t erase extra fields you already have).<br>
            • “Remove” for users will delete those user nodes from <code>/user/{uid}</code>.<br>
            • “Dealers Public” writes to <code>/dealershipPublic</code> and “Displays” writes to <code>/displays</code>.<br>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // same config as main
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig, 'admin-2');
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const $=s=>document.querySelector(s);
    const toast=(m,e=false)=>{const t=$('#toast');t.textContent=m;t.className='toast show'+(e?' err':'');setTimeout(()=>t.classList.remove('show'),2200);};
    const esc = s => String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    // Download current snapshot
    function compactUsers(u){ const out={}; Object.entries(u||{}).forEach(([uid,v])=>{ out[uid]={email:v.email||null,name:v.name||null,role:v.role||'user',dealershipId:v.dealershipId||null,dealershipName:v.dealershipName||null}; }); return out; }
    async function snapshot(){ const [dPub,disp,usr]=await Promise.all([ get(ref(db,'dealershipPublic')).catch(()=>({val:()=>null})), get(ref(db,'displays')).catch(()=>({val:()=>null})), get(ref(db,'user')).catch(()=>({val:()=>null})) ]); return { meta:{generatedAt:new Date().toISOString(),by:auth.currentUser?.email||'admin',format:'iptv-bfa@1'}, dealersPublic:dPub?.val?.()||{}, displays:disp?.val?.()||{}, users:compactUsers(usr?.val?.()||{}) }; }
    function download(filename, text){ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click(); }
    document.getElementById('downloadBtn').onclick = async ()=>{ const snap=await snapshot(); download('iptv-backup.json', JSON.stringify(snap,null,2)); };

    // Restore preview + apply
    let restoreData=null, structuredDiff=null;
    function makeDiffItemEl(item){ const el=document.createElement('div'); el.className='item'; const keyLabel=`${item.scope} / ${item.key}`; el.innerHTML=`<label style="display:flex;gap:10px;align-items:center"><input type="checkbox" data-scope="${item.scope}" data-key="${item.key}" data-type="${item.type}"/> <div>${esc(keyLabel)}</div></label>`; return el; }
    function bindSelectAll(id,container){ const master=document.getElementById(id); master.onclick=()=> container.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=master.checked); }

    document.getElementById('btnPreviewRestore').onclick = async ()=>{
      const f = document.getElementById('fileRestore').files?.[0]; if(!f) return toast('Pick a JSON file',true);
      try{ restoreData=JSON.parse(await f.text()); }catch{ return toast('Invalid JSON',true); }
      const live = await snapshot();

      const diff={add:[],update:[],remove:[]};
      function diffMap(scope,cur,next){
        const keys=new Set([...(Object.keys(cur||{})),...(Object.keys(next||{}))]);
        keys.forEach(k=>{
          const a=cur?.[k], b=next?.[k];
          if(a==null && b!=null) diff.add.push({scope,key:k,type:'add'});
          else if(a!=null && b==null) diff.remove.push({scope,key:k,type:'remove'});
          else if(JSON.stringify(a)!==JSON.stringify(b)) diff.update.push({scope,key:k,type:'update'});
        });
      }
      diffMap('dealersPublic',live.dealersPublic,restoreData.dealersPublic);
      diffMap('displays',     live.displays,     restoreData.displays);
      diffMap('users',        live.users,        restoreData.users);
      structuredDiff=diff;

      const addBox=$('#diffAdd'), updBox=$('#diffUpd'), remBox=$('#diffRem');
      addBox.innerHTML=''; updBox.innerHTML=''; remBox.innerHTML='';
      diff.add.forEach(it=> addBox.appendChild(makeDiffItemEl(it)));
      diff.update.forEach(it=> updBox.appendChild(makeDiffItemEl(it)));
      diff.remove.forEach(it=> remBox.appendChild(makeDiffItemEl(it)));

      bindSelectAll('selAllAdd',addBox); bindSelectAll('selAllUpd',updBox); bindSelectAll('selAllRem',remBox);
      document.getElementById('restorePreview').style.display='block';
      toast((diff.add.length+diff.update.length+diff.remove.length)?'Select the changes to apply':'No differences');
    };

    document.getElementById('btnCancelRestore').onclick = ()=>{ document.getElementById('restorePreview').style.display='none'; restoreData=null; structuredDiff=null; };

    document.getElementById('btnApplyRestore').onclick = async ()=>{
      if(!restoreData||!structuredDiff) return;
      const selected = Array.from(document.querySelectorAll('#restorePreview input[type="checkbox"]:checked')).map(cb=>({scope:cb.dataset.scope,key:cb.dataset.key,type:cb.dataset.type}));
      if(!selected.length) return toast('Select at least one change',true);
      if(!confirm(`Apply ${selected.length} selected change(s)?`)) return;

      try{
        const updates={};
        const put=(path,val)=> updates[path]=val;
        const del=(path)=> updates[path]=null;

        // Merge helper for users add/update: expand to /user/{uid} safely
        const liveUsers=(await get(ref(db,'user'))).val()||{};
        const mergedUsers={...liveUsers};

        for(const {scope,key,type} of selected){
          if(scope==='dealersPublic'){
            if(type==='remove') del(`dealershipPublic/${key}`);
            else put(`dealershipPublic/${key}`, restoreData.dealersPublic?.[key] ?? null);
          }else if(scope==='displays'){
            if(type==='remove') del(`displays/${key}`);
            else put(`displays/${key}`, restoreData.displays?.[key] ?? null);
          }else if(scope==='users'){
            if(type==='remove'){
              del(`user/${key}`);
              delete mergedUsers[key];
            }else{
              // safe merge
              const incoming = restoreData.users?.[key] ?? null;
              mergedUsers[key] = { ...(mergedUsers[key]||{}), ...(incoming||{}) };
            }
          }
        }

        // write users merged map in one go if any users touched
        const touchedUsers = selected.some(s=>s.scope==='users');
        if(touchedUsers){
          put('user', mergedUsers);
        }

        await update(ref(db), updates);
        toast('Restore complete ✔︎');
        document.getElementById('restorePreview').style.display='none';
      }catch(e){
        console.error(e);
        toast('Restore failed',true);
      }
    };
  </script>
</body>
</html>
