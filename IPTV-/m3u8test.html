<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BFA — IPTV Channel Tester</title>

<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

<style>
  :root{
    --brand:#ff6a00; --brand-2:#e85f00;
    --bg:#fafafa; --fg:#1f2937;
    --panel:#ffffff; --line:#e5e7eb; --muted:#6b7280;
    --radius:14px; --btn-h:46px; --ring:rgba(255,106,0,.45);
  }
  [data-theme="dark"]{
    --bg:#0b0c10; --fg:#e8ecf1; --panel:#14151a; --line:rgba(255,255,255,.10); --muted:#9aa1ac;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;}
  .page{max-width:860px;margin:16px auto;padding:16px}

  /* Header */
  .head{display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:10px;min-width:0}
  .logo{height:28px;width:auto}
  h1{font-size:clamp(18px,4.6vw,22px);margin:0;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:12px}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* Controls baseline */
  button,input,select,textarea{
    font-size:14px;height:var(--btn-h);padding:0 12px;border-radius:10px;border:1px solid var(--line);
    background:var(--panel);color:var(--fg);outline:none;
  }
  .btn{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;border:0;box-shadow:0 6px 16px rgba(255,106,0,.28);transition:transform .06s ease, filter .15s ease, box-shadow .2s ease;}
  .btn:hover{filter:brightness(1.03)}
  .btn:active{transform:translateY(1px); box-shadow:0 4px 10px rgba(255,106,0,.22)}
  .btn-outline{background:transparent;border-color:var(--brand);color:var(--brand)}
  .btn-outline:hover{background:var(--brand);color:#fff}
  .tag{font-size:12px;color:var(--muted)}
  textarea{height:auto;min-height:110px;padding:10px 12px;line-height:1.45}

  /* Icon buttons + remote focus */
  .btn-remote{position:relative;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:0 14px}
  .ico{display:inline-block;width:20px;height:20px;line-height:0;flex:0 0 20px}
  .lbl{line-height:1}
  .btn-remote:focus-visible{outline:none}
  .btn-remote:focus-visible::after,.remote-focus:focus-visible::after{content:"";position:absolute;inset:-6px;border-radius:14px;border:2px solid var(--brand);animation:bfaBlink 1.1s ease-in-out infinite;pointer-events:none;filter:drop-shadow(0 0 6px var(--ring));}
  .btn-remote.blink::after{content:"";position:absolute;inset:-8px;border-radius:16px;border:2px solid var(--brand);animation:bfaPulse 0.45s ease-out 1;pointer-events:none;}
  .btn-remote[aria-pressed="true"]{background:linear-gradient(180deg,#ff7f22,#ff6a00); color:#fff;}
  @keyframes bfaBlink{0%,100%{opacity:.95}50%{opacity:.4}}
  @keyframes bfaPulse{0%{box-shadow:0 0 0 0 var(--ring);opacity:1}70%{box-shadow:0 0 0 10px rgba(255,106,0,0);opacity:.75}100%{box-shadow:0 0 0 0 rgba(255,106,0,0);opacity:1}}

  /* Cards */
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:12px;overflow:hidden}

  /* Player */
  .player{padding:0}
  .ph{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;min-height:42px}
  .status{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.18)}
  .status.err{background:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.22)}
  .now{font-weight:700}
  .meta{margin-left:auto;color:var(--muted);font-size:12px}
  .video-shell{position:relative;aspect-ratio:16/9;background:#000}
  .video-js{position:absolute!important;inset:0;width:100%!important;height:100%!important}
  .video-js .vjs-control-bar{background:rgba(0,0,0,.35)}
  .video-js .vjs-big-play-button{background:var(--brand);border:none;border-radius:10px}
  .errbar{display:none;padding:10px 12px;background:rgba(239,68,68,.10);border-top:1px solid rgba(239,68,68,.25);color:#b91c1c}
  [data-theme="dark"] .errbar{color:#fecaca}
  .errbar.show{display:block}

  /* Main controls grid */
  .controls{display:grid;gap:10px;align-items:center;margin-top:12px;grid-template-columns:repeat(3,1fr) auto 1fr auto auto}
  .controls .btn,.controls button{min-width:0;justify-self:stretch}
  .vol{height:var(--btn-h); width:100%}

  /* Input group to keep inside borders */
  .igroup{display:grid;gap:0;margin-top:10px;grid-template-columns:160px 110px 1fr;border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--panel)}
  .igroup > *{ border:0; border-radius:0; height:var(--btn-h); }
  .igroup > * + *{ border-left:1px solid var(--line) }
  #chanSelect{ width:100% }

  /* Custom section boxes */
  .textwrap{border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--panel); margin-top:6px}
  .textwrap textarea{ border:0; border-radius:0; width:100%; min-height:120px }

  /* Direct link mini group */
  .dgroup{display:grid;gap:0;margin-top:10px;grid-template-columns:2fr 1fr 160px 160px;border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--panel)}
  .dgroup > *{ border:0; border-radius:0; height:var(--btn-h) }
  .dgroup > * + *{ border-left:1px solid var(--line) }
  .dgroup .btn,.dgroup .btn-outline{border-radius:0}

  .row{display:grid;gap:8px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:220px 1fr 1fr}

  @media (max-width:560px){
    .controls{grid-template-columns:repeat(3,1fr);grid-auto-rows:var(--btn-h)}
    .controls > *:nth-child(n+4){grid-column:span 1}
    .igroup{grid-template-columns:1fr}
    .igroup > * + *{ border-left:0; border-top:1px solid var(--line) }
    .dgroup{grid-template-columns:1fr}
    .dgroup > * + *{ border-left:0; border-top:1px solid var(--line) }
    .row.cols-3{grid-template-columns:1fr}
  }
  .theme-sel{width:110px}
</style>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <div class="head">
      <div class="brand">
        <img id="bfaLogo" class="logo" alt="BFA logo" />
        <div>
          <h1>BFA — IPTV Channel Tester</h1>
          <div class="sub">BFA orange • Video.js • Sheet B2 (URLs) / C2 (Names)</div>
        </div>
      </div>
      <div class="actions">
        <select id="themeSel" class="theme-sel remote-focus" title="Theme">
          <option value="light" selected>Light</option>
          <option value="dark">Dark</option>
        </select>
        <button id="reloadBtn" class="btn-outline btn-remote">
          <span class="ico" aria-hidden="true">
            <!-- refresh -->
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path><path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"></path></svg>
          </span>
          <span class="lbl">Reload</span>
        </button>
      </div>
    </div>

    <!-- Player -->
    <div class="card player">
      <div class="ph">
        <div id="dot" class="status"></div>
        <div id="now" class="now">Select a channel</div>
        <div id="meta" class="meta"></div>
      </div>
      <div class="video-shell">
        <video id="videoPlayer" class="video-js vjs-default-skin" playsinline webkit-playsinline controls preload="auto" data-setup="{}">
          <source src="" type="application/x-mpegURL" />
        </video>
      </div>
      <div id="errbar" class="errbar">Playback error. Some streams block cross-origin playback or autoplay. Press ▶️ if needed.</div>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="controls">
        <button id="prevBtn" class="btn btn-remote" aria-label="Previous">
          <span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="4" y="5" width="2" height="14" rx="1"></rect><path d="M19 6L9 12l10 6V6z"></path></svg></span>
          <span class="lbl">Prev</span>
        </button>

        <button id="playBtn" class="btn btn-remote" aria-pressed="false" aria-label="Play / Pause">
          <span class="ico" id="playIcon" aria-hidden="true"></span><span class="lbl" id="playLbl">Play</span>
        </button>

        <button id="nextBtn" class="btn btn-remote" aria-label="Next">
          <span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="18" y="5" width="2" height="14" rx="1"></rect><path d="M5 6l10 6L5 18V6z"></path></svg></span>
          <span class="lbl">Next</span>
        </button>

        <button id="muteBtn" class="btn-remote" aria-label="Mute / Unmute">
          <span class="ico" id="muteIcon" aria-hidden="true"></span><span class="lbl" id="muteLbl">Mute</span>
        </button>

        <input id="vol" class="vol remote-focus" type="range" min="0" max="1" step="0.05" value="0.8" aria-label="Volume" />

        <button id="pipBtn" class="btn-remote" aria-label="Picture in Picture">
          <span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"></rect><rect x="12.5" y="10" width="6.5" height="4.5" rx="1.2" fill="currentColor" stroke="none"></rect></svg></span>
          <span class="lbl">PiP</span>
        </button>

        <button id="fsBtn" class="btn-remote" aria-label="Fullscreen">
          <span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9V5h4"></path><path d="M21 9V5h-4"></path><path d="M3 15v4h4"></path><path d="M21 15v4h-4"></path></svg></span>
          <span class="lbl">Full</span>
        </button>
      </div>

      <!-- Channel jump: inside boundaries -->
      <div class="igroup" role="group" aria-label="Channel jump">
        <input id="chanInput" class="remote-focus" type="number" min="1" placeholder="Channel #" />
        <button id="goBtn" class="btn btn-remote">
          <span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M12 2v3M12 19v3M2 12h3M19 12h3"></path></svg></span>
          <span class="lbl">Go</span>
        </button>
        <select id="chanSelect" class="remote-focus"><option value="">Choose Channel</option></select>
      </div>

      <div id="loadStatus" class="tag" style="margin-top:8px"></div>
    </div>

    <!-- Custom stream area -->
    <div class="card custom">
      <!-- Direct link mini-group -->
      <label style="font-weight:700;display:block;margin-bottom:6px">Add a direct link</label>
      <div class="dgroup">
        <input id="singleUrl" placeholder="https://… (HLS link, can be any http/https — .m3u8 optional)" />
        <input id="singleName" placeholder="Optional name" />
        <button id="singleAddLocal" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg></span><span class="lbl">Add locally</span></button>
        <button id="singleAddSheet" class="btn-outline btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="18" rx="2"></rect><path d="M8 7h8M8 11h8M8 15h5"></path></svg></span><span class="lbl">Add to Sheet</span></button>
      </div>

      <!-- Bulk add (multi-lines) -->
      <label for="bulkTextarea" style="font-weight:700;display:block;margin-top:12px;margin-bottom:6px">Or paste many links (one per line). Optional name after a comma.</label>
      <div class="textwrap">
        <textarea id="bulkTextarea" placeholder="https://example.com/stream1.m3u8, My Channel
https://example.com/stream2"></textarea>
      </div>

      <div class="row cols-2" style="margin-top:8px">
        <button id="addLocalBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg></span><span class="lbl">Add locally & play last</span></button>
        <button id="addSheetBtn" class="btn-outline btn-remote" title="Appends to your Google Sheet via Apps Script"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="18" rx="2"></rect><path d="M8 7h8M8 11h8M8 15h5"></path></svg></span><span class="lbl">Add to Sheet</span></button>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <input id="sheetId"  placeholder="Spreadsheet ID" />
        <input id="sheetGid" placeholder="Worksheet gid" />
        <input id="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec" />
      </div>
      <div id="addMsg" class="tag" style="margin-top:8px"></div>
    </div>

    <div class="tag" style="margin-top:8px">Shortcuts: ←/→ (prev/next), Space (play/pause), M (mute), F (fullscreen), P (PiP)</div>
  </div>

<script>
  /* ===== Logo (tries your IPTV path, then inline SVG fallback) ===== */
  const LOGO_PRIMARY = '/IPTV-/icons/icon-192.png';
  const LOGO_FALLBACK_SVG =
    '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="28" viewBox="0 0 120 28"><rect rx="6" width="120" height="28" fill="#ff6a00"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-weight="800" font-size="14" fill="#fff">BFA</text></svg>';
  const logoImg = document.getElementById('bfaLogo');
  (function setLogo(){
    const svgData = 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(LOGO_FALLBACK_SVG);
    logoImg.src = LOGO_PRIMARY;
    logoImg.onerror = () => { logoImg.onerror=null; logoImg.src = svgData; };
  })();

  /* ===== Defaults ===== */
  const DEFAULT_SHEET_ID = '1Oh69mDuOCuy27YDYpInoVfcw3o4TlFutQEGYamBXSHE';
  const DEFAULT_SHEET_GID = '824459168';
  const DEFAULT_WEBAPP   = 'https://script.google.com/macros/s/AKfycbyOi8N0nipdc0TWvfcccVH6zNHsiVUgXLdm21vUD4vfIZR4g9-Qc2E7YnfRQvKnCYACug/exec';

  /* ===== Theme ===== */
  const themeSel = document.getElementById('themeSel');
  function applyTheme(mode){ document.documentElement.setAttribute('data-theme', mode==='dark'?'dark':'light'); localStorage.setItem('bfa_theme', mode); themeSel.value = mode; }
  applyTheme(localStorage.getItem('bfa_theme') || 'light');
  themeSel.addEventListener('change', e => applyTheme(e.target.value));

  /* ===== Player ===== */
  const player = videojs("videoPlayer",{ html5:{vhs:{overrideNative:true}}, controlBar:{volumePanel:{inline:false}}});
  const volEl = document.getElementById('vol');
  player.volume( parseFloat(localStorage.getItem('bfa_vol')||'0.8') );
  volEl.value = player.volume();
  volEl.addEventListener('input', e => { player.volume(parseFloat(e.target.value)); localStorage.setItem('bfa_vol', String(player.volume())); });

  const errbar = document.getElementById('errbar');
  const dot = document.getElementById('dot');
  function setError(msg){ errbar.textContent = 'Playback error. '+(msg||''); errbar.classList.add('show'); dot.classList.add('err'); }
  function clearError(){ errbar.classList.remove('show'); dot.classList.remove('err'); }

  player.on('error', () => setError(player.error()?.message));
  player.on('playing', () => { clearError(); updateMeta(); });
  player.on('loadedmetadata', updateMeta);
  function updateMeta(){ const tech=player.tech(true); const d=player.duration(); document.getElementById('meta').textContent=(tech?tech.name_:'html5')+(isFinite(d)&&d>0?(' • '+fmt(d)):''); }
  function fmt(s){ const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=Math.floor(s%60); return (h?h+':':'')+String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0'); }

  /* ===== Channels ===== */
  const nowEl = document.getElementById('now');
  const selectEl = document.getElementById('chanSelect');
  const chanInputEl = document.getElementById('chanInput');
  const loadStatus = document.getElementById('loadStatus');
  let channels = []; let current = -1;

  function populateDropdown(){
    selectEl.innerHTML = '<option value="">Choose Channel</option>';
    channels.forEach(ch=>{ const opt=document.createElement('option'); opt.value=ch.num; opt.text=`${ch.num}. ${ch.name}`; selectEl.appendChild(opt); });
  }
  function playIndex(idx){
    if (idx<0||idx>=channels.length) return;
    current = idx; const ch = channels[idx];
    nowEl.textContent = `Now Playing: ${ch.num}. ${ch.name}`;
    clearError();
    try{
      player.src({ type:'application/x-mpegURL', src: ch.url });
      player.play().catch(()=> setError('Autoplay blocked. Tap ▶️'));
      selectEl.value = ch.num; chanInputEl.value = '';
    }catch(e){ setError(String(e)); }
  }
  function playByNum(num){ const idx=channels.findIndex(c=>c.num===Number(num)); if(idx!==-1) playIndex(idx); }

  /* ===== Icons (inline SVG) ===== */
  const icons = {
    play:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M8 5v14l11-7-11-7z"/></svg>',
    pause:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M7 5h4v14H7zM13 5h4v14h-4z"/></svg>',
    vol:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M4 10v4h4l5 4V6l-5 4H4z"/><path d="M16 8c1.5 1.2 2.4 2.9 2.4 4.9S17.5 16.6 16 17.8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
    mute:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M4 10v4h4l5 4V6l-5 4H4z"/><path d="M19 9l-6 6M13 9l6 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>'
  };
  const playIcon = document.getElementById('playIcon');
  const playLbl  = document.getElementById('playLbl');
  const muteIcon = document.getElementById('muteIcon');
  const muteLbl  = document.getElementById('muteLbl');
  function setPlayState(paused){ playIcon.innerHTML = paused ? icons.play : icons.pause; playLbl.textContent = paused ? 'Play' : 'Pause'; }
  function setMuteState(muted){ muteIcon.innerHTML = muted ? icons.mute : icons.vol; muteLbl.textContent = muted ? 'Unmute' : 'Mute'; }

  /* ===== Remote-like blink & handlers ===== */
  function blink(el){ el.classList.remove('blink'); void el.offsetWidth; el.classList.add('blink'); }
  const prevBtn=document.getElementById('prevBtn'), playBtn=document.getElementById('playBtn'), nextBtn=document.getElementById('nextBtn'), muteBtn=document.getElementById('muteBtn'), pipBtn=document.getElementById('pipBtn'), fsBtn=document.getElementById('fsBtn'), goBtn=document.getElementById('goBtn');
  setPlayState(true); setMuteState(false);

  prevBtn.addEventListener('click', ()=>{ blink(prevBtn); if(channels.length) playIndex((current-1+channels.length)%channels.length); });
  nextBtn.addEventListener('click', ()=>{ blink(nextBtn); if(channels.length) playIndex((current+1)%channels.length); });
  playBtn.addEventListener('click', ()=>{ blink(playBtn); const p=player.paused(); p?player.play():player.pause(); playBtn.setAttribute('aria-pressed', String(p)); setPlayState(p); });
  player.on('play', ()=>{ playBtn.setAttribute('aria-pressed','true'); setPlayState(false); });
  player.on('pause',()=>{ playBtn.setAttribute('aria-pressed','false'); setPlayState(true); });
  muteBtn.addEventListener('click', ()=>{ blink(muteBtn); player.muted(!player.muted()); setMuteState(player.muted()); });
  player.on('volumechange', ()=> setMuteState(player.muted()));
  pipBtn.addEventListener('click', async ()=>{ blink(pipBtn); const el=player.el().querySelector('video'); if(!document.pictureInPictureEnabled||!el) return; try{ if(document.pictureInPictureElement) await document.exitPictureInPicture(); else await el.requestPictureInPicture(); }catch{} });
  fsBtn.addEventListener('click', ()=>{ blink(fsBtn); player.isFullscreen()?player.exitFullscreen():player.requestFullscreen(); });
  goBtn.addEventListener('click', ()=>{ blink(goBtn); const n=parseInt(chanInputEl.value,10); if(n) playByNum(n); });
  document.getElementById('reloadBtn').addEventListener('click', ()=> loadFromSheet(true));
  selectEl.addEventListener('change', ()=>{ const n=parseInt(selectEl.value,10); if(n) playByNum(n); });
  document.addEventListener('keydown', (e)=>{ if(e.repeat) return; switch(e.code){ case 'ArrowLeft': if(channels.length){ blink(prevBtn); playIndex((current-1+channels.length)%channels.length);} return; case 'ArrowRight': if(channels.length){ blink(nextBtn); playIndex((current+1)%channels.length);} return; case 'Space': e.preventDefault(); playBtn.click(); return; case 'KeyM': muteBtn.click(); return; case 'KeyF': fsBtn.click(); return; case 'KeyP': pipBtn.click(); return; case 'Enter': const n=parseInt(chanInputEl.value,10); if(n){ blink(goBtn); playByNum(n);} return; } });

  /* ===== Smart URL checks ===== */
  const URL_RE = /^https?:\/\/\S+$/i;
  const looksLikeHls = u => /\.m3u8(\?|$)/i.test(u) || /m3u8/i.test(u) || /(index|master|playlist)\b/i.test(u);
  const isUrl = u => URL_RE.test(u||'');

  /* ===== Load from Sheet (Apps Script → CSV range → full CSV) ===== */
  const sheetIdEl  = document.getElementById('sheetId');
  const sheetGidEl = document.getElementById('sheetGid');
  const webAppEl   = document.getElementById('webAppUrl');
  sheetIdEl.value  = localStorage.getItem('sheet_id')  || DEFAULT_SHEET_ID;
  sheetGidEl.value = localStorage.getItem('sheet_gid') || DEFAULT_SHEET_GID;
  webAppEl.value   = localStorage.getItem('webapp_url')|| DEFAULT_WEBAPP;
  [sheetIdEl,sheetGidEl,webAppEl].forEach(el=>el.addEventListener('change', ()=>{ localStorage.setItem('sheet_id',sheetIdEl.value.trim()); localStorage.setItem('sheet_gid',sheetGidEl.value.trim()); localStorage.setItem('webapp_url',webAppEl.value.trim()); }));

  loadFromSheet(true);

  async function loadFromSheet(autoPlayFirst=false){
    loadStatus.textContent = 'Loading list from Sheet…';
    const sheetId = sheetIdEl.value.trim(), gid = sheetGidEl.value.trim(), webapp = webAppEl.value.trim();
    localStorage.setItem('sheet_id',sheetId); localStorage.setItem('sheet_gid',gid); localStorage.setItem('webapp_url',webapp);

    // 1) Apps Script JSON
    if (isUrl(webapp)){
      try{
        const list = await fetchFromWebApp(webapp);
        if (list.length){
          channels = list.map((x,i)=>({ num:i+1, name:x.name||guessName(x.url), url:x.url }));
          populateDropdown(); loadStatus.textContent = `Loaded ${channels.length} from Web App.`; if (autoPlayFirst) playIndex(0); return;
        }
      }catch(e){ console.warn('Web App failed:', e.message); loadStatus.textContent = 'Web App fetch failed; trying CSV…'; }
    }
    // 2) Range CSV B2:C
    try{
      const rangeCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${encodeURIComponent(gid)}&range=${encodeURIComponent('B2:C')}`;
      const txt = await fetchCsv(rangeCsv);
      const rows = parseCSV(txt);
      const list = rows.map(r => ({ url:(r[0]||'').trim(), name:(r[1]||'').trim() }))
                       .filter(x => isUrl(x.url) && (looksLikeHls(x.url) || true)); // accept any http(s)
      if (list.length){
        channels = list.map((x,i)=>({ num:i+1, name:x.name||guessName(x.url), url:x.url }));
        populateDropdown(); loadStatus.textContent = `Loaded ${channels.length} from CSV range B2:C.`; if (autoPlayFirst) playIndex(0); return;
      }
    }catch(e){ console.warn('Range CSV failed:', e.message); }

    // 3) Full CSV (use B/C)
    try{
      const fullCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${encodeURIComponent(gid)}`;
      const txt = await fetchCsv(fullCsv);
      const rows = parseCSV(txt);
      const list = rows.slice(1).map(r => ({ url:(r[1]||'').trim(), name:(r[2]||'').trim() }))
                       .filter(x => isUrl(x.url));
      if (list.length){
        channels = list.map((x,i)=>({ num:i+1, name:x.name||guessName(x.url), url:x.url }));
        populateDropdown(); loadStatus.textContent = `Loaded ${channels.length} from full CSV (B/C).`; if (autoPlayFirst) playIndex(0); return;
      }
    }catch(e){ console.warn('Full CSV failed:', e.message); }

    channels = []; populateDropdown();
    loadStatus.innerHTML = `No channels found.<br/>Check sharing or Apps Script. URLs in <b>B2</b> (names optional in <b>C2</b>).`;
  }

  async function fetchFromWebApp(base){
    const u = base.includes('?') ? base + '&fn=list' : base + '?fn=list';
    const r = await fetch(u, { cache:'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    if (!data || data.ok !== true || !Array.isArray(data.channels)) throw new Error('Bad JSON');
    return data.channels.map(x => (typeof x==='string'?{url:x,name:''}:x)).filter(x => isUrl(x.url));
  }

  async function fetchCsv(url){
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const txt = await r.text();
    if (/^\s*</.test(txt)) throw new Error('Got HTML (permissions)');
    return txt;
  }

  function parseCSV(text){
    const out=[]; let row=[],cur="",inQ=false;
    for (let i=0;i<text.length;i++){
      const ch=text[i],n=text[i+1];
      if (inQ){ if (ch==='"'&&n==='"'){cur+='"';i++} else if (ch==='"'){inQ=false} else cur+=ch; }
      else { if (ch==='"'){inQ=true} else if (ch===','){row.push(cur);cur=""} else if (ch==='\n'){row.push(cur);out.push(row);row=[];cur=""} else if (ch!=='\r'){cur+=ch} }
    }
    row.push(cur); out.push(row);
    return out.filter(r=>r.some(c=>String(c||'').trim().length));
  }
  function guessName(u){ try{ const p=new URL(u).pathname.split('/').filter(Boolean); return decodeURIComponent(p.pop()||'Channel').replace(/\.(m3u8|playlist)$/i,''); }catch{return 'Channel'} }

  /* ===== Add links (Direct + Bulk) ===== */
  const addMsg = document.getElementById('addMsg');
  const bulkEl = document.getElementById('bulkTextarea');
  const singleUrlEl = document.getElementById('singleUrl');
  const singleNameEl= document.getElementById('singleName');

  function setAddMsg(t){ addMsg.textContent=t; setTimeout(()=> addMsg.textContent='', 5000); }

  const addLocalBtn = document.getElementById('addLocalBtn');
  const addSheetBtn = document.getElementById('addSheetBtn');
  const singleAddLocal = document.getElementById('singleAddLocal');
  const singleAddSheet = document.getElementById('singleAddSheet');

  singleAddLocal.addEventListener('click', ()=>{
    const url = singleUrlEl.value.trim(); const name = singleNameEl.value.trim();
    if (!isUrl(url)) return setAddMsg('Please paste a valid http(s) link.');
    const added = addLocal([{url,name}]); if (added){ playIndex(channels.length-1); singleUrlEl.value=''; singleNameEl.value=''; setAddMsg('Added locally ✔'); }
  });

  singleAddSheet.addEventListener('click', async ()=>{
    const url = singleUrlEl.value.trim(); const name = singleNameEl.value.trim();
    if (!isUrl(url)) return setAddMsg('Please paste a valid http(s) link.');
    const ok = await addToSheet([{url,name}]); setAddMsg(ok? 'Added to Sheet ✔' : 'Failed to add to Sheet'); if (ok){ singleUrlEl.value=''; singleNameEl.value=''; await loadFromSheet(false); }
  });

  addLocalBtn.addEventListener('click', ()=>{
    const items = parseBulk(bulkEl.value.trim()); if(!items.length) return setAddMsg('Paste at least one http(s) link (optional name after comma).');
    const added = addLocal(items); if (added){ playIndex(channels.length-1); bulkEl.value=''; setAddMsg(`Added ${added} locally ✔`); }
  });

  addSheetBtn.addEventListener('click', async ()=>{
    const items = parseBulk(bulkEl.value.trim()); if(!items.length) return setAddMsg('Paste at least one http(s) link (optional name after comma).');
    const ok = await addToSheet(items); setAddMsg(ok? 'Added to Sheet ✔ Reloading…' : 'Some adds failed'); if (ok){ bulkEl.value=''; await loadFromSheet(false); }
  });

  function addLocal(items){
    let added=0;
    for (const it of items){
      if (!isUrl(it.url)) continue;
      if (channels.some(c=>c.url===it.url)) continue;
      channels.push({ num:channels.length+1, name: it.name || (looksLikeHls(it.url)?guessName(it.url):'Custom'), url: it.url });
      added++;
    }
    populateDropdown(); return added;
  }

  async function addToSheet(items){
    const webapp = document.getElementById('webAppUrl').value.trim(); if (!isUrl(webapp)) return false;
    let ok=0;
    for (const it of items){
      try{
        const res = await fetch(webapp,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:it.url,name:it.name||''})});
        const data = await res.json().catch(()=> ({}));
        if (res.ok && data.ok===true) ok++;
      }catch{}
    }
    return ok===items.length;
  }

  function parseBulk(text){
    if (!text) return [];
    return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(line=>{
      const parts=line.split(','); const url=(parts[0]||'').trim(); const name=(parts.slice(1).join(',')||'').trim();
      return isUrl(url)?{url,name}:null;
    }).filter(Boolean);
  }
</script>
</body>
</html>
