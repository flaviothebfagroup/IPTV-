<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BFA — IPTV Channel Tester</title>

<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

<style>
  :root{
    --brand:#ff6a00; --brand-2:#e85f00;
    --bg:#f8fafc; --fg:#0f172a;
    --panel:#ffffff; --line:#e5e7eb; --muted:#64748b;
    --radius:14px; --btn-h:46px; --gap:14px;
  }
  [data-theme="dark"]{
    --bg:#0b0c10; --fg:#e8ecf1; --panel:#14151a; --line:rgba(255,255,255,.10); --muted:#9aa1ac;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif}
  .page{max-width:900px;margin:18px auto;padding:16px}
  .stack>*+*{margin-top:var(--gap)}

  .head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{height:30px}
  h1{margin:0;font-size:clamp(18px,4.2vw,22px);font-weight:800}
  .sub{color:var(--muted);font-size:12px}
  .actions{display:flex;gap:8px;align-items:center}
  .theme-sel{width:110px}

  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:12px;overflow:hidden}

  button,input,select,textarea{
    font-size:14px;height:var(--btn-h);padding:0 12px;border-radius:12px;border:1px solid var(--line);
    background:var(--panel);color:var(--fg);outline:none;-webkit-tap-highlight-color:transparent;
  }
  textarea{min-height:110px;padding:10px 12px;line-height:1.45}

  .btn{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;border:0;
       box-shadow:0 6px 16px rgba(255,106,0,.26)}
  .btn-outline{background:transparent;border-color:var(--brand);color:var(--brand)}
  .btn-remote{position:relative;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:0 14px}
  .ico{width:20px;height:20px;line-height:0}
  .lbl{line-height:1}

  /* No sticky outline after click; nicer hover */
  button:focus{outline:none}
  button:focus:not(:focus-visible){outline:none}
  .btn, .btn-remote{transition:transform .12s ease, box-shadow .20s ease, filter .18s ease, background .18s ease}
  .btn:hover, .btn-remote:hover{transform:translateY(-1px);filter:brightness(1.06);box-shadow:0 12px 26px rgba(255,106,0,.30)}
  .btn:active, .btn-remote:active{transform:translateY(0);filter:brightness(.98);box-shadow:0 6px 16px rgba(255,106,0,.20)}
  .btn-outline:hover{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;box-shadow:0 12px 26px rgba(255,106,0,.30)}
  .btn-remote .ico,.btn-remote .lbl{transition:transform .12s ease}
  .btn-remote:hover .ico{transform:translateX(-1px)} .btn-remote:hover .lbl{transform:translateX(1px)}

  .player{padding:0}
  .ph{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;min-height:42px}
  .status{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.18)}
  .status.err{background:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.22)}
  .now{font-weight:700}
  .meta{margin-left:auto;color:var(--muted);font-size:12px}
  .video-shell{position:relative;aspect-ratio:16/9;background:#000}
  .video-js{position:absolute!important;inset:0;width:100%!important;height:100%!important}
  .video-js .vjs-control-bar{background:rgba(0,0,0,.35)}
  .video-js .vjs-big-play-button{background:var(--brand);border:none;border-radius:10px}
  .video-js .vjs-big-play-button:focus{outline:none!important}
  .errbar{display:none;padding:10px 12px;background:rgba(239,68,68,.10);border-top:1px solid rgba(239,68,68,.25);color:#b91c1c}
  [data-theme="dark"] .errbar{color:#fecaca}
  .errbar.show{display:block}

  .controls{display:grid;gap:10px;align-items:center;margin-top:12px;
            grid-template-columns:repeat(3,1fr) auto 1fr auto auto}
  .vol{height:var(--btn-h); width:100%}

  .igroup{display:grid;gap:0;margin-top:10px;grid-template-columns:160px 110px 1fr;
          border:1px solid var(--line);border-radius:12px;overflow:hidden;background:var(--panel)}
  .igroup>*{border:0;border-radius:0;height:var(--btn-h)} .igroup>*+*{border-left:1px solid var(--line)}
  #chanSelect{width:100%}

  .textwrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:var(--panel);margin-top:6px}
  .textwrap textarea{border:0;border-radius:0;width:100%}

  .dgroup{display:grid;gap:0;margin-top:10px;grid-template-columns:2fr 1fr 160px 160px;
          border:1px solid var(--line);border-radius:12px;overflow:hidden;background:var(--panel)}
  .dgroup>*{border:0;border-radius:0;height:var(--btn-h)} .dgroup>*+*{border-left:1px solid var(--line)}

  .row{display:grid;gap:8px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:220px 1fr 1fr}

  @media (max-width:560px){
    .controls{grid-template-columns:repeat(3,1fr);grid-auto-rows:var(--btn-h)}
    .controls>*:nth-child(n+4){grid-column:span 1}
    .igroup{grid-template-columns:1fr} .igroup>*+*{border-left:0;border-top:1px solid var(--line)}
    .dgroup{grid-template-columns:1fr} .dgroup>*+*{border-left:0;border-top:1px solid var(--line)}
    .row.cols-3{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="page stack">
    <div class="head">
      <div class="brand">
        <img id="bfaLogo" class="logo" alt="BFA logo" />
        <div><h1>BFA — IPTV Channel Tester</h1><div class="sub">BFA orange • Video.js • Sheet B2 (URL), C2 (Name)</div></div>
      </div>
      <div class="actions">
        <select id="themeSel" class="theme-sel" title="Theme"><option value="light" selected>Light</option><option value="dark">Dark</option></select>
        <button id="reloadBtn" class="btn-outline btn-remote"><span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path><path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"></path></svg>
        </span><span class="lbl">Reload</span></button>
      </div>
    </div>

    <div class="card player">
      <div class="ph"><div id="dot" class="status"></div><div id="now" class="now">Select a channel</div><div id="meta" class="meta"></div></div>
      <div class="video-shell">
        <video id="videoPlayer" class="video-js vjs-default-skin" playsinline webkit-playsinline controls preload="auto" muted data-setup="{}">
          <source src="" type="application/x-mpegURL" />
        </video>
      </div>
      <div id="errbar" class="errbar">Playback error. Some streams block cross-origin playback or autoplay. Press ▶️ if needed.</div>
    </div>

    <div class="card">
      <div class="controls">
        <button id="prevBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="4" y="5" width="2" height="14" rx="1"></rect><path d="M19 6L9 12l10 6V6z"></path></svg></span><span class="lbl">Prev</span></button>
        <button id="playBtn" class="btn btn-remote" aria-pressed="false"><span class="ico" id="playIcon"></span><span class="lbl" id="playLbl">Play</span></button>
        <button id="nextBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="18" y="5" width="2" height="14" rx="1"></rect><path d="M5 6l10 6L5 18V6z"></path></svg></span><span class="lbl">Next</span></button>
        <button id="muteBtn" class="btn-remote"><span class="ico" id="muteIcon"></span><span class="lbl" id="muteLbl">Mute</span></button>
        <input id="vol" class="vol" type="range" min="0" max="1" step="0.05" value="0.8" />
        <button id="pipBtn" class="btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"></rect><rect x="12.5" y="10" width="6.5" height="4.5" rx="1.2" fill="currentColor" stroke="none"></rect></svg></span><span class="lbl">PiP</span></button>
        <button id="fsBtn" class="btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9V5h4"></path><path d="M21 9V5h-4"></path><path d="M3 15v4h4"></path><path d="M21 15v4h-4"></path></svg></span><span class="lbl">Full</span></button>
      </div>

      <div class="igroup" role="group" aria-label="Channel jump">
        <input id="chanInput" type="number" min="1" placeholder="Channel #" autocomplete="off" />
        <button id="goBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M12 2v3M12 19v3M2 12h3M19 12h3"></path></svg></span><span class="lbl">Go</span></button>
        <select id="chanSelect"><option value="">Choose Channel</option></select>
      </div>

      <div id="loadStatus" class="sub" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <label style="font-weight:700;display:block;margin-bottom:6px">Add a direct link</label>
      <div class="dgroup">
        <input id="singleUrl" placeholder="https://… (HLS link; .m3u8 optional)" autocomplete="off" />
        <input id="singleName" placeholder="Optional name" autocomplete="off" />
        <button id="singleAddLocal" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg></span><span class="lbl">Add locally</span></button>
        <button id="singleAddSheet" class="btn-outline btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="18" rx="2"></rect><path d="M8 7h8M8 11h8M8 15h5"></path></svg></span><span class="lbl">Add to Sheet</span></button>
      </div>

      <label for="bulkTextarea" style="font-weight:700;display:block;margin-top:12px;margin-bottom:6px">Or paste many links (one per line). Optional name after a comma.</label>
      <div class="textwrap"><textarea id="bulkTextarea" placeholder="https://example.com/stream1.m3u8, My Channel
https://example.com/stream2"></textarea></div>

      <div class="row cols-3" style="margin-top:10px">
        <input id="sheetId"  placeholder="Spreadsheet ID" />
        <input id="sheetGid" placeholder="Worksheet gid" />
        <input id="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec" />
      </div>
      <div class="row cols-2" style="margin-top:8px">
        <button id="addLocalBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg></span><span class="lbl">Add locally & play last</span></button>
        <button id="addSheetBtn" class="btn-outline btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="18" rx="2"></rect><path d="M8 7h8M8 11h8M8 15h5"></path></svg></span><span class="lbl">Add to Sheet</span></button>
      </div>
      <div id="addMsg" class="sub" style="margin-top:8px"></div>
    </div>

    <div class="sub">Shortcuts: ←/→ (prev/next), Space (play/pause), M (mute), F (fullscreen), P (PiP)</div>
  </div>

<script>
  /* Blur after click/tap (no sticky focus) */
  ['pointerup','click'].forEach(ev=>{
    document.addEventListener(ev,(e)=>{const b=e.target.closest('button'); if(b) setTimeout(()=>b.blur(),0)}, true);
  });

  /* Logo with SVG fallback */
  const LOGO_PRIMARY='/IPTV-/icons/icon-192.png';
  const FALLBACK='data:image/svg+xml;charset=UTF-8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="30" viewBox="0 0 120 30"><rect rx="7" width="120" height="30" fill="#ff6a00"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-weight="800" font-size="14" fill="#fff">BFA</text></svg>');
  const logo=document.getElementById('bfaLogo'); logo.src=LOGO_PRIMARY; logo.onerror=()=>{logo.onerror=null; logo.src=FALLBACK;}

  /* Defaults */
  const DEFAULT_SHEET_ID='1Oh69mDuOCuy27YDYpInoVfcw3o4TlFutQEGYamBXSHE';
  const DEFAULT_SHEET_GID='824459168';
  const DEFAULT_WEBAPP='https://script.google.com/macros/s/AKfycbyKFo_jbKUqSwmrre3Xn2lK0PR7mB4IwskGEKmk0-VfjSLB5YvcKAsclEHi8se_SQLanA/exec';

  /* Theme */
  const themeSel=document.getElementById('themeSel');
  function applyTheme(m){document.documentElement.setAttribute('data-theme',m==='dark'?'dark':'light');localStorage.setItem('bfa_theme',m);themeSel.value=m;}
  applyTheme(localStorage.getItem('bfa_theme')||'light'); themeSel.onchange=e=>applyTheme(e.target.value);

  /* Video.js */
  const player=videojs('videoPlayer',{html5:{vhs:{overrideNative:true}},controlBar:{volumePanel:{inline:false}}});
  const vol=document.getElementById('vol'); player.volume(parseFloat(localStorage.getItem('bfa_vol')||'0.8')); vol.value=player.volume();
  vol.oninput=e=>{player.volume(parseFloat(e.target.value)); localStorage.setItem('bfa_vol', String(player.volume()));};
  const errbar=document.getElementById('errbar'), dot=document.getElementById('dot');
  function setError(m){errbar.textContent='Playback error. '+(m||'');errbar.classList.add('show');dot.classList.add('err');}
  function clearError(){errbar.classList.remove('show');dot.classList.remove('err');}
  player.on('error',()=>setError(player.error()?.message));
  player.on('playing',()=>{clearError();updateMeta();});
  player.on('loadedmetadata',updateMeta);
  function updateMeta(){const tech=player.tech(true);const d=player.duration();document.getElementById('meta').textContent=(tech?tech.name_:'html5')+(isFinite(d)&&d>0?(' • '+fmt(d)):'');}
  function fmt(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=Math.floor(s%60);return(h?h+':':'')+String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0');}

  /* Channels */
  const nowEl=document.getElementById('now'), sel=document.getElementById('chanSelect'), chanInput=document.getElementById('chanInput'), loadStatus=document.getElementById('loadStatus');
  let channels=[], current=-1;
  function populate(){sel.innerHTML='<option value="">Choose Channel</option>'; channels.forEach(c=>{const o=document.createElement('option');o.value=c.num;o.text=`${c.num}. ${c.name}`;sel.appendChild(o);});}
  function playIndex(i){ if(i<0||i>=channels.length) return; current=i; const ch=channels[i]; nowEl.textContent=`Now Playing: ${ch.num}. ${ch.name}`; clearError();
    try{player.src({type:'application/x-mpegURL',src:ch.url}); player.play().catch(()=>setError('Autoplay blocked. Tap ▶️')); sel.value=ch.num; chanInput.value=''; }catch(e){ setError(String(e)); } }
  function playByNum(n){ const i=channels.findIndex(c=>c.num===Number(n)); if(i!==-1) playIndex(i); }

  const icons={ play:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M8 5v14l11-7-11-7z"/></svg>',
                pause:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M7 5h4v14H7zM13 5h4v14h-4z"/></svg>',
                vol:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M4 10v4h4l5 4V6l-5 4H4z"/><path d="M16 8c1.5 1.2 2.4 2.9 2.4 4.9S17.5 16.6 16 17.8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
                mute:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M4 10v4h4l5 4V6l-5 4H4z"/><path d="M19 9l-6 6M13 9l6 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>' };
  const playIcon=document.getElementById('playIcon'), playLbl=document.getElementById('playLbl'), muteIcon=document.getElementById('muteIcon'), muteLbl=document.getElementById('muteLbl');
  function setPlayState(p){ playIcon.innerHTML=p?icons.play:icons.pause; playLbl.textContent=p?'Play':'Pause'; }
  function setMuteState(m){ muteIcon.innerHTML=m?icons.mute:icons.vol; muteLbl.textContent=m?'Unmute':'Mute'; }
  setPlayState(true); setMuteState(false);

  const prev=document.getElementById('prevBtn'), playBtn=document.getElementById('playBtn'),
        next=document.getElementById('nextBtn'), muteBtn=document.getElementById('muteBtn'),
        pipBtn=document.getElementById('pipBtn'), fsBtn=document.getElementById('fsBtn'), go=document.getElementById('goBtn');

  const blink = el => {el.classList.remove('blink'); void el.offsetWidth; el.classList.add('blink');};

  prev.onclick =()=>{ blink(prev); if(channels.length) playIndex((current-1+channels.length)%channels.length); };
  next.onclick =()=>{ blink(next); if(channels.length) playIndex((current+1)%channels.length); };
  playBtn.onclick=()=>{ blink(playBtn); const p=player.paused(); p?player.play():player.pause(); setPlayState(p); };
  player.on('play', ()=> setPlayState(false)); player.on('pause', ()=> setPlayState(true));
  muteBtn.onclick=()=>{ blink(muteBtn); player.muted(!player.muted()); setMuteState(player.muted()); };
  player.on('volumechange', ()=> setMuteState(player.muted()));
  pipBtn.onclick = async ()=>{ blink(pipBtn); const el=player.el().querySelector('video');
    if(!document.pictureInPictureEnabled||!el) return; try{ if(document.pictureInPictureElement) await document.exitPictureInPicture(); else await el.requestPictureInPicture(); }catch{} };
  fsBtn.onclick  = ()=>{ blink(fsBtn); player.isFullscreen()?player.exitFullscreen():player.requestFullscreen(); };
  go.onclick     = ()=>{ blink(go); const n=parseInt(chanInput.value,10); if(n) playByNum(n); };
  document.getElementById('reloadBtn').onclick=()=> loadFromSheet(true);
  sel.onchange=()=>{ const n=parseInt(sel.value,10); if(n) playByNum(n); };

  document.addEventListener('keydown',(e)=>{ if(e.repeat) return;
    switch(e.code){ case 'ArrowLeft': if(channels.length){blink(prev); playIndex((current-1+channels.length)%channels.length);} return;
      case 'ArrowRight': if(channels.length){blink(next); playIndex((current+1)%channels.length);} return;
      case 'Space': e.preventDefault(); playBtn.click(); return;
      case 'KeyM': muteBtn.click(); return; case 'KeyF': fsBtn.click(); return; case 'KeyP': pipBtn.click(); return;
      case 'Enter': const n=parseInt(chanInput.value,10); if(n){blink(go); playByNum(n);} return; } });

  /* Sheet I/O */
  const sheetIdEl=document.getElementById('sheetId'), sheetGidEl=document.getElementById('sheetGid'), webAppEl=document.getElementById('webAppUrl');
  sheetIdEl.value=localStorage.getItem('sheet_id')||DEFAULT_SHEET_ID;
  sheetGidEl.value=localStorage.getItem('sheet_gid')||DEFAULT_SHEET_GID;
  webAppEl.value =localStorage.getItem('webapp_url')||DEFAULT_WEBAPP;
  [sheetIdEl,sheetGidEl,webAppEl].forEach(el=>el.addEventListener('change',()=>{
    localStorage.setItem('sheet_id',sheetIdEl.value.trim());
    localStorage.setItem('sheet_gid',sheetGidEl.value.trim());
    localStorage.setItem('webapp_url',webAppEl.value.trim());
  }));
  const isUrl=u=>/^https?:\/\/\S+$/i.test(u||'');

  async function loadFromSheet(autoPlay=false){
    loadStatus.textContent='Loading list…';
    const sheetId=sheetIdEl.value.trim(), gid=sheetGidEl.value.trim(), webapp=webAppEl.value.trim();

    if(isUrl(webapp)){
      try{ const list=await fetchListJson(webapp); if(list.length){ setList(list,'Web App JSON'); if(autoPlay) playIndex(0); return; } }
      catch{ try{ const list=await fetchListJsonp(webapp); if(list.length){ setList(list,'Web App JSONP'); if(autoPlay) playIndex(0); return; } } catch{} }
    }

    try{
      const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${encodeURIComponent(gid)}&range=${encodeURIComponent('B2:C')}`;
      const txt=await fetchCsv(url), rows=parseCSV(txt);
      const list=rows.map(r=>({url:(r[0]||'').trim(),name:(r[1]||'').trim()})).filter(x=>isUrl(x.url));
      if(list.length){ setList(list,'CSV B2:C'); if(autoPlay) playIndex(0); return; }
    }catch{}
    try{
      const url=`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${encodeURIComponent(gid)}`;
      const txt=await fetchCsv(url), rows=parseCSV(txt);
      const list=rows.slice(1).map(r=>({url:(r[1]||'').trim(),name:(r[2]||'').trim()})).filter(x=>isUrl(x.url));
      if(list.length){ setList(list,'CSV full'); if(autoPlay) playIndex(0); return; }
    }catch{}

    channels=[]; populate(); loadStatus.textContent='No channels found. Make the sheet public (Viewer) or use the Web App.';
  }

  function setList(list, source){
    channels=list.map((x,i)=>({num:i+1,name:x.name||guessName(x.url),url:x.url}));
    populate(); loadStatus.textContent=`Loaded ${channels.length} from ${source}.`;
  }

  async function fetchListJson(base){ const r=await fetch(base+(base.includes('?')?'&':'?')+'fn=list',{cache:'no-store'}); if(!r.ok) throw 0; const d=await r.json();
    if(!d||d.ok!==true||!Array.isArray(d.channels)) throw 0; return d.channels.map(x=>typeof x==='string'?{url:x,name:''}:x).filter(x=>isUrl(x.url)); }
  function fetchListJsonp(base){ return new Promise((resolve,reject)=>{
    const cb='bfa_cb_'+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{try{delete window[cb]; s.remove(); if(!data||data.ok!==true||!Array.isArray(data.channels)) return reject(); resolve(data.channels.map(x=>typeof x==='string'?{url:x,name:''}:x).filter(x=>isUrl(x.url)));}catch(e){reject(e)}};
    const s=document.createElement('script'); s.src=base+(base.includes('?')?'&':'?')+'fn=list&callback='+cb; s.onerror=()=>{delete window[cb]; s.remove(); reject();};
    document.body.appendChild(s); }); }
  async function fetchCsv(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0; const t=await r.text(); if(/^\s*</.test(t)) throw 0; return t; }
  function parseCSV(t){ const out=[]; let row=[],cur="",q=false; for(let i=0;i<t.length;i++){const c=t[i],n=t[i+1];
    if(q){ if(c=='"'&&n=='"'){cur+='"';i++} else if(c=='"'){q=false} else cur+=c; }
    else { if(c=='"'){q=true} else if(c==','){row.push(cur);cur=""} else if(c=='\n'){row.push(cur);out.push(row);row=[];cur=""} else if(c!='\r'){cur+=c} } }
    row.push(cur); out.push(row); return out.filter(r=>r.some(c=>String(c||'').trim())); }
  function guessName(u){ try{ const p=new URL(u).pathname.split('/').filter(Boolean); return decodeURIComponent(p.pop()||'Channel').replace(/\.(m3u8|playlist)$/i,''); }catch{return'Channel'} }

  /* Add links (local + sheet) */
  const addMsg=document.getElementById('addMsg'), bulk=document.getElementById('bulkTextarea'), singleUrl=document.getElementById('singleUrl'), singleName=document.getElementById('singleName');
  const msg=t=>{ addMsg.textContent=t; setTimeout(()=>addMsg.textContent='',5000); };
  document.getElementById('singleAddLocal').onclick=()=>{ const url=singleUrl.value.trim(), name=singleName.value.trim();
    if(!isUrl(url)) return msg('Paste a valid http(s) link.');
    const n=addLocal([{url,name}]); if(n){ playIndex(channels.length-1); singleUrl.value=''; singleName.value=''; msg('Added locally ✔'); } };
  document.getElementById('singleAddSheet').onclick=async()=>{ const url=singleUrl.value.trim(), name=singleName.value.trim();
    if(!isUrl(url)) return msg('Paste a valid http(s) link.');
    const ok=await addToSheet([{url,name}]); msg(ok?'Added to Sheet ✔':'Add failed'); if(ok){ singleUrl.value=''; singleName.value=''; setTimeout(()=>loadFromSheet(false),800); } };
  document.getElementById('addLocalBtn').onclick=()=>{ const items=parseBulk(bulk.value.trim()); if(!items.length) return msg('Paste lines of links, optional name after comma.');
    const n=addLocal(items); if(n){ playIndex(channels.length-1); bulk.value=''; msg(`Added ${n} locally ✔`); } };
  document.getElementById('addSheetBtn').onclick=async()=>{ const items=parseBulk(bulk.value.trim()); if(!items.length) return msg('Paste lines of links, optional name after comma.');
    const ok=await addToSheet(items); msg(ok?'Added to Sheet ✔ Reloading…':'Some adds failed'); if(ok){ bulk.value=''; setTimeout(()=>loadFromSheet(false),800); } };

  function addLocal(items){ let added=0; for(const it of items){ if(!isUrl(it.url)) continue; if(channels.some(c=>c.url===it.url)) continue;
      channels.push({num:channels.length+1,name:it.name||guessName(it.url),url:it.url}); added++; } populate(); return added; }

  async function addToSheet(items){
    const base=webAppEl.value.trim(); if(!isUrl(base)) return false; let ok=0;
    for(const it of items){
      const payload=JSON.stringify({url:it.url,name:it.name||''});
      try{ const res=await fetch(base,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:payload});
           const d=await res.json().catch(()=>({ok:res.ok})); if(!res.ok || d.ok!==true) throw 0; ok++; }
      catch{ try{ await jsonpAdd(base,it.url,it.name||''); ok++; } catch{} }
    }
    return ok===items.length;
  }
  function jsonpAdd(base,url,name){ return new Promise((resolve,reject)=>{
      const cb='bfa_add_'+Math.random().toString(36).slice(2);
      window[cb]=(d)=>{ try{ delete window[cb]; s.remove(); d&&d.ok?resolve():reject(); }catch(e){ reject(e); } };
      const s=document.createElement('script'); s.src=base+(base.includes('?')?'&':'?')+new URLSearchParams({fn:'add',url,name,callback:cb}).toString();
      s.onerror=()=>{ delete window[cb]; s.remove(); reject(); }; document.body.appendChild(s);
  });}
  function parseBulk(text){ if(!text) return []; return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(line=>{
      const parts=line.split(','), url=(parts[0]||'').trim(), name=(parts.slice(1).join(',')||'').trim(); return isUrl(url)?{url,name}:null; }).filter(Boolean); }

  /* Init */
  document.getElementById('sheetId').value = sheetIdEl.value;
  document.getElementById('sheetGid').value = sheetGidEl.value;
  document.getElementById('webAppUrl').value = webAppEl.value;
  loadFromSheet(true);
</script>
</body>
</html>
