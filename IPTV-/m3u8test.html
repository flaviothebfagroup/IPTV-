<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum=1, user-scalable=no" />
  <title>BFA ‚Äî M3U8 Link Tester</title>

  <!-- Video.js -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

  <style>
    :root{
      --brand: #ff6a00; /* BRAND_ORANGE ‚Äî replace if your BFA orange differs */
      --brand-2: #e85f00;
      --bg:#0b0c10; --panel:#14151a; --muted:#9aa1ac; --fg:#e8ecf1; --ring:rgba(255,106,0,.28);
    }
    [data-theme="light"]{
      --bg:#fafafa; --panel:#ffffff; --muted:#6b7280; --fg:#0f172a; --ring:rgba(255,106,0,.22);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px;display:grid;gap:16px;grid-template-columns:1fr;grid-template-areas:"header" "player" "controls" "sidebar"}
    @media (min-width:980px){.wrap{grid-template-columns:2fr 1fr;grid-template-areas:"header header" "player sidebar" "controls sidebar"}}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.18)}
    .header{grid-area:header;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{display:flex;align-items:center;gap:12px}
    .logo{height:28px;width:auto}
    .badge{font-size:12px;color:var(--muted)}
    .player-card{grid-area:player;padding:0;overflow:hidden}
    .player-head{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px}
    .now{font-weight:700}
    .status-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.2)}
    .status-dot.err{background:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.25)}
    .video-shell{position:relative;background:#000}
    .video-shell::before{content:"";display:block;padding-top:56.25%}
    .video-js{position:absolute!important;inset:0;width:100%!important;height:100%!important}
    .errorbar{display:none;padding:10px 14px;background:rgba(239,68,68,.12);color:#fecaca;border-top:1px solid rgba(239,68,68,.3);font-size:14px}
    .errorbar.show{display:block}
    .controls{grid-area:controls;display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:center}
    .controls .card{padding:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button,input,select,textarea{background:#0f1116;color:var(--fg);border:1px solid rgba(255,255,255,.1);padding:10px 12px;border-radius:10px;font-size:14px;outline:none}
    [data-theme="light"] button,[data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] textarea{background:#fff;border-color:#e5e7eb}
    button{cursor:pointer}
    .btn{background:var(--brand);border-color:transparent}
    .btn:hover{background:var(--brand-2)}
    .btn-ghost{background:transparent}
    .btn-outline{background:transparent;border-color:var(--brand);color:var(--brand)}
    .btn-outline:hover{background:var(--brand);color:#fff}
    input[type="range"]{accent-color:var(--brand)}
    .sidebar{grid-area:sidebar;display:grid;gap:12px}
    .search{display:flex;gap:8px}
    .list{max-height:520px;overflow:auto;padding:6px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01))}
    .chan{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-radius:10px;cursor:pointer}
    .chan:hover{background:rgba(255,106,0,.12)}
    .chan .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chan .num{color:var(--muted);min-width:28px;text-align:right;font-variant-numeric:tabular-nums}
    .subtle{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,106,0,.12);color:#ffd7c2;border:1px solid rgba(255,106,0,.25);font-size:12px}
    .spacer{flex:1}
    .kbd{border:1px solid rgba(255,255,255,.2);border-bottom-width:3px;padding:1px 6px;border-radius:6px;font-size:12px;color:var(--muted)}
    .right{margin-left:auto}
    .ring:focus{box-shadow:0 0 0 3px var(--ring);border-color:transparent}
    .drop{border:2px dashed rgba(255,255,255,.18);border-radius:12px;padding:10px 12px;width:100%;text-align:center}
    .drop.drag{border-color:var(--brand);background:rgba(255,106,0,.06)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <img id="bfaLogo" class="logo" alt="BFA" />
        <div>
          <div style="font-weight:800;letter-spacing:.2px">BFA ‚Äî M3U8 Link Tester</div>
          <div class="badge">Clean ‚Ä¢ Orange ‚Ä¢ Cross-browser</div>
        </div>
      </div>
      <div class="row">
        <button id="themeBtn" class="btn-ghost ring" title="Toggle theme">üåì Theme</button>
        <button id="exportBtn" class="btn-outline ring" title="Export channels JSON">Export</button>
        <button id="importBtn" class="btn-outline ring" title="Import channels JSON">Import</button>
        <button id="resetBtn" class="btn-outline ring" title="Reset to defaults">Reset</button>
      </div>
    </div>

    <div class="player-card card">
      <div class="player-head">
        <div id="statusDot" class="status-dot"></div>
        <div class="now" id="nowTitle">No channel playing</div>
        <div class="spacer"></div>
        <div class="subtle" id="metaInfo"></div>
      </div>
      <div class="video-shell">
        <video id="videoPlayer" class="video-js vjs-default-skin" playsinline webkit-playsinline controls preload="auto" data-setup="{}">
          <source src="" type="application/x-mpegURL" />
        </video>
      </div>
      <div id="errorbar" class="errorbar">
        <strong>Playback error.</strong>
        Tip: Some streams block cross-origin playback, are region-locked, or require HTTPS. Try another URL, use HTTPS, or test in Safari (native HLS). If autoplay is blocked, press Play.
      </div>
    </div>

    <div class="controls">
      <div class="card" style="grid-column: span 12;">
        <div class="row">
          <button id="prevBtn" class="btn ring">‚èÆ Prev</button>
          <button id="playPauseBtn" class="btn ring">‚ñ∂Ô∏è Play</button>
          <button id="nextBtn" class="btn ring">Next ‚è≠</button>
          <button id="muteBtn" class="btn-ghost ring">üîá Mute</button>
          <input id="vol" class="ring" type="range" min="0" max="1" step="0.05" value="0.8" style="width:140px" />
          <button id="pipBtn" class="btn-ghost ring">üóî PiP</button>
          <button id="fsBtn" class="btn-ghost ring">‚õ∂ Fullscreen</button>
          <span class="spacer"></span>
          <input id="channelNum" class="ring" type="number" min="1" placeholder="Channel #" style="width:110px" />
          <button id="gotoBtn" class="btn ring">Go</button>
          <span class="pill">Shortcuts: <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span>, <span class="kbd">Space</span>, <span class="kbd">M</span>, <span class="kbd">F</span>, <span class="kbd">P</span></span>
        </div>
      </div>

      <!-- Add URL(s) -->
      <div class="card" style="grid-column: span 12;">
        <div class="row" style="width:100%">
          <input id="customUrl" class="ring grow" placeholder="Paste a .m3u8 URL (or many, separated by new lines)‚Ä¶" />
          <button id="addBtn" class="btn ring">Add & Play</button>
          <button id="copyBtn" class="btn-ghost ring" title="Copy current stream URL">Copy URL</button>
        </div>
        <div id="drop" class="drop hint">Drop a <b>.m3u</b>/<b>.txt</b> file or raw URLs here to add many at once</div>
      </div>

      <!-- Import M3U text -->
      <div class="card" style="grid-column: span 12;">
        <div class="row" style="width:100%">
          <textarea id="m3uText" class="ring" placeholder="#EXTM3U
#EXTINF:-1 tvg-id=&quot;...&quot;,My Channel
https://example.com/live/playlist.m3u8

# or paste multiple lines of pure .m3u8 URLs without #EXTINF
https://a/b/c1.m3u8
https://a/b/c2.m3u8" style="width:100%; height:110px;"></textarea>
        </div>
        <div class="row">
          <button id="parseBtn" class="btn ring">Parse & Add</button>
          <span class="hint">Understands full M3U or plain lines of URLs.</span>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="card">
        <div class="search">
          <input id="search" class="ring grow" placeholder="Search channels‚Ä¶" />
          <select id="sortSel" class="ring">
            <option value="num-asc"># ‚Üë</option>
            <option value="num-desc"># ‚Üì</option>
            <option value="name-asc">Name A‚ÜíZ</option>
            <option value="name-desc">Name Z‚ÜíA</option>
          </select>
        </div>
        <div id="list" class="list" role="listbox" aria-label="Channel list"></div>
        <div class="hint" style="margin-top:8px">Double-click a channel to play. Enter on <b>Channel #</b> jumps.</div>
      </div>

      <!-- Google Sheet / Apps Script loader -->
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Load channels from Google Sheet</div>
        <select id="sheetMode" class="ring" style="width:100%;margin-bottom:8px">
          <option value="csv">CSV (Publish to web)</option>
          <option value="json">Apps Script JSON</option>
        </select>
        <input id="sheetUrl" class="ring" placeholder="Paste CSV or Web App JSON URL‚Ä¶" style="width:100%;margin-bottom:8px" />
        <div class="row">
          <button id="loadSheetBtn" class="btn ring">Load from Sheet</button>
          <label class="hint" style="display:flex;align-items:center;gap:6px">
            <input id="autoRefresh" type="checkbox" /> Auto-refresh (2 min)
          </label>
        </div>
        <div class="hint" style="margin-top:8px">
          CSV headers: <b>num,name,url</b> or <b>name,url</b>.<br/>
          JSON: <code>[{num,name,url},‚Ä¶]</code> or <code>{channels:[‚Ä¶]}</code>.
        </div>
      </div>

      <div class="card">
        <div style="font-weight:600; margin-bottom:6px">Help</div>
        <div class="hint">
          ‚Ä¢ Many public test URLs die over time; add your own.<br/>
          ‚Ä¢ If playback fails, try Safari (native HLS) or another stream.<br/>
          ‚Ä¢ Theme / volume / sheet URL are remembered per browser.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIGURE BRAND + LOGO ======
    const BRAND_ORANGE = '#ff6a00'; // change if you use a different BFA orange
    const BFA_LOGO_SRC = '/IPTV-/icons/icon-192.png'; // set to your BFA logo path
    document.documentElement.style.setProperty('--brand', BRAND_ORANGE);
    document.getElementById('bfaLogo').src = BFA_LOGO_SRC;

    // ====== Theme persistence ======
    const preferred = localStorage.getItem("theme") ||
      (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? "light" : "dark");
    document.documentElement.setAttribute("data-theme", preferred);
    document.getElementById("themeBtn").addEventListener("click", () => {
      const cur = document.documentElement.getAttribute("data-theme");
      const next = cur === "light" ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });

    // ====== Defaults ======
    const defaultChannels = [
      { num: 1, name: '6ter (1080p)', url: 'https://viamotionhsi.netplus.ch/live/eds/6ter/browser-HLS8/6ter.m3u8' },
      { num: 2, name: '20 Minutes TV (1080p)', url: 'https://live-20minutestv.digiteka.com/1961167769/index.m3u8' },
      { num: 3, name: 'A12 TV (720p)', url: 'https://video1.getstreamhosting.com:1936/8420/8420/playlist.m3u8' },
      { num: 4, name: 'ADN TV+', url: 'https://d3b73b34o7cvkq.cloudfront.net/v1/master/3722c60a815c199d9c0ef36c5b73da68a62b09d1/cc-gz2sgqzp076kf/adn.m3u8' },
      { num: 5, name: 'Africa 24 (1080p)', url: 'https://africa24.vedge.infomaniak.com/livecast/ik:africa24/manifest.m3u8' },
      { num: 6, name: 'Africa 24 Sport', url: 'https://africa24.vedge.infomaniak.com/livecast/ik:africa24sport/manifest.m3u8' },
      { num: 7, name: 'Africanews English', url: 'https://d35j504z0x2vu2.cloudfront.net/v1/master/0bc8e8376bd8417a1b6761138aa41c26c7309312/africanews/africanews-en.m3u8' },
      { num: 8, name: 'Africanews French', url: 'https://cdn-euronews.akamaized.net/live/eds/africanews-fr/25050/index.m3u8' },
      { num: 9, name: 'Al Jazeera English', url: 'https://live-hls-web-aje.getaj.net/AJE/01.m3u8' },
      { num: 10, name: 'Al Jazeera Arabic', url: 'https://live-hls-web-ajm.getaj.net/AJM/01.m3u8' },
      { num: 11, name: 'ARTE (FR/DE)', url: 'https://artestrasp.akamaized.net/hls/arteplus7/de/stream.m3u8' },
      { num: 12, name: 'BBC News', url: 'https://bbcmedia.ic.llnwd.net/stream/bbcmedia_news_mf_p' },
      { num: 13, name: 'Bloomberg TV', url: 'https://live-ws-tx.smartstream.tv/bloombergtv/bloombergtv_720p/playlist.m3u8' },
      { num: 14, name: 'CGTN English', url: 'https://video.cgtn.com/lives/live.m3u8' },
      { num: 15, name: 'CNN International', url: 'https://cnn-cdn-live.cnn.com/cnn/live/2022/08/16/cnnus.stream.m3u8' },
      { num: 16, name: 'Euronews English', url: 'https://cdn-euronews.akamaized.net/live/eds/euronews-en/25050/index.m3u8' },
      { num: 17, name: 'France 24 English', url: 'https://static.france24.com/live/F24_EN_LO_HLS/live_web.m3u8' },
      { num: 18, name: 'France 24 French', url: 'https://static.france24.com/live/F24_FR_LO_HLS/live_web.m3u8' },
      { num: 19, name: 'NHK World-Japan', url: 'https://nhkworld-jp-live.akamaized.net/hls/live/2020/nhkworld/index.m3u8' },
      { num: 20, name: 'Sky News UK', url: 'https://skynewsau-lh.akamaihd.net/i/skynews_1@119320/master.m3u8' },
      { num: 21, name: 'TLC HD', url: 'https://tlc-lh.akamaihd.net/i/tlc_1@119320/master.m3u8' },
      { num: 22, name: 'TV5MONDE', url: 'https://tv5monde-lh.akamaihd.net/i/tv5monde_1@119320/master.m3u8' },
      { num: 23, name: 'Weather Channel', url: 'https://weatherchannel.akamaized.net/streams/weatherchannel/playlist.m3u8' },
    ];

    // ====== State & helpers ======
    let channels = JSON.parse(localStorage.getItem("channels") || "null") || defaultChannels.slice();
    let currentIdx = -1;
    const $ = s => document.querySelector(s);
    const listEl = $("#list"), nowTitle = $("#nowTitle"), metaInfo = $("#metaInfo"), statusDot = $("#statusDot"), errorbar = $("#errorbar");

    function persist(){ localStorage.setItem("channels", JSON.stringify(channels)); }
    function setStatus(ok){ statusDot.classList.toggle("err", !ok); }
    function showError(msg){ errorbar.innerHTML = "<strong>Playback error.</strong> " + (msg || ""); errorbar.classList.add("show"); setStatus(false); }
    function clearError(){ errorbar.classList.remove("show"); }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }
    function renderList(){
      const q = $("#search").value.toLowerCase();
      const sort = $("#sortSel").value;
      let view = channels.slice();
      if (q) view = view.filter(c => (c.name + " " + c.num + " " + c.url).toLowerCase().includes(q));
      if (sort === "num-asc") view.sort((a,b)=>a.num-b.num);
      if (sort === "num-desc") view.sort((a,b)=>b.num-a.num);
      if (sort === "name-asc") view.sort((a,b)=>a.name.localeCompare(b.name));
      if (sort === "name-desc") view.sort((a,b)=>b.name.localeCompare(a.name));
      listEl.innerHTML = "";
      for (const c of view){
        const row = document.createElement("div");
        row.className = "chan"; row.tabIndex = 0; row.setAttribute("role","option");
        row.innerHTML = `<div class="name">${c.num}. ${escapeHtml(c.name)}</div><div class="num">#${c.num}</div>`;
        row.addEventListener("click", () => playByNum(c.num));
        row.addEventListener("dblclick", () => playByNum(c.num));
        row.addEventListener("keydown", e => { if (e.key === "Enter") playByNum(c.num); });
        listEl.appendChild(row);
      }
    }

    // ====== Player ======
    const player = videojs("videoPlayer", {
      html5: { vhs: { overrideNative: true } },
      controlBar: { volumePanel: { inline: false } },
      fluid: false, inactivityTimeout: 2000
    });
    try { player.tech_.el_.crossOrigin = "anonymous"; } catch {}
    const savedVol = parseFloat(localStorage.getItem("volume") || "0.8");
    player.volume(isFinite(savedVol) ? savedVol : 0.8);
    $("#vol").value = player.volume();
    player.on("error", () => { const err = player.error(); showError(err && err.message ? err.message : "Unknown error."); });
    player.on("playing", () => { clearError(); setStatus(true); updateMeta(); });
    player.on("loadedmetadata", updateMeta);
    function updateMeta(){ const tech = player.tech(true); const dur = player.duration(); metaInfo.textContent = (tech ? tech.name_ : "html5") + (isFinite(dur)&&dur>0 ? ` ‚Ä¢ ${fmtTime(dur)}` : ""); }
    function fmtTime(s){ const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=Math.floor(s%60); return (h?h+":":"") + String(m).padStart(2,"0") + ":" + String(ss).padStart(2,"0"); }

    function playIndex(idx){
      if (idx<0 || idx>=channels.length) return;
      currentIdx = idx;
      const ch = channels[idx];
      nowTitle.textContent = `Now Playing: ${ch.num}. ${ch.name}`;
      clearError(); setStatus(true);
      try {
        player.src({ type:"application/x-mpegURL", src: ch.url });
        player.play().catch(()=> showError("Autoplay is blocked. Press Play ‚ñ∂Ô∏è."));
      } catch (e) { showError(String(e)); }
    }
    function playByNum(num){ const idx = channels.findIndex(c => c.num === Number(num)); if (idx !== -1) playIndex(idx); }
    function prev(){ if (!channels.length) return; playIndex((currentIdx - 1 + channels.length) % channels.length); }
    function next(){ if (!channels.length) return; playIndex((currentIdx + 1) % channels.length); }

    // ====== Controls ======
    $("#prevBtn").addEventListener("click", prev);
    $("#nextBtn").addEventListener("click", next);
    $("#gotoBtn").addEventListener("click", () => { const v = Number($("#channelNum").value); if (v) playByNum(v); });
    const playPauseBtn = $("#playPauseBtn");
    function syncPlayBtn(){ playPauseBtn.textContent = player.paused() ? "‚ñ∂Ô∏è Play" : "‚è∏ Pause"; }
    playPauseBtn.addEventListener("click", () => { player.paused() ? player.play() : player.pause(); syncPlayBtn(); });
    player.on("pause", syncPlayBtn); player.on("play", syncPlayBtn);
    $("#vol").addEventListener("input", e => { player.volume(parseFloat(e.target.value)); localStorage.setItem("volume", String(player.volume())); });
    $("#muteBtn").addEventListener("click", () => { player.muted(!player.muted()); $("#muteBtn").textContent = player.muted() ? "üîä Unmute" : "üîá Mute"; });
    $("#pipBtn").addEventListener("click", async () => {
      const el = player.el().querySelector("video"); if (!document.pictureInPictureEnabled || !el) return;
      try { if (document.pictureInPictureElement) await document.exitPictureInPicture(); else await el.requestPictureInPicture(); } catch {}
    });
    $("#fsBtn").addEventListener("click", () => player.isFullscreen() ? player.exitFullscreen() : player.requestFullscreen());
    document.addEventListener("keydown", (e) => {
      if (e.repeat) return;
      switch (e.code){
        case "ArrowLeft": return prev();
        case "ArrowRight": return next();
        case "Space": e.preventDefault(); return player.paused()?player.play():player.pause();
        case "KeyM": player.muted(!player.muted()); $("#muteBtn").textContent = player.muted() ? "üîä Unmute" : "üîá Mute"; break;
        case "KeyF": player.isFullscreen() ? player.exitFullscreen() : player.requestFullscreen(); break;
        case "KeyP": $("#pipBtn").click(); break;
        case "Enter": const n = Number($("#channelNum").value); if (n) playByNum(n);
      }
    });

    // ====== Add single or many URLs ======
    $("#addBtn").addEventListener("click", () => {
      const raw = $("#customUrl").value.trim();
      if (!raw) return alert("Paste one or more .m3u8 URLs (each on a new line).");
      const urls = extractUrls(raw);
      if (!urls.length) return alert("No .m3u8 URLs found.");
      let added = 0;
      for (const u of urls){
        if (channels.some(c => c.url === u)) continue;
        channels.push({ num: channels.length + 1, name: guessNameFromUrl(u), url: u }); added++;
      }
      persist(); renderList();
      if (added) playIndex(channels.length - 1);
      $("#customUrl").value = "";
      alert(`Added ${added} URL(s).`);
    });

    $("#copyBtn").addEventListener("click", async () => {
      const cur = channels[currentIdx]; if (!cur) return;
      try { await navigator.clipboard.writeText(cur.url); alert("Copied stream URL."); } catch { alert(cur.url); }
    });

    // Drag & drop (.m3u / .txt or raw text)
    const drop = $("#drop");
    drop.addEventListener("dragover", e => { e.preventDefault(); drop.classList.add("drag"); });
    drop.addEventListener("dragleave", () => drop.classList.remove("drag"));
    drop.addEventListener("drop", async (e) => {
      e.preventDefault(); drop.classList.remove("drag");
      if (e.dataTransfer.files && e.dataTransfer.files.length){
        const file = e.dataTransfer.files[0]; const txt = await file.text(); addFromAny(txt);
      } else {
        const txt = e.dataTransfer.getData("text/plain"); addFromAny(txt);
      }
    });

    // Paste M3U text
    $("#parseBtn").addEventListener("click", () => {
      const txt = $("#m3uText").value;
      if (!txt.trim()) return alert("Paste M3U text or URLs first.");
      addFromAny(txt);
      $("#m3uText").value = "";
    });

    function addFromAny(text){
      const entries = parseM3U(text);
      let added = 0;
      if (entries.length){
        for (const p of entries){
          if (!p.url) continue;
          if (channels.some(c => c.url === p.url)) continue;
          channels.push({ num: channels.length + 1, name: p.name || guessNameFromUrl(p.url), url: p.url }); added++;
        }
      } else {
        const urls = extractUrls(text);
        for (const u of urls){
          if (channels.some(c => c.url === u)) continue;
          channels.push({ num: channels.length + 1, name: guessNameFromUrl(u), url: u }); added++;
        }
      }
      persist(); renderList();
      if (added) playIndex(channels.length - 1);
      alert(`Added ${added} channel(s).`);
    }

    function parseM3U(text){
      const lines = text.split(/\r?\n/);
      const out = []; let curName = null;
      for (const raw of lines){
        const line = raw.trim();
        if (!line || line.startsWith("#EXTM3U")) continue;
        if (line.startsWith("#EXTINF")){
          const m = line.match(/#EXTINF:[^,]*,(.*)$/); curName = m ? m[1].trim() : null;
        } else if (/^https?:\/\/.+/i.test(line) && line.toLowerCase().includes(".m3u8")){
          out.push({ name: curName, url: line }); curName = null;
        }
      }
      return out;
    }
    function extractUrls(text){
      const urls = [];
      for (const m of text.matchAll(/https?:\/\/[^\s"'<>]+\.m3u8[^\s"'<>]*/gi)){ urls.push(m[0]); }
      return Array.from(new Set(urls));
    }
    function guessNameFromUrl(u){
      try{ const p = new URL(u).pathname.split("/").filter(Boolean); return decodeURIComponent(p[p.length-1]).replace(/\.(m3u8|playlist)$/i,""); }catch{return "Custom Channel";}
    }

    // ====== Export / Import / Reset ======
    $("#exportBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(channels, null, 2)], {type:"application/json"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "channels.json"; a.click(); URL.revokeObjectURL(a.href);
    });
    $("#importBtn").addEventListener("click", async () => {
      const input = document.createElement("input"); input.type = "file"; input.accept = "application/json";
      input.onchange = async () => {
        const file = input.files[0]; if (!file) return;
        try {
          const txt = await file.text();
          const arr = JSON.parse(txt);
          const list = Array.isArray(arr) ? arr : (Array.isArray(arr.channels)?arr.channels:[]);
          if (!list.length) throw new Error("Invalid JSON.");
          channels = list.map((c,i)=>({ num:i+1, name:String(c.name||`Imported #${i+1}`), url:String(c.url||"") })).filter(c=>c.url);
          persist(); renderList(); alert(`Imported ${channels.length} channel(s).`);
        } catch (e) { alert("Import failed: "+e.message); }
      };
      input.click();
    });
    $("#resetBtn").addEventListener("click", () => {
      if (!confirm("Reset channel list to defaults?")) return;
      channels = defaultChannels.slice();
      persist(); renderList();
    });

    // ====== Google Sheet loader ======
    const sheetMode = $("#sheetMode"), sheetUrl = $("#sheetUrl"), loadBtn = $("#loadSheetBtn"), autoRefresh = $("#autoRefresh");
    // restore saved source
    sheetMode.value = localStorage.getItem("sheetMode") || "csv";
    sheetUrl.value = localStorage.getItem("sheetUrl") || "";
    autoRefresh.checked = localStorage.getItem("sheetAuto") === "1";
    let refreshTimer = null;

    loadBtn.addEventListener("click", async () => {
      const mode = sheetMode.value, url = sheetUrl.value.trim();
      if (!url) return alert("Paste the CSV or JSON Web App URL.");
      try{
        if (mode === "csv"){
          channels = await loadFromGoogleCSV(url);
        } else {
          channels = await loadFromAppsScript(url);
        }
        reindex(channels); persist(); renderList();
        alert(`Loaded ${channels.length} channel(s) from sheet.`);
        localStorage.setItem("sheetMode", mode);
        localStorage.setItem("sheetUrl", url);
        handleAutoRefresh();
      } catch (e){
        alert("Load failed: "+e.message);
      }
    });
    autoRefresh.addEventListener("change", handleAutoRefresh);
    function handleAutoRefresh(){
      localStorage.setItem("sheetAuto", autoRefresh.checked ? "1":"0");
      if (refreshTimer){ clearInterval(refreshTimer); refreshTimer = null; }
      if (autoRefresh.checked && sheetUrl.value.trim()){
        refreshTimer = setInterval(()=> loadBtn.click(), 120000); // 2 min
      }
    }
    async function loadFromGoogleCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const csv = await res.text();
      const rows = parseCSV(csv); // array of arrays
      if (!rows.length) return [];
      const headers = rows[0].map(h => String(h||"").toLowerCase().trim());
      const dataRows = rows.slice(1).filter(r => r.some(x => String(x||"").trim().length));
      const idxNum = headers.indexOf("num");
      const idxName = headers.indexOf("name");
      const idxUrl = headers.indexOf("url");
      if (idxUrl === -1) throw new Error("CSV must include a 'url' column");
      const list = dataRows.map((r,i)=>({
        num: idxNum>-1 ? Number(r[idxNum]||i+1) : i+1,
        name: idxName>-1 ? String(r[idxName]||`Channel #${i+1}`) : `Channel #${i+1}`,
        url: String(r[idxUrl]||"").trim()
      })).filter(x => x.url);
      return list;
    }
    async function loadFromAppsScript(url){
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const list = Array.isArray(json) ? json : (Array.isArray(json.channels) ? json.channels : null);
      if (!list) throw new Error("JSON must be an array or {channels:[‚Ä¶]}");
      return list.map((c,i)=>({ num:Number(c.num||i+1), name:String(c.name||`Channel #${i+1}`), url:String(c.url||"") })).filter(x=>x.url);
    }
    function parseCSV(text){
      const out = []; let row = [], cur = "", inQ = false;
      for (let i=0;i<text.length;i++){
        const ch = text[i], nxt = text[i+1];
        if (inQ){
          if (ch === '"' && nxt === '"'){ cur += '"'; i++; }
          else if (ch === '"'){ inQ = false; }
          else cur += ch;
        } else {
          if (ch === '"'){ inQ = true; }
          else if (ch === ','){ row.push(cur); cur=""; }
          else if (ch === '\n'){ row.push(cur); out.push(row); row=[]; cur=""; }
          else if (ch === '\r'){ /* skip */ }
          else cur += ch;
        }
      }
      row.push(cur); out.push(row);
      return out.filter(r => r.length>1 || (r.length===1 && r[0].trim().length));
    }
    function reindex(list){ list.forEach((c,i)=> c.num = i+1); }

    // ====== Search & init ======
    $("#search").addEventListener("input", renderList);
    $("#sortSel").addEventListener("change", renderList);
    renderList();
    // Auto-load from URL ?sheet=<csv-or-json>
    const qp = new URLSearchParams(location.search);
    const sheetQ = qp.get("sheet");
    if (sheetQ){ sheetUrl.value = sheetQ; loadBtn.click(); }
  </script>
</body>
</html>
