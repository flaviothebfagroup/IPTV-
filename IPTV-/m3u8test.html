<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BFA — IPTV Channel Tester</title>

<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

<style>
  :root{
    --brand:#ff6a00; --brand-2:#e85f00;
    --bg:#fafafa; --fg:#1f2937;
    --panel:#ffffff; --line:#e5e7eb; --muted:#6b7280;
    --radius:14px; --btn-h:46px; --ring:rgba(255,106,0,.45);
    --gap:14px;
  }
  [data-theme="dark"]{
    --bg:#0b0c10; --fg:#e8ecf1; --panel:#14151a; --line:rgba(255,255,255,.10); --muted:#9aa1ac;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;}
  .page{max-width:860px;margin:16px auto;padding:16px}

  .head{display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap;margin-bottom:var(--gap)}
  .brand{display:flex;align-items:center;gap:10px;min-width:0}
  .logo{height:28px;width:auto}
  h1{font-size:clamp(18px,4.6vw,22px);margin:0;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:12px}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  button,input,select,textarea{
    font-size:14px;height:var(--btn-h);padding:0 12px;border-radius:10px;border:1px solid var(--line);
    background:var(--panel);color:var(--fg);outline:none;
  }
  .btn{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;border:0;box-shadow:0 6px 16px rgba(255,106,0,.28);transition:transform .06s ease, filter .15s ease, box-shadow .2s ease;}
  .btn:hover{filter:brightness(1.03)}
  .btn:active{transform:translateY(1px); box-shadow:0 4px 10px rgba(255,106,0,.22)}
  .btn-outline{background:transparent;border-color:var(--brand);color:var(--brand)}
  .btn-outline:hover{background:var(--brand);color:#fff}
  .tag{font-size:12px;color:var(--muted)}
  textarea{height:auto;min-height:110px;padding:10px 12px;line-height:1.45}

  .btn-remote{position:relative;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:0 14px}
  .ico{display:inline-block;width:20px;height:20px;line-height:0;flex:0 0 20px}
  .lbl{line-height:1}
  .btn-remote:focus{outline:none}
  .kb .btn-remote:focus::after,.kb .remote-focus:focus::after{
    content:"";position:absolute;inset:-6px;border-radius:14px;border:2px solid var(--brand);
    animation:bfaBlink 1.1s ease-in-out infinite;pointer-events:none;filter:drop-shadow(0 0 6px var(--ring));
  }
  .btn-remote.blink::after{content:"";position:absolute;inset:-8px;border-radius:16px;border:2px solid var(--brand);animation:bfaPulse 0.45s ease-out 1;pointer-events:none;}
  .btn-remote[aria-pressed="true"]{background:linear-gradient(180deg,#ff7f22,#ff6a00); color:#fff;}
  @keyframes bfaBlink{0%,100%{opacity:.95}50%{opacity:.4}}
  @keyframes bfaPulse{0%{box-shadow:0 0 0 0 var(--ring);opacity:1}70%{box-shadow:0 0 0 10px rgba(255,106,0,0);opacity:.75}100%{box-shadow:0 0 0 0 rgba(255,106,0,0);opacity:1}}

  .stack > * + *{ margin-top: var(--gap); }   /* bento spacing */

  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:12px;overflow:hidden}

  .player{padding:0}
  .ph{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;min-height:42px}
  .status{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.18)}
  .status.err{background:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.22)}
  .now{font-weight:700}
  .meta{margin-left:auto;color:var(--muted);font-size:12px}
  .video-shell{position:relative;aspect-ratio:16/9;background:#000}
  .video-js{position:absolute!important;inset:0;width:100%!important;height:100%!important}
  .video-js .vjs-control-bar{background:rgba(0,0,0,.35)}
  .video-js .vjs-big-play-button{background:var(--brand);border:none;border-radius:10px}
  .errbar{display:none;padding:10px 12px;background:rgba(239,68,68,.10);border-top:1px solid rgba(239,68,68,.25);color:#b91c1c}
  [data-theme="dark"] .errbar{color:#fecaca}
  .errbar.show{display:block}

  .controls{display:grid;gap:10px;align-items:center;margin-top:12px;grid-template-columns:repeat(3,1fr) auto 1fr auto auto}
  .controls .btn,.controls button{min-width:0;justify-self:stretch}
  .vol{height:var(--btn-h); width:100%}

  .igroup{display:grid;gap:0;margin-top:10px;grid-template-columns:160px 110px 1fr;border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--panel)}
  .igroup > *{ border:0; border-radius:0; height:var(--btn-h) }
  .igroup > * + *{ border-left:1px solid var(--line) }
  #chanSelect{ width:100% }

  .textwrap{border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--panel); margin-top:6px}
  .textwrap textarea{ border:0; border-radius:0; width:100%; min-height:120px }

  .dgroup{display:grid;gap:0;margin-top:10px;grid-template-columns:2fr 1fr 160px 160px;border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--panel)}
  .dgroup > *{ border:0; border-radius:0; height:var(--btn-h) }
  .dgroup > * + *{ border-left:1px solid var(--line) }
  .dgroup .btn,.dgroup .btn-outline{border-radius:0}

  .row{display:grid;gap:8px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:220px 1fr 1fr}

  @media (max-width:560px){
    .controls{grid-template-columns:repeat(3,1fr);grid-auto-rows:var(--btn-h)}
    .controls > *:nth-child(n+4){grid-column:span 1}
    .igroup{grid-template-columns:1fr}
    .igroup > * + *{ border-left:0; border-top:1px solid var(--line) }
    .dgroup{grid-template-columns:1fr}
    .dgroup > * + *{ border-left:0; border-top:1px solid var(--line) }
    .row.cols-3{grid-template-columns:1fr}
  }
  .theme-sel{width:110px}
</style>
</head>
<body>
  <div class="page stack">
    <!-- Header -->
    <div class="head">
      <div class="brand">
        <img id="bfaLogo" class="logo" alt="BFA logo" />
        <div>
          <h1>BFA — IPTV Channel Tester</h1>
          <div class="sub">BFA orange • Video.js • Sheet B2 (URL), C2 (Name)</div>
        </div>
      </div>
      <div class="actions">
        <select id="themeSel" class="theme-sel remote-focus" title="Theme">
          <option value="light" selected>Light</option>
          <option value="dark">Dark</option>
        </select>
        <button id="reloadBtn" class="btn-outline btn-remote">
          <span class="ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path><path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"></path></svg>
          </span>
          <span class="lbl">Reload</span>
        </button>
      </div>
    </div>

    <!-- Player -->
    <div class="card player">
      <div class="ph">
        <div id="dot" class="status"></div>
        <div id="now" class="now">Select a channel</div>
        <div id="meta" class="meta"></div>
      </div>
      <div class="video-shell">
        <video id="videoPlayer" class="video-js vjs-default-skin" playsinline webkit-playsinline controls preload="auto" muted data-setup="{}">
          <source src="" type="application/x-mpegURL" />
        </video>
      </div>
      <div id="errbar" class="errbar">Playback error. Some streams block cross-origin playback or autoplay. Press ▶️ if needed.</div>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="controls">
        <button id="prevBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="4" y="5" width="2" height="14" rx="1"></rect><path d="M19 6L9 12l10 6V6z"></path></svg></span><span class="lbl">Prev</span></button>
        <button id="playBtn" class="btn btn-remote" aria-pressed="false"><span class="ico" id="playIcon"></span><span class="lbl" id="playLbl">Play</span></button>
        <button id="nextBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="18" y="5" width="2" height="14" rx="1"></rect><path d="M5 6l10 6L5 18V6z"></path></svg></span><span class="lbl">Next</span></button>
        <button id="muteBtn" class="btn-remote"><span class="ico" id="muteIcon"></span><span class="lbl" id="muteLbl">Mute</span></button>
        <input id="vol" class="vol remote-focus" type="range" min="0" max="1" step="0.05" value="0.8" />
        <button id="pipBtn" class="btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"></rect><rect x="12.5" y="10" width="6.5" height="4.5" rx="1.2" fill="currentColor" stroke="none"></rect></svg></span><span class="lbl">PiP</span></button>
        <button id="fsBtn" class="btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9V5h4"></path><path d="M21 9V5h-4"></path><path d="M3 15v4h4"></path><path d="M21 15v4h-4"></path></svg></span><span class="lbl">Full</span></button>
      </div>

      <div class="igroup" role="group" aria-label="Channel jump">
        <input id="chanInput" class="remote-focus" type="number" min="1" placeholder="Channel #" autocomplete="off" />
        <button id="goBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M12 2v3M12 19v3M2 12h3M19 12h3"></path></svg></span><span class="lbl">Go</span></button>
        <select id="chanSelect" class="remote-focus"><option value="">Choose Channel</option></select>
      </div>

      <div id="loadStatus" class="tag" style="margin-top:8px"></div>
    </div>

    <!-- Custom -->
    <div class="card">
      <label style="font-weight:700;display:block;margin-bottom:6px">Add a direct link</label>
      <div class="dgroup">
        <input id="singleUrl" placeholder="https://… (HLS link; .m3u8 optional)" autocomplete="off" />
        <input id="singleName" placeholder="Optional name" autocomplete="off" />
        <button id="singleAddLocal" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg></span><span class="lbl">Add locally</span></button>
        <button id="singleAddSheet" class="btn-outline btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="18" rx="2"></rect><path d="M8 7h8M8 11h8M8 15h5"></path></svg></span><span class="lbl">Add to Sheet</span></button>
      </div>

      <label for="bulkTextarea" style="font-weight:700;display:block;margin-top:12px;margin-bottom:6px">Or paste many links (one per line). Optional name after a comma.</label>
      <div class="textwrap">
        <textarea id="bulkTextarea" placeholder="https://example.com/stream1.m3u8, My Channel
https://example.com/stream2"></textarea>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <input id="sheetId"  placeholder="Spreadsheet ID" />
        <input id="sheetGid" placeholder="Worksheet gid" />
        <input id="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec" />
      </div>
      <div class="row cols-2" style="margin-top:8px">
        <button id="addLocalBtn" class="btn btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg></span><span class="lbl">Add locally & play last</span></button>
        <button id="addSheetBtn" class="btn-outline btn-remote"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="18" rx="2"></rect><path d="M8 7h8M8 11h8M8 15h5"></path></svg></span><span class="lbl">Add to Sheet</span></button>
      </div>
      <div id="addMsg" class="tag" style="margin-top:8px"></div>
    </div>

    <div class="tag">Shortcuts: ←/→ (prev/next), Space (play/pause), M (mute), F (fullscreen), P (PiP)</div>
  </div>

<script>
  // keyboard-only focus ring + blur after click
  (function(){
    const setKb = (on)=>document.body.classList.toggle('kb', !!on);
    addEventListener('keydown', (e)=>{ if(['Tab','ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) setKb(true); }, {passive:true});
    addEventListener('mousedown', ()=> setKb(false), {passive:true});
    addEventListener('touchstart', ()=> setKb(false), {passive:true});
    document.addEventListener('click', (e)=>{ const b=e.target.closest('.btn-remote'); if(b) b.blur(); }, {passive:true});
  })();

  // logo (fallback)
  const LOGO_PRIMARY = '/IPTV-/icons/icon-192.png';
  const FALLBACK = 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="28" viewBox="0 0 120 28"><rect rx="6" width="120" height="28" fill="#ff6a00"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-weight="800" font-size="14" fill="#fff">BFA</text></svg>');
  const logoImg = document.getElementById('bfaLogo'); logoImg.src = LOGO_PRIMARY; logoImg.onerror = ()=>{ logoImg.onerror=null; logoImg.src=FALLBACK; };

  // defaults
  const DEFAULT_SHEET_ID = '1Oh69mDuOCuy27YDYpInoVfcw3o4TlFutQEGYamBXSHE';
  const DEFAULT_SHEET_GID = '824459168';
  const DEFAULT_WEBAPP   = 'https://script.google.com/macros/s/AKfycbzHIqQFXOFz75yFiYDF3iKblaO37pph_o3uvzbbz4g8DWOEKFXqBsIqhnM_O33Z5RAKJw/exec';

  // theme
  const themeSel = document.getElementById('themeSel');
  function applyTheme(m){ document.documentElement.setAttribute('data-theme', m==='dark'?'dark':'light'); localStorage.setItem('bfa_theme', m); themeSel.value=m; }
  applyTheme(localStorage.getItem('bfa_theme')||'light'); themeSel.onchange = e => applyTheme(e.target.value);

  // player
  const player = videojs("videoPlayer",{ html5:{vhs:{overrideNative:true}}, controlBar:{volumePanel:{inline:false}}});
  const volEl = document.getElementById('vol'); player.volume(parseFloat(localStorage.getItem('bfa_vol')||'0.8')); volEl.value=player.volume();
  volEl.oninput = e => { player.volume(parseFloat(e.target.value)); localStorage.setItem('bfa_vol', String(player.volume())); };
  const errbar=document.getElementById('errbar'), dot=document.getElementById('dot');
  function setError(m){ errbar.textContent='Playback error. '+(m||''); errbar.classList.add('show'); dot.classList.add('err'); }
  function clearError(){ errbar.classList.remove('show'); dot.classList.remove('err'); }
  player.on('error',()=>setError(player.error()?.message)); player.on('playing',()=>{clearError();updateMeta();}); player.on('loadedmetadata',updateMeta);
  function updateMeta(){ const tech=player.tech(true); const d=player.duration(); document.getElementById('meta').textContent=(tech?tech.name_:'html5')+(isFinite(d)&&d>0?(' • '+fmt(d)):''); }
  function fmt(s){ const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=Math.floor(s%60); return (h?h+':':'')+String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0'); }

  // channels
  const nowEl=document.getElementById('now'), selectEl=document.getElementById('chanSelect'), chanInputEl=document.getElementById('chanInput'), loadStatus=document.getElementById('loadStatus');
  let channels=[]; let current=-1;
  function populate(){ selectEl.innerHTML='<option value="">Choose Channel</option>'; channels.forEach(c=>{ const o=document.createElement('option'); o.value=c.num; o.text=`${c.num}. ${c.name}`; selectEl.appendChild(o); }); }
  function playIndex(i){ if(i<0||i>=channels.length) return; current=i; const ch=channels[i]; nowEl.textContent=`Now Playing: ${ch.num}. ${ch.name}`; clearError(); try{ player.src({type:'application/x-mpegURL', src:ch.url}); player.play().catch(()=>setError('Autoplay blocked. Tap ▶️')); selectEl.value=ch.num; chanInputEl.value=''; }catch(e){ setError(String(e)); } }
  function playByNum(n){ const i=channels.findIndex(c=>c.num===Number(n)); if(i!==-1) playIndex(i); }

  const icons={ play:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M8 5v14l11-7-11-7z"/></svg>', pause:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M7 5h4v14H7zM13 5h4v14h-4z"/></svg>', vol:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M4 10v4h4l5 4V6l-5 4H4z"/><path d="M16 8c1.5 1.2 2.4 2.9 2.4 4.9S17.5 16.6 16 17.8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>', mute:'<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M4 10v4h4l5 4V6l-5 4H4z"/><path d="M19 9l-6 6M13 9l6 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>' };
  const playIcon=document.getElementById('playIcon'), playLbl=document.getElementById('playLbl'), muteIcon=document.getElementById('muteIcon'), muteLbl=document.getElementById('muteLbl');
  function setPlayState(paused){ playIcon.innerHTML=paused?icons.play:icons.pause; playLbl.textContent=paused?'Play':'Pause'; }
  function setMuteState(muted){ muteIcon.innerHTML=muted?icons.mute:icons.vol; muteLbl.textContent=muted?'Unmute':'Mute'; }
  setPlayState(true); setMuteState(false);

  function blink(el){ el.classList.remove('blink'); void el.offsetWidth; el.classList.add('blink'); }
  const prevBtn=document.getElementById('prevBtn'), playBtn=document.getElementById('playBtn'), nextBtn=document.getElementById('nextBtn'), muteBtn=document.getElementById('muteBtn'), pipBtn=document.getElementById('pipBtn'), fsBtn=document.getElementById('fsBtn'), goBtn=document.getElementById('goBtn');

  prevBtn.onclick=()=>{ blink(prevBtn); prevBtn.blur(); if(channels.length) playIndex((current-1+channels.length)%channels.length); };
  nextBtn.onclick=()=>{ blink(nextBtn); nextBtn.blur(); if(channels.length) playIndex((current+1)%channels.length); };
  playBtn.onclick=()=>{ blink(playBtn); playBtn.blur(); const p=player.paused(); p?player.play():player.pause(); playBtn.setAttribute('aria-pressed', String(p)); setPlayState(p); };
  player.on('play', ()=>{ playBtn.setAttribute('aria-pressed','true'); setPlayState(false); });
  player.on('pause',()=>{ playBtn.setAttribute('aria-pressed','false'); setPlayState(true); });
  muteBtn.onclick=()=>{ blink(muteBtn); muteBtn.blur(); player.muted(!player.muted()); setMuteState(player.muted()); };
  player.on('volumechange', ()=> setMuteState(player.muted()));
  pipBtn.onclick=async ()=>{ blink(pipBtn); pipBtn.blur(); const el=player.el().querySelector('video'); if(!document.pictureInPictureEnabled||!el) return; try{ if(document.pictureInPictureElement) await document.exitPictureInPicture(); else await el.requestPictureInPicture(); }catch{} };
  fsBtn.onclick=()=>{ blink(fsBtn); fsBtn.blur(); player.isFullscreen()?player.exitFullscreen():player.requestFullscreen(); };
  goBtn.onclick=()=>{ blink(goBtn); goBtn.blur(); const n=parseInt(chanInputEl.value,10); if(n) playByNum(n); };
  document.getElementById('reloadBtn').onclick=()=> loadFromSheet(true);
  selectEl.onchange=()=>{ const n=parseInt(selectEl.value,10); if(n) playByNum(n); };
  document.addEventListener('keydown', (e)=>{ if(e.repeat) return; switch(e.code){ case 'ArrowLeft': if(channels.length){ blink(prevBtn); playIndex((current-1+channels.length)%channels.length);} return; case 'ArrowRight': if(channels.length){ blink(nextBtn); playIndex((current+1)%channels.length);} return; case 'Space': e.preventDefault(); playBtn.click(); return; case 'KeyM': muteBtn.click(); return; case 'KeyF': fsBtn.click(); return; case 'KeyP': pipBtn.click(); return; case 'Enter': const n=parseInt(chanInputEl.value,10); if(n){ blink(goBtn); playByNum(n);} return; } });

  // inputs
  const sheetIdEl=document.getElementById('sheetId'), sheetGidEl=document.getElementById('sheetGid'), webAppEl=document.getElementById('webAppUrl');
  sheetIdEl.value=localStorage.getItem('sheet_id')||DEFAULT_SHEET_ID;
  sheetGidEl.value=localStorage.getItem('sheet_gid')||DEFAULT_SHEET_GID;
  webAppEl.value =localStorage.getItem('webapp_url')||DEFAULT_WEBAPP;
  [sheetIdEl,sheetGidEl,webAppEl].forEach(el=>el.addEventListener('change', ()=>{ localStorage.setItem('sheet_id',sheetIdEl.value.trim()); localStorage.setItem('sheet_gid',sheetGidEl.value.trim()); localStorage.setItem('webapp_url',webAppEl.value.trim()); }));

  // load list: Apps Script (JSON -> JSONP) -> CSV range -> CSV full
  const isUrl = u => /^https?:\/\/\S+$/i.test(u||'');
  async function loadFromSheet(autoPlayFirst=false){
    loadStatus.textContent='Loading list…';
    const sheetId = sheetIdEl.value.trim(), gid = sheetGidEl.value.trim(), webapp = webAppEl.value.trim();

    // A) Apps Script JSON
    if (isUrl(webapp)){
      try{
        const list = await fetchListJson(webapp);
        if (list.length){ setList(list, 'Web App JSON'); if(autoPlayFirst) playIndex(0); return; }
      }catch(e){
        // B) JSONP (no CORS)
        try{
          const list = await fetchListJsonp(webapp);
          if (list.length){ setList(list, 'Web App JSONP'); if(autoPlayFirst) playIndex(0); return; }
        }catch(_){}
      }
    }

    // C) CSV B2:C
    try{
      const rangeCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${encodeURIComponent(gid)}&range=${encodeURIComponent('B2:C')}`;
      const txt = await fetchCsv(rangeCsv); const rows=parseCSV(txt);
      const list = rows.map(r=>({url:(r[0]||'').trim(), name:(r[1]||'').trim()})).filter(x=>isUrl(x.url));
      if (list.length){ setList(list, 'CSV B2:C'); if(autoPlayFirst) playIndex(0); return; }
    }catch(_){}

    // D) CSV full (B/C)
    try{
      const fullCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${encodeURIComponent(gid)}`;
      const txt = await fetchCsv(fullCsv); const rows=parseCSV(txt);
      const list = rows.slice(1).map(r=>({url:(r[1]||'').trim(), name:(r[2]||'').trim()})).filter(x=>isUrl(x.url));
      if (list.length){ setList(list, 'CSV full'); if(autoPlayFirst) playIndex(0); return; }
    }catch(_){}

    channels=[]; populate();
    loadStatus.innerHTML='No channels found. Make the sheet public (Viewer) or use the Web App list.';
  }

  function setList(list, source){
    channels = list.map((x,i)=>({ num:i+1, name:x.name||guessName(x.url), url:x.url }));
    populate();
    loadStatus.textContent = `Loaded ${channels.length} from ${source}.`;
  }

  async function fetchListJson(base){
    const u = base + (base.includes('?') ? '&' : '?') + 'fn=list';
    const r = await fetch(u,{cache:'no-store'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    if (!data || data.ok !== true || !Array.isArray(data.channels)) throw new Error('Bad JSON');
    return data.channels.map(x => (typeof x==='string'?{url:x,name:''}:x)).filter(x => isUrl(x.url));
  }

  function fetchListJsonp(base){
    return new Promise((resolve, reject)=>{
      const cb = 'bfa_cb_' + Math.random().toString(36).slice(2);
      window[cb] = (data)=>{
        try{
          delete window[cb];
          s.remove();
          if (!data || data.ok !== true || !Array.isArray(data.channels)) return reject('Bad JSONP');
          const out = data.channels.map(x => (typeof x==='string'?{url:x,name:''}:x)).filter(x => isUrl(x.url));
          resolve(out);
        }catch(e){ reject(e); }
      };
      const s = document.createElement('script');
      s.src = base + (base.includes('?') ? '&' : '?') + 'fn=list&callback=' + cb;
      s.onerror = ()=>{ delete window[cb]; s.remove(); reject('Script load error'); };
      document.body.appendChild(s);
    });
  }

  async function fetchCsv(url){
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const txt = await r.text();
    if (/^\s*</.test(txt)) throw new Error('Got HTML (permissions)');
    return txt;
  }
  function parseCSV(text){
    const out=[]; let row=[],cur="",inQ=false;
    for (let i=0;i<text.length;i++){
      const ch=text[i],n=text[i+1];
      if (inQ){ if (ch==='"'&&n==='"'){cur+='"';i++} else if (ch==='"'){inQ=false} else cur+=ch; }
      else { if (ch==='"'){inQ=true} else if (ch===','){row.push(cur);cur=""} else if (ch==='\n'){row.push(cur);out.push(row);row=[];cur=""} else if (ch!=='\r'){cur+=ch} }
    }
    row.push(cur); out.push(row);
    return out.filter(r=>r.some(c=>String(c||'').trim().length));
  }
  function guessName(u){ try{ const p=new URL(u).pathname.split('/').filter(Boolean); return decodeURIComponent(p.pop()||'Channel').replace(/\.(m3u8|playlist)$/i,''); }catch{return 'Channel'} }

  // Add links (Direct + Bulk)
  const addMsg=document.getElementById('addMsg'), bulkEl=document.getElementById('bulkTextarea'), singleUrlEl=document.getElementById('singleUrl'), singleNameEl=document.getElementById('singleName');
  function setAddMsg(t){ addMsg.textContent=t; setTimeout(()=> addMsg.textContent='', 5000); }

  document.getElementById('singleAddLocal').onclick = ()=>{
    const url=singleUrlEl.value.trim(), name=singleNameEl.value.trim();
    if (!isUrl(url)) return setAddMsg('Paste a valid http(s) link.');
    const added = addLocal([{url,name}]); if (added){ playIndex(channels.length-1); singleUrlEl.value=''; singleNameEl.value=''; setAddMsg('Added locally ✔'); }
  };
  document.getElementById('singleAddSheet').onclick = async ()=>{
    const url=singleUrlEl.value.trim(), name=singleNameEl.value.trim();
    if (!isUrl(url)) return setAddMsg('Paste a valid http(s) link.');
    const ok = await addToSheet([{url,name}]); setAddMsg(ok?'Added to Sheet ✔':'Add failed'); if (ok){ singleUrlEl.value=''; singleNameEl.value=''; await delay(800); await loadFromSheet(false); }
  };

  document.getElementById('addLocalBtn').onclick = ()=>{
    const items = parseBulk(bulkEl.value.trim()); if(!items.length) return setAddMsg('Paste lines of http(s) links (optional name after comma).');
    const added = addLocal(items); if (added){ playIndex(channels.length-1); bulkEl.value=''; setAddMsg(`Added ${added} locally ✔`); }
  };
  document.getElementById('addSheetBtn').onclick = async ()=>{
    const items = parseBulk(bulkEl.value.trim()); if(!items.length) return setAddMsg('Paste lines of http(s) links (optional name after comma).');
    const ok = await addToSheet(items); setAddMsg(ok?'Added to Sheet ✔ Reloading…':'Some adds failed'); if (ok){ bulkEl.value=''; await delay(800); await loadFromSheet(false); }
  };

  function addLocal(items){
    let added=0;
    for (const it of items){
      if (!isUrl(it.url)) continue;
      if (channels.some(c=>c.url===it.url)) continue;
      channels.push({ num:channels.length+1, name: it.name || guessName(it.url), url: it.url });
      added++;
    }
    populate(); return added;
  }

  async function addToSheet(items){
    const base = document.getElementById('webAppUrl').value.trim(); if (!isUrl(base)) return false;
    // Try POST; if CORS blocks, use JSONP (GET)
    let ok=0;
    for (const it of items){
      const payload = JSON.stringify({url:it.url, name:it.name||''});
      try{
        const res = await fetch(base,{ method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:payload });
        let good=false; try{ const d=await res.json(); good = res.ok && d && d.ok===true; }catch{ good=res.ok; }
        if (!good) throw new Error('POST blocked');
        ok++;
      }catch(_){
        // JSONP fallback
        try{
          await jsonpAdd(base, it.url, it.name||''); ok++;
        }catch(__){}
      }
    }
    return ok===items.length;
  }

  function jsonpAdd(base, url, name){
    return new Promise((resolve,reject)=>{
      const cb = 'bfa_add_' + Math.random().toString(36).slice(2);
      window[cb] = (data)=>{ try{ delete window[cb]; s.remove(); data && data.ok ? resolve() : reject('bad'); }catch(e){ reject(e); } };
      const s = document.createElement('script');
      const q = new URLSearchParams({ fn:'add', url, name, callback:cb });
      s.src = base + (base.includes('?')?'&':'?') + q.toString();
      s.onerror = ()=>{ delete window[cb]; s.remove(); reject('script error'); };
      document.body.appendChild(s);
    });
  }

  function parseBulk(text){
    if (!text) return [];
    return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(line=>{
      const parts=line.split(','); const url=(parts[0]||'').trim(); const name=(parts.slice(1).join(',')||'').trim();
      return isUrl(url)?{url,name}:null;
    }).filter(Boolean);
  }
  function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // initial load
  loadFromSheet(true);
</script>
</body>
</html>
