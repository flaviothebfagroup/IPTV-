<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BFA IPTV ‚Äî Users</title>

  <link rel="manifest" href="/IPTV-/manifest.webmanifest" />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png" />
  <link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0c;--fg:#fff;--muted:#9a9aa0;--panel:#121214;--border:rgba(255,255,255,.14);
      --accent:#ff9500;--tile:#17171a;--tileActive:#1d1d21;--shadow:0 18px 48px rgba(0,0,0,.45);
      --radius:18px;--radius-lg:22px;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444
    }
    body.light{
      --bg:#f5f5f7;--fg:#111;--muted:#6e6e73;--panel:#fff;--border:rgba(0,0,0,.12);
      --tile:#f2f2f7;--tileActive:#eaeaef;--shadow:0 14px 36px rgba(0,0,0,.10)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;margin:0}
    a{color:inherit;text-decoration:none}

    /* Topbar + nav */
    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .lhs{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:#000 center/contain no-repeat;border:1px solid var(--border);overflow:hidden}
    .title{font-weight:900;letter-spacing:.3px}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .btn{height:34px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;line-height:1}
    .btn.primary{border-color:var(--accent);color:var(--accent);background:transparent}
    .btn.solid{background:var(--accent);border-color:var(--accent);color:#000}
    .btn.danger{border-color:#ff6b6b;color:#ff6b6b;background:transparent}
    .muted{color:var(--muted);font-size:12px}

    /* Shell */
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow)}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;margin:10px 0}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .row3{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin:10px 0}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin:10px 0}
    @media (max-width:960px){.row4{grid-template-columns:1fr 1fr}}
    @media (max-width:720px){.row,.row2,.row3{grid-template-columns:1fr;gap:8px}}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .input,.select{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
    .input::placeholder{color:var(--muted)}
    .small{font-size:12px}
    .spacer{height:8px}

    /* Users grid */
    .user-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
    .user-card{background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .user-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .user-name{font-weight:800;display:flex;align-items:center;gap:8px}
    .badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}
    .user-actions{display:flex;gap:8px;flex-wrap:wrap}
    .tag{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:transparent;font-size:12px;color:var(--muted)}
    .online{display:inline-flex;align-items:center;gap:6px;font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#999;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--err)}

    /* Lists / items */
    .list{margin:8px 0 0;padding:0;list-style:none}
    .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px;margin:8px 0;background:var(--tile);border:1px solid var(--border);border-radius:12px;flex-wrap:wrap}
    .empty{padding:12px;border:1px dashed var(--border);border-radius:12px;color:var(--muted);text-align:center}

    /* Toast */
    .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
    .toast.show{opacity:1}
    .toast.err{background:#ff453a;color:#fff}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="lhs">
      <div id="brandLogo" class="logo" title="IPTV"></div>
      <div class="title">BFA IPTV ‚Äî Users</div>
    </div>
    <div class="nav">
      <a class="btn" href="home.html">Home</a>
      <a class="btn" href="dealerships.html">Dealerships</a>
      <a class="btn" href="displays.html">Displays</a>
      <a class="btn primary" href="users.html">Users</a>
      <a class="btn" href="links.html">Links</a>
      <a class="btn" href="analytics.html">Analytics</a>
      <a class="btn" href="schedule.html">Schedule</a>
    </div>
    <div class="nav">
      <button id="themeBtn" class="btn">‚òÄÔ∏é/üåô</button>
      <button id="signOutBtn" class="btn primary">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px">Users</h2>
      <div class="small muted">Create users, manage roles & dealerships, find duplicates, and clean up stale device accounts.</div>

      <!-- Create user -->
      <div class="row4" style="margin-top:12px">
        <div>
          <div class="label">Email</div>
          <input id="userEmail" class="input" placeholder="user@email.com" />
        </div>
        <div>
          <div class="label">Name</div>
          <input id="userName" class="input" placeholder="Full Name" />
        </div>
        <div>
          <div class="label">Role</div>
          <select id="userRole" class="select">
            <option value="user">user</option>
            <option value="admin">admin</option>
            <option value="device">device</option>
          </select>
        </div>
        <div>
          <div class="label">Dealership</div>
          <select id="userDealer" class="select"><option value="">Dealership‚Ä¶</option></select>
        </div>
      </div>

      <div class="row3">
        <div>
          <div class="label">Initial password (at creation)</div>
          <input id="userPass" class="input" type="text" value="123456789" />
          <div class="small muted">Used only when creating a new account. For existing users, use ‚ÄúReset password‚Äù.</div>
        </div>
        <div>
          <div class="label">After create</div>
          <label class="small muted" style="display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:12px;padding:12px">
            <input id="sendResetAfterCreate" type="checkbox" checked /> Send reset email (recommended)
          </label>
        </div>
        <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
          <button id="createUserBtn" class="btn solid">Create User</button>
          <button id="inviteUserBtn" class="btn">Send Reset (existing)</button>
        </div>
      </div>

      <!-- Filters -->
      <div class="row3">
        <div><div class="label">Search</div><input id="userSearch" class="input" placeholder="Search name or email‚Ä¶" /></div>
        <div><div class="label">Filter dealership</div><select id="filterDealer" class="select"><option value="">All dealerships</option></select></div>
        <div><div class="label">Filter role</div>
          <select id="filterRole" class="select">
            <option value="">All roles</option><option value="admin">admin</option><option value="device">device</option><option value="user">user</option><option value="disabled">disabled</option>
          </select>
        </div>
      </div>

      <!-- Duplicate finder -->
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0;flex-wrap:wrap">
        <button id="findDupBtn" class="btn">Find duplicates</button>
        <button id="deleteDupBtn" class="btn danger">Delete selected duplicates</button>
        <span class="muted small">Duplicates = device users with the same name within a dealership. Green dot = currently active.</span>
      </div>
      <div id="dupBox" class="card" style="display:none;margin-bottom:10px">
        <h3 style="margin:0 0 6px">Duplicate candidates</h3>
        <div id="dupList" class="list"></div>
        <div class="small muted" id="dupEmpty" style="display:none">No duplicates found.</div>
      </div>

      <!-- Device Cleanup -->
      <div class="card" id="deviceCleanup" style="margin-top:10px">
        <h3 style="margin:0 0 6px">Device Cleanup</h3>
        <div class="row3">
          <div>
            <div class="label">Inactivity threshold (hours)</div>
            <input id="dcThresholdHours" class="input" type="number" min="1" value="24" />
          </div>
          <div>
            <div class="label">Active window (minutes)</div>
            <input id="dcActiveMins" class="input" type="number" min="1" value="10" />
          </div>
          <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
            <button id="dcScan" class="btn">Scan</button>
            <button id="dcSelectAuto" class="btn">Select stale</button>
            <button id="dcSelectAll" class="btn">Select all</button>
            <label class="muted" style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="dcLive" /> Live monitor
            </label>
            <button id="dcDelete" class="btn danger" disabled>Delete selected</button>
          </div>
        </div>
        <div class="small muted">Finds <b>device</b> users not seen within the threshold and not currently active (never selects green-dot devices).</div>
        <div id="dcList" class="list"></div>
        <div id="dcEmpty" class="empty" style="display:none">No stale device users found.</div>
      </div>

      <div class="spacer"></div>

      <!-- Groups -->
      <div class="group"><h3>Admins (<span id="countAdmins">0</span>)</h3><div class="user-grid" id="gridAdmins"></div></div>
      <div class="group"><h3>Device Users (<span id="countDevices">0</span>)</h3><div class="user-grid" id="gridDevices"></div></div>
      <div class="group"><h3>Regular Users (<span id="countUsers">0</span>)</h3><div class="user-grid" id="gridUsers"></div></div>
      <div class="group"><h3>Disabled (<span id="countDisabled">0</span>)</h3><div class="user-grid" id="gridDisabled"></div></div>
      <div id="userEmpty" class="empty" style="display:none">No users.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp, deleteApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged,
      sendPasswordResetEmail, signOut, createUserWithEmailAndPassword
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getDatabase, ref, get, set, update, remove, onValue
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ========= CONFIG =========
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };
    const LOGO_URL = "https://flaviothebfagroup.github.io/IPTV-/icons/icon-512.png";

    // ========= Helpers / UI =========
    const $ = s => document.querySelector(s);
    function htmlEscape(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function toast(msg, err=false){ const t=$('#toast'); t.textContent=msg; t.className='toast show'+(err?' err':''); setTimeout(()=>t.classList.remove('show'),2200); }
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    function timeAgo(ts){ if(!ts) return '‚Äî'; const s=Math.max(1,Math.floor((Date.now()-ts)/1000)); const u=[['d',86400],['h',3600],['m',60],['s',1]]; for(const [l,v] of u){ if(s>=v) return Math.floor(s/v)+l; } return s+'s'; }

    // Theme + logo
    const savedTheme = localStorage.getItem('iptv_theme') || 'light';
    document.body.classList.toggle('light', savedTheme==='light');
    $('#themeBtn').addEventListener('click', ()=>{
      const isLight = !document.body.classList.contains('light');
      document.body.classList.toggle('light', isLight);
      localStorage.setItem('iptv_theme', isLight ? 'light' : 'dark');
    });
    $('#brandLogo').style.backgroundImage = `url("${LOGO_URL}")`;

    // App
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='home.html'; return; }
    });
    $('#signOutBtn').addEventListener('click', ()=>signOut(auth));

    // Load dealers into selects
    async function loadDealersMap(){
      let map={};
      try{
        const pub=await get(ref(db,'dealershipPublic'));
        if(pub.exists()) map=Object.fromEntries(Object.entries(pub.val()).map(([k,v])=>[k,v?.name||k]));
      }catch(e){}
      const selUser=$('#userDealer'), selFilter=$('#filterDealer');
      const prevU=selUser.value, prevF=selFilter.value;
      selUser.innerHTML='<option value="">Dealership‚Ä¶</option>';
      selFilter.innerHTML='<option value="">All dealerships</option>';
      for(const [id,name] of Object.entries(map).sort((a,b)=>a[1].localeCompare(b[1]))){
        const u=document.createElement('option'); u.value=id; u.textContent=name; selUser.appendChild(u);
        const f=document.createElement('option'); f.value=id; f.textContent=name; selFilter.appendChild(f);
      }
      selUser.value=prevU||''; selFilter.value=prevF||'';
      return map;
    }

    // Create user (with initial password)
    $('#createUserBtn').addEventListener('click', createUserAdminSafe);
    $('#inviteUserBtn').addEventListener('click', async ()=>{
      const email=$('#userEmail').value.trim(); if(!email) return toast('Enter email',true);
      try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(e){ console.error(e); toast('Reset failed',true); }
    });

    async function createUserAdminSafe(){
      const email=$('#userEmail').value.trim();
      const name=$('#userName').value.trim();
      const role=$('#userRole').value;
      const did=$('#userDealer').value;
      const pass=$('#userPass').value || '123456789';
      const alsoReset=$('#sendResetAfterCreate').checked;

      if(!email||!name||!role||!did) return toast('Fill all fields',true);
      if((pass||'').length<6) return toast('Password must be at least 6 chars', true);

      const tempName='admin-helper-'+Date.now();
      const tempApp=initializeApp(firebaseConfig,tempName);
      const tempAuth=getAuth(tempApp);
      try{
        const cred=await createUserWithEmailAndPassword(tempAuth,email,pass);
        const uid=cred.user.uid;

        let dname=did; try{ const p=await get(ref(db,`dealershipPublic/${did}`)); if(p.exists()) dname=p.val()?.name||did; }catch(e){}
        let displays=[]; const ds=await get(ref(db,`dealership/${did}/displays`)); if(ds.exists()) displays=Object.keys(ds.val()||{});

        await set(ref(db,`user/${uid}`),{
          email,name,role,dealershipId:did,dealershipName:dname,displays,createdAt:Date.now()
        });

        if(alsoReset){ try{ await sendPasswordResetEmail(tempAuth,email); }catch(_){ } }

        toast('User created'); clearCreateForm(); await refreshUsers();
      }catch(e){ console.error(e); toast('Create failed: '+(e?.code||'error'),true); }
      finally{ try{ await deleteApp(tempApp);}catch(e){} }
    }
    function clearCreateForm(){
      $('#userEmail').value=''; $('#userName').value='';
      $('#userRole').value='user'; $('#userDealer').value='';
    }

    // Filters/events
    $('#userSearch').addEventListener('input', debounce(refreshUsers, 200));
    $('#filterDealer').addEventListener('change', refreshUsers);
    $('#filterRole').addEventListener('change', refreshUsers);

    // Users list (with green dot + Delete button)
    async function refreshUsers(){
      const search=($('#userSearch').value||'').toLowerCase();
      const fDid=$('#filterDealer').value;
      const fRole=$('#filterRole').value;
      const dealers=await loadDealersMap();

      let map={}; try{ const u=await get(ref(db,'user')); if(u.exists()) map=u.val(); }catch(e){}
      const rows=Object.entries(map).map(([uid,v])=>({uid,...v}));

      const filtered=rows.filter(r=>{
        if(fDid && r.dealershipId!==fDid) return false;
        if(fRole && (r.role||'user')!==fRole) return false;
        if(search && !((r.email||'').toLowerCase().includes(search) || (r.name||'').toLowerCase().includes(search))) return false;
        return true;
      });

      const groups={admin:[],device:[],user:[],disabled:[]};
      filtered.forEach(r=>{ const role=(r.role||'user');
        if(role==='admin') groups.admin.push(r);
        else if(role==='device') groups.device.push(r);
        else if(role==='disabled') groups.disabled.push(r);
        else groups.user.push(r);
      });

      $('#countAdmins').textContent=groups.admin.length;
      $('#countDevices').textContent=groups.device.length;
      $('#countUsers').textContent=groups.user.length;
      $('#countDisabled').textContent=groups.disabled.length;

      $('#userEmpty').style.display= (groups.admin.length+groups.device.length+groups.user.length+groups.disabled.length)? 'none':'block';

      const { map:actMap, now } = await getActivityMap();
      const me = auth.currentUser?.uid;

      const renderGroup=(arr,gridId)=>{
        const grid=document.getElementById(gridId); grid.innerHTML='';
        arr.sort((a,b)=> (a.dealershipName||a.dealershipId||'').localeCompare(b.dealershipName||b.dealershipId||'') || (a.email||'').localeCompare(b.email||''));
        arr.forEach(r=>{
          const dealer=r.dealershipName||r.dealershipId||'‚Äî';
          const isDevice=(r.role==='device');
          const last=actMap[r.uid] || r.updatedAt || r.createdAt || 0;
          const active=isDevice && last && (now-last) < 10*60*1000;

          const card=document.createElement('div'); card.className='user-card';
          card.innerHTML=`
            <div class="user-header">
              <div class="user-name" title="Click to rename" data-rename="${r.uid}">
                ${isDevice ? `<i class="dot ${active?'ok':'err'}" title="${active?'Active now':'Inactive'}"></i>` : ''}
                ${htmlEscape(r.name||'No name')}
              </div>
              <span class="badge">${htmlEscape(r.role||'user')}</span>
            </div>
            <div class="small muted" style="display:flex;gap:8px;flex-wrap:wrap">
              <span>${htmlEscape(r.email||'')}</span>
              <span class="badge">${htmlEscape(dealer)}</span>
              ${last? `<span class="badge">last ${timeAgo(last)}</span>`:''}
            </div>
            <div class="user-actions">
              <select data-uid="${r.uid}" class="select roleSel">
                ${['user','admin','device','disabled'].map(v=>`<option value="${v}" ${v===(r.role||'user')?'selected':''}>${v}</option>`).join('')}
              </select>
              <select data-uid="${r.uid}" class="select dealerSel">
                ${Object.entries(dealers).map(([id,nm])=>`<option value="${id}" ${id===(r.dealershipId||'')?'selected':''}>${nm}</option>`).join('')}
              </select>
              <button class="btn" data-reset="${htmlEscape(r.email||'')}">Reset password</button>
              <button class="btn danger" data-del="${r.uid}" ${r.uid===me?'disabled':''}>Delete</button>
            </div>`;
          grid.appendChild(card);
        });

        // rename name
        grid.querySelectorAll('[data-rename]').forEach(el=>{
          el.addEventListener('click', async ()=>{
            const uid=el.getAttribute('data-rename'); const current=el.textContent.trim();
            const next=prompt('New name', current||''); if(!next || next===current) return;
            try{ await update(ref(db,`user/${uid}`),{name:next}); el.innerHTML = el.innerHTML.replace(current, htmlEscape(next)); toast('Name updated'); }catch(e){ toast('Update failed',true); }
          });
        });
        // role change
        grid.querySelectorAll('.roleSel').forEach(sel=>{
          sel.addEventListener('change', async (e)=>{ const uid=e.target.dataset.uid; const role=e.target.value;
            try{ await update(ref(db,`user/${uid}`),{role}); toast('Role updated'); await refreshUsers(); }catch(err){ toast('Update failed',true); }
          });
        });
        // move dealership
        grid.querySelectorAll('.dealerSel').forEach(sel=>{
          sel.addEventListener('change', async (e)=>{ const uid=e.target.dataset.uid; const did=e.target.value;
            const name=dealers[did]||did;
            try{ await update(ref(db,`user/${uid}`),{dealershipId:did,dealershipName:name}); toast('Moved'); }catch(err){ toast('Move failed',true); }
          });
        });
        // reset password
        grid.querySelectorAll('[data-reset]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const email=btn.getAttribute('data-reset'); if(!email) return toast('No email',true);
            try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(err){ toast('Reset failed',true); }
          });
        });
        // delete user
        grid.querySelectorAll('[data-del]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const uid=btn.getAttribute('data-del');
            if(uid===me) return; // already disabled
            if(!confirm('Delete this user from the database? (Auth account is not removed)')) return;
            try{ await remove(ref(db,`user/${uid}`)); toast('User deleted'); await refreshUsers(); }catch(e){ toast('Delete failed', true); }
          });
        });
      };

      renderGroup(groups.admin,'gridAdmins');
      renderGroup(groups.device,'gridDevices');
      renderGroup(groups.user,'gridUsers');
      renderGroup(groups.disabled,'gridDisabled');
    }

    // Build activity map from displays
    async function getActivityMap(){
      let map={}; const s=await get(ref(db,'displays'));
      const now=Date.now();
      if(s.exists()){
        const d=s.val()||{};
        Object.values(d).forEach(v=>{
          const uid=v?.lastUser?.uid;
          const last=Math.max(v?.lastSeenAt||0, v?.timestamp||0);
          if(uid){ map[uid] = Math.max(map[uid]||0, last); }
        });
      }
      return { map, now };
    }

    // Duplicate finder
    const DUP_SEL = new Set();
    $('#findDupBtn').addEventListener('click', async ()=>{
      DUP_SEL.clear(); $('#dupList').innerHTML='';
      let map={}; try{ const u=await get(ref(db,'user')); if(u.exists()) map=u.val(); }catch(e){}
      const rows=Object.entries(map).map(([uid,v])=>({uid,...v})).filter(r=> (r.role==='device') && r.name && r.dealershipId);
      const groups={};
      rows.forEach(r=>{
        const key=(r.dealershipId||'')+'|'+(r.name||'').toLowerCase().trim();
        if(!groups[key]) groups[key]=[];
        groups[key].push(r);
      });
      const { map:actMap, now } = await getActivityMap();
      let any=false;
      for(const [key,arr] of Object.entries(groups)){
        if(arr.length<=1) continue;
        any=true;
        arr.sort((a,b)=> (actMap[b.uid]||b.updatedAt||0)-(actMap[a.uid]||a.updatedAt||0));
        const holder=document.createElement('div'); holder.className='item';
        const [did,name]=key.split('|');
        const inner=arr.map(r=>{
          const last=actMap[r.uid]||r.updatedAt||0;
          const active = last && (now-last) < 10*60*1000;
          return `
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" data-uid="${r.uid}"/>
              <span>
                ${active?'<i class="dot ok" title="Active now"></i>':'<i class="dot err" title="Inactive"></i>'}
                ${htmlEscape(r.name)} <span class="tag">${htmlEscape(did)}</span>
                ${last? `<span class="badge">last ${timeAgo(last)}</span>`:''}
                <span class="badge">${htmlEscape(r.email||'')}</span>
              </span>
            </label>`;
        }).join('<br/>');
        holder.innerHTML = `<div><b>‚Äú${htmlEscape(name)}‚Äù in ${htmlEscape(did)}</b><div class="small muted">Select old/unused ones and delete</div></div><div>${inner}</div>`;
        $('#dupList').appendChild(holder);
      }
      $('#dupBox').style.display='block';
      $('#dupEmpty').style.display= any? 'none':'block';
      $('#dupList').querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change',()=>{ const uid=cb.dataset.uid; if(cb.checked) DUP_SEL.add(uid); else DUP_SEL.delete(uid); });
      });
    });
    $('#deleteDupBtn').addEventListener('click', async ()=>{
      if(!DUP_SEL.size) { toast('Pick duplicates to delete'); return; }
      if(!confirm(`Delete ${DUP_SEL.size} selected user(s)?`)) return;
      try{
        await Promise.all(Array.from(DUP_SEL).map(uid=> remove(ref(db,`user/${uid}`)).catch(()=>{})));
        DUP_SEL.clear(); toast('Deleted'); document.getElementById('dupBox').style.display='none'; await refreshUsers();
      }catch(e){ toast('Delete failed',true); }
    });

    // Device Cleanup
    const DC_SEL = new Set();
    let DC_LIVE_OFF = null;
    const $dc = {
      hrs: ()=> Math.max(1, parseInt($('#dcThresholdHours').value,10)||24),
      mins:()=> Math.max(1, parseInt($('#dcActiveMins').value,10)||10),
      list:  $('#dcList'),
      empty: $('#dcEmpty'),
      scanBtn: $('#dcScan'),
      selAutoBtn: $('#dcSelectAuto'),
      delBtn: $('#dcDelete'),
      selectAllBtn: $('#dcSelectAll'),
      liveChk: $('#dcLive'),
    };

    $dc.scanBtn.addEventListener('click', scanDeviceCleanup);
    $dc.selectAllBtn.addEventListener('click', ()=>{
      $dc.list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked = true; DC_SEL.add(cb.dataset.uid); });
      updateDcDeleteState();
    });
    $dc.selAutoBtn.addEventListener('click', ()=>{
      $dc.list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked = true; DC_SEL.add(cb.dataset.uid); });
      updateDcDeleteState();
    });
    $dc.liveChk.addEventListener('change', ()=>{
      if($dc.liveChk.checked){
        const dispRef = ref(db,'displays');
        const off = onValue(dispRef, ()=> scanDeviceCleanup().catch(()=>{}));
        DC_LIVE_OFF = ()=> off();
        scanDeviceCleanup();
      }else{
        if(DC_LIVE_OFF){ DC_LIVE_OFF(); DC_LIVE_OFF=null; }
      }
    });
    $dc.delBtn.addEventListener('click', async ()=>{
      if(!DC_SEL.size) return toast('Nothing selected', true);
      if(!confirm(`Delete ${DC_SEL.size} device user(s) from database? (Auth account not removed)`)) return;
      try{
        await Promise.all(Array.from(DC_SEL).map(uid=> remove(ref(db,`user/${uid}`)).catch(()=>{})));
        toast('Deleted');
        DC_SEL.clear();
        await scanDeviceCleanup();
        await refreshUsers();
      }catch(e){ console.error(e); toast('Delete failed', true); }
    });

    async function scanDeviceCleanup(){
      DC_SEL.clear(); updateDcDeleteState();
      $dc.list.innerHTML=''; $dc.empty.style.display='none';
      let map={}; try{ const u=await get(ref(db,'user')); if(u.exists()) map=u.val(); }catch(e){}
      const all = Object.entries(map).map(([uid,v])=>({uid,...v}));
      const devices = all.filter(u => (u.role==='device'));
      const { map:actMap, now } = await getActivityMap();

      const msThreshold = $dc.hrs()*60*60*1000;
      const msActive    = $dc.mins()*60*1000;

      const stale = [];
      devices.forEach(u=>{
        const seen = actMap[u.uid] || u.updatedAt || u.createdAt || 0;
        const isActive = (actMap[u.uid] && (now-actMap[u.uid]) < msActive);
        const tooOld  = (now - (seen||0)) > msThreshold;
        if(!isActive && tooOld){
          stale.push({
            uid: u.uid, name: u.name || '(no name)', email: u.email || '',
            dealershipName: u.dealershipName || u.dealershipId || '‚Äî', lastSeen: seen || 0
          });
        }
      });
      if(!stale.length){ $dc.empty.style.display='block'; return; }
      stale.sort((a,b)=> (a.lastSeen||0) - (b.lastSeen||0));
      stale.forEach(r=>{
        const li=document.createElement('div'); li.className='item';
        li.innerHTML = `
          <label style="display:flex;align-items:center;gap:10px">
            <input type="checkbox" data-uid="${r.uid}"/>
            <div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <b>${htmlEscape(r.name)}</b>
                <span class="badge">${htmlEscape(r.email)}</span>
                <span class="badge">${htmlEscape(r.dealershipName)}</span>
                <span class="badge">${r.lastSeen ? ('last: '+htmlEscape(timeAgo(r.lastSeen))) : 'no activity'}</span>
              </div>
              <div class="small muted">Will be deleted (inactive ‚â• ${$dc.hrs()}h & not currently active)</div>
            </div>
          </label>`;
        $dc.list.appendChild(li);
      });
      $dc.list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change',()=>{ const uid=cb.dataset.uid; if(cb.checked) DC_SEL.add(uid); else DC_SEL.delete(uid); updateDcDeleteState(); });
      });
    }
    function updateDcDeleteState(){ $dc.delBtn.disabled = DC_SEL.size===0; }

    // Init
    await loadDealersMap();
    await refreshUsers();
  </script>
</body>
</html>
