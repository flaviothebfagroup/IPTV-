<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>BFA IPTV â€” Analytics</title>

  <style>
    :root{
      --bg:#0b0b0c;--fg:#fff;--muted:#9a9aa0;--panel:#121214;--border:rgba(255,255,255,.14);
      --accent:#ff9500;--tile:#17171a;--tileActive:#1d1d21;--shadow:0 18px 48px rgba(0,0,0,.45);
      --radius:18px;--radius-lg:22px;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444
    }
    body.light{
      --bg:#f5f5f7;--fg:#111;--muted:#6e6e73;--panel:#fff;--border:rgba(0,0,0,.12);
      --tile:#f2f2f7;--tileActive:#eaeaef;--shadow:0 14px 36px rgba(0,0,0,.10)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;margin:0}
    a{color:inherit;text-decoration:none}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .lhs{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:#000 center/cover no-repeat;border:1px solid var(--border)}
    .title{font-weight:900;letter-spacing:.3px}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .btn{height:36px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .btn.primary{border-color:var(--accent);color:var(--accent);background:transparent}
    .btn.solid{background:var(--accent);color:#000;border-color:var(--accent)}
    .btn.danger{border-color:#ff6b6b;color:#ff6b6b;background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}

    /* Shell */
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow)}
    h2{margin:0 0 8px}

    /* Inputs */
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;margin:10px 0}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin:10px 0}
    @media (max-width:900px){.row3{grid-template-columns:1fr 1fr}.row4{grid-template-columns:1fr 1fr}}
    @media (max-width:600px){.row,.row2,.row3,.row4{grid-template-columns:1fr}}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .input,.select{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
    .input::placeholder{color:var(--muted)}
    .small{font-size:12px}

    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:8px 0}
    @media (max-width:980px){.stats{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.stats{grid-template-columns:1fr}}
    .stat{background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:14px}
    .stat b{font-size:22px}

    /* Bars */
    .list{margin:8px 0 0;padding:0;list-style:none}
    .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px;margin:8px 0;background:var(--tile);border:1px solid var(--border);border-radius:12px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:6px;min-width:200px}
    .bar{height:10px;background:var(--tileActive);border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#ffb866)}
    .badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}
    .online{display:inline-flex;align-items:center;gap:6px;font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#999}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--err)}

    /* Toast */
    .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
    .toast.show{opacity:1}
    .toast.err{background:#ff453a;color:#fff}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="lhs">
      <a href="home.html" title="Home"><div id="brandLogo" class="logo"></div></a>
      <div class="title">BFA IPTV â€” Analytics</div>
    </div>
    <div class="nav">
      <a class="btn" href="home.html">Home</a>
      <a class="btn" href="dealerships.html">Dealerships</a>
      <a class="btn" href="displays.html">Displays</a>
      <a class="btn" href="users.html">Users</a>
      <a class="btn" href="links.html">Links</a>
      <a class="btn" href="schedule.html">Schedule</a>
      <button id="themeBtn" class="btn">â˜€ï¸Ž/ðŸŒ™</button>
      <button id="reloadBtn" class="btn">Reload</button>
      <button id="signOutBtn" class="btn primary">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Auth gates -->
    <div id="loginBox" class="card" style="max-width:520px;margin:40px auto;display:none">
      <h2>Admin Sign In</h2>
      <div class="row2">
        <div><div class="label">Email</div><input id="email" class="input" type="email" placeholder="you@company.com" autocomplete="email"/></div>
        <div><div class="label">Password</div><input id="password" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/></div>
      </div>
      <div class="row2">
        <button id="loginBtn" class="btn solid">Sign in</button>
        <button id="resetBtn" class="btn">Send reset link</button>
      </div>
      <div class="small muted">Requires <b>role: "admin"</b> in <code>/user/{uid}</code>.</div>
    </div>

    <div id="notAdmin" class="card" style="display:none;max-width:720px;margin:40px auto">
      <h2>Not authorized</h2>
      <div class="muted small">Ask an admin to set your role to <b>admin</b> in the database.</div>
    </div>

    <!-- Analytics -->
    <div id="anaPg" style="display:none">
      <div class="card">
        <h2>Analytics â€” right now</h2>
        <div class="row3" style="margin-top:6px">
          <div>
            <div class="label">Active window</div>
            <select id="activeWindow" class="select">
              <option value="1">1 minute</option>
              <option value="5" selected>5 minutes</option>
              <option value="10">10 minutes</option>
              <option value="30">30 minutes</option>
              <option value="60">1 hour</option>
            </select>
          </div>
          <div>
            <div class="label">Filter dealership</div>
            <select id="filterDealer" class="select"><option value="">All dealerships</option></select>
          </div>
          <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
            <a class="btn" href="displays.html">Manage Displays</a>
            <button id="refreshBtn" class="btn">Refresh</button>
          </div>
        </div>

        <!-- Stats row -->
        <div class="stats">
          <div class="stat"><div class="muted small">Active TVs</div><b id="statActive">0</b></div>
          <div class="stat"><div class="muted small">Offline</div><b id="statOffline">0</b></div>
          <div class="stat"><div class="muted small">Top Channel</div><b id="statTopCh">â€”</b></div>
          <div class="stat"><div class="muted small">Avg Volume / Muted</div><b id="statVolMuted">0 â€¢ 0%</b></div>
        </div>

        <h3 style="margin:10px 0 6px">Channel mix</h3>
        <div id="anaChBars"></div>

        <h3 style="margin:16px 0 6px">Most active dealerships</h3>
        <div id="anaDealerBars"></div>

        <h3 style="margin:16px 0 6px">Online TVs now</h3>
        <div id="onlineList" class="list"></div>
        <div id="noneOnline" class="muted small" style="display:none">No TVs online in this window.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword,
      onAuthStateChanged, sendPasswordResetEmail, signOut
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getDatabase, ref, get, onValue, query, orderByChild, equalTo
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ====== CONFIG ======
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };
    const LOGO_URL = "https://flaviothebfagroup.github.io/IPTV-/icons/icon-512.png";

    // ====== APP ======
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const $ = s => document.querySelector(s);
    function toast(msg, err=false){ const t=$('#toast'); t.textContent=msg; t.className='toast show'+(err?' err':''); setTimeout(()=>t.classList.remove('show'),2200); }

    // Theme + logo
    const savedTheme = localStorage.getItem('iptv_theme') || 'light';
    document.body.classList.toggle('light', savedTheme==='light');
    document.getElementById('themeBtn').addEventListener('click', ()=>{
      const isLight = !document.body.classList.contains('light');
      document.body.classList.toggle('light', isLight);
      localStorage.setItem('iptv_theme', isLight ? 'light' : 'dark');
    });
    document.getElementById('brandLogo').style.backgroundImage = `url("${LOGO_URL}")`;

    // Nav & auth
    document.getElementById('reloadBtn').addEventListener('click', ()=> location.reload());
    document.getElementById('signOutBtn').addEventListener('click', ()=> signOut(auth));
    document.getElementById('refreshBtn').addEventListener('click', ()=> computeAnalytics());

    document.getElementById('loginBtn').addEventListener('click', doLogin);
    document.getElementById('resetBtn').addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      if(!email) return toast('Enter email', true);
      try{ await sendPasswordResetEmail(auth, email); toast('Reset sent'); }catch(e){ toast('Reset failed', true); }
    });

    async function doLogin(){
      const email=document.getElementById('email').value.trim(), pass=document.getElementById('password').value;
      if(!email||!pass) return toast('Fill email & password', true);
      try{ await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth,email,pass); }
      catch(e){ console.error(e); toast('Sign-in failed', true); }
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        showGate('login'); return;
      }
      // admin check
      try{
        const u = (await get(ref(db, `user/${user.uid}`))).val()||{};
        if(u.role!=='admin'){ showGate('notAdmin'); return; }
      }catch(_){}
      showGate('ok');
      await loadDealers();
      startLive();
    });

    function showGate(which){
      document.getElementById('loginBox').style.display = which==='login' ? 'block':'none';
      document.getElementById('notAdmin').style.display = which==='notAdmin' ? 'block':'none';
      document.getElementById('anaPg').style.display   = which==='ok' ? 'block':'none';
    }

    // ====== dealers map for filter ======
    let DEALERS = {};
    async function loadDealers(){
      DEALERS = {};
      try{
        const pub = await get(ref(db,'dealershipPublic'));
        if(pub.exists()){
          Object.entries(pub.val()).forEach(([id,v])=> DEALERS[id] = v?.name||id);
        }
      }catch(_){}
      if(!Object.keys(DEALERS).length){
        try{
          const d = await get(ref(db,'dealership'));
          if(d.exists()){
            Object.entries(d.val()).forEach(([id,v])=> DEALERS[id] = v?.name||id);
          }
        }catch(_){}
      }
      const sel=document.getElementById('filterDealer');
      const prev=sel.value;
      sel.innerHTML='<option value="">All dealerships</option>';
      Object.entries(DEALERS).sort((a,b)=>a[1].localeCompare(b[1])).forEach(([id,name])=>{
        const o=document.createElement('option'); o.value=id; o.textContent=name; sel.appendChild(o);
      });
      sel.value=prev||'';
      sel.addEventListener('change', computeAnalytics);
      document.getElementById('activeWindow').addEventListener('change', computeAnalytics);
    }

    // ====== live displays listener ======
    let displaysMap = {};
    let unsub = null;
    function startLive(){
      if(unsub) unsub();
      const off = onValue(ref(db,'displays'), snap=>{
        displaysMap = snap.exists()? snap.val() : {};
        computeAnalytics();
      }, err=>console.warn(err));
      unsub = ()=>off();
    }

    function activeThresholdMs(){
      const mins = parseInt(document.getElementById('activeWindow').value, 10) || 5;
      return mins*60*1000;
    }

    function computeAnalytics(){
      const dealerFilter = document.getElementById('filterDealer').value || '';
      const now = Date.now(), win = activeThresholdMs();

      const items = Object.entries(displaysMap)
        .map(([id,v])=>({id, ...v}))
        .filter(r=> dealerFilter ? (r.dealership===dealerFilter) : true);

      // status
      let onlineList = [];
      let offline = 0;
      const chCounts = {1:0,2:0,3:0,4:0,5:0};
      const dealerCounts = {};
      let volSum=0, volN=0, muted=0;

      items.forEach(r=>{
        const seen = r.lastSeenAt || r.timestamp || 0;
        const isOnline = (now - seen) <= win;
        if(isOnline){
          onlineList.push(r);
          const ch = Math.max(1, Math.min(5, parseInt(r.channel||1,10)||1));
          chCounts[ch] = (chCounts[ch]||0)+1;
          dealerCounts[r.dealership||'â€”'] = (dealerCounts[r.dealership||'â€”']||0)+1;
          if(typeof r.volume==='number'){ volSum+=r.volume; volN++; }
          if(r.muted===true) muted++;
        }else{
          offline++;
        }
      });

      // stats
      const active = onlineList.length;
      const avgVol = volN ? Math.round(volSum/volN) : 0;
      const mutedPct = (active+offline) ? Math.round((muted/(active+offline))*100) : 0;
      const topCh = Object.entries(chCounts).sort((a,b)=>b[1]-a[1])[0];
      document.getElementById('statActive').textContent = active;
      document.getElementById('statOffline').textContent = offline;
      document.getElementById('statTopCh').textContent = topCh && topCh[1]>0 ? 'CH '+topCh[0] : 'â€”';
      document.getElementById('statVolMuted').textContent = `${avgVol} â€¢ ${mutedPct}%`;

      // channel bars (only CH1..CH5)
      renderBars('anaChBars', Object.entries(chCounts).map(([k,v])=>({label:'Channel '+k, value:v})));

      // dealer bars (top 10)
      const dArr = Object.entries(dealerCounts).map(([k,v])=>({label:(DEALERS[k]||k), value:v}))
                      .sort((a,b)=>b.value-a.value).slice(0,10);
      renderBars('anaDealerBars', dArr);

      // online list
      const list = document.getElementById('onlineList');
      list.innerHTML='';
      if(!onlineList.length){
        document.getElementById('noneOnline').style.display='block';
      }else{
        document.getElementById('noneOnline').style.display='none';
        onlineList.sort((a,b)=> (a.dealership||'').localeCompare(b.dealership||'') || (a.id||'').localeCompare(b.id||''));
        onlineList.forEach(r=>{
          const row = document.createElement('div'); row.className='item';
          const seen = r.lastSeenAt || r.timestamp || 0;
          row.innerHTML = `
            <div class="col">
              <div>
                <span class="badge">${(DEALERS[r.dealership]||r.dealership||'â€”')}</span>
                <b style="margin-left:6px">${r.id}</b>
              </div>
              <div class="muted small">Seen: ${new Date(seen).toLocaleTimeString()}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span class="badge">CH ${r.channel ?? 1}</span>
              <span class="badge">VOL ${r.volume ?? 0}</span>
              <span class="badge">${r.muted ? 'Muted' : 'Unmuted'}</span>
            </div>`;
          list.appendChild(row);
        });
      }
    }

    function renderBars(containerId, rows){
      const wrap = document.getElementById(containerId);
      wrap.innerHTML='';
      const total = rows.reduce((a,b)=>a+b.value,0);
      rows.forEach(r=>{
        const pct = total ? Math.round((r.value/total)*100) : 0;
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `
          <div class="col">
            <b>${r.label}</b>
            <div class="bar"><i style="width:${pct}%"></i></div>
          </div>
          <div class="small muted">${r.value} â€¢ ${pct}%</div>`;
        wrap.appendChild(div);
      });
      if(!rows.length){
        const empty=document.createElement('div'); empty.className='muted small'; empty.textContent='No data.';
        wrap.appendChild(empty);
      }
    }
  </script>
</body>
</html>
