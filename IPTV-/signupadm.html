<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>BFA IPTV — Dealership Admin</title>

  <!-- Leaflet for free/open maps (no API key) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin="">
  </script>

  <style>
    :root { --bg:#0b0b0c; --fg:#fff; --muted:#9a9aa0; --panel:#121214; --border:rgba(255,255,255,.14);
            --accent:#ff9500; --shadow:0 18px 48px rgba(0,0,0,.45); }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;
    }
    .shell{
      max-width:1100px;
      margin:24px auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    @media (min-width:900px){
      .layout{
        display:grid;
        grid-template-columns: minmax(0, 0.4fr) minmax(0, 0.6fr);
        gap:16px;
      }
    }
    .card{
      background:var(--panel);
      border-radius:24px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
    }
    h1{
      font-size:22px;
      font-weight:800;
      margin:0 0 4px;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
    }
    .section-title{
      font-size:13px;
      font-weight:600;
      margin-bottom:8px;
    }
    .dealer-list{
      max-height:420px;
      overflow:auto;
      margin-top:4px;
      border-radius:16px;
      border:1px solid var(--border);
      padding:6px 8px;
      background:#09090b;
    }
    .dealer-item{
      padding:8px 8px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .dealer-item + .dealer-item{
      margin-top:4px;
    }
    .dealer-item.active{
      background:rgba(255,149,0,.14);
      border:1px solid rgba(255,149,0,.6);
    }
    .dealer-name{
      font-size:13px;
      font-weight:600;
    }
    .dealer-meta{
      font-size:11px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--muted);
    }
    .pill span.key{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.8px;
      opacity:.7;
    }
    .pill span.value{
      font-family:monospace;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin:6px 0;
    }
    label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.8px;
    }
    .input, .textarea{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#050508;
      color:var(--fg);
      font-size:13px;
      outline:none;
    }
    .textarea{
      min-height:48px;
      resize:vertical;
    }
    .input::placeholder, .textarea::placeholder{
      color:rgba(154,154,160,.8);
    }
    .input:focus, .textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(255,149,0,.35);
    }
    .row{
      display:flex;
      gap:8px;
    }
    .row > .field{
      flex:1;
      margin:0;
    }
    .btn-row{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:10px;
    }
    .btn{
      padding:9px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
    }
    .btn-secondary{
      background:transparent;
      color:var(--muted);
      border:1px solid var(--border);
    }
    .btn-primary{
      background:var(--accent);
      color:#000;
    }
    .btn-danger{
      background:#ff453a;
      color:#fff;
    }
    #map{
      width:100%;
      height:360px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    .help-text{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:var(--accent);
      color:#000;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      opacity:0;
      transition:opacity .25s;
      pointer-events:none;
      max-width:90vw;
      text-align:center;
      z-index:9999;
    }
    .toast.show{opacity:1}
    .toast.error{background:#ff453a;color:#fff;}
  </style>
</head>
<body>
  <div class="shell">
    <div>
      <h1>Dealership Manager</h1>
      <div class="subtitle">
        Admin-only. Paste a Google Maps link, we’ll extract name + coordinates and save everything to <code>dealershipPublic</code>.
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: list -->
      <div class="card">
        <div class="section-title">Existing Dealerships</div>
        <div class="field">
          <input id="listSearch" class="input" placeholder="Filter by name / city / postal">
        </div>
        <div id="dealerList" class="dealer-list"></div>
        <div class="help-text">
          Click a dealership to edit it, or use the form on the right to add a new one.
        </div>
      </div>

      <!-- RIGHT: editor -->
      <div class="card">
        <div class="section-title">Add / Edit Dealership</div>

        <div class="field">
          <label for="mapsUrl">Google Maps link</label>
          <input id="mapsUrl" class="input" placeholder="Paste full Google Maps URL for this dealership">
          <div class="help-text">
            In Google Maps: search the store → Share → copy link → paste here → click “Parse link”.
          </div>
        </div>

        <div class="btn-row" style="justify-content:flex-start;margin-bottom:4px;">
          <button id="parseBtn" class="btn btn-secondary">Parse link</button>
        </div>

        <div class="row">
          <div class="field">
            <label for="name">Name</label>
            <input id="name" class="input" placeholder="Stouffville Hyundai">
          </div>
        </div>

        <div class="field">
          <label for="address">Address (line)</label>
          <input id="address" class="input" placeholder="67 Automall Blvd">
        </div>

        <div class="row">
          <div class="field">
            <label for="city">City</label>
            <input id="city" class="input" placeholder="Whitchurch-Stouffville">
          </div>
          <div class="field" style="max-width:92px;">
            <label for="province">Prov/State</label>
            <input id="province" class="input" placeholder="ON">
          </div>
          <div class="field" style="max-width:120px;">
            <label for="postal">Postal</label>
            <input id="postal" class="input" placeholder="L4A 0W7">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="phone">Phone</label>
            <input id="phone" class="input" placeholder="905-888-7777">
          </div>
          <div class="field">
            <label for="placeId">Place ID (optional)</label>
            <input id="placeId" class="input" placeholder="Only if you already have it">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="lat">Latitude</label>
            <input id="lat" class="input" placeholder="43.9495">
          </div>
          <div class="field">
            <label for="lng">Longitude</label>
            <input id="lng" class="input" placeholder="-79.2632">
          </div>
        </div>

        <div class="help-text">
          Lat / Lng and Name are auto-filled from the Google Maps URL when possible. You can tweak any field.
        </div>

        <div id="idDisplay" class="help-text" style="margin-top:6px;"></div>

        <div id="map" style="margin-top:10px;"></div>

        <div class="btn-row">
          <button id="newBtn" class="btn btn-secondary">New</button>
          <button id="deleteBtn" class="btn btn-danger">Delete</button>
          <button id="saveBtn" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      signInAnonymously,
      setPersistence,
      browserLocalPersistence,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getDatabase,
      ref,
      get,
      set,
      remove
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const toastEl = document.getElementById('toast');
    function showToast(msg, type=''){
      toastEl.textContent = msg;
      toastEl.className = 'toast show' + (type==='error' ? ' error' : '');
      setTimeout(()=>{ toastEl.classList.remove('show'); }, 2600);
    }

    // --- map ---
    let map = null;
    let marker = null;
    function initMap(){
      if(map) return;
      map = L.map('map').setView([43.7, -79.4], 9); // GTA default
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: ''
      }).addTo(map);

      marker = L.marker([43.7, -79.4], { draggable:true }).addTo(map);
      marker.on('dragend', ()=>{
        const pos = marker.getLatLng();
        latInput.value = pos.lat.toFixed(6);
        lngInput.value = pos.lng.toFixed(6);
      });

      map.on('click', (e)=>{
        marker.setLatLng(e.latlng);
        latInput.value = e.latlng.lat.toFixed(6);
        lngInput.value = e.latlng.lng.toFixed(6);
      });
    }

    function updateMapFromLatLng(){
      initMap();
      const lat = parseFloat(latInput.value);
      const lng = parseFloat(lngInput.value);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
      const pos = [lat, lng];
      map.setView(pos, 14);
      marker.setLatLng(pos);
    }

    // --- helpers ---
    function slugify(str){
      return (str || '')
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'')
        .substr(0,50);
    }

    function parseGoogleMapsUrl(url){
      try{
        const u = new URL(url);
        if (!/google\.[^/]*\/maps/.test(u.href)) return null;

        // name from /place/<name>/
        let name = '';
        const parts = u.pathname.split('/');
        const placeIndex = parts.indexOf('place');
        if(placeIndex >= 0 && parts.length > placeIndex+1){
          name = decodeURIComponent(parts[placeIndex+1].replace(/\+/g,' '));
        }

        // lat/lng from @lat,lng or from q= / ll=
        let lat = null, lng = null;

        const atMatch = u.href.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
        if(atMatch){
          lat = parseFloat(atMatch[1]);
          lng = parseFloat(atMatch[2]);
        } else if(u.searchParams.get('ll')){
          const ll = u.searchParams.get('ll').split(',');
          if(ll.length>=2){
            lat = parseFloat(ll[0]);
            lng = parseFloat(ll[1]);
          }
        } else if(u.searchParams.get('q')){
          const q = u.searchParams.get('q');
          const coordMatch = q.match(/(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/);
          if(coordMatch){
            lat = parseFloat(coordMatch[1]);
            lng = parseFloat(coordMatch[2]);
          }
        }

        return { name, lat, lng };
      }catch(e){
        return null;
      }
    }

    // --- DOM refs ---
    const listEl      = document.getElementById('dealerList');
    const listSearch  = document.getElementById('listSearch');
    const mapsUrl     = document.getElementById('mapsUrl');
    const nameInput   = document.getElementById('name');
    const addressInput= document.getElementById('address');
    const cityInput   = document.getElementById('city');
    const provinceInput=document.getElementById('province');
    const postalInput = document.getElementById('postal');
    const phoneInput  = document.getElementById('phone');
    const placeIdInput= document.getElementById('placeId');
    const latInput    = document.getElementById('lat');
    const lngInput    = document.getElementById('lng');
    const idDisplay   = document.getElementById('idDisplay');

    const parseBtn    = document.getElementById('parseBtn');
    const newBtn      = document.getElementById('newBtn');
    const saveBtn     = document.getElementById('saveBtn');
    const deleteBtn   = document.getElementById('deleteBtn');

    const mapOverlay  = document.getElementById('map');
    initMap(); // start immediately

    let currentId = null;
    let allDealersMap = {}; // id -> obj

    // --- load dealerships from DB ---
    async function loadDealerships(){
      const snap = await get(ref(db, 'dealershipPublic'));
      allDealersMap = {};
      if(!snap.exists()){
        listEl.innerHTML = '<div class="help-text" style="padding:4px 2px;">No dealerships yet. Add one on the right.</div>';
        return;
      }
      allDealersMap = snap.val() || {};
      renderDealerList();
    }

    function renderDealerList(){
      const q = (listSearch.value || '').toLowerCase().trim();
      listEl.innerHTML = '';

      const entries = Object.entries(allDealersMap).map(([id, v])=>({id, v}));

      entries.sort((a,b)=>{
        const an = (a.v.name || a.id).toLowerCase();
        const bn = (b.v.name || b.id).toLowerCase();
        return an.localeCompare(bn);
      });

      const filtered = entries.filter(({id, v})=>{
        if(!q) return true;
        const txt = [
          id,
          v.name,
          v.city,
          v.address,
          v.fullAddress,
          v.postal,
          v.province,
          v.phone
        ].filter(Boolean).join(' ').toLowerCase();
        return txt.includes(q);
      });

      if(!filtered.length){
        listEl.innerHTML = '<div class="help-text" style="padding:4px 2px;">No results.</div>';
        return;
      }

      filtered.forEach(({id, v})=>{
        const item = document.createElement('div');
        item.className = 'dealer-item' + (currentId === id ? ' active' : '');
        item.dataset.id = id;

        const name = v.name || id;
        const cityLine = [v.city, v.province].filter(Boolean).join(', ');
        const addr = v.address || v.fullAddress || '';

        item.innerHTML = `
          <div class="dealer-name">${name}</div>
          <div class="dealer-meta">${[addr, cityLine, v.postal].filter(Boolean).join(' • ')}</div>
          <div class="pill"><span class="key">ID</span><span class="value">${id}</span></div>
        `;
        item.addEventListener('click', ()=>loadFormForId(id));
        listEl.appendChild(item);
      });
    }

    function clearForm(){
      currentId = null;
      mapsUrl.value = '';
      nameInput.value = '';
      addressInput.value = '';
      cityInput.value = '';
      provinceInput.value = '';
      postalInput.value = '';
      phoneInput.value = '';
      placeIdInput.value = '';
      latInput.value = '';
      lngInput.value = '';
      idDisplay.textContent = 'New dealership (ID will be auto-generated from the name)';
      listEl.querySelectorAll('.dealer-item').forEach(el=>el.classList.remove('active'));
      map.setView([43.7,-79.4], 9);
      marker.setLatLng([43.7,-79.4]);
    }

    function loadFormForId(id){
      const v = allDealersMap[id];
      if(!v) return;
      currentId = id;
      mapsUrl.value = v.mapsUrl || '';
      nameInput.value = v.name || '';
      addressInput.value = v.address || v.fullAddress || '';
      cityInput.value = v.city || '';
      provinceInput.value = v.province || '';
      postalInput.value = v.postal || v.postalCode || '';
      phoneInput.value = v.phone || '';
      placeIdInput.value = v.placeId || '';
      latInput.value = (v.lat != null ? v.lat : '').toString();
      lngInput.value = (v.lng != null ? v.lng : '').toString();
      idDisplay.textContent = `Editing ID: ${id}`;
      renderDealerList();
      updateMapFromLatLng();
    }

    // parse Google Maps URL
    parseBtn.addEventListener('click', ()=>{
      const raw = mapsUrl.value.trim();
      if(!raw){
        showToast('Paste a Google Maps URL first','error');
        return;
      }
      const parsed = parseGoogleMapsUrl(raw);
      if(!parsed){
        showToast('Could not understand this URL. Make sure it is a Google Maps place link.','error');
        return;
      }
      if(parsed.name && !nameInput.value){
        nameInput.value = parsed.name;
      }
      if(parsed.lat != null){
        latInput.value = parsed.lat.toFixed(6);
      }
      if(parsed.lng != null){
        lngInput.value = parsed.lng.toFixed(6);
      }
      updateMapFromLatLng();
      showToast('Parsed link — check fields above.');
    });

    // map updates when lat/lng edited
    latInput.addEventListener('change', updateMapFromLatLng);
    lngInput.addEventListener('change', updateMapFromLatLng);

    // list filter
    listSearch.addEventListener('input', ()=>renderDealerList());

    newBtn.addEventListener('click', ()=>clearForm());

    deleteBtn.addEventListener('click', async ()=>{
      if(!currentId){
        showToast('No dealership selected to delete','error');
        return;
      }
      if(!confirm(`Delete dealership "${currentId}"?`)) return;
      await remove(ref(db, 'dealershipPublic/' + currentId));
      showToast('Deleted dealership');
      currentId = null;
      await loadDealerships();
      clearForm();
    });

    saveBtn.addEventListener('click', async ()=>{
      const name = nameInput.value.trim();
      if(!name){
        showToast('Name is required','error');
        return;
      }
      const id = currentId || slugify(name);
      if(!id){
        showToast('Could not generate ID','error');
        return;
      }

      const lat = latInput.value.trim();
      const lng = lngInput.value.trim();

      const payload = {
        name,
        address: addressInput.value.trim() || undefined,
        city: cityInput.value.trim() || undefined,
        province: provinceInput.value.trim() || undefined,
        postal: postalInput.value.trim() || undefined,
        phone: phoneInput.value.trim() || undefined,
        placeId: placeIdInput.value.trim() || undefined,
        mapsUrl: mapsUrl.value.trim() || undefined,
      };

      if(lat && lng && !Number.isNaN(parseFloat(lat)) && !Number.isNaN(parseFloat(lng))){
        payload.lat = parseFloat(lat);
        payload.lng = parseFloat(lng);
      }

      await set(ref(db, 'dealershipPublic/' + id), payload);
      currentId = id;
      showToast('Saved dealership');

      await loadDealerships();
      loadFormForId(id);
    });

    // auth then load data
    (async ()=>{
      try{
        await setPersistence(auth, browserLocalPersistence);
        await signInAnonymously(auth);
      }catch(e){
        console.error(e);
        showToast('Anonymous auth failed — check rules', 'error');
      }finally{
        initMap();
        loadDealerships();
      }
    })();
  </script>
</body>
</html>
