<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>BFA IPTV — Dealership Admin</title>

  <!-- Leaflet (free / no key) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin="">
  </script>

  <style>
    :root {
      /* Light, similar to your other clean IPTV pages */
      --bg:#f5f5f7;
      --fg:#111827;
      --muted:#6b7280;
      --panel:#ffffff;
      --border:rgba(15,23,42,.08);
      --accent:#ff9500;
      --shadow:0 18px 48px rgba(15,23,42,.09);
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;
      min-height:100vh;
    }

    .shell{
      max-width:1100px;
      margin:24px auto 32px;
      padding:0 16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    @media (min-width:900px){
      .layout{
        display:grid;
        grid-template-columns: minmax(0, 0.4fr) minmax(0, 0.6fr);
        gap:16px;
        align-items:flex-start;
      }
    }

    .card{
      background:var(--panel);
      border-radius:24px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
    }

    h1{
      font-size:22px;
      font-weight:800;
      margin:0 0 4px;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
    }
    .section-title{
      font-size:13px;
      font-weight:600;
      margin-bottom:8px;
    }

    .dealer-list{
      max-height:420px;
      overflow:auto;
      margin-top:4px;
      border-radius:16px;
      border:1px solid var(--border);
      padding:6px 8px;
      background:#f9fafb;
    }
    .dealer-item{
      padding:8px 8px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:2px;
      transition:background .15s, box-shadow .15s;
    }
    .dealer-item + .dealer-item{
      margin-top:4px;
    }
    .dealer-item:hover{
      background:#f3f4ff;
    }
    .dealer-item.active{
      background:#fffbeb;
      box-shadow:0 0 0 1px rgba(245,158,11,.45);
    }
    .dealer-name{
      font-size:13px;
      font-weight:600;
    }
    .dealer-meta{
      font-size:11px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }
    .pill span.key{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.8px;
      opacity:.7;
    }
    .pill span.value{
      font-family:monospace;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin:6px 0;
    }
    label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.8px;
    }
    .input, .textarea{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:var(--fg);
      font-size:13px;
      outline:none;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    .textarea{
      min-height:48px;
      resize:vertical;
    }
    .input::placeholder, .textarea::placeholder{
      color:rgba(156,163,175,.9);
    }
    .input:focus, .textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(245,158,11,.35);
      background:#ffffff;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .row > .field{
      flex:1;
      margin:0;
      min-width:0;
    }
    .btn-row{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .btn{
      padding:9px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
    }
    .btn-secondary{
      background:#ffffff;
      color:var(--muted);
      border:1px solid var(--border);
    }
    .btn-secondary:hover{
      background:#f3f4f6;
    }
    .btn-primary{
      background:var(--accent);
      color:#000;
    }
    .btn-primary:hover{
      filter:brightness(1.05);
    }
    .btn-danger{
      background:#ef4444;
      color:#fff;
    }
    .btn-danger:hover{
      filter:brightness(1.05);
    }
    #map{
      width:100%;
      height:320px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
      margin-top:10px;
    }
    @media (min-width:1100px){
      #map{height:360px;}
    }
    .help-text{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:var(--accent);
      color:#000;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      opacity:0;
      transition:opacity .25s;
      pointer-events:none;
      max-width:90vw;
      text-align:center;
      z-index:9999;
    }
    .toast.show{opacity:1}
    .toast.error{background:#ef4444;color:#fff;}

    .login-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:4px;
    }
    .login-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .login-meta{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }
  </style>
</head>
<body>
  <div class="shell">

    <!-- LOGIN VIEW -->
    <div id="loginView" class="card">
      <div class="login-title">Admin sign in</div>
      <div class="login-sub">
        Only BFA admin accounts can manage dealerships.  
        Use the same email/password you already use for the IPTV admin.
      </div>

      <div class="field">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" class="input" type="email" placeholder="admin@yourdomain.com" autocomplete="email">
      </div>

      <div class="field">
        <label for="loginPassword">Password</label>
        <input id="loginPassword" class="input" type="password" placeholder="Password" autocomplete="current-password">
      </div>

      <div class="btn-row" style="justify-content:flex-start">
        <button id="loginBtn" class="btn btn-primary">Sign in</button>
      </div>

      <div class="login-meta" id="loginStatus"></div>
    </div>

    <!-- ADMIN VIEW -->
    <div id="adminView" style="display:none; width:100%; display:flex; flex-direction:column; gap:16px;">
      <div>
        <h1>Dealership Manager</h1>
        <div class="subtitle" id="adminSubtitle">
          Loading…
        </div>
      </div>

      <div class="layout">
        <!-- LEFT: list -->
        <div class="card">
          <div class="section-title">Existing Dealerships</div>
          <div class="field">
            <input id="listSearch" class="input" placeholder="Filter by name / city / postal">
          </div>
          <div id="dealerList" class="dealer-list"></div>
          <div class="help-text">
            Click a dealership to edit it, or use the form on the right to add a new one.
          </div>
        </div>

        <!-- RIGHT: editor -->
        <div class="card">
          <div class="section-title">Add / Edit Dealership</div>

          <div class="field">
            <label for="mapsUrl">Google Maps link</label>
            <input id="mapsUrl" class="input" placeholder="Paste full Google Maps URL for this dealership">
            <div class="help-text">
              If you have a short link like <code>https://share.google/...</code>, open it first in a new tab,
              let Maps load, then copy the long URL from the browser address bar (it will start with
              <code>https://www.google.com/maps/...</code>).
            </div>
          </div>

          <div class="btn-row" style="justify-content:flex-start;margin-bottom:4px;">
            <button id="parseBtn" class="btn btn-secondary">Parse link</button>
          </div>

          <div class="row">
            <div class="field">
              <label for="name">Name</label>
              <input id="name" class="input" placeholder="Stouffville Hyundai">
            </div>
          </div>

          <div class="field">
            <label for="address">Address (line)</label>
            <input id="address" class="input" placeholder="67 Automall Blvd">
          </div>

          <div class="row">
            <div class="field">
              <label for="city">City</label>
              <input id="city" class="input" placeholder="Whitchurch-Stouffville">
            </div>
            <div class="field" style="max-width:92px;">
              <label for="province">Prov/State</label>
              <input id="province" class="input" placeholder="ON">
            </div>
            <div class="field" style="max-width:120px;">
              <label for="postal">Postal</label>
              <input id="postal" class="input" placeholder="L4A 0W7">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="phone">Phone</label>
              <input id="phone" class="input" placeholder="905-888-7777">
            </div>
            <div class="field">
              <label for="placeId">Place ID (optional)</label>
              <input id="placeId" class="input" placeholder="If you already have it">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="lat">Latitude</label>
              <input id="lat" class="input" placeholder="43.9495">
            </div>
            <div class="field">
              <label for="lng">Longitude</label>
              <input id="lng" class="input" placeholder="-79.2632">
            </div>
          </div>

          <div class="help-text">
            We auto-fill <strong>name + coordinates</strong> from the Maps URL when possible.
            Address / city / postal can be pasted from Maps if needed.
          </div>

          <div id="idDisplay" class="help-text" style="margin-top:6px;"></div>

          <div id="map"></div>

          <div class="btn-row">
            <button id="newBtn" class="btn btn-secondary">New</button>
            <button id="deleteBtn" class="btn btn-danger">Delete</button>
            <button id="saveBtn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      setPersistence,
      browserLocalPersistence,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getDatabase,
      ref,
      get,
      set,
      remove
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // -------- small helper: remove undefined before sending to Firebase ------
    function stripUndefined(obj) {
      Object.keys(obj).forEach((key) => {
        if (obj[key] === undefined) delete obj[key];
      });
      return obj;
    }

    const toastEl       = document.getElementById('toast');
    const loginView     = document.getElementById('loginView');
    const adminView     = document.getElementById('adminView');
    const loginEmail    = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn      = document.getElementById('loginBtn');
    const loginStatus   = document.getElementById('loginStatus');
    const adminSubtitle = document.getElementById('adminSubtitle');

    function showToast(msg, type=''){
      toastEl.textContent = msg;
      toastEl.className = 'toast show' + (type==='error' ? ' error' : '');
      setTimeout(()=>{ toastEl.classList.remove('show'); }, 2600);
    }

    // --- map ---
    let map = null;
    let marker = null;
    function initMap(){
      if(map) return;
      map = L.map('map').setView([43.7, -79.4], 9); // GTA default
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: ''
      }).addTo(map);

      marker = L.marker([43.7, -79.4], { draggable:true }).addTo(map);
      marker.on('dragend', ()=>{
        const pos = marker.getLatLng();
        latInput.value = pos.lat.toFixed(6);
        lngInput.value = pos.lng.toFixed(6);
      });

      map.on('click', (e)=>{
        marker.setLatLng(e.latlng);
        latInput.value = e.latlng.lat.toFixed(6);
        lngInput.value = e.latlng.lng.toFixed(6);
      });
    }

    function updateMapFromLatLng(){
      initMap();
      const lat = parseFloat(latInput.value);
      const lng = parseFloat(lngInput.value);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
      const pos = [lat, lng];
      map.setView(pos, 14);
      marker.setLatLng(pos);
    }

    // --- helpers ---
    function slugify(str){
      return (str || '')
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'')
        .substr(0,50);
    }

    function parseGoogleMapsUrl(url){
      try{
        const u = new URL(url);

        let name = '';

        // From /place/<name>/
        const parts = u.pathname.split('/');
        const placeIndex = parts.indexOf('place');
        if(placeIndex >= 0 && parts.length > placeIndex+1){
          name = decodeURIComponent(parts[placeIndex+1].replace(/\+/g,' '));
        }

        // lat/lng from @lat,lng or from ll= or q=lat,lng
        let lat = null, lng = null;

        const atMatch = u.href.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
        if(atMatch){
          lat = parseFloat(atMatch[1]);
          lng = parseFloat(atMatch[2]);
        } else if(u.searchParams.get('ll')){
          const ll = u.searchParams.get('ll').split(',');
          if(ll.length>=2){
            lat = parseFloat(ll[0]);
            lng = parseFloat(ll[1]);
          }
        } else if(u.searchParams.get('q')){
          const qVal = u.searchParams.get('q');
          const coordMatch = qVal.match(/(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/);
          if(coordMatch){
            lat = parseFloat(coordMatch[1]);
            lng = parseFloat(coordMatch[2]);
          }
          if(!name){
            name = decodeURIComponent(qVal.replace(/\+/g,' '));
          }
        }

        // best-effort address guess from q= if it's not coordinates
        let addressGuess = '';
        const qRaw = u.searchParams.get('q');
        if(qRaw){
          const decodedQ = decodeURIComponent(qRaw.replace(/\+/g,' '));
          const looksLikeCoords = /-?\d+\.?\d*,\s*-?\d+\.?\d*/.test(decodedQ);
          if(!looksLikeCoords){
            addressGuess = decodedQ;
          }
        }

        if(!name && !lat && !lng && !addressGuess){
          return null;
        }
        return { name, lat, lng, addressGuess };
      }catch(e){
        return null;
      }
    }

    // --- DOM refs for admin UI ---
    const listEl      = document.getElementById('dealerList');
    const listSearch  = document.getElementById('listSearch');
    const mapsUrl     = document.getElementById('mapsUrl');
    const nameInput   = document.getElementById('name');
    const addressInput= document.getElementById('address');
    const cityInput   = document.getElementById('city');
    const provinceInput=document.getElementById('province');
    const postalInput = document.getElementById('postal');
    const phoneInput  = document.getElementById('phone');
    const placeIdInput= document.getElementById('placeId');
    const latInput    = document.getElementById('lat');
    const lngInput    = document.getElementById('lng');
    const idDisplay   = document.getElementById('idDisplay');

    const parseBtn    = document.getElementById('parseBtn');
    const newBtn      = document.getElementById('newBtn');
    const saveBtn     = document.getElementById('saveBtn');
    const deleteBtn   = document.getElementById('deleteBtn');

    let currentId = null;
    let allDealersMap = {}; // id -> obj

    // --- load dealerships from DB (only after admin check) ---
    async function loadDealerships(){
      try{
        const snap = await get(ref(db, 'dealershipPublic'));
        allDealersMap = {};
        if(!snap.exists()){
          listEl.innerHTML = '<div class="help-text" style="padding:4px 2px;">No dealerships yet. Add one on the right.</div>';
          idDisplay.textContent = 'New dealership (ID will be auto-generated from the name)';
          return;
        }
        allDealersMap = snap.val() || {};
        renderDealerList();
        idDisplay.textContent = currentId
          ? 'Editing ID: ' + currentId
          : 'New dealership (ID will be auto-generated from the name)';
      }catch(e){
        console.error(e);
        showToast('Failed to load dealerships: ' + (e.code || e.message),'error');
      }
    }

    function renderDealerList(){
      const q = (listSearch.value || '').toLowerCase().trim();
      listEl.innerHTML = '';

      const entries = Object.entries(allDealersMap).map(([id, v])=>({id, v}));

      entries.sort((a,b)=>{
        const an = (a.v.name || a.id).toLowerCase();
        const bn = (b.v.name || b.id).toLowerCase();
        return an.localeCompare(bn);
      });

      const filtered = entries.filter(({id, v})=>{
        if(!q) return true;
        const txt = [
          id,
          v.name,
          v.city,
          v.address,
          v.fullAddress,
          v.postal,
          v.province,
          v.phone
        ].filter(Boolean).join(' ').toLowerCase();
        return txt.includes(q);
      });

      if(!filtered.length){
        listEl.innerHTML = '<div class="help-text" style="padding:4px 2px;">No results.</div>';
        return;
      }

      filtered.forEach(({id, v})=>{
        const item = document.createElement('div');
        item.className = 'dealer-item' + (currentId === id ? ' active' : '');
        item.dataset.id = id;

        const name = v.name || id;
        const cityLine = [v.city, v.province].filter(Boolean).join(', ');
        const addr = v.address || v.fullAddress || '';

        item.innerHTML = `
          <div class="dealer-name">${name}</div>
          <div class="dealer-meta">${[addr, cityLine, v.postal].filter(Boolean).join(' • ')}</div>
          <div class="pill"><span class="key">ID</span><span class="value">${id}</span></div>
        `;
        item.addEventListener('click', ()=>loadFormForId(id));
        listEl.appendChild(item);
      });
    }

    function clearForm(){
      currentId = null;
      mapsUrl.value = '';
      nameInput.value = '';
      addressInput.value = '';
      cityInput.value = '';
      provinceInput.value = '';
      postalInput.value = '';
      phoneInput.value = '';
      placeIdInput.value = '';
      latInput.value = '';
      lngInput.value = '';
      idDisplay.textContent = 'New dealership (ID will be auto-generated from the name)';
      if(map && marker){
        map.setView([43.7,-79.4], 9);
        marker.setLatLng([43.7,-79.4]);
      }
      listEl.querySelectorAll('.dealer-item').forEach(el=>el.classList.remove('active'));
    }

    function loadFormForId(id){
      const v = allDealersMap[id];
      if(!v) return;
      currentId = id;
      mapsUrl.value = v.mapsUrl || '';
      nameInput.value = v.name || '';
      addressInput.value = v.address || v.fullAddress || '';
      cityInput.value = v.city || '';
      provinceInput.value = v.province || '';
      postalInput.value = v.postal || v.postalCode || '';
      phoneInput.value = v.phone || '';
      placeIdInput.value = v.placeId || '';
      latInput.value = (v.lat != null ? v.lat : '').toString();
      lngInput.value = (v.lng != null ? v.lng : '').toString();
      idDisplay.textContent = `Editing ID: ${id}`;
      renderDealerList();
      updateMapFromLatLng();
    }

    // parse Google Maps URL
    parseBtn.addEventListener('click', ()=>{
      const raw = mapsUrl.value.trim();
      if(!raw){
        showToast('Paste a Google Maps URL first','error');
        return;
      }
      const parsed = parseGoogleMapsUrl(raw);
      if(!parsed){
        showToast('Could not understand this URL. Open the short link first and paste the long Maps URL.', 'error');
        return;
      }
      if(parsed.name && !nameInput.value){
        nameInput.value = parsed.name;
      }
      if(parsed.addressGuess && !addressInput.value){
        addressInput.value = parsed.addressGuess;
      }
      if(parsed.lat != null){
        latInput.value = parsed.lat.toFixed(6);
      }
      if(parsed.lng != null){
        lngInput.value = parsed.lng.toFixed(6);
      }
      updateMapFromLatLng();
      showToast('Parsed link — name / position filled. Address may still need manual tweak.');
    });

    // map updates when lat/lng edited
    latInput.addEventListener('change', updateMapFromLatLng);
    lngInput.addEventListener('change', updateMapFromLatLng);

    // list filter
    listSearch.addEventListener('input', ()=>renderDealerList());

    newBtn.addEventListener('click', ()=>clearForm());

    deleteBtn.addEventListener('click', async ()=>{
      if(!currentId){
        showToast('No dealership selected to delete','error');
        return;
      }
      if(!confirm(`Delete dealership "${currentId}"?`)) return;
      try{
        await remove(ref(db, 'dealershipPublic/' + currentId));
        showToast('Deleted dealership');
        currentId = null;
        await loadDealerships();
        clearForm();
      }catch(e){
        console.error(e);
        showToast('Delete failed: ' + (e.code || e.message),'error');
      }
    });

    saveBtn.addEventListener('click', async ()=>{
      const name = nameInput.value.trim();
      if(!name){
        showToast('Name is required','error');
        return;
      }
      const id = currentId || slugify(name);
      if(!id){
        showToast('Could not generate ID','error');
        return;
      }

      const lat = latInput.value.trim();
      const lng = lngInput.value.trim();

      let payload = {
        name,
        address: addressInput.value.trim() || undefined,
        city: cityInput.value.trim() || undefined,
        province: provinceInput.value.trim() || undefined,
        postal: postalInput.value.trim() || undefined,
        phone: phoneInput.value.trim() || undefined,
        placeId: placeIdInput.value.trim() || undefined,
        mapsUrl: mapsUrl.value.trim() || undefined,
      };

      if (
        lat && lng &&
        !Number.isNaN(parseFloat(lat)) &&
        !Number.isNaN(parseFloat(lng))
      ) {
        payload.lat = parseFloat(lat);
        payload.lng = parseFloat(lng);
      }

      // remove any undefined fields (fixes the error you saw)
      payload = stripUndefined(payload);

      try{
        await set(ref(db, 'dealershipPublic/' + id), payload);
        currentId = id;
        showToast('Saved dealership');
        await loadDealerships();
        loadFormForId(id);
      }catch(e){
        console.error(e);
        showToast('Save failed: ' + (e.code || e.message),'error');
      }
    });

    // --- ADMIN AUTH FLOW ---

    async function doLogin(){
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      if(!email || !password){
        loginStatus.textContent = 'Enter email and password.';
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in…';
      loginStatus.textContent = '';
      try{
        await setPersistence(auth, browserLocalPersistence);
        await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged will handle the rest
      }catch(e){
        console.error(e);
        loginStatus.textContent = 'Login failed: ' + (e.code || e.message);
      }finally{
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign in';
      }
    }

    loginBtn.addEventListener('click', doLogin);
    loginPassword.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') doLogin();
    });
    loginEmail.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') doLogin();
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        // not logged in
        loginView.style.display = 'block';
        adminView.style.display = 'none';
        loginStatus.textContent = '';
        return;
      }

      try{
        const profileSnap = await get(ref(db, 'user/' + user.uid));
        const profile = profileSnap.exists() ? profileSnap.val() : {};
        const role = profile.role || 'user';

        if(role === 'admin'){
          loginView.style.display = 'none';
          adminView.style.display = 'flex';
          adminSubtitle.textContent = `Signed in as ${user.email || 'admin'} · role: admin`;
          initMap();
          loadDealerships();
        }else{
          loginView.style.display = 'block';
          adminView.style.display = 'none';
          loginStatus.textContent = `You are signed in as ${user.email || 'user'}, but your role is "${role}". This page is restricted to admin accounts.`;
          await signOut(auth);
        }
      }catch(e){
        console.error(e);
        loginView.style.display = 'block';
        adminView.style.display = 'none';
        loginStatus.textContent = 'Could not verify admin role: ' + (e.code || e.message);
      }
    });

  </script>
</body>
</html>
