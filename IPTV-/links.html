<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
<title>BFA IPTV â€” Links</title>

<link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
<meta name="theme-color" content="#ffffff"/>
<link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
<link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

<style>
  :root{
    --accent:#ff9500;
    --bg-start:#fff4e4; --bg-mid:#ffd293; --bg-end:#ff9500;
    --fg:#111; --muted:#6e6e73;
    --panel:rgba(255,255,255,.58); --tile:rgba(255,255,255,.46); --tileHover:rgba(255,149,0,.08);
    --border:rgba(15,23,42,.10); --borderStrong:rgba(15,23,42,.18);
    --shadow:0 14px 34px rgba(15,23,42,.08), 0 2px 8px rgba(15,23,42,.05);
    --glass-blur:16px; --glass-sat:140%;
  }
  body.dark{
    --bg-start:#0b0b0c; --bg-mid:#0d1016; --bg-end:#10141b;
    --fg:#f7f7f8; --muted:#a1a1a8;
    --panel:rgba(21,21,23,.56); --tile:rgba(26,26,29,.50); --tileHover:rgba(255,149,0,.10);
    --border:rgba(255,255,255,.10); --borderStrong:rgba(255,255,255,.20);
    --shadow:0 18px 46px rgba(0,0,0,.36), 0 2px 8px rgba(0,0,0,.22);
    --glass-blur:14px;
  }
  *{box-sizing:border-box}
  html,body{min-height:100%}
  body{
    margin:0;color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;background:transparent;
  }
  body::before{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;background:linear-gradient(180deg,var(--bg-start) 0%, var(--bg-mid) 52%, var(--bg-end) 100%);}
  a{color:inherit;text-decoration:none}

  .topbar{position:sticky;top:0;z-index:200;background:var(--panel);border-bottom:1px solid var(--border);
    padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px;backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));}
  .toprow{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px;position:relative}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:#fff center/cover no-repeat}
  .logotxt{font-weight:900;letter-spacing:.2px}
  .nav{display:flex;gap:10px;margin-left:auto;margin-right:auto}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:9999px;border:1px solid transparent;background:transparent;color:inherit;font-weight:800;font-size:14px;white-space:nowrap;transition:border-color .18s ease, filter .18s ease}
  .pill:hover{border-color:var(--accent);filter:brightness(1.04)}
  .pill.is-active{outline:2px solid var(--accent)}
  .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}
  .more{position:relative}
  #moreBtn .plus{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
  #moreMenu{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;min-width:230px;background:var(--panel);
    border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none;
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));}
  #moreMenu.open{display:block}
  #moreMenu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px}
  #moreMenu a:hover{background:var(--tileHover)}
  #moreMenu a.is-active{outline:2px solid var(--accent)}
  #moreMenu .ic{width:18px;height:18px;stroke-width:1.9}

  .actions{display:flex;gap:8px;align-items:center}
  .email{max-width:240px;padding:6px 10px;border-radius:9999px;background:var(--tile);
    border:1.5px solid var(--borderStrong);color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));}
  .chip{height:34px;min-width:34px;padding:0 12px;border-radius:9999px;border:1.5px solid var(--borderStrong);
    background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
    transition:transform .12s ease, filter .18s ease, border-color .18s ease;
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));}
  .chip:hover{border-color:var(--accent);transform:translateY(-1px);filter:brightness(1.03)}
  .chip .ic{width:18px;height:18px;stroke-width:2}
  #hamburger{display:none;border:0;background:transparent;color:var(--accent);height:42px;min-width:42px;padding:0;align-items:center;justify-content:center;position:absolute;right:0;top:50%;transform:translateY(-50%)}
  #hamburger .ic{width:22px;height:22px;stroke:var(--accent);stroke-width:2.35}
  @media (max-width:920px){ .nav{display:none} #hamburger{display:inline-flex} .email{display:none} }

  /* SHEET OUTSIDE HEADER, HIGH Z-INDEX */
  #sheet{position:fixed;inset:0;z-index:1200;display:none}
  #sheet.open{display:block}
  #sheet .back{position:absolute;inset:0;background:rgba(0,0,0,.28)}
  .panel{position:absolute;right:0;top:0;height:100%;width:min(86vw,360px);background:var(--panel);border-left:1px solid var(--border);
    box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:14px;
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));}
  .panel .row{display:flex;align-items:center;justify-content:space-between}
  .panel nav{display:grid;gap:8px}
  .panel nav a{justify-content:flex-start}

  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow);
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));}
  .muted{color:var(--muted);font-size:12px}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .input{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none;
    backdrop-filter:blur(calc(var(--glass-blur) - 6px)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(calc(var(--glass-blur) - 6px)) saturate(var(--glass-sat));}
  .btn{height:34px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center;
    transition:transform .1s ease, border-color .2s ease, box-shadow .2s ease, filter .18s ease;
    backdrop-filter:blur(calc(var(--glass-blur) - 4px)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(calc(var(--glass-blur) - 4px)) saturate(var(--glass-sat));}
  .btn:hover{transform:translateY(-1px);border-color:var(--accent);box-shadow:0 8px 22px rgba(255,149,0,.15);filter:brightness(1.02)}
  .btn.solid{background:var(--accent);border-color:var(--accent);color:#000}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;margin:10px 0}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
  .row3{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin:10px 0}
  @media (max-width:720px){.row,.row2,.row3{grid-template-columns:1fr}}

  .apps-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
  @media (max-width:1060px){.apps-grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.apps-grid{grid-template-columns:1fr}}
  .app-tile{display:flex;gap:12px;align-items:center;padding:12px;border:1px solid var(--border);border-radius:16px;background:var(--tile);text-decoration:none;color:inherit;
    transition:transform .1s, box-shadow .2s, border-color .2s, filter .18s;
    box-shadow:0 6px 18px rgba(15,23,42,.06);backdrop-filter:blur(calc(var(--glass-blur) - 4px)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(calc(var(--glass-blur) - 4px)) saturate(var(--glass-sat));}
  .app-tile:hover{transform:translateY(-1px);border-color:var(--accent);box-shadow:0 12px 26px rgba(255,149,0,.20);filter:brightness(1.02)}
  .app-emoji,.app-logo{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:var(--tileHover) center/cover no-repeat;display:grid;place-items:center;font-size:20px}
  .app-info{display:flex;flex-direction:column;gap:2px}
  .app-title{font-weight:800}
  .app-desc{font-size:12px;color:var(--muted)}

  a:focus-visible,button:focus-visible,input:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

  .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:2000;box-shadow:0 10px 26px rgba(0,0,0,.18);
    backdrop-filter:blur(calc(var(--glass-blur) - 6px)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(calc(var(--glass-blur) - 6px)) saturate(var(--glass-sat));}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <!-- ===== NAVBAR ===== -->
  <header class="topbar">
    <div class="toprow">
      <a class="brand" href="home.html"><span class="logo" id="brandLogo"></span><span class="logotxt">BFA IPTV</span></a>

      <nav class="nav" aria-label="Primary">
        <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
        <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
        <a class="pill" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
        <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
        <div class="more">
          <a id="moreBtn" class="pill" href="javascript:void(0)"><svg class="plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg> More</a>
          <div id="moreMenu" role="menu" aria-label="More">
            <a class="is-active" href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
            <a href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
            <a href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
            <a href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
            <a href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
            <a href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
          </div>
        </div>
      </nav>

      <div class="actions">
        <span id="adminEmail" class="email"></span>
        <button id="themeBtn" class="chip" title="Light/Dark"><svg id="themeIcon" class="ic" viewBox="0 0 24 24"></svg>Theme</button>
        <button id="signOutBtn" class="chip">Sign out</button>
        <button id="hamburger" class="chip" aria-label="Menu"><svg class="ic" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg></button>
      </div>
    </div>
  </header>

  <!-- Mobile sheet OUTSIDE header -->
  <div id="sheet" aria-hidden="true">
    <div class="back"></div>
    <aside class="panel" role="dialog" aria-modal="true" aria-label="Menu">
      <div class="row">
        <div class="brand"><span class="logo" id="brandLogoM"></span><span class="logotxt">BFA IPTV</span></div>
        <button id="closeSheet" class="chip" aria-label="Close"><svg class="ic" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
      </div>
      <nav>
        <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
        <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
        <a class="pill" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
        <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
        <div class="muted" style="padding:8px 2px 0">More</div>
        <a class="pill is-active" href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
        <a class="pill" href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
        <a class="pill" href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
        <a class="pill" href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
        <a class="pill" href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
        <a class="pill" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
        <button id="signOutBtnM" class="chip" style="margin-top:8px">Sign out</button>
      </nav>
    </aside>
  </div>

  <!-- ===================================================== -->
  <div class="wrap">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <h2 style="margin:0">Apps / Quick Links</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="syncBtn" class="btn">Sync â†’ GitHub</button>
          <button id="settingsBtn" class="btn">Settings</button>
        </div>
      </div>

      <div class="row3">
        <div><div class="label">Title</div><input id="qlTitle" class="input" placeholder="e.g., Firebase â€” Database"/></div>
        <div><div class="label">URL</div><input id="qlHref" class="input" placeholder="https://..."/></div>
        <div style="display:flex;align-items:end"><button id="qlAddBtn" class="btn solid" style="width:100%">Add Link</button></div>
      </div>
      <div class="row2">
        <div><div class="label">Emoji (optional)</div><input id="qlEmoji" class="input" placeholder="ðŸ”¥ âœ… ðŸ“ â€¦"/></div>
        <div><div class="label">Logo image URL (optional)</div><input id="qlImg" class="input" placeholder="https://.../logo.png"/></div>
      </div>
      <div class="row">
        <div><div class="label">Description (optional)</div><input id="qlDesc" class="input" placeholder="Short label under the title"/></div>
        <div style="display:flex;align-items:end"><button id="qlResetBtn" class="btn" style="width:100%">Reset to defaults</button></div>
      </div>

      <div id="appsGrid" class="apps-grid"></div>
      <div class="muted" id="qlStorageNote">Loadingâ€¦</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <dialog id="settingsDlg" style="border:0;padding:0;border-radius:18px;max-width:720px;width:96vw">
    <form method="dialog" class="card" style="margin:0">
      <h2>Settings</h2>
      <div class="row2">
        <div><div class="label">GitHub Owner</div><input id="ghOwner" class="input" placeholder="org-or-user"/></div>
        <div><div class="label">Repo</div><input id="ghRepo" class="input" placeholder="repo"/></div>
      </div>
      <div class="row3">
        <div><div class="label">Branch</div><input id="ghBranch" class="input" placeholder="main"/></div>
        <div><div class="label">Path</div><input id="ghPath" class="input" placeholder="config/iptv-config.json"/></div>
        <div><div class="label">Token</div><input id="ghToken" class="input" type="password" placeholder="fine-grained token (contents:write)"/></div>
      </div>
      <div class="row2">
        <button class="btn" value="cancel">Close</button>
        <button id="saveSettingsBtn" class="btn solid" value="default">Save</button>
      </div>
    </form>
  </dialog>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getDatabase, ref, get, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};
  const LOGO_URL="/IPTV-/icons/icon-512.png";
  const CONFIG_URL='/IPTV-/config/iptv-config.json';

  let appConfig=null;
  try{ appConfig = await fetch(CONFIG_URL,{cache:'no-store'}).then(r=>r.ok?r.json():null).catch(()=>null);}catch{appConfig=null;}

  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getDatabase(app);

  const $=s=>document.querySelector(s);
  const toast=(m)=>{const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200);};

  // Logos
  $('#brandLogo').style.backgroundImage=`url("${LOGO_URL}")`;
  const brandLogoM=$('#brandLogoM'); if(brandLogoM){ brandLogoM.style.backgroundImage=`url("${LOGO_URL}")`; }

  // Theme
  const THEME_KEY='iptv_theme';
  const themeBtn=$('#themeBtn'), themeIcon=$('#themeIcon');
  const setThemeIcon=()=>{ const dark=document.body.classList.contains('dark'); themeIcon.innerHTML = dark? `<path d="M21 12a9 9 0 1 1-9-9 6 6 0 0 0 9 9z"/>` : `<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M5 19l-1.4 1.4M20.4 3.6 19 5"/>`; };
  const saved=localStorage.getItem(THEME_KEY)||'light';
  document.body.classList.toggle('dark', saved==='dark'); setThemeIcon();
  themeBtn.addEventListener('click',()=>{ const toDark=!document.body.classList.contains('dark'); document.body.classList.toggle('dark',toDark); localStorage.setItem(THEME_KEY,toDark?'dark':'light'); setThemeIcon(); });

  // More dropdown
  const moreBtn=$('#moreBtn'), moreMenu=$('#moreMenu');
  if(moreBtn){
    moreBtn.addEventListener('click',e=>{e.preventDefault(); moreMenu.classList.toggle('open');});
    document.addEventListener('click',(e)=>{ if(!moreMenu.contains(e.target)&&e.target!==moreBtn&&!moreBtn.contains(e.target)) moreMenu.classList.remove('open'); },{capture:true});
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') moreMenu.classList.remove('open'); });
    const file=(location.pathname.split("/").pop()||"links.html").toLowerCase();
    moreMenu.querySelectorAll('a').forEach(a=>{ const h=(a.getAttribute('href')||'').toLowerCase(); if(h===file) a.classList.add('is-active'); });
  }

  // Mobile sheet (outside header)
  (()=>{
    const sheet=$('#sheet'); const open=()=>{sheet.classList.add('open'); document.body.style.overflow='hidden';};
    const close=()=>{sheet.classList.remove('open'); document.body.style.overflow='';};
    $('#hamburger').addEventListener('click', open); $('#closeSheet').addEventListener('click', close); sheet.querySelector('.back').addEventListener('click', close);
    const mainOut=$('#signOutBtn'), mobOut=$('#signOutBtnM'); if(mainOut&&mobOut){ mobOut.addEventListener('click',()=> mainOut.click()); }
  })();

  // Auth
  $('#signOutBtn').addEventListener('click',()=>signOut(auth));
  setPersistence(auth,browserLocalPersistence);
  onAuthStateChanged(auth,u=>{
    if(!u){ location.href='./home.html'; return; }
    $('#adminEmail').textContent=u.email||u.uid;
  });

  /* ===== Quick Links (Realtime DB â†”ï¸Ž GitHub â†”ï¸Ž Local) ===== */
  const LINKS_DB_PATH='admin/quickLinks';
  const DEFAULT_LINKS=[
    {emoji:'ðŸ”¥',title:'Firebase â€” Overview',href:'https://console.firebase.google.com/project/iptv-bfa/overview',desc:'Console home'},
    {emoji:'ðŸ‘¤',title:'Firebase â€” Auth',href:'https://console.firebase.google.com/project/iptv-bfa/authentication/users',desc:'Users & providers'},
    {emoji:'ðŸ™',title:'GitHub Repo',href:'https://github.com/flaviothebfagroup/IPTV-',desc:'Source code'},
    {emoji:'ðŸŒ',title:'GitHub Pages (Remote)',href:'https://flaviothebfagroup.github.io/IPTV-/remote-control.html',desc:'Open remote'},
    {emoji:'ðŸ“§',title:'Gmail',href:'https://mail.google.com/mail/u/0/#inbox',desc:'Primary inbox'},
    {emoji:'ðŸ“§',title:'Outlook',href:'https://outlook.office.com/mail/',desc:'Office 365 inbox'},
    {emoji:'âœ…',title:'Trello â€” Digital Team',href:'https://trello.com/b/jHjTIrZG/digital-team',desc:'Board'},
    {emoji:'ðŸŽ›ï¸',title:'BSN.cloud',href:'https://app.bsn.cloud/#/dashboard',desc:'BrightSign dashboard'},
    {emoji:'ðŸ–¥ï¸',title:'Signagelive',href:'https://login.signagelive.com/',desc:'CMS login'},
    {emoji:'ðŸ“',title:'Google Drive',href:'https://drive.google.com/drive/u/0/',desc:'My Drive'}
  ];
  const LS_LOCAL='admin_quick_links';

  let quickLinks=[], source='db', unsubscribe=null;

  const note=$('#qlStorageNote');

  function useLocal(){
    quickLinks = JSON.parse(localStorage.getItem(LS_LOCAL)||'[]');
    if(!quickLinks.length) quickLinks=[...DEFAULT_LINKS];
    source='local'; note.textContent='Links are stored locally. Add/edit, then â€œSync â†’ GitHubâ€ to commit.';
    renderApps();
  }

  function startRealtime(){
    if(unsubscribe) unsubscribe();
    const r=ref(db,LINKS_DB_PATH);
    const off = onValue(r,(snap)=>{
      if(snap.exists()){
        const val=snap.val();
        quickLinks = Array.isArray(val) ? val : Object.values(val||{});
        source='db';
        note.textContent='Realtime: synced from Database (admin/quickLinks).';
        renderApps();
      }else{
        // DB path empty â€” fall back to config or defaults, but keep listener alive
        const cfg = appConfig?.quickLinks;
        if(Array.isArray(cfg) && cfg.length){
          quickLinks = cfg; source='config'; note.textContent='Loaded from GitHub config (config/iptv-config.json).';
        }else{
          quickLinks = [...DEFAULT_LINKS]; source='db'; note.textContent='Database empty. Showing defaults (save to persist).';
        }
        renderApps();
      }
    }, (_err)=>{
      // Permission/other error â†’ local fallback
      useLocal();
    });
    unsubscribe = ()=> off();
  }

  async function saveLinks(){
    // Try DB first (admins share across devices)
    try{
      const data = quickLinks; // store as array for order
      await set(ref(db,LINKS_DB_PATH), data);
      source='db'; note.textContent='Saved to Database (shared across admins).';
      return;
    }catch(e){
      // fallback to local
      localStorage.setItem(LS_LOCAL, JSON.stringify(quickLinks));
      source='local'; note.textContent='Saved locally (no DB permission).';
    }
  }

  function renderApps(){
    const grid=$('#appsGrid'); grid.innerHTML='';
    quickLinks.forEach((l,idx)=>{
      const a=document.createElement('a'); a.className='app-tile'; a.href=l.href; a.target='_blank'; a.rel='noopener';
      a.innerHTML=`
        ${l.img? `<div class="app-logo" style="background-image:url('${l.img}')"></div>` : `<div class="app-emoji">${l.emoji||'ðŸ”—'}</div>`}
        <div class="app-info">
          <div class="app-title">${l.title||'Link'}</div>
          <div class="app-desc">${l.desc||''}</div>
        </div>
        <button type="button" class="btn" data-remove="${idx}" style="margin-left:auto">Ã—</button>`;
      grid.appendChild(a);
    });
    grid.querySelectorAll('[data-remove]').forEach(b=>b.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      quickLinks.splice(+b.dataset.remove,1);
      saveLinks(); renderApps(); toast('Link removed');
    }));
  }

  // Add/Reset
  $('#qlAddBtn').addEventListener('click', async ()=>{
    const title=$('#qlTitle').value.trim();
    const href=$('#qlHref').value.trim();
    if(!title||!href) return toast('Title + URL required');
    quickLinks.push({
      title, href,
      emoji:$('#qlEmoji').value.trim(),
      img:$('#qlImg').value.trim(),
      desc:$('#qlDesc').value.trim()
    });
    ['qlTitle','qlHref','qlEmoji','qlImg','qlDesc'].forEach(id=>$('#'+id).value='');
    await saveLinks(); renderApps(); toast('Link added');
  });

  $('#qlResetBtn').addEventListener('click', async ()=>{
    quickLinks=[...DEFAULT_LINKS]; await saveLinks(); renderApps(); toast('Defaults restored');
  });

  /* ===== GitHub export ===== */
  const LS_GH='iptv_admin_gh';
  const gh=JSON.parse(localStorage.getItem(LS_GH)||'{}');
  $('#settingsBtn').addEventListener('click',()=>{
    $('#ghOwner').value=gh.owner||''; $('#ghRepo').value=gh.repo||'';
    $('#ghBranch').value=gh.branch||'main'; $('#ghPath').value=gh.path||'config/iptv-config.json';
    $('#ghToken').value=gh.token||''; $('#settingsDlg').showModal();
  });
  $('#saveSettingsBtn').addEventListener('click',(e)=>{
    e.preventDefault();
    gh.owner=$('#ghOwner').value.trim(); gh.repo=$('#ghRepo').value.trim();
    gh.branch=$('#ghBranch').value.trim()||'main'; gh.path=$('#ghPath').value.trim()||'config/iptv-config.json';
    gh.token=$('#ghToken').value.trim();
    localStorage.setItem(LS_GH,JSON.stringify(gh)); toast('Settings saved'); $('#settingsDlg').close();
  });

  const b64=s=>btoa(unescape(encodeURIComponent(s)));
  async function ghFetch(url,opts){ const r=await fetch(url,opts); const t=await r.text(); let d; try{d=t?JSON.parse(t):{}}catch{d={raw:t}} if(!r.ok) throw new Error((d&&d.message)||r.statusText); return d; }

  async function snapshot(){
    const [dp,ds,us]=await Promise.all([
      get(ref(db,'dealershipPublic')).catch(()=>({val:()=>null})),
      get(ref(db,'displays')).catch(()=>({val:()=>null})),
      get(ref(db,'user')).catch(()=>({val:()=>null}))
    ]);
    const users={};
    Object.entries(us?.val?.()||{}).forEach(([uid,u])=>{
      users[uid]={email:u.email||null,name:u.name||null,role:u.role||'user',dealershipId:u.dealershipId||null};
    });
    return {
      meta:{generatedAt:new Date().toISOString(),by:auth.currentUser?.email||'admin',format:'iptv-bfa@1'},
      dealersPublic:dp?.val?.()||{},
      displays:ds?.val?.()||{},
      users,
      quickLinks
    };
  }

  async function exportToGitHub(){
    try{
      if(!gh.owner||!gh.repo||!gh.branch||!gh.path||!gh.token){ toast('Settings incomplete'); return; }
      await ghFetch(`https://api.github.com/repos/${gh.owner}/${gh.repo}`,{headers:{Authorization:`Bearer ${gh.token}`,'Accept':'application/vnd.github+json'}});
      const content=b64(JSON.stringify(await snapshot(),null,2));
      const base=`https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/${encodeURIComponent(gh.path)}`;
      const headers={Authorization:`Bearer ${gh.token}`,'Accept':'application/vnd.github+json','Content-Type':'application/json'};
      let sha; try{ const ex=await ghFetch(`${base}?ref=${encodeURIComponent(gh.branch)}`,{headers}); sha=ex.sha; }catch{}
      await ghFetch(base,{method:'PUT',headers,body:JSON.stringify({message:sha?`update: ${gh.path}`:`create: ${gh.path}`,content,branch:gh.branch,sha})});
      toast('Synced to GitHub âœ”ï¸Ž');
    }catch(e){ alert('GitHub sync failed: '+e.message); toast('Sync failed'); }
  }
  $('#syncBtn').addEventListener('click',exportToGitHub);

  // Start realtime sync (DB â†’ UI). If rules deny, we fall back to local.
  startRealtime();
</script>
</body>
</html>
