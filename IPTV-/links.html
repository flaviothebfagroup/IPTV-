<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BFA IPTV â€” Links</title>
<link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
<meta name="theme-color" content="#000000"/>
<link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
<link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>
<style>
:root{--bg:#0b0b0c;--fg:#fff;--muted:#9a9aa0;--panel:#121214;--border:rgba(255,255,255,.14);
--accent:#ff9500;--tile:#17171a;--tileActive:#1d1d21;--shadow:0 18px 48px rgba(0,0,0,.45);
--radius:18px;--radius-lg:22px}
body.light{--bg:#f5f5f7;--fg:#111;--muted:#6e6e73;--panel:#fff;--border:rgba(0,0,0,.12);
--tile:#f2f2f7;--tileActive:#eaeaef;--shadow:0 14px 36px rgba(0,0,0,.10)}
*{box-sizing:border-box} html,body{height:100%}
body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;margin:0}
a{color:inherit}
.topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.lhs{display:flex;align-items:center;gap:12px}
.logo{width:36px;height:36px;border-radius:10px;background:var(--tile) center/contain no-repeat;border:1px solid var(--border)}
.title{font-weight:900;letter-spacing:.3px}
.btn{height:34px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer}
.btn.primary{border-color:var(--accent);color:var(--accent);background:transparent}
.nav{display:flex;gap:6px;flex-wrap:wrap}
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow)}
.row{display:grid;grid-template-columns:1fr auto;gap:10px;margin:10px 0}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
.row3{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin:10px 0}
@media (max-width:720px){.row,.row2,.row3{grid-template-columns:1fr}}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}
.input,.select{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
.btn.solid{padding:12px;border-radius:12px;background:var(--accent);border:0;color:#000;font-weight:900;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.apps-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
@media (max-width:1060px){.apps-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:560px){.apps-grid{grid-template-columns:1fr}}
.app-tile{display:flex;gap:12px;align-items:center;padding:12px;border:1px solid var(--border);border-radius:16px;background:var(--tile);text-decoration:none;color:inherit;transition:transform .1s, box-shadow .2s, border-color .2s}
.app-tile:hover{transform:translateY(-1px);border-color:var(--accent);box-shadow:0 8px 22px rgba(255,149,0,.15)}
.app-emoji,.app-logo{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:var(--tileActive) center/cover no-repeat;display:grid;place-items:center;font-size:20px}
.app-info{display:flex;flex-direction:column;gap:2px}
.app-title{font-weight:800}
.app-desc{font-size:12px;color:var(--muted)}
.toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
.toast.show{opacity:1}
</style>
</head>
<body>
  <div class="topbar">
    <div class="lhs">
      <a href="./home.html" class="logo" id="brandLogo" title="Home"></a>
      <div class="title">Links</div>
    </div>
    <div class="nav">
      <a class="btn" href="./dealerships.html">Dealers</a>
      <a class="btn" href="./displays.html">Displays</a>
      <a class="btn" href="./users.html">Users</a>
      <a class="btn primary" href="./links.html">Links</a>
      <a class="btn" href="./analytics.html">Analytics</a>
      <a class="btn" href="./schedule.html">Schedule</a>
      <a class="btn" href="./backups.html">Backups</a>
      <a class="btn" href="./remote.html">Remote</a>
      <button id="themeBtn" class="btn">â˜€ï¸Ž/ðŸŒ™</button>
      <button id="syncBtn" class="btn primary">Sync â†’ GitHub</button>
      <button id="settingsBtn" class="btn">Settings</button>
      <button id="signOutBtn" class="btn">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px">Apps / Quick Links</h2>
      <div class="row3">
        <div><div class="label">Title</div><input id="qlTitle" class="input" placeholder="e.g., Firebase â€” Database"/></div>
        <div><div class="label">URL</div><input id="qlHref" class="input" placeholder="https://..."/></div>
        <div style="display:flex;align-items:end"><button id="qlAddBtn" class="btn solid" style="width:100%">Add Link</button></div>
      </div>
      <div class="row2">
        <div><div class="label">Emoji (optional)</div><input id="qlEmoji" class="input" placeholder="ðŸ”¥ âœ… ðŸ“ â€¦"/></div>
        <div><div class="label">Logo image URL (optional)</div><input id="qlImg" class="input" placeholder="https://.../logo.png"/></div>
      </div>
      <div class="row">
        <div><div class="label">Description (optional)</div><input id="qlDesc" class="input" placeholder="Short label under the title"/></div>
        <div style="display:flex;align-items:end"><button id="qlResetBtn" class="btn" style="width:100%">Reset to defaults</button></div>
      </div>
      <div id="appsGrid" class="apps-grid"></div>
      <div class="small" id="qlStorageNote">Loadingâ€¦</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Settings dialog -->
  <dialog id="settingsDlg" style="border:0;padding:0;border-radius:18px;max-width:720px;width:96vw">
    <form method="dialog" class="card" style="margin:0">
      <h2>Settings</h2>
      <div class="row2">
        <div><div class="label">GitHub Owner</div><input id="ghOwner" class="input" placeholder="org-or-user"/></div>
        <div><div class="label">Repo</div><input id="ghRepo" class="input" placeholder="repo"/></div>
      </div>
      <div class="row3">
        <div><div class="label">Branch</div><input id="ghBranch" class="input" placeholder="main"/></div>
        <div><div class="label">Path</div><input id="ghPath" class="input" placeholder="config/iptv-config.json"/></div>
        <div><div class="label">Token</div><input id="ghToken" class="input" type="password" placeholder="fine-grained token (contents:write)"/></div>
      </div>
      <div class="row2">
        <button class="btn" value="cancel">Close</button>
        <button id="saveSettingsBtn" class="btn solid" value="default">Save</button>
      </div>
    </form>
  </dialog>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};
const LOGO_URL="https://flaviothebfagroup.github.io/IPTV-/icons/icon-512.png";
const DEFAULT_LINKS=[
  {emoji:'ðŸ”¥',title:'Firebase â€” Overview',href:'https://console.firebase.google.com/project/iptv-bfa/overview',desc:'Console home'},
  {emoji:'ðŸ—„ï¸',title:'Firebase â€” Database',href:'https://console.firebase.google.com/project/iptv-bfa/database/iptv-bfa-default-rtdb/data',desc:'Realtime DB data'},
  {emoji:'ðŸ‘¤',title:'Firebase â€” Auth',href:'https://console.firebase.google.com/project/iptv-bfa/authentication/users',desc:'Users & providers'},
  {emoji:'ðŸ™',title:'GitHub Repo',href:'https://github.com/flaviothebfagroup/IPTV-',desc:'Source code'},
  {emoji:'ðŸŒ',title:'GitHub Pages (Remote)',href:'https://flaviothebfagroup.github.io/IPTV-/remote-control.html',desc:'Open remote'},
  {emoji:'ðŸ“§',title:'Gmail',href:'https://mail.google.com/mail/u/0/#inbox',desc:'Primary inbox'},
  {emoji:'ðŸ“§',title:'Outlook',href:'https://outlook.office.com/mail/',desc:'Office 365 inbox'},
  {emoji:'âœ…',title:'Trello â€” Digital Team',href:'https://trello.com/b/jHjTIrZG/digital-team',desc:'Board'},
  {emoji:'ðŸŽ›ï¸',title:'BSN.cloud',href:'https://app.bsn.cloud/#/dashboard',desc:'BrightSign dashboard'},
  {emoji:'ðŸ–¥ï¸',title:'Signagelive',href:'https://login.signagelive.com/',desc:'CMS login'},
  {emoji:'ðŸ“',title:'Google Drive',href:'https://drive.google.com/drive/u/0/',desc:'My Drive'}
];

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getDatabase(app);

const $=s=>document.querySelector(s);
function toast(msg){const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}
const savedTheme=localStorage.getItem('iptv_theme')||'light';
document.body.classList.toggle('light',savedTheme==='light');
$('#themeBtn').addEventListener('click',()=>{const isLight=!document.body.classList.contains('light');document.body.classList.toggle('light',isLight);localStorage.setItem('iptv_theme',isLight?'light':'dark');});
$('#brandLogo').style.backgroundImage=`url("${LOGO_URL}")`;

$('#signOutBtn').addEventListener('click',()=>signOut(auth));
setPersistence(auth,browserLocalPersistence);
onAuthStateChanged(auth,u=>{ if(!u){location.href='./home.html';} });

const LINKS_DB_PATH='admin/quickLinks';
let quickLinks=[], source='db';

async function loadLinks(){
  try{
    const s=await get(ref(db,LINKS_DB_PATH));
    if(s.exists()){ quickLinks=Object.values(s.val()); source='db'; $('#qlStorageNote').textContent='Links are synced from database.'; }
    else throw new Error();
  }catch{
    quickLinks=JSON.parse(localStorage.getItem('admin_quick_links')||'[]');
    if(!quickLinks.length) quickLinks=[...DEFAULT_LINKS];
    source='local'; $('#qlStorageNote').textContent='Links are stored locally (no DB permission).';
  }
  renderApps();
}
function renderApps(){
  const grid=$('#appsGrid'); grid.innerHTML='';
  quickLinks.forEach((l,idx)=>{
    const a=document.createElement('a'); a.className='app-tile'; a.href=l.href; a.target='_blank'; a.rel='noopener';
    a.innerHTML = `
      ${l.img? `<div class="app-logo" style="background-image:url('${l.img}')"></div>` : `<div class="app-emoji">${l.emoji||'ðŸ”—'}</div>`}
      <div class="app-info"><div class="app-title">${l.title||'Link'}</div><div class="app-desc">${l.desc||''}</div></div>
      <button type="button" class="btn" data-remove="${idx}" style="margin-left:auto">Ã—</button>`;
    grid.appendChild(a);
  });
  grid.querySelectorAll('[data-remove]').forEach(b=>b.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();const i=+b.dataset.remove;quickLinks.splice(i,1);saveLinks();renderApps();toast('Link removed');}));
}
async function saveLinks(){
  if(source==='local'){ localStorage.setItem('admin_quick_links',JSON.stringify(quickLinks)); return; }
  try{
    const data={}; quickLinks.forEach((l,i)=>data[i]=l);
    await set(ref(db,LINKS_DB_PATH),data);
  }catch{
    localStorage.setItem('admin_quick_links',JSON.stringify(quickLinks)); source='local'; $('#qlStorageNote').textContent='Links are stored locally (no DB permission).';
  }
}
$('#qlAddBtn').addEventListener('click',async ()=>{
  const title=$('#qlTitle').value.trim(), href=$('#qlHref').value.trim();
  if(!title||!href) return toast('Title + URL required');
  quickLinks.push({title,href,emoji:$('#qlEmoji').value.trim(),img:$('#qlImg').value.trim(),desc:$('#qlDesc').value.trim()});
  ['#qlTitle','#qlHref','#qlEmoji','#qlImg','#qlDesc'].forEach(s=>$(s).value='');
  await saveLinks(); renderApps(); toast('Link added');
});
$('#qlResetBtn').addEventListener('click',async ()=>{ quickLinks=[...DEFAULT_LINKS]; await saveLinks(); renderApps(); toast('Defaults restored'); });

/* GitHub settings + sync (shared behavior) */
const LS_GH='iptv_admin_gh';
const gh=JSON.parse(localStorage.getItem(LS_GH)||'{}');
$('#settingsBtn').addEventListener('click',()=>{ $('#ghOwner').value=gh.owner||'';$('#ghRepo').value=gh.repo||'';$('#ghBranch').value=gh.branch||'main';$('#ghPath').value=gh.path||'config/iptv-config.json';$('#ghToken').value=gh.token||'';$('#settingsDlg').showModal();});
$('#saveSettingsBtn').addEventListener('click',(e)=>{e.preventDefault(); gh.owner=$('#ghOwner').value.trim();gh.repo=$('#ghRepo').value.trim();gh.branch=$('#ghBranch').value.trim()||'main';gh.path=$('#ghPath').value.trim()||'config/iptv-config.json';gh.token=$('#ghToken').value.trim();localStorage.setItem(LS_GH,JSON.stringify(gh));toast('Settings saved');$('#settingsDlg').close();});
function b64(s){return btoa(unescape(encodeURIComponent(s)));}
async function ghFetch(url,opts){const r=await fetch(url,opts);const t=await r.text();let d;try{d=t?JSON.parse(t):{}}catch{d={raw:t}}if(!r.ok)throw new Error((d&&d.message)||r.statusText);return d;}
async function snapshot(){
  const [dp,ds,us]=await Promise.all([get(ref(db,'dealershipPublic')).catch(()=>({val:()=>null})),get(ref(db,'displays')).catch(()=>({val:()=>null})),get(ref(db,'user')).catch(()=>({val:()=>null}))]);
  const users={}; Object.entries(us?.val?.()||{}).forEach(([uid,u])=>{users[uid]={email:u.email||null,name:u.name||null,role:u.role||'user',dealershipId:u.dealershipId||null};});
  return {meta:{generatedAt:new Date().toISOString(),by:auth.currentUser?.email||'admin',format:'iptv-bfa@1'},dealersPublic:dp?.val?.()||{},displays:ds?.val?.()||{},users};
}
async function exportToGitHub(){
  try{
    const cfg=JSON.parse(localStorage.getItem(LS_GH)||'{}');
    if(!cfg.owner||!cfg.repo||!cfg.branch||!cfg.path||!cfg.token){toast('Settings incomplete');return;}
    await ghFetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}`,{headers:{Authorization:`Bearer ${cfg.token}`,'Accept':'application/vnd.github+json'}});
    const content=b64(JSON.stringify(await snapshot(),null,2));
    const base=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(cfg.path)}`;
    const headers={Authorization:`Bearer ${cfg.token}`,'Accept':'application/vnd.github+json','Content-Type':'application/json'};
    let sha; try{ const ex=await ghFetch(`${base}?ref=${encodeURIComponent(cfg.branch)}`,{headers}); sha=ex.sha; }catch(e){}
    await ghFetch(base,{method:'PUT',headers,body:JSON.stringify({message:sha?`update: ${cfg.path}`:`create: ${cfg.path}`,content,branch:cfg.branch,sha})});
    toast('Synced to GitHub âœ”ï¸Ž');
  }catch(e){alert('GitHub sync failed: '+e.message);toast('Sync failed');}
}
$('#syncBtn').addEventListener('click',exportToGitHub);

await loadLinks();
</script>
</body>
</html>
