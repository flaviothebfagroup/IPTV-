<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BFA IPTV — Wall Layout Editor</title>

  <style>
    :root{
      --brand:#ff6a00; --brand-2:#e85f00;
      --bg-start:#fefefe;
      --bg-mid:#f3f6fb;
      --bg-end:#ff6a00;

      --fg:#0f172a;
      --panel:rgba(255,255,255,.56);
      --line:rgba(15,23,42,.12);
      --muted:#64748b;

      --glass-blur:18px;
      --glass-sat:150%;
      --elev-shadow:0 18px 40px rgba(15,23,42,.14), 0 2px 10px rgba(15,23,42,.08);
      --elev-shadow-soft:0 10px 26px rgba(15,23,42,.10), 0 1px 4px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{
      margin:0;color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:transparent;
      min-height:100vh;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-2; pointer-events:none;
      background:
        radial-gradient(circle at 10% 0%, rgba(255,255,255,0.7) 0, transparent 50%),
        radial-gradient(circle at 90% 0%, rgba(255,179,102,1) 0, transparent 55%),
        linear-gradient(180deg, var(--bg-start) 0%, var(--bg-mid) 55%, var(--bg-end) 100%);
    }

    .page{max-width:980px;margin:18px auto;padding:16px}
    .stack>*+*{margin-top:14px}

    .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand-pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.35);
      border:1px solid rgba(255,255,255,0.85);
      box-shadow:0 8px 22px rgba(255,106,0,0.35);
      backdrop-filter:blur(18px) saturate(160%);
      -webkit-backdrop-filter:blur(18px) saturate(160%);
    }
    .logo{height:32px}
    h1{margin:0;font-size:clamp(18px,4.2vw,24px);font-weight:900;letter-spacing:.03em}
    .sub{color:var(--muted);font-size:12px}

    .badge{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(15,23,42,0.85);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--brand);
      box-shadow:0 0 0 0 rgba(255,149,0,0.7);
      animation:pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(255,149,0,0.7);}
      70%{box-shadow:0 0 0 9px rgba(255,149,0,0);}
      100%{box-shadow:0 0 0 0 rgba(255,149,0,0);}
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px 14px 16px;
      box-shadow:var(--elev-shadow);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    }

    label{font-size:13px;font-weight:600;display:block;margin-bottom:4px}
    select,button,input{
      font-size:13px;
      height:36px;
      padding:0 12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--fg);
      outline:none;
      -webkit-tap-highlight-color:transparent;
      box-shadow:var(--elev-shadow-soft);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    }
    button{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 10px 24px rgba(255,106,0,.32);
    }
    .btn-outline{
      background:var(--panel);
      color:var(--brand);
      border-color:rgba(255,149,0,.6);
    }
    button.btn,button.btn-outline{
      transition:transform .12s ease, box-shadow .18s ease, filter .18s ease, background .18s ease;
    }
    button.btn:hover,button.btn-outline:hover{
      transform:translateY(-1px);
      filter:brightness(1.03);
    }

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .msg{font-size:12px;margin-top:6px}
    .msg-ok{color:#16a34a}
    .msg-err{color:#b91c1c}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:12px;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid rgba(148,163,184,0.3);
      text-align:left;
    }
    th{font-weight:600;color:var(--muted);font-size:11px}
    td.slot-col{width:40px;font-weight:600}
    td select{width:100%}
    @media (max-width:640px){
      table{font-size:11px}
      th:nth-child(3),td:nth-child(3){display:none;} /* hide URL column on very small */
    }
  </style>
</head>
<body>
  <div class="page stack">
    <header class="head">
      <div class="brand-pill">
        <img id="bfaLogo" class="logo" alt="BFA logo" />
        <div>
          <h1>BFA IPTV — Wall Layout Editor</h1>
          <div class="sub">Choose grid + assign channels. wall-display.html will follow this layout.</div>
        </div>
      </div>
      <div class="badge">
        <span class="dot"></span>
        <span>Editor (laptop only)</span>
      </div>
    </header>

    <!-- GRID + SHEET CONFIG -->
    <section class="card">
      <div class="row" style="margin-bottom:10px">
        <div style="flex:1 1 220px">
          <label for="sheetId">Sheet ID</label>
          <input id="sheetId" />
        </div>
        <div style="flex:0 0 auto;margin-top:18px">
          <button id="loadListBtn" class="btn-outline" type="button">Load channel list</button>
        </div>
      </div>
      <div class="row">
        <div style="flex:1 1 220px">
          <label for="gridPreset">Grid</label>
          <select id="gridPreset">
            <option value="1x1">1 × 1 (1 screen)</option>
            <option value="2x1">2 × 1 (2 screens)</option>
            <option value="2x2" selected>2 × 2 (4 screens)</option>
            <option value="3x2">3 × 2 (6 screens)</option>
            <option value="3x3">3 × 3 (9 screens)</option>
            <option value="4x3">4 × 3 (12 screens)</option>
          </select>
        </div>
        <div style="flex:0 0 auto;margin-top:18px">
          <span id="gridInfo" class="sub"></span>
        </div>
      </div>
      <div class="sub" style="margin-top:6px">
        Each tile is 16:9 inside the grid. Choose the grid you want for the wall-display player (1920×1080).
      </div>
    </section>

    <!-- SLOT ASSIGNMENT -->
    <section class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <strong>Slots</strong>
        <span id="listStatus" class="sub">Channel list: not loaded yet.</span>
      </div>

      <div class="sub">For each slot, pick a channel from your sheet. Empty = no tile.</div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Channel from sheet</th>
            <th>Preview URL</th>
          </tr>
        </thead>
        <tbody id="slotsBody"></tbody>
      </table>

      <div class="row" style="margin-top:10px">
        <button id="saveBtn" class="btn" type="button">Save layout to backend</button>
        <button id="reloadLayoutBtn" class="btn-outline" type="button">Reload layout</button>
        <span id="saveMsg" class="msg"></span>
      </div>
    </section>

    <div class="sub">
      Tip: open <code>wall-display.html</code> on the BrightSign. After you hit “Save layout”, the wall can refresh (every 30–60s) and follow your changes.
    </div>
  </div>

  <script>
  // ===== CONFIG =====
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxDqMW48Yrkt-m942pipz7HtMOk0lwJp8O_LQHIQR-OM06sytw9U-HNQIrbpOjS4VQS/exec';

  // Grid presets: cols, rows, total slots
  const GRID_PRESETS = [
    { id: '2x2', label: '2 × 2 (4 screens)',  cols: 2, rows: 2, slots: 4 },
    { id: '3x2', label: '3 × 2 (6 screens)',  cols: 3, rows: 2, slots: 6 },
    { id: '4x3', label: '4 × 3 (12 screens)', cols: 4, rows: 3, slots: 12 },
    { id: '5x3', label: '5 × 3 (15 screens)', cols: 5, rows: 3, slots: 15 },
    { id: '6x4', label: '6 × 4 (24 screens)', cols: 6, rows: 4, slots: 24 }
  ];

  // ===== DOM SHORTCUTS =====
  const gridSelect   = document.getElementById('gridSelect');     // <select> for grid
  const slotsContainer = document.getElementById('slotsContainer'); // where rows go
  const loadBtn      = document.getElementById('loadBtn');        // "Load channel list"
  const saveBtn      = document.getElementById('saveBtn');        // "Save layout to backend"
  const reloadBtn    = document.getElementById('reloadBtn');      // "Reload layout"
  const statusMsg    = document.getElementById('statusMsg');      // small text message
  const channelCountText = document.getElementById('channelCountText'); // "Channel list: X..."

  let allChannels = [];   // from backend (fn=list)
  let currentPreset = GRID_PRESETS[1]; // default 3x2 like your screenshot

  // ===== UTIL =====
  function showStatus(text, isError = false) {
    statusMsg.textContent = text || '';
    statusMsg.style.color = isError ? '#b91c1c' : '#0f172a';
  }

  function setChannelCount(n) {
    if (!channelCountText) return;
    if (!n) {
      channelCountText.textContent = 'Channel list not loaded yet.';
    } else {
      channelCountText.textContent = `Channel list: ${n} channel(s) loaded.`;
    }
  }

  function getPresetByColsRows(cols, rows) {
    return GRID_PRESETS.find(p => p.cols === cols && p.rows === rows) || GRID_PRESETS[1];
  }

  // ===== BUILD GRID ROWS =====
  function buildSlotRows(preset) {
    slotsContainer.innerHTML = '';
    if (!preset) preset = currentPreset;

    for (let i = 1; i <= preset.slots; i++) {
      const row = document.createElement('div');
      row.className = 'slot-row';
      row.dataset.slot = String(i);

      row.innerHTML = `
        <div class="slot-index">${i}</div>
        <div class="slot-select-wrap">
          <select class="slot-select">
            <option value="">— Empty —</option>
          </select>
        </div>
        <div class="slot-url">
          <input class="slot-url-input" type="text" readonly placeholder="Preview URL" />
        </div>
      `;

      slotsContainer.appendChild(row);
    }

    // Fill dropdowns with channel list
    populateSelectsFromChannels();
  }

  function populateSelectsFromChannels() {
    const rows = Array.from(slotsContainer.querySelectorAll('.slot-row'));
    rows.forEach(row => {
      const select = row.querySelector('.slot-select');
      const urlInput = row.querySelector('.slot-url-input');

      // Clear and re-add options
      const prevValue = select.value;
      select.innerHTML = '<option value="">— Empty —</option>';

      allChannels.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch.id;
        opt.textContent = `${ch.id} — ${ch.name || 'Channel ' + ch.id}`;
        select.appendChild(opt);
      });

      // Event: update URL preview on change
      select.addEventListener('change', () => {
        const id = Number(select.value || '0');
        const ch = allChannels.find(c => c.id === id);
        urlInput.value = ch ? ch.url : '';
      });

      // Keep previously selected value if still valid
      if (prevValue) {
        select.value = prevValue;
        const id = Number(prevValue);
        const ch = allChannels.find(c => c.id === id);
        urlInput.value = ch ? ch.url : '';
      }
    });
  }

  // ===== LOAD CHANNEL LIST FROM BACKEND (fn=list) =====
  async function loadChannelList() {
    showStatus('Loading channel list…');
    setChannelCount(0);

    try {
      const res = await fetch(WEBAPP_URL + '?fn=list', { cache: 'no-store' });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Backend error');
      allChannels = Array.isArray(data.channels) ? data.channels : [];
      setChannelCount(allChannels.length);
      populateSelectsFromChannels();
      showStatus('Channel list loaded ✔');
    } catch (err) {
      console.error(err);
      showStatus('Error loading channel list.', true);
    }
  }

  // ===== LOAD EXISTING WALL LAYOUT (fn=getwall) =====
  async function loadLayoutFromBackend() {
    showStatus('Loading layout…');

    try {
      const res = await fetch(WEBAPP_URL + '?fn=getwall', { cache: 'no-store' });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Backend error');

      const cols = Number(data.cols) || 3;
      const rows = Number(data.rows) || 2;
      const tiles = Array.isArray(data.tiles) ? data.tiles : [];

      currentPreset = getPresetByColsRows(cols, rows);
      gridSelect.value = currentPreset.id;
      buildSlotRows(currentPreset);

      // Apply tile mapping {slot, channelId}
      const slotMap = new Map();
      tiles.forEach(t => {
        if (t && t.slot && t.channelId) {
          slotMap.set(Number(t.slot), Number(t.channelId));
        }
      });

      const rowsDom = Array.from(slotsContainer.querySelectorAll('.slot-row'));
      rowsDom.forEach(row => {
        const slot = Number(row.dataset.slot);
        const chId = slotMap.get(slot);
        const select = row.querySelector('.slot-select');
        const urlInput = row.querySelector('.slot-url-input');
        if (chId) {
          select.value = chId;
          const ch = allChannels.find(c => c.id === chId);
          urlInput.value = ch ? ch.url : '';
        }
      });

      showStatus('Layout loaded ✔');
    } catch (err) {
      console.error(err);
      showStatus('Could not load existing layout (will start fresh).', true);
    }
  }

  // ===== SAVE LAYOUT (fn=setwall) – CORS-SAFE FIX =====
  async function saveLayoutToBackend() {
    // Gather from grid
    const rowsDom = Array.from(slotsContainer.querySelectorAll('.slot-row'));
    const tiles = [];

    rowsDom.forEach(row => {
      const slot = Number(row.dataset.slot);
      const select = row.querySelector('.slot-select');
      const chId = Number(select.value || '0');
      if (!chId) return;
      tiles.push({ slot, channelId: chId });
    });

    const payload = {
      cols: currentPreset.cols,
      rows: currentPreset.rows,
      tiles
    };

    showStatus('Saving layout…');

    try {
      // IMPORTANT PART: text/plain to avoid preflight / CORS issues
      const res = await fetch(WEBAPP_URL + '?fn=setwall', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        throw new Error(data && data.error ? data.error : 'Backend error');
      }

      showStatus('Layout saved ✔ Wall will follow this layout.');
      return true;
    } catch (err) {
      console.error(err);
      showStatus('Error saving layout.', true);
      return false;
    }
  }

  // ===== EVENT WIRING =====
  // Populate grid dropdown options (if not already in HTML)
  if (gridSelect && !gridSelect.options.length) {
    GRID_PRESETS.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.label;
      gridSelect.appendChild(opt);
    });
  }

  if (gridSelect) {
    gridSelect.addEventListener('change', () => {
      const id = gridSelect.value;
      const preset = GRID_PRESETS.find(p => p.id === id) || GRID_PRESETS[1];
      currentPreset = preset;
      buildSlotRows(preset);
    });
  }

  if (loadBtn) loadBtn.addEventListener('click', loadChannelList);
  if (saveBtn) saveBtn.addEventListener('click', saveLayoutToBackend);
  if (reloadBtn) reloadBtn.addEventListener('click', loadLayoutFromBackend);

  // ===== INITIALISE ON PAGE LOAD =====
  (async function init() {
    // Default preset
    gridSelect.value = currentPreset.id;
    buildSlotRows(currentPreset);

    // Load channels first, then layout
    await loadChannelList();
    await loadLayoutFromBackend();
  })();
</script>

</body>
</html>
 
