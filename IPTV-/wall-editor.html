<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BFA IPTV — Wall Layout Editor</title>

  <style>
    :root{
      --brand:#ff6a00; --brand-2:#e85f00;
      --bg-start:#fefefe;
      --bg-mid:#f3f6fb;
      --bg-end:#ff6a00;

      --fg:#0f172a;
      --panel:rgba(255,255,255,.56);
      --line:rgba(15,23,42,.12);
      --muted:#64748b;

      --glass-blur:18px;
      --glass-sat:150%;
      --elev-shadow:0 18px 40px rgba(15,23,42,.14), 0 2px 10px rgba(15,23,42,.08);
      --elev-shadow-soft:0 10px 26px rgba(15,23,42,.10), 0 1px 4px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{
      margin:0;color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:transparent;
      min-height:100vh;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-2; pointer-events:none;
      background:
        radial-gradient(circle at 10% 0%, rgba(255,255,255,0.7) 0, transparent 50%),
        radial-gradient(circle at 90% 0%, rgba(255,179,102,1) 0, transparent 55%),
        linear-gradient(180deg, var(--bg-start) 0%, var(--bg-mid) 55%, var(--bg-end) 100%);
    }

    .page{max-width:980px;margin:18px auto;padding:16px}
    .stack>*+*{margin-top:14px}

    .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand-pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.35);
      border:1px solid rgba(255,255,255,0.85);
      box-shadow:0 8px 22px rgba(255,106,0,0.35);
      backdrop-filter:blur(18px) saturate(160%);
      -webkit-backdrop-filter:blur(18px) saturate(160%);
    }
    .logo{height:32px}
    h1{margin:0;font-size:clamp(18px,4.2vw,24px);font-weight:900;letter-spacing:.03em}
    .sub{color:var(--muted);font-size:12px}

    .badge{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(15,23,42,0.85);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--brand);
      box-shadow:0 0 0 0 rgba(255,149,0,0.7);
      animation:pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(255,149,0,0.7);}
      70%{box-shadow:0 0 0 9px rgba(255,149,0,0);}
      100%{box-shadow:0 0 0 0 rgba(255,149,0,0);}
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px 14px 16px;
      box-shadow:var(--elev-shadow);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    }

    label{font-size:13px;font-weight:600;display:block;margin-bottom:4px}
    select,button,input{
      font-size:13px;
      height:36px;
      padding:0 12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--fg);
      outline:none;
      -webkit-tap-highlight-color:transparent;
      box-shadow:var(--elev-shadow-soft);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    }
    button{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 10px 24px rgba(255,106,0,.32);
    }
    .btn-outline{
      background:var(--panel);
      color:var(--brand);
      border-color:rgba(255,149,0,.6);
    }
    button.btn,button.btn-outline{
      transition:transform .12s ease, box-shadow .18s ease, filter .18s ease, background .18s ease;
    }
    button.btn:hover,button.btn-outline:hover{
      transform:translateY(-1px);
      filter:brightness(1.03);
    }

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .msg{font-size:12px;margin-top:6px}
    .msg-ok{color:#16a34a}
    .msg-err{color:#b91c1c}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:12px;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid rgba(148,163,184,0.3);
      text-align:left;
    }
    th{font-weight:600;color:var(--muted);font-size:11px}
    td.slot-col{width:40px;font-weight:600}
    td select{width:100%}
    @media (max-width:640px){
      table{font-size:11px}
      th:nth-child(3),td:nth-child(3){display:none;} /* hide URL column on very small */
    }
  </style>
</head>
<body>
  <div class="page stack">
    <header class="head">
      <div class="brand-pill">
        <img id="bfaLogo" class="logo" alt="BFA logo" />
        <div>
          <h1>BFA IPTV — Wall Layout Editor</h1>
          <div class="sub">Choose grid + assign channels. wall-display.html will follow this layout.</div>
        </div>
      </div>
      <div class="badge">
        <span class="dot"></span>
        <span>Editor (laptop only)</span>
      </div>
    </header>

    <!-- GRID + SHEET CONFIG -->
    <section class="card">
      <div class="row" style="margin-bottom:10px">
        <div style="flex:1 1 220px">
          <label for="sheetId">Sheet ID</label>
          <input id="sheetId" />
        </div>
        <div style="flex:0 0 auto;margin-top:18px">
          <button id="loadListBtn" class="btn-outline" type="button">Load channel list</button>
        </div>
      </div>
      <div class="row">
        <div style="flex:1 1 220px">
          <label for="gridPreset">Grid</label>
          <select id="gridPreset">
            <option value="1x1">1 × 1 (1 screen)</option>
            <option value="2x1">2 × 1 (2 screens)</option>
            <option value="2x2" selected>2 × 2 (4 screens)</option>
            <option value="3x2">3 × 2 (6 screens)</option>
            <option value="3x3">3 × 3 (9 screens)</option>
            <option value="4x3">4 × 3 (12 screens)</option>
          </select>
        </div>
        <div style="flex:0 0 auto;margin-top:18px">
          <span id="gridInfo" class="sub"></span>
        </div>
      </div>
      <div class="sub" style="margin-top:6px">
        Each tile is 16:9 inside the grid. Choose the grid you want for the wall-display player (1920×1080).
      </div>
    </section>

    <!-- SLOT ASSIGNMENT -->
    <section class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <strong>Slots</strong>
        <span id="listStatus" class="sub">Channel list: not loaded yet.</span>
      </div>

      <div class="sub">For each slot, pick a channel from your sheet. Empty = no tile.</div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Channel from sheet</th>
            <th>Preview URL</th>
          </tr>
        </thead>
        <tbody id="slotsBody"></tbody>
      </table>

      <div class="row" style="margin-top:10px">
        <button id="saveBtn" class="btn" type="button">Save layout to backend</button>
        <button id="reloadLayoutBtn" class="btn-outline" type="button">Reload layout</button>
        <span id="saveMsg" class="msg"></span>
      </div>
    </section>

    <div class="sub">
      Tip: open <code>wall-display.html</code> on the BrightSign. After you hit “Save layout”, the wall can refresh (every 30–60s) and follow your changes.
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    // PASTE YOUR WEB APP URL HERE:
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxDqMW48Yrkt-m942pipz7HtMOk0lwJp8O_LQHIQR-OM06sytw9U-HNQIrbpOjS4VQS/exec';

    // ---- LOGO ----
    (function(){
      const LOGO_PRIMARY = '/IPTV-/icons/icon-192.png';
      const FALLBACK = 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="30" viewBox="0 0 120 30"><rect rx="7" width="120" height="30" fill="#ff6a00"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-weight="800" font-size="14" fill="#fff">BFA</text></svg>');
      const logo = document.getElementById('bfaLogo');
      logo.src = LOGO_PRIMARY;
      logo.onerror = function(){ logo.onerror=null; logo.src = FALLBACK; };
    })();

    // ---- ELEMENTS ----
    const sheetIdEl        = document.getElementById('sheetId');
    const gridPresetEl     = document.getElementById('gridPreset');
    const gridInfoEl       = document.getElementById('gridInfo');
    const slotsBody        = document.getElementById('slotsBody');
    const loadListBtn      = document.getElementById('loadListBtn');
    const listStatusEl     = document.getElementById('listStatus');
    const saveBtn          = document.getElementById('saveBtn');
    const reloadLayoutBtn  = document.getElementById('reloadLayoutBtn');
    const saveMsgEl        = document.getElementById('saveMsg');

    // ---- STATE ----
    let channels = [];  // [{url,name}]
    let cols = 2;
    let rows = 2;

    // ---- HELPERS ----
    function isUrl(u){ return /^https?:\/\/\S+$/i.test((u||'').trim()); }

    function showSaveMsg(msg, ok){
      saveMsgEl.textContent = msg || '';
      saveMsgEl.className = 'msg ' + (ok ? 'msg-ok' : 'msg-err');
      if(msg){
        setTimeout(()=>{ saveMsgEl.textContent=''; saveMsgEl.className='msg'; }, 5000);
      }
    }

    function updateGridFromPreset(){
      const val = gridPresetEl.value || '2x2';
      const parts = val.split('x');
      cols = parseInt(parts[0],10) || 2;
      rows = parseInt(parts[1],10) || 2;
      const slots = cols * rows;
      gridInfoEl.textContent = `${cols} × ${rows} = ${slots} slots`;
      buildSlotsTable(slots);
    }

    function buildSlotsTable(slots){
      slotsBody.innerHTML = '';
      for(let i=1;i<=slots;i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="slot-col">${i}</td>
          <td>
            <select class="slot-select" data-slot="${i}">
              <option value="">(empty)</option>
            </select>
          </td>
          <td class="url-cell"><span class="slot-url" data-slot-url="${i}" style="font-family:ui-monospace,Menlo,Monaco,Consolas,'Courier New',monospace;font-size:11px;opacity:.8"></span></td>
        `;
        slotsBody.appendChild(tr);
      }
      // populate selects with channels
      refreshChannelOptionsInSlots();
    }

    function refreshChannelOptionsInSlots(){
      const selects = document.querySelectorAll('.slot-select');
      selects.forEach(sel=>{
        const current = sel.value;
        sel.innerHTML = '<option value="">(empty)</option>';
        channels.forEach((ch, idx)=>{
          const opt = document.createElement('option');
          opt.value = String(idx);
          opt.textContent = (idx+1)+' — '+(ch.name || ch.url);
          sel.appendChild(opt);
        });
        // keep previous selection if possible
        if(current && Number(current) < channels.length){
          sel.value = current;
        }
      });

      // hook up URL preview
      selects.forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const slot = sel.getAttribute('data-slot');
          const urlSpan = document.querySelector('[data-slot-url="'+slot+'"]');
          const idx = Number(sel.value);
          urlSpan.textContent = (sel.value!=='' && channels[idx]) ? channels[idx].url : '';
        });
        // trigger once
        sel.dispatchEvent(new Event('change'));
      });
    }

    function fetchJson(url, options){
      return fetch(url, options || {}).then(res=>{
        if(!res.ok) throw new Error('HTTP '+res.status);
        return res.json();
      });
    }

    function loadChannelList(){
      const id = sheetIdEl.value.trim();
      if(!id){
        listStatusEl.textContent = 'Channel list: missing Sheet ID.';
        return Promise.resolve();
      }
      listStatusEl.textContent = 'Channel list: loading…';
      const url = WEBAPP_URL + '?fn=list';
      return fetchJson(url).then(data=>{
        if(!data.ok) throw new Error(data.error || 'list failed');
        channels = data.channels || [];
        listStatusEl.textContent = `Channel list: ${channels.length} channel(s) loaded.`;
        refreshChannelOptionsInSlots();
      }).catch(err=>{
        console.log(err);
        listStatusEl.textContent = 'Channel list: error loading.';
      });
    }

    function loadLayout(){
      const url = WEBAPP_URL + '?fn=getwall';
      return fetchJson(url).then(data=>{
        if(!data.ok) throw new Error(data.error || 'getWall failed');
        if(data.cols && data.rows){
          cols = Number(data.cols) || cols;
          rows = Number(data.rows) || rows;
          const presetStr = cols+'x'+rows;
          if([...gridPresetEl.options].some(o=>o.value === presetStr)){
            gridPresetEl.value = presetStr;
          }
        }
        updateGridFromPreset();
        // apply tile mapping
        const tiles = Array.isArray(data.tiles) ? data.tiles : [];
        const selects = document.querySelectorAll('.slot-select');
        tiles.forEach(t=>{
          const slot = Number(t.slot);
          if(!slot) return;
          const sel = [...selects].find(s=>Number(s.getAttribute('data-slot'))===slot);
          if(!sel) return;
          const idx = channels.findIndex(ch => ch.url === t.url);
          if(idx>=0){
            sel.value = String(idx);
            sel.dispatchEvent(new Event('change'));
          }
        });
        showSaveMsg('Layout loaded from backend.', true);
      }).catch(err=>{
        console.log(err);
        showSaveMsg('Error loading layout.', false);
      });
    }

    function collectLayoutFromUI(){
      const tiles = [];
      const selects = document.querySelectorAll('.slot-select');
      selects.forEach(sel=>{
        if(sel.value==='') return;
        const idx = Number(sel.value);
        const slot = Number(sel.getAttribute('data-slot'));
        const ch = channels[idx];
        if(!ch || !ch.url) return;
        tiles.push({
          slot,
          name: ch.name || ('Channel '+(idx+1)),
          url: ch.url
        });
      });
      return { cols, rows, tiles };
    }

    function saveLayout(){
      const payload = collectLayoutFromUI();
      if(!payload.tiles.length){
        showSaveMsg('Nothing to save (all slots empty).', false);
        return;
      }
      showSaveMsg('Saving…', true);
      fetchJson(WEBAPP_URL+'?fn=setwall', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(data=>{
        if(!data.ok) throw new Error(data.error || 'setWall failed');
        showSaveMsg('Layout saved. Wall will follow this grid.', true);
      }).catch(err=>{
        console.log(err);
        showSaveMsg('Error saving layout.', false);
      });
    }

    // ---- EVENTS ----
    gridPresetEl.addEventListener('change', ()=>{
      updateGridFromPreset();
    });

    loadListBtn.addEventListener('click', ()=>{
      loadChannelList();
    });

    saveBtn.addEventListener('click', saveLayout);
    reloadLayoutBtn.addEventListener('click', ()=>{
      loadLayout();
    });

    // ---- INIT ----
    (function init(){
      // optional: remember sheet ID in localStorage
      try{
        const stored = localStorage.getItem('bfa_wall_sheet_id');
        if(stored) sheetIdEl.value = stored;
      }catch(e){}
      sheetIdEl.addEventListener('change', ()=>{
        try{
          localStorage.setItem('bfa_wall_sheet_id', sheetIdEl.value.trim());
        }catch(e){}
      });

      updateGridFromPreset();
      // Load channels then layout
      loadChannelList().then(loadLayout);
    })();
  </script>
</body>
</html>
 
