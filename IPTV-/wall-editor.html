<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BFA IPTV — Wall Layout Editor</title>

  <style>
    :root{
      --brand:#ff6a00; --brand-2:#e85f00;

      --bg-start:#fff7f0;
      --bg-mid:#ffe0c2;
      --bg-end:#ff6a00;

      --fg:#1f2933;
      --muted:#6b7280;

      --panel:rgba(255,255,255,.72);
      --line:rgba(15,23,42,.08);

      --glass-blur:18px;
      --glass-sat:140%;

      --shadow-strong:0 18px 40px rgba(148,93,40,.32);
      --shadow-soft:0 10px 24px rgba(148,93,40,.18);

      --radius-lg:28px;
      --radius-md:18px;
      --btn-h:44px;
    }

    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--fg);
      background:transparent;
      min-height:100vh;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1;
      background:radial-gradient(circle at top left,#ffe9d1 0,#ffd1a1 18%,transparent 48%),
                 radial-gradient(circle at bottom right,#ff8c32 0,#f97316 26%,#f97316 46%,#b45309 70%),
                 linear-gradient(180deg,var(--bg-start),var(--bg-mid) 50%,var(--bg-end) 110%);
    }

    .page{
      max-width:1040px;
      margin:22px auto 28px;
      padding:0 16px;
    }
    .stack>*+*{margin-top:16px}

    .head{
      background:var(--panel);
      border-radius:var(--radius-lg);
      padding:14px 18px;
      border:1px solid rgba(255,255,255,.85);
      box-shadow:var(--shadow-strong);
      display:flex;
      flex-wrap:wrap;
      gap:10px 16px;
      align-items:center;
      justify-content:space-between;
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo-badge{
      width:40px;
      height:40px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#ffd9aa,transparent 60%),linear-gradient(135deg,#ff9f3f,#ff6a00);
      box-shadow:0 10px 22px rgba(148,93,40,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    .logo-img{
      width:26px;
      height:26px;
      border-radius:8px;
    }
    .titles{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .titles h1{
      margin:0;
      font-weight:800;
      font-size:clamp(18px,4.4vw,22px);
      letter-spacing:.02em;
      white-space:nowrap;
    }
    .sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .head-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .caps-pill{
      padding:6px 11px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.8);
      background:rgba(15,23,42,.06);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#111827;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .caps-dot{
      width:8px;height:8px;border-radius:999px;
      background:#ef4444;
      box-shadow:0 0 0 0 rgba(239,68,68,.55);
      animation:ping 1.6s infinite;
    }
    @keyframes ping{
      0%{box-shadow:0 0 0 0 rgba(239,68,68,.55);}
      80%{box-shadow:0 0 0 10px rgba(239,68,68,0);}
      100%{box-shadow:0 0 0 0 rgba(239,68,68,0);}
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      height:var(--btn-h);
      padding:0 16px;
      border-radius:999px;
      border:1px solid transparent;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      background:linear-gradient(180deg,var(--brand),var(--brand-2));
      color:#fff;
      box-shadow:0 10px 22px rgba(248,113,22,.35);
      outline:none;
      transition:transform .1s ease,box-shadow .16s ease,filter .16s ease;
    }
    .btn-outline{
      background:rgba(255,255,255,.6);
      color:#b45309;
      border-color:rgba(251,146,60,.9);
      box-shadow:var(--shadow-soft);
    }
    .btn:focus-visible{
      box-shadow:0 0 0 2px #f97316,0 0 0 6px rgba(248,250,252,.9);
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.02);}
    .btn:active{transform:translateY(0);filter:brightness(.97);}

    .card{
      background:var(--panel);
      border-radius:var(--radius-lg);
      padding:14px 16px 16px;
      border:1px solid rgba(255,255,255,.86);
      box-shadow:var(--shadow-soft);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    }

    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .card-title{
      font-weight:700;
      font-size:14px;
      letter-spacing:.03em;
      text-transform:uppercase;
      color:#111827;
    }

    .field-row{
      display:grid;
      grid-template-columns:minmax(180px,260px) minmax(160px,220px) auto;
      gap:10px;
      align-items:flex-end;
    }
    @media (max-width:640px){
      .field-row{grid-template-columns:1fr}
    }

    .field label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--muted);
      margin-bottom:4px;
    }
    input[type="text"], select{
      width:100%;
      height:var(--btn-h);
      border-radius:var(--radius-md);
      border:1px solid var(--line);
      padding:0 14px;
      font-size:13px;
      background-color:rgba(255,255,255,.9);
      color:var(--fg);
      outline:none;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.65),0 8px 18px rgba(148,93,40,.16);
    }
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#b45309 50%),linear-gradient(135deg,#b45309 50%,transparent 50%);background-position:calc(100% - 16px) 17px,calc(100% - 11px) 17px;background-size:6px 6px,6px 6px;background-repeat:no-repeat;padding-right:30px;}
    input[readonly]{background:rgba(255,255,255,.8);}

    /* Slots table */
    .slots-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .slots-head small{font-size:12px;color:var(--muted);}
    .channel-count{font-size:12px;color:var(--muted);}

    .slots{
      border-radius:20px;
      border:1px solid rgba(248,250,252,.9);
      background:rgba(255,255,255,.7);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 10px 24px rgba(148,93,40,.18);
      padding:6px 0;
      max-height:520px;
      overflow:auto;
    }
    .slot-row{
      display:grid;
      grid-template-columns:46px minmax(140px,260px) minmax(220px,1fr);
      gap:6px;
      align-items:center;
      padding:6px 10px;
    }
    .slot-row:nth-child(odd){
      background:linear-gradient(90deg,rgba(255,255,255,.9),rgba(255,255,255,.75));
    }
    .slot-index{
      font-weight:600;
      font-size:12px;
      color:#9f1239;
    }
    .slot-select-wrap select{
      height:36px;
      border-radius:999px;
      font-size:12px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.8),0 3px 8px rgba(148,93,40,.20);
    }
    .slot-url input{
      height:36px;
      border-radius:999px;
      font-size:11px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      padding-right:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    @media (max-width:680px){
      .slot-row{
        grid-template-columns:34px 1fr;
        grid-template-rows:auto auto;
      }
      .slot-url{grid-column:1/-1}
    }

    .slots-actions{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .status-msg{
      font-size:12px;
      color:#065f46;
    }

    .footer-tip{
      font-size:11px;
      color:rgba(31,41,55,.8);
      margin-top:4px;
    }
  </style>
</head>
<body>
  <div class="page stack">
    <!-- HEADER -->
    <header class="head">
      <div class="brand">
        <div class="logo-badge">
          <img id="bfaLogo" class="logo-img" alt="BFA logo" />
        </div>
        <div class="titles">
          <h1>BFA IPTV — Wall Layout Editor</h1>
          <p class="sub">Choose grid and assign channels. <code>wall-display.html</code> will follow this layout.</p>
        </div>
      </div>
      <div class="head-right">
        <div class="caps-pill">
          <span class="caps-dot"></span>
          <span>Editor · laptop only</span>
        </div>
        <button id="loadBtn" class="btn-outline" type="button">Load channel list</button>
      </div>
    </header>

    <!-- GRID + SHEET CARD -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">Setup</div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Backing Apps Script URL</label>
          <input type="text" value="https://script.google.com/macros/s/AKfycbxDqMW48Yrkt-m942pipz7HtMOk0lwJp8O_LQHIQR-OM06sytw9U-HNQIrbpOjS4VQS/exec" readonly />
        </div>
        <div class="field">
          <label>Grid</label>
          <select id="gridSelect">
            <!-- filled by JS -->
          </select>
        </div>
        <p class="sub">Each tile is 16:9 inside the grid. Choose the grid you want for the wall-display player (1920×1080).</p>
      </div>
    </section>

    <!-- SLOTS CARD -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">Slots</div>
        <div class="channel-count" id="channelCountText">Channel list not loaded yet.</div>
      </div>
      <div class="slots-head">
        <small>For each slot, pick a channel from your sheet. Empty = no tile.</small>
        <small id="rowsInfo"></small>
      </div>
      <div id="slotsContainer" class="slots"></div>

      <div class="slots-actions">
        <button id="saveBtn" class="btn" type="button">Save layout to backend</button>
        <button id="reloadBtn" class="btn-outline" type="button">Reload layout</button>
        <span id="statusMsg" class="status-msg"></span>
      </div>

      <p class="footer-tip">
        Tip: open <code>wall-display.html</code> on the BrightSign. After you hit “Save layout”, the wall will refresh (every ~30–60s) and follow your changes.
      </p>
    </section>
  </div>

  <script>
    /************* CONFIG *************/
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxDqMW48Yrkt-m942pipz7HtMOk0lwJp8O_LQHIQR-OM06sytw9U-HNQIrbpOjS4VQS/exec';

    const GRID_PRESETS = [
      { id:'2x2', label:'2 × 2 (4 screens)',  cols:2, rows:2 },
      { id:'3x2', label:'3 × 2 (6 screens)',  cols:3, rows:2 },
      { id:'4x3', label:'4 × 3 (12 screens)', cols:4, rows:3 },
      { id:'5x3', label:'5 × 3 (15 screens)', cols:5, rows:3 },
      { id:'6x4', label:'6 × 4 (24 screens)', cols:6, rows:4 }
    ];

    /************* DOM SHORTCUTS *************/
    const gridSelect   = document.getElementById('gridSelect');
    const slotsContainer = document.getElementById('slotsContainer');
    const statusMsg    = document.getElementById('statusMsg');
    const channelCountText = document.getElementById('channelCountText');
    const rowsInfo     = document.getElementById('rowsInfo');
    const loadBtn      = document.getElementById('loadBtn');
    const saveBtn      = document.getElementById('saveBtn');
    const reloadBtn    = document.getElementById('reloadBtn');
    const logoImg      = document.getElementById('bfaLogo');

    /************* LOGO *************/
    (function initLogo(){
      const LOGO_PRIMARY = '/IPTV-/icons/icon-192.png';
      const FALLBACK = 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#ffb86c" offset="0"/><stop stop-color="#ff6a00" offset="1"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="16" fill="url(#g)"/><text x="50%" y="52%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-weight="800" font-size="22" fill="#fff">BFA</text></svg>');
      logoImg.src = LOGO_PRIMARY;
      logoImg.onerror = () => { logoImg.onerror = null; logoImg.src = FALLBACK; };
    })();

    /************* STATE *************/
    let allChannels = [];
    let currentPreset = GRID_PRESETS[1]; // default 3x2

    /************* UTIL *************/
    function showStatus(text, isError=false){
      statusMsg.textContent = text || '';
      statusMsg.style.color = isError ? '#b91c1c' : '#065f46';
    }
    function setChannelCount(n){
      if(!n){
        channelCountText.textContent = 'Channel list not loaded yet.';
      } else {
        channelCountText.textContent = `Channel list: ${n} channel(s) loaded.`;
      }
    }
    const isUrl = (u)=>/^https?:\/\/\S+$/i.test((u||'').trim());

    function getPresetByColsRows(cols,rows){
      return GRID_PRESETS.find(p=>p.cols===cols && p.rows===rows) || GRID_PRESETS[1];
    }

    /************* BUILD SLOT ROWS *************/
    function buildSlotRows(preset){
      if(!preset) preset = currentPreset;
      currentPreset = preset;

      const totalSlots = preset.cols * preset.rows;
      rowsInfo.textContent = `${preset.cols} × ${preset.rows} = ${totalSlots} slot(s)`;
      slotsContainer.innerHTML = '';

      for(let i=1;i<=totalSlots;i++){
        const row = document.createElement('div');
        row.className = 'slot-row';
        row.dataset.slot = String(i);
        row.innerHTML = `
          <div class="slot-index">${i}</div>
          <div class="slot-select-wrap">
            <select class="slot-select">
              <option value="">— Empty —</option>
            </select>
          </div>
          <div class="slot-url">
            <input class="slot-url-input" type="text" readonly placeholder="Preview URL" />
          </div>
        `;
        slotsContainer.appendChild(row);
      }
      populateSelectsFromChannels();
    }

    function populateSelectsFromChannels(){
      const rows = Array.from(slotsContainer.querySelectorAll('.slot-row'));
      rows.forEach(row=>{
        const select = row.querySelector('.slot-select');
        const urlInput = row.querySelector('.slot-url-input');
        const prev = select.value;

        select.innerHTML = '<option value="">— Empty —</option>';

        allChannels.forEach(ch=>{
          const opt = document.createElement('option');
          opt.value = ch.id;
          opt.textContent = `${ch.id} — ${ch.name || 'Channel '+ch.id}`;
          select.appendChild(opt);
        });

        select.addEventListener('change',()=>{
          const id = Number(select.value||'0');
          const ch = allChannels.find(c=>c.id===id);
          urlInput.value = ch ? ch.url : '';
        });

        // keep previous selection if still valid
        if(prev){
          select.value = prev;
          const id = Number(prev);
          const ch = allChannels.find(c=>c.id===id);
          urlInput.value = ch ? ch.url : '';
        }
      });
    }

    /************* BACKEND: LOAD CHANNELS (fn=list) *************/
    async function loadChannelList(){
      showStatus('Loading channel list…');
      try{
        const res = await fetch(WEBAPP_URL+'?fn=list',{cache:'no-store'});
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || 'Backend error');
        allChannels = Array.isArray(data.channels)?data.channels:[];
        setChannelCount(allChannels.length);
        populateSelectsFromChannels();
        showStatus('Channel list loaded ✔');
      }catch(err){
        console.error(err);
        allChannels = [];
        setChannelCount(0);
        showStatus('Error loading channel list.',true);
      }
    }

    /************* BACKEND: LOAD EXISTING LAYOUT (fn=getwall) *************/
    async function loadLayoutFromBackend(){
      showStatus('Loading layout…');
      try{
        const res = await fetch(WEBAPP_URL+'?fn=getwall',{cache:'no-store'});
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || 'Backend error');

        const cols = Number(data.cols)||3;
        const rows = Number(data.rows)||2;
        const tiles = Array.isArray(data.tiles)?data.tiles:[];

        currentPreset = getPresetByColsRows(cols,rows);
        gridSelect.value = currentPreset.id;
        buildSlotRows(currentPreset);

        const slotMap = new Map();
        tiles.forEach(t=>{
          if(t && t.slot && t.channelId){
            slotMap.set(Number(t.slot),Number(t.channelId));
          }
        });

        const rowsDom = Array.from(slotsContainer.querySelectorAll('.slot-row'));
        rowsDom.forEach(row=>{
          const slot = Number(row.dataset.slot);
          const chId = slotMap.get(slot);
          const select = row.querySelector('.slot-select');
          const urlInput = row.querySelector('.slot-url-input');
          if(chId){
            select.value = chId;
            const ch = allChannels.find(c=>c.id===chId);
            urlInput.value = ch ? ch.url : '';
          }
        });

        showStatus('Layout loaded ✔');
      }catch(err){
        console.error(err);
        showStatus('Could not load existing layout (starting fresh).',true);
        buildSlotRows(currentPreset);
      }
    }

    /************* BACKEND: SAVE LAYOUT (fn=setwall) *************/
    async function saveLayoutToBackend(){
      const rowsDom = Array.from(slotsContainer.querySelectorAll('.slot-row'));
      const tiles = [];
      rowsDom.forEach(row=>{
        const slot = Number(row.dataset.slot);
        const select = row.querySelector('.slot-select');
        const chId = Number(select.value||'0');
        if(!chId) return;
        tiles.push({slot,channelId:chId});
      });

      const payload = {
        cols: currentPreset.cols,
        rows: currentPreset.rows,
        tiles
      };

      showStatus('Saving layout…');
      try{
        const res = await fetch(WEBAPP_URL+'?fn=setwall',{
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body:JSON.stringify(payload)
        });
        // Apps Script returns JSON; but if something odd happens, treat 200 as OK
        let data = {};
        try{ data = await res.json(); } catch(e){}
        if(!res.ok || (data.ok === false)){
          throw new Error((data && data.error) || 'Backend error');
        }
        showStatus('Layout saved ✔ Wall will follow this layout.');
      }catch(err){
        console.error(err);
        showStatus('Error saving layout.',true);
      }
    }

    /************* INIT DROPDOWN, EVENTS, FIRST LOAD *************/
    function initUI(){
      // grid select options
      GRID_PRESETS.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.label;
        gridSelect.appendChild(opt);
      });
      gridSelect.value = currentPreset.id;
      buildSlotRows(currentPreset);

      gridSelect.addEventListener('change',()=>{
        const preset = GRID_PRESETS.find(p=>p.id===gridSelect.value) || GRID_PRESETS[1];
        currentPreset = preset;
        buildSlotRows(preset);
      });

      loadBtn.addEventListener('click',loadChannelList);
      reloadBtn.addEventListener('click',loadLayoutFromBackend);
      saveBtn.addEventListener('click',saveLayoutToBackend);
    }

    (async function main(){
      initUI();
      await loadChannelList();
      await loadLayoutFromBackend();
    })();
  </script>
</body>
</html>
