<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BFA IPTV — Monitor Wall</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

<style>
  :root{
    --accent:#ff9500;

    /* Home-page gradient */
    --bg-start:#fff4e4;
    --bg-mid:#ffd293;
    --bg-end:#ff9500;

    --fg:#111;
    --muted:#6e6e73;

    --panel:rgba(255,255,255,.58);
    --tile:rgba(255,255,255,.46);
    --tileHover:rgba(255,149,0,.08);

    --border:rgba(15,23,42,.10);
    --borderStrong:rgba(15,23,42,.18);
    --shadow:0 14px 34px rgba(15,23,42,.08), 0 2px 8px rgba(15,23,42,.05);

    --glass-blur:16px;
    --glass-sat:140%;

    --radius-outer:26px;
    --radius-card:20px;
  }

  body.dark{
    --bg-start:#0b0c10;
    --bg-mid:#0d1016;
    --bg-end:#10141b;

    --fg:#f7f7f8;
    --muted:#a1a1a8;

    --panel:rgba(21,21,23,.56);
    --tile:rgba(26,26,29,.50);
    --tileHover:rgba(255,149,0,.10);

    --border:rgba(255,255,255,.10);
    --borderStrong:rgba(255,255,255,.20);
    --shadow:0 18px 46px rgba(0,0,0,.36), 0 2px 8px rgba(0,0,0,.22);

    --glass-blur:14px;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:var(--fg);
    overflow:hidden;
    background:transparent;
  }
  body::before{
    content:"";
    position:fixed; inset:0; z-index:-1; pointer-events:none;
    background:linear-gradient(180deg,var(--bg-start) 0%, var(--bg-mid) 52%, var(--bg-end) 100%);
  }

  .frame{height:100%; padding:16px}
  .shell{
    height:100%;
    border-radius:var(--radius-outer);
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 14px 12px;
    border-bottom:1px solid var(--border);
    gap:12px;
  }
  .brand{display:flex; align-items:center; gap:12px; min-width:0}
  .logo{
    width:38px;height:38px;border-radius:10px;
    border:1px solid var(--border);
    background:#fff center/cover no-repeat;
  }
  .titles{min-width:0}
  .title{font-weight:900; letter-spacing:.2px; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .sub{color:var(--muted); font-size:12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  .actions{display:flex; align-items:center; gap:8px}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    background:var(--tile);
    border:1px solid var(--borderStrong);
    font-size:12px; font-weight:800;
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    white-space:nowrap;
  }
  .dot{width:9px;height:9px;border-radius:99px;background:#22c55e; box-shadow:0 0 10px rgba(34,197,94,.65)}
  .btn{
    height:36px; padding:0 12px; border-radius:999px;
    border:1.5px solid var(--borderStrong);
    background:var(--tile);
    cursor:pointer;
    font-weight:900;
  }
  .btn:hover{border-color:var(--accent)}
  .btn.accent{border-color:var(--accent); color:var(--accent); background:transparent}

  .layout{flex:1; min-height:0; display:flex; flex-direction:column; gap:12px; padding:12px}
  .card{
    background:var(--tile);
    border:1px solid var(--border);
    border-radius:var(--radius-card);
    box-shadow:0 10px 26px rgba(15,23,42,.06);
    backdrop-filter:blur(calc(var(--glass-blur) - 4px)) saturate(var(--glass-sat));
    -webkit-backdrop-filter:blur(calc(var(--glass-blur) - 4px)) saturate(var(--glass-sat));
    overflow:hidden;
  }

  /* HERO */
  .hero{flex:1; min-height:0; display:flex; flex-direction:column}
  .hero-inner{position:relative; width:100%; height:100%}
  .hero-16x9{position:absolute; inset:0}
  .hero-16x9 video{width:100%; height:100%; object-fit:cover; background:#000; display:block}
  .hero-overlay{
    position:absolute; left:0; right:0; bottom:0;
    padding:10px 12px;
    background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.78) 70%, rgba(0,0,0,.9) 100%);
    color:#fff;
    display:flex; justify-content:space-between; align-items:flex-end;
    gap:10px;
  }
  .hero-left{min-width:0}
  .hero-name{font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .hero-meta{font-size:12px; opacity:.85; margin-top:2px}
  .tag{
    background:rgba(255,255,255,.92);
    color:#111;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    font-weight:900;
    display:flex; align-items:center; gap:8px;
    border:1px solid rgba(255,255,255,.6);
  }
  .tag .dot{background:#22c55e}

  /* DOCK */
  .dock-head{
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 12px;
    border-bottom:1px solid var(--border);
    color:var(--muted);
    font-size:12px;
    font-weight:800;
  }
  .dock{
    padding:12px;
    display:grid;
    gap:10px;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  }
  @media (max-width:760px){
    .dock{grid-template-columns:repeat(2, minmax(0, 1fr))}
    .sub{display:none}
  }

  .tile{
    border-radius:16px;
    overflow:hidden;
    border:1px solid var(--borderStrong);
    background:#0b0c10;
    position:relative;
    transform:translateZ(0);
  }
  .tile video{
    width:100%; aspect-ratio:16/9;
    display:block;
    object-fit:cover;
    background:#000;
  }
  .tile-bar{
    position:absolute; left:0; right:0; bottom:0;
    padding:6px 8px;
    background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.86) 60%, rgba(0,0,0,.92) 100%);
    color:#fff;
    display:flex; justify-content:space-between; align-items:center;
    gap:8px;
    font-size:11px;
  }
  .tname{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%}
  .tstat{opacity:.9}
  .tstat.err{color:#fecaca}
  .tstat.idle{color:#cbd5e1}

  .banner{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:#ff453a; color:#fff; font-weight:900;
    padding:10px 14px; border-radius:999px;
    box-shadow:0 18px 40px rgba(0,0,0,.28);
    display:none; z-index:9999;
    max-width:min(92vw,820px);
    text-align:center;
  }
</style>
</head>

<body>
<div class="frame">
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="logo" id="logo" style="background-image:url('/IPTV-/icons/icon-192.png')"></div>
        <div class="titles">
          <div class="title">BFA IPTV — Monitor Wall</div>
          <div class="sub">All streams running • Auto-recover • Wake Lock • 16:9 thumbnails</div>
        </div>
      </div>

      <div class="actions">
        <div class="pill"><span class="dot"></span><span id="statusLabel">Starting…</span></div>
        <button class="btn" id="btnTheme">Theme</button>
        <button class="btn accent" id="btnReload">Reload</button>
      </div>
    </div>

    <div class="layout">
      <div class="card hero">
        <div class="hero-inner">
          <div class="hero-16x9">
            <video id="heroVideo" autoplay muted playsinline></video>
          </div>
          <div class="hero-overlay">
            <div class="hero-left">
              <div class="hero-name" id="heroName">—</div>
              <div class="hero-meta" id="heroMeta">Loading…</div>
            </div>
            <div class="tag"><span class="dot"></span><span id="heroTag">LIVE • 0/0</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="dock-head">
          <span>Channel dock</span>
          <span id="dockSummary">—</span>
        </div>
        <div id="dock" class="dock"></div>
      </div>
    </div>
  </div>
</div>

<div id="banner" class="banner"></div>

<script>
/* =========================
   CONFIG
========================= */
const CONFIG = {
  ROTATE_SECONDS: 25,
  AUTO_RELOAD_HOURS: 8, // helps long-running stability
  channels: [
    { name:"Sport 1", url:"https://amg02298-nuvyoo-amg02298c4-tablo-us-8942.playouts.now.amagi.tv/playlist.m3u8" },
    { name:"Sport 2", url:"https://amg01334-amg01334c2-tablo-us-7356.playouts.now.amagi.tv/playlist.m3u8" },
    { name:"Sport 3", url:"https://fl31.moveonjoy.com/CBS_SPORTS_NETWORK/index.m3u8" },
    { name:"Sport 4", url:"https://37b4c228.wurl.com/master/f36d25e7e52f1ba8d7e56eb859c636563214f541/UmFrdXRlblRWLWZyX0ZJRkFQbHVzRnJlbmNoX0hMUw/playlist.m3u8" },
    { name:"Sport 5", url:"https://amg01416-amg01416c4-tablo-us-4553.playouts.now.amagi.tv/playlist.m3u8" },
    { name:"Sport 6", url:"https://dazn-combat-rakuten.amagi.tv/hls/amagi_hls_data_rakutenAA-dazn-combat-rakuten/CDN/master.m3u8" },
    { name:"Sport 7", url:"https://fl1.moveonjoy.com/SNY/index.m3u8" }
  ]
};

const isUrl = u => /^https?:\/\/\S+$/i.test((u||"").trim());
const $ = sel => document.querySelector(sel);

const statusLabel = $("#statusLabel");
const dock = $("#dock");
const dockSummary = $("#dockSummary");
const banner = $("#banner");

const heroVideo = $("#heroVideo");
const heroNameEl = $("#heroName");
const heroMetaEl = $("#heroMeta");
const heroTagEl  = $("#heroTag");

let CHANNELS = [];
let heroIndex = 0;
let rotateTimer = null;
let wakeLock = null;

const controllers = new Map(); // key -> {hls, video, url, lastGood, role}

/* =========================
   UI helpers
========================= */
function showBanner(msg){
  banner.textContent = msg;
  banner.style.display = "block";
  clearTimeout(showBanner._t);
  showBanner._t = setTimeout(()=> banner.style.display="none", 5000);
}

/* =========================
   Wake Lock (prevents “idle/white” on supported browsers)
========================= */
async function requestWakeLock(){
  try{
    if (!("wakeLock" in navigator)) return;
    wakeLock = await navigator.wakeLock.request("screen");
    wakeLock.addEventListener("release", ()=>{ /* released */ });
  }catch(e){
    // ignore
  }
}
document.addEventListener("visibilitychange", ()=>{
  if (document.visibilityState === "visible") requestWakeLock();
});

/* =========================
   HLS attach with recovery
========================= */
function destroyController(key){
  const c = controllers.get(key);
  if (!c) return;
  try{
    if (c.hls) c.hls.destroy();
  }catch(e){}
  try{
    c.video.pause();
    c.video.removeAttribute("src");
    c.video.load();
  }catch(e){}
  controllers.delete(key);
}

function attachStream({ key, video, url, statusEl, lowLatency=false }){
  destroyController(key);

  statusEl && (statusEl.textContent = "Loading…");
  const record = {
    key,
    video,
    url,
    hls: null,
    lastGood: Date.now(),
    role: key.startsWith("hero") ? "hero" : "dock"
  };

  // iOS friendliness
  video.muted = true;
  video.autoplay = true;
  video.playsInline = true;
  video.setAttribute("playsinline", "");
  video.setAttribute("webkit-playsinline", "");

  function markGood(){
    record.lastGood = Date.now();
  }

  function setStatus(text, cls){
    if (!statusEl) return;
    statusEl.textContent = text;
    statusEl.className = "tstat" + (cls ? " " + cls : "");
  }

  // Video events for “is it alive”
  ["playing","timeupdate","canplay"].forEach(ev => video.addEventListener(ev, markGood, {passive:true}));
  video.addEventListener("stalled", ()=> setStatus("Stalled", "idle"));
  video.addEventListener("waiting", ()=> setStatus("Buffering", "idle"));
  video.addEventListener("error", ()=> setStatus("Video error", "err"));

  if (window.Hls && Hls.isSupported()){
    const hls = new Hls({
      enableWorker: true,
      lowLatencyMode: !!lowLatency,
      // keep memory under control on long-running pages
      backBufferLength: 10,
      maxBufferLength: 12,
      liveSyncDurationCount: 3,
      liveMaxLatencyDurationCount: 8
    });

    record.hls = hls;
    hls.loadSource(url);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
      video.play().then(()=>{
        setStatus("LIVE");
        markGood();
      }).catch(()=>{
        setStatus("Tap", "idle");
      });
    });

    hls.on(Hls.Events.ERROR, (_, data)=>{
      if (!data || !data.fatal) return;

      // Recovery strategy recommended for HLS.js fatal errors
      if (data.type === Hls.ErrorTypes.NETWORK_ERROR){
        setStatus("Reconnecting…", "idle");
        try{ hls.startLoad(); }catch(e){}
        return;
      }

      if (data.type === Hls.ErrorTypes.MEDIA_ERROR){
        setStatus("Recovering…", "idle");
        try{ hls.recoverMediaError(); }catch(e){}
        return;
      }

      setStatus("Error", "err");
      showBanner(`Stream error: ${url}`);
      // last resort: full rebuild after delay
      setTimeout(()=> attachStream({ key, video, url, statusEl, lowLatency }), 2000);
    });
  } else if (video.canPlayType("application/vnd.apple.mpegurl")){
    video.src = url;
    video.play().then(()=>{
      setStatus("LIVE");
      markGood();
    }).catch(()=> setStatus("Tap", "idle"));
  } else {
    video.src = url;
    setStatus("HLS?", "idle");
  }

  controllers.set(key, record);
}

/* =========================
   Hero rotation
========================= */
function loadHero(idx){
  if (!CHANNELS.length) return;
  heroIndex = (idx + CHANNELS.length) % CHANNELS.length;
  const ch = CHANNELS[heroIndex];

  heroNameEl.textContent = ch.name || `Channel ${heroIndex+1}`;
  heroMetaEl.textContent = "Loading…";
  heroTagEl.textContent = `LIVE • ${heroIndex+1}/${CHANNELS.length}`;

  attachStream({
    key: "hero",
    video: heroVideo,
    url: ch.url,
    statusEl: {
      set textContent(v){ heroMetaEl.textContent = v; },
      set className(_){} // ignore
    },
    lowLatency: true
  });

  restartRotation();
}

function restartRotation(){
  if (rotateTimer) clearInterval(rotateTimer);
  if (CHANNELS.length <= 1) return;
  rotateTimer = setInterval(()=> loadHero(heroIndex + 1), (CONFIG.ROTATE_SECONDS || 25) * 1000);
}

/* =========================
   Dock build
========================= */
function buildDock(){
  dock.innerHTML = "";
  CHANNELS.forEach((ch, i)=>{
    const wrap = document.createElement("div");
    wrap.className = "tile";

    const v = document.createElement("video");
    v.autoplay = true;
    v.muted = true;
    v.playsInline = true;

    const bar = document.createElement("div");
    bar.className = "tile-bar";

    const name = document.createElement("div");
    name.className = "tname";
    name.textContent = ch.name || `Channel ${i+1}`;

    const stat = document.createElement("div");
    stat.className = "tstat";
    stat.textContent = "Loading…";

    bar.appendChild(name);
    bar.appendChild(stat);

    wrap.appendChild(v);
    wrap.appendChild(bar);

    wrap.addEventListener("click", ()=> loadHero(i));
    dock.appendChild(wrap);

    attachStream({ key:`dock-${i}`, video:v, url:ch.url, statusEl:stat, lowLatency:false });
  });

  dockSummary.textContent = `${CHANNELS.length} stream${CHANNELS.length>1?"s":""} live`;
}

/* =========================
   Watchdog (reload stuck videos)
========================= */
function startWatchdog(){
  setInterval(()=>{
    const now = Date.now();
    controllers.forEach((c)=>{
      const age = now - c.lastGood;
      // If no “good” signal for 30s, rebuild that player
      if (age > 30000){
        const key = c.key;
        attachStream({
          key,
          video: c.video,
          url: c.url,
          statusEl: key === "hero" ? { set textContent(v){ heroMetaEl.textContent=v; }, set className(_){} } : c.video.parentElement.querySelector(".tstat"),
          lowLatency: key === "hero"
        });
      }
    });
  }, 15000);
}

/* =========================
   Theme
========================= */
function setTheme(next){
  document.body.classList.toggle("dark", next === "dark");
  localStorage.setItem("bfa_theme_wall", next);
}
(function initTheme(){
  const saved = localStorage.getItem("bfa_theme_wall");
  if (saved) setTheme(saved);
})();

$("#btnTheme").addEventListener("click", ()=>{
  const isDark = document.body.classList.contains("dark");
  setTheme(isDark ? "light" : "dark");
});
$("#btnReload").addEventListener("click", ()=> location.reload());

/* =========================
   Init
========================= */
function init(){
  CHANNELS = CONFIG.channels.filter(c => c && isUrl(c.url));
  if (!CHANNELS.length){
    statusLabel.textContent = "No valid channels";
    showBanner("Add valid HLS URLs in CONFIG.channels.");
    return;
  }

  requestWakeLock();
  statusLabel.textContent = `Running • ${CHANNELS.length} channels`;

  buildDock();
  loadHero(0);
  startWatchdog();

  // Auto reload (stability on long-running displays)
  setTimeout(()=> location.reload(), (CONFIG.AUTO_RELOAD_HOURS || 8) * 3600 * 1000);

  // network regain
  window.addEventListener("online", ()=> {
    showBanner("Back online — refreshing streams…");
    location.reload();
  });
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
