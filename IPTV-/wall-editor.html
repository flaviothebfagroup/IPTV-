<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BFA IPTV — Liquid Glass Monitor Wall</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

<style>
  :root{
    --accent:#ff9500;

    /* Home-page background tokens you posted */
    --bg-start:#fff4e4;
    --bg-mid:#ffd293;
    --bg-end:#ff9500;

    --fg:#0f172a;
    --muted:#94a3b8;

    --shell-radius:32px;
    --card-radius:24px;

    --shadow-strong:0 32px 90px rgba(15,23,42,.22);
    --shadow-soft:0 20px 60px rgba(15,23,42,.18);
  }

  *{box-sizing:border-box;margin:0;padding:0;}
  html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--fg);}

  /* Full-viewport gradient (non-cropping) */
  body{background:transparent;}
  body::before{
    content:"";
    position:fixed;inset:0;z-index:-1;pointer-events:none;
    background:linear-gradient(180deg,var(--bg-start) 0%, var(--bg-mid) 52%, var(--bg-end) 100%);
  }

  .frame{position:relative;width:100%;height:100%;padding:22px;}
  .shell{
    position:relative;width:100%;height:100%;
    border-radius:var(--shell-radius);
    background:rgba(255,255,255,.62);
    box-shadow:var(--shadow-strong);
    padding:18px 22px 20px;
    display:flex;flex-direction:column;
    backdrop-filter:blur(18px) saturate(140%);
    -webkit-backdrop-filter:blur(18px) saturate(140%);
    border:1px solid rgba(15,23,42,.08);
  }

  .shell-header{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-bottom:14px;}
  .brand-left{display:flex;align-items:center;gap:16px;min-width:0;}
  .logo-wrap{
    width:56px;height:56px;border-radius:18px;
    background:linear-gradient(180deg,#fff 0%, #ffe3b5 50%, #ffc06a 100%);
    border:1px solid rgba(15,23,42,.10);
    box-shadow:0 18px 40px rgba(15,23,42,.14);
    display:flex;align-items:center;justify-content:center;overflow:hidden;
  }
  .logo{width:42px;height:42px;border-radius:12px;display:block;}
  .brand-text{min-width:0;}
  .brand-title{font-size:20px;font-weight:900;letter-spacing:.01em;}
  .brand-sub{font-size:12px;color:#64748b;margin-top:4px;}

  .pill{
    padding:8px 14px;border-radius:999px;
    background:rgba(15,23,42,.90);
    border:1px solid rgba(255,255,255,.16);
    color:#e5e7eb;font-size:11px;
    display:inline-flex;align-items:center;gap:8px;
    box-shadow:0 18px 40px rgba(15,23,42,.22);
    white-space:nowrap;
  }
  .pill-dot{width:9px;height:9px;border-radius:999px;background:#22c55e;box-shadow:0 0 10px rgba(34,197,94,.55);}
  .pill-dot.warn{background:#f59e0b;box-shadow:0 0 10px rgba(245,158,11,.55);}
  .pill-dot.err{background:#ef4444;box-shadow:0 0 10px rgba(239,68,68,.55);}

  .layout{flex:1;min-height:0;display:flex;flex-direction:column;gap:14px;}

  .hero-wrap{flex:1;min-height:0;display:flex;align-items:center;justify-content:center;}
  .hero-shell{
    width:100%;max-width:1420px;border-radius:var(--card-radius);
    background:rgba(2,6,23,.92);
    box-shadow:var(--shadow-soft);
    border:1px solid rgba(15,23,42,.65);
    overflow:hidden;position:relative;
  }
  .hero-16x9{position:relative;width:100%;height:0;padding-top:56.25%;}
  .hero-16x9 video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;display:block;}

  .hero-overlay{
    position:absolute;left:0;right:0;bottom:0;
    padding:12px 16px 14px;display:flex;justify-content:space-between;align-items:flex-end;
    pointer-events:none;
    background:linear-gradient(180deg,rgba(15,23,42,0) 0%,rgba(15,23,42,.35) 35%,rgba(3,7,18,.96) 100%);
    backdrop-filter:blur(14px) saturate(140%);
    -webkit-backdrop-filter:blur(14px) saturate(140%);
  }
  .hero-left{max-width:70%;}
  .hero-kicker{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:rgba(226,232,240,.85);margin-bottom:4px;}
  .hero-name{font-weight:900;font-size:16px;color:#f9fafb;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
  .hero-meta{font-size:11px;color:#cbd5f5;margin-top:4px;}

  .hero-tag{
    padding:6px 12px;border-radius:999px;font-size:11px;
    background:rgba(255,255,255,.82);color:#020617;
    border:1px solid rgba(255,255,255,.85);
    display:flex;align-items:center;gap:7px;
  }
  .hero-tag-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;}

  .dock-shell{
    border-radius:var(--card-radius);
    background:rgba(255,255,255,.62);
    box-shadow:var(--shadow-soft);
    padding:10px 10px 12px;
    border:1px solid rgba(15,23,42,.08);
    backdrop-filter:blur(18px) saturate(140%);
    -webkit-backdrop-filter:blur(18px) saturate(140%);
  }
  .dock-title{font-size:12px;font-weight:700;color:#64748b;margin:0 2px 8px;display:flex;justify-content:space-between;align-items:center;}
  .dock-title span:last-child{font-weight:600;}

  .dock{display:grid;grid-auto-rows:1fr;gap:9px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
  .dock-item{
    position:relative;border-radius:18px;background:rgba(2,6,23,.92);
    box-shadow:0 12px 26px rgba(15,23,42,.16);
    border:1px solid rgba(15,23,42,.60);
    overflow:hidden;cursor:pointer;
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .dock-item-inner{position:relative;width:100%;height:0;padding-top:56.25%;}
  .dock-item video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;display:block;}

  .dock-overlay{
    position:absolute;left:0;right:0;bottom:0;padding:6px 9px;
    background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(0,0,0,.88) 60%,rgba(0,0,0,.98) 100%);
    display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#e5e7eb;
  }
  .dock-name{font-weight:700;max-width:70%;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
  .dock-status{font-size:10px;color:#cbd5f5;opacity:.95;}
  .dock-status.err{color:#fecaca;}
  .dock-status.idle{color:#cbd5e1;}
  .dock-status.buf{color:#fde68a;}

  .dock-item-active{transform:translateY(-3px) scale(1.02);border-color:rgba(255,149,0,.95);box-shadow:0 18px 40px rgba(255,149,0,.18), 0 16px 40px rgba(15,23,42,.18);}
  .hint{margin-top:4px;font-size:11px;color:#64748b;text-align:right;}
  .err-banner{
    position:absolute;left:50%;bottom:24px;transform:translateX(-50%);
    background:rgba(239,68,68,.96);color:#fff;padding:7px 14px;border-radius:999px;
    font-size:11px;box-shadow:0 18px 44px rgba(0,0,0,.25);display:none;z-index:40;
  }

  @media (max-width:1100px){
    .shell{padding:14px 14px 18px;}
    .shell-header{flex-direction:column;align-items:flex-start;gap:10px;}
    .pill{align-self:flex-end;}
  }
</style>
</head>

<body>
<div class="frame">
  <div class="shell">
    <header class="shell-header">
      <div class="brand-left">
        <div class="logo-wrap">
          <img class="logo" src="/IPTV-/icons/icon-192.png" alt="BFA logo"
               onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2242%22 height=%2242%22 viewBox=%220 0 42 42%22%3E%3Crect width=%2242%22 height=%2242%22 rx=%2212%22 fill=%22%23ff9500%22/%3E%3Ctext x=%2250%25%22 y=%2257%25%22 text-anchor=%22middle%22 font-size=%2214%22 font-family=%22system-ui%22 font-weight=%22900%22 fill=%22%23000%22%3EBFA%3C/text%3E%3C/svg%3E';">
        </div>
        <div class="brand-text">
          <div class="brand-title">BFA IPTV — Monitor Wall</div>
          <div class="brand-sub">Hero channel on top • Dock thumbnails all live • Self-healing streams</div>
        </div>
      </div>

      <div class="pill">
        <span id="pillDot" class="pill-dot"></span>
        <span id="statusLabel">Starting…</span>
      </div>
    </header>

    <section class="layout">
      <div class="hero-wrap">
        <div class="hero-shell">
          <div class="hero-16x9">
            <video id="heroVideo" autoplay muted playsinline></video>
            <div class="hero-overlay">
              <div class="hero-left">
                <div class="hero-kicker">Now showing</div>
                <div class="hero-name" id="heroName">—</div>
                <div class="hero-meta" id="heroMeta">Loading…</div>
              </div>
              <div class="hero-tag">
                <span class="hero-tag-dot" id="heroDot"></span>
                <span id="heroTagText">LIVE</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="dock-shell">
        <div class="dock-title">
          <span>Channel dock</span>
          <span id="dockSummary"></span>
        </div>
        <div id="dock" class="dock"></div>
      </div>

      <div class="hint">Tip: if a device is weak, reduce channel count or use lower-bitrate streams.</div>
    </section>
  </div>

  <div id="errBanner" class="err-banner"></div>
</div>

<script>
  // ===============================
  // 1) CONFIG (edit only this)
  // ===============================
  const CONFIG = {
    ROTATE_SECONDS: 25,            // hero auto-rotate delay
    AUTO_REFRESH_MINUTES: 180,     // optional: reload page every N minutes (set 0 to disable)
    STALL_SECONDS: 14,             // if video time doesn't advance for this long -> rebuild stream
    channels: [
      { name: "Sport 1", url: "https://amg02298-nuvyoo-amg02298c4-tablo-us-8942.playouts.now.amagi.tv/playlist.m3u8" },
      { name: "Sport 2", url: "https://amg01334-amg01334c2-tablo-us-7356.playouts.now.amagi.tv/playlist.m3u8" },
      { name: "Sport 3", url: "https://fl31.moveonjoy.com/CBS_SPORTS_NETWORK/index.m3u8" },
      { name: "Sport 4", url: "https://37b4c228.wurl.com/master/f36d25e7e52f1ba8d7e56eb859c636563214f541/UmFrdXRlblRWLWZyX0ZJRkFQbHVzRnJlbmNoX0hMUw/playlist.m3u8" },
      { name: "Sport 5", url: "https://amg01416-amg01416c4-tablo-us-4553.playouts.now.amagi.tv/playlist.m3u8" },
      { name: "Sport 6", url: "https://dazn-combat-rakuten.amagi.tv/hls/amagi_hls_data_rakutenAA-dazn-combat-rakuten/CDN/master.m3u8" },
      { name: "Sport 7", url: "https://fl1.moveonjoy.com/SNY/index.m3u8" }
    ]
  };

  // ===============================
  // 2) Helpers + state
  // ===============================
  const isUrl = u => /^https?:\/\/\S+$/i.test((u||'').trim());

  const statusLabel = document.getElementById('statusLabel');
  const pillDot     = document.getElementById('pillDot');
  const errBanner   = document.getElementById('errBanner');
  const dock        = document.getElementById('dock');
  const dockSummary = document.getElementById('dockSummary');

  const heroVideo   = document.getElementById('heroVideo');
  const heroNameEl  = document.getElementById('heroName');
  const heroMetaEl  = document.getElementById('heroMeta');
  const heroTagText = document.getElementById('heroTagText');
  const heroDot     = document.getElementById('heroDot');

  let CHANNELS = [];
  let heroIndex = 0;
  let rotateTimer = null;

  // Keep references so we can rebuild individual tiles safely
  const streamControllers = new Map(); // key: videoEl -> controller

  function showBanner(msg){
    errBanner.textContent = msg;
    errBanner.style.display = 'block';
  }
  function hideBanner(){ errBanner.style.display = 'none'; }

  // Smaller buffers = less RAM + fewer crashes
  const HLS_BASE_CONFIG = {
    enableWorker: true,
    lowLatencyMode: false,
    backBufferLength: 0,
    maxBufferLength: 8,
    maxMaxBufferLength: 16,
    maxBufferSize: 12 * 1000 * 1000, // 12MB
    liveSyncDurationCount: 2,
    liveMaxLatencyDurationCount: 4
  };

  function setPill(state){
    pillDot.classList.remove('warn','err');
    if (state === 'warn') pillDot.classList.add('warn');
    if (state === 'err')  pillDot.classList.add('err');
  }

  async function requestWakeLock(){
    try{
      if (!('wakeLock' in navigator)) return;
      const lock = await navigator.wakeLock.request('screen');
      lock.addEventListener('release', ()=>{ /* ignore */ });
      document.addEventListener('visibilitychange', async ()=>{
        try{
          if (document.visibilityState === 'visible'){
            await navigator.wakeLock.request('screen');
          }
        }catch(e){}
      });
    }catch(e){}
  }

  function buildHlsController(video, url, statusEl, label){
    let hls = null;
    let destroyed = false;
    let lastTime = 0;
    let lastTick = Date.now();

    const STALL_MS = (CONFIG.STALL_SECONDS || 14) * 1000;

    function setStatus(text, cls){
      if (!statusEl) return;
      statusEl.textContent = text;
      statusEl.className = 'dock-status' + (cls ? ' ' + cls : '');
    }

    function cleanup(){
      try{ video.pause(); }catch(e){}
      video.removeAttribute('src');
      try{ video.load(); }catch(e){}
      if (hls){
        try{ hls.destroy(); }catch(e){}
        hls = null;
      }
    }

    function start(){
      destroyed = false;
      cleanup();

      // native HLS (Safari/macOS/iOS)
      if (video.canPlayType('application/vnd.apple.mpegurl') && !Hls.isSupported()){
        video.src = url;
        video.muted = true;
        video.playsInline = true;
        video.autoplay = true;

        const p = video.play();
        if (p && p.catch){
          p.catch(()=> setStatus('Tap', 'idle'));
        } else {
          setStatus('LIVE');
        }
        return;
      }

      // Hls.js
      if (window.Hls && Hls.isSupported()){
        hls = new Hls({ ...HLS_BASE_CONFIG });
        hls.loadSource(url);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
          video.muted = true;
          video.playsInline = true;
          video.autoplay = true;
          const p = video.play();
          if (p && p.catch){
            p.then(()=> setStatus('LIVE'))
             .catch(()=> setStatus('Tap', 'idle'));
          } else {
            setStatus('LIVE');
          }
        });

        hls.on(Hls.Events.ERROR, (_, data)=>{
          if (!data || !data.fatal) return;

          // self-healing
          if (data.type === Hls.ErrorTypes.NETWORK_ERROR){
            setStatus('Reconnecting…', 'buf');
            try{ hls.startLoad(); }catch(e){ rebuild(); }
            return;
          }
          if (data.type === Hls.ErrorTypes.MEDIA_ERROR){
            setStatus('Recovering…', 'buf');
            try{ hls.recoverMediaError(); }catch(e){ rebuild(); }
            return;
          }

          // unrecoverable -> rebuild
          setStatus('Error', 'err');
          rebuild();
        });

        video.addEventListener('waiting', ()=> setStatus('Buffering…', 'buf'));
        video.addEventListener('playing', ()=> setStatus('LIVE'));
      } else {
        // last resort
        video.src = url;
        setStatus('HLS?', 'idle');
      }
    }

    function rebuild(){
      if (destroyed) return;
      cleanup();
      // backoff a bit
      setTimeout(()=>{ if (!destroyed) start(); }, 900);
    }

    function tick(){
      if (destroyed) return;

      // stall watchdog (time not advancing)
      const t = video.currentTime || 0;
      const now = Date.now();

      if (!video.paused && !video.ended){
        if (t !== lastTime){
          lastTime = t;
          lastTick = now;
        } else {
          if (now - lastTick > STALL_MS){
            setStatus('Restarting…', 'buf');
            rebuild();
            lastTick = now;
          }
        }
      }
    }

    function destroy(){
      destroyed = true;
      cleanup();
    }

    // surface controller
    start();
    return { start, rebuild, destroy, tick, label };
  }

  function attachStream(video, url, statusEl, label){
    if (!isUrl(url)){
      if (statusEl){
        statusEl.textContent = 'No URL';
        statusEl.className = 'dock-status err';
      }
      return;
    }
    const controller = buildHlsController(video, url, statusEl, label);
    streamControllers.set(video, controller);
  }

  // ===============================
  // 3) UI build
  // ===============================
  function buildDock(){
    dock.innerHTML = '';
    CHANNELS.forEach((ch, idx)=>{
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'dock-item';
      item.dataset.index = String(idx);

      const inner = document.createElement('div');
      inner.className = 'dock-item-inner';

      const v = document.createElement('video');
      v.autoplay = true;
      v.muted = true;
      v.playsInline = true;
      v.setAttribute('playsinline','');

      const overlay = document.createElement('div');
      overlay.className = 'dock-overlay';

      const nameEl = document.createElement('div');
      nameEl.className = 'dock-name';
      nameEl.textContent = ch.name || `Channel ${idx+1}`;

      const statusEl = document.createElement('div');
      statusEl.className = 'dock-status';
      statusEl.textContent = 'Loading…';

      overlay.appendChild(nameEl);
      overlay.appendChild(statusEl);
      inner.appendChild(v);
      inner.appendChild(overlay);
      item.appendChild(inner);
      dock.appendChild(item);

      attachStream(v, ch.url, statusEl, `dock:${idx}`);

      item.addEventListener('click', ()=> loadHero(idx));
    });

    dockSummary.textContent = `${CHANNELS.length} channel${CHANNELS.length>1?'s':''} live`;
  }

  // ===============================
  // 4) Hero logic
  // ===============================
  function loadHero(idx){
    if (!CHANNELS.length) return;
    if (idx < 0) idx = 0;
    if (idx >= CHANNELS.length) idx = 0;
    heroIndex = idx;

    const ch = CHANNELS[idx];
    heroNameEl.textContent = ch.name || `Channel ${idx+1}`;
    heroTagText.textContent = `LIVE • ${idx+1}/${CHANNELS.length}`;
    heroMetaEl.textContent = 'Loading…';
    heroDot.style.background = '#22c55e';

    // highlight active tile
    dock.querySelectorAll('.dock-item').forEach((el, i)=>{
      if (i === idx) el.classList.add('dock-item-active');
      else el.classList.remove('dock-item-active');
    });

    // rebuild hero stream
    const existing = streamControllers.get(heroVideo);
    if (existing) existing.destroy();
    attachStream(heroVideo, ch.url, null, `hero:${idx}`);

    restartHeroRotation();
  }

  function restartHeroRotation(){
    if (rotateTimer) clearInterval(rotateTimer);
    if (CHANNELS.length <= 1) return;
    const delay = (CONFIG.ROTATE_SECONDS || 25) * 1000;
    rotateTimer = setInterval(()=>{
      loadHero((heroIndex + 1) % CHANNELS.length);
    }, delay);
  }

  // ===============================
  // 5) Health loop + optional auto refresh
  // ===============================
  function updateHeaderStatus(){
    // count errors by scanning dock status text/classes
    const statuses = [...dock.querySelectorAll('.dock-status')];
    const errCount = statuses.filter(s => s.classList.contains('err')).length;
    const bufCount = statuses.filter(s => s.classList.contains('buf')).length;

    if (errCount > 0){
      setPill('err');
      statusLabel.textContent = `Running • ${CHANNELS.length} • ${errCount} error`;
    } else if (bufCount > 0){
      setPill('warn');
      statusLabel.textContent = `Running • ${CHANNELS.length} • buffering…`;
    } else {
      setPill('ok');
      statusLabel.textContent = `Running • ${CHANNELS.length} live`;
    }
  }

  function startHealthLoop(){
    setInterval(()=>{
      // tick all controllers (stall watchdog)
      for (const ctrl of streamControllers.values()){
        try{ ctrl.tick(); }catch(e){}
      }
      updateHeaderStatus();
    }, 1000);
  }

  function scheduleAutoRefresh(){
    const m = Number(CONFIG.AUTO_REFRESH_MINUTES || 0);
    if (!m || m <= 0) return;
    setTimeout(()=> location.reload(), m * 60 * 1000);
  }

  // ===============================
  // 6) init
  // ===============================
  function init(){
    CHANNELS = CONFIG.channels.filter(c => c && isUrl(c.url));
    if (!CHANNELS.length){
      statusLabel.textContent = 'No valid channels configured';
      showBanner('Add at least one valid URL in CONFIG.channels.');
      setPill('err');
      return;
    }

    hideBanner();
    statusLabel.textContent = `Starting • ${CHANNELS.length} channels`;
    buildDock();
    loadHero(0);

    requestWakeLock();
    startHealthLoop();
    scheduleAutoRefresh();
  }

  document.addEventListener('DOMContentLoaded', init);

  window.addEventListener('beforeunload', ()=>{
    if (rotateTimer) clearInterval(rotateTimer);
    for (const ctrl of streamControllers.values()){
      try{ ctrl.destroy(); }catch(e){}
    }
    streamControllers.clear();
  });
</script>
</body>
</html>
