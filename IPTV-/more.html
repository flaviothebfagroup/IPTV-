<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
  <title>BFA IPTV — Displays</title>

  <!-- PWA (optional) -->
  <link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
  <meta name="theme-color" content="#ffffff"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
  <link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

  <style>
    :root{
      --accent:#ff9500; --fg:#111; --muted:#6e6e73; --bg:#fff;
      --border:rgba(0,0,0,.16); --shadow:0 8px 28px rgba(0,0,0,.08);
      --panel:#fff; --tile:#f7f7f9; --border2:rgba(0,0,0,.12);
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:14px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }

    /* Navbar */
    .nav{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(180%) blur(10px);
      background:rgba(255,255,255,.75);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{
      max-width:1200px; margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; gap:16px; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px rgba(255,149,0,.15)}
    .nav-actions{display:flex; gap:8px; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--panel); color:var(--fg);
      padding:8px 12px; border-radius:12px; cursor:pointer;
      box-shadow:var(--shadow); transition:.2s transform,.2s box-shadow;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-accent{border-color:transparent;background:var(--accent);color:#fff}

    /* Page */
    .wrap{max-width:1200px; margin:22px auto; padding:0 20px}
    .header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:16px;
    }
    h1{font-size:24px; margin:0}
    .sub{color:var(--muted)}

    /* Table-like list */
    .grid{
      border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; background:var(--panel);
    }
    .row{display:grid; grid-template-columns:180px 1fr 160px 120px 120px; gap:0; align-items:center;
      border-bottom:1px solid var(--border2); padding:12px 14px;
    }
    .row.header{font-weight:600; background:var(--tile)}
    .row:last-child{border-bottom:0}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px; background:var(--tile); padding:6px 8px; border-radius:10px; border:1px solid var(--border2)}
    .status{display:inline-flex; align-items:center; gap:6px}
    .dot-ok,.dot-warn,.dot-err{width:8px;height:8px;border-radius:50%}
    .dot-ok{background:var(--ok)} .dot-warn{background:var(--warn)} .dot-err{background:var(--err)}
    .actions{display:flex; gap:8px; justify-content:flex-end}

    /* Inline preview */
    .preview{
      grid-column:1 / -1; padding:0 0 12px 0; background:linear-gradient(to bottom, rgba(0,0,0,.03), transparent);
    }
    .preview-inner{
      border-top:1px dashed var(--border2); margin-top:12px; padding-top:12px;
      border-radius:12px; overflow:hidden;
    }
    iframe{
      width:100%; height:360px; border:0; background:#000; border-radius:12px;
    }

    /* Banners */
    .banner{border:1px solid var(--border); background:var(--tile); padding:12px 14px; border-radius:14px; margin-bottom:16px}
    .banner.err{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.06)}
    .kvs{display:flex; gap:12px; flex-wrap:wrap}
    .kv{background:var(--tile); border:1px solid var(--border2); border-radius:10px; padding:6px 10px; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px}

    @media (max-width:900px){
      .row{grid-template-columns:140px 1fr 120px 110px 110px}
    }
    @media (max-width:700px){
      .row{grid-template-columns:120px 1fr 110px 90px 90px}
      .nav-inner{padding:12px}
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="dot"></div>
        <div>BFA IPTV — <span style="opacity:.8">Displays</span></div>
      </div>
      <div class="nav-actions">
        <button class="btn" id="reloadBtn" title="Reload list">Reload</button>
        <button class="btn btn-accent" id="newDisplayBtn" title="Add display (local only)">+ New</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="banner" class="banner" style="display:none"></div>

    <div class="header">
      <div>
        <h1>Displays</h1>
        <div class="sub" id="signedInAs">Connecting…</div>
      </div>
      <div class="kvs" id="envInfo" aria-hidden="true"></div>
    </div>

    <div class="grid" id="list">
      <div class="row header">
        <div>Display Code</div>
        <div>Name</div>
        <div>Dealership</div>
        <div>Status</div>
        <div class="actions">Actions</div>
      </div>
      <!-- rows injected here -->
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // ===== 0) Helper: tiny DOM utils =====
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const show = (el, on=true) => el.style.display = on ? '' : 'none';

    // ===== 1) Load central config (NO-CACHE) =====
    const CONFIG_URL = '/IPTV-/config/iptv-config.json'; // works on GitHub Pages
    async function loadConfig(){
      const res = await fetch(CONFIG_URL, { cache:'no-store' });
      if(!res.ok) throw new Error(`Config HTTP ${res.status}`);
      const json = await res.json();
      if(!json.firebaseConfig) throw new Error('Missing firebaseConfig in iptv-config.json');
      return json;
    }

    // ===== 2) Firebase (ESM CDN v11) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    let app, auth, db, appConfig = null;

    // ===== 3) UI: banners =====
    function banner(msg, type='info'){
      const el = document.getElementById('banner');
      el.className = 'banner' + (type==='err' ? ' err' : '');
      el.textContent = msg;
      show(el, true);
    }

    // ===== 4) Render list =====
    function createRow(key, item){
      // item: { code, name, dealerName, status }
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.key = key;

      const code = document.createElement('div');
      code.className = 'code';
      code.textContent = item.code || key;

      const name = document.createElement('div');
      name.textContent = item.name || '—';

      const dealer = document.createElement('div');
      dealer.textContent = item.dealerName || '—';

      const status = document.createElement('div');
      const s = (item.status || 'unknown').toLowerCase();
      const dot = document.createElement('span');
      dot.className = s === 'online' ? 'dot-ok' : s === 'warning' ? 'dot-warn' : 'dot-err';
      const holder = document.createElement('span');
      holder.className = 'status';
      const label = document.createElement('span');
      label.textContent = (item.status || 'unknown');
      holder.appendChild(dot);
      holder.appendChild(label);
      status.appendChild(holder);

      const actions = document.createElement('div');
      actions.className = 'actions';
      const btnPrev = document.createElement('button');
      btnPrev.className = 'btn';
      btnPrev.textContent = 'Preview';
      btnPrev.addEventListener('click', () => togglePreview(row, item));
      const btnOpen = document.createElement('button');
      btnOpen.className = 'btn';
      btnOpen.textContent = 'Open';
      btnOpen.addEventListener('click', () => {
        const url = displayUrl(item);
        window.open(url, '_blank', 'noopener');
      });
      actions.appendChild(btnPrev);
      actions.appendChild(btnOpen);

      row.appendChild(code);
      row.appendChild(name);
      row.appendChild(dealer);
      row.appendChild(status);
      row.appendChild(actions);
      return row;
    }

    function displayUrl(item){
      // GitHub Pages path-safe: /IPTV-/Displays/{CODE}.html
      const code = (item.code || '').trim();
      const safe = code ? encodeURIComponent(code) : 'UNKNOWN';
      return `/IPTV-/Displays/${safe}.html`;
    }

    function togglePreview(row, item){
      const existing = row.nextElementSibling;
      if(existing && existing.classList.contains('row') && existing.classList.contains('preview')){
        existing.remove();
        return;
      }
      // remove other previews (like dealership page behavior)
      $$('.row.preview').forEach(p => p.remove());

      const prevRow = document.createElement('div');
      prevRow.className = 'row preview';

      const inner = document.createElement('div');
      inner.className = 'preview-inner';
      inner.style.padding = '12px';

      const url = displayUrl(item);
      const note = document.createElement('div');
      note.style.margin = '0 0 8px 0';
      note.style.color = 'var(--muted)';
      note.textContent = `Preview: ${url}`;

      const frame = document.createElement('iframe');
      frame.loading = 'lazy';
      frame.referrerPolicy = 'no-referrer';
      frame.title = `Preview ${item.code || 'Display'}`;
      frame.src = url;

      inner.appendChild(note);
      inner.appendChild(frame);

      // make preview span full width under the list
      const holder = document.createElement('div');
      holder.style.gridColumn = '1 / -1';
      holder.appendChild(inner);

      prevRow.appendChild(holder);
      row.after(prevRow);
    }

    function renderList(snapshot){
      const list = document.getElementById('list');

      // Remove old rows (keep header)
      $$('.row:not(.header)', list).forEach(n => n.remove());

      const val = snapshot?.val?.() ?? snapshot?.val?. /* compat */ ?? snapshot?.val?.() ?? snapshot?.val;
      const items = val || {};

      const keys = Object.keys(items);
      if(keys.length === 0){
        const empty = document.createElement('div');
        empty.className = 'row';
        empty.style.color = 'var(--muted)';
        empty.innerHTML = '<div class="code">—</div><div>No displays yet</div><div>—</div><div>—</div><div class="actions"></div>';
        list.appendChild(empty);
        return;
      }

      keys.sort((a,b)=>{
        const ca = (items[a]?.code || a).toLowerCase();
        const cb = (items[b]?.code || b).toLowerCase();
        return ca.localeCompare(cb);
      });

      for(const k of keys){
        const row = createRow(k, items[k] || {});
        list.appendChild(row);
      }
    }

    // ===== 5) Add (local only) – writes to Realtime Database at /displays/{autoId} =====
    async function addDisplay(){
      const code = prompt('Display CODE (file will be Displays/{CODE}.html on GitHub Pages):');
      if(!code) return;
      const name = prompt('Display Name (optional):') || '';
      const dealerName = prompt('Dealership (optional):') || '';
      const status = 'unknown';

      const path = ref(db, 'displays');
      const node = push(path);
      await set(node, { code, name, dealerName, status, createdAt: Date.now() });
      alert('Display created in database.\n\nNote: Creating the matching file on GitHub must be done by your admin tool that talks to the GitHub API.');
    }

    // ===== 6) Boot =====
    (async function main(){
      try{
        appConfig = await loadConfig();

        // Show a bit of env info (helpful for debugging)
        const env = document.getElementById('envInfo');
        env.innerHTML = '';
        const kv = (k,v) => {
          const n = document.createElement('div'); n.className='kv'; n.textContent = `${k}: ${v}`; return n;
        };
        env.appendChild(kv('config', '/IPTV-/config/iptv-config.json'));
        env.appendChild(kv('projectId', appConfig?.firebaseConfig?.projectId || '—'));
        env.appendChild(kv('db', appConfig?.realtimePath || '/displays'));

        // Init Firebase
        app = initializeApp(appConfig.firebaseConfig);
        auth = getAuth(app);
        db = getDatabase(app);

        // Auth (anonymous by default)
        onAuthStateChanged(auth, async (user) => {
          if(!user){
            try{
              await signInAnonymously(auth);
            }catch(e){
              banner('Auth error: ' + (e?.message || e), 'err');
            }
            return;
          }
          const uid = user.uid;
          $('#signedInAs').textContent = `Signed in: ${uid.slice(0,6)}… (anonymous)`;

          // Subscribe to list
          const path = ref(db, appConfig.realtimePath || 'displays');
          onValue(path, (snap) => {
            renderList(snap);
          }, (err)=>{
            banner('Database error: ' + (err?.message || err), 'err');
          });
        });

      }catch(err){
        banner('Config error: ' + (err?.message || err), 'err');
        console.error(err);
      }

      // Buttons
      $('#reloadBtn').addEventListener('click', () => location.reload());
      $('#newDisplayBtn').addEventListener('click', addDisplay);
    })();
  </script>
</body>
</html>
