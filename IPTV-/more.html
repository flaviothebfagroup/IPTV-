<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BFA IPTV ‚Äî More</title>
  <link rel="stylesheet" href="assets/ui.css"/>
</head>
<body>
  <div class="topbar">
    <div class="lhs">
      <div id="brandLogo" class="logo" title="IPTV"></div>
      <div class="title">More</div>
    </div>
    <div class="rhs" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <a class="btn" href="home.html">‚Üê Home</a>
      <span id="adminEmail" class="muted"></span>
      <button id="themeBtn" class="btn">‚òÄÔ∏é/üåô</button>
    </div>
  </div>

  <div class="wrap">
    <div id="links" class="card">
      <h2 style="margin:0 0 8px">Apps / Quick Links</h2>
      <div class="row3">
        <div><div class="label">Title</div><input id="qlTitle" class="input" placeholder="e.g., Firebase ‚Äî Database" /></div>
        <div><div class="label">URL</div><input id="qlHref" class="input" placeholder="https://..." /></div>
        <div style="display:flex;align-items:end"><button id="qlAddBtn" class="btn solid" style="width:100%">Add Link</button></div>
      </div>
      <div class="row2">
        <div><div class="label">Emoji (optional)</div><input id="qlEmoji" class="input" placeholder="üî• ‚úÖ üìÅ ‚Ä¶" /></div>
        <div><div class="label">Logo image URL (optional)</div><input id="qlImg" class="input" placeholder="https://.../logo.png" /></div>
      </div>
      <div class="row">
        <div><div class="label">Description (optional)</div><input id="qlDesc" class="input" placeholder="Short label under the title" /></div>
        <div style="display:flex;align-items:end"><button id="qlResetBtn" class="btn" style="width:100%">Reset to defaults</button></div>
      </div>
      <div id="appsGrid" class="apps-grid"></div>
      <div class="apps-note muted small" id="qlStorageNote">Loading‚Ä¶</div>
    </div>

    <div id="analytics" class="card" style="margin-top:12px">
      <h2 style="margin:0 0 8px">Analytics ‚Äî right now</h2>
      <div class="stats">
        <div class="stat"><div class="muted small">Active TVs</div><b id="statActive">0</b></div>
        <div class="stat"><div class="muted small">Offline</div><b id="statOffline">0</b></div>
        <div class="stat"><div class="muted small">Top Channel</div><b id="statTopCh">‚Äî</b></div>
        <div class="stat"><div class="muted small">Avg Volume / Muted</div><b id="statVolMuted">0 ‚Ä¢ 0%</b></div>
      </div>
      <h3 style="margin:10px 0 6px">Channel mix</h3>
      <div id="anaChBars"></div>
      <h3 style="margin:16px 0 6px">Most active dealerships</h3>
      <div id="anaDealerBars"></div>
    </div>

    <div id="schedule" class="card" style="margin-top:12px">
      <h2 style="margin:0 0 8px">Schedule / Reminders (local)</h2>
      <div class="row2">
        <div>
          <div class="label">Date / time</div>
          <input id="schWhen" class="input" type="datetime-local" />
        </div>
        <div>
          <div class="label">Destination / address (optional)</div>
          <input id="schDest" class="input" placeholder="Location / notes‚Ä¶" />
        </div>
      </div>
      <div class="row2">
        <div>
          <div class="label">Note</div>
          <input id="schNote" class="input" placeholder="Installation / visit / reminder‚Ä¶" />
        </div>
        <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="schCreateAssets" />
            <span class="small">Create assets now (dealership + display)</span>
          </label>
          <button id="schAdd" class="btn solid">Add</button>
        </div>
      </div>
      <div id="schAssets" style="display:none">
        <div class="row3">
          <div><div class="label">Dealership name</div><input id="schDealerName" class="input" placeholder="e.g., Genesis Winnipeg"/></div>
          <div><div class="label">Dealership ID (auto if empty)</div><input id="schDealerId" class="input" placeholder="genesiswinnipeg"/></div>
          <div><div class="label">Display ID (auto if empty)</div><input id="schDisplayId" class="input" placeholder="GW-001"/></div>
        </div>
      </div>
      <ul id="schList" class="list"></ul>
      <div id="schEmpty" class="empty" style="display:none">No reminders.</div>
    </div>

    <div id="backups" class="card" style="margin-top:12px">
      <h2 style="margin:0 0 8px">Backups</h2>
      <div class="row2">
        <button id="btnDownloadBackup" class="btn solid">Download backup (JSON)</button>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="fileRestore" type="file" accept="application/json" class="input" />
          <button id="btnPreviewRestore" class="btn">Preview restore</button>
        </div>
      </div>
      <div id="restorePreview" class="card" style="display:none;margin-top:8px">
        <h3 style="margin:0 0 8px">Restore preview</h3>
        <div id="restoreDiff" class="list"></div>
        <div class="row2">
          <button id="btnApplyRestore" class="btn solid">Apply changes</button>
          <button id="btnCancelRestore" class="btn">Cancel</button>
        </div>
      </div>
    </div>

    <div id="github" class="card" style="margin-top:12px">
      <h2 style="margin:0 0 8px">GitHub Sync</h2>
      <div class="row2">
        <div><div class="label">GitHub Owner</div><input id="ghOwner" class="input" placeholder="org-or-user" /></div>
        <div><div class="label">Repo</div><input id="ghRepo" class="input" placeholder="repo" /></div>
      </div>
      <div class="row3">
        <div><div class="label">Branch</div><input id="ghBranch" class="input" placeholder="main" /></div>
        <div><div class="label">Path</div><input id="ghPath" class="input" placeholder="config/iptv-config.json" /></div>
        <div><div class="label">Token</div><input id="ghToken" class="input" type="password" placeholder="fine-grained token (contents:write)" /></div>
      </div>
      <div class="row2">
        <button id="saveSettingsBtn" class="btn">Save</button>
        <button id="syncBtn" class="btn solid">Sync ‚Üí GitHub</button>
      </div>
      <div class="small muted">Token must be fine-grained with Contents: Read &amp; write, repo selected. Metadata permission is auto-added by GitHub.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { setupTheme, guardAdminOrRedirect, auth, db, $, $$, htmlEscape, toast, debounce, DEFAULT_LINKS, snapshot, initialsFromName, nextSuffix, makeDealerId } from './assets/core.js';
    import { get, set, update, remove, ref, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    setupTheme();
    await guardAdminOrRedirect();

    // ===== LINKS =====
    const LINKS_DB_PATH='admin/quickLinks';
    let quickLinks=[], quickLinksSource='db';
    function clearQlForm(){ ['#qlTitle','#qlHref','#qlEmoji','#qlImg','#qlDesc'].forEach(s=>$(s).value=''); }
    function renderApps(){
      const grid=$('#appsGrid'); grid.innerHTML='';
      quickLinks.forEach((l,idx)=>{
        const a=document.createElement('a'); a.className='app-tile'; a.href=l.href; a.target='_blank'; a.rel='noopener noreferrer';
        const left=l.img? `<div class="app-logo" style="background-image:url('${l.img}')"></div>` : `<div class="app-emoji">${htmlEscape(l.emoji||'üîó')}</div>`;
        a.innerHTML=`${left}<div class="app-info"><div class="app-title">${htmlEscape(l.title||'Link')}</div><div class="app-desc">${htmlEscape(l.desc||'')}</div></div><button type="button" title="Remove" class="btn danger" data-remove="${idx}" style="margin-left:auto">√ó</button>`;
        grid.appendChild(a);
      });
      grid.querySelectorAll('button[data-remove]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{ e.preventDefault(); e.stopPropagation(); const i=parseInt(btn.dataset.remove,10); quickLinks.splice(i,1); await quickLinksSave(); renderApps(); toast('Link removed'); });
      });
    }
    async function quickLinksLoadRender(){
      try{ const s=await get(ref(db,LINKS_DB_PATH)); if(s.exists()){ quickLinks=Object.values(s.val()); quickLinksSource='db'; $('#qlStorageNote').textContent='Links are synced from database.'; }
      else throw new Error('empty'); }
      catch(e){
        try{ quickLinks=JSON.parse(localStorage.getItem('admin_quick_links')||'[]'); if(!quickLinks.length) quickLinks=[...DEFAULT_LINKS]; quickLinksSource='local'; $('#qlStorageNote').textContent='Links are stored locally on this device (no DB permission).'; }
        catch(_){ quickLinks=[...DEFAULT_LINKS]; quickLinksSource='local'; $('#qlStorageNote').textContent='Links are stored locally on this device (no DB permission).'; }
      }
      renderApps();
    }
    async function quickLinksSave(forceLocal=false){
      if(forceLocal || quickLinksSource==='local'){
        localStorage.setItem('admin_quick_links', JSON.stringify(quickLinks)); quickLinksSource='local'; $('#qlStorageNote').textContent='Links are stored locally on this device (no DB permission).'; return;
      }
      try{ const data={}; quickLinks.forEach((l,i)=>data[i]=l); await set(ref(db,LINKS_DB_PATH),data); quickLinksSource='db'; $('#qlStorageNote').textContent='Links are synced from database.'; }
      catch(e){ localStorage.setItem('admin_quick_links', JSON.stringify(quickLinks)); quickLinksSource='local'; $('#qlStorageNote').textContent='Links are stored locally on this device (no DB permission).'; }
    }
    $('#qlAddBtn').addEventListener('click', async ()=>{
      const title=$('#qlTitle').value.trim(), href=$('#qlHref').value.trim();
      const emoji=$('#qlEmoji').value.trim(), img=$('#qlImg').value.trim(), desc=$('#qlDesc').value.trim();
      if(!title||!href) return toast('Title and URL are required',true);
      quickLinks.push({title,href,emoji,img,desc}); await quickLinksSave(); clearQlForm(); renderApps(); toast('Link added');
    });
    $('#qlResetBtn').addEventListener('click', async ()=>{
      quickLinks=[...DEFAULT_LINKS]; await quickLinksSave(true); renderApps(); toast('Links reset');
    });
    quickLinksLoadRender();

    // ===== Analytics =====
    function renderBarRow(label,value,total){
      const pct = total ? Math.round((value/total)*100) : 0;
      const row = document.createElement('div');
      row.className='item';
      row.innerHTML = `<div class="col"><b>${htmlEscape(label)}</b><div class="bar"><i style="width:${pct}%"></i></div></div><div class="small muted">${value} ‚Ä¢ ${pct}%</div>`;
      return row;
    }
    async function loadAnalytics(){
      const s=await get(ref(db,'displays')); const map=s.val()||{}; const ids=Object.keys(map);
      const now=Date.now();
      let online=0, offline=0, volSum=0, volN=0, mutedCount=0;
      const channelCounts={}, dealerCounts={};
      ids.forEach(id=>{
        const v=map[id]||{};
        const on=(v.lastSeenAt && (now-v.lastSeenAt)<60000) || (v.timestamp && (now-v.timestamp)<120000);
        on? online++ : offline++;
        const ch=(v.channel||1); channelCounts[ch]=(channelCounts[ch]||0)+1;
        const d=(v.dealership||'‚Äî'); dealerCounts[d]=(dealerCounts[d]||0)+1;
        if(typeof v.volume==='number'){ volSum+=v.volume; volN++; }
        if(v.muted===true) mutedCount++;
      });
      const avgVol = volN ? Math.round(volSum/volN) : 0;
      const topCh = Object.entries(channelCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äî';
      const mutedPct = ids.length? Math.round((mutedCount/ids.length)*100) : 0;
      $('#statActive').textContent = online;
      $('#statOffline').textContent= offline;
      $('#statTopCh').textContent  = topCh;
      $('#statVolMuted').textContent = `${avgVol} ‚Ä¢ ${mutedPct}%`;
      const chWrap = $('#anaChBars'); chWrap.innerHTML='';
      const chTotal = Object.values(channelCounts).reduce((a,b)=>a+b,0);
      Object.entries(channelCounts).sort((a,b)=>a[0]-b[0]).forEach(([ch,n])=> chWrap.appendChild(renderBarRow('Channel '+ch, n, chTotal)));
      const dWrap = $('#anaDealerBars'); dWrap.innerHTML='';
      const dTotal = Object.values(dealerCounts).reduce((a,b)=>a+b,0);
      Object.entries(dealerCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(([d,n])=> dWrap.appendChild(renderBarRow(d, n, dTotal)));
    }
    loadAnalytics();

    // ===== Schedule =====
    const LS_SCH='iptv_admin_schedule';
    const schedule = JSON.parse(localStorage.getItem(LS_SCH)||'[]');
    $('#schCreateAssets').addEventListener('change', e=>{ $('#schAssets').style.display = e.target.checked ? 'block' : 'none'; });
    function saveSchedule(){ localStorage.setItem(LS_SCH, JSON.stringify(schedule)); renderSchedule(); }
    function renderSchedule(){
      const ul=$('#schList'); ul.innerHTML='';
      if(!schedule.length){ $('#schEmpty').style.display='block'; return; }
      $('#schEmpty').style.display='none';
      schedule.sort((a,b)=>a.when.localeCompare(b.when));
      schedule.forEach((r,i)=>{
        const li=document.createElement('li'); li.className='item';
        li.innerHTML=`<div><b>${new Date(r.when).toLocaleString()}</b>
          <div class="small muted">${htmlEscape(r.note||'')}</div>
          ${r.dest? `<div class="small muted">üìç ${htmlEscape(r.dest)}</div>`:''}
          ${r.assets? `<div class="small muted">Assets: ${htmlEscape(r.assets)}</div>`:''}
        </div><button class="btn danger" data-del="${i}">Delete</button>`;
        ul.appendChild(li);
      });
      ul.querySelectorAll('button[data-del]').forEach(btn=> btn.addEventListener('click',()=>{ const i=parseInt(btn.dataset.del,10); schedule.splice(i,1); saveSchedule(); }));
    }
    renderSchedule();
    $('#schAdd').addEventListener('click', async ()=>{
      const when=$('#schWhen').value;
      const note=$('#schNote').value.trim();
      const dest=$('#schDest').value.trim();
      const make=$('#schCreateAssets').checked;
      if(!when||!note) return toast('Pick date/time and note',true);
      let assetsMsg='';
      if(make){
        let dName=$('#schDealerName').value.trim();
        let dId=$('#schDealerId').value.trim();
        let displayId=$('#schDisplayId').value.trim();
        if(!dName && !dId) return toast('Enter dealership name or id', true);
        if(!dId) dId = makeDealerId(dName||('dealer_'+Date.now()));
        const exists = await get(ref(db,`dealershipPublic/${dId}`));
        if(!exists.exists()){
          await set(ref(db,`dealershipPublic/${dId}`), { name: dName || dId });
          await set(ref(db,`dealership/${dId}`), { name: dName || dId, createdAt: Date.now(), createdBy: auth.currentUser?.email||'admin', displays:{} });
        }
        if(!displayId){
          const friendly=(await get(ref(db,`dealershipPublic/${dId}`))).val()?.name||dId;
          const pref=initialsFromName(friendly);
          const existing=await (async()=>{ const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(dId)); const s=await get(qRef); return Object.keys(s.val()||{}); })();
          let n=nextSuffix(existing,pref);
          displayId=`${pref}-${String(n).padStart(3,'0')}`;
        }
        await set(ref(db,`dealership/${dId}/displays/${displayId}`), true);
        await update(ref(db,`displays/${displayId}`), { channel:1, volume:0, muted:true, dealership:dId, timestamp:Date.now() });
        assetsMsg = `${dId} ‚Ä¢ ${displayId}`;
        $('#schDealerName').value=''; $('#schDealerId').value=''; $('#schDisplayId').value='';
      }
      schedule.push({when,note,dest, assets: assetsMsg});
      saveSchedule();
      $('#schWhen').value=''; $('#schNote').value=''; $('#schDest').value=''; $('#schCreateAssets').checked=false; $('#schAssets').style.display='none';
      toast('Scheduled');
    });

    // ===== Backups =====
    function download(filename, text){
      const a=document.createElement('a');
      a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text);
      a.download=filename; a.click();
    }
    $('#btnDownloadBackup').addEventListener('click', async ()=>{
      const snap = await snapshot();
      download('iptv-backup.json', JSON.stringify(snap, null, 2));
    });

    let restoreData=null, restoreDiff=null;
    $('#btnPreviewRestore').addEventListener('click', async ()=>{
      const f = $('#fileRestore').files?.[0];
      if(!f) return toast('Pick a JSON file', true);
      try{ restoreData = JSON.parse(await f.text()); }catch(e){ return toast('Invalid JSON', true); }
      const live = await snapshot();
      const diff = { add:[], update:[], remove:[] };
      function diffMap(title, cur, next){
        const keys = new Set([...Object.keys(cur||{}), ...Object.keys(next||{})]);
        keys.forEach(k=>{
          const a = cur?.[k]; const b = next?.[k];
          if(a==null && b!=null) diff.add.push(`${title}: + ${k}`);
          else if(a!=null && b==null) diff.remove.push(`${title}: - ${k}`);
          else if(JSON.stringify(a)!==JSON.stringify(b)) diff.update.push(`${title}: ~ ${k}`);
        });
      }
      diffMap('dealersPublic', live.dealersPublic, restoreData.dealersPublic);
      diffMap('displays', live.displays, restoreData.displays);
      diffMap('users', live.users, restoreData.users);
      restoreDiff = diff;
      const box = $('#restoreDiff'); box.innerHTML='';
      const addH = document.createElement('div'); addH.className='item'; addH.innerHTML = `<b>Add</b><div class="small muted">${diff.add.length? diff.add.join('<br/>') : '‚Äî'}</div>`;
      const updH = document.createElement('div'); updH.className='item'; updH.innerHTML = `<b>Update</b><div class="small muted">${diff.update.length? diff.update.join('<br/>') : '‚Äî'}</div>`;
      const remH = document.createElement('div'); remH.className='item'; remH.innerHTML = `<b>Remove</b><div class="small muted">${diff.remove.length? diff.remove.join('<br/>') : '‚Äî'}</div>`;
      box.appendChild(addH); box.appendChild(updH); box.appendChild(remH);
      $('#restorePreview').style.display='block';
      toast((diff.add.length+diff.update.length+diff.remove.length)>0? 'Review changes below' : 'No differences');
    });
    $('#btnCancelRestore').addEventListener('click', ()=>{ $('#restorePreview').style.display='none'; restoreData=null; restoreDiff=null; });
    $('#btnApplyRestore').addEventListener('click', async ()=>{
      if(!restoreData) return;
      if(!confirm('Apply these changes? This will overwrite matching keys.')) return;
      try{
        await set(ref(db,'dealershipPublic'), restoreData.dealersPublic || {});
        await set(ref(db,'displays'), restoreData.displays || {});
        const liveUsers = (await get(ref(db,'user'))).val()||{};
        const merged = {...liveUsers};
        Object.entries(restoreData.users||{}).forEach(([uid,u])=>{ merged[uid] = { ...(merged[uid]||{}), ...u }; });
        await set(ref(db,'user'), merged);
        toast('Restore complete'); $('#restorePreview').style.display='none';
      }catch(e){ console.error(e); toast('Restore failed', true); }
    });

    // ===== GitHub Sync (settings stored locally) =====
    const LS_GH='iptv_admin_gh';
    const gh = JSON.parse(localStorage.getItem(LS_GH)||'{}');
    function saveSettings(){
      gh.owner=$('#ghOwner').value.trim();
      gh.repo=$('#ghRepo').value.trim();
      gh.branch=$('#ghBranch').value.trim()||'main';
      gh.path=$('#ghPath').value.trim()||'config/iptv-config.json';
      gh.token=$('#ghToken').value.trim();
      localStorage.setItem(LS_GH, JSON.stringify(gh));
      toast('Settings saved');
    }
    function openSettings(){
      $('#ghOwner').value = gh.owner||'';
      $('#ghRepo').value  = gh.repo||'';
      $('#ghBranch').value= gh.branch||'main';
      $('#ghPath').value  = gh.path||'config/iptv-config.json';
      $('#ghToken').value = gh.token||'';
    }
    openSettings();
    $('#saveSettingsBtn').addEventListener('click', saveSettings);

    function b64(str){return btoa(unescape(encodeURIComponent(str)));}
    async function ghFetch(url, opts){
      const res = await fetch(url, opts);
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : {}; } catch { data = { raw:text }; }
      if(!res.ok){
        const msg = data?.message || res.statusText || 'GitHub error';
        throw new Error(`${msg} (HTTP ${res.status})`);
      }
      return data;
    }
    async function checkRepo(gh){
      const url = `https://api.github.com/repos/${gh.owner}/${gh.repo}`;
      return ghFetch(url, {
        headers:{
          'Authorization': `Bearer ${gh.token}`,
          'Accept':'application/vnd.github+json',
          'X-GitHub-Api-Version':'2022-11-28'
        }
      });
    }
    async function exportToGitHub(){
      try{
        const gh = JSON.parse(localStorage.getItem('iptv_admin_gh')||'{}');
        if(!gh.owner || !gh.repo || !gh.branch || !gh.path || !gh.token){
          toast('Settings incomplete ‚Äî fill all fields above', true);
          return;
        }
        await checkRepo(gh);
        const payload = await snapshot();
        const contentB64 = b64(JSON.stringify(payload, null, 2));

        const base = `https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/${encodeURIComponent(gh.path)}`;
        const headers = {
          'Authorization': `Bearer ${gh.token}`,
          'Accept':'application/vnd.github+json',
          'X-GitHub-Api-Version':'2022-11-28',
          'Content-Type':'application/json'
        };
        let sha = undefined;
        try{
          const existing = await ghFetch(`${base}?ref=${encodeURIComponent(gh.branch)}`, { headers });
          sha = existing.sha;
        }catch(e){
          if(!String(e.message||'').includes('404')) throw e;
        }
        const body = { message: sha ? `update: ${gh.path}` : `create: ${gh.path}`, content: contentB64, branch: gh.branch, sha };
        await ghFetch(base, { method:'PUT', headers, body: JSON.stringify(body) });
        toast('Synced to GitHub ‚úîÔ∏é');
      }catch(err){
        console.error('[github sync failed]', err);
        alert(`GitHub sync failed:\n\n${err.message}\n\nChecklist:\n‚Ä¢ Token must be fine-grained with ‚ÄúContents: Read and write‚Äù (and Metadata auto-adds)\n‚Ä¢ Repo must be selected on the token\n‚Ä¢ Owner/Repo/Branch/Path must be exact`);
        toast('Sync failed', true);
      }
    }
    document.getElementById('syncBtn').addEventListener('click', exportToGitHub);

  </script>
</body>
</html>
