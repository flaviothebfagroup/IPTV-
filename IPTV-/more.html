<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
<title>BFA IPTV â€” Backups & Pages</title>

<style>
  :root{
    --bg:#0b0b0c;--fg:#fff;--muted:#9a9aa0;--panel:#121214;--border:rgba(255,255,255,.14);
    --accent:#ff9500;--tile:#17171a;--tileActive:#1d1d21;--shadow:0 18px 48px rgba(0,0,0,.45);
    --radius:18px;--radius-lg:22px;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444
  }
  body.light{
    --bg:#f5f5f7;--fg:#111;--muted:#6e6e73;--panel:#fff;--border:rgba(0,0,0,.12);
    --tile:#f2f2f7;--tileActive:#eaeaef;--shadow:0 14px 36px rgba(0,0,0,.10)
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
  a{color:inherit;text-decoration:none}

  /* Topbar (consistent + More) */
  .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .lhs{display:flex;align-items:center;gap:10px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.3px}
  .logo{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--tile) center/cover no-repeat}
  .nav{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .btn{height:34px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .btn.primary{border-color:var(--accent);color:var(--accent);background:transparent}
  .btn.solid{background:var(--accent);border-color:var(--accent);color:#000}
  .muted{color:var(--muted);font-size:12px}
  .more{position:relative}
  .more .menu{display:none;position:absolute;right:0;top:42px;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;min-width:220px}
  .more.open .menu{display:block}
  .more .menu a{display:flex;gap:8px;align-items:center;padding:8px 10px;border-radius:10px}
  .more .menu a:hover{background:var(--tileActive)}
  .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}

  /* Shell + cards */
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow);margin-bottom:12px}
  h2,h3{margin:0 0 8px}

  /* Step cards */
  .step{display:grid;grid-template-columns:36px 1fr auto;gap:10px;align-items:center}
  .step .circle{width:36px;height:36px;border-radius:999px;background:var(--tile);border:1px solid var(--border);display:grid;place-items:center;font-weight:900;color:var(--accent)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row .grow{flex:1}
  .input,.select{height:38px;padding:0 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--fg)}
  .input::placeholder{color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:980px){.grid2{grid-template-columns:1fr}}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media (max-width:980px){.grid3{grid-template-columns:1fr}}

  /* File manager */
  .fm{display:grid;grid-template-rows:auto 1fr;gap:10px}
  .fm-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .crumbs{display:flex;gap:6px;flex-wrap:wrap}
  .crumb{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--tile);cursor:pointer}
  .list{margin:0;padding:0;list-style:none}
  .item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;margin:8px 0;background:var(--tile);border:1px solid var(--border);border-radius:12px}
  .left{display:flex;align-items:center;gap:10px}
  .badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}
  .fileIc,.folderIc{width:28px;height:28px;border:1px solid var(--border);border-radius:8px;display:grid;place-items:center;background:var(--tileActive)}
  .fileIc svg,.folderIc svg{width:16px;height:16px}
  .right{display:flex;gap:8px;flex-wrap:wrap}

  /* Dialogs */
  dialog{border:0;padding:0;background:transparent}
  .modal{background:var(--panel);border:1px solid var(--border);border-radius:18px;max-width:820px;width:96vw;padding:14px}
  .textarea{width:100%;min-height:48vh;border:1px solid var(--border);border-radius:12px;background:var(--tile);color:var(--fg);font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;padding:10px}
  .danger{border-color:#ff6b6b;color:#ff6b6b;background:transparent}

  /* Toast */
  .toast{position:fixed;left:50%;bottom:26px;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
  .toast.show{opacity:1}
  .toast.err{background:#ff453a;color:#fff}
</style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="lhs">
      <a class="brand" href="home.html">
        <div id="brandLogo" class="logo" title="IPTV"></div>
        <span>BFA IPTV â€” Backups & Pages</span>
      </a>
    </div>
    <div class="nav">
      <a class="btn" href="home.html">Home</a>
      <a class="btn" href="dealerships.html">Dealerships</a>
      <a class="btn" href="displays.html">Displays</a>
      <a class="btn" href="users.html">Users</a>
      <div class="more">
        <button id="moreBtn" class="btn">+ More</button>
        <div class="menu" id="moreMenu">
          <a class="btn" href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
          <a class="btn" href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
          <a class="btn" href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
          <a class="btn" href="remote.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
        </div>
      </div>
      <button id="themeBtn" class="btn">â˜€ï¸Ž/ðŸŒ™</button>
      <button id="signOutBtn" class="btn primary">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Step 1: Connect -->
    <div class="card">
      <div class="step">
        <span class="circle">1</span>
        <div>
          <h2>Connect to GitHub</h2>
          <div class="hint">Paste your fine-grained token (Contents: Read &amp; Write). Stored only in this browser.</div>
          <div class="grid3" style="margin-top:8px">
            <div><div class="hint">Owner</div><input id="ghOwner" class="input" placeholder="org-or-user"/></div>
            <div><div class="hint">Repo</div><input id="ghRepo" class="input" placeholder="repo"/></div>
            <div><div class="hint">Branch</div><input id="ghBranch" class="input" placeholder="main" value="main"/></div>
          </div>
          <div class="grid3" style="margin-top:8px">
            <div class="grow"><div class="hint">Base path (starts with /)</div><input id="ghBasePath" class="input" placeholder="/ (root)" value="/"/></div>
            <div class="grow"><div class="hint">GitHub Token</div>
              <div class="row">
                <input id="ghToken" class="input grow" type="password" placeholder="paste token here"/>
                <button id="toggleTok" class="btn" type="button">Show</button>
              </div>
            </div>
            <div style="display:flex;align-items:flex-end"><button id="ghSave" class="btn solid" type="button">Save & Test</button></div>
          </div>
          <div class="row" style="margin-top:8px">
            <span class="hint">Pages URL:</span>
            <a id="pagesUrl" class="btn" href="#" target="_blank" rel="noopener">â€”</a>
            <button id="clearGh" class="btn danger" type="button">Clear token</button>
          </div>
        </div>
        <div></div>
      </div>
    </div>

    <!-- Step 2: Files -->
    <div class="card">
      <div class="step">
        <span class="circle">2</span>
        <div class="grow">
          <h2>Manage Pages files</h2>
          <div class="hint">Browse folders, create, paste code, upload, edit, download, delete.</div>
        </div>
        <div class="row">
          <button id="btnRefresh" class="btn">Refresh</button>
        </div>
      </div>

      <div class="fm" style="margin-top:8px">
        <div class="fm-toolbar">
          <div class="crumbs" id="crumbs"></div>
          <div class="row" style="margin-left:auto">
            <button id="btnNewFolder" class="btn">New Folder</button>
            <button id="btnNewFile" class="btn">New File</button>
            <button id="btnPasteCode" class="btn">Paste Code</button>
            <label class="btn">
              Upload<input id="fileUpload" type="file" multiple style="display:none"/>
            </label>
          </div>
        </div>
        <ul id="fileList" class="list"></ul>
        <div id="emptyList" class="muted" style="display:none">This folder is empty.</div>
      </div>
    </div>

    <!-- Step 3: Backup -->
    <div class="card">
      <div class="step">
        <span class="circle">3</span>
        <div class="grow">
          <h2>Firebase backup</h2>
          <div class="hint">Snapshot dealershipPublic, dealership, displays, user, and quick links.</div>
        </div>
        <div class="row">
          <button id="btnMakeBackup" class="btn">Create</button>
          <button id="btnDownloadBackup" class="btn">Download</button>
          <button id="btnSaveBackupGh" class="btn solid">Save to GitHub</button>
        </div>
      </div>
      <pre id="bkPreview" class="textarea" style="min-height:180px;margin-top:8px"></pre>
    </div>

    <!-- Step 4: Publish -->
    <div class="card">
      <div class="step">
        <span class="circle">4</span>
        <div class="grow">
          <h2>Open your site</h2>
          <div class="hint">Click to view your GitHub Pages site.</div>
        </div>
        <div><a id="pagesUrl2" class="btn primary" href="#" target="_blank" rel="noopener">Open Pages</a></div>
      </div>
    </div>
  </div>

  <!-- Editor dialog -->
  <dialog id="editorDlg">
    <div class="modal">
      <h3 id="edTitle">Edit</h3>
      <div class="row" style="margin:6px 0"><span class="badge" id="edPath"></span></div>
      <textarea id="edText" class="textarea" spellcheck="false"></textarea>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="edCancel" class="btn">Close</button>
        <button id="edSave" class="btn solid">Save</button>
      </div>
    </div>
  </dialog>

  <!-- New file dialog -->
  <dialog id="newFileDlg">
    <div class="modal">
      <h3>Create new file</h3>
      <div class="row"><input id="nfPath" class="input grow" placeholder="file path (e.g., pages/new.html)"/></div>
      <div class="row">
        <label class="badge"><input type="radio" name="nfType" value="html" checked/> HTML Page</label>
        <label class="badge"><input type="radio" name="nfType" value="json"/> JSON Config</label>
        <label class="badge"><input type="radio" name="nfType" value="empty"/> Empty</label>
      </div>
      <div id="nfHtmlOpts" style="margin-top:6px">
        <div class="row"><input id="nfTitle" class="input grow" placeholder="Page title" value="BFA IPTV â€” New Page"/></div>
        <label class="badge"><input id="nfIncludeNavbar" type="checkbox" checked/> Include navbar + +More</label>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="nfCancel" class="btn">Cancel</button>
        <button id="nfCreate" class="btn solid">Create</button>
      </div>
    </div>
  </dialog>

  <!-- Paste dialog -->
  <dialog id="pasteDlg">
    <div class="modal">
      <h3>Paste code</h3>
      <div class="row"><input id="pastePath" class="input grow" placeholder="file path (e.g., pages/foo.html)"/></div>
      <textarea id="pasteText" class="textarea" spellcheck="false" placeholder="Paste your code hereâ€¦"></textarea>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="pasteCancel" class="btn">Cancel</button>
        <button id="pasteSave" class="btn solid">Save</button>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  // ===== Firebase (for backup) =====
  const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};
  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getDatabase(app);

  const $=s=>document.querySelector(s);
  const toast=(m,err=false)=>{const t=$("#toast");t.textContent=m;t.className='toast show'+(err?' err':'');setTimeout(()=>t.classList.remove('show'),2200);};

  // Theme + logo + nav More
  const savedTheme=localStorage.getItem('iptv_theme')||'light';
  document.body.classList.toggle('light', savedTheme==='light');
  $('#themeBtn').addEventListener('click', ()=>{ const isLight=!document.body.classList.contains('light'); document.body.classList.toggle('light',isLight); localStorage.setItem('iptv_theme', isLight?'light':'dark');});
  $('#brandLogo').style.backgroundImage='url("/IPTV-/icons/icon-512.png")';
  (function(){ const more=$('.more'); $('#moreBtn').addEventListener('click',()=>more.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!more.contains(e.target)) more.classList.remove('open'); },{capture:true}); })();

  // Auth gate (admin)
  setPersistence(auth, browserLocalPersistence);
  onAuthStateChanged(auth, async (u)=>{
    if(!u){ location.href='home.html'; return; }
    try{
      const rec=(await get(ref(db,'user/'+u.uid))).val()||{};
      if(rec.role!=='admin'){ alert('Not authorized. Ask an admin to set role=admin.'); location.href='home.html'; }
    }catch(e){}
  });
  $('#signOutBtn').addEventListener('click', ()=>signOut(auth));

  // ===== GitHub wiring =====
  const LS='iptv_admin_gh';
  let GH = JSON.parse(localStorage.getItem(LS)||'{}'); // {owner,repo,branch,basePath,token}
  const ghHeaders=()=>({ 'Authorization':`Bearer ${GH.token||''}`, 'Accept':'application/vnd.github+json' });
  const ghBase = () => `https://api.github.com/repos/${encodeURIComponent(GH.owner)}/${encodeURIComponent(GH.repo)}`;
  const safeJoin=(...parts)=>parts.join('/').replace(/\/+/g,'/').replace(/\/$/,'').replace(/^\//,''); // no leading /
  const basePath=()=> (GH.basePath||'/').replace(/\/+$/,'/');
  const pagesUrl=()=> `https://${GH.owner}.github.io/${GH.repo}/`;

  // Prefill UI
  $('#ghOwner').value = GH.owner||'';
  $('#ghRepo').value = GH.repo||'';
  $('#ghBranch').value = GH.branch||'main';
  $('#ghBasePath').value = GH.basePath||'/';
  $('#pagesUrl').textContent = pagesUrl(); $('#pagesUrl').href = pagesUrl();
  $('#pagesUrl2').textContent = pagesUrl(); $('#pagesUrl2').href = pagesUrl();

  $('#toggleTok').addEventListener('click', ()=>{
    const el=$('#ghToken'); el.type = el.type==='password' ? 'text':'password';
    $('#toggleTok').textContent = el.type==='password' ? 'Show':'Hide';
  });

  $('#clearGh').addEventListener('click', ()=>{
    GH.token=''; localStorage.setItem(LS, JSON.stringify(GH));
    $('#ghToken').value='';
    toast('Token cleared');
  });

  $('#ghSave').addEventListener('click', async ()=>{
    GH.owner = $('#ghOwner').value.trim();
    GH.repo  = $('#ghRepo').value.trim();
    GH.branch= ($('#ghBranch').value.trim()||'main');
    GH.basePath = ($('#ghBasePath').value.trim()||'/');
    const tok = $('#ghToken').value.trim();
    if(tok) GH.token = tok;
    localStorage.setItem(LS, JSON.stringify(GH));
    $('#pagesUrl').textContent = pagesUrl(); $('#pagesUrl').href = pagesUrl();
    $('#pagesUrl2').textContent = pagesUrl(); $('#pagesUrl2').href = pagesUrl();
    try{
      await ghFetch(`${ghBase()}`, {headers:ghHeaders()});
      toast('Connected âœ”ï¸Ž');
      refreshList();
    }catch(e){
      console.error(e); toast('Connect failed', true);
    }
  });

  async function ghFetch(url,opts){
    const r = await fetch(url,opts);
    const t = await r.text();
    let d; try{ d=t?JSON.parse(t):{}; }catch{ d={raw:t}; }
    if(!r.ok) throw new Error(d?.message||r.statusText);
    return d;
  }
  async function ghGetContent(path){
    const url = `${ghBase()}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(GH.branch)}`;
    return await ghFetch(url, {headers:ghHeaders()});
  }
  async function ghPutFile(path, contentText, message){
    const content = btoa(unescape(encodeURIComponent(contentText)));
    const base = `${ghBase()}/contents/${encodeURIComponent(path)}`;
    let sha; // if exists -> update
    try{ const ex = await ghGetContent(path); sha = ex.sha; }catch(_){}
    const body = JSON.stringify({ message: message || (sha?`update: ${path}`:`create: ${path}`), content, branch: GH.branch, sha });
    return await ghFetch(base,{ method:'PUT', headers:{...ghHeaders(),'Content-Type':'application/json'}, body });
  }
  async function ghDeleteFile(path, message){
    const info = await ghGetContent(path);
    const base = `${ghBase()}/contents/${encodeURIComponent(path)}`;
    const body = JSON.stringify({ message: message || `delete: ${path}`, sha: info.sha, branch: GH.branch });
    return await ghFetch(base, { method:'DELETE', headers:{...ghHeaders(),'Content-Type':'application/json'}, body });
  }
  function rawUrl(path){
    return `https://raw.githubusercontent.com/${encodeURIComponent(GH.owner)}/${encodeURIComponent(GH.repo)}/${encodeURIComponent(GH.branch)}/${path}`;
  }

  // ===== File manager state =====
  let curPath = ''; // relative to basePath()
  function fullPath(p){ return safeJoin(basePath().replace(/^\//,''), p||''); }
  function showCrumbs(){
    const c=$('#crumbs'); c.innerHTML='';
    const segs = curPath ? curPath.split('/').filter(Boolean) : [];
    const mk=(name,acc)=>{ const b=document.createElement('button'); b.className='crumb'; b.textContent=name; b.addEventListener('click',()=>{ curPath=acc; refreshList();}); return b; };
    c.appendChild(mk('root',''));
    let acc=''; segs.forEach((s,i)=>{ acc = safeJoin(acc,s); c.appendChild(mk(s,acc)); });
  }

  async function refreshList(){
    try{
      const p = fullPath(curPath);
      const data = await ghGetContent(p||'');
      showCrumbs();
      renderList(Array.isArray(data)?data:[], p);
      toast('Loaded');
    }catch(e){
      console.error(e); toast('Load failed', true);
    }
  }

  function iconFor(item){
    const isDir = item.type==='dir';
    const ext = (item.name.split('.').pop()||'').toLowerCase();
    const html = '<svg viewBox="0 0 24 24"><path d="M4 6h6l2 2h8v10a2 2 0 0 1-2 2H4z"/></svg>';
    const json = '<svg viewBox="0 0 24 24"><rect x="4" y="3" width="16" height="18" rx="2"/><path d="M8 7h8M8 11h8M8 15h5"/></svg>';
    const img  = '<svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><circle cx="8" cy="10" r="2"/><path d="M21 15l-5-5-4 4-2-2-5 5"/></svg>';
    const txt  = '<svg viewBox="0 0 24 24"><path d="M6 2h9l5 5v15a2 2 0 0 1-2 2H6z"/><path d="M14 2v6h6"/></svg>';
    if(isDir) return `<div class="folderIc"><svg viewBox="0 0 24 24"><path d="M3 7h6l2 2h10v9a2 2 0 0 1-2 2H3z"/></svg></div>`;
    if(['html','htm'].includes(ext)) return `<div class="fileIc">${html}</div>`;
    if(['json'].includes(ext)) return `<div class="fileIc">${json}</div>`;
    if(['png','jpg','jpeg','gif','svg','webp'].includes(ext)) return `<div class="fileIc">${img}</div>`;
    return `<div class="fileIc">${txt}</div>`;
  }

  function renderList(items, baseShown){
    const list=$('#fileList'); list.innerHTML='';
    if(!items.length){ $('#emptyList').style.display='block'; return; }
    $('#emptyList').style.display='none';
    items.sort((a,b)=> (a.type===b.type? a.name.localeCompare(b.name) : (a.type==='dir'?-1:1)));
    items.forEach(it=>{
      const li=document.createElement('li'); li.className='item';
      li.innerHTML = `
        <div class="left">
          ${iconFor(it)}
          <div>
            <div style="font-weight:800">${it.name}</div>
            <div class="muted small">${it.type} ${it.size?('â€¢ '+it.size+' bytes'):''}</div>
          </div>
        </div>
        <div class="right">
          ${it.type==='dir'
            ? `<button class="btn" data-open="${it.path}">Open</button>`
            : `<button class="btn" data-edit="${it.path}">Edit</button>
               <a class="btn" href="${rawUrl(it.path)}" target="_blank" rel="noopener">Download</a>
               <button class="btn danger" data-del="${it.path}">Delete</button>`
          }
        </div>`;
      list.appendChild(li);
    });

    list.querySelectorAll('[data-open]').forEach(b=>{
      b.addEventListener('click', ()=>{ curPath = (b.dataset.open||'').replace(fullPath('')+'/','').replace(basePath().replace(/^\//,''),''); refreshList();});
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        try{
          const path=b.dataset.edit;
          const raw=await fetch(rawUrl(path)).then(r=>r.text());
          openEditor(path, raw);
        }catch(e){ toast('Open failed', true); }
      });
    });
    list.querySelectorAll('[data-del]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const path=b.dataset.del;
        if(!confirm(`Delete ${path}?`)) return;
        try{ await ghDeleteFile(path); toast('Deleted'); refreshList(); }catch(e){ toast('Delete failed', true); }
      });
    });
  }

  $('#btnRefresh').addEventListener('click', refreshList);

  // New folder = create .keep inside new directory
  $('#btnNewFolder').addEventListener('click', async ()=>{
    const name = prompt('Folder name (no /)');
    if(!name) return;
    const dest = safeJoin(fullPath(curPath), name, '.keep');
    try{ await ghPutFile(dest, '', `create folder ${name}`); toast('Folder created'); refreshList(); }catch(e){ toast('Create failed', true); }
  });

  // New file dialog
  const newDlg = $('#newFileDlg');
  $('#btnNewFile').addEventListener('click', ()=>{
    newDlg.showModal();
  });
  $('#nfCancel').addEventListener('click', ()=> newDlg.close());
  newDlg.querySelectorAll('input[name="nfType"]').forEach(r=>{
    r.addEventListener('change', ()=>{ $('#nfHtmlOpts').style.display = (r.value==='html' && r.checked) ? 'block':'none'; });
  });
  function htmlTemplate(title='BFA IPTV â€” New Page', includeNavbar=true){
    const nav = includeNavbar ? `
  <header class="topbar">
    <div class="lhs">
      <a class="brand" href="home.html"><div class="logo" id="brandLogo2"></div><span>BFA IPTV â€” Page</span></a>
    </div>
    <div class="nav">
      <a class="btn" href="home.html">Home</a>
      <a class="btn" href="dealerships.html">Dealerships</a>
      <a class="btn" href="displays.html">Displays</a>
      <a class="btn" href="users.html">Users</a>
      <div class="more">
        <button class="btn">+ More</button>
      </div>
    </div>
  </header>` : '';
    return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${title}</title>
<style>
:root{--bg:#0b0b0c;--fg:#fff;--muted:#9a9aa0;--panel:#121214;--border:rgba(255,255,255,.14);--accent:#ff9500;--tile:#17171a;--tileActive:#1d1d21;--shadow:0 18px 48px rgba(0,0,0,.45)}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
.topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));border-bottom:1px solid var(--border)}
.logo{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--tile) center/cover no-repeat}
.nav{margin-left:auto;display:flex;gap:8px}
.btn{height:34px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
</style>
</head>
<body>
${nav}
<div class="wrap"><div class="card"><h2>${title}</h2><p class="muted">Start building.</p></div></div>
<script>document.getElementById('brandLogo2')?.style.setProperty('background-image','url("/IPTV-/icons/icon-512.png")');</script>
</body>
</html>`;
  }
  function jsonTemplate(){ return JSON.stringify({kind:'bfa-iptv.config',version:'v1',createdAt:new Date().toISOString(),data:{}},null,2); }

  $('#nfCreate').addEventListener('click', async ()=>{
    const rel = $('#nfPath').value.trim();
    if(!rel) return toast('Enter file path', true);
    const type = [...newDlg.querySelectorAll('input[name="nfType"]')].find(x=>x.checked)?.value || 'html';
    const full = safeJoin(fullPath(curPath), rel);
    let content='';
    if(type==='html') content = htmlTemplate($('#nfTitle').value||'BFA IPTV â€” New Page', $('#nfIncludeNavbar').checked);
    else if(type==='json') content = jsonTemplate();
    else content = '';
    try{ await ghPutFile(full, content); newDlg.close(); toast('Created'); refreshList(); }catch(e){ toast('Create failed', true); }
  });

  // Paste dialog
  const pasteDlg = $('#pasteDlg');
  $('#btnPasteCode').addEventListener('click', ()=> pasteDlg.showModal());
  $('#pasteCancel').addEventListener('click', ()=> pasteDlg.close());
  $('#pasteSave').addEventListener('click', async ()=>{
    const rel=$('#pastePath').value.trim(); if(!rel) return toast('Enter file path',true);
    try{ await ghPutFile(safeJoin(fullPath(curPath),rel), $('#pasteText').value, `save: ${rel}`); pasteDlg.close(); toast('Saved'); refreshList(); }catch(e){ toast('Save failed', true); }
  });

  // Upload files
  $('#fileUpload').addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]);
    if(!files.length) return;
    try{
      for(const f of files){
        const buf = await f.arrayBuffer();
        const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
        const path = safeJoin(fullPath(curPath), f.name);
        const base = `${ghBase()}/contents/${encodeURIComponent(path)}`;
        let sha; try{ const ex=await ghGetContent(path); sha=ex.sha; }catch(_){}
        await ghFetch(base,{method:'PUT',headers:{...ghHeaders(),'Content-Type':'application/json'},
          body:JSON.stringify({message:(sha?`update: ${path}`:`upload: ${path}`), content:b64, branch:GH.branch, sha})});
      }
      toast('Upload complete'); refreshList();
    }catch(e){ console.error(e); toast('Upload failed', true); }
    e.target.value='';
  });

  // Editor dialog helpers
  const edDlg=$('#editorDlg'); const edText=$('#edText'); const edPath=$('#edPath'); const edTitle=$('#edTitle');
  function openEditor(path, text){
    edTitle.textContent = 'Edit file';
    edPath.textContent  = path;
    edText.value = text||'';
    edDlg.showModal();
  }
  $('#edCancel').addEventListener('click', ()=> edDlg.close());
  $('#edSave').addEventListener('click', async ()=>{
    const path = edPath.textContent; const txt = edText.value;
    try{ await ghPutFile(path, txt); toast('Saved'); edDlg.close(); refreshList(); }catch(e){ toast('Save failed', true); }
  });

  // ===== Backup =====
  async function snapshot(){
    const [dp, d, ds, us, ql] = await Promise.all([
      get(ref(db,'dealershipPublic')).catch(()=>({val:()=>null})),
      get(ref(db,'dealership')).catch(()=>({val:()=>null})),
      get(ref(db,'displays')).catch(()=>({val:()=>null})),
      get(ref(db,'user')).catch(()=>({val:()=>null})),
      get(ref(db,'admin/quickLinks')).catch(()=>({val:()=>null})),
    ]);
    const users={};
    Object.entries(us?.val?.()||{}).forEach(([uid,u])=>{
      users[uid]={ email:u.email||null, name:u.name||null, role:u.role||'user', dealershipId:u.dealershipId||null, updatedAt:u.updatedAt||null };
    });
    return {
      kind:'bfa-iptv.backup', version:'v1',
      exportedAt:new Date().toISOString(),
      exportedBy:auth.currentUser?.email||'admin',
      sections:['dealershipPublic','dealership','displays','users','quickLinks'],
      data:{
        dealershipPublic: dp?.val?.()||{},
        dealership:       d?.val?.()||{},
        displays:         ds?.val?.()||{},
        users,
        quickLinks:       ql?.val?.()||{}
      }
    };
  }
  function download(name, obj){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2500);
  }
  function nowStamp(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; }

  let lastBackup=null;
  $('#btnMakeBackup').addEventListener('click', async ()=>{
    try{ lastBackup = await snapshot(); $('#bkPreview').value = JSON.stringify(lastBackup,null,2); toast('Backup created âœ”ï¸Ž'); }catch(e){ toast('Backup failed', true); }
  });
  $('#btnDownloadBackup').addEventListener('click', ()=>{
    if(!lastBackup) return toast('Create a backup first', true);
    download(`bfa-backup-${nowStamp()}.json`, lastBackup);
  });
  $('#btnSaveBackupGh').addEventListener('click', async ()=>{
    if(!lastBackup) return toast('Create a backup first', true);
    try{
      const p = safeJoin(fullPath('backups'), `bfa-backup-${nowStamp()}.json`);
      await ghPutFile(p, JSON.stringify(lastBackup,null,2), 'backup: snapshot');
      toast('Backup saved to GitHub âœ”ï¸Ž');
      refreshList();
    }catch(e){ toast('Save failed', true); }
  });

  // Initial load (if creds already present)
  if(GH.owner && GH.repo && GH.branch && GH.token){
    try{ await ghFetch(`${ghBase()}`, {headers:ghHeaders()}); refreshList(); }catch(e){}
  }
</script>
</body>
</html>
