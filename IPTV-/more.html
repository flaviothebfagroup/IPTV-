// === Template helpers ===
function htmlPageTemplate(title='BFA IPTV — New Page', includeNavbar=true){
  // a clean, consistent page shell with your orange, icons, and +More
  const nav = includeNavbar ? `
  <header class="topbar">
    <div class="toprow">
      <a class="brand" href="home.html"><span class="logo" id="brandLogo"></span><span class="logotxt">BFA IPTV</span></a>
      <nav class="nav" aria-label="Primary">
        <a class="pill" href="home.html" data-page="home"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
        <a class="pill" href="dealerships.html" data-page="dealerships"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
        <a class="pill" href="displays.html" data-page="displays"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
        <a class="pill" href="users.html" data-page="users"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
        <div class="more">
          <a id="moreBtn" class="pill" href="javascript:void(0)">
            <svg class="plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg> More
          </a>
          <div id="moreMenu" role="menu" aria-label="More">
            <a href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
            <a href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
            <a href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
            <a href="backups.html" class=""><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
            <a href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
          </div>
        </div>
      </nav>
    </div>
  </header>` : '';

  // minimal CSS tokens to keep it consistent + lightweight
  const css = `
  <style>
    :root{--accent:#ff9500;--fg:#111;--muted:#6e6e73;--bg:#fff;--panel:#fff;--tile:#f6f6f8;--border:rgba(0,0,0,.14);--shadow:0 12px 30px rgba(0,0,0,.08)}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
    a{color:inherit;text-decoration:none}
    .topbar{position:sticky;top:0;z-index:50;background:var(--panel);border-bottom:1px solid var(--border);padding:12px 14px}
    .toprow{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:#fff center/cover no-repeat}
    .logotxt{font-weight:900;letter-spacing:.2px}
    .nav{display:flex;gap:10px;margin-left:auto;margin-right:auto}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:9999px;border:1px solid transparent;font-weight:800}
    .pill:hover{border-color:var(--accent)}
    .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}
    .more{position:relative}
    #moreMenu{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;min-width:230px;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none}
    #moreMenu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px}
    #moreMenu a:hover{background:#fff7ea}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
  </style>`;

  const js = `
  <script>
    const moreBtn=document.getElementById('moreBtn'), moreMenu=document.getElementById('moreMenu');
    moreBtn?.addEventListener('click',(e)=>{e.preventDefault();moreMenu.classList.toggle('open');moreMenu.style.display=moreMenu.style.display==='block'?'none':'block';});
    document.addEventListener('click',(e)=>{ if(!moreMenu?.contains(e.target) && e.target!==moreBtn && !moreBtn?.contains(e.target)){ if(moreMenu) moreMenu.style.display='none'; }}, {capture:true});
    document.getElementById('brandLogo')?.style.setProperty('background-image','url("/IPTV-/icons/icon-512.png")');
  </script>`;

  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${title}</title>
${css}
</head>
<body>
  ${nav}
  <div class="wrap">
    <div class="card">
      <h2>${title}</h2>
      <p class="muted">New page — start building!</p>
    </div>
  </div>
${js}
</body>
</html>`;
}

function jsonTemplate(){
  return JSON.stringify({ kind:"bfa-iptv.config", version:"v1", createdAt:new Date().toISOString(), data:{} }, null, 2);
}

function openNewFileDlg(){
  saveGhLS(); if(!isConnected()) return toast('Connect GitHub first',true);
  const dlg = document.getElementById('newFileDlg');
  dlg.showModal();

  // toggle extra HTML options visibility
  dlg.querySelectorAll('input[name="nfType"]').forEach(r=>{
    r.addEventListener('change',()=>{
      document.getElementById('nfHtmlOpts').style.display = r.value==='html' && r.checked ? 'block':'none';
    });
  });

  dlg.querySelector('#nfCreateBtn').onclick = async (e)=>{
    e.preventDefault();
    const path = document.getElementById('nfPath').value.trim();
    if(!path) return toast('Enter a file path',true);

    const type = [...dlg.querySelectorAll('input[name="nfType"]')].find(x=>x.checked)?.value || 'html';
    let content = '';
    if(type==='html'){
      const title = (document.getElementById('nfTitle').value||'BFA IPTV — New Page').trim();
      const includeNavbar = document.getElementById('nfIncludeNavbar').checked;
      content = htmlPageTemplate(title, includeNavbar);
    }else if(type==='json'){
      content = jsonTemplate();
    }else{
      content = '';
    }

    // open in editor (we reuse the existing editor/save flow)
    const full = [basePath(), curPath, path].filter(Boolean).join('/');
    dlg.close();
    openEditor(full, content);
  };
}

document.getElementById('newFile').addEventListener('click', openNewFileDlg);
