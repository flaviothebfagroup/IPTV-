<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
  <title>BFA IPTV — Users</title>

  <!-- PWA (optional) -->
  <link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
  <meta name="theme-color" content="#ffffff"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
  <link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

  <style>
    /* ===== Tokens ===== */
    :root{
      --accent:#ff9500;
      --fg:#111; --muted:#6e6e73; --bg:#ffffff;
      --panel:#fff; --tile:#f6f6f8; --tileHover:#fff7ea;
      --border:rgba(0,0,0,.14); --borderStrong:rgba(0,0,0,.28);
      --shadow:0 14px 36px rgba(0,0,0,.08);
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    body.dark{
      --bg:#0b0b0c; --fg:#f7f7f8; --muted:#a1a1a8;
      --panel:#151517; --tile:#1a1a1d; --tileHover:#221e18;
      --border:rgba(255,255,255,.16); --borderStrong:rgba(255,255,255,.36);
      --shadow:0 18px 48px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
    a{color:inherit;text-decoration:none}
    /* keep all your CSS from before … unchanged */
    /* Toast */
    .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
    .toast.show{opacity:1}
    .toast.err{background:#ff453a;color:#fff}
  </style>
</head>
<body>
  <!-- ===== NAVBAR ===== -->
  <!-- (keep your same navbar / layout HTML from before) -->

  <!-- ===================================================== -->
  <div class="wrap">
    <!-- (login, notAdmin, usersPg cards stay exactly as before) -->
    <!-- … I keep your markup unchanged … -->
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp, deleteApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword,
      onAuthStateChanged, sendPasswordResetEmail, signOut, createUserWithEmailAndPassword
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getDatabase, ref, get, set, update, remove, onValue
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };
    const LOGO_URL = "/IPTV-/icons/icon-512.png";

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const $ = s => document.querySelector(s);
    function toast(msg, err=false){ const t=$('#toast'); t.textContent=msg; t.className='toast show'+(err?' err':''); setTimeout(()=>t.classList.remove('show'),2200); }

    /* === your navbar/theme/login code here (unchanged) === */

    // ====== Create user (fixed) ======
    document.getElementById('createUserBtn').addEventListener('click', createUserAdminSafe);

    async function createUserAdminSafe(){
      const email=$('#userEmail').value.trim();
      const name=$('#userName').value.trim();
      const role=$('#userRole').value;
      const did=$('#userDealer').value;
      const pass=($('#userPass').value || '123456789');
      const alsoReset=document.getElementById('sendResetAfterCreate').checked;

      if(!email||!name||!role||!did){ toast('Fill all fields', true); return; }
      if(pass.length<6){ toast('Password min 6 chars', true); return; }

      const tempName='admin-helper-'+Date.now();
      const tempApp=initializeApp(firebaseConfig,tempName);
      const tempAuth=getAuth(tempApp);

      try{
        // 1) Create Auth account on secondary app
        const cred=await createUserWithEmailAndPassword(tempAuth,email,pass);
        const uid=cred.user.uid;

        // 2) dealership name & displays (admin read)
        let dname=did;
        try{ const p=await get(ref(db,`dealershipPublic/${did}`)); if(p.exists()) dname=p.val()?.name||did; }catch(_){}
        let displays=[]; try{ const ds=await get(ref(db,`dealership/${did}/displays`)); if(ds.exists()) displays=Object.keys(ds.val()||{}); }catch(_){}

        // 3) WRITE PROFILE WITH ADMIN SESSION
        await set(ref(db,`user/${uid}`),{
          email,name,role,
          dealershipId:did,dealershipName:dname,
          displays,createdAt:Date.now()
        });

        // 4) optional reset
        if(alsoReset){ try{ await sendPasswordResetEmail(tempAuth,email); }catch(_){} }

        toast('User created');
        $('#userEmail').value=''; $('#userName').value=''; $('#userRole').value='user'; $('#userDealer').value=''; $('#userPass').value=''; document.getElementById('sendResetAfterCreate').checked=false;

      }catch(e){
        console.error(e);
        if(e.code?.includes('email-already-in-use')) toast('Email already in use', true);
        else if(e.code?.includes('operation-not-allowed')) toast('Enable Email/Password in Auth', true);
        else toast('Create failed', true);
      }finally{
        try{ await deleteApp(tempApp);}catch(_){}
      }
    }

    // ====== rest of your users live rendering code stays the same ======
  </script>
</body>
</html>
