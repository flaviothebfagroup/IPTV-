<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
  <title>BFA IPTV — Displays</title>

  <!-- PWA (optional) -->
  <link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
  <meta name="theme-color" content="#ffffff"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
  <link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

  <style>
    :root{ --accent:#ff9500; --fg:#111; --muted:#6e6e73; --bg:#ffffff; --panel:#fff; --tile:#f6f6f8; --tileHover:#fff7ea; --border:rgba(0,0,0,.14); --borderStrong:rgba(0,0,0,.28); --shadow:0 14px 36px rgba(0,0,0,.08); --ok:#22c55e; --err:#ef4444; }
    body.dark{ --bg:#0b0b0c; --fg:#f7f7f8; --muted:#a1a1a8; --panel:#151517; --tile:#1a1a1d; --tileHover:#221e18; --border:rgba(255,255,255,.16); --borderStrong:rgba(255,255,255,.36); --shadow:0 18px 48px rgba(0,0,0,.45); }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif; line-height:1.35}
    a{color:inherit;text-decoration:none}

    .topbar{position:sticky;top:0;z-index:100;background:var(--panel);border-bottom:1px solid var(--border);padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px}
    .toprow{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px;position:relative}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:#fff center/cover no-repeat}
    .logotxt{font-weight:900;letter-spacing:.2px}

    .nav{display:flex;gap:10px;margin-left:auto;margin-right:auto}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:9999px;border:1px solid transparent;background:transparent;color:inherit;font-weight:800;font-size:14px;line-height:1;white-space:nowrap}
    .pill:hover{border-color:var(--accent)} .pill.is-active{outline:2px solid var(--accent)}
    .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}

    .more{position:relative}
    #moreBtn .plus{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
    #moreMenu{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;min-width:230px;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none}
    #moreMenu.open{display:block}
    #moreMenu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px}
    #moreMenu a:hover{background:var(--tileHover)} #moreMenu a.is-active{outline:2px solid var(--accent)}
    #moreMenu .ic{width:18px;height:18px;stroke-width:1.9}

    .actions{display:flex;gap:8px;align-items:center}
    .email{max-width:240px;padding:6px 10px;border-radius:9999px;background:var(--tile);border:1px solid var(--border);color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .chip{height:34px;min-width:34px;padding:0 12px;border-radius:9999px;border:1.5px solid var(--borderStrong);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .chip:hover{border-color:var(--accent)} .chip .ic{width:18px;height:18px;stroke-width:2}
    .chip.accent{background:transparent;border-color:var(--accent);color:var(--accent)}
    #hamburger{display:none;border:0;background:transparent;color:var(--accent);height:42px;min-width:42px;padding:0;align-items:center;justify-content:center;position:absolute;right:0;top:50%;transform:translateY(-50%)}
    #hamburger .ic{width:22px;height:22px;stroke:var(--accent);stroke-width:2.35}
    @media (max-width:920px){ .nav{display:none} #hamburger{display:inline-flex} .email{display:none} }

    #sheet{position:fixed;inset:0;z-index:120;display:none}
    #sheet.open{display:block}
    #sheet .back{position:absolute;inset:0;background:rgba(0,0,0,.28)}
    .panel{position:absolute;right:0;top:0;height:100%;width:min(86vw,360px);background:var(--panel);border-left:1px solid var(--border);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:14px}
    .panel .row{display:flex;align-items:center;justify-content:space-between}
    .panel nav{display:grid;gap:8px}
    .panel nav a{justify-content:flex-start}

    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .hstack{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .row3{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin:10px 0}
    @media (max-width:840px){.row3{grid-template-columns:1fr}}
    .label{font-size:12px;color:var(--muted);margin:0 0 6px}
    .input,.select{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
    .input::placeholder{color:var(--muted)}
    .btn{height:34px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center}
    .btn.solid{background:var(--accent);border-color:var(--accent);color:#000}
    .btn.danger{border-color:#ff6b6b;color:#ff6b6b;background:transparent}
    .small{font-size:12px} .muted{color:var(--muted)}

    .list{margin:8px 0 0;padding:0;list-style:none}
    .empty{padding:12px;border:1px dashed var(--border);border-radius:12px;color:var(--muted);text-align:center}
    .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px;margin:8px 0;background:var(--tile);border:1px solid var(--border);border-radius:12px;flex-wrap:wrap}
    .split{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:6px;min-width:220px}
    .tag{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:transparent;font-size:12px;color:var(--muted)}
    .online{display:inline-flex;align-items:center;gap:6px;font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#999}
    .dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
    .vol{display:flex;align-items:center;gap:8px}
    .vol input[type="range"]{width:140px;accent-color:var(--accent)}
    @media (max-width:560px){ .vol input[type="range"]{width:100%} }

    .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
    .toast.show{opacity:1}
    .toast.err{background:#ff453a;color:#fff}

    /* Inline preview (global) */
    .sub.preview{grid-column:1/-1;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:6px}
    .sub.preview .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .sub.preview iframe{width:100%;height:420px;border:1px solid var(--border);border-radius:10px;background:#000}

    /* Channels subpanel (per row) */
    .sub.channels{grid-column:1/-1;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:6px}
    .chgrid{display:grid;grid-template-columns: 56px 1fr auto; gap:8px; align-items:center}
    .chcell{font-size:12px;color:var(--muted);word-break:break-all}
    .chname{font-weight:800;color:var(--fg);font-size:13px}
    .badge{font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}

    /* Channel picker (global) */
    #chPicker .grid{display:grid;grid-template-columns:1fr;gap:8px}
    #chList{max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:6px;background:var(--tile)}
    .chrow{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:10px}
    .chrow:hover{background:var(--tileHover)}
    .churl{font-size:12px;color:var(--muted);word-break:break-all}

    /* Global test player (picker) */
    #testWrap{display:none;margin-top:8px;border:1px dashed var(--border);border-radius:12px;padding:8px}
    #testWrap video{width:100%;height:260px;background:#000;border-radius:10px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="toprow">
      <a class="brand" href="home.html"><span class="logo" id="brandLogo"></span><span class="logotxt">BFA IPTV</span></a>
      <nav class="nav" aria-label="Primary">
        <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
        <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
        <a class="pill is-active" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
        <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
        <div class="more">
          <a id="moreBtn" class="pill" href="javascript:void(0)"><svg class="plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg> More</a>
          <div id="moreMenu" role="menu" aria-label="More">
            <a href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
            <a href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
            <a href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
            <a href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
            <a href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
            <a href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
          </div>
        </div>
      </nav>

      <div class="actions">
        <span id="adminEmail" class="email"></span>
        <button id="themeBtn" class="chip" title="Light/Dark"><svg id="themeIcon" class="ic" viewBox="0 0 24 24"></svg>Theme</button>
        <button id="signOutBtn" class="chip">Sign out</button>
        <button id="hamburger" class="chip" aria-label="Menu"><svg class="ic" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg></button>
      </div>
    </div>

    <!-- Mobile sheet -->
    <div id="sheet" aria-hidden="true">
      <div class="back"></div>
      <aside class="panel" role="dialog" aria-modal="true" aria-label="Menu">
        <div class="row">
          <div class="brand"><span class="logo" id="brandLogoM"></span><span class="logotxt">BFA IPTV</span></div>
          <button id="closeSheet" class="chip" aria-label="Close"><svg class="ic" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
        </div>
        <nav>
          <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
          <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
          <a class="pill is-active" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
          <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
          <div class="muted" style="padding:8px 2px 0">More</div>
          <a class="pill" href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
          <a class="pill" href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
          <a class="pill" href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
          <a class="pill" href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
          <a class="pill" href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
          <a class="pill" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
          <button id="signOutBtnM" class="chip" style="margin-top:8px">Sign out</button>
        </nav>
      </aside>
    </div>
  </header>

  <div class="wrap">
    <!-- Login -->
    <div id="loginBox" class="card" style="max-width:520px;margin:40px auto;display:none">
      <h2 style="margin:0 0 12px">Admin Sign In</h2>
      <div class="row3" style="grid-template-columns:1fr 1fr auto">
        <div><div class="label">Email</div><input id="email" class="input" type="email" placeholder="you@company.com" autocomplete="email"/></div>
        <div><div class="label">Password</div><input id="password" class="input" type="password" placeholder="••••••••" autocomplete="current-password"/></div>
        <div style="display:flex;align-items:end"><button id="loginBtn" class="btn solid" style="width:100%">Sign in</button></div>
      </div>
      <div class="hstack">
        <button id="resetBtn" class="btn">Send reset link</button>
        <span class="small muted">Requires <b>role:"admin"</b> in <code>/user/{uid}</code>.</span>
      </div>
    </div>

    <!-- Displays -->
    <div id="content" class="card" style="display:none">
      <h2 style="margin:0 0 8px">Displays</h2>
      <div class="muted small">New players are created at <code>/Displays/{displayId}.html</code> using your template.</div>

      <div class="row3" style="margin:10px 0">
        <div>
          <div class="label">Dealership</div>
          <select id="dealerForDisplays" class="select"><option value="">Select dealership…</option></select>
        </div>
        <div>
          <div class="label">Optional display ID</div>
          <input id="newDisplayId" class="input" placeholder="Auto if empty (e.g., GW-002)"/>
        </div>
        <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
          <button id="addDisplayBtn" class="btn solid">Add TV</button>
          <button id="ghSetupBtn" class="btn" title="Configure GitHub (owner/repo/branch/token)">GH Setup</button>
          <button id="ghResetBtn" class="btn" title="Clear saved GitHub config">GH Reset</button>
          <!-- Channels setup & picker -->
          <button id="chSetupBtn" class="btn" title="Configure Google Sheet for channels">CH Setup</button>
          <button id="chPickBtn" class="btn" title="Pick channels from the sheet">Pick Channels</button>
          <span id="chSelBadge" class="badge" style="display:none"></span>
        </div>
      </div>

      <!-- Channel picker panel -->
      <div id="chPicker" class="card" style="display:none; margin-top:8px">
        <div class="grid">
          <div class="hstack" style="justify-content:space-between">
            <div class="label">Pick channels to embed</div>
            <button id="chClose" class="btn">Close</button>
          </div>
          <div class="hstack">
            <input id="chSearch" class="input" placeholder="Search name or URL…"/>
            <button id="chReload" class="btn">Reload</button>
            <button id="chClearSel" class="btn">Clear</button>
            <button id="chApply" class="btn solid">Use Selected</button>
          </div>
          <div id="chList"></div>

          <!-- inline test player (picker) -->
          <div id="testWrap">
            <div class="hstack" style="justify-content:space-between;align-items:center;margin-bottom:6px">
              <div class="small muted">Channel preview</div>
              <button id="testStop" class="btn">Stop</button>
            </div>
            <video id="testVideo" controls playsinline></video>
          </div>

          <div class="muted small">Tip: Select any; order is preserved. If you skip this, the default 5 stay.</div>
        </div>
      </div>

      <div class="hstack" style="margin:8px 0">
        <button id="bulkMute" class="btn">Mute all</button>
        <button id="bulkUnmute" class="btn">Unmute all</button>
        <button id="bulkCh1" class="btn">All → CH1</button>
        <button id="displaysReload" class="btn">Reload</button>
        <button id="manageUsers" class="btn" title="Open Users filtered to this dealership">Manage Users</button>
      </div>

      <ul id="displayList" class="list"></ul>
      <div id="displayEmpty" class="empty" style="display:none">Pick a dealership to list TVs.</div>
    </div>
  </div>

  <!-- ===== Player file template (with Volume HUD) ===== -->
  <template id="playerTemplate"><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Digital Signage — Player</title>
  <style>
    :root{ --bg:#000; --fg:#fff; --muted:#b3b3b3; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.15); --accent:#ff9500; --ok:#22c55e; --err:#ef4444; }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{ background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif; overflow:hidden; position:relative; }
    .video-container{position:absolute; inset:0; background:#000}
    video{width:100%; height:100%; object-fit:cover; background:#000}
    .loading-overlay{ position:absolute; inset:0; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity .25s; }
    .loading-overlay.active{opacity:1; pointer-events:auto}
    .spinner{ width:54px; height:54px; border-radius:50%; border:3px solid rgba(255,255,255,.15); border-top-color:#fff; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .channel-info{ position:absolute; top:18px; left:18px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 14px; z-index:50; opacity:0; transform:translateY(-8px); transition:opacity .25s, transform .25s; }
    .channel-info.show{opacity:1; transform:translateY(0)}
    .channel-name{font-weight:800}
    .channel-sub{font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center}
    .live-dot{width:8px;height:8px;border-radius:50%; background:var(--accent); box-shadow:0 0 0 0 rgba(255,149,0,.7); animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,149,0,.7)} 70%{box-shadow:0 0 0 8px rgba(255,149,0,0)} 100%{box-shadow:0 0 0 0 rgba(255,149,0,0)}}
    .status-bar{ position:absolute; right:18px; bottom:18px; display:flex; gap:10px; align-items:center; background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-size:12px; z-index:50; }
    .status-dot{width:10px;height:10px;border-radius:50%; background:var(--ok)}
    .status-dot.disconnected{background:var(--err)}
    .divider{opacity:.45}
    .display-id{ position:absolute; left:18px; bottom:18px; z-index:50; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-size:12px; color:#fff; }
    .error-message{ position:absolute; inset:auto 50% 50% auto; transform:translate(50%,-50%); background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.4); color:#fff; padding:14px 18px; border-radius:14px; display:none; z-index:80; text-align:center; }
    .error-message.show{display:block}
    .error-title{font-weight:800; margin-bottom:4px; color:var(--err)}
    .error-text{font-size:12px; color:#fff}
    .transition-overlay{position:absolute; inset:0; background:#000; z-index:40; opacity:0; pointer-events:none; transition:opacity .25s}
    .transition-overlay.active{opacity:1}
    .volume-control{ position:absolute; left:50%; bottom:100px; transform:translateX(-50%); display:flex; align-items:center; gap:12px; z-index:70; background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .2s; }
    .volume-control.show{opacity:1; pointer-events:auto}
    .vol-btn{ width:40px; height:40px; border-radius:50%; border:1px solid var(--border); background:transparent; color:#fff; font-size:18px; cursor:pointer; }
    .vol-track{width:160px; height:8px; border-radius:6px; background:rgba(255,255,255,.12); position:relative; overflow:hidden; border:1px solid var(--border)}
    .vol-fill{position:absolute; left:0; top:0; bottom:0; width:0%; background:var(--accent)}
    .vol-percent{font-weight:800; min-width:46px; text-align:right}
    .vol-icon{width:22px;height:22px; display:block}
    .bar{opacity:0; transition:opacity .15s}
    .icon-muted .bar, .icon-level-0 .bar{opacity:0}
    .icon-level-1 #bar1{opacity:1}
    .icon-level-2 #bar1, .icon-level-2 #bar2{opacity:1}
    .icon-level-3 #bar1, .icon-level-3 #bar2, #bar3{opacity:1}
    .icon-muted #x1, .icon-muted #x2{opacity:1}
    #x1,#x2{opacity:0; stroke:var(--err); stroke-width:2; stroke-linecap:round}
    .volume-float{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.92); border:1px solid var(--border); color:#fff; padding:26px 36px; border-radius:18px; font-weight:900; font-size:40px; z-index:90; animation:fadeHud 1.8s ease forwards; }
    @keyframes fadeHud{0%{opacity:0; transform:translate(-50%,-50%) scale(.96)} 15%{opacity:1; transform:translate(-50%,-50%) scale(1)} 85%{opacity:1} 100%{opacity:0}}
    @media (prefers-reduced-motion:reduce){ .transition-overlay,.channel-info,.loading-overlay{transition:none} }
  </style>
</head>
<body>
  <div class="volume-control" id="volumeHud" aria-live="polite">
    <button class="vol-btn" id="muteBtn" title="Mute/Unmute" aria-label="Mute/Unmute">
      <svg id="volSvg" class="vol-icon icon-muted" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 10v4h4l5 4V6l-5 4H3Z"/>
        <path id="bar1" class="bar" d="M16 9a3 3 0 0 1 0 6" />
        <path id="bar2" class="bar" d="M18.5 7a6 6 0 0 1 0 10" />
        <path id="bar3" class="bar" d="M21 5a9 9 0 0 1 0 14" />
        <line id="x1" x1="2" y1="2" x2="22" y2="22"/>
        <line id="x2" x1="22" y1="2" x2="2" y2="22"/>
      </svg>
    </button>
    <button class="vol-btn" id="volDown" title="Volume down" aria-label="Volume down">−</button>
    <div class="vol-track"><div class="vol-fill" id="volFill"></div></div>
    <button class="vol-btn" id="volUp" title="Volume up" aria-label="Volume up">+</button>
    <div class="vol-percent" id="volPct">0%</div>
  </div>

  <div class="video-container">
    <video id="videoPlayer" autoplay muted playsinline></video>
  </div>

  <div class="loading-overlay" id="loading"><div class="spinner"></div></div>

  <div class="channel-info" id="channelInfo">
    <div class="channel-name" id="chName">Channel</div>
    <div class="channel-sub"><span class="live-dot"></span><span>LIVE • CH <span id="chNum">1</span></span></div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="statusDot" title="Connection"></div>
    <span id="statusText">Connected</span>
    <span class="divider">•</span>
    <span id="clock">00:00</span>
  </div>

  <div class="display-id">Display: <b id="displayId">—</b></div>

  <div class="error-message" id="errToast">
    <div class="error-title">Stream Unavailable</div>
    <div class="error-text" id="errText">Reconnecting…</div>
  </div>

  <div class="transition-overlay" id="fade"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>

  <script>
    const CONFIG = {
      displayId: '(NEW-CODE)',
      dealershipName: '(NEW-NAME)',
      channels: [
        { id:1, name:'News',   url:'https://citynewsregional.akamaized.net/hls/live/1024052/Regional_Live_7/Video-2Mbps.m3u8', type:'hls' },
        { id:2, name:'Sports', url:'http://fl5.moveonjoy.com/TSN_5/index.m3u8', type:'hls' },
        { id:3, name:'Cooking',url:'https://gusto-xumo.amagi.tv/playlist.m3u8', type:'hls' },
        { id:4, name:'Nature', url:'https://aegis-cloudfront-1.tubi.video/dc8bda97-ce9e-4091-b4e8-11254dea4da6/playlist.m3u8', type:'hls' },
        { id:5, name:'Kids',   url:'https://c0c65b821b3542c3a4dca92702f59944.mediatailor.us-east-1.amazonaws.com/v1/master/04fd913bb278d8775298c26fdca9d9841f37601f/RakutenTV-eu_BabySharkTV/playlist.m3u8', type:'hls' }
      ]
    };

    let hls=null;
    window.currentChannel=1; window.currentVolume=0; window.isMuted=true; let lastVolume=50;
    const $ = (id)=>document.getElementById(id);
    let _hudTimer=null;

    document.addEventListener('DOMContentLoaded', ()=>{
      $('displayId').textContent = CONFIG.displayId;
      initVideo(); initVolumeUI(); tickClock(); setInterval(tickClock, 1000); loadChannel(1);
    });

    function initVideo(){
      const v=$('videoPlayer'); v.volume=0; v.muted=true;
      v.addEventListener('loadstart', ()=> showLoading(true));
      v.addEventListener('canplay',   ()=> showLoading(false));
      v.addEventListener('stalled',   ()=> showLoading(true));
      v.addEventListener('error',     onVideoError);
      $('volUp').onclick   = ()=> volumeUp();
      $('volDown').onclick = ()=> volumeDown();
      $('muteBtn').onclick = ()=> toggleMute();
    }
    function initVolumeUI(){
      const sv=localStorage.getItem('displayVolume'); const sm=localStorage.getItem('displayMuted');
      if(sv!==null){ window.currentVolume=parseInt(sv,10); lastVolume=window.currentVolume||50; }
      if(sm!==null){ window.isMuted=(sm==='true'); }
      const v=$('videoPlayer'); v.volume=(window.currentVolume||0)/100; v.muted=!!window.isMuted; renderVolumeUI();
    }
    function renderVolumeUI(){
      const pct=Math.max(0,Math.min(100,window.currentVolume|0));
      $('volFill').style.width=pct+'%'; $('volPct').textContent=(window.isMuted||pct===0)?'0%':(pct+'%');
      const cls=window.isMuted||pct===0?'icon-muted':pct<30?'icon-level-1':pct<70?'icon-level-2':'icon-level-3';
      $('volSvg').className.baseVal='vol-icon '+cls;
    }
    function showVolumeHudBubble(text){
      const b=document.createElement('div'); b.className='volume-float'; b.textContent=text; document.body.appendChild(b);
      setTimeout(()=>{ b.remove(); }, 1800);
    }
    function flashVolumeHud(){ const hud=$('volumeHud'); hud.classList.add('show'); clearTimeout(_hudTimer); _hudTimer=setTimeout(()=>hud.classList.remove('show'), 1500); }

    function toggleMute(){ window.isMuted?mute():unmute(); }
    function mute(){ const v=$('videoPlayer'); window.isMuted=true; v.muted=true; localStorage.setItem('displayMuted','true'); renderVolumeUI(); flashVolumeHud(); showVolumeHudBubble('MUTED'); }
    function unmute(){ const v=$('videoPlayer'); if(window.currentVolume===0){ window.currentVolume=lastVolume||50; v.volume=window.currentVolume/100; } window.isMuted=false; v.muted=false; v.play().catch(()=>{}); localStorage.setItem('displayMuted','false'); renderVolumeUI(); flashVolumeHud(); showVolumeHudBubble(`${window.currentVolume|0}%`); }
    function setVolume(vol){ vol=Math.max(0,Math.min(100,vol|0)); const v=$('videoPlayer'); window.currentVolume=vol; if(vol>0) lastVolume=vol; v.volume=vol/100; if(vol===0){ window.isMuted=true; v.muted=true; localStorage.setItem('displayMuted','true'); } localStorage.setItem('displayVolume',String(vol)); renderVolumeUI(); flashVolumeHud(); showVolumeHudBubble(window.isMuted?'MUTED':`${vol}%`); }
    function volumeUp(){ if(window.isMuted) unmute(); setVolume(window.currentVolume+10); }
    function volumeDown(){ setVolume(window.currentVolume-10); }

    function showError(msg){ $('errText').textContent=msg; $('errToast').classList.add('show'); }
    function hideError(){ $('errToast').classList.remove('show'); }
    function showLoading(f){ const el=$('loading'); if(f){ el.classList.add('active'); } else { el.classList.remove('active'); hideError(); } }
    function setStatus(connected,msg){ const dot=$('statusDot'),txt=$('statusText'); dot.classList.toggle('disconnected',!connected); txt.textContent=connected?'Connected':('Disconnected'+(msg?` — ${msg}`:'')); }
    function tickClock(){ $('clock').textContent=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'}); }
    function updateChannelInfo(ch){ $('chName').textContent=ch.name||('Channel '+ch.id); $('chNum').textContent=ch.id; const box=$('channelInfo'); box.classList.add('show'); clearTimeout(box._t); box._t=setTimeout(()=>box.classList.remove('show'),4000); }
    function onHlsError(evt,data){ if(!data||!data.fatal) return; showError('Stream error'); }
    function onVideoError(){ showError('Playback error'); }
    function loadChannel(n){
      const ch=CONFIG.channels.find(c=>c.id===n); if(!ch) return;
      const v=$('videoPlayer'); showLoading(true);
      if(Hls.isSupported()){
        if(hls){ try{hls.destroy();}catch(e){} hls=null; }
        hls=new Hls({enableWorker:true,lowLatencyMode:true});
        hls.attachMedia(v);
        hls.loadSource(ch.url);
        hls.on(Hls.Events.MANIFEST_PARSED,()=>{ v.play().then(()=>{ v.volume=window.currentVolume/100; v.muted=window.isMuted; showLoading(false); }).catch(()=>{}); });
        hls.on(Hls.Events.ERROR,onHlsError);
      } else if(v.canPlayType('application/vnd.apple.mpegurl')){
        v.src=ch.url;
        v.play().then(()=>{ v.volume=window.currentVolume/100; v.muted=window.isMuted; showLoading(false); }).catch(()=>{});
      } else { showError('HLS not supported'); }
      updateChannelInfo(ch); window.currentChannel=n;
    }
    window.setStatus=setStatus;
    window.applyVolumeSettings=function(volume,muted){ if(typeof volume==='number') setVolume(volume); if(typeof muted==='boolean') muted?mute():unmute(); };
  </script>

  <!-- Firebase (module) for the player -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, update, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};

    const EMBED=/\bembed=1\b/i.test(location.search)||(window.top!==window.self);
    const app=initializeApp(firebaseConfig, EMBED?'embed':undefined);
    const auth=getAuth(app); if(EMBED){ await setPersistence(auth,inMemoryPersistence); }
    const db=getDatabase(app);

    signInAnonymously(auth).catch(e=>{ console.error('[auth]',e); window.setStatus(false,'anon auth failed'); });

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      const displayId=CONFIG.displayId, dealershipName=CONFIG.dealershipName;

      if(EMBED){
        const dref=ref(db,`displays/${displayId}`);
        onValue(dref,(snap)=>{ const d=snap.val(); if(!d) return;
          if(typeof d.channel==='number'&&d.channel!==window.currentChannel) window.loadChannel(d.channel);
          if(d.volume!==undefined||d.muted!==undefined) window.applyVolumeSettings(d.volume,d.muted);
          window.setStatus(true,''); },
          (err)=>{ console.error('[listener]',err); window.setStatus(false,'listener error'); });
        return;
      }

      try{ await update(ref(db,`user/${user.uid}`),{role:'device',name:displayId,dealershipId:dealershipName,updatedAt:Date.now(),createdAt:Date.now()}); }catch(e){}
      try{
        const dRef=ref(db,`displays/${displayId}`); const snap=await get(dRef);
        if(!snap.exists()){ await update(dRef,{channel:1,volume:50,muted:true,dealership:dealershipName,timestamp:Date.now()}); }
      }catch(e){}

      const dref=ref(db,`displays/${displayId}`);
      onValue(dref,(snap)=>{ const d=snap.val(); if(!d) return;
        if(typeof d.channel==='number'&&d.channel!==window.currentChannel) window.loadChannel(d.channel);
        if(d.volume!==undefined||d.muted!==undefined) window.applyVolumeSettings(d.volume,d.muted);
        window.setStatus(true,''); },
        (err)=>{ console.error('[listener]',err); window.setStatus(false,'listener error'); });

      try{ const hbRef=ref(db,`displays/${displayId}`); const beat=async()=>{ try{ await update(hbRef,{lastSeenAt:Date.now(),updatedAt:Date.now()}); }catch(e){} }; beat(); setInterval(beat,15000); }catch(e){}
    });
  </script>
</body>
</html></template>

  <div id="toast" class="toast"></div>

  <!-- Hls.js for admin-side channel previews -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, get, set, update, remove, onValue, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};
    const LOGO_URL="/IPTV-/icons/icon-512.png";

    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getDatabase(app);

    const $=s=>document.querySelector(s);
    const $$=s=>document.querySelectorAll(s);
    const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
    function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function toast(msg,err=false){const t=$('#toast');t.textContent=msg;t.className='toast show'+(err?' err':'');setTimeout(()=>t.classList.remove('show'),2400);}

    // logos & theme
    $('#brandLogo').style.backgroundImage=`url("${LOGO_URL}")`; const brandLogoM=document.getElementById('brandLogoM'); if(brandLogoM){ brandLogoM.style.backgroundImage=`url("${LOGO_URL}")`; }
    const THEME_KEY='iptv_theme', themeBtn=document.getElementById('themeBtn'), themeIcon=document.getElementById('themeIcon');
    const setThemeIcon=()=>{ const dark=document.body.classList.contains('dark'); themeIcon.innerHTML= dark? `<path d="M21 12a9 9 0 1 1-9-9 6 6 0 0 0 9 9z"/>` : `<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M5 19l-1.4 1.4M20.4 3.6 19 5"/>`; };
    const saved=localStorage.getItem(THEME_KEY)||'light'; document.body.classList.toggle('dark',saved==='dark'); setThemeIcon();
    themeBtn.addEventListener('click',()=>{ const toDark=!document.body.classList.contains('dark'); document.body.classList.toggle('dark',toDark); localStorage.setItem(THEME_KEY,toDark?'dark':'light'); setThemeIcon(); });

    // more menu & mobile sheet
    const moreBtn=document.getElementById('moreBtn'), moreMenu=document.getElementById('moreMenu');
    if(moreBtn){
      moreBtn.addEventListener('click',e=>{e.preventDefault();moreMenu.classList.toggle('open');});
      document.addEventListener('click',e=>{if(!moreMenu.contains(e.target)&&e.target!==moreBtn&&!moreBtn.contains(e.target)){moreMenu.classList.remove('open');}},{capture:true});
      document.addEventListener('keydown',e=>{if(e.key==='Escape') moreMenu.classList.remove('open');});
      const file=(location.pathname.split("/").pop()||"displays.html").toLowerCase();
      moreMenu.querySelectorAll('a').forEach(a=>{const h=(a.getAttribute('href')||'').toLowerCase(); if(h===file){a.classList.add('is-active');}});
    }
    (()=>{ const sheet=document.getElementById('sheet'); const open=()=>{sheet.classList.add('open');document.body.style.overflow='hidden';}; const close=()=>{sheet.classList.remove('open');document.body.style.overflow='';}; document.getElementById('hamburger').addEventListener('click',open); document.getElementById('closeSheet').addEventListener('click',close); sheet.querySelector('.back').addEventListener('click',close); const mainOut=document.getElementById('signOutBtn'); const mobOut=document.getElementById('signOutBtnM'); if(mainOut&&mobOut){mobOut.addEventListener('click',()=> mainOut.click());}})();

    // auth UI
    document.getElementById('loginBtn').addEventListener('click',doLogin);
    document.getElementById('resetBtn').addEventListener('click',async()=>{ const email=document.getElementById('email').value.trim(); if(!email) return toast('Enter email',true); try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(e){ console.error(e); toast('Reset failed',true);} });
    document.getElementById('signOutBtn').addEventListener('click',()=>signOut(auth));
    async function doLogin(){ const email=document.getElementById('email').value.trim(); const pass=document.getElementById('password').value; if(!email||!pass) return toast('Fill email & password',true); try{ await setPersistence(auth,browserLocalPersistence); await signInWithEmailAndPassword(auth,email,pass);}catch(e){console.error(e);toast('Sign-in failed',true);} }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ $('#loginBox').style.display='block'; $('#content').style.display='none'; return; }
      document.getElementById('adminEmail').textContent=user.email||user.uid;
      try{ const snap=await get(ref(db,`user/${user.uid}`)); const u=snap.val()||{}; if(u.role!=='admin'){ $('#loginBox').style.display='none'; $('#content').style.display='none'; alert('Not authorized. Ask an admin to set your role to admin.'); return; } }catch(_){}
      $('#loginBox').style.display='none'; $('#content').style.display='block';
      await refreshDealers(); const did=new URL(location.href).searchParams.get('dealer')||''; if(did){ document.getElementById('dealerForDisplays').value=did; watchDisplays(did,true); }
    });

    async function refreshDealers(){
      const sel=document.getElementById('dealerForDisplays'); sel.innerHTML='<option value="">Select dealership…</option>';
      let map={}; try{ const pub=await get(ref(db,'dealershipPublic')); if(pub.exists()) map=pub.val(); }catch(e){}
      if(!map||Object.keys(map).length===0){ try{ const d=await get(ref(db,'dealership')); if(d.exists()){ const raw=d.val(); for(const id of Object.keys(raw)) map[id]={name:raw[id]?.name||id}; } }catch(e){} }
      Object.entries(map||{}).sort((a,b)=> (a[1]?.name||a[0]).localeCompare(b[1]?.name||b[0]) ).forEach(([id,v])=>{
        const opt=document.createElement('option'); opt.value=id; opt.textContent=v?.name||id; sel.appendChild(opt);
      });
    }

    // ===== Channel source (Google Sheet / JSON) =====
    // Sheet: column B=m3u8, column C=name, starting at row 2
    const CH_KEY='iptv_admin_ch';
    function chCfg(){ try{return JSON.parse(localStorage.getItem(CH_KEY)||'{}');}catch{return{};} }
    function saveChCfg(c){ localStorage.setItem(CH_KEY, JSON.stringify(c)); }
    function chNeedsConfig(){ const c=chCfg(); return !(c.url); }

    async function fetchChannelSheet(){
      const c=chCfg(); if(!c.url) throw new Error('No channel source configured');
      const r=await fetch(c.url,{cache:'no-store'}); if(!r.ok) throw new Error(`Fetch failed [${r.status}]`);
      const ct=(r.headers.get('content-type')||'').toLowerCase(); const txt=await r.text();
      if(/json/.test(ct) || /\.json(\?|$)/i.test(c.url)){
        let data=JSON.parse(txt); const rows=Array.isArray(data)?data:(Array.isArray(data.channels)?data.channels:[]);
        return normalizeChannelRows(rows);
      }else{
        const rows=parseCSVRows(txt); return normalizeChannelRows(rows);
      }
    }
    function parseCSVRows(s){
      const sep=/\t/.test(s)&&!/,/.test(s.split('\n',1)[0])?'\t':',';
      const rows=[]; let i=0, field='', row=[], inQ=false;
      const pushField=()=>{row.push(field); field='';};
      const pushRow=()=>{rows.push(row); row=[];};
      while(i<s.length){
        const ch=s[i++];
        if(inQ){ if(ch==='"'){ if(s[i]==='"'){field+='"'; i++;} else inQ=false; } else field+=ch; }
        else{ if(ch==='"') inQ=true; else if(ch===sep) pushField(); else if(ch==='\r'){} else if(ch==='\n'){ pushField(); pushRow(); } else field+=ch; }
      }
      if(field!==''||row.length){ pushField(); pushRow(); }
      return rows;
    }
    function normalizeChannelRows(rows){
      const out=[];
      if(!Array.isArray(rows)) return out;
      if(rows.length && !Array.isArray(rows[0]) && typeof rows[0]==='object'){
        for(const r of rows){
          const name=r.name||r.title||r.channel||r.Channel||r.Name||'';
          const url=r.url||r.link||r.stream||r.URL||r.Link||'';
          const type=r.type||'hls';
          const code=r.id||r.code||r.Code||name||url;
          if(String(url).trim()){ out.push({code:String(code).trim(),name:String(name||'Channel').trim(),url:String(url).trim(),type:String(type||'hls').trim()}); }
        }
        return out;
      }
      let start=0;
      if(rows.length){
        const hdr=rows[0].map(x=>String(x||'').toLowerCase());
        if(hdr.some(x=>/name|channel/.test(x)) || hdr.some(x=>/url|m3u|link|stream/.test(x))) start=1;
      }
      for(let r=start;r<rows.length;r++){
        const row=rows[r]||[];
        const url=(row[1]||'').trim(); const name=(row[2]||'').trim();
        if(url) out.push({code:name||url,name:name||'Channel',url,type:'hls'});
      }
      return out;
    }

    // picker state
    let chSource=[], chSelectedCodes=new Set(), chSelectedList=[];
    const chPickerEl = document.getElementById('chPicker');
    const chListEl   = document.getElementById('chList');
    const chBadge    = document.getElementById('chSelBadge');

    const testWrap = document.getElementById('testWrap');
    const testVideo = document.getElementById('testVideo');
    let testHls=null;

    function openPicker(){ chPickerEl.style.display='block'; }
    function closePicker(){ chPickerEl.style.display='none'; }
    function setBadge(){
      if(!chSelectedList.length){ chBadge.style.display='none'; chBadge.textContent=''; }
      else{ chBadge.style.display='inline-block'; chBadge.textContent=`${chSelectedList.length} selected`; }
    }

    function renderChannelList(){
      const q=(document.getElementById('chSearch').value||'').trim().toLowerCase();
      chListEl.innerHTML='';
      const frag=document.createDocumentFragment();
      const list=chSource.filter(r=>{
        if(!q) return true;
        return (r.name||'').toLowerCase().includes(q) || (r.url||'').toLowerCase().includes(q) || (r.code||'').toLowerCase().includes(q);
      });
      if(!list.length){
        const div=document.createElement('div'); div.className='muted small'; div.style.padding='8px 4px'; div.textContent='No channels found. Reload or change your search.'; frag.appendChild(div);
      }else{
        list.forEach((r)=>{
          const row=document.createElement('div'); row.className='chrow';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=chSelectedCodes.has(r.code); cb.addEventListener('change',()=>{ if(cb.checked){ chSelectedCodes.add(r.code); }else{ chSelectedCodes.delete(r.code); } chSelectedList=list.filter(x=>chSelectedCodes.has(x.code)); setBadge(); });
          const col=document.createElement('div'); col.style.flex='1';
          col.innerHTML=`<div class="chname">${esc(r.name||'Channel')}</div><div class="churl">${esc(r.url)}</div>`;
          const test=document.createElement('button'); test.className='btn'; test.textContent='Preview'; test.addEventListener('click',()=>playTest(r.url));
          row.append(cb,col,test);
          frag.appendChild(row);
        });
      }
      chListEl.appendChild(frag);
    }
    function stopTest(){
      if(testHls){ try{testHls.destroy();}catch{} testHls=null; }
      testVideo.pause(); testVideo.removeAttribute('src'); testWrap.style.display='none';
    }
    function playTest(url){
      stopTest(); testWrap.style.display='block';
      if(Hls.isSupported()){
        testHls=new Hls({lowLatencyMode:true}); testHls.attachMedia(testVideo); testHls.loadSource(url);
      }else if(testVideo.canPlayType('application/vnd.apple.mpegurl')){ testVideo.src=url; }
      testVideo.play().catch(()=>{});
    }
    document.getElementById('testStop').addEventListener('click',stopTest);

    // picker buttons
    document.getElementById('chSetupBtn').addEventListener('click',()=>{
      const c=chCfg(); const url=prompt('Paste the published CSV (or JSON) URL for the channels.\nSheet: B=URL, C=Name, row2+.', c.url||'');
      if(url){ saveChCfg({...c,url:url.trim()}); toast('Channel source saved'); }
    });
    document.getElementById('chPickBtn').addEventListener('click',async()=>{
      if(chNeedsConfig()) return toast('Run CH Setup first',true);
      try{ chSource=await fetchChannelSheet(); chSelectedCodes=new Set((chSelectedList||[]).map(x=>x.code)); renderChannelList(); openPicker(); }catch(e){ console.error(e); toast('Load channels failed',true); }
    });
    document.getElementById('chReload').addEventListener('click',async()=>{
      try{ chSource=await fetchChannelSheet(); renderChannelList(); toast('Channels reloaded'); }catch(e){ toast('Reload failed',true); }
    });
    document.getElementById('chClearSel').addEventListener('click',()=>{ chSelectedCodes.clear(); chSelectedList=[]; renderChannelList(); setBadge(); });
    document.getElementById('chApply').addEventListener('click',()=>{
      chSelectedList = chSource.filter(x=>chSelectedCodes.has(x.code)).slice(0,50);
      setBadge(); closePicker(); toast(`${chSelectedList.length} channel(s) selected`);
    });
    document.getElementById('chClose').addEventListener('click',closePicker);
    document.getElementById('chSearch').addEventListener('input',debounce(renderChannelList,150));

    // ===== GitHub config + file ops =====
    const GH_KEY='iptv_admin_gh';
    function ghCfg(){ try{return JSON.parse(localStorage.getItem(GH_KEY)||'{}');}catch{return{};} }
    function saveGhCfg(c){ localStorage.setItem(GH_KEY, JSON.stringify(c)); }
    function ghHeaders(){ const t=ghCfg().token||''; const h={'Accept':'application/vnd.github+json'}; if(t) h['Authorization']=`Bearer ${t}`; return h; }
    function ghPathFor(displayId){ const base='Displays'; return `${base}/${displayId}.html`; }

    async function ghGet(path){
      const c=ghCfg(); if(!c.owner||!c.repo||!c.branch||!c.token) throw new Error('GitHub not configured');
      const url=`https://api.github.com/repos/${encodeURIComponent(c.owner)}/${encodeURIComponent(c.repo)}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(c.branch)}`;
      const r=await fetch(url,{headers:ghHeaders()}); if(!r.ok) throw new Error('GH get failed '+r.status);
      return await r.json(); // {content,sha}
    }
    async function ghPut(path, content, message, sha=null){
      const c=ghCfg(); if(!c.owner||!c.repo||!c.branch||!c.token) throw new Error('GitHub not configured');
      const url=`https://api.github.com/repos/${encodeURIComponent(c.owner)}/${encodeURIComponent(c.repo)}/contents/${encodeURIComponent(path)}`;
      const body={message:message||`Update ${path}`, content:btoa(unescape(encodeURIComponent(content))), branch:c.branch}; if(sha) body.sha=sha;
      const r=await fetch(url,{method:'PUT',headers:{...ghHeaders(),'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok){ const t=await r.text().catch(()=> ''); throw new Error('GH put failed '+r.status+' '+t); }
      return await r.json();
    }
    function openGhSetup(){
      const c=ghCfg();
      const owner=prompt('GitHub owner/org:', c.owner||'')||'';
      const repo =prompt('Repository name:', c.repo||'')||'';
      const branch=prompt('Branch name:', c.branch||'main')||'main';
      const token=prompt('GitHub token (repo:contents):', c.token||'')||'';
      saveGhCfg({owner,repo,branch,token}); toast('GitHub config saved');
    }
    document.getElementById('ghSetupBtn').addEventListener('click',openGhSetup);
    document.getElementById('ghResetBtn').addEventListener('click',()=>{ localStorage.removeItem(GH_KEY); toast('GitHub config cleared'); });

    // ===== Displays listing & controls =====
    const displayList=document.getElementById('displayList');
    const displayEmpty=document.getElementById('displayEmpty');
    let unsubDisplays=null, currentDealerId='';

    document.getElementById('dealerForDisplays').addEventListener('change',e=>{ watchDisplays(e.target.value,true); });
    document.getElementById('manageUsers').addEventListener('click',()=>{ if(currentDealerId) location.href=`users.html?dealer=${encodeURIComponent(currentDealerId)}`; });

    async function watchDisplays(dealerId, first=false){
      currentDealerId=dealerId;
      displayList.innerHTML=''; displayEmpty.style.display=dealerId?'none':'block';
      if(unsubDisplays) unsubDisplays(); unsubDisplays=null;
      if(!dealerId) return;
      const qRef=query(ref(db,'displays'), orderByChild('dealership'), equalTo(dealerId));
      const off=onValue(qRef,(snap)=>{
        const map=snap.val()||{};
        renderDisplays(dealerId, map);
      });
      unsubDisplays=()=> off();
    }

    function renderDisplays(dealerId, map){
      displayList.innerHTML='';
      const ids=Object.keys(map).sort();
      if(!ids.length){ displayEmpty.style.display='block'; return; }
      displayEmpty.style.display='none';
      ids.forEach(id=>{
        const d=map[id]||{};
        const item=document.createElement('li'); item.className='item';
        const left=document.createElement('div'); left.className='col';
        const online=(Date.now()-(d.lastSeenAt||0)<45000);
        left.innerHTML=`
          <div class="hstack">
            <span class="tag">ID: <b>${esc(id)}</b></span>
            <span class="online"><span class="dot ${online?'ok':'err'}"></span>${online?'Online':'Offline'}</span>
            <span class="tag">CH ${esc(d.channel||1)}</span>
            <span class="tag">Vol ${esc(d.volume??0)}${d.muted?' (muted)':''}</span>
          </div>
          <div class="small muted">Updated ${new Date(d.updatedAt||d.timestamp||0).toLocaleString()}</div>
        `;

        const right=document.createElement('div'); right.className='col';
        const controls=document.createElement('div'); controls.className='split';
        // quick CH buttons
        for(let ch=1;ch<=5;ch++){
          const b=document.createElement('button'); b.className='btn'; b.textContent='CH'+ch;
          b.addEventListener('click',()=> setDb(id,{channel:ch}));
          controls.appendChild(b);
        }
        // vol + mute
        const vol=document.createElement('div'); vol.className='vol';
        const rng=document.createElement('input'); rng.type='range'; rng.min=0; rng.max=100; rng.value=Number(d.volume??0);
        rng.addEventListener('input',debounce(()=> setDb(id,{volume:parseInt(rng.value,10), muted:false}),150));
        const mute=document.createElement('button'); mute.className='btn'; mute.textContent=d.muted?'Unmute':'Mute';
        mute.addEventListener('click',()=> setDb(id,{muted:!d.muted}));
        vol.append(rng,mute);

        const links=document.createElement('div'); links.className='split';
        const open=document.createElement('a'); open.className='btn'; open.href=`Displays/${encodeURIComponent(id)}.html`; open.target='_blank'; open.textContent='Open';
        const embed=document.createElement('a'); embed.className='btn'; embed.href=`Displays/${encodeURIComponent(id)}.html?embed=1`; embed.target='_blank'; embed.textContent='Embed';
        const chans=document.createElement('button'); chans.className='btn'; chans.textContent='Channels';
        chans.addEventListener('click',()=> toggleChannelsPanel(item,id,dealerId));

        links.append(open,embed,chans);

        right.append(controls,vol,links);
        item.append(left,right);

        // placeholder for channels panel
        const sub=document.createElement('div'); sub.className='sub channels'; sub.style.display='none'; sub.dataset.kind='channels';
        sub.innerHTML=`<div class="small muted">Loading channels…</div>`;
        item.appendChild(sub);

        displayList.appendChild(item);
      });
    }

    async function setDb(id,patch){ try{ await update(ref(db,`displays/${id}`), {...patch, updatedAt:Date.now()}); }catch(e){ console.error(e); toast('Update failed',true); } }

    // toggle + load channels for a display (from GH file)
    async function toggleChannelsPanel(item, displayId, dealerId){
      const panel=item.querySelector('.sub.channels'); if(!panel) return;
      const isOpen=panel.style.display!=='none'; // currently visible?
      if(isOpen){ panel.style.display='none'; return; }
      panel.style.display='block';
      try{
        const file=await ghGet(ghPathFor(displayId));
        const html=atob(file.content.replace(/\n/g,'')); // player file HTML
        const channels=parseChannelsFromPlayer(html); // [{id,name,url,type}]
        panel.innerHTML='';
        const title=document.createElement('div'); title.className='hstack'; title.style.justifyContent='space-between';
        title.innerHTML=`<div class="label">Current channels for <b>${esc(displayId)}</b></div>`;
        const apply=document.createElement('button'); apply.className='btn solid'; apply.textContent='Push Selected (global) to this TV';
        apply.addEventListener('click',()=> pushSelectedChannelsTo(displayId, dealerId, file.sha));
        title.appendChild(apply);
        panel.appendChild(title);

        // table of channels + preview buttons
        const grid=document.createElement('div'); grid.className='chgrid';
        channels.forEach(ch=>{
          const tag=document.createElement('div'); tag.className='badge'; tag.textContent='CH '+ch.id;
          const cell=document.createElement('div'); cell.className='chcell'; cell.innerHTML=`<div class="chname">${esc(ch.name||('Channel '+ch.id))}</div><div class="churl">${esc(ch.url||'')}</div>`;
          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Preview';
          btn.addEventListener('click',()=> playTest(ch.url));
          grid.append(tag,cell,btn);
        });
        panel.appendChild(grid);
      }catch(e){ console.error(e); panel.innerHTML=`<div class="small muted">Could not load player file. Check GH config & file path.</div>`; }
    }

    function parseChannelsFromPlayer(html){
      // very small parser: find "channels: [ ... ]" inside CONFIG
      const m=html.match(/channels\s*:\s*\[([\s\S]*?)\]/);
      if(!m) return [];
      const arrTxt='['+m[1]+']';
      // make it JSON-ish: quote keys & single quotes -> double
      const jsonish=arrTxt
        .replace(/(\w+)\s*:/g,'"$$$1":')
        .replace(/'/g,'"');
      let arr=[]; try{ arr=JSON.parse(jsonish.replace(/\bNaN\b/g,'null')); }catch{ arr=[]; }
      // coerce ids
      return (arr||[]).map((x,i)=>({ id:Number(x.id||i+1), name:String(x.name||('Channel '+(i+1))), url:String(x.url||''), type:String(x.type||'hls') }));
    }

    function channelsFromSelectionOrDefault(){
      const list=(chSelectedList && chSelectedList.length>=1) ? chSelectedList.slice(0,5) : [
        {name:'News',url:'https://citynewsregional.akamaized.net/hls/live/1024052/Regional_Live_7/Video-2Mbps.m3u8',type:'hls'},
        {name:'Sports',url:'http://fl5.moveonjoy.com/TSN_5/index.m3u8',type:'hls'},
        {name:'Cooking',url:'https://gusto-xumo.amagi.tv/playlist.m3u8',type:'hls'},
        {name:'Nature',url:'https://aegis-cloudfront-1.tubi.video/dc8bda97-ce9e-4091-b4e8-11254dea4da6/playlist.m3u8',type:'hls'},
        {name:'Kids',url:'https://c0c65b821b3542c3a4dca92702f59944.mediatailor.us-east-1.amazonaws.com/v1/master/04fd913bb278d8775298c26fdca9d9841f37601f/RakutenTV-eu_BabySharkTV/playlist.m3u8',type:'hls'},
      ];
      // decorate ids 1..N
      return list.slice(0,5).map((c,idx)=>({id:idx+1,name:c.name,url:c.url,type:c.type||'hls'}));
    }

    function buildPlayerFile(displayId, dealerId){
      const tpl=document.getElementById('playerTemplate').innerHTML;
      const chans=channelsFromSelectionOrDefault();
      const chanTxt=chans.map(c=>`{ id:${c.id}, name:'${c.name.replace(/'/g,"\\'")}', url:'${c.url.replace(/'/g,"\\'")}', type:'${c.type}' }`).join(',\n        ');
      return tpl
        .replace("displayId: '(NEW-CODE)'", `displayId: '${displayId}'`)
        .replace("dealershipName: '(NEW-NAME)'", `dealershipName: '${dealerId}'`)
        .replace(/channels:\s*\[[\s\S]*?\]\s*?\n\s*\}/, `channels: [\n        ${chanTxt}\n      ]\n    }`);
    }

    async function pushSelectedChannelsTo(displayId, dealerId, existingSha=null){
      try{
        const html=buildPlayerFile(displayId,dealerId);
        const path=ghPathFor(displayId);
        // if sha not provided, try fetch to get it
        let sha=existingSha;
        if(!sha){ try{ const f=await ghGet(path); sha=f.sha; }catch{} }
        await ghPut(path, html, `Update channels for ${displayId}`, sha||undefined);
        toast('Channels pushed to GitHub');
      }catch(e){ console.error(e); toast('Push failed (check GH config/perm)',true); }
    }

    // ===== Add TV =====
    document.getElementById('addDisplayBtn').addEventListener('click', addDisplayFlow);

    async function addDisplayFlow(){
      const dealerId=document.getElementById('dealerForDisplays').value||'';
      if(!dealerId) return toast('Pick a dealership first',true);
      let displayId=(document.getElementById('newDisplayId').value||'').trim();
      if(!displayId){
        const pref=dealerId.slice(0,2).toUpperCase();
        displayId = `${pref}-${Math.floor(Math.random()*900+100)}`; // e.g. GW-742
      }
      // write player file to GH
      try{
        const html=buildPlayerFile(displayId,dealerId);
        await ghPut(ghPathFor(displayId), html, `Create player for ${displayId}`);
      }catch(e){ console.error(e); return toast('GitHub write failed — check GH Setup',true); }

      // seed DB node
      try{
        await update(ref(db,`displays/${displayId}`), {channel:1,volume:50,muted:true,dealership:dealerId,timestamp:Date.now(),updatedAt:Date.now()});
        toast(`TV ${displayId} created`);
        document.getElementById('newDisplayId').value='';
        // refresh list (onValue will reflect automatically)
      }catch(e){ console.error(e); toast('Database seed failed',true); }
    }

    // ===== Bulk actions =====
    document.getElementById('bulkMute').addEventListener('click',()=> bulkPatch({muted:true}));
    document.getElementById('bulkUnmute').addEventListener('click',()=> bulkPatch({muted:false}));
    document.getElementById('bulkCh1').addEventListener('click',()=> bulkPatch({channel:1}));
    document.getElementById('displaysReload').addEventListener('click',()=>{ if(currentDealerId) watchDisplays(currentDealerId,true); });

    async function bulkPatch(patch){
      if(!currentDealerId) return;
      try{
        const snap=await get(query(ref(db,'displays'), orderByChild('dealership'), equalTo(currentDealerId)));
        const map=snap.val()||{};
        await Promise.all(Object.keys(map).map(id=> update(ref(db,`displays/${id}`), {...patch, updatedAt:Date.now()}) ));
        toast('Bulk update sent');
      }catch(e){ console.error(e); toast('Bulk update failed',true); }
    }

  </script>
</body>
</html>
