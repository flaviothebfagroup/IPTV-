<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BFA IPTV — Displays</title>

<style>
  :root{
    --bg:#f5f5f7;--fg:#111;--muted:#6e6e73;--panel:#fff;--border:rgba(0,0,0,.12);
    --tile:#f2f2f7;--tileActive:#ededf2;--shadow:0 14px 36px rgba(0,0,0,.10);
    --accent:#ff9500;--danger:#e11d48;
    --rad:16px; --pad:16px; --gap:10px; --btnH:40px; --btnFS:14px;
    --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
  a{color:inherit;text-decoration:none}

  /* Top */
  .top{position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px var(--pad);background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .lhs{display:flex;align-items:center;gap:10px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .logo{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--tile) center/cover no-repeat}

  /* Common buttons/inputs */
  .chip,.btn, a.btn, .select,.input{
    height:var(--btnH);padding:0 16px;border-radius:9999px;border:1px solid var(--border);background:var(--tile);
    font-weight:700;font-size:var(--btnFS);line-height:1;white-space:nowrap;display:inline-flex;align-items:center;justify-content:center;
  }
  .chip{padding:0 14px}
  .btn, a.btn{cursor:pointer}
  .btn:hover, a.btn:hover{border-color:var(--accent);background:var(--tileActive)}
  .btn.danger, a.btn.danger{background:transparent;border-color:rgba(225,29,72,.35);color:var(--danger)}
  .btn.danger:hover, a.btn.danger:hover{background:#fff1f3;border-color:var(--danger)}
  .btn:focus-visible, a.btn:focus-visible, .input:focus-visible, .select:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .select{min-width:210px;background:transparent}
  .input{min-width:220px;background:transparent}

  /* Shell */
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:var(--pad);box-shadow:var(--shadow)}
  .muted{color:var(--muted);font-size:12px}
  .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px}

  /* List */
  .list{list-style:none;margin:14px 0 0;padding:0}
  .item{
    display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;
    background:var(--tile);border:1px solid var(--border);border-radius:16px;padding:12px;margin:10px 0;
  }
  .title{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .tag{padding:2px 8px;border:1px solid var(--border);border-radius:9999px;background:transparent;font-size:12px;color:var(--muted)}
  .small{font-size:12px}
  .mutedline{color:var(--muted)}
  .online{display:inline-flex;align-items:center;gap:6px;font-size:12px}
  .dot{width:8px;height:8px;border-radius:999px;background:#999}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--err)} .dot.warn{background:var(--warn)}

  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .vol{display:flex;align-items:center;gap:8px}
  .vol input[type="range"]{width:140px;accent-color:var(--accent)}
  @media (min-width:681px){
    .actions .btn, .actions a.btn, .actions .select{min-width:110px;justify-content:center}
  }
  @media (max-width:680px){
    .item{grid-template-columns:1fr}
    .actions{justify-content:flex-start}
    .vol input[type="range"]{width:100%}
  }

  /* Dialogs */
  dialog{border:0;padding:0;border-radius:18px;width:min(980px,96vw);max-height:90vh}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .dlg{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
  .dlgHead{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .usersList{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:720px){ .usersList{grid-template-columns:1fr} }
  .uItem{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--tile)}
  .badge{border:1px solid var(--border);border-radius:9999px;padding:2px 8px;font-size:11px;color:var(--muted)}
  .frameWrap{width:min(1100px,96vw);height:min(70vh,760px);background:#000;border-radius:18px;overflow:hidden;border:1px solid var(--border)}
  .frameWrap iframe{width:100%;height:100%;border:0;display:block}

  /* Toast */
  .toast{position:fixed;left:50%;bottom:26px;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;z-index:99}
  .toast.show{opacity:1}
  .toast.err{background:#ff453a;color:#fff}
</style>
</head>
<body>

<!-- Top bar -->
<div class="top">
  <div class="lhs">
    <div class="logo" id="brandLogo" title="IPTV"></div>
    <div class="brand">BFA IPTV — Admin</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <a class="chip" href="home.html">← Home</a>
    <span id="who" class="muted"></span>
    <button id="reloadBtn" class="btn">Reload</button>
    <button id="signOutBtn" class="btn">Sign out</button>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <h2 style="margin:0">Displays</h2>
    <div class="muted">Pick a dealership, add TVs, and control channel / volume / mute.</div>

    <!-- Controls -->
    <div class="bar">
      <select id="dealerSel" class="select"><option value="">Select dealership…</option></select>
      <input id="newDisplayId" class="input" placeholder="Optional display ID (auto if empty)"/>
      <button id="addBtn" class="btn">Add TV</button>
      <button id="checkUsersBtn" class="btn">Check Users</button>
      <a id="jumpUsers" class="btn" href="users.html">Open Users Page</a>
    </div>

    <div class="bar" style="margin-top:10px">
      <button id="bulkMute" class="btn">Mute all</button>
      <button id="bulkUnmute" class="btn">Unmute all</button>
      <button id="bulkCh1" class="btn">All → CH1</button>
      <button id="refreshBtn" class="btn">Reload</button>
    </div>

    <!-- Live list -->
    <ul id="list" class="list"></ul>
    <div id="empty" class="muted" style="display:none">Pick a dealership to list TVs.</div>
  </div>
</div>

<!-- Users dialog -->
<dialog id="usersDlg">
  <div class="dlg">
    <div class="dlgHead">
      <div>
        <h3 style="margin:0">Users in <span id="dlgDealerName">—</span></h3>
        <div class="muted" id="dlgCounts">Loading…</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <a id="dlgOpenUsers" class="btn" href="users.html">Open Users Page</a>
        <button id="dlgClose" class="btn">Close</button>
      </div>
    </div>
    <div id="usersList" class="usersList"></div>
  </div>
</dialog>

<!-- Preview dialog -->
<dialog id="previewDlg">
  <div class="dlg">
    <div class="dlgHead">
      <h3 style="margin:0" id="pvTitle">Preview</h3>
      <div style="display:flex;gap:8px">
        <a id="pvOpenTab" class="btn" target="_blank" rel="noopener">Open Remote</a>
        <button id="pvClose" class="btn">Close</button>
      </div>
    </div>
    <div class="frameWrap"><iframe id="pvFrame" allow="autoplay; fullscreen"></iframe></div>
    <div class="muted" style="margin-top:8px">This embeds <code>remote-control.html</code>. Use “Open Remote” for full control.</div>
  </div>
</dialog>

<div id="toast" class="toast"></div>

<script type="module">
/* ---------- Firebase ---------- */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getDatabase, ref, get, set, update, remove, onValue, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
  authDomain: "iptv-bfa.firebaseapp.com",
  databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
  projectId: "iptv-bfa",
  storageBucket: "iptv-bfa.firebasestorage.app",
  messagingSenderId: "838790935867",
  appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
};
const LOGO_URL = "https://flaviothebfagroup.github.io/IPTV-/icons/icon-512.png";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

/* ---------- helpers ---------- */
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}
function toast(msg,err=false){const t=$("#toast");t.textContent=msg;t.className='toast show'+(err?' err':'');setTimeout(()=>t.classList.remove('show'),2200);}
const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
function initialsFromName(name){
  const raw=(name||'').trim(); if(!raw) return 'DS';
  let parts=raw.match(/[A-ZÀ-ÖØ-Ý][a-zà-öø-ÿ]*/g)||raw.match(/[A-Za-zÀ-ÖØ-öø-ÿ]+/g)||[];
  let a=parts[0]||'', b=parts[1]||''; let p=(a? a[0]:'')+(b? b[0]:'');
  if(p.length<2 && a.length>=2) p=a.slice(0,2);
  return p.toUpperCase();
}
function nextSuffix(list,pref){
  let max=0;
  list.forEach(id=>{
    const m=id.match(new RegExp('^'+pref+'-(\\d{3})$'));
    if(m){ const n=parseInt(m[1],10); if(n>max) max=n;}
  });
  return max+1;
}
function onlineNow(v){
  const now=Date.now();
  return (v.lastSeenAt && (now-v.lastSeenAt)<60000) || (v.timestamp && (now-v.timestamp)<120000);
}

/* set logo */
document.getElementById('brandLogo').style.backgroundImage = `url("${LOGO_URL}")`;

/* ---------- auth gate ---------- */
let unsub=null;
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href='home.html'; return; }
  $("#who").textContent=user.email||user.uid;
  const u = (await get(ref(db,'user/'+user.uid))).val()||{};
  if(u.role!=='admin'){ alert('Admin only'); await signOut(auth); location.href='home.html'; return; }
  await loadDealers();                       // fill the select
  // preselect via ?dealer=
  const q = new URLSearchParams(location.search);
  const pre = q.get('dealer')||'';
  if(pre && $('#dealerSel').querySelector(`option[value="${CSS.escape(pre)}"]`)){
    $('#dealerSel').value = pre;
  }
  attachWatcher();
});
$("#signOutBtn").addEventListener('click', ()=>signOut(auth).then(()=>location.href='home.html'));
$("#reloadBtn").addEventListener('click', ()=>location.reload());

/* ---------- Dealership select ---------- */
async function loadDealers(){
  const sel = $('#dealerSel');
  sel.innerHTML = '<option value="">Select dealership…</option>';
  let map={};
  try{ const s=await get(ref(db,'dealershipPublic')); map=s.val()||{}; }catch(e){}
  if(!Object.keys(map).length){
    try{ const s=await get(ref(db,'dealership')); const raw=s.val()||{}; for(const id of Object.keys(raw)) map[id]={name:raw[id]?.name||id}; }catch(e){}
  }
  Object.entries(map).sort((a,b)=> (a[1]?.name||a[0]).localeCompare(b[1]?.name||b[0]))
    .forEach(([id,info])=>{
      const o=document.createElement('option'); o.value=id; o.textContent=info?.name||id; sel.appendChild(o);
    });
}
$('#dealerSel').addEventListener('change', attachWatcher);

/* ---------- Watch & render ---------- */
function renderList(did, map){
  const ul=$('#list'); ul.innerHTML='';
  const ids=Object.keys(map||{}).sort();
  if(!ids.length){ $('#empty').style.display='block'; return; }
  $('#empty').style.display='none';
  ids.forEach(id=>{
    const st=map[id]||{};
    const on = onlineNow(st);
    const li=document.createElement('li'); li.className='item';
    li.innerHTML = `
      <div>
        <div class="title">
          <b>${esc(id)}</b>
          <span class="tag">${esc(did)}</span>
          <span class="online"><i class="dot ${on?'ok':'err'}"></i>${on?'Online':'Offline'}</span>
        </div>
        <div class="mutedline small">CH ${st.channel ?? 1} • VOL ${st.volume ?? 0} • ${st.muted ? 'Muted' : 'Unmuted'}</div>
      </div>
      <div class="actions">
        <select data-id="${esc(id)}" class="select chsel">
          ${[1,2,3,4,5].map(n=>`<option value="${n}" ${n===(st.channel||1)?'selected':''}>CH ${n}</option>`).join('')}
        </select>
        <div class="vol">
          <span class="muted small">VOL</span>
          <input type="range" min="0" max="100" value="${st.volume ?? 0}" data-id="${esc(id)}" class="vslider"/>
        </div>
        <button class="btn toggleMute" data-id="${esc(id)}" data-muted="${!!st.muted}">${st.muted?'Unmute':'Mute'}</button>
        <button class="btn previewBtn" data-id="${esc(id)}">Preview</button>
        <a class="btn" target="_blank" rel="noopener" href="remote-control.html?display=${encodeURIComponent(id)}">Remote</a>
        <button class="btn danger removeBtn" data-id="${esc(id)}">Delete</button>
      </div>
    `;
    ul.appendChild(li);
  });

  // events
  $$('.chsel').forEach(el=>{
    el.addEventListener('change', e=>{
      const id=e.target.dataset.id; const ch=parseInt(e.target.value,10);
      writeDisplay(id, { channel: ch });
    });
  });
  const debouncedWrite = debounce((id,val)=> writeDisplay(id,{volume:val}), 160);
  $$('.vslider').forEach(el=>{
    el.addEventListener('input', e=>{
      const id=e.target.dataset.id; const v=parseInt(e.target.value,10);
      debouncedWrite(id, v);
    });
  });
  $$('.toggleMute').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id=btn.dataset.id; const cur = btn.getAttribute('data-muted')==='true';
      writeDisplay(id, { muted: !cur });
    });
  });
  $$('.previewBtn').forEach(btn=>{
    btn.addEventListener('click', ()=> openPreview(btn.dataset.id));
  });
  $$('.removeBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id=btn.dataset.id; if(!confirm(`Remove ${id}?`)) return;
      try{
        await remove(ref(db, `dealership/${did}/displays/${id}`)).catch(()=>{});
        await remove(ref(db, `displays/${id}`)).catch(()=>{});
        toast('Display removed');
      }catch(e){ console.error(e); toast('Remove failed', true); }
    });
  });
}

/* ---------- Preview dialog ---------- */
function openPreview(displayId){
  $('#pvTitle').textContent = `Preview — ${displayId}`;
  const url = `remote-control.html?display=${encodeURIComponent(displayId)}&preview=1`;
  $('#pvOpenTab').href = url;
  $('#pvFrame').src = url;
  $('#previewDlg').showModal();
}
$('#pvClose').addEventListener('click', ()=>$('#previewDlg').close());

/* ---------- Users dialog ---------- */
$('#checkUsersBtn').addEventListener('click', openUsersDialog);
$('#dlgClose').addEventListener('click', ()=>$('#usersDlg').close());

async function openUsersDialog(){
  const did = $('#dealerSel').value;
  if(!did) return toast('Pick a dealership first', true);

  // resolve nice name
  let dname = did;
  try{ const p=await get(ref(db,'dealershipPublic/'+did)); if(p.exists()) dname=p.val()?.name||did; }catch(_){}
  $('#dlgDealerName').textContent = dname;
  $('#dlgOpenUsers').href = `users.html?dealer=${encodeURIComponent(did)}`;

  // load users
  let map={}; try{ const u=await get(ref(db,'user')); if(u.exists()) map=u.val(); }catch(e){}
  const now=Date.now();
  const rows = Object.entries(map).map(([uid,v])=>({uid,...v})).filter(r=>r.dealershipId===did);
  const counts = {
    admin: rows.filter(r=>r.role==='admin').length,
    device: rows.filter(r=>r.role==='device').length,
    user: rows.filter(r=>(!r.role || r.role==='user')).length,
    disabled: rows.filter(r=>r.role==='disabled').length
  };
  $('#dlgCounts').textContent = `Admins: ${counts.admin} • Devices: ${counts.device} • Users: ${counts.user} • Disabled: ${counts.disabled}`;

  const list = $('#usersList'); list.innerHTML='';
  rows.sort((a,b)=> (a.role||'user').localeCompare(b.role||'user') || (a.name||'').localeCompare(b.name||''));
  rows.forEach(r=>{
    const isDevice = r.role==='device';
    const active = isDevice && r.updatedAt && (now-r.updatedAt)<10*60*1000;
    const div=document.createElement('div'); div.className='uItem';
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        ${isDevice?`<i class="dot ${active?'ok':'err'}" title="${active?'Active now':'Inactive'}"></i>`:''}
        <b>${esc(r.name||'—')}</b>
        <span class="badge">${esc(r.role||'user')}</span>
        <span class="muted small">${esc(r.email||'')}</span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        ${r.email?'<button class="btn resetBtn" data-email="'+esc(r.email)+'">Reset</button>':''}
      </div>
    `;
    list.appendChild(div);
  });

  // attach reset handlers
  list.querySelectorAll('.resetBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const email=btn.dataset.email;
      try{ await sendPasswordResetEmail(auth, email); toast('Reset sent'); }
      catch(e){ console.error(e); toast('Reset failed', true); }
    });
  });

  $('#usersDlg').showModal();
}

/* ---------- Attach watcher ---------- */
async function attachWatcher(){
  if(unsub){unsub();unsub=null;}
  $('#list').innerHTML='';
  const did = $('#dealerSel').value;
  $('#jumpUsers').href = did ? `users.html?dealer=${encodeURIComponent(did)}` : 'users.html';
  if(!did){ $('#empty').style.display='block'; return; }
  $('#empty').style.display='none';
  const qRef = query(ref(db,'displays'), orderByChild('dealership'), equalTo(did));
  const off = onValue(qRef, snap=>renderList(did, snap.val()||{}), err=>console.warn(err));
  unsub = ()=>off();
}

/* ---------- Write helpers ---------- */
async function writeDisplay(id, patch){
  try{
    const did = $('#dealerSel').value || (await get(ref(db,'displays/'+id))).val()?.dealership || null;
    await update(ref(db,'displays/'+id), { ...patch, dealership: did, timestamp: Date.now() });
    toast(`${id}: updated`);
  }catch(e){ console.error(e); toast('Write denied', true); }
}

/* ---------- Add & bulk ---------- */
$('#addBtn').addEventListener('click', async ()=>{
  const did = $('#dealerSel').value;
  if(!did) return toast('Pick a dealership', true);

  let id = $('#newDisplayId').value.trim();
  if(!id){
    const friendly=(await get(ref(db,'dealershipPublic/'+did))).val()?.name||did;
    const pref=initialsFromName(friendly);
    const existing = await (async ()=>{ const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(did)); const s=await get(qRef); return Object.keys(s.val()||{}); })();
    const n = nextSuffix(existing, pref);
    id = `${pref}-${String(n).padStart(3,'0')}`;
  }
  try{
    await set(ref(db,`dealership/${did}/displays/${id}`), true);
    await update(ref(db,`displays/${id}`), { channel:1, volume:0, muted:true, dealership:did, timestamp:Date.now() });
    $('#newDisplayId').value='';
    toast('Display added');
  }catch(e){ console.error(e); toast('Add failed', true); }
});

$('#bulkMute').addEventListener('click', ()=>bulkWrite({muted:true}));
$('#bulkUnmute').addEventListener('click', ()=>bulkWrite({muted:false}));
$('#bulkCh1').addEventListener('click', ()=>bulkWrite({channel:1}));
$('#refreshBtn').addEventListener('click', attachWatcher);

async function bulkWrite(patch){
  const did=$('#dealerSel').value; if(!did) return toast('Pick a dealership', true);
  try{
    const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(did));
    const s=await get(qRef); const map=s.val()||{}; const ids=Object.keys(map);
    for(const id of ids){ await writeDisplay(id, patch); }
    toast('Applied to all TVs');
  }catch(e){ console.error(e); toast('Bulk failed', true); }
}
</script>
</body>
</html>
