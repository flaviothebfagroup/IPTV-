<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
<title>BFA IPTV ‚Äî Schedule</title>

<!-- PWA (optional) -->
<link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
<meta name="theme-color" content="#ffffff"/>
<link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
<link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

<style>
  /* =========================================================
     Tokens (light default) + dark override
  ========================================================= */
  :root{
    --accent:#ff9500;
    --fg:#111; --muted:#6e6e73; --bg:#ffffff;
    --panel:#fff; --tile:#f6f6f8; --tileHover:#fff7ea;
    --border:rgba(0,0,0,.14); --borderStrong:rgba(0,0,0,.28);
    --shadow:0 14px 36px rgba(0,0,0,.08);
  }
  body.dark{
    --bg:#0b0b0c; --fg:#f7f7f8; --muted:#a1a1a8;
    --panel:#151517; --tile:#1a1a1d; --tileHover:#221e18;
    --border:rgba(255,255,255,.16); --borderStrong:rgba(255,255,255,.36);
    --shadow:0 18px 48px rgba(0,0,0,.45);
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
  a{color:inherit;text-decoration:none}

  /* =========================================================
     Topbar (shared)
  ========================================================= */
  .topbar{position:sticky;top:0;z-index:100;background:var(--panel);
    border-bottom:1px solid var(--border);
    padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px}
  .toprow{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px;position:relative}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:#fff center/cover no-repeat}
  .logotxt{font-weight:900;letter-spacing:.2px}

  .nav{display:flex;gap:10px;margin-left:auto;margin-right:auto}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:9999px;border:1px solid transparent;background:transparent;color:inherit;font-weight:800;font-size:14px;line-height:1;white-space:nowrap}
  .pill:hover{border-color:var(--accent)}
  .pill.is-active{outline:2px solid var(--accent)}
  .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}

  /* More (+) dropdown */
  .more{position:relative}
  #moreBtn .plus{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
  #moreMenu{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;min-width:230px;background:var(--panel);
    border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none}
  #moreMenu.open{display:block}
  #moreMenu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px}
  #moreMenu a:hover{background:var(--tileHover)}
  #moreMenu a.is-active{outline:2px solid var(--accent)}
  #moreMenu .ic{width:18px;height:18px;stroke-width:1.9}

  /* Actions */
  .actions{display:flex;gap:8px;align-items:center}
  .email{max-width:240px;padding:6px 10px;border-radius:9999px;background:var(--tile);
    border:1.5px solid var(--borderStrong);color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .chip{height:34px;min-width:34px;padding:0 12px;border-radius:9999px;border:1.5px solid var(--borderStrong);
    background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .chip:hover{border-color:var(--accent)}
  .chip .ic{width:18px;height:18px;stroke-width:2}
  .chip.accent{background:transparent;border-color:var(--accent);color:var(--accent)}
  /* Hamburger (orange lines, no border, centered) */
  #hamburger{display:none;border:0;background:transparent;color:var(--accent);height:42px;min-width:42px;padding:0;align-items:center;justify-content:center;position:absolute;right:0;top:50%;transform:translateY(-50%)}
  #hamburger .ic{width:22px;height:22px;stroke:var(--accent);stroke-width:2.35}

  @media (max-width:920px){
    .nav{display:none}
    #hamburger{display:inline-flex}
    .email{display:none}
  }

  /* Mobile sheet */
  #sheet{position:fixed;inset:0;z-index:120;display:none}
  #sheet.open{display:block}
  #sheet .back{position:absolute;inset:0;background:rgba(0,0,0,.28)}
  .panel{position:absolute;right:0;top:0;height:100%;width:min(86vw,360px);background:var(--panel);border-left:1px solid var(--border);
    box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:14px}
  .panel .row{display:flex;align-items:center;justify-content:space-between}
  .panel nav{display:grid;gap:8px}
  .panel nav a{justify-content:flex-start}

  /* =========================================================
     Page UI
  ========================================================= */
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
  .muted{color:var(--muted);font-size:12px}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .input{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
  .btn{height:34px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center}
  .btn.solid{background:var(--accent);border-color:var(--accent);color:#000}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0}
  @media (max-width:720px){.row2,.row3{grid-template-columns:1fr}}

  .list{margin:8px 0 0;padding:0;list-style:none}
  .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px;margin:8px 0;background:var(--tile);border:1px solid var(--border);border-radius:12px;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:9999px;padding:2px 8px;font-size:11px;color:var(--muted);background:transparent}
  .badge.warn{border-color:#f59e0b;color:#f59e0b}
  .badge.ok{border-color:#22c55e;color:#22c55e}
  .badge.err{border-color:#ef4444;color:#ef4444}

  /* Toast */
  .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <!-- ===== NAVBAR ===== -->
  <header class="topbar">
    <div class="toprow">
      <a class="brand" href="home.html"><span class="logo" id="brandLogo"></span><span class="logotxt">BFA IPTV</span></a>

      <nav class="nav" aria-label="Primary">
        <a class="pill" href="home.html" data-page="home">
          <svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home
        </a>
        <a class="pill" href="dealerships.html" data-page="dealerships">
          <svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships
        </a>
        <a class="pill" href="displays.html" data-page="displays">
          <svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays
        </a>
        <a class="pill" href="users.html" data-page="users">
          <svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users
        </a>
        <div class="more">
          <a id="moreBtn" class="pill" href="javascript:void(0)">
            <svg class="plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg> More
          </a>
          <div id="moreMenu" role="menu" aria-label="More">
            <a href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
            <a href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
            <a class="is-active" href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
            <a href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
            <a href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
            <!-- Settings = sliders icon -->
            <a href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
          </div>
        </div>
      </nav>

      <div class="actions">
        <span id="adminEmail" class="email"></span>
        <button id="themeBtn" class="chip" title="Light/Dark">
          <svg id="themeIcon" class="ic" viewBox="0 0 24 24"></svg>
          Theme
        </button>
        <button id="signOutBtn" class="chip">Sign out</button>
        <button id="hamburger" class="chip" aria-label="Menu">
          <svg class="ic" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        </button>
      </div>
    </div>

    <!-- Mobile sheet -->
    <div id="sheet" aria-hidden="true">
      <div class="back"></div>
      <aside class="panel" role="dialog" aria-modal="true" aria-label="Menu">
        <div class="row">
          <div class="brand"><span class="logo" id="brandLogoM"></span><span class="logotxt">BFA IPTV</span></div>
          <button id="closeSheet" class="chip" aria-label="Close"><svg class="ic" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
        </div>
        <nav>
          <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
          <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
          <a class="pill" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
          <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
          <div class="muted" style="padding:8px 2px 0">More</div>
          <a class="pill" href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
          <a class="pill" href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
          <a class="pill is-active" href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
          <a class="pill" href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
          <a class="pill" href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
          <a class="pill" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
          <button id="signOutBtnM" class="chip" style="margin-top:8px">Sign out</button>
        </nav>
      </aside>
    </div>
  </header>

  <!-- ===================================================== -->
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px">Reminders (local)</h2>
      <div class="muted" style="margin-bottom:8px">Stores in your browser only. Optional: auto-create dealership and first display.</div>

      <div class="row2">
        <div><div class="label">Date / time</div><input id="schWhen" class="input" type="datetime-local"/></div>
        <div><div class="label">Destination / address (optional)</div><input id="schDest" class="input" placeholder="Location / notes‚Ä¶"/></div>
      </div>

      <div class="row2">
        <div><div class="label">Note</div><input id="schNote" class="input" placeholder="Installation / visit / reminder‚Ä¶"/></div>
        <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="schCreateAssets"/><span class="small">Create dealership/display now</span></label>
          <button id="schAdd" class="btn solid">Add</button>
        </div>
      </div>

      <div id="schAssets" style="display:none">
        <div class="row3">
          <div><div class="label">Dealership name</div><input id="schDealerName" class="input" placeholder="e.g., Genesis Winnipeg"/></div>
          <div><div class="label">Dealership ID (auto if empty)</div><input id="schDealerId" class="input" placeholder="genesiswinnipeg"/></div>
          <div><div class="label">Display ID (auto if empty)</div><input id="schDisplayId" class="input" placeholder="GW-001"/></div>
        </div>
      </div>

      <ul id="schList" class="list"></ul>
      <div id="schEmpty" class="small">No reminders.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getDatabase, ref, get, set, update, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  /* Firebase */
  const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};
  const LOGO_URL="/IPTV-/icons/icon-512.png";

  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getDatabase(app);

  const $=s=>document.querySelector(s);
  function toast(m){const t=document.querySelector('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}

  /* Logos */
  $('#brandLogo').style.backgroundImage=`url("${LOGO_URL}")`;
  const brandLogoM=document.getElementById('brandLogoM'); if(brandLogoM){ brandLogoM.style.backgroundImage=`url("${LOGO_URL}")`; }

  /* Theme (dark class + icon) */
  const THEME_KEY='iptv_theme';
  const themeBtn=document.getElementById('themeBtn');
  const themeIcon=document.getElementById('themeIcon');
  const setThemeIcon=()=>{
    const dark=document.body.classList.contains('dark');
    themeIcon.innerHTML = dark
      ? `<path d="M21 12a9 9 0 1 1-9-9 6 6 0 0 0 9 9z"/>`
      : `<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M5 19l-1.4 1.4M20.4 3.6 19 5"/>`;
  };
  const saved=localStorage.getItem(THEME_KEY)||'light';
  document.body.classList.toggle('dark', saved==='dark');
  setThemeIcon();
  themeBtn.addEventListener('click', ()=>{
    const toDark=!document.body.classList.contains('dark');
    document.body.classList.toggle('dark', toDark);
    localStorage.setItem(THEME_KEY, toDark?'dark':'light');
    setThemeIcon();
  });

  /* ‚ÄúMore‚Äù dropdown */
  const moreBtn=document.getElementById('moreBtn');
  const moreMenu=document.getElementById('moreMenu');
  if(moreBtn){
    moreBtn.addEventListener('click',(e)=>{ e.preventDefault(); moreMenu.classList.toggle('open');});
    document.addEventListener('click',(e)=>{ if(!moreMenu.contains(e.target) && e.target!==moreBtn && !moreBtn.contains(e.target)){ moreMenu.classList.remove('open'); } },{capture:true});
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') moreMenu.classList.remove('open'); });
    const file=(location.pathname.split("/").pop()||"schedule.html").toLowerCase();
    moreMenu.querySelectorAll('a').forEach(a=>{ const h=(a.getAttribute('href')||'').toLowerCase(); if(h===file){ a.classList.add('is-active'); }});
  }

  /* Mobile sheet */
  (()=>{
    const sheet=document.getElementById('sheet');
    const open=()=>{ sheet.classList.add('open'); document.body.style.overflow='hidden'; };
    const close=()=>{ sheet.classList.remove('open'); document.body.style.overflow=''; };
    document.getElementById('hamburger').addEventListener('click', open);
    document.getElementById('closeSheet').addEventListener('click', close);
    sheet.querySelector('.back').addEventListener('click', close);
    const mainOut=document.getElementById('signOutBtn');
    const mobOut=document.getElementById('signOutBtnM');
    if(mainOut && mobOut){ mobOut.addEventListener('click', ()=> mainOut.click()); }
  })();

  /* Auth */
  document.getElementById('signOutBtn').addEventListener('click',()=>signOut(auth));
  setPersistence(auth,browserLocalPersistence);
  onAuthStateChanged(auth,u=>{
    if(!u){ location.href='./home.html'; return; }
    document.getElementById('adminEmail').textContent=u.email||u.uid;
  });

  /* ===== Schedule (localStorage) ===== */
  const LS_SCH='iptv_admin_schedule';
  let schedule=JSON.parse(localStorage.getItem(LS_SCH)||'[]');
  function saveSchedule(){ localStorage.setItem(LS_SCH,JSON.stringify(schedule)); renderSchedule(); }

  function relTime(ts){
    const d=new Date(ts).getTime(); const now=Date.now();
    const diff=d-now; const abs=Math.abs(diff);
    const mins=Math.round(abs/60000);
    if(mins<60){ return (diff>=0? `${mins}m`:`${mins}m ago`); }
    const hrs=Math.round(mins/60);
    if(hrs<36){ return (diff>=0? `${hrs}h`:`${hrs}h ago`); }
    const days=Math.round(hrs/24);
    return (diff>=0? `${days}d`:`${days}d ago`);
  }
  function mapLink(q){ return `https://maps.google.com/?q=${encodeURIComponent(q)}`; }
  function previewUrlForDisplayId(displayId){ return `https://flaviothebfagroup.github.io/IPTV-/${encodeURIComponent(displayId)}.html`; }

  function renderSchedule(){
    const ul=$('#schList'); ul.innerHTML='';
    if(!schedule.length){ $('#schEmpty').style.display='block'; return; }
    $('#schEmpty').style.display='none';

    schedule.sort((a,b)=> String(a.when||'').localeCompare(String(b.when||'')));

    schedule.forEach((r,i)=>{
      const whenStr=r.when? new Date(r.when).toLocaleString(): '‚Äî';
      const rel=r.when? relTime(r.when): '';
      const isFuture = r.when && (new Date(r.when).getTime() > Date.now());
      const badgeClass = r.done ? 'ok' : (isFuture ? 'warn' : 'err');

      // try to pull displayId from assets if present as "dealer ‚Ä¢ display"
      let displayId='';
      if(r.assets && r.assets.includes('‚Ä¢')){
        const parts=r.assets.split('‚Ä¢').map(s=>s.trim());
        displayId = parts[1] || '';
      }

      const li=document.createElement('li'); li.className='item';
      li.innerHTML=`
        <div style="display:flex;flex-direction:column;gap:6px;min-width:240px">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <b>${whenStr}</b>
            ${rel? `<span class="badge ${badgeClass}"><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l4 2"/></svg>${rel}</span>`:''}
            ${r.done? `<span class="badge ok">Done</span>`:''}
          </div>
          <div>${r.note ? r.note.replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''}</div>
          ${r.dest? `<div class="small">üìç ${r.dest.replace(/</g,'&lt;')}</div>`:''}
          ${r.assets? `<div class="small">Assets: ${r.assets.replace(/</g,'&lt;')}</div>`:''}
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          ${r.dest? `<a class="btn" href="${mapLink(r.dest)}" target="_blank" rel="noopener">Map</a>`:''}
          ${displayId? `<a class="btn" href="${previewUrlForDisplayId(displayId)}" target="_blank" rel="noopener">Preview</a>`:''}
          <button class="btn" data-toggle="${i}">${r.done?'Undone':'Done'}</button>
          <button class="btn" data-del="${i}">Delete</button>
        </div>`;
      ul.appendChild(li);
    });

    // actions
    ul.querySelectorAll('[data-del]').forEach(b=>{
      b.addEventListener('click',()=>{ const idx=+b.dataset.del; schedule.splice(idx,1); saveSchedule(); });
    });
    ul.querySelectorAll('[data-toggle]').forEach(b=>{
      b.addEventListener('click',()=>{ const idx=+b.dataset.toggle; schedule[idx].done=!schedule[idx].done; saveSchedule(); });
    });
  }
  renderSchedule();

  // Show extra asset fields
  $('#schCreateAssets').addEventListener('change',e=>{ $('#schAssets').style.display=e.target.checked?'block':'none'; });

  // Helpers (same as other pages)
  function makeDealerId(name){ const base=(name||'').toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,24); return base||('dealer_'+Date.now()); }
  function initialsFromName(name){ const raw=(name||'').trim(); if(!raw) return 'DS'; let parts=raw.match(/[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]+/g)||[]; let a=parts[0]||'', b=parts[1]||''; let p=(a? a[0]:'')+(b? b[0]:''); if(p.length<2 && a.length>=2) p=a.slice(0,2); return p.toUpperCase(); }
  async function collectDisplays(did){ const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(did)); const s=await get(qRef); return Object.keys(s.val()||{}); }
  function nextSuffix(list,pref){ let max=0; list.forEach(id=>{ const m=id.match(new RegExp('^'+pref+'-(\\d{3})$')); if(m){ const n=parseInt(m[1],10); if(n>max) max=n; }}); return max+1; }

  // Add reminder (+ optional create assets)
  $('#schAdd').addEventListener('click', async ()=>{
    const when=$('#schWhen').value, note=$('#schNote').value.trim(), dest=$('#schDest').value.trim(), make=$('#schCreateAssets').checked;
    if(!when||!note) return toast('Pick date/time and note');

    let assets='';
    if(make){
      let dName=$('#schDealerName').value.trim();
      let dId=$('#schDealerId').value.trim();
      let displayId=$('#schDisplayId').value.trim();
      if(!dName && !dId) return toast('Enter dealership name or id');

      if(!dId) dId=makeDealerId(dName);

      // Create dealership if missing
      const exists=await get(ref(db,`dealershipPublic/${dId}`));
      if(!exists.exists()){
        await set(ref(db,`dealershipPublic/${dId}`),{name:dName||dId});
        await set(ref(db,`dealership/${dId}`),{name:dName||dId,createdAt:Date.now(),createdBy:auth.currentUser?.email||'admin',displays:{}});
      }

      // Create display (ID auto if empty)
      if(!displayId){
        const friendly=(await get(ref(db,`dealershipPublic/${dId}`))).val()?.name||dId;
        const pref=initialsFromName(friendly);
        const existing=await collectDisplays(dId);
        displayId=`${pref}-${String(nextSuffix(existing,pref)).padStart(3,'0')}`;
      }
      await set(ref(db,`dealership/${dId}/displays/${displayId}`),true);
      await update(ref(db,`displays/${displayId}`),{channel:1,volume:0,muted:true,dealership:dId,timestamp:Date.now()});

      assets=`${dId} ‚Ä¢ ${displayId}`;
      $('#schDealerName').value='';$('#schDealerId').value='';$('#schDisplayId').value='';
    }

    schedule.push({when,note,dest,assets,done:false});
    saveSchedule();
    $('#schWhen').value='';$('#schNote').value='';$('#schDest').value='';
    $('#schCreateAssets').checked=false;$('#schAssets').style.display='none';
    toast('Scheduled');
  });
</script>
</body>
</html>
