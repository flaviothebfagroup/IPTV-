<!DOCTYPE html>
<html lang="en">
<head>
  <!-- keep these first -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- PWA + Icons -->
  <link rel="manifest" href="/IPTV-/manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png">
  <link rel="apple-touch-icon" href="/IPTV-/icons/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/IPTV-/icons/apple-touch-icon-120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/IPTV-/icons/apple-touch-icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/IPTV-/icons/apple-touch-icon-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/IPTV-/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="IPTV Remote">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <title>IPTV — Create Account</title>

  <style>
    :root { --bg:#0b0b0c; --fg:#fff; --muted:#9a9aa0; --panel:#121214; --border:rgba(255,255,255,.14);
            --accent:#ff9500; --tile:#17171a; --tileActive:#1d1d21; --shadow:0 18px 48px rgba(0,0,0,.45); }
    body.light { --bg:#f5f5f7; --fg:#111; --muted:#6e6e73; --panel:#fff; --border:rgba(0,0,0,.12);
                 --accent:#ff9500; --tile:#f2f2f7; --tileActive:#eaeaef; --shadow:0 14px 36px rgba(0,0,0,.10); }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
      transition:background .25s,color .25s
    }

    .wrap{width:100%;max-width:420px}
    .brand{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:16px}
    .logo{width:110px;height:110px;background:var(--accent);
      -webkit-mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;
      mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat}
    .title{font-size:22px;font-weight:800;letter-spacing:.4px}
    .subtitle{color:var(--muted);font-size:12px;letter-spacing:1px;text-transform:uppercase}

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:28px;
      padding:22px 18px 18px;
      box-shadow:var(--shadow)
    }

    .field{display:flex;flex-direction:column;gap:8px;margin:12px 0}
    .label{font-size:12px;color:var(--muted);letter-spacing:.5px}

    .input{
      width:100%;
      padding:14px 14px;
      background:transparent;
      border:1px solid var(--border);
      border-radius:14px;
      color:var(--fg);
      font-size:16px;
      text-align:center;
      outline:none;
      transition:border-color .18s, box-shadow .18s
    }
    .input::placeholder{color:var(--muted)}
    .input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(255,149,0,.25)
    }

    .helper{
      margin:8px 0 4px;
      text-align:center;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.8px;
      text-transform:uppercase
    }

    .btn{
      width:100%;
      padding:14px;
      background:var(--accent);
      color:#000;
      border:none;
      border-radius:9999px;
      font-size:16px;
      font-weight:800;
      cursor:pointer
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .spinner{
      display:inline-block;
      width:14px;
      height:14px;
      border:2px solid rgba(0,0,0,.35);
      border-top-color:#000;
      border-radius:50%;
      animation:spin .6s linear infinite;
      margin-left:10px;
      vertical-align:-2px
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .below{margin-top:16px;text-align:center;color:var(--muted);font-size:14px}
    .below a{color:var(--fg);text-decoration:none;border-bottom:1px dashed var(--border)}

    .toast{
      position:fixed;
      bottom:50px;
      left:50%;
      transform:translateX(-50%);
      background:var(--accent);
      color:#000;
      padding:10px 20px;
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      opacity:0;
      transition:opacity .25s;
      pointer-events:none;
      max-width:92vw;
      text-align:center
    }
    .toast.show{opacity:1}
    .toast.error{background:#ff453a;color:#fff}

    .theme-note{
      display:block;
      text-align:center;
      margin-top:10px;
      color:var(--muted);
      font-size:11px
    }

    /* Dealer search & list */
    .search-row{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
    }
    .chip-btn{
      padding:0 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--fg);
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .chip-btn:active{transform:scale(.97)}

    #dealerResults{
      margin-top:4px;
      border-radius:16px;
      border:1px solid var(--border);
      padding:8px 10px;
      background:rgba(0,0,0,.22);
      font-size:13px;
      max-height:220px;
      overflow:auto;
    }
    body.light #dealerResults{
      background:rgba(255,255,255,.75);
    }
    .dealer-item{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    body.light .dealer-item{
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .dealer-item:last-child{border-bottom:none}
    .dealer-index{
      width:20px;
      text-align:center;
      font-weight:700;
      font-size:13px;
      margin-top:2px;
    }
    .dealer-main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .dealer-name{
      font-size:13px;
      font-weight:600;
    }
    .dealer-meta{
      font-size:11px;
      color:var(--muted);
    }

    /* Mini map */
    #mapField{margin-top:6px;}
    .map-frame{
      width:100%;
      border-radius:20px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#050816;
      min-height:160px;
    }
    body.light .map-frame{background:#e5e7eb;}
    #mapFrame{
      width:100%;
      height:200px;
      border:0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo" role="img" aria-label="IPTV logo"></div>
      <div class="title">Create your account</div>
      <div class="subtitle">Access your dealership remotes</div>
    </div>

    <div class="card">
      <div class="field">
        <input id="email" class="input" type="email" placeholder="Email" autocomplete="email">
      </div>
      <div class="field">
        <input id="password" class="input" type="password" placeholder="Password (6+ characters)" autocomplete="new-password">
      </div>
      <div class="field">
        <input id="name" class="input" type="text" placeholder="Your Name" autocomplete="name">
      </div>

      <div class="helper">Your Dealership</div>

      <!-- Search input + button -->
      <div class="field">
        <div class="search-row">
          <input id="dealerSearch" class="input" type="text" placeholder="City, dealership or postal code">
          <button type="button" class="chip-btn" id="dealerSearchBtn">Find</button>
        </div>
      </div>

      <!-- Dealer suggestions (filtered list, not full dropdown) -->
      <div class="field" id="dealerResults" style="display:none"></div>

      <!-- Mini map showing the selected dealership -->
      <div class="field" id="mapField" style="display:none">
        <div class="label">Map preview</div>
        <div class="map-frame">
          <iframe
            id="mapFrame"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            allowfullscreen>
          </iframe>
        </div>
      </div>

      <!-- Hidden fields that store the chosen dealership -->
      <input type="hidden" id="dealershipId">
      <input type="hidden" id="dealershipName">

      <button id="signupBtn" class="btn" onclick="signUp()">CREATE ACCOUNT</button>
      <small class="theme-note">Theme matches your remote (white/dark)</small>
    </div>

    <div class="below">
      Already have an account? <a href="https://flaviothebfagroup.github.io/IPTV-/remote-control.html">Sign in</a>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // keep theme consistent with the remote
    (function(){
      const saved = localStorage.getItem('iptv_theme') || 'light';
      document.body.classList.toggle('light', saved === 'light');
    })();
  </script>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      setPersistence, browserLocalPersistence,
      signInAnonymously, EmailAuthProvider, linkWithCredential,
      createUserWithEmailAndPassword
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ---------- helpers ----------
    function showToast(message, type=''){
      const t = document.getElementById('toast');
      t.textContent = message;
      t.className = 'toast show' + (type==='error' ? ' error' : '');
      setTimeout(()=>t.classList.remove('show'), 2800);
    }

    let dealerships = []; // loaded from dealershipPublic

    // Load dealerships from RTDB but don't expose full list directly
    async function loadDealerships(){
      try{
        const snap = await get(ref(db, 'dealershipPublic'));
        dealerships = [];

        if (snap.exists()) {
          dealerships = Object.entries(snap.val()).map(([id, v]) => {
            const obj = v || {};
            return {
              id,
              name: obj.name || id,
              // we'll use anything available here for search / display
              city: obj.city || obj.town || '',
              address: obj.address || obj.street || obj.fullAddress || '',
              province: obj.province || obj.state || '',
              postal: obj.postal || obj.postalCode || '',
              phone: obj.phone || obj.telephone || ''
            };
          }).sort((a,b)=>a.name.localeCompare(b.name));
        } else {
          console.warn('dealershipPublic is empty');
        }
      }catch(err){
        console.warn('Could not load dealershipPublic:', err);
        dealerships = [];
      }
    }

    function buildDealerSearchHaystack(d){
      return [
        d.name,
        d.city,
        d.address,
        d.province,
        d.postal
      ].filter(Boolean).join(' ').toLowerCase();
    }

    function renderDealerResults(list){
      const resultsEl = document.getElementById('dealerResults');
      const hiddenId   = document.getElementById('dealershipId');
      const hiddenName = document.getElementById('dealershipName');
      const mapField   = document.getElementById('mapField');

      if(!list.length){
        resultsEl.style.display = 'none';
        resultsEl.innerHTML = '';
        hiddenId.value = '';
        hiddenName.value = '';
        mapField.style.display = 'none';
        return;
      }

      resultsEl.innerHTML = '';
      list.forEach((d, idx)=>{
        const item = document.createElement('div');
        item.className = 'dealer-item';
        const cityLine = [d.city, d.province].filter(Boolean).join(', ');
        const addrLine = d.address || '';
        const meta = [addrLine, cityLine, d.postal].filter(Boolean).join(' • ');

        item.innerHTML = `
          <div class="dealer-index">${idx+1}</div>
          <div class="dealer-main">
            <label style="display:flex;align-items:flex-start;gap:6px;cursor:pointer;">
              <input type="radio" name="dealerChoice" value="${d.id}" data-name="${d.name}" data-idx="${idx}" ${idx===0?'checked':''}>
              <div>
                <div class="dealer-name">${d.name}</div>
                ${meta ? `<div class="dealer-meta">${meta}</div>` : ''}
              </div>
            </label>
          </div>
        `;
        resultsEl.appendChild(item);
      });

      resultsEl.style.display = 'block';

      // Update selected + map for first result by default
      updateSelectedDealerFromRadio();
    }

    function mapSearchStringForDealer(d){
      // Best-effort address string for Google Maps search
      const parts = [
        d.name,
        d.address,
        d.city,
        d.province,
        d.postal
      ].filter(Boolean);
      return parts.join(', ') || d.name;
    }

    function updateMapForDealer(d){
      const mapField = document.getElementById('mapField');
      const mapFrame = document.getElementById('mapFrame');
      if(!d){
        mapField.style.display = 'none';
        return;
      }
      const q = encodeURIComponent(mapSearchStringForDealer(d));
      mapFrame.src = `https://www.google.com/maps?q=${q}&output=embed`;
      mapField.style.display = 'block';
    }

    function updateSelectedDealerFromRadio(){
      const hiddenId   = document.getElementById('dealershipId');
      const hiddenName = document.getElementById('dealershipName');

      const checked = document.querySelector('input[name="dealerChoice"]:checked');
      if(!checked){
        hiddenId.value = '';
        hiddenName.value = '';
        updateMapForDealer(null);
        return;
      }

      const id = checked.value;
      const dealer = dealerships.find(d => d.id === id);
      hiddenId.value = id;
      hiddenName.value = checked.dataset.name || (dealer ? dealer.name : '');

      if(dealer){
        updateMapForDealer(dealer);
      } else {
        updateMapForDealer(null);
      }
    }

    document.addEventListener('change', (e)=>{
      if(e.target && e.target.name === 'dealerChoice'){
        updateSelectedDealerFromRadio();
      }
    });

    function runDealerSearch(){
      const qRaw = (document.getElementById('dealerSearch').value || '').trim();
      const q = qRaw.toLowerCase();
      const resultsEl = document.getElementById('dealerResults');

      if(!q){
        resultsEl.style.display = 'none';
        resultsEl.innerHTML = '';
        updateMapForDealer(null);
        document.getElementById('dealershipId').value = '';
        document.getElementById('dealershipName').value = '';
        return;
      }

      if(!dealerships.length){
        showToast('No dealerships available yet.','error');
        return;
      }

      const matches = dealerships.filter(d => {
        const hay = buildDealerSearchHaystack(d);
        return hay.includes(q);
      }).slice(0, 8); // show at most 8

      if(!matches.length){
        showToast('No dealerships match this search','error');
      }

      renderDealerResults(matches);
    }

    // sign-in anonymously so reads are allowed by your root .read rule
    (async ()=>{
      try{
        await setPersistence(auth, browserLocalPersistence);
        if (!auth.currentUser) await signInAnonymously(auth);
      }catch(e){ console.warn('Anonymous sign-in failed:', e); }
      finally{
        loadDealerships();
      }
    })();

    // enter to submit
    ['email','password','name'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') signUp(); });
    });

    // Dealer search events
    const dealerSearchInput = document.getElementById('dealerSearch');
    const dealerSearchBtn   = document.getElementById('dealerSearchBtn');

    dealerSearchBtn.addEventListener('click', runDealerSearch);
    dealerSearchInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') runDealerSearch();
    });

    // ---------- sign up ----------
    window.signUp = async function(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const name = document.getElementById('name').value.trim();

      const dealershipId   = document.getElementById('dealershipId').value;
      const dealershipName = document.getElementById('dealershipName').value;

      if(!email || !password || !name){
        showToast('Please fill all fields','error');
        return;
      }
      if(password.length < 6){
        showToast('Password must be 6+ characters','error');
        return;
      }
      if(!dealershipId || !dealershipName){
        showToast('Please pick your dealership from the list','error');
        return;
      }

      const btn = document.getElementById('signupBtn');
      btn.disabled = true;
      btn.innerHTML = 'CREATING<span class="spinner"></span>';

      try{
        // Upgrade anon → email/pass OR create if not anon
        let cred;
        if (auth.currentUser && auth.currentUser.isAnonymous) {
          const c = EmailAuthProvider.credential(email, password);
          cred = await linkWithCredential(auth.currentUser, c);
        } else {
          cred = await createUserWithEmailAndPassword(auth, email, password);
        }
        const { user } = cred;

        // Try to read displays for existing dealership (allowed by your public .read at children)
        let userDisplays = [];
        try {
          const dSnap = await get(ref(db, `dealership/${dealershipId}/displays`));
          if (dSnap.exists()) {
            userDisplays = Object.keys(dSnap.val());
          }
        } catch (e) {
          console.warn('Displays read failed (ok):', e);
        }

        const profile = {
          email,
          name,
          dealershipId,
          dealershipName,
          createdAt: Date.now()
        };
        if (userDisplays.length) profile.displays = userDisplays;

        await set(ref(db, `user/${user.uid}`), profile);

        showToast('Account created!');

        btn.innerHTML = 'SUCCESS — OPENING REMOTE…';
        setTimeout(()=>{ window.location.href = 'https://flaviothebfagroup.github.io/IPTV-/remote-control.html'; }, 1200);
      }catch(error){
        console.error('signup', error);
        const map = {
          'auth/operation-not-allowed':'Email & Password sign-in is disabled (enable in Firebase Auth).',
          'auth/unauthorized-domain':'Domain not authorized in Firebase Auth settings.',
          'auth/email-already-in-use':'Email already registered.',
          'auth/weak-password':'Password too weak.',
          'auth/invalid-email':'Invalid email address.'
        };
        const msg = map[error.code] || (`Signup failed: ${error.code || error.message || 'Unknown error'}`);
        showToast(msg, 'error');
        btn.disabled = false;
        btn.textContent = 'CREATE ACCOUNT';
      }
    };
  </script>
</body>
</html>
