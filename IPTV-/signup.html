<!DOCTYPE html>
<html lang="en">
<head>
  <!-- keep these first -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- PWA + Icons -->
  <link rel="manifest" href="/IPTV-/manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png">
  <link rel="apple-touch-icon" href="/IPTV-/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <title>BFA IPTV — Create Account</title>

  <!-- Leaflet (free; no API key) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --bg:#0b0b0c;
      --fg:#fff;
      --muted:#9a9aa0;
      --panel:#121214;
      --border:rgba(255,255,255,.14);
      --accent:#ff9500;
      --tile:#17171a;
      --tileActive:#1d1d21;
      --shadow:0 18px 48px rgba(0,0,0,.45);
    }
    body.light {
      --bg:#f5f5f7;
      --fg:#111;
      --muted:#6e6e73;
      --panel:#fff;
      --border:rgba(0,0,0,.12);
      --accent:#ff9500;
      --tile:#f5f5f7;
      --tileActive:#eaeaef;
      --shadow:0 14px 36px rgba(0,0,0,.10);
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
      transition:background .25s,color .25s;
    }

    .wrap{width:100%;max-width:420px}
    .brand{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:16px}
    .logo{
      width:110px;height:110px;background:var(--accent);
      -webkit-mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;
      mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;
    }
    .title{font-size:22px;font-weight:800;}
    .subtitle{color:var(--muted);font-size:12px;text-transform:uppercase;}

    .card{
      background:var(--panel);
      border-radius:28px;
      border:1px solid var(--border);
      padding:22px 18px 18px;
      box-shadow:var(--shadow);
    }

    .field{display:flex;flex-direction:column;gap:8px;margin:12px 0}
    .input{
      padding:14px;
      background:transparent;
      border:1px solid var(--border);
      border-radius:14px;
      color:var(--fg);
      font-size:16px;
      text-align:center;
      outline:none;
      transition:border-color .18s, box-shadow .18s, background .18s;
    }
    .input::placeholder{color:var(--muted)}
    .input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(255,149,0,.25);
      background:rgba(0,0,0,.06);
    }

    .helper{text-align:center;font-size:11px;color:var(--muted);margin-bottom:6px;}

    .btn{
      width:100%;padding:14px;border:none;
      border-radius:999px;font-size:16px;font-weight:800;
      background:var(--accent);color:#000;cursor:pointer;
      transition:filter .18s,transform .08s;
    }
    .btn:active{transform:scale(.97);}
    .btn:disabled{opacity:.6;cursor:not-allowed;}

    .btn-ghost{
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--fg);
      font-size:12px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }

    .loc-icon{
      width:16px;height:16px;
      border-radius:999px;
      border:2px solid var(--accent);
      position:relative;
    }
    .loc-icon::after{
      content:'';
      position:absolute;
      inset:3px;
      border-radius:999px;
      background:var(--accent);
    }

    .dealer-row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .dealer-row .input{
      flex:1;
      text-align:left;
      font-size:14px;
      padding-inline:12px;
    }

    .dealer-results{
      max-height:160px;
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--tile);
      padding:6px;
    }

    .dealer-card{
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      transition:background .18s, transform .08s;
    }
    .dealer-card + .dealer-card{margin-top:4px;}
    .dealer-card:hover{background:var(--tileActive);transform:translateY(-1px);}
    .dealer-card.selected{
      background:rgba(255,149,0,.2);
      box-shadow:0 0 0 1px rgba(255,149,0,.7);
    }

    .dealer-name{font-weight:600;font-size:12px;}
    .dealer-meta{font-size:11px;color:var(--muted);}
    .dealer-distance{font-size:11px;color:var(--muted);}

    .map-wrap{
      margin-top:10px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
      display:none;
    }
    #dealerMap{width:100%;height:220px;}

    .below{margin-top:16px;text-align:center;color:var(--muted);font-size:14px}
    .below a{color:var(--fg);border-bottom:1px dashed var(--border);text-decoration:none;}

    .toast{
      position:fixed;bottom:50px;left:50%;
      transform:translateX(-50%);
      background:var(--accent);color:#000;
      padding:10px 20px;border-radius:999px;
      opacity:0;transition:.25s;font-weight:700;
      pointer-events:none;
      max-width:92vw;
      text-align:center;
      z-index:9999;
    }
    .toast.show{opacity:1;}
    .toast.error{background:#ff453a;color:#fff;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="brand">
    <div class="logo"></div>
    <div class="title">Create your account</div>
    <div class="subtitle">Access your dealership remotes</div>
  </div>

  <div class="card">

    <div class="field">
      <input id="email" class="input" type="email" placeholder="Email">
    </div>
    <div class="field">
      <input id="password" class="input" type="password" placeholder="Password (6+ characters)">
    </div>
    <div class="field">
      <input id="name" class="input" type="text" placeholder="Your Name">
    </div>

    <div class="helper">Choose your dealership</div>

    <div class="field">
      <div class="dealer-row">
        <button id="locateBtn" class="btn-ghost" type="button">
          <span class="loc-icon"></span>
          <span>Use my location</span>
        </button>
        <input id="dealerSearch" class="input" type="text" placeholder="Search city or dealership">
      </div>

      <div class="dealer-results" id="dealerResults">
        <div class="dealer-card">
          <span class="dealer-meta">Search or tap “Use my location”.</span>
        </div>
      </div>

      <div class="map-wrap" id="mapWrap">
        <div id="dealerMap"></div>
      </div>

      <div class="helper" id="dealerHelper">Search or tap “Use my location”.</div>
    </div>

    <input type="hidden" id="dealershipId">
    <input type="hidden" id="dealershipName">

    <button id="signupBtn" class="btn" onclick="signUp()">CREATE ACCOUNT</button>
  </div>

  <div class="below">
    Already have an account? <a href="/IPTV-/remote-control.html">Sign in</a>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
  const saved = localStorage.getItem('iptv_theme') || 'light';
  document.body.classList.toggle('light', saved === 'light');
})();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    signInAnonymously,
    setPersistence,
    browserLocalPersistence,
    EmailAuthProvider,
    linkWithCredential,
    createUserWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    set
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
    authDomain: "iptv-bfa.firebaseapp.com",
    databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
    projectId: "iptv-bfa",
    storageBucket: "iptv-bfa.firebasestorage.app",
    messagingSenderId: "838790935867",
    appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const L  = window.L;

  const dealerResultsEl = document.getElementById("dealerResults");
  const dealerSearchEl  = document.getElementById("dealerSearch");
  const locateBtn       = document.getElementById("locateBtn");
  const dealerHelper    = document.getElementById("dealerHelper");
  const mapWrap         = document.getElementById("mapWrap");
  const dealershipIdInput   = document.getElementById("dealershipId");
  const dealershipNameInput = document.getElementById("dealershipName");

  let allDealers = [];
  let selectedDealerId = null;
  let userLocation = null;
  let map = null;
  let dealerMarker = null;

  function showToast(msg,type=""){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.className="toast show"+(type==="error"?" error":"");
    setTimeout(()=>t.classList.remove("show"),2600);
  }

  function initMap(){
    if(map) return;
    map = L.map("dealerMap").setView([43.7,-79.4],8);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }

  function setDealerMarker(lat,lng){
    // show container first so Leaflet can measure correctly
    mapWrap.style.display = "block";
    initMap();

    const pos=[lat,lng];
    if(!dealerMarker){
      dealerMarker=L.marker(pos).addTo(map);
    }else{
      dealerMarker.setLatLng(pos);
    }
    map.setView(pos,13);

    // force Leaflet to recalc size after becoming visible
    setTimeout(()=>{ map.invalidateSize(); }, 0);
  }

  function distanceKm(a,b){
    const R=6371;
    const dLat=(b.lat-a.lat)*Math.PI/180;
    const dLng=(b.lng-a.lng)*Math.PI/180;
    const lat1=a.lat*Math.PI/180;
    const lat2=b.lat*Math.PI/180;
    const s1=Math.sin(dLat/2);
    const s2=Math.sin(dLng/2);
    const c=2*Math.atan2(
      Math.sqrt(s1*s1 + Math.cos(lat1)*Math.cos(lat2)*s2*s2),
      Math.sqrt(1 - (s1*s1 + Math.cos(lat1)*Math.cos(lat2)*s2*s2))
    );
    return R*c;
  }

  function renderSingleDealerCard(dealer,distLabel){
    dealerResultsEl.innerHTML="";
    if(!dealer){
      dealerResultsEl.innerHTML=
        `<div class="dealer-card"><span class="dealer-meta">No results found.</span></div>`;
      return;
    }

    const card=document.createElement("div");
    card.className="dealer-card"+(dealer.id===selectedDealerId?" selected":"");
    const lines=[];
    if(dealer.address) lines.push(dealer.address);
    const cityLine=[dealer.city,dealer.province].filter(Boolean).join(", ");
    if(cityLine) lines.push(cityLine);
    if(dealer.postal) lines.push(dealer.postal);

    card.innerHTML=`
      <div class="dealer-name">${dealer.name}</div>
      <div class="dealer-meta">${lines.join(" • ")}</div>
      ${distLabel ? `<div class="dealer-distance">${distLabel}</div>` : ""}
    `;
    card.addEventListener("click",()=>selectDealer(dealer.id,dealer));
    dealerResultsEl.appendChild(card);
  }

  function selectDealer(id,preload=null){
    const d=preload || allDealers.find(x=>x.id===id);
    if(!d)return;

    selectedDealerId=d.id;
    dealershipIdInput.value=d.id;
    dealershipNameInput.value=d.name;

    document.querySelectorAll(".dealer-card").forEach(c=>
      c.classList.toggle("selected",c.textContent.includes(d.name))
    );

    dealerHelper.textContent=`Selected: ${d.name}`;

    if(d.lat!=null && d.lng!=null){
      setDealerMarker(d.lat,d.lng);
    }
  }

  async function useMyLocation(){
    if(!navigator.geolocation){
      showToast("Location not supported","error");
      return;
    }
    dealerHelper.textContent="Locating…";
    locateBtn.disabled=true;

    try{
      const pos=await new Promise((res,rej)=>{
        navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:11000});
      });
      userLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};

      let nearest=null;
      let bestDist=Infinity;

      allDealers.forEach(d=>{
        if(d.lat==null || d.lng==null)return;
        const dist=distanceKm(userLocation,{lat:d.lat,lng:d.lng});
        if(dist<bestDist){
          bestDist=dist;
          nearest={...d,_km:dist};
        }
      });

      if(!nearest){
        renderSingleDealerCard(null,null);
        mapWrap.style.display="none";
        dealerHelper.textContent="No dealership found near you.";
        return;
      }

      const label = bestDist < 1
        ? `${Math.round(bestDist*1000)} m away`
        : `${bestDist.toFixed(1)} km away`;

      renderSingleDealerCard(nearest,label);
      selectDealer(nearest.id,nearest);
      dealerHelper.textContent="Nearest dealership selected.";
    }
    catch(e){
      showToast("Location denied","error");
      dealerHelper.textContent="Search by city or dealership.";
    }
    finally{
      locateBtn.disabled=false;
    }
  }

  function searchBestMatch(){
    const q=dealerSearchEl.value.trim().toLowerCase();
    if(!q){
      dealerResultsEl.innerHTML=
        `<div class="dealer-card"><span class='dealer-meta'>Search or tap “Use my location”.</span></div>`;
      if(!selectedDealerId) mapWrap.style.display="none";
      return;
    }

    let best=null;
    let bestScore=-1;

    allDealers.forEach(d=>{
      const text=[
        d.name,d.city,d.province,d.address,d.postal
      ].filter(Boolean).join(" ").toLowerCase();

      if(!text.includes(q))return;

      const score=q.length;
      if(score>bestScore){
        bestScore=score;
        best=d;
      }
    });

    if(!best){
      renderSingleDealerCard(null,null);
      mapWrap.style.display="none";
      dealerHelper.textContent="No results.";
      return;
    }

    renderSingleDealerCard(best,"");
    dealerHelper.textContent="Tap to confirm.";
  }

  dealerSearchEl.addEventListener("input",searchBestMatch);
  locateBtn.addEventListener("click",useMyLocation);

  async function loadDealers(){
    try{
      const snap=await get(ref(db,"dealershipPublic"));
      if(snap.exists()){
        allDealers = Object.entries(snap.val()).map(([id,v])=>({
          id,
          name:v.name||id,
          address:v.address||"",
          city:v.city||"",
          province:v.province||"",
          postal:v.postal||"",
          lat:v.lat!=null?parseFloat(v.lat):null,
          lng:v.lng!=null?parseFloat(v.lng):null
        }));
      }
    }
    catch(e){
      console.warn(e);
    }
  }

  (async()=>{
    await setPersistence(auth,browserLocalPersistence);
    if(!auth.currentUser) await signInAnonymously(auth);
    await loadDealers();
  })();

  ["email","password","name"].forEach(id=>{
    document.getElementById(id).addEventListener("keydown",e=>{
      if(e.key==="Enter") signUp();
    });
  });

  window.signUp=async function(){
    const email=document.getElementById("email").value.trim();
    const password=document.getElementById("password").value;
    const name=document.getElementById("name").value.trim();
    const dealershipId=dealershipIdInput.value;
    const dealershipName=dealershipNameInput.value;

    if(!email || !password || !name){
      showToast("Fill all fields","error");
      return;
    }
    if(password.length<6){
      showToast("Password too short","error");
      return;
    }
    if(!dealershipId){
      showToast("Please select dealership","error");
      return;
    }

    const btn=document.getElementById("signupBtn");
    btn.disabled=true;
    btn.textContent="CREATING…";

    try{
      let cred;
      if(auth.currentUser?.isAnonymous){
        const c=EmailAuthProvider.credential(email,password);
        cred = await linkWithCredential(auth.currentUser,c);
      }else{
        cred = await createUserWithEmailAndPassword(auth,email,password);
      }
      const {user}=cred;

      let displays=[];
      try{
        const snap=await get(ref(db,`dealership/${dealershipId}/displays`));
        if(snap.exists()) displays=Object.keys(snap.val());
      }catch{}

      const profile={
        email,
        name,
        dealershipId,
        dealershipName,
        createdAt:Date.now()
      };
      if(displays.length) profile.displays=displays;

      await set(ref(db,`user/${user.uid}`),profile);

      showToast("Account created!");
      btn.textContent="SUCCESS";
      setTimeout(()=>location.href="/IPTV-/remote-control.html",1100);

    }catch(e){
      console.error(e);
      showToast(e.message||"Signup failed","error");
      btn.disabled=false;
      btn.textContent="CREATE ACCOUNT";
    }
  };
</script>
    <!-- Start of HubSpot Embed Code -->
  <script type="text/javascript" id="hs-script-loader" async defer src="//js-na3.hs-scripts.com/342895404.js"></script>
<!-- End of HubSpot Embed Code -->
</body>
</html>
