<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BFA â€” Channel Wall</title>

  <!-- hls.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>

  <style>
    :root{
      --brand:#ff6a00; --brand-2:#e85f00;

      /* gradient stops (light) */
      --bg-start:#fefefe;
      --bg-mid:#f3f6fb;
      --bg-end:#ff6a00;

      --fg:#0f172a;
      --panel:rgba(255,255,255,.56);
      --line:rgba(15,23,42,.06);
      --muted:#64748b;

      --glass-blur:16px;
      --glass-sat:140%;
      --elev-shadow:0 14px 34px rgba(15,23,42,.08), 0 2px 8px rgba(15,23,42,.05);
      --elev-shadow-soft:0 10px 26px rgba(15,23,42,.06), 0 1px 4px rgba(15,23,42,.04);
    }
    [data-theme="dark"]{
      --fg:#e8ecf1;
      --bg-start:#0b0c10;
      --bg-mid:#0d1016;
      --bg-end:#10141b;

      --panel:rgba(20,21,26,.55);
      --line:rgba(255,255,255,.08);
      --muted:#a8b0bc;
      --glass-blur:14px; --glass-sat:140%;
      --elev-shadow:0 12px 28px rgba(0,0,0,.32), 0 1px 2px rgba(0,0,0,.24);
      --elev-shadow-soft:0 10px 20px rgba(0,0,0,.28), 0 1px 2px rgba(0,0,0,.2);
    }

    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{
      margin:0;color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:transparent;
      min-height:100vh;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:linear-gradient(180deg, var(--bg-start) 0%, var(--bg-mid) 52%, var(--bg-end) 100%);
    }

    .page{
      max-width:1280px;
      margin:12px auto;
      padding:12px 16px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:100vh;
    }

    /* HEADER */
    .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{height:34px}
    h1{margin:0;font-size:clamp(18px,4.2vw,22px);font-weight:800}
    .sub{color:var(--muted);font-size:12px}

    .right-head{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    select,button{
      font-size:13px;
      height:34px;
      padding:0 12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--fg);
      outline:none;
      -webkit-tap-highlight-color:transparent;
      box-shadow:var(--elev-shadow-soft);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn{
      background:linear-gradient(180deg,var(--brand),var(--brand-2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 8px 18px rgba(255,106,0,.18);
    }
    .btn-outline{
      background:var(--panel);
      border-color:rgba(255,149,0,.42);
      color:var(--brand);
    }
    button:focus{outline:none}
    button:focus:not(:focus-visible){outline:none}
    button.btn,button.btn-outline{
      transition:transform .12s ease, box-shadow .18s ease, filter .18s ease, background .18s ease;
    }
    button.btn:hover,button.btn-outline:hover{
      transform:translateY(-1px);
      filter:brightness(1.03);
    }
    button.btn:active,button.btn-outline:active{
      transform:translateY(0);
      filter:brightness(.985);
    }

    .badge{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(15,23,42,0.7);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--brand);
      box-shadow:0 0 0 0 rgba(255,149,0,0.5);
      animation:pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(255,149,0,0.6);}
      70%{box-shadow:0 0 0 8px rgba(255,149,0,0);}
      100%{box-shadow:0 0 0 0 rgba(255,149,0,0);}
    }

    /* MAIN CARD */
    .card{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:22px;
      padding:12px 12px 14px;
      box-shadow:var(--elev-shadow);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      min-height:0;
    }

    .card-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .card-title{font-weight:700;font-size:14px}
    .status-text{font-size:12px;color:var(--muted)}

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:10px;
      width:100%;
      flex:1;
      min-height:0;
    }

    /* 16:9 TILE */
    .tile{
      position:relative;
      background:#050816;
      border-radius:16px;
      border:1px solid rgba(15,23,42,0.45);
      overflow:hidden;
      box-shadow:var(--elev-shadow-soft);
      aspect-ratio:16 / 9;  /* ðŸ”¶ LOCKED 16:9 */
    }

    .tile video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      background:#000;
      display:block;
    }

    .tile-header{
      position:absolute;
      top:8px; left:8px; right:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      pointer-events:none;
      z-index:1;
    }
    .name-pill{
      font-size:12px;
      font-weight:600;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,15,15,0.8);
      border:1px solid rgba(255,255,255,0.25);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
      max-width:65%;
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
      color:#f9fafb;
    }
    .status-pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,15,15,0.85);
      border:1px solid rgba(255,255,255,0.1);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .status-pill.ok{color:#22c55e;border-color:rgba(34,197,94,0.5);}
    .status-pill.err{color:#ef4444;border-color:rgba(239,68,68,0.6);}
    .status-pill.load{color:var(--muted);}
    .status-dot{
      width:7px;height:7px;border-radius:50%;background:var(--muted);
    }
    .status-pill.ok .status-dot{background:#22c55e;}
    .status-pill.err .status-dot{background:#ef4444;}

    .tile-footer{
      position:absolute;
      left:0;right:0;bottom:0;
      padding:8px 10px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(0,0,0,0.95));
      border-top:1px solid rgba(148,163,184,0.2);
      z-index:1;
    }
    .url{
      max-width:80%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:10px;
    }
    .ctrl-button{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:transparent;
      color:#e5e7eb;
      box-shadow:none;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
      cursor:pointer;
    }
    .ctrl-button:hover{
      border-color:var(--brand);
    }

    @media (max-width:640px){
      .page{padding:10px}
      .card{padding:10px}
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="head">
      <div class="brand">
        <img id="bfaLogo" class="logo" alt="BFA logo" />
        <div>
          <h1>BFA â€” Channel Wall</h1>
          <div class="sub">16:9 preview wall. Reads channels from <code>bfa_multi_channels_v1</code>.</div>
        </div>
      </div>
      <div class="right-head">
        <select id="themeSel" title="Theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <button id="refreshBtn" class="btn-outline" type="button">Refresh channels</button>
        <div class="badge">
          <span class="dot"></span>
          <span>TV wall</span>
        </div>
      </div>
    </header>

    <section class="card">
      <div class="card-top">
        <div class="card-title">Live preview</div>
        <div id="statusText" class="status-text">Loading configâ€¦</div>
      </div>
      <div id="grid" class="grid"></div>
    </section>
  </div>

  <script>
    /************* SMALL UTILITIES *************/
    const isUrl = (u) => /^https?:\/\/\S+$/i.test((u || "").trim());

    /************* THEME + LOGO *************/
    const themeSel = document.getElementById("themeSel");
    function applyTheme(mode) {
      const m = mode === "dark" ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", m);
      themeSel.value = m;
      localStorage.setItem("bfa_theme_multi", m);
    }
    applyTheme(localStorage.getItem("bfa_theme_multi") || "light");
    themeSel.addEventListener("change", (e) => applyTheme(e.target.value));

    const LOGO_PRIMARY = "/IPTV-/icons/icon-192.png";
    const FALLBACK_SVG = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="30" viewBox="0 0 120 30"><rect rx="7" width="120" height="30" fill="#ff6a00"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-weight="800" font-size="14" fill="#fff">BFA</text></svg>'
    );
    const logoEl = document.getElementById("bfaLogo");
    logoEl.src = LOGO_PRIMARY;
    logoEl.onerror = () => { logoEl.onerror = null; logoEl.src = FALLBACK_SVG; };

    /************* CONFIG SOURCE (same as editor) *************/
    const STORAGE_KEY = "bfa_multi_channels_v1";
    const MAX_SLOTS = 32;

    const DEFAULT_CHANNELS = [
      {
        id: 1,
        name: "News",
        url: "https://citynewsregional.akamaized.net/hls/live/1024052/Regional_Live_7/Video-2Mbps.m3u8",
      },
      {
        id: 2,
        name: "Tennis Channel S",
        url: "https://amg01444-tennischannelth-tennischannelnl-samsungnl-x3dq1.amagi.tv/playlist/amg01444-tennischannelth-tennischannelnl-samsungnl/playlist.m3u8",
      },
      {
        id: 3,
        name: "Cooking",
        url: "https://gusto-xumo.amagi.tv/playlist.m3u8",
      },
      {
        id: 4,
        name: "Love Nature",
        url: "https://aegis-cloudfront-1.tubi.video/6d6d0f24-8445-4b4c-bdf6-44f9e38beaa4/playlist.m3u8",
      },
      {
        id: 5,
        name: "Kids",
        url: "https://c0c65b821b3542c3a4dca92702f59944.mediatailor.us-east-1.amazonaws.com/v1/master/04fd913bb278d8775298c26fdca9d9841f37601f/RakutenTV-eu_BabySharkTV/playlist.m3u8",
      },
      {
        id: 6,
        name: "Extra Slot",
        url: "",
      }
    ];

    function loadChannelsFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return DEFAULT_CHANNELS.slice();
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return DEFAULT_CHANNELS.slice();
        return parsed.slice(0, MAX_SLOTS).map((c, i) => ({
          id: (c && c.id) || (i + 1),
          name: (c && c.name) || "",
          url: (c && c.url) || "",
        }));
      } catch {
        return DEFAULT_CHANNELS.slice();
      }
    }

    /************* GRID + HLS INSTANCES *************/
    const gridEl = document.getElementById("grid");
    const statusText = document.getElementById("statusText");
    const refreshBtn = document.getElementById("refreshBtn");
    const instances = new Map(); // videoEl -> { hls, id }

    function setStatusLabel(text) {
      statusText.textContent = text;
    }

    function destroyAllInstances() {
      instances.forEach(({ hls }) => {
        if (hls) {
          try { hls.destroy(); } catch (e) {}
        }
      });
      instances.clear();
    }

    function createTile(channel) {
      const tile = document.createElement("section");
      tile.className = "tile";

      tile.innerHTML = `
        <div class="tile-header">
          <div class="name-pill">${channel.name || ("Channel " + channel.id)}</div>
          <div class="status-pill load" data-status>
            <span class="status-dot"></span>
            <span data-status-text>Loadingâ€¦</span>
          </div>
        </div>
        <video muted playsinline autoplay data-chan-id="${channel.id}"></video>
        <div class="tile-footer">
          <div class="url" title="${channel.url}">${channel.url}</div>
          <button class="ctrl-button" type="button" data-reload>Reload</button>
        </div>
      `;

      const video = tile.querySelector("video");
      const statusPill = tile.querySelector("[data-status]");
      const statusTextEl = tile.querySelector("[data-status-text]");
      const reloadBtn = tile.querySelector("[data-reload]");

      const setTileStatus = (state, text) => {
        statusPill.classList.remove("ok", "err", "load");
        if (state === "ok") statusPill.classList.add("ok");
        else if (state === "err") statusPill.classList.add("err");
        else statusPill.classList.add("load");
        statusTextEl.textContent = text;
      };

      const playChannel = () => {
        if (!isUrl(channel.url)) {
          setTileStatus("err", "No URL");
          return;
        }
        setTileStatus("load", "Loadingâ€¦");

        const existing = instances.get(video);
        if (existing && existing.hls) {
          try { existing.hls.destroy(); } catch (e) {}
        }

        if (window.Hls && Hls.isSupported()) {
          const hls = new Hls({ enableWorker: true, lowLatencyMode: true });
          instances.set(video, { hls, id: channel.id });

          hls.attachMedia(video);
          hls.loadSource(channel.url);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video.muted = true;
            video.play().then(() => {
              setTileStatus("ok", "Playing");
            }).catch(err => {
              console.warn("Autoplay blocked for channel", channel.id, err);
              setTileStatus("err", "Autoplay blocked");
            });
          });

          hls.on(Hls.Events.ERROR, (_, data) => {
            console.error("HLS error for channel", channel.id, data);
            if (data && data.fatal) {
              setTileStatus("err", "Stream error");
            }
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = channel.url;
          instances.set(video, { hls: null, id: channel.id });
          video.muted = true;
          video.play().then(() => {
            setTileStatus("ok", "Playing");
          }).catch(err => {
            console.warn("Autoplay blocked (native) channel", channel.id, err);
            setTileStatus("err", "Autoplay blocked");
          });
        } else {
          setTileStatus("err", "HLS not supported");
        }

        video.onerror = () => {
          setTileStatus("err", "Video error");
        };
      };

      reloadBtn.addEventListener("click", playChannel);
      playChannel(); // initial

      return tile;
    }

    function buildGrid() {
      destroyAllInstances();
      gridEl.innerHTML = "";

      const channels = loadChannelsFromStorage();
      const activeChannels = channels.filter(ch => isUrl(ch.url));
      const totalSlots = channels.length;
      const activeCount = activeChannels.length;

      if (!activeCount) {
        setStatusLabel("No enabled channels. Configure them in the editor page.");
        return;
      }

      activeChannels.forEach(ch => {
        gridEl.appendChild(createTile(ch));
      });

      if (activeCount === totalSlots) {
        setStatusLabel(`Showing ${activeCount} channels (all slots in use).`);
      } else {
        setStatusLabel(`Showing ${activeCount} channel${activeCount>1?'s':''} out of ${totalSlots} slots.`);
      }
    }

    // Manual refresh button
    refreshBtn.addEventListener("click", () => {
      buildGrid();
    });

    // Live updates if editor is open in another tab on SAME device + origin
    window.addEventListener("storage", (e) => {
      if (e.key === STORAGE_KEY) {
        buildGrid();
      }
    });

    // Clean up HLS on unload
    window.addEventListener("beforeunload", () => {
      destroyAllInstances();
    });

    /************* INIT *************/
    buildGrid();
  </script>
</body>
</html>
