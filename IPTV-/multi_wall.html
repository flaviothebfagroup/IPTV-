<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BFA â€” Channel Wall</title>

  <!-- hls.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>

  <style>
    :root{
      --brand:#ff6a00; --brand-2:#e85f00;

      /* gradient stops (light) */
      --bg-start:#fff7f0;
      --bg-mid:#ffe0c2;
      --bg-end:#ff6a00;

      --fg:#0f172a;
      --panel:rgba(255,255,255,.56);
      --line:rgba(15,23,42,.06);
      --muted:#64748b;

      --glass-blur:18px;
      --glass-sat:150%;
      --elev-shadow:0 18px 40px rgba(15,23,42,.14), 0 2px 10px rgba(15,23,42,.08);
      --elev-shadow-soft:0 10px 26px rgba(15,23,42,.10), 0 1px 4px rgba(15,23,42,.06);
    }
    [data-theme="dark"]{
      --fg:#e8ecf1;
      --bg-start:#0b0c10;
      --bg-mid:#111827;
      --bg-end:#ff6a00;

      --panel:rgba(18,19,25,.73);
      --line:rgba(255,255,255,.12);
      --muted:#a8b0bc;
      --glass-blur:16px; --glass-sat:150%;
      --elev-shadow:0 18px 40px rgba(0,0,0,.55), 0 2px 8px rgba(0,0,0,.45);
      --elev-shadow-soft:0 12px 28px rgba(0,0,0,.5), 0 1px 4px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{
      margin:0;color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:transparent;
      min-height:100vh;
    }
    /* Nice orange gradient wall with a glow */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-2; pointer-events:none;
      background:
        radial-gradient(circle at 10% 0%, rgba(255,255,255,0.65) 0, transparent 50%),
        radial-gradient(circle at 85% 15%, rgba(255,179,102,0.9) 0, transparent 48%),
        linear-gradient(180deg, var(--bg-start) 0%, var(--bg-mid) 55%, var(--bg-end) 100%);
    }
    body::after{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:radial-gradient(circle at 50% 110%, rgba(0,0,0,0.6) 0, transparent 55%);
      mix-blend-mode:multiply;
    }

    .page{
      max-width:1280px;
      margin:12px auto 18px;
      padding:12px 16px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:100vh;
    }

    /* HEADER */
    .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.3);
      border:1px solid rgba(255,255,255,0.7);
      box-shadow:0 8px 22px rgba(255,106,0,0.35);
      backdrop-filter:blur(18px) saturate(160%);
      -webkit-backdrop-filter:blur(18px) saturate(160%);
    }
    [data-theme="dark"] .brand{
      background:rgba(15,15,20,0.85);
      border-color:rgba(255,255,255,0.18);
      box-shadow:0 10px 24px rgba(0,0,0,0.7);
    }
    .logo{height:34px}
    h1{
      margin:0;
      font-size:clamp(18px,4.2vw,24px);
      font-weight:900;
      letter-spacing:.02em;
    }
    .sub{color:var(--muted);font-size:12px}

    .right-head{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    select,button{
      font-size:13px;
      height:34px;
      padding:0 12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--fg);
      outline:none;
      -webkit-tap-highlight-color:transparent;
      box-shadow:var(--elev-shadow-soft);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 10px 24px rgba(255,106,0,.32);
    }
    .btn-outline{
      background:var(--panel);
      border-color:rgba(255,149,0,.52);
      color:var(--brand);
    }
    button:focus{outline:none}
    button:focus:not(:focus-visible){outline:none}
    button.btn,button.btn-outline{
      transition:transform .12s ease, box-shadow .18s ease, filter .18s ease, background .18s ease;
    }
    button.btn:hover,button.btn-outline:hover{
      transform:translateY(-1px);
      filter:brightness(1.03);
    }
    button.btn:active,button.btn-outline:active{
      transform:translateY(0);
      filter:brightness(.985);
    }

    .badge{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(15,23,42,0.82);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--brand);
      box-shadow:0 0 0 0 rgba(255,149,0,0.7);
      animation:pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(255,149,0,0.7);}
      70%{box-shadow:0 0 0 9px rgba(255,149,0,0);}
      100%{box-shadow:0 0 0 0 rgba(255,149,0,0);}
    }

    /* MAIN CARD */
    .card{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:26px;
      padding:14px 14px 16px;
      box-shadow:var(--elev-shadow);
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      min-height:0;
    }

    .card-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .card-title{font-weight:800;font-size:14px;letter-spacing:.04em;text-transform:uppercase}
    .status-text{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status-pill-small{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      font-size:11px;
      background:rgba(15,23,42,0.06);
    }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:12px;
      width:100%;
      flex:1;
      min-height:0;
    }

    /* 16:9 TILE */
    .tile{
      position:relative;
      background:#050816;
      border-radius:18px;
      border:1px solid rgba(15,23,42,0.55);
      overflow:hidden;
      box-shadow:var(--elev-shadow-soft);
      aspect-ratio:16 / 9;  /* ðŸ”¶ LOCKED 16:9 */
      isolation:isolate;
    }
    .tile::before{
      content:"";
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(circle at 0% 0%, rgba(255,255,255,0.08) 0, transparent 50%),
        radial-gradient(circle at 100% 0%, rgba(255,149,0,0.3) 0, transparent 55%);
      mix-blend-mode:soft-light;
      opacity:.55;
      pointer-events:none;
      z-index:0;
    }

    .tile video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      background:#000;
      display:block;
      z-index:0;
    }

    .tile-header{
      position:absolute;
      top:8px; left:8px; right:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      pointer-events:none;
      z-index:2;
    }
    .name-pill{
      font-size:12px;
      font-weight:650;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(10,10,13,0.86);
      border:1px solid rgba(255,255,255,0.28);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      max-width:68%;
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
      color:#f9fafb;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .name-pill span.idx{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;height:18px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      font-size:11px;
    }

    .status-pill{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(10,10,13,0.9);
      border:1px solid rgba(255,255,255,0.16);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .status-pill.ok{color:#4ade80;border-color:rgba(34,197,94,0.7);}
    .status-pill.err{color:#fecaca;border-color:rgba(239,68,68,0.8);}
    .status-pill.load{color:#e5e7eb;}
    .status-dot{
      width:7px;height:7px;border-radius:50%;background:var(--muted);
    }
    .status-pill.ok .status-dot{background:#22c55e;}
    .status-pill.err .status-dot{background:#ef4444;}

    .tile-footer{
      position:absolute;
      left:0;right:0;bottom:0;
      padding:7px 10px;
      font-size:11px;
      color:#cbd5f5;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(0,0,0,0.98));
      border-top:1px solid rgba(148,163,184,0.38);
      z-index:2;
    }
    .url{
      max-width:80%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:10px;
      opacity:.85;
    }
    .ctrl-button{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:transparent;
      color:#e5e7eb;
      box-shadow:none;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
      cursor:pointer;
    }
    .ctrl-button:hover{
      border-color:var(--brand);
      background:rgba(255,149,0,0.06);
    }

    @media (max-width:640px){
      .page{padding:10px}
      .card{padding:10px}
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="head">
      <div class="brand">
        <img id="bfaLogo" class="logo" alt="BFA logo" />
        <div>
          <h1>BFA IPTV â€” Channel Wall</h1>
          <div class="sub">Beautiful orange test wall â€¢ 16:9 tiles â€¢ Reads from <code>bfa_multi_channels_v1</code>.</div>
        </div>
      </div>
      <div class="right-head">
        <select id="themeSel" title="Theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <button id="refreshBtn" class="btn-outline" type="button">
          âŸ³ Refresh channels
        </button>
        <div class="badge">
          <span class="dot"></span>
          <span>TV wall</span>
        </div>
      </div>
    </header>

    <section class="card">
      <div class="card-top">
        <div class="card-title">Live preview</div>
        <div id="statusText" class="status-text">
          <span class="status-pill-small">Loadingâ€¦</span>
        </div>
      </div>
      <div id="grid" class="grid"></div>
    </section>
  </div>

  <script>
    /************* SMALL UTILITIES *************/
    const isUrl = (u) => /^https?:\/\/\S+$/i.test((u || "").trim());
    const AUTO_REFRESH_MS = 60000; // ðŸ” auto-refresh every 60s (change if you want)

    /************* THEME + LOGO *************/
    const themeSel = document.getElementById("themeSel");
    function applyTheme(mode) {
      const m = mode === "dark" ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", m);
      themeSel.value = m;
      localStorage.setItem("bfa_theme_multi", m);
    }
    applyTheme(localStorage.getItem("bfa_theme_multi") || "light");
    themeSel.addEventListener("change", (e) => applyTheme(e.target.value));

    const LOGO_PRIMARY = "/IPTV-/icons/icon-192.png";
    const FALLBACK_SVG = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="30" viewBox="0 0 120 30"><rect rx="7" width="120" height="30" fill="#ff6a00"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-weight="800" font-size="14" fill="#fff">BFA</text></svg>'
    );
    const logoEl = document.getElementById("bfaLogo");
    logoEl.src = LOGO_PRIMARY;
    logoEl.onerror = () => { logoEl.onerror = null; logoEl.src = FALLBACK_SVG; };

    /************* CONFIG SOURCE (same as editor) *************/
    const STORAGE_KEY = "bfa_multi_channels_v1";
    const MAX_SLOTS = 32;

    const DEFAULT_CHANNELS = [
      {
        id: 1,
        name: "News",
        url: "https://citynewsregional.akamaized.net/hls/live/1024052/Regional_Live_7/Video-2Mbps.m3u8",
      },
      {
        id: 2,
        name: "Tennis Channel S",
        url: "https://amg01444-tennischannelth-tennischannelnl-samsungnl-x3dq1.amagi.tv/playlist/amg01444-tennischannelth-tennischannelnl-samsungnl/playlist.m3u8",
      },
      {
        id: 3,
        name: "Cooking",
        url: "https://gusto-xumo.amagi.tv/playlist.m3u8",
      },
      {
        id: 4,
        name: "Love Nature",
        url: "https://aegis-cloudfront-1.tubi.video/6d6d0f24-8445-4b4c-bdf6-44f9e38beaa4/playlist.m3u8",
      },
      {
        id: 5,
        name: "Kids",
        url: "https://c0c65b821b3542c3a4dca92702f59944.mediatailor.us-east-1.amazonaws.com/v1/master/04fd913bb278d8775298c26fdca9d9841f37601f/RakutenTV-eu_BabySharkTV/playlist.m3u8",
      },
      {
        id: 6,
        name: "Extra Slot",
        url: "",
      }
    ];

    function loadChannelsFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return DEFAULT_CHANNELS.slice();
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return DEFAULT_CHANNELS.slice();
        return parsed.slice(0, MAX_SLOTS).map((c, i) => ({
          id: (c && c.id) || (i + 1),
          name: (c && c.name) || "",
          url: (c && c.url) || "",
        }));
      } catch {
        return DEFAULT_CHANNELS.slice();
      }
    }

    /************* GRID + HLS INSTANCES *************/
    const gridEl = document.getElementById("grid");
    const statusText = document.getElementById("statusText");
    const refreshBtn = document.getElementById("refreshBtn");
    const instances = new Map(); // videoEl -> { hls, id }
    let lastRefresh = null;

    function formatTime(ts){
      const d = ts ? new Date(ts) : new Date();
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    }

    function setStatusLabel(activeCount, totalSlots) {
      if (!activeCount) {
        statusText.innerHTML = `
          <span class="status-pill-small">No enabled channels</span>
          <span>Configure them in the editor page.</span>
        `;
        return;
      }
      const last = lastRefresh ? formatTime(lastRefresh) : formatTime();
      statusText.innerHTML = `
        <span class="status-pill-small">${activeCount} / ${totalSlots} slots in use</span>
        <span>Last refresh: ${last}</span>
        <span style="opacity:.7">Auto-refresh every ${Math.round(AUTO_REFRESH_MS/1000)}s</span>
      `;
    }

    function destroyAllInstances() {
      instances.forEach(({ hls }) => {
        if (hls) {
          try { hls.destroy(); } catch (e) {}
        }
      });
      instances.clear();
    }

    function createTile(channel, index) {
      const tile = document.createElement("section");
      tile.className = "tile";

      tile.innerHTML = `
        <div class="tile-header">
          <div class="name-pill">
            <span class="idx">${index + 1}</span>
            <span class="lbl">${channel.name || ("Channel " + channel.id)}</span>
          </div>
          <div class="status-pill load" data-status>
            <span class="status-dot"></span>
            <span data-status-text>Loadingâ€¦</span>
          </div>
        </div>
        <video muted playsinline autoplay data-chan-id="${channel.id}"></video>
        <div class="tile-footer">
          <div class="url" title="${channel.url}">${channel.url}</div>
          <button class="ctrl-button" type="button" data-reload>Reload</button>
        </div>
      `;

      const video = tile.querySelector("video");
      const statusPill = tile.querySelector("[data-status]");
      const statusTextEl = tile.querySelector("[data-status-text]");
      const reloadBtn = tile.querySelector("[data-reload]");

      const setTileStatus = (state, text) => {
        statusPill.classList.remove("ok", "err", "load");
        if (state === "ok") statusPill.classList.add("ok");
        else if (state === "err") statusPill.classList.add("err");
        else statusPill.classList.add("load");
        statusTextEl.textContent = text;
      };

      const playChannel = () => {
        if (!isUrl(channel.url)) {
          setTileStatus("err", "No URL");
          return;
        }
        setTileStatus("load", "Loadingâ€¦");

        const existing = instances.get(video);
        if (existing && existing.hls) {
          try { existing.hls.destroy(); } catch (e) {}
        }

        if (window.Hls && Hls.isSupported()) {
          const hls = new Hls({ enableWorker: true, lowLatencyMode: true });
          instances.set(video, { hls, id: channel.id });

          hls.attachMedia(video);
          hls.loadSource(channel.url);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video.muted = true;
            video.play().then(() => {
              setTileStatus("ok", "Playing");
            }).catch(err => {
              console.warn("Autoplay blocked for channel", channel.id, err);
              setTileStatus("err", "Autoplay blocked");
            });
          });

          hls.on(Hls.Events.ERROR, (_, data) => {
            console.error("HLS error for channel", channel.id, data);
            if (data && data.fatal) {
              setTileStatus("err", "Stream error");
            }
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = channel.url;
          instances.set(video, { hls: null, id: channel.id });
          video.muted = true;
          video.play().then(() => {
            setTileStatus("ok", "Playing");
          }).catch(err => {
            console.warn("Autoplay blocked (native) channel", channel.id, err);
            setTileStatus("err", "Autoplay blocked");
          });
        } else {
          setTileStatus("err", "HLS not supported");
        }

        video.onerror = () => {
          setTileStatus("err", "Video error");
        };
      };

      reloadBtn.addEventListener("click", playChannel);
      playChannel(); // initial

      return tile;
    }

    function buildGrid() {
      destroyAllInstances();
      gridEl.innerHTML = "";

      const channels = loadChannelsFromStorage();
      const activeChannels = channels.filter(ch => isUrl(ch.url));
      const totalSlots = channels.length;
      const activeCount = activeChannels.length;

      if (!activeCount) {
        setStatusLabel(0, totalSlots || 0);
        return;
      }

      activeChannels.forEach((ch, idx) => {
        gridEl.appendChild(createTile(ch, idx));
      });

      lastRefresh = Date.now();
      setStatusLabel(activeCount, totalSlots);
    }

    // Manual refresh button
    refreshBtn.addEventListener("click", () => {
      buildGrid();
    });

    // Live updates if editor is open in another tab on SAME device + origin
    window.addEventListener("storage", (e) => {
      if (e.key === STORAGE_KEY) {
        buildGrid();
      }
    });

    // Auto-refresh every AUTO_REFRESH_MS
    setInterval(() => {
      buildGrid();
    }, AUTO_REFRESH_MS);

    // Clean up HLS on unload
    window.addEventListener("beforeunload", () => {
      destroyAllInstances();
    });

    /************* INIT *************/
    buildGrid();
  </script>
</body>
</html>
