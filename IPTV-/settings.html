<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
<title>BFA IPTV ‚Äî Settings</title>

<link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
<meta name="theme-color" content="#ffffff"/>
<link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
<link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

<style>
  :root{
    --accent:#ff9500;
    --fg:#111; --muted:#6e6e73; --bg:#ffffff;
    --panel:#fff; --tile:#f6f6f8; --tileHover:#fff7ea;
    --border:rgba(0,0,0,.14); --borderStrong:rgba(0,0,0,.28);
    --shadow:0 14px 36px rgba(0,0,0,.08);
  }
  body.dark{
    --bg:#0b0b0c; --fg:#f7f7f8; --muted:#a1a1a8;
    --panel:#151517; --tile:#1a1a1d; --tileHover:#221e18;
    --border:rgba(255,255,255,.16); --borderStrong:rgba(255,255,255,.36);
    --shadow:0 18px 48px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
  a{color:inherit;text-decoration:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}

  /* ===== NAV ===== */
  .topbar{position:sticky;top:0;z-index:100;background:var(--panel);
    border-bottom:1px solid var(--border);
    padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px}
  .toprow{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px;position:relative}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:#fff center/cover no-repeat}
  .logotxt{font-weight:900;letter-spacing:.2px}
  .nav{display:flex;gap:10px;margin-left:auto;margin-right:auto}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:9999px;border:1px solid transparent;background:transparent;color:inherit;font-weight:800;font-size:14px}
  .pill:hover{border-color:var(--accent)}
  .pill.is-active{outline:2px solid var(--accent)}
  .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}
  .more{position:relative}
  #moreBtn .plus{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
  #moreMenu{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;min-width:230px;background:var(--panel);
    border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none}
  #moreMenu.open{display:block}
  #moreMenu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px}
  #moreMenu a:hover{background:var(--tileHover)}
  #moreMenu a.is-active{outline:2px solid var(--accent)}
  #moreMenu .ic{width:18px;height:18px;stroke-width:1.9}
  .actions{display:flex;gap:8px;align-items:center}
  .email{max-width:240px;padding:6px 10px;border-radius:9999px;background:var(--tile);
    border:1.5px solid var(--borderStrong);color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .chip{height:34px;min-width:34px;padding:0 12px;border-radius:9999px;border:1.5px solid var(--borderStrong);
    background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .chip:hover{border-color:var(--accent)}
  .chip .ic{width:18px;height:18px;stroke-width:2}
  #hamburger{display:none;border:0;background:transparent;color:var(--accent);height:42px;min-width:42px;padding:0;align-items:center;justify-content:center;position:absolute;right:0;top:50%;transform:translateY(-50%)}
  #hamburger .ic{width:22px;height:22px;stroke:var(--accent);stroke-width:2.35}
  @media (max-width:920px){.nav{display:none} #hamburger{display:inline-flex} .email{display:none}}

  #sheet{position:fixed;inset:0;z-index:120;display:none}
  #sheet.open{display:block}
  #sheet .back{position:absolute;inset:0;background:rgba(0,0,0,.28)}
  .panel{position:absolute;right:0;top:0;height:100%;width:min(86vw,360px);background:var(--panel);border-left:1px solid var(--border);
    box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:14px}
  .panel .row{display:flex;align-items:center;justify-content:space-between}
  .panel nav{display:grid;gap:8px}
  .panel nav a{justify-content:flex-start}

  /* ===== Page ===== */
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px}
  .muted{color:var(--muted);font-size:12px}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .input,textarea{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
  textarea{min-height:120px;resize:vertical}
  .btn{height:34px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center}
  .btn.solid{background:var(--accent);border-color:var(--accent);color:#000}
  .btn.danger{border-color:#ff6b6b;color:#ff6b6b;background:transparent}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0}
  @media (max-width:720px){.row2,.row3{grid-template-columns:1fr}}

  /* Explorer table */
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .tr{display:grid;grid-template-columns:28px 1fr auto auto auto;gap:8px;align-items:center;background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:8px}
  .tr .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:transparent;font-size:12px;color:var(--muted)}
  .crumbs{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .crumbs a{padding:6px 10px;border:1px solid var(--border);border-radius:9999px}
  .crumbs a.active{border-color:var(--accent)}

  /* Tabs + toast (for Delete Users card) */
  .tabs{display:flex;gap:8px;margin-top:10px;margin-bottom:8px}
  .tab{padding:6px 10px;border:1px solid var(--border);border-radius:9999px;cursor:pointer;font-weight:800}
  .tab.active{border-color:var(--accent)}
  .hide{display:none}
  .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
  .toast.show{opacity:1}
</style>
</head>
<body>
<header class="topbar">
  <div class="toprow">
    <a class="brand" href="home.html"><span class="logo" id="brandLogo"></span><span class="logotxt">BFA IPTV</span></a>
    <nav class="nav" aria-label="Primary">
      <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
      <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
      <a class="pill" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
      <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
      <div class="more">
        <a id="moreBtn" class="pill" href="javascript:void(0)"><svg class="plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg> More</a>
        <div id="moreMenu" role="menu" aria-label="More">
          <a href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
          <a href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
          <a href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
          <a href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
          <a class="is-active" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
        </div>
      </div>
    </nav>
    <div class="actions">
      <span id="adminEmail" class="email"></span>
      <button id="themeBtn" class="chip" title="Light/Dark"><svg id="themeIcon" class="ic" viewBox="0 0 24 24"></svg>Theme</button>
      <button id="signOutBtn" class="chip">Sign out</button>
      <button id="hamburger" class="chip" aria-label="Menu"><svg class="ic" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg></button>
    </div>
  </div>
  <div id="sheet" aria-hidden="true">
    <div class="back"></div>
    <aside class="panel" role="dialog" aria-modal="true" aria-label="Menu">
      <div class="row">
        <div class="brand"><span class="logo" id="brandLogoM"></span><span class="logotxt">BFA IPTV</span></div>
        <button id="closeSheet" class="chip" aria-label="Close"><svg class="ic" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
      </div>
      <nav>
        <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
        <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
        <a class="pill" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
        <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
        <div class="muted" style="padding:8px 2px 0">More</div>
        <a class="pill" href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
        <a class="pill" href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
        <a class="pill" href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
        <a class="pill" href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
        <a class="pill is-active" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
        <button id="signOutBtnM" class="chip" style="margin-top:8px">Sign out</button>
      </nav>
    </aside>
  </div>
</header>

<div class="wrap">

  <!-- ===== GitHub Connection ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">GitHub Connection</h3>
    <div class="row3">
      <div><div class="label">Owner</div><input id="ghcOwner" class="input" value="flaviothebfagroup"/></div>
      <div><div class="label">Repo</div><input id="ghcRepo" class="input" value="IPTV-"/></div>
      <div><div class="label">Branch</div><input id="ghcBranch" class="input" value="main"/></div>
    </div>
    <div class="row2">
      <div><div class="label">Token</div><input id="ghcToken" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password"/></div>
      <div style="display:flex;gap:8px;align-items:end">
        <button id="ghSave" class="btn solid">Save</button>
        <button id="ghClear" class="btn">Clear</button>
        <button id="ghTest" class="btn">Test</button>
      </div>
    </div>
    <div class="muted">Token is stored locally in this browser only.</div>
    <div id="ghStatus" class="small mono muted" style="margin-top:6px"></div>
  </div>

  <!-- ===== GitHub Explorer (ALL FILES) ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">GitHub Explorer (All Files)</h3>
    <div class="crumbs" id="breadcrumbs" style="margin-bottom:8px"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="exUp" class="btn">Up</button>
      <button id="exRefresh" class="btn">Refresh</button>
      <button id="exDeleteSel" class="btn danger">Delete selected</button>
      <button id="exNewFile" class="btn">New file‚Ä¶</button>
      <button id="exNewFolder" class="btn">New folder‚Ä¶</button>
      <label class="btn"><input id="exUpload" type="file" style="display:none">Upload‚Ä¶</label>
      <span class="muted">Tip: Folder rename isn‚Äôt supported directly. Open the folder and rename/move files inside.</span>
    </div>
    <div id="exTable"></div>
  </div>

  <!-- ===== Pull Requests ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">Open Pull Requests</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="prRefresh" class="btn">Refresh PRs</button>
    </div>
    <div id="prList"></div>
  </div>

  <!-- ===== Delete Anonymous Users ===== -->
  <div class="card" id="purgeCard">
    <h3 style="margin:0 0 8px">Delete Anonymous Users</h3>
    <div class="muted">Two ways: <b>Cloud Shell (no deploy)</b> or <b>Direct (optional)</b>.</div>

    <div class="tabs">
      <button class="tab active" data-tab="shell">Cloud Shell (no deploy)</button>
      <button class="tab" data-tab="direct">Direct (optional)</button>
    </div>

    <!-- Cloud Shell tab -->
    <div id="tab-shell">
      <div class="row3">
        <div><div class="label">Keep last N days (0 = ALL)</div><input id="purgeDays" class="input" type="number" min="0" step="1" value="0"/></div>
        <div><div class="label">Firebase projectId</div><input id="purgeFbProject" class="input" value="iptv-bfa"/></div>
        <div><div class="label">GCP project ID (console header)</div><input id="purgeGcpProject" class="input" value="iptv-bfa-471617"/></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="btnPurgeCopy" class="btn solid">Copy Cloud Shell commands</button>
        <a id="btnPurgeOpenShell" class="btn" target="_blank" rel="noopener">Open Cloud Shell</a>
        <button id="btnPurgeShow" class="btn">Show commands</button>
      </div>
      <textarea id="purgeCmd" class="input mono" style="margin-top:10px;display:none;height:260px" spellcheck="false"></textarea>
    </div>

    <!-- Direct tab -->
    <div id="tab-direct" class="hide">
      <div class="row3">
        <div><div class="label">Function URL (https‚Ä¶/purgeAnonHttp)</div><input id="purgeUrl" class="input" placeholder="https://us-central1-iptv-bfa.cloudfunctions.net/purgeAnonHttp"></div>
        <div><div class="label">Secret key</div><input id="purgeKey" class="input" placeholder="Only stored in this browser"></div>
        <div><div class="label">Keep last N days (0 = ALL)</div><input id="purgeDays2" class="input" type="number" min="0" step="1" value="0"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="btnDirectDry" class="btn">Dry run</button>
        <button id="btnDirectGo" class="btn solid">Run purge</button>
      </div>
      <pre id="purgeOut" class="mono" style="margin-top:10px;background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:12px;white-space:pre-wrap"></pre>
      <div class="muted" style="margin-top:6px">URL/key are saved only in this browser (localStorage).</div>
    </div>
  </div>

  <!-- ===== Central Config (helper) ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">Central Config Source</h3>
    <div class="row3">
      <div><div class="label">Owner</div><input id="ghOwner" class="input" value="flaviothebfagroup"/></div>
      <div><div class="label">Repo</div><input id="ghRepo" class="input" value="IPTV-"/></div>
      <div><div class="label">Branch</div><input id="ghBranch" class="input" value="main"/></div>
    </div>
    <div class="row2">
      <div><div class="label">Path (in repo)</div><input id="ghPath" class="input" value="config/iptv-config.json"/></div>
      <div><div class="label">Raw URL (auto)</div><input id="rawUrl" class="input mono" readonly/></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button id="btnOpenFile" class="btn">Open in GitHub</button>
      <button id="btnOpenEditor" class="btn">Open GitHub Editor</button>
      <button id="btnLoadConfig" class="btn">View current JSON</button>
      <button id="btnCopyLoader" class="btn solid">Copy loader snippet</button>
    </div>
    <textarea id="cfgView" class="input mono" style="margin-top:10px;display:none;height:220px" spellcheck="false"></textarea>
  </div>

</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  /* ==== FIREBASE (auth for this page) ==== */
  const firebaseConfig = {
    apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
    authDomain: "iptv-bfa.firebaseapp.com",
    databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
    projectId: "iptv-bfa",
    storageBucket: "iptv-bfa.firebasestorage.app",
    messagingSenderId: "838790935867",
    appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
  };

  const LOGO_URL="/IPTV-/icons/icon-512.png";
  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);

  const $=s=>document.querySelector(s);
  function toast(m){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}
  const mono = s => `<span class="mono">${s}</span>`;

  // Logo + Theme
  $('#brandLogo').style.backgroundImage=`url("${LOGO_URL}")`;
  const brandLogoM=document.getElementById('brandLogoM'); if(brandLogoM){ brandLogoM.style.backgroundImage=`url("${LOGO_URL}")`; }
  const THEME_KEY='iptv_theme';
  (function(){
    const themeBtn=$('#themeBtn'), themeIcon=$('#themeIcon');
    const saved=localStorage.getItem(THEME_KEY)||'light';
    document.body.classList.toggle('dark', saved==='dark');
    const setIcon=()=>{ const dark=document.body.classList.contains('dark');
      themeIcon.innerHTML = dark? `<path d="M21 12a9 9 0 1 1-9-9 6 6 0 0 0 9 9z"/>`
        : `<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M5 19l-1.4 1.4M20.4 3.6 19 5"/>`; };
    setIcon();
    themeBtn.addEventListener('click',()=>{const d=!document.body.classList.contains('dark');document.body.classList.toggle('dark',d);localStorage.setItem(THEME_KEY,d?'dark':'light');setIcon();});
  })();

  // More dropdown + mobile sheet
  (function(){
    const moreBtn=$('#moreBtn'), moreMenu=$('#moreMenu');
    if(moreBtn){
      moreBtn.addEventListener('click',(e)=>{e.preventDefault();moreMenu.classList.toggle('open');});
      document.addEventListener('click',(e)=>{ if(!moreMenu.contains(e.target) && e.target!==moreBtn && !moreBtn.contains(e.target)) moreMenu.classList.remove('open'); },{capture:true});
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') moreMenu.classList.remove('open'); });
      const file=(location.pathname.split("/").pop()||"settings.html").toLowerCase();
      moreMenu.querySelectorAll('a').forEach(a=>{ const h=(a.getAttribute('href')||'').toLowerCase(); if(h===file){ a.classList.add('is-active'); }});
    }
    const sheet=$('#sheet');
    const open=()=>{sheet.classList.add('open');document.body.style.overflow='hidden';};
    const close=()=>{sheet.classList.remove('open');document.body.style.overflow='';};
    $('#hamburger').addEventListener('click',open);
    $('#closeSheet').addEventListener('click',close);
    sheet.querySelector('.back').addEventListener('click',close);
    const mainOut=$('#signOutBtn'), mobOut=$('#signOutBtnM'); if(mainOut && mobOut) mobOut.addEventListener('click',()=> mainOut.click());
  })();

  // Auth
  setPersistence(auth,browserLocalPersistence);
  onAuthStateChanged(auth,u=>{
    if(!u){ location.href='./home.html'; return; }
    $('#adminEmail').textContent=u.email||u.uid;
  });
  $('#signOutBtn').addEventListener('click',()=>signOut(auth));

  /* ===== Central Config helper (read only) ===== */
  const ghOwner=$('#ghOwner'), ghRepo=$('#ghRepo'), ghBranch=$('#ghBranch'), ghPath=$('#ghPath'), rawUrl=$('#rawUrl');
  function computeRaw(){ return `https://raw.githubusercontent.com/${ghOwner.value.trim()}/${ghRepo.value.trim()}/${ghBranch.value.trim()}/${ghPath.value.trim()}`; }
  function refreshRaw(){ rawUrl.value = computeRaw(); }
  [ghOwner,ghRepo,ghBranch,ghPath].forEach(el=>el.addEventListener('input', refreshRaw));
  refreshRaw();
  $('#btnOpenFile').onclick=()=> window.open(`https://github.com/${ghOwner.value.trim()}/${ghRepo.value.trim()}/blob/${ghBranch.value.trim()}/${ghPath.value.trim()}`,'_blank','noopener');
  $('#btnOpenEditor').onclick=()=> window.open(`https://github.com/${ghOwner.value.trim()}/${ghRepo.value.trim()}/edit/${ghBranch.value.trim()}/${ghPath.value.trim()}`,'_blank','noopener');
  $('#btnLoadConfig').onclick=async()=>{ const out=$('#cfgView'); out.style.display='block'; out.value='Loading‚Ä¶'; try{ const resp=await fetch(computeRaw(),{cache:'no-store'}); out.value=await resp.text(); }catch(e){ out.value='Error: '+(e?.message||String(e)); } };
  $('#btnCopyLoader').onclick=async()=>{
    const url=computeRaw();
    const snip = `// Central loader
const CONFIG_URL='${url}';
const appConfig=await fetch(CONFIG_URL,{cache:'no-store'}).then(r=>r.json());
const firebaseConfig=appConfig.firebaseConfig;`;
    try{await navigator.clipboard.writeText(snip); toast('Loader snippet copied');}
    catch{const ta=document.createElement('textarea'); ta.value=snip; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast('Loader snippet copied');}
  };

  /* ===== GITHUB API HELPERS ===== */
  function ghCfg(){ try{return JSON.parse(localStorage.getItem('iptv_admin_gh')||'{}');}catch{return{};} }
  function saveGhCfg(c){ localStorage.setItem('iptv_admin_gh', JSON.stringify(c)); }
  const ghcOwner=$('#ghcOwner'), ghcRepo=$('#ghcRepo'), ghcBranch=$('#ghcBranch'), ghcToken=$('#ghcToken');
  // prefill
  (()=>{
    const c=ghCfg();
    if(c.owner) ghcOwner.value=c.owner;
    if(c.repo)  ghcRepo.value=c.repo;
    if(c.branch)ghcBranch.value=c.branch;
    if(c.token) ghcToken.value=c.token;
  })();

  $('#ghSave').onclick=()=>{ const c={owner:ghcOwner.value.trim(),repo:ghcRepo.value.trim(),branch:ghcBranch.value.trim()||'main',token:ghcToken.value.trim()}; if(!c.owner||!c.repo||!c.token){toast('Fill owner/repo/token');return;} saveGhCfg(c); toast('GitHub saved'); };
  $('#ghClear').onclick=()=>{ localStorage.removeItem('iptv_admin_gh'); toast('Cleared'); location.reload(); };

  function headers(scheme='Bearer', tok=ghCfg().token){
    return {'Authorization':`${scheme} ${tok}`,'Accept':'application/vnd.github+json','Content-Type':'application/json','X-GitHub-Api-Version':'2022-11-28'};
  }
  async function ghFetch(url,opts={}){
    let r=await fetch(url,{...opts,headers:headers('Bearer')});
    if(r.status===401) r=await fetch(url,{...opts,headers:headers('token')});
    return r;
  }
  async function ghText(r){ const t=await r.text().catch(()=> ''); try{ return {json:JSON.parse(t), raw:t}; }catch{ return {json:null, raw:t}; } }
  function encPath(p){ return (p||'').split('/').map(encodeURIComponent).join('/'); }
  function needPR(msg,status){ const m=String(msg||'').toLowerCase(); return status===403||status===422||m.includes('protected')||m.includes('status check')||m.includes('resource not accessible'); }

  async function whoami(){
    const r=await ghFetch('https://api.github.com/user');
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`user [${r.status}] ${json?.message||raw}`); }
    return r.json();
  }
  async function getRef(branch){
    const c=ghCfg(); const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/git/ref/heads/${encodeURIComponent(branch)}`);
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`ref [${r.status}] ${json?.message||raw}`); }
    return (await r.json()).object.sha;
  }
  async function createBranch(from,to){
    const sha=await getRef(from);
    const c=ghCfg(); const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/git/refs`,{method:'POST',body:JSON.stringify({ref:`refs/heads/${to}`,sha})});
    if(!r.ok && r.status!==422){ const {json,raw}=await ghText(r); throw new Error(`branch [${r.status}] ${json?.message||raw}`); }
  }
  async function fileSha(path,branch){
    const c=ghCfg(); const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encPath(path)}?ref=${encodeURIComponent(branch)}`);
    if(r.status===404) return null;
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`sha [${r.status}] ${json?.message||raw}`); }
    return (await r.json()).sha||null;
  }
  async function fetchFile(path,branch){
    const c=ghCfg();
    const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encPath(path)}?ref=${encodeURIComponent(branch)}`;
    const r=await ghFetch(url);
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`get [${r.status}] ${json?.message||raw}`); }
    return r.json(); // has base64 content for files
  }
  async function listDir(path,branch){
    const c=ghCfg();
    const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encPath(path)}?ref=${encodeURIComponent(branch)}`);
    if(r.status===404) return [];
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`ls [${r.status}] ${json?.message||raw}`); }
    const arr=await r.json();
    return Array.isArray(arr)?arr:[]; // directory listing only
  }
  async function openPR(head,base,title,body){
    const c=ghCfg();
    const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/pulls`,{method:'POST',body:JSON.stringify({title,head,base,body})});
    if(!r.ok && r.status!==422){ const {json,raw}=await ghText(r); throw new Error(`PR [${r.status}] ${json?.message||raw}`); }
    return r.json?.();
  }
  async function upsertFile(path,{contentBase64=null,text=null,message,branch}={}){
    const c=ghCfg(); const br=branch||c.branch||'main';
    const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encPath(path)}`;
    const sha=await fileSha(path,br);
    const content = contentBase64 ?? btoa(unescape(encodeURIComponent(text||'')));
    let res=await ghFetch(url,{method:'PUT',body:JSON.stringify({message:message||`Update ${path}`,content,branch:br,...(sha?{sha}:{})})});
    if(!res.ok){
      const {json,raw}=await ghText(res);
      if(needPR(json?.message||raw,res.status)){
        const tmp=`iptv-admin-${Date.now().toString(36)}`;
        await createBranch(br,tmp);
        const sha2=await fileSha(path,tmp);
        const res2=await ghFetch(url,{method:'PUT',body:JSON.stringify({message:message||`Update ${path}`,content,branch:tmp,...(sha2?{sha:sha2}:{})})});
        if(!res2.ok){ const {json:jj,raw:rr}=await ghText(res2); throw new Error(`PUT@PR [${res2.status}] ${jj?.message||rr}`); }
        await openPR(tmp, br, message||`Update ${path}`, `Auto-created by Settings page\n\nPath: \`${path}\``);
        return res2.json();
      }
      throw new Error(`put [${res.status}] ${json?.message||raw}`);
    }
    return res.json();
  }
  async function deleteFile(path,{message,branch}={}){
    const c=ghCfg(); const br=branch||c.branch||'main';
    const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encPath(path)}`;
    const sha=await fileSha(path,br);
    if(!sha) return {ok:true,skipped:true};
    let res=await ghFetch(url,{method:'DELETE',body:JSON.stringify({message:message||`Delete ${path}`,sha,branch:br})});
    if(!res.ok){
      const {json,raw}=await ghText(res);
      if(needPR(json?.message||raw,res.status)){
        const tmp=`iptv-delete-${Date.now().toString(36)}`;
        await createBranch(br,tmp);
        const sha2=await fileSha(path,tmp);
        if(!sha2) return {ok:true,skipped:true};
        const res2=await ghFetch(url,{method:'DELETE',body:JSON.stringify({message:message||`Delete ${path}`,sha:sha2,branch:tmp})});
        if(!res2.ok){ const {json:jj,raw:rr}=await ghText(res2); throw new Error(`del@PR [${res2.status}] ${jj?.message||rr}`); }
        await openPR(tmp, br, message||`Delete ${path}`, `Auto-created by Settings page (delete)\n\nPath: \`${path}\``);
        return res2.json();
      }
      throw new Error(`del [${res.status}] ${json?.message||raw}`);
    }
    return res.json();
  }

  // GitHub Test
  $('#ghTest').onclick=async()=>{
    const c=ghCfg(); if(!c.token){ toast('Set token first'); return; }
    try{
      const me=await whoami();
      const ref=await getRef(c.branch||'main');
      $('#ghStatus').innerHTML=`OK as ${mono(me.login)} ‚Äî branch ${mono((c.branch||'main'))} @ ${mono(ref.slice(0,7))}`;
      toast('GitHub OK');
    }catch(e){ $('#ghStatus').textContent=String(e.message||e); toast('GitHub failed'); }
  };

  /* ====== EXPLORER (ALL FILES) ====== */
  let currentPath = ''; // '' = repo root

  function setCrumbs(){
    const bc=$('#breadcrumbs');
    const parts=currentPath?currentPath.split('/'):[];
    const acc=[];
    let html = `<a href="javascript:void(0)" data-path="" class="active">/${ghcRepo.value}</a>`;
    parts.forEach((p)=>{
      acc.push(p);
      html += `<span class="muted">‚Ä∫</span><a href="javascript:void(0)" data-path="${acc.join('/')}">${p}</a>`;
    });
    bc.innerHTML = html;
    bc.querySelectorAll('a').forEach(a=>{
      a.onclick=()=>{ currentPath=a.dataset.path||''; refreshExplorer(); };
    });
  }

  function icon(type){ return type==='dir' ? 'üìÅ' : 'üìÑ'; }

  async function refreshExplorer(){
    const table=$('#exTable'); table.innerHTML='Loading‚Ä¶';
    setCrumbs();
    try{
      const c=ghCfg(); if(!c.owner||!c.repo||!c.branch||!c.token){ table.innerHTML='<div class="muted">Set GitHub connection first.</div>'; return; }
      let items = await listDir(currentPath, c.branch||'main');
      items = (items||[]).sort((a,b)=>{
        if(a.type!==b.type) return a.type==='dir'?-1:1;
        return a.name.localeCompare(b.name);
      });
      const rows = items.map(it=>{
        const size = it.type==='file' ? `<span class="badge">${(it.size||0)} bytes</span>` : '';
        const rawUrl = it.type==='file'
          ? `https://raw.githubusercontent.com/${c.owner}/${c.repo}/${encodeURIComponent(c.branch||'main')}/${encPath((currentPath?currentPath+'/':'')+it.name)}`
          : '#';
        return `
          <div class="tr" data-name="${it.name}" data-type="${it.type}">
            <input type="checkbox" class="chk">
            <div class="name mono">${icon(it.type)} ${(it.name)}</div>
            <div>${size}</div>
            <div style="display:flex;gap:6px">
              ${it.type==='dir'
                ? `<button class="btn" data-open>Open</button>`
                : `<a class="btn" href="${rawUrl}" target="_blank" rel="noopener">Raw</a>`}
              <button class="btn" data-rename>Rename</button>
              ${it.type==='file'?`<button class="btn danger" data-delete>Delete</button>`:''}
            </div>
            <a class="btn" target="_blank" rel="noopener" href="https://github.com/${c.owner}/${c.repo}/${it.type==='dir'?'tree':'blob'}/${encodeURIComponent(c.branch||'main')}/${encPath((currentPath?currentPath+'/':'')+it.name)}">GitHub</a>
          </div>`;
      }).join('') || '<div class="muted">Empty folder.</div>';
      table.innerHTML = `<div style="margin-bottom:6px"><label class="badge"><input id="exAll" type="checkbox"> Select all</label></div><div class="table">${rows}</div>`;
      $('#exAll')?.addEventListener('change',()=>{ table.querySelectorAll('.chk').forEach(x=>x.checked=$('#exAll').checked); });

      // open dir
      table.querySelectorAll('[data-open]').forEach(btn=>{
        btn.onclick=()=>{ const row=btn.closest('.tr'); const name=row.dataset.name; const next = currentPath?`${currentPath}/${name}`:name; currentPath = next; refreshExplorer(); };
      });
      // delete file
      table.querySelectorAll('[data-delete]').forEach(btn=>{
        btn.onclick=async()=>{
          const row=btn.closest('.tr'); const name=row.dataset.name;
          const full=(currentPath?currentPath+'/':'')+name;
          if(!confirm(`Delete ${full}?`)) return;
          try{ await deleteFile(full,{message:`Delete ${full}`}); toast('Deleted (PR if needed)'); refreshExplorer(); }catch(e){ toast(`Delete failed: ${e.message||e}`); }
        };
      });
      // rename (files only)
      table.querySelectorAll('[data-rename]').forEach(btn=>{
        btn.onclick=async()=>{
          const row=btn.closest('.tr'); const name=row.dataset.name; const type=row.dataset.type;
          const full=(currentPath?currentPath+'/':'')+name;
          const newName=(prompt(`Rename ${name} to:`, name)||'').trim();
          if(!newName || newName===name) return;
          const target=(currentPath?currentPath+'/':'')+newName;
          try{
            if(type==='dir'){ alert('Folder rename not supported. Open the folder and rename files inside.'); return; }
            const meta=await fetchFile(full, ghCfg().branch||'main'); // has content base64
            await upsertFile(target,{contentBase64:meta.content.replace(/\n/g,''),message:`Rename ${full} ‚Üí ${target}`});
            await deleteFile(full,{message:`Remove old ${full}`});
            toast('Renamed (PR if needed)');
            refreshExplorer();
          }catch(e){ toast(`Rename failed: ${e.message||e}`); }
        };
      });

    }catch(e){
      console.error(e);
      table.innerHTML=`<div class="small mono" style="color:#ef4444">${String(e.message||e)}</div>`;
    }
  }

  $('#exRefresh').onclick=refreshExplorer;
  $('#exUp').onclick=()=>{ if(!currentPath) return; currentPath=currentPath.split('/').slice(0,-1).join('/'); refreshExplorer(); };
  $('#exDeleteSel').onclick=async()=>{
    const tbl=$('#exTable'); const picks=[...tbl.querySelectorAll('.tr')].filter(r=>r.querySelector('.chk')?.checked);
    const files = picks.filter(r=>r.dataset.type==='file').map(r=>(currentPath?currentPath+'/':'')+r.dataset.name);
    if(files.length===0){ toast('Pick file(s)'); return; }
    if(!confirm(`Delete ${files.length} file(s)?`)) return;
    try{
      for(const f of files){ await deleteFile(f,{message:`Delete ${f}`}); }
      toast('Delete done (PR if needed)'); refreshExplorer();
    }catch(e){ toast(`Delete failed: ${e.message||e}`); }
  };
  $('#exNewFile').onclick=async()=>{
    const name=(prompt('New file path (relative to current folder):','new.txt')||'').trim();
    if(!name) return;
    const full=(currentPath?currentPath+'/':'')+name;
    const text=prompt('Initial content (optional):','')||'';
    try{ await upsertFile(full,{text,message:`Create ${full}`}); toast('File created (PR if needed)'); refreshExplorer(); }catch(e){ toast(`Create failed: ${e.message||e}`); }
  };
  $('#exNewFolder').onclick=async()=>{
    const name=(prompt('New folder name:','NewFolder')||'').trim();
    if(!name) return;
    const full=(currentPath?currentPath+'/':'')+name+'/.gitkeep';
    try{ await upsertFile(full,{text:'',message:`Create folder ${(currentPath?currentPath+'/':'')+name}`}); toast('Folder created'); refreshExplorer(); }catch(e){ toast(`Create failed: ${e.message||e}`); }
  };
  $('#exUpload').addEventListener('change', async (ev)=>{
    const f=ev.target.files?.[0]; if(!f) return;
    const path=(prompt('Upload to (file name):', (currentPath?currentPath+'/':'')+f.name)||'').trim();
    if(!path) return;
    try{
      const buf=await f.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
      await upsertFile(path,{contentBase64:base64,message:`Upload ${path}`});
      toast('Uploaded'); refreshExplorer();
    }catch(e){ toast(`Upload failed: ${e.message||e}`); }
    ev.target.value='';
  });

  /* ===== PR LIST ===== */
  async function listPRs(){
    const c=ghCfg();
    const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/pulls?state=open`);
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`prs [${r.status}] ${json?.message||raw}`); }
    return r.json();
  }
  async function mergePR(num){
    const c=ghCfg();
    const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/pulls/${num}/merge`,{method:'PUT',body:JSON.stringify({merge_method:'squash'})});
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`merge [${r.status}] ${json?.message||raw}`); }
    return r.json();
  }
  async function refreshPRs(){
    const list=$('#prList'); list.innerHTML='Loading‚Ä¶';
    try{
      const prs=await listPRs();
      if(!prs||prs.length===0){ list.innerHTML='<div class="muted">No open PRs.</div>'; return; }
      list.innerHTML=prs.map(p=>`
        <div class="tr" style="grid-template-columns:1fr auto auto;">
          <div><b>#${p.number}</b> ‚Äî ${p.title} <span class="badge">from ${mono(p.head.ref)}</span></div>
          <a class="btn" target="_blank" rel="noopener" href="${p.html_url}">Open</a>
          <button class="btn" data-merge="${p.number}">Merge</button>
        </div>`).join('');
      list.querySelectorAll('[data-merge]').forEach(b=>{
        b.onclick=async()=>{ try{ await mergePR(b.dataset.merge); toast('Merged'); refreshExplorer(); refreshPRs(); }catch(e){ toast(`Merge failed: ${e.message||e}`); } };
      });
    }catch(e){ list.innerHTML=`<div class="small mono" style="color:#ef4444">${String(e.message||e)}</div>`; }
  }
  $('#prRefresh').onclick=refreshPRs;

  /* ===== Delete Users: tabs ===== */
  document.querySelectorAll('#purgeCard .tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('#purgeCard .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const which=btn.dataset.tab;
      $('#tab-shell').classList.toggle('hide', which!=='shell');
      $('#tab-direct').classList.toggle('hide', which!=='direct');
    });
  });

  /* ===== Delete Users: Cloud Shell helper ===== */
  (function(){
    const daysEl=$('#purgeDays'), fbEl=$('#purgeFbProject'), gcpEl=$('#purgeGcpProject');
    const outEl=$('#purgeCmd'), btnCopy=$('#btnPurgeCopy'), btnOpen=$('#btnPurgeOpenShell'), btnShow=$('#btnPurgeShow');

    function buildCommands(){
      const DAYS=Math.max(0,parseInt(daysEl.value||'0',10))||0;
      const FB=(fbEl.value||'iptv-bfa').trim();
      const GCP=(gcpEl.value||FB).trim();
      return `gcloud config set project ${GCP}

mkdir -p ~/auth-purge && cd ~/auth-purge
npm init -y >/dev/null 2>&1
npm i firebase-admin@12 >/dev/null 2>&1

cat > purge-anon.js <<'JS'
const admin = require('firebase-admin');
admin.initializeApp({ credential: admin.credential.applicationDefault(), projectId: '${FB}' });
function tms(x){ const n=new Date(x||0).getTime(); return Number.isFinite(n)?n:0; }
const argv=process.argv.slice(2);function arg(n,d){const i=argv.findIndex(a=>a==='--'+n||a.startsWith('--'+n+'='));if(i<0)return d;const v=argv[i].includes('=')?argv[i].split('=')[1]:argv[i+1];return v??d;}
const days=Number(arg('days', ${DAYS}))||0;const dryRun=argv.includes('--dry-run');
(async()=>{const cutoff=Date.now()-days*24*60*60*1000;let scanned=0,kept=0,next;const batch=[];
  console.log('Scanning‚Ä¶ days='+days+', cutoff='+new Date(cutoff).toISOString()+', dryRun='+dryRun);
  do{const page=await admin.auth().listUsers(1000,next);
    for(const u of page.users){scanned++;const isAnon=!u.providerData||u.providerData.length===0;if(!isAnon){kept++;continue;}
      const last=Math.max(tms(u.metadata.lastSignInTime),tms(u.metadata.creationTime)); if(last<cutoff) batch.push(u.uid); else kept++; }
    next=page.pageToken; if(scanned%5000===0) console.log('‚Ä¶scanned='+scanned+', candidates='+batch.length);
  }while(next);
  console.log('Scan done. scanned='+scanned+', candidates='+batch.length+', kept='+kept);
  if(dryRun||!batch.length)return; let deleted=0,errors=0;
  for(let i=0;i<batch.length;i+=1000){const chunk=batch.slice(i,i+1000);const r=await admin.auth().deleteUsers(chunk);deleted+=r.successCount;errors+=r.failureCount;console.log('Deleted '+r.successCount+' (chunk '+(i+1)+'-'+Math.min(i+chunk.length,batch.length)+')');}
  console.log('Finished. Deleted='+deleted+', errors='+errors);
})(); 
JS

node purge-anon.js --days ${DAYS} --dry-run
node purge-anon.js --days ${DAYS}
`; }

    function refresh(show=false){ outEl.value=buildCommands(); if(show) outEl.style.display='block'; }
    btnCopy.addEventListener('click',async()=>{refresh(false); try{await navigator.clipboard.writeText(outEl.value);toast('Commands copied');}catch{outEl.style.display='block';outEl.select();document.execCommand('copy');toast('Commands copied');}});
    btnShow.addEventListener('click',()=>{refresh(true); outEl.scrollTop=0;});
    btnOpen.addEventListener('click',()=>{ const gcp=(gcpEl.value||'iptv-bfa-471617').trim(); btnOpen.href=`https://shell.cloud.google.com/?project=${encodeURIComponent(gcp)}`; });
    [daysEl,fbEl,gcpEl].forEach(el=>el.addEventListener('input',()=>refresh(outEl.style.display==='block')));
    refresh(false);
  })();

  /* ===== Delete Users: Direct function call ===== */
  (function(){
    const urlEl=$('#purgeUrl'), keyEl=$('#purgeKey'), daysEl=$('#purgeDays2'), out=$('#purgeOut');
    urlEl.value = localStorage.getItem('purge_url') || '';
    keyEl.value = localStorage.getItem('purge_key') || '';
    function save(){ localStorage.setItem('purge_url', urlEl.value.trim()); localStorage.setItem('purge_key', keyEl.value); }
    urlEl.addEventListener('input',save); keyEl.addEventListener('input',save);

    async function call(dry){
      const url=(urlEl.value||'').trim(); const key=keyEl.value||''; const days=Math.max(0,parseInt(daysEl.value||'0',10))||0;
      if(!url || !key){ out.textContent='Enter function URL and secret key.'; return; }
      out.textContent='Running...';
      try{
        const qp = new URL(url); qp.searchParams.set('days', String(days)); if (dry) qp.searchParams.set('dry','1');
        const resp = await fetch(qp.toString(), { headers: { 'x-api-key': key }});
        const j = await resp.json();
        out.textContent = JSON.stringify(j, null, 2);
      }catch(e){
        out.textContent = 'Error: '+(e?.message||String(e));
      }
    }
    $('#btnDirectDry').addEventListener('click',()=>call(true));
    $('#btnDirectGo').addEventListener('click',()=>call(false));
  })();

  // Initial loads
  refreshExplorer();
  refreshPRs();
</script>
</body>
</html>
