<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
<title>BFA IPTV — Settings</title>

<!-- PWA (optional) -->
<link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
<meta name="theme-color" content="#ffffff"/>
<link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
<link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

<style>
  /* =========================================================
     Tokens (light default) + dark override (same as Schedule)
  ========================================================= */
  :root{
    --accent:#ff9500;
    --fg:#111; --muted:#6e6e73; --bg:#ffffff;
    --panel:#fff; --tile:#f6f6f8; --tileHover:#fff7ea;
    --border:rgba(0,0,0,.14); --borderStrong:rgba(0,0,0,.28);
    --shadow:0 14px 36px rgba(0,0,0,.08);
  }
  body.dark{
    --bg:#0b0b0c; --fg:#f7f7f8; --muted:#a1a1a8;
    --panel:#151517; --tile:#1a1a1d; --tileHover:#221e18;
    --border:rgba(255,255,255,.16); --borderStrong:rgba(255,255,255,.36);
    --shadow:0 18px 48px rgba(0,0,0,.45);
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
  a{color:inherit;text-decoration:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  /* =========================================================
     Topbar (shared — identical to Schedule)
  ========================================================= */
  .topbar{position:sticky;top:0;z-index:100;background:var(--panel);
    border-bottom:1px solid var(--border);
    padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px}
  .toprow{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px;position:relative}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:#fff center/cover no-repeat}
  .logotxt{font-weight:900;letter-spacing:.2px}

  .nav{display:flex;gap:10px;margin-left:auto;margin-right:auto}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:9999px;border:1px solid transparent;background:transparent;color:inherit;font-weight:800;font-size:14px;line-height:1;white-space:nowrap}
  .pill:hover{border-color:var(--accent)}
  .pill.is-active{outline:2px solid var(--accent)}
  .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}

  /* More (+) dropdown */
  .more{position:relative}
  #moreBtn .plus{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
  #moreMenu{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;min-width:230px;background:var(--panel);
    border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none}
  #moreMenu.open{display:block}
  #moreMenu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px}
  #moreMenu a:hover{background:var(--tileHover)}
  #moreMenu a.is-active{outline:2px solid var(--accent)}
  #moreMenu .ic{width:18px;height:18px;stroke-width:1.9}

  /* Actions */
  .actions{display:flex;gap:8px;align-items:center}
  .email{max-width:240px;padding:6px 10px;border-radius:9999px;background:var(--tile);
    border:1.5px solid var(--borderStrong);color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .chip{height:34px;min-width:34px;padding:0 12px;border-radius:9999px;border:1.5px solid var(--borderStrong);
    background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .chip:hover{border-color:var(--accent)}
  .chip .ic{width:18px;height:18px;stroke-width:2}
  .chip.accent{background:transparent;border-color:var(--accent);color:var(--accent)}
  /* Hamburger (orange lines, no border, centered) */
  #hamburger{display:none;border:0;background:transparent;color:var(--accent);height:42px;min-width:42px;padding:0;align-items:center;justify-content:center;position:absolute;right:0;top:50%;transform:translateY(-50%)}
  #hamburger .ic{width:22px;height:22px;stroke:var(--accent);stroke-width:2.35}

  @media (max-width:920px){
    .nav{display:none}
    #hamburger{display:inline-flex}
    .email{display:none}
  }

  /* Mobile sheet */
  #sheet{position:fixed;inset:0;z-index:120;display:none}
  #sheet.open{display:block}
  #sheet .back{position:absolute;inset:0;background:rgba(0,0,0,.28)}
  .panel{position:absolute;right:0;top:0;height:100%;width:min(86vw,360px);background:var(--panel);border-left:1px solid var(--border);
    box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:14px}
  .panel .row{display:flex;align-items:center;justify-content:space-between}
  .panel nav{display:grid;gap:8px}
  .panel nav a{justify-content:flex-start}

  /* =========================================================
     Page UI
  ========================================================= */
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
  .muted{color:var(--muted);font-size:12px}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .input, textarea, select{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
  textarea{min-height:120px;resize:vertical}
  .btn{height:34px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center}
  .btn.solid{background:var(--accent);border-color:var(--accent);color:#000}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0}
  @media (max-width:720px){.row2,.row3{grid-template-columns:1fr}}
  .stat{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--tile)}

  /* Toast */
  .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <!-- ===== NAVBAR ===== -->
  <header class="topbar">
    <div class="toprow">
      <a class="brand" href="home.html"><span class="logo" id="brandLogo"></span><span class="logotxt">BFA IPTV</span></a>

      <nav class="nav" aria-label="Primary">
        <a class="pill" href="home.html" data-page="home">
          <svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home
        </a>
        <a class="pill" href="dealerships.html" data-page="dealerships">
          <svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships
        </a>
        <a class="pill" href="displays.html" data-page="displays">
          <svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays
        </a>
        <a class="pill" href="users.html" data-page="users">
          <svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users
        </a>
        <div class="more">
          <a id="moreBtn" class="pill" href="javascript:void(0)">
            <svg class="plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg> More
          </a>
          <div id="moreMenu" role="menu" aria-label="More">
            <a href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
            <a href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
            <a href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
            <a href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
            <a href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
            <a class="is-active" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
          </div>
        </div>
      </nav>

      <div class="actions">
        <span id="adminEmail" class="email"></span>
        <button id="themeBtn" class="chip" title="Light/Dark">
          <svg id="themeIcon" class="ic" viewBox="0 0 24 24"></svg>
          Theme
        </button>
        <button id="signOutBtn" class="chip">Sign out</button>
        <button id="hamburger" class="chip" aria-label="Menu">
          <svg class="ic" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        </button>
      </div>
    </div>

    <!-- Mobile sheet -->
    <div id="sheet" aria-hidden="true">
      <div class="back"></div>
      <aside class="panel" role="dialog" aria-modal="true" aria-label="Menu">
        <div class="row">
          <div class="brand"><span class="logo" id="brandLogoM"></span><span class="logotxt">BFA IPTV</span></div>
          <button id="closeSheet" class="chip" aria-label="Close"><svg class="ic" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
        </div>
        <nav>
          <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
          <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
          <a class="pill" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
          <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
          <div class="muted" style="padding:8px 2px 0">More</div>
          <a class="pill" href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
          <a class="pill" href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
          <a class="pill" href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
          <a class="pill" href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
          <a class="pill" href="remote-control.html"><svg class="ic" viewBox="0 0 24 24"><rect x="7" y="3" width="10" height="18" rx="3"/><circle cx="12" cy="8" r="2"/><path d="M9 13h6"/></svg> Remote</a>
          <a class="pill is-active" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
          <button id="signOutBtnM" class="chip" style="margin-top:8px">Sign out</button>
        </nav>
      </aside>
    </div>
  </header>

  <!-- =========================================================
       SETTINGS CONTENT
  ========================================================= -->
  <div class="wrap">
    <!-- Overview -->
    <div class="card" style="margin-bottom:12px">
      <h2 style="margin:0 0 8px">Overview</h2>
      <div class="row3">
        <div class="stat"><b>Firebase Project:</b> <span id="ov-fb-project" class="mono" style="margin-left:6px">iptv-bfa</span></div>
        <div class="stat"><b>Auth User:</b> <span id="ov-user" class="mono" style="margin-left:6px">—</span></div>
        <div class="stat"><b>Role:</b> <span id="ov-role" class="mono" style="margin-left:6px">—</span></div>
      </div>
      <div class="row3" style="margin-top:8px">
        <div class="stat"><b>Displays (RTDB):</b> <span id="ov-displays" class="mono" style="margin-left:6px">—</span></div>
        <div class="stat"><b>Dealers (RTDB):</b> <span id="ov-dealers" class="mono" style="margin-left:6px">—</span></div>
        <div class="stat"><b>GitHub Account:</b> <span id="ov-gh" class="mono" style="margin-left:6px">—</span></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="btn-refresh-overview" class="btn">Refresh Overview</button>
        <button id="btn-ping" class="btn">Ping Functions</button>
      </div>
      <div class="muted" style="margin-top:6px">Counts read from Realtime Database.</div>
    </div>

    <!-- Quick preferences -->
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px">Quick Preferences</h3>
      <div class="row3">
        <div><div class="label">Displays collection (optional)</div><input id="inp-displays-col" class="input" value="displays"/></div>
        <div><div class="label">Dealers collection (optional)</div><input id="inp-dealers-col" class="input" value="dealers"/></div>
        <div><div class="label">Functions region</div><input id="inp-functions-region" class="input" value="us-central1"/></div>
      </div>
      <div style="margin-top:10px"><button id="btn-save-preferences" class="btn solid">Save Preferences</button></div>
      <div class="muted" style="margin-top:6px">Stored in localStorage.</div>
    </div>

    <!-- GitHub -->
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px">GitHub Settings</h3>
      <div class="row3">
        <div><div class="label">Owner</div><input id="inp-gh-owner" class="input" value="flaviothebfagroup"/></div>
        <div><div class="label">Repo</div><input id="inp-gh-repo" class="input" value="IPTV-"/></div>
        <div><div class="label">Branch</div><input id="inp-gh-branch" class="input" value="main"/></div>
      </div>
      <div class="row2">
        <div><div class="label">Config path</div><input id="inp-gh-path" class="input" value="config/iptv-config.json"/></div>
        <div>
          <div class="label">PAT (masked)</div>
          <input id="inp-gh-token" class="input" type="password" autocomplete="new-password"
                 value="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"/>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button id="btn-gh-save-session" class="btn">Use for this session</button>
        <button id="btn-gh-encrypted-save" class="btn">Encrypt & save locally</button>
        <button id="btn-gh-clear" class="btn">Clear saved</button>
        <button id="btn-gh-test" class="btn solid">Test Token</button>
      </div>
      <div class="row2" style="margin-top:12px">
        <div><div class="label">Token expiry (optional)</div><input id="inp-gh-expiry" type="datetime-local" class="input"/></div>
        <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
          <button id="btn-gh-expiry-save" class="btn">Save expiry</button>
          <button id="btn-gh-expiry-ics" class="btn">Download .ics reminder</button>
          <span id="gh-expiry-info" class="mono" style="font-size:12px;color:var(--muted)"></span>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">PAT is session-only unless you encrypt & save it with a passphrase (WebCrypto AES-GCM).</div>
    </div>

    <!-- Firebase -->
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px">Firebase Settings</h3>
      <div class="row3">
        <div><div class="label">apiKey</div><input id="fb-apiKey" class="input" value="AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY"/></div>
        <div><div class="label">authDomain</div><input id="fb-authDomain" class="input" value="iptv-bfa.firebaseapp.com"/></div>
        <div><div class="label">databaseURL</div><input id="fb-databaseURL" class="input" value="https://iptv-bfa-default-rtdb.firebaseio.com"/></div>
      </div>
      <div class="row3">
        <div><div class="label">projectId</div><input id="fb-projectId" class="input" value="iptv-bfa"/></div>
        <div><div class="label">storageBucket</div><input id="fb-storageBucket" class="input" value="iptv-bfa.firebasestorage.app"/></div>
        <div><div class="label">messagingSenderId</div><input id="fb-msgId" class="input" value="838790935867"/></div>
      </div>
      <div class="row2">
        <div><div class="label">appId</div><input id="fb-appId" class="input" value="1:838790935867:web:1860eac7dbeb7159e1b31e"/></div>
        <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
          <button id="btn-fb-save" class="btn solid">Save & Init</button>
          <button id="btn-fb-test" class="btn">Test Firebase</button>
          <button id="btn-fb-logout" class="btn">Sign out</button>
        </div>
      </div>
      <div class="muted">Saved in localStorage as <span class="mono">firebaseConfig</span>. Tests write/read a small ping in RTDB.</div>
    </div>

    <!-- Purge anonymous -->
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px">Purge Anonymous Logins</h3>
      <div class="row2">
        <div><div class="label">Delete anon users older than (days)</div><input id="inp-anon-days" class="input" value="30"/></div>
        <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
          <button id="btn-purge-anon" class="btn">Run Purge</button>
        </div>
      </div>
      <div class="muted">Calls callable <span class="mono">purgeAnonymousUsers</span> in region <span class="mono">us-central1</span>.</div>
    </div>

    <!-- Backup / Restore of Settings -->
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px">Backup / Restore Settings</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btn-export-settings" class="btn">Export JSON</button>
        <label class="btn" style="cursor:pointer">Import JSON<input id="inp-import-settings" type="file" accept="application/json" style="display:none"></label>
      </div>
      <div class="muted" style="margin-top:6px">Exports GitHub prefs, encrypted token (if any), Firebase config, region, and token expiry.</div>
    </div>

    <!-- Log -->
    <div class="card">
      <h3 style="margin:0 0 8px">Log</h3>
      <textarea id="log" class="input mono" placeholder="Output…"></textarea>
      <div style="margin-top:8px"><button id="btn-log-clear" class="btn">Clear Log</button></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getDatabase, ref as rtdbRef, set as rtdbSet, get as rtdbGet } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
  import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

  /* ===== Hard defaults from you ===== */
  const DEFAULTS = {
    githubOwner: 'flaviothebfagroup',
    githubRepo: 'IPTV-',
    githubBranch: 'main',
    githubPath: 'config/iptv-config.json',
    // PAT is intentionally NOT stored; we just prefill the field
    firebaseConfig: {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    },
    functionsRegion: 'us-central1',
    LOGO_URL: "/IPTV-/icons/icon-512.png"
  };

  /* ===== Storage keys ===== */
  const SKEYS = {
    displaysCol: 'pref_displays_collection',
    dealersCol:  'pref_dealers_collection',
    functionsRegion: 'pref_functions_region',
    githubOwner: 'pref_github_owner',
    githubRepo:  'pref_github_repo',
    githubBranch:'pref_github_branch',
    githubPath:  'pref_github_path',
    ghTokenEnc:  'secure_github_token',
    ghTokenExp:  'github_token_expiry',
    fbConfig:    'firebaseConfig'
  };

  const $ = s => document.querySelector(s);
  function toast(m){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}
  const logEl = $('#log'); function log(msg){ logEl.value += (msg + '\n'); logEl.scrollTop = logEl.scrollHeight; }

  /* ===== Force prefill into localStorage (except PAT) ===== */
  function prefillNow(){
    localStorage.setItem(SKEYS.githubOwner,  DEFAULTS.githubOwner);
    localStorage.setItem(SKEYS.githubRepo,   DEFAULTS.githubRepo);
    localStorage.setItem(SKEYS.githubBranch, DEFAULTS.githubBranch);
    localStorage.setItem(SKEYS.githubPath,   DEFAULTS.githubPath);
    localStorage.setItem(SKEYS.functionsRegion, DEFAULTS.functionsRegion);
    // Optional Firestore names (not required for RTDB)
    if(!localStorage.getItem(SKEYS.displaysCol)) localStorage.setItem(SKEYS.displaysCol, 'displays');
    if(!localStorage.getItem(SKEYS.dealersCol))  localStorage.setItem(SKEYS.dealersCol,  'dealers');
    // Full Firebase config
    localStorage.setItem(SKEYS.fbConfig, JSON.stringify(DEFAULTS.firebaseConfig));
  }

  /* ===== UI load/save ===== */
  function loadPrefs(){
    $('#inp-displays-col').value = localStorage.getItem(SKEYS.displaysCol) || 'displays';
    $('#inp-dealers-col').value  = localStorage.getItem(SKEYS.dealersCol)  || 'dealers';
    $('#inp-functions-region').value = localStorage.getItem(SKEYS.functionsRegion) || 'us-central1';

    $('#inp-gh-owner').value  = localStorage.getItem(SKEYS.githubOwner)  || DEFAULTS.githubOwner;
    $('#inp-gh-repo').value   = localStorage.getItem(SKEYS.githubRepo)   || DEFAULTS.githubRepo;
    $('#inp-gh-branch').value = localStorage.getItem(SKEYS.githubBranch) || DEFAULTS.githubBranch;
    $('#inp-gh-path').value   = localStorage.getItem(SKEYS.githubPath)   || DEFAULTS.githubPath;

    // PAT visible but not stored
    const patField = $('#inp-gh-token');
    patField.setAttribute('autocomplete','new-password');
    // Keep what's in HTML value; do not overwrite

    // Firebase form
    const cfg = JSON.parse(localStorage.getItem(SKEYS.fbConfig) || 'null') || DEFAULTS.firebaseConfig;
    $('#fb-apiKey').value        = cfg.apiKey || '';
    $('#fb-authDomain').value    = cfg.authDomain || '';
    $('#fb-databaseURL').value   = cfg.databaseURL || '';
    $('#fb-projectId').value     = cfg.projectId || '';
    $('#fb-storageBucket').value = cfg.storageBucket || '';
    $('#fb-msgId').value         = cfg.messagingSenderId || '';
    $('#fb-appId').value         = cfg.appId || '';

    updateExpiryInfo();
  }
  function savePrefs(){
    localStorage.setItem(SKEYS.displaysCol, $('#inp-displays-col').value.trim() || 'displays');
    localStorage.setItem(SKEYS.dealersCol,  $('#inp-dealers-col').value.trim()  || 'dealers');
    localStorage.setItem(SKEYS.functionsRegion, $('#inp-functions-region').value.trim() || 'us-central1');

    localStorage.setItem(SKEYS.githubOwner,  $('#inp-gh-owner').value.trim());
    localStorage.setItem(SKEYS.githubRepo,   $('#inp-gh-repo').value.trim());
    localStorage.setItem(SKEYS.githubBranch, $('#inp-gh-branch').value.trim());
    localStorage.setItem(SKEYS.githubPath,   $('#inp-gh-path').value.trim());
    toast('Preferences saved');
  }

  /* ===== WebCrypto for encrypted token save ===== */
  async function deriveKey(passphrase){
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(passphrase), 'PBKDF2', false, ['deriveKey']);
    return crypto.subtle.deriveKey(
      { name:'PBKDF2', salt: enc.encode('bfa-iptv-salt-v1'), iterations:120000, hash:'SHA-256' },
      keyMaterial, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']
    );
  }
  async function encryptToken(token, pass){ const iv = crypto.getRandomValues(new Uint8Array(12)); const key=await deriveKey(pass); const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(token)); return {iv:Array.from(iv),data:Array.from(new Uint8Array(ct))}; }
  async function decryptToken(blob, pass){ const key=await deriveKey(pass); const iv=new Uint8Array(blob.iv); const data=new Uint8Array(blob.data); const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,data); return new TextDecoder().decode(pt); }

  /* ===== GitHub helpers ===== */
  let ghTokenSession = '';
  function ghHeaders(){
    const t = ghTokenSession;
    if(!t) return null;
    return { 'Authorization':'Bearer '+t, 'Accept':'application/vnd.github+json' };
  }
  async function testGitHubToken(){
    const h = ghHeaders(); if(!h){ log('GitHub token missing (session).'); return; }
    try{
      const res = await fetch('https://api.github.com/user', { headers: h });
      const t = await res.json();
      if(res.ok){ $('#ov-gh').textContent = `${t.login} (id ${t.id})`; log('GitHub token OK: '+t.login); }
      else { $('#ov-gh').textContent = 'Bad credentials'; log('GitHub token failed: '+(t.message||res.status)); }
    }catch(e){ log('GitHub test error: '+e.message); }
  }

  /* ===== Firebase init (modular) ===== */
  let app, auth, db, fns;

  function readFirebaseForm(){
    return {
      apiKey: $('#fb-apiKey').value.trim(),
      authDomain: $('#fb-authDomain').value.trim(),
      databaseURL: $('#fb-databaseURL').value.trim(),
      projectId: $('#fb-projectId').value.trim(),
      storageBucket: $('#fb-storageBucket').value.trim(),
      messagingSenderId: $('#fb-msgId').value.trim(),
      appId: $('#fb-appId').value.trim()
    };
  }
  function saveFirebaseConfig(){
    const cfg = readFirebaseForm();
    localStorage.setItem(SKEYS.fbConfig, JSON.stringify(cfg));
    initFirebase(cfg);
    toast('Firebase saved & initialized');
  }
  function initFirebase(cfg){
    try{ if(!cfg) cfg = JSON.parse(localStorage.getItem(SKEYS.fbConfig) || 'null'); }catch(e){}
    if(!cfg || !cfg.apiKey){ log('Firebase config missing.'); return; }

    app = initializeApp(cfg);
    auth = getAuth(app);
    db = getDatabase(app);
    const region = localStorage.getItem(SKEYS.functionsRegion) || 'us-central1';
    fns = getFunctions(app, region);

    setPersistence(auth,browserLocalPersistence);
    onAuthStateChanged(auth, async (u)=>{
      if(!u){ await signInAnonymously(auth).catch(err=>log('Anon sign-in error: '+err.message)); }
      $('#adminEmail').textContent = (auth.currentUser?.email) || auth.currentUser?.uid || '';
      refreshOverview();
    });
  }
  async function testFirebase(){
    if(!db){ log('Firebase not initialized.'); return; }
    try{
      const ts = Date.now();
      await rtdbSet(rtdbRef(db, 'ping'), { time: ts, by: auth.currentUser?.uid || 'unknown' });
      const snap = await rtdbGet(rtdbRef(db, 'ping'));
      log('RTDB OK: '+ JSON.stringify(snap.val()));
    }catch(e){ log('Firebase test failed: '+e.message); }
  }
  async function signOutFirebase(){ try{ await signOut(auth); log('Signed out.'); refreshOverview(); }catch(e){ log('Sign out error: '+e.message); } }

  /* ===== Overview (RTDB counts) ===== */
  async function refreshOverview(){
    // Project id
    try{
      const cfg = JSON.parse(localStorage.getItem(SKEYS.fbConfig) || 'null');
      $('#ov-fb-project').textContent = (cfg && cfg.projectId) ? cfg.projectId : '—';
    }catch(e){}
    // User info
    const u = auth?.currentUser;
    if(u){
      const provider = (u.providerData?.[0]?.providerId) || (u.isAnonymous ? 'anonymous' : 'password');
      $('#ov-user').textContent = (u.email || '(anon)') + ' • uid ' + u.uid + ' • ' + provider;
      try{
        const roleSnap = await rtdbGet(rtdbRef(db, `user/${u.uid}/role`));
        $('#ov-role').textContent = roleSnap.exists() ? roleSnap.val() : '—';
      }catch(_){ $('#ov-role').textContent = '—'; }
    }else{
      $('#ov-user').textContent = '—'; $('#ov-role').textContent = '—';
    }
    // RTDB counts
    try{
      const ds = await rtdbGet(rtdbRef(db, 'displays'));
      const dl = await rtdbGet(rtdbRef(db, 'dealershipPublic'));
      $('#ov-displays').textContent = ds.exists() ? Object.keys(ds.val()).length : 0;
      $('#ov-dealers').textContent  = dl.exists() ? Object.keys(dl.val()).length : 0;
    }catch(_){
      $('#ov-displays').textContent = '—';
      $('#ov-dealers').textContent  = '—';
    }
  }

  /* ===== Ping + Purge ===== */
  async function pingFunctions(){
    try{
      const ping = httpsCallable(fns, 'ping');
      const res = await ping({});
      log('Ping OK: ' + JSON.stringify(res.data));
      return true;
    }catch(e){
      log(`Ping error -> code: ${e.code} | message: ${e.message} | details: ${JSON.stringify(e.details)}`);
      return false;
    }
  }
  async function purgeAnonymous(){
    if(!fns){ log('Functions not initialized.'); return; }
    const ok = await pingFunctions(); if(!ok){ toast('Functions ping failed'); return; }
    const days = parseInt($('#inp-anon-days').value || '30', 10);
    try{
      const callable = httpsCallable(fns, 'purgeAnonymousUsers');
      const res = await callable({ olderThanDays: days });
      log('Purge result: '+ JSON.stringify(res.data));
      toast('Purge requested');
    }catch(e){
      log(`Purge error -> code: ${e.code} | message: ${e.message} | details: ${JSON.stringify(e.details)}`);
      toast('Purge failed (see Log)');
    }
  }

  /* ===== Token expiry helper ===== */
  function updateExpiryInfo(){
    const iso = localStorage.getItem(SKEYS.ghTokenExp);
    const el = $('#gh-expiry-info');
    if(!iso){ el.textContent = 'No expiry set.'; return; }
    const now = new Date(), dt = new Date(iso);
    const days = Math.ceil((dt - now) / (1000*60*60*24));
    el.textContent = (days>=0)? `${days} day(s) left • ${dt}` : `Expired ${-days} day(s) ago • ${dt}`;
  }
  function saveExpiry(){
    const v = $('#inp-gh-expiry').value;
    if(!v){ localStorage.removeItem(SKEYS.ghTokenExp); updateExpiryInfo(); toast('Removed'); return; }
    localStorage.setItem(SKEYS.ghTokenExp, new Date(v).toISOString());
    updateExpiryInfo(); toast('Expiry saved');
  }
  function downloadICS(){
    const iso = localStorage.getItem(SKEYS.ghTokenExp);
    if(!iso){ toast('Set an expiry first'); return; }
    const dt = new Date(iso);
    const uid = 'bfa-iptv-gh-token-'+dt.getTime()+'@settings';
    const stamp = d => d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
    const ics = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//BFA IPTV//Settings//EN',
      'BEGIN:VEVENT','UID:'+uid,'DTSTAMP:'+stamp(new Date()),
      'DTSTART:'+stamp(dt),'DTEND:'+stamp(new Date(dt.getTime()+30*60*1000)),
      'SUMMARY:Rotate GitHub Token','DESCRIPTION:Update the GitHub PAT used by BFA IPTV.',
      'END:VEVENT','END:VCALENDAR'
    ].join('\r\n');
    const blob = new Blob([ics], {type:'text/calendar'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='github-token-reminder.ics';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  /* ===== Backup / Restore (Settings JSON) ===== */
  function exportSettings(){
    const out = {
      [SKEYS.displaysCol]: localStorage.getItem(SKEYS.displaysCol),
      [SKEYS.dealersCol]: localStorage.getItem(SKEYS.dealersCol),
      [SKEYS.functionsRegion]: localStorage.getItem(SKEYS.functionsRegion),
      [SKEYS.githubOwner]: localStorage.getItem(SKEYS.githubOwner),
      [SKEYS.githubRepo]: localStorage.getItem(SKEYS.githubRepo),
      [SKEYS.githubBranch]: localStorage.getItem(SKEYS.githubBranch),
      [SKEYS.githubPath]: localStorage.getItem(SKEYS.githubPath),
      [SKEYS.ghTokenExp]: localStorage.getItem(SKEYS.ghTokenExp) || '',
      [SKEYS.fbConfig]: localStorage.getItem(SKEYS.fbConfig) || '',
      [SKEYS.ghTokenEnc]: localStorage.getItem(SKEYS.ghTokenEnc) || ''
    };
    const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'bfa-iptv-settings.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function importSettings(file){
    const r = new FileReader();
    r.onload = () => {
      try{
        const json = JSON.parse(r.result);
        Object.keys(json).forEach(k => localStorage.setItem(k, json[k]));
        loadPrefs(); initFirebase(); toast('Settings imported');
      }catch(e){ toast('Invalid JSON'); }
    };
    r.readAsText(file);
  }

  /* ===== Navbar / Theme behaviors (identical to Schedule) ===== */
  const LOGO_URL = DEFAULTS.LOGO_URL;
  $('#brandLogo').style.backgroundImage=`url("${LOGO_URL}")`;
  const brandLogoM=document.getElementById('brandLogoM'); if(brandLogoM){ brandLogoM.style.backgroundImage=`url("${LOGO_URL}")`; }

  const THEME_KEY='iptv_theme';
  const themeBtn=document.getElementById('themeBtn');
  const themeIcon=document.getElementById('themeIcon');
  const setThemeIcon=()=>{
    const dark=document.body.classList.contains('dark');
    themeIcon.innerHTML = dark
      ? `<path d="M21 12a9 9 0 1 1-9-9 6 6 0 0 0 9 9z"/>`
      : `<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M5 19l-1.4 1.4M20.4 3.6 19 5"/>`;
  };
  const saved=localStorage.getItem(THEME_KEY)||'light';
  document.body.classList.toggle('dark', saved==='dark');
  setThemeIcon();
  themeBtn.addEventListener('click', ()=>{
    const toDark=!document.body.classList.contains('dark');
    document.body.classList.toggle('dark', toDark);
    localStorage.setItem(THEME_KEY, toDark?'dark':'light');
    setThemeIcon();
  });

  const moreBtn=document.getElementById('moreBtn');
  const moreMenu=document.getElementById('moreMenu');
  if(moreBtn){
    moreBtn.addEventListener('click',(e)=>{ e.preventDefault(); moreMenu.classList.toggle('open');});
    document.addEventListener('click',(e)=>{ if(!moreMenu.contains(e.target) && e.target!==moreBtn && !moreBtn.contains(e.target)){ moreMenu.classList.remove('open'); } },{capture:true});
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') moreMenu.classList.remove('open'); });
    const file=(location.pathname.split("/").pop()||"settings.html").toLowerCase();
    moreMenu.querySelectorAll('a').forEach(a=>{ const h=(a.getAttribute('href')||'').toLowerCase(); if(h===file){ a.classList.add('is-active'); }});
  }

  (()=>{
    const sheet=document.getElementById('sheet');
    const open=()=>{ sheet.classList.add('open'); document.body.style.overflow='hidden'; };
    const close=()=>{ sheet.classList.remove('open'); document.body.style.overflow=''; };
    document.getElementById('hamburger').addEventListener('click', open);
    document.getElementById('closeSheet').addEventListener('click', close);
    sheet.querySelector('.back').addEventListener('click', close);
    const mainOut=document.getElementById('signOutBtn');
    const mobOut=document.getElementById('signOutBtnM');
    if(mainOut && mobOut){ mobOut.addEventListener('click', ()=> mainOut.click()); }
  })();

  /* ===== Buttons & bootstrap ===== */
  prefillNow();
  loadPrefs();
  initFirebase();

  document.getElementById('signOutBtn').addEventListener('click',()=>signOut(getAuth()).catch(()=>{}));
  onAuthStateChanged(getAuth(), u=>{
    if(!u){ /* optional redirect */ }
    document.getElementById('adminEmail').textContent=u?.email || u?.uid || '';
  });

  // Save prefs
  document.getElementById('btn-save-preferences').addEventListener('click', savePrefs);

  // GitHub token flow
  document.getElementById('btn-gh-save-session').addEventListener('click', ()=>{
    const v = document.getElementById('inp-gh-token').value.trim(); if(!v) return toast('Enter a token first');
    ghTokenSession = v; toast('Token set for session');
  });
  document.getElementById('btn-gh-encrypted-save').addEventListener('click', async ()=>{
    const token = document.getElementById('inp-gh-token').value.trim(); if(!token) return toast('Enter a token first');
    const pass = prompt('Set a passphrase to encrypt your token (store it safely):'); if(!pass) return;
    try{ const blob = await encryptToken(token, pass); localStorage.setItem(SKEYS.ghTokenEnc, JSON.stringify(blob)); toast('Encrypted token saved'); }
    catch(e){ toast('Encrypt failed'); }
  });
  document.getElementById('btn-gh-clear').addEventListener('click', ()=>{ localStorage.removeItem(SKEYS.ghTokenEnc); toast('Saved token cleared'); });
  document.getElementById('btn-gh-test').addEventListener('click', async ()=>{
    if(!ghTokenSession){
      const blob = localStorage.getItem(SKEYS.ghTokenEnc);
      if(blob){
        const pass = prompt('Enter passphrase to unlock saved token:');
        if(pass){ try{ ghTokenSession = await decryptToken(JSON.parse(blob), pass); } catch(e){ log('Decrypt failed: '+e.message); return; } }
      } else {
        const field = document.getElementById('inp-gh-token').value.trim(); if(field) ghTokenSession = field;
      }
    }
    await testGitHubToken();
  });

  // Expiry
  document.getElementById('btn-gh-expiry-save').addEventListener('click', saveExpiry);
  document.getElementById('btn-gh-expiry-ics').addEventListener('click', downloadICS);

  // Firebase
  document.getElementById('btn-fb-save').addEventListener('click', saveFirebaseConfig);
  document.getElementById('btn-fb-test').addEventListener('click', testFirebase);
  document.getElementById('btn-fb-logout').addEventListener('click', signOutFirebase);

  // Purge & Ping
  document.getElementById('btn-ping').addEventListener('click', pingFunctions);
  document.getElementById('btn-purge-anon').addEventListener('click', purgeAnonymous);

  // Overview + Log
  document.getElementById('btn-refresh-overview').addEventListener('click', refreshOverview);
  document.getElementById('btn-log-clear').addEventListener('click', ()=>{ logEl.value=''; });

  // Settings backup/restore
  document.getElementById('btn-export-settings').addEventListener('click', exportSettings);
  document.getElementById('inp-import-settings').addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) importSettings(e.target.files[0]); });

  // Keep prefs in sync on edits
  ['inp-gh-owner','inp-gh-repo','inp-gh-branch','inp-gh-path'].forEach(id=>document.getElementById(id).addEventListener('change', savePrefs));
</script>
</body>
</html>
