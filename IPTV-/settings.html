<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
<title>BFA IPTV — Settings</title>

<link rel="manifest" href="/IPTV-/manifest.webmanifest"/>
<meta name="theme-color" content="#ffffff"/>
<link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png"/>
<link rel="apple-touch-icon" href="/IPTV-/icons/icon-192.png"/>

<style>
  :root{
    --accent:#ff9500;
    --fg:#111; --muted:#6e6e73; --bg:#ffffff;
    --panel:#fff; --tile:#f6f6f8; --tileHover:#fff7ea;
    --border:rgba(0,0,0,.14); --borderStrong:rgba(0,0,0,.28);
    --shadow:0 14px 36px rgba(0,0,0,.08);
  }
  body.dark{
    --bg:#0b0b0c; --fg:#f7f7f8; --muted:#a1a1a8;
    --panel:#151517; --tile:#1a1a1d; --tileHover:#221e18;
    --border:rgba(255,255,255,.16); --borderStrong:rgba(255,255,255,.36);
    --shadow:0 18px 48px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
  a{color:inherit;text-decoration:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}

  /* ===== NAV (same as your other pages) ===== */
  .topbar{position:sticky;top:0;z-index:100;background:var(--panel);
    border-bottom:1px solid var(--border);
    padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px}
  .toprow{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px;position:relative}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:#fff center/cover no-repeat}
  .logotxt{font-weight:900;letter-spacing:.2px}
  .nav{display:flex;gap:10px;margin-left:auto;margin-right:auto}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:9999px;border:1px solid transparent;background:transparent;color:inherit;font-weight:800;font-size:14px}
  .pill:hover{border-color:var(--accent)}
  .pill.is-active{outline:2px solid var(--accent)}
  .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}
  .more{position:relative}
  #moreBtn .plus{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
  #moreMenu{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;min-width:230px;background:var(--panel);
    border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none}
  #moreMenu.open{display:block}
  #moreMenu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px}
  #moreMenu a:hover{background:var(--tileHover)}
  #moreMenu a.is-active{outline:2px solid var(--accent)}
  #moreMenu .ic{width:18px;height:18px;stroke-width:1.9}
  .actions{display:flex;gap:8px;align-items:center}
  .email{max-width:240px;padding:6px 10px;border-radius:9999px;background:var(--tile);
    border:1.5px solid var(--borderStrong);color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .chip{height:34px;min-width:34px;padding:0 12px;border-radius:9999px;border:1.5px solid var(--borderStrong);
    background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .chip:hover{border-color:var(--accent)}
  .chip .ic{width:18px;height:18px;stroke-width:2}
  .chip.accent{background:transparent;border-color:var(--accent);color:var(--accent)}
  #hamburger{display:none;border:0;background:transparent;color:var(--accent);height:42px;min-width:42px;padding:0;align-items:center;justify-content:center;position:absolute;right:0;top:50%;transform:translateY(-50%)}
  #hamburger .ic{width:22px;height:22px;stroke:var(--accent);stroke-width:2.35}
  @media (max-width:920px){.nav{display:none} #hamburger{display:inline-flex} .email{display:none}}

  #sheet{position:fixed;inset:0;z-index:120;display:none}
  #sheet.open{display:block}
  #sheet .back{position:absolute;inset:0;background:rgba(0,0,0,.28)}
  .panel{position:absolute;right:0;top:0;height:100%;width:min(86vw,360px);background:var(--panel);border-left:1px solid var(--border);
    box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:14px}
  .panel .row{display:flex;align-items:center;justify-content:space-between}
  .panel nav{display:grid;gap:8px}
  .panel nav a{justify-content:flex-start}

  /* ===== Page ===== */
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px}
  .muted{color:var(--muted);font-size:12px}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .input,textarea{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
  textarea{min-height:120px;resize:vertical}
  .btn{height:34px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center}
  .btn.solid{background:var(--accent);border-color:var(--accent);color:#000}
  .btn.danger{border-color:#ff6b6b;color:#ff6b6b;background:transparent}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0}
  @media (max-width:720px){.row2,.row3{grid-template-columns:1fr}}
  .tabs{display:flex;gap:8px;margin-top:10px;margin-bottom:8px}
  .tab{padding:6px 10px;border:1px solid var(--border);border-radius:9999px;cursor:pointer;font-weight:800}
  .tab.active{border-color:var(--accent)}
  .hide{display:none}
  .toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
  .toast.show{opacity:1}

  /* Small additions for GitHub manager table */
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .tr{display:grid;grid-template-columns:28px 1fr auto auto;gap:8px;align-items:center;background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:8px}
  .tr .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:transparent;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header class="topbar">
  <div class="toprow">
    <a class="brand" href="home.html"><span class="logo" id="brandLogo"></span><span class="logotxt">BFA IPTV</span></a>
    <nav class="nav" aria-label="Primary">
      <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
      <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
      <a class="pill" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
      <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
      <div class="more">
        <a id="moreBtn" class="pill" href="javascript:void(0)"><svg class="plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg> More</a>
        <div id="moreMenu" role="menu" aria-label="More">
          <a href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
          <a href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
          <a href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
          <a href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
          <a class="is-active" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
        </div>
      </div>
    </nav>
    <div class="actions">
      <span id="adminEmail" class="email"></span>
      <button id="themeBtn" class="chip" title="Light/Dark"><svg id="themeIcon" class="ic" viewBox="0 0 24 24"></svg>Theme</button>
      <button id="signOutBtn" class="chip">Sign out</button>
      <button id="hamburger" class="chip" aria-label="Menu"><svg class="ic" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg></button>
    </div>
  </div>
  <div id="sheet" aria-hidden="true">
    <div class="back"></div>
    <aside class="panel" role="dialog" aria-modal="true" aria-label="Menu">
      <div class="row">
        <div class="brand"><span class="logo" id="brandLogoM"></span><span class="logotxt">BFA IPTV</span></div>
        <button id="closeSheet" class="chip" aria-label="Close"><svg class="ic" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
      </div>
      <nav>
        <a class="pill" href="home.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
        <a class="pill" href="dealerships.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
        <a class="pill" href="displays.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
        <a class="pill" href="users.html"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
        <div class="muted" style="padding:8px 2px 0">More</div>
        <a class="pill" href="links.html"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
        <a class="pill" href="analytics.html"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
        <a class="pill" href="schedule.html"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
        <a class="pill" href="backups.html"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
        <a class="pill is-active" href="settings.html"><svg class="ic" viewBox="0 0 24 24"><path d="M4 7h10"/><circle cx="16" cy="7" r="2"/><path d="M20 17H10"/><circle cx="8" cy="17" r="2"/></svg> Settings</a>
        <button id="signOutBtnM" class="chip" style="margin-top:8px">Sign out</button>
      </nav>
    </aside>
  </div>
</header>

<div class="wrap">
  <!-- ===== Central Config Source (your original) ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">Central Config Source</h3>
    <div class="muted" style="margin-bottom:8px">
      Point <b>all pages</b> to 1 JSON file in your repo. Update it once, all pages use it.
      (Never store your GitHub token in the browser — keep secrets out of this JSON.)
    </div>
    <div class="row3">
      <div><div class="label">Owner</div><input id="ghOwner" class="input" value="flaviothebfagroup"/></div>
      <div><div class="label">Repo</div><input id="ghRepo" class="input" value="IPTV-"/></div>
      <div><div class="label">Branch</div><input id="ghBranch" class="input" value="main"/></div>
    </div>
    <div class="row2">
      <div><div class="label">Path (in repo)</div><input id="ghPath" class="input" value="config/iptv-config.json"/></div>
      <div><div class="label">Raw URL (auto)</div><input id="rawUrl" class="input mono" readonly/></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button id="btnOpenFile" class="btn">Open in GitHub</button>
      <button id="btnOpenEditor" class="btn">Open GitHub Editor</button>
      <button id="btnLoadConfig" class="btn">View current JSON</button>
      <button id="btnCopyLoader" class="btn solid">Copy loader snippet (use on all pages)</button>
    </div>
    <textarea id="cfgView" class="input mono" style="margin-top:10px;display:none;height:240px" spellcheck="false"></textarea>

    <div class="muted" style="margin-top:10px">Suggested JSON (copy into <span class="mono">config/iptv-config.json</span>):</div>
    <textarea class="input mono" readonly style="margin-top:6px;height:180px" spellcheck="false">
{
  "firebaseConfig": {
    "apiKey": "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
    "authDomain": "iptv-bfa.firebaseapp.com",
    "databaseURL": "https://iptv-bfa-default-rtdb.firebaseio.com",
    "projectId": "iptv-bfa",
    "storageBucket": "iptv-bfa.firebasestorage.app",
    "messagingSenderId": "838790935867",
    "appId": "1:838790935867:web:1860eac7dbeb7159e1b31e"
  },
  "github": {
    "owner": "flaviothebfagroup",
    "repo": "IPTV-",
    "branch": "main",
    "configPath": "config/iptv-config.json"
  }
}
    </textarea>
  </div>

  <!-- ===== NEW: GitHub Connection (token saved locally) ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">GitHub Connection</h3>
    <div class="row3">
      <div><div class="label">Owner</div><input id="ghcOwner" class="input" placeholder="flaviothebfagroup"/></div>
      <div><div class="label">Repo</div><input id="ghcRepo" class="input" placeholder="IPTV-"/></div>
      <div><div class="label">Branch</div><input id="ghcBranch" class="input" placeholder="main" value="main"/></div>
    </div>
    <div class="row2">
      <div><div class="label">Token</div><input id="ghcToken" class="input" placeholder="••••••••" type="password"/></div>
      <div style="display:flex;gap:8px;align-items:end">
        <button id="ghSave" class="btn solid">Save</button>
        <button id="ghClear" class="btn">Clear</button>
        <button id="ghTest" class="btn">Test</button>
      </div>
    </div>
    <div id="ghStatus" class="small mono muted" style="margin-top:6px"></div>
  </div>

  <!-- ===== Firebase Overview (yours) ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">Firebase Overview</h3>
    <div class="row3">
      <div><div class="label">Project ID</div><input class="input mono" value="iptv-bfa" readonly/></div>
      <div><div class="label">Realtime DB</div><input class="input mono" value="https://iptv-bfa-default-rtdb.firebaseio.com" readonly/></div>
      <div><div class="label">Auth user (signed-in)</div><input id="whoami" class="input mono" readonly/></div>
    </div>
  </div>

  <!-- ===== NEW: Displays folder manager ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">Displays Folder</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="filesRefresh" class="btn">Refresh</button>
      <button id="filesDelete" class="btn danger">Delete selected</button>
      <button id="filesCreate" class="btn">Create player…</button>
      <label class="badge"><input id="showOrphansOnly" type="checkbox"> Orphans only</label>
      <span class="muted">Orphan = on GitHub but not in Firebase <code>/displays</code></span>
    </div>
    <div id="filesTable"></div>
  </div>

  <!-- ===== NEW: Pull Requests ===== -->
  <div class="card">
    <h3 style="margin:0 0 8px">Open Pull Requests</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="prRefresh" class="btn">Refresh PRs</button>
    </div>
    <div id="prList"></div>
  </div>

  <!-- ===== Delete Anonymous Users (your original) ===== -->
  <div class="card" id="purgeCard">
    <h3 style="margin:0 0 8px">Delete Anonymous Users</h3>
    <div class="muted">Two ways: <b>Cloud Shell (no deploy)</b> or <b>Direct (optional)</b>.</div>

    <div class="tabs">
      <button class="tab active" data-tab="shell">Cloud Shell (no deploy)</button>
      <button class="tab" data-tab="direct">Direct (optional)</button>
    </div>

    <!-- Cloud Shell tab -->
    <div id="tab-shell">
      <div class="row3">
        <div><div class="label">Keep last N days (0 = ALL)</div><input id="purgeDays" class="input" type="number" min="0" step="1" value="0"/></div>
        <div><div class="label">Firebase projectId</div><input id="purgeFbProject" class="input" value="iptv-bfa"/></div>
        <div><div class="label">GCP project ID (console header)</div><input id="purgeGcpProject" class="input" value="iptv-bfa-471617"/></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="btnPurgeCopy" class="btn solid">Copy Cloud Shell commands</button>
        <a id="btnPurgeOpenShell" class="btn" target="_blank" rel="noopener">Open Cloud Shell</a>
        <button id="btnPurgeShow" class="btn">Show commands</button>
      </div>
      <textarea id="purgeCmd" class="input mono" style="margin-top:10px;display:none;height:260px" spellcheck="false"></textarea>
    </div>

    <!-- Direct tab (optional, needs function) -->
    <div id="tab-direct" class="hide">
      <div class="row3">
        <div><div class="label">Function URL (https…/purgeAnonHttp)</div><input id="purgeUrl" class="input" placeholder="https://us-central1-iptv-bfa.cloudfunctions.net/purgeAnonHttp"></div>
        <div><div class="label">Secret key</div><input id="purgeKey" class="input" placeholder="Only stored in this browser"></div>
        <div><div class="label">Keep last N days (0 = ALL)</div><input id="purgeDays2" class="input" type="number" min="0" step="1" value="0"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="btnDirectDry" class="btn">Dry run</button>
        <button id="btnDirectGo" class="btn solid">Run purge</button>
      </div>
      <pre id="purgeOut" class="mono" style="margin-top:10px;background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:12px;white-space:pre-wrap"></pre>
      <div class="muted" style="margin-top:6px">URL/key are saved only in this browser (localStorage).</div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};
  const LOGO_URL="/IPTV-/icons/icon-512.png";
  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getDatabase(app);

  const $=s=>document.querySelector(s);
  function toast(m){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}
  const mono = s => `<span class="mono">${s}</span>`;

  // Logo + Theme
  $('#brandLogo').style.backgroundImage=`url("${LOGO_URL}")`;
  const brandLogoM=document.getElementById('brandLogoM'); if(brandLogoM){ brandLogoM.style.backgroundImage=`url("${LOGO_URL}")`; }
  const THEME_KEY='iptv_theme';
  (function(){
    const themeBtn=$('#themeBtn'), themeIcon=$('#themeIcon');
    const saved=localStorage.getItem(THEME_KEY)||'light';
    document.body.classList.toggle('dark', saved==='dark');
    const setIcon=()=>{ const dark=document.body.classList.contains('dark');
      themeIcon.innerHTML = dark? `<path d="M21 12a9 9 0 1 1-9-9 6 6 0 0 0 9 9z"/>`
        : `<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M5 19l-1.4 1.4M20.4 3.6 19 5"/>`; };
    setIcon();
    themeBtn.addEventListener('click',()=>{const d=!document.body.classList.contains('dark');document.body.classList.toggle('dark',d);localStorage.setItem(THEME_KEY,d?'dark':'light');setIcon();});
  })();

  // More dropdown + mobile sheet
  (function(){
    const moreBtn=$('#moreBtn'), moreMenu=$('#moreMenu');
    if(moreBtn){
      moreBtn.addEventListener('click',(e)=>{e.preventDefault();moreMenu.classList.toggle('open');});
      document.addEventListener('click',(e)=>{ if(!moreMenu.contains(e.target) && e.target!==moreBtn && !moreBtn.contains(e.target)) moreMenu.classList.remove('open'); },{capture:true});
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') moreMenu.classList.remove('open'); });
      const file=(location.pathname.split("/").pop()||"settings.html").toLowerCase();
      moreMenu.querySelectorAll('a').forEach(a=>{ const h=(a.getAttribute('href')||'').toLowerCase(); if(h===file){ a.classList.add('is-active'); }});
    }
    const sheet=$('#sheet');
    const open=()=>{sheet.classList.add('open');document.body.style.overflow='hidden';};
    const close=()=>{sheet.classList.remove('open');document.body.style.overflow='';};
    $('#hamburger').addEventListener('click',open);
    $('#closeSheet').addEventListener('click',close);
    sheet.querySelector('.back').addEventListener('click',close);
    const mainOut=$('#signOutBtn'), mobOut=$('#signOutBtnM'); if(mainOut && mobOut) mobOut.addEventListener('click',()=> mainOut.click());
  })();

  // Auth
  setPersistence(auth,browserLocalPersistence);
  onAuthStateChanged(auth,u=>{
    if(!u){ location.href='./home.html'; return; }
    $('#adminEmail').textContent=u.email||u.uid;
    $('#whoami').value = u.email || u.uid || '(anonymous)';
  });
  $('#signOutBtn').addEventListener('click',()=>signOut(auth));

  /* ===== Central Config helpers (your original) ===== */
  const ghOwner=$('#ghOwner'), ghRepo=$('#ghRepo'), ghBranch=$('#ghBranch'), ghPath=$('#ghPath'), rawUrl=$('#rawUrl');
  function computeRaw(){ return `https://raw.githubusercontent.com/${ghOwner.value.trim()}/${ghRepo.value.trim()}/${ghBranch.value.trim()}/${ghPath.value.trim()}`; }
  function refreshRaw(){ rawUrl.value = computeRaw(); }
  [ghOwner,ghRepo,ghBranch,ghPath].forEach(el=>el.addEventListener('input', refreshRaw));
  refreshRaw();

  $('#btnOpenFile').addEventListener('click',()=>{
    const url=`https://github.com/${ghOwner.value.trim()}/${ghRepo.value.trim()}/blob/${ghBranch.value.trim()}/${ghPath.value.trim()}`;
    window.open(url,'_blank','noopener');
  });
  $('#btnOpenEditor').addEventListener('click',()=>{
    const url=`https://github.com/${ghOwner.value.trim()}/${ghRepo.value.trim()}/edit/${ghBranch.value.trim()}/${ghPath.value.trim()}`;
    window.open(url,'_blank','noopener');
  });
  $('#btnLoadConfig').addEventListener('click', async ()=>{
    const out=$('#cfgView'); out.style.display='block'; out.value='Loading…';
    try{
      const resp=await fetch(computeRaw(),{cache:'no-store'});
      out.value = await resp.text();
    }catch(e){ out.value='Error loading: '+(e?.message||String(e)); }
  });
  $('#btnCopyLoader').addEventListener('click', async ()=>{
    const url=computeRaw();
    const snippet =
`// Load central config once on page load:
const CONFIG_URL = '${url}';
const appConfig = await fetch(CONFIG_URL, {cache:'no-store'}).then(r=>r.json());

// Use across pages:
const firebaseConfig = appConfig.firebaseConfig;
// initializeApp(firebaseConfig);

// Example: get a custom value
// const owner = appConfig.github.owner;`;

    try{ await navigator.clipboard.writeText(snippet); toast('Loader snippet copied'); }
    catch{ const ta=document.createElement('textarea'); ta.value=snippet; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); toast('Loader snippet copied'); }
  });

  /* ===== Purge tabs (your original) ===== */
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const which=btn.dataset.tab;
      $('#tab-shell').classList.toggle('hide', which!=='shell');
      $('#tab-direct').classList.toggle('hide', which!=='direct');
    });
  });

  /* ===== Purge: Cloud Shell helper (your original) ===== */
  (function(){
    const daysEl=$('#purgeDays'), fbEl=$('#purgeFbProject'), gcpEl=$('#purgeGcpProject');
    const outEl=$('#purgeCmd'), btnCopy=$('#btnPurgeCopy'), btnOpen=$('#btnPurgeOpenShell'), btnShow=$('#btnPurgeShow');

    function buildCommands(){
      const DAYS=Math.max(0,parseInt(daysEl.value||'0',10))||0;
      const FB=(fbEl.value||'iptv-bfa').trim();
      const GCP=(gcpEl.value||FB).trim();
      return `gcloud config set project ${GCP}

mkdir -p ~/auth-purge && cd ~/auth-purge
npm init -y >/dev/null 2>&1
npm i firebase-admin@12 >/dev/null 2>&1

cat > purge-anon.js <<'JS'
const admin = require('firebase-admin');
admin.initializeApp({ credential: admin.credential.applicationDefault(), projectId: '${FB}' });
function tms(x){ const n=new Date(x||0).getTime(); return Number.isFinite(n)?n:0; }
const argv=process.argv.slice(2);function arg(n,d){const i=argv.findIndex(a=>a==='--'+n||a.startsWith('--'+n+'='));if(i<0)return d;const v=argv[i].includes('=')?argv[i].split('=')[1]:argv[i+1];return v??d;}
const days=Number(arg('days', ${DAYS}))||0;const dryRun=argv.includes('--dry-run');
(async()=>{const cutoff=Date.now()-days*24*60*60*1000;let scanned=0,kept=0,next;const batch=[];
  console.log('Scanning… days='+days+', cutoff='+new Date(cutoff).toISOString()+', dryRun='+dryRun);
  do{const page=await admin.auth().listUsers(1000,next);
    for(const u of page.users){scanned++;const isAnon=!u.providerData||u.providerData.length===0;if(!isAnon){kept++;continue;}
      const last=Math.max(tms(u.metadata.lastSignInTime),tms(u.metadata.creationTime)); if(last<cutoff) batch.push(u.uid); else kept++; }
    next=page.pageToken; if(scanned%5000===0) console.log('…scanned='+scanned+', candidates='+batch.length);
  }while(next);
  console.log('Scan done. scanned='+scanned+', candidates='+batch.length+', kept='+kept);
  if(dryRun||!batch.length)return; let deleted=0,errors=0;
  for(let i=0;i+0<batch.length;i+=1000){const chunk=batch.slice(i,i+1000);const r=await admin.auth().deleteUsers(chunk);deleted+=r.successCount;errors+=r.failureCount;console.log('Deleted '+r.successCount+' (chunk '+(i+1)+'-'+Math.min(i+chunk.length,batch.length)+')');}
  console.log('Finished. Deleted='+deleted+', errors='+errors);
})(); 
JS

node purge-anon.js --days ${DAYS} --dry-run
node purge-anon.js --days ${DAYS}
`; }

    function refresh(show=false){ outEl.value=buildCommands(); if(show) outEl.style.display='block'; }
    btnCopy.addEventListener('click',async()=>{refresh(false); try{await navigator.clipboard.writeText(outEl.value);toast('Commands copied');}catch{outEl.style.display='block';outEl.select();document.execCommand('copy');toast('Commands copied');}});
    btnShow.addEventListener('click',()=>{refresh(true); outEl.scrollTop=0;});
    btnOpen.addEventListener('click',()=>{ const gcp=(gcpEl.value||'iptv-bfa-471617').trim(); btnOpen.href=`https://shell.cloud.google.com/?project=${encodeURIComponent(gcp)}`; });
    [daysEl,fbEl,gcpEl].forEach(el=>el.addEventListener('input',()=>refresh(outEl.style.display==='block')));
    refresh(false);
  })();

  /* ===== Purge: Direct call (your original) ===== */
  (function(){
    const urlEl=$('#purgeUrl'), keyEl=$('#purgeKey'), daysEl=$('#purgeDays2'), out=$('#purgeOut');
    urlEl.value = localStorage.getItem('purge_url') || '';
    keyEl.value = localStorage.getItem('purge_key') || '';
    function save(){ localStorage.setItem('purge_url', urlEl.value.trim()); localStorage.setItem('purge_key', keyEl.value); }
    urlEl.addEventListener('input',save); keyEl.addEventListener('input',save);

    async function call(dry){
      const url=(urlEl.value||'').trim(); const key=keyEl.value||''; const days=Math.max(0,parseInt(daysEl.value||'0',10))||0;
      if(!url || !key){ out.textContent='Enter function URL and secret key.'; return; }
      out.textContent='Running...';
      try{
        const qp = new URL(url); qp.searchParams.set('days', String(days)); if (dry) qp.searchParams.set('dry','1');
        const resp = await fetch(qp.toString(), { headers: { 'x-api-key': key }});
        const j = await resp.json();
        out.textContent = JSON.stringify(j, null, 2);
      }catch(e){
        out.textContent = 'Error: '+(e?.message||String(e));
      }
    }
    $('#btnDirectDry').addEventListener('click',()=>call(true));
    $('#btnDirectGo').addEventListener('click',()=>call(false));
  })();

  /* ===== NEW: GitHub helpers (token in localStorage: iptv_admin_gh) ===== */
  function ghCfg(){ try{return JSON.parse(localStorage.getItem('iptv_admin_gh')||'{}');}catch{return{};} }
  function saveGhCfg(c){ localStorage.setItem('iptv_admin_gh', JSON.stringify(c)); }
  const ghcOwner=$('#ghcOwner'), ghcRepo=$('#ghcRepo'), ghcBranch=$('#ghcBranch'), ghcToken=$('#ghcToken');
  // prefill form from storage
  (()=>{
    const c=ghCfg();
    ghcOwner.value=c.owner||'flaviothebfagroup';
    ghcRepo.value =c.repo ||'IPTV-';
    ghcBranch.value=c.branch||'main';
    ghcToken.value =c.token||'';
  })();
  $('#ghSave').onclick=()=>{ const c={owner:ghcOwner.value.trim(),repo:ghcRepo.value.trim(),branch:ghcBranch.value.trim()||'main',token:ghcToken.value.trim()}; if(!c.owner||!c.repo||!c.token){toast('Fill owner/repo/token');return;} saveGhCfg(c); toast('GitHub saved'); };
  $('#ghClear').onclick=()=>{ localStorage.removeItem('iptv_admin_gh'); toast('Cleared'); location.reload(); };

  function headers(scheme='Bearer', tok=ghCfg().token){
    return {'Authorization':`${scheme} ${tok}`,'Accept':'application/vnd.github+json','Content-Type':'application/json','X-GitHub-Api-Version':'2022-11-28'};
  }
  async function ghFetch(url,opts={}){
    let r=await fetch(url,{...opts,headers:headers('Bearer')});
    if(r.status===401) r=await fetch(url,{...opts,headers:headers('token')});
    return r;
  }
  async function ghText(r){ const t=await r.text().catch(()=> ''); try{ return {json:JSON.parse(t), raw:t}; }catch{ return {json:null, raw:t}; } }
  function ghPath(p){ return (p||'').split('/').map(encodeURIComponent).join('/'); }
  function b64(s){ return btoa(unescape(encodeURIComponent(s))); }
  function needPR(msg,status){ const m=String(msg||'').toLowerCase(); return status===403||status===422||m.includes('protected')||m.includes('status check')||m.includes('resource not accessible'); }

  async function whoami(){
    const r=await ghFetch('https://api.github.com/user');
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`user [${r.status}] ${json?.message||raw}`); }
    return r.json();
  }
  async function getRef(branch){
    const c=ghCfg(); const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/git/ref/heads/${encodeURIComponent(branch)}`);
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`ref [${r.status}] ${json?.message||raw}`); }
    return (await r.json()).object.sha;
  }
  async function createBranch(from,to){
    const sha=await getRef(from);
    const c=ghCfg(); const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/git/refs`,{method:'POST',body:JSON.stringify({ref:`refs/heads/${to}`,sha})});
    if(!r.ok && r.status!==422){ const {json,raw}=await ghText(r); throw new Error(`branch [${r.status}] ${json?.message||raw}`); }
  }
  async function fileSha(path,branch){
    const c=ghCfg(); const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${ghPath(path)}?ref=${encodeURIComponent(branch)}`);
    if(r.status===404) return null;
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`getFileSha [${r.status}] ${json?.message||raw}`); }
    return (await r.json()).sha||null;
  }
  async function ghListDir(path,branch){
    const c=ghCfg(); const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${ghPath(path)}?ref=${encodeURIComponent(branch)}`);
    if(r.status===404) return [];
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`ls [${r.status}] ${json?.message||raw}`); }
    return await r.json();
  }
  async function openPR(head,base,title,body){
    const c=ghCfg();
    const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/pulls`,{method:'POST',body:JSON.stringify({title,head,base,body})});
    if(!r.ok && r.status!==422){ const {json,raw}=await ghText(r); throw new Error(`PR [${r.status}] ${json?.message||raw}`); }
    return r.json?.();
  }
  async function ghUpsert(path,content,message,branch){
    const c=ghCfg(); const br=branch||c.branch||'main';
    const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${ghPath(path)}`;
    const sha=await fileSha(path,br);
    const body=JSON.stringify({message:message||`Update ${path}`,content:b64(content||''),branch:br,...(sha?{sha}:{})});
    let res=await ghFetch(url,{method:'PUT',body});
    if(!res.ok){
      const {json,raw}=await ghText(res);
      if(needPR(json?.message||raw,res.status)){
        const tmp=`iptv-admin-${Date.now().toString(36)}`;
        await createBranch(br,tmp);
        const sha2=await fileSha(path,tmp);
        const body2=JSON.stringify({message:message||`Update ${path}`,content:b64(content||''),branch:tmp,...(sha2?{sha:sha2}:{})});
        const res2=await ghFetch(url,{method:'PUT',body:body2});
        if(!res2.ok){ const {json:jj,raw:rr}=await ghText(res2); throw new Error(`PUT@PR [${res2.status}] ${jj?.message||rr}`); }
        await openPR(tmp, br, message||`Update ${path}`, `Auto-created by Settings page\n\nPath: \`${path}\``);
        return res2.json();
      }
      throw new Error(`put [${res.status}] ${json?.message||raw}`);
    }
    return res.json();
  }
  async function ghDelete(path,message,branch){
    const c=ghCfg(); const br=branch||c.branch||'main';
    const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${ghPath(path)}`;
    const sha=await fileSha(path,br);
    if(!sha) return {ok:true,skipped:true};
    let res=await ghFetch(url,{method:'DELETE',body:JSON.stringify({message:message||`Delete ${path}`,sha,branch:br})});
    if(!res.ok){
      const {json,raw}=await ghText(res);
      if(needPR(json?.message||raw,res.status)){
        const tmp=`iptv-delete-${Date.now().toString(36)}`;
        await createBranch(br,tmp);
        const sha2=await fileSha(path,tmp);
        if(!sha2) return {ok:true,skipped:true};
        const res2=await ghFetch(url,{method:'DELETE',body:JSON.stringify({message:message||`Delete ${path}`,sha:sha2,branch:tmp})});
        if(!res2.ok){ const {json:jj,raw:rr}=await ghText(res2); throw new Error(`del@PR [${res2.status}] ${jj?.message||rr}`); }
        await openPR(tmp, br, message||`Delete ${path}`, `Auto-created by Settings page (delete)\n\nPath: \`${path}\``);
        return res2.json();
      }
      throw new Error(`del [${res.status}] ${json?.message||raw}`);
    }
    return res.json();
  }

  // GitHub Test button
  $('#ghTest').onclick=async()=>{
    const c=ghCfg(); if(!c.token){ toast('Set token first'); return; }
    try{
      const me=await whoami();
      const ref=await getRef(c.branch||'main');
      $('#ghStatus').innerHTML=`OK as ${mono(me.login)} — branch ${mono((c.branch||'main'))} @ ${mono(ref.slice(0,7))}`;
      toast('GitHub OK');
    }catch(e){ $('#ghStatus').textContent=String(e.message||e); toast('GitHub failed'); }
  };

  // Firebase displays for orphan check
  async function fbDisplayIds(){
    try{
      const s=await get(ref(db,'displays')); const map=s.val()||{}; return Object.keys(map);
    }catch{ return []; }
  }

  // List files
  async function refreshFiles(){
    const c=ghCfg(); if(!c.owner||!c.repo||!c.branch||!c.token){ toast('Configure GitHub first'); return; }
    const tbl=$('#filesTable'); tbl.innerHTML='Loading…';
    try{
      const ids=new Set(await fbDisplayIds());
      let items=await ghListDir('Displays', c.branch||'main');
      items=(items||[]).filter(x=>x.type==='file' && /\.html$/i.test(x.name)).sort((a,b)=>a.name.localeCompare(b.name));
      const orphansOnly=$('#showOrphansOnly').checked;
      const rows=items.map(it=>{
        const id=it.name.replace(/\.html$/,'');
        const orphan=!ids.has(id);
        if(orphansOnly && !orphan) return '';
        return `
          <div class="tr" data-name="${it.name}">
            <input type="checkbox" class="chk">
            <div class="name mono">${it.name} ${orphan?'<span class="badge">orphan</span>':''}</div>
            <button class="btn" data-rename>Rename</button>
            <a class="btn" href="https://flaviothebfagroup.github.io/IPTV-/Displays/${encodeURIComponent(id)}.html" target="_blank" rel="noopener">Open</a>
          </div>`;
      }).join('') || '<div class="muted">No files.</div>';
      tbl.innerHTML=`
        <div style="margin-bottom:6px"><label class="badge"><input id="filesAll" type="checkbox"> Select all</label></div>
        <div class="table">${rows}</div>`;
      $('#filesAll').onchange=()=>{ tbl.querySelectorAll('.chk').forEach(x=>x.checked=$('#filesAll').checked); };
      // rename handlers
      tbl.querySelectorAll('[data-rename]').forEach(btn=>{
        btn.onclick=async()=>{
          const row=btn.closest('.tr'); const name=row.dataset.name; const idOld=name.replace(/\.html$/,'');
          const idNew=(prompt('New display ID (no .html):', idOld)||'').trim();
          if(!idNew || idNew===idOld) return;
          try{
            // try to fetch old file to preserve content; else use template
            const c=ghCfg();
            const file=`Displays/${name}`;
            let html=null;
            try{
              html=await fetch(`https://raw.githubusercontent.com/${c.owner}/${c.repo}/${encodeURIComponent(c.branch||'main')}/${ghPath(file)}`).then(r=>r.text());
            }catch(_){}
            const updated=(html||buildPlayerTemplate(idOld,idOld)).replaceAll(idOld, idNew);
            await ghUpsert(`Displays/${idNew}.html`, updated, `Rename player ${idOld} → ${idNew}`);
            await ghDelete(`Displays/${idOld}.html`, `Delete old ${idOld}`);
            toast(`Renamed ${idOld} → ${idNew}`);
            refreshFiles();
          }catch(e){ console.error(e); toast(`Rename failed: ${e.message||e}`); }
        };
      });
    }catch(e){ console.error(e); $('#filesTable').innerHTML=`<div class="small mono" style="color:#ef4444">${String(e.message||e)}</div>`; }
  }
  $('#filesRefresh').onclick=refreshFiles;
  $('#showOrphansOnly').onchange=refreshFiles;

  // delete selected
  $('#filesDelete').onclick=async()=>{
    const tbl=$('#filesTable'); const picks=[...tbl.querySelectorAll('.tr')].filter(r=>r.querySelector('.chk')?.checked).map(r=>r.dataset.name);
    if(picks.length===0) return toast('Pick files');
    if(!confirm(`Delete ${picks.length} file(s)?`)) return;
    try{
      for(const name of picks){
        await ghDelete(`Displays/${name}`, `Delete ${name}`);
      }
      toast('Delete done (PR opened if needed)');
      refreshFiles();
    }catch(e){ console.error(e); toast(`Delete failed: ${e.message||e}`); }
  };

  // create player
  $('#filesCreate').onclick=async()=>{
    const id=(prompt('New display ID (e.g., DS-003):','')||'').trim();
    if(!id) return;
    const friendly=(prompt('Dealership public name for template:', '')||id).trim();
    const html=buildPlayerTemplate(id,friendly);
    try{
      await ghUpsert(`Displays/${id}.html`, html, `Create player for ${id} (${friendly})`);
      toast('Player created (PR if needed)');
      refreshFiles();
    }catch(e){ console.error(e); toast(`Create failed: ${e.message||e}`); }
  };

  // PR list
  async function listPRs(){
    const c=ghCfg();
    const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/pulls?state=open`);
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`prs [${r.status}] ${json?.message||raw}`); }
    return r.json();
  }
  async function mergePR(num){
    const c=ghCfg();
    const r=await ghFetch(`https://api.github.com/repos/${c.owner}/${c.repo}/pulls/${num}/merge`,{method:'PUT',body:JSON.stringify({merge_method:'squash'})});
    if(!r.ok){ const {json,raw}=await ghText(r); throw new Error(`merge [${r.status}] ${json?.message||raw}`); }
    return r.json();
  }
  async function refreshPRs(){
    const list=$('#prList'); list.innerHTML='Loading…';
    try{
      const prs=await listPRs();
      if(!prs||prs.length===0){ list.innerHTML='<div class="muted">No open PRs.</div>'; return; }
      list.innerHTML=prs.map(p=>`
        <div class="tr" style="grid-template-columns:1fr auto auto;">
          <div><b>#${p.number}</b> — ${p.title} <span class="badge">from ${mono(p.head.ref)}</span></div>
          <a class="btn" target="_blank" rel="noopener" href="${p.html_url}">Open</a>
          <button class="btn" data-merge="${p.number}">Merge</button>
        </div>`).join('');
      list.querySelectorAll('[data-merge]').forEach(b=>{
        b.onclick=async()=>{ try{ await mergePR(b.dataset.merge); toast('Merged'); refreshFiles(); refreshPRs(); }catch(e){ toast(`Merge failed: ${e.message||e}`); } };
      });
    }catch(e){ list.innerHTML=`<div class="small mono" style="color:#ef4444">${String(e.message||e)}</div>`; }
  }
  $('#prRefresh').onclick=refreshPRs;

  // Initial load for new sections
  refreshFiles(); refreshPRs();

  /* ===== Player template for file creation (exact as your Displays template) ===== */
  function buildPlayerTemplate(displayId, dealershipPublicName){
    const tpl=document.getElementById('tpl');
    return (tpl?.innerHTML||'').replaceAll('(NEW-CODE)', displayId).replaceAll('(NEW-NAME)', dealershipPublicName);
  }
</script>

<!-- ===== EXACT PLAYER TEMPLATE (from your Displays page) ===== -->
<template id="tpl"><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Digital Signage — Player</title>
  <style>
    :root{ --bg:#000; --fg:#fff; --muted:#b3b3b3; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.15); --accent:#ff9500; --ok:#22c55e; --err:#ef4444; }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{ background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif; overflow:hidden; position:relative; }
    .video-container{position:absolute; inset:0; background:#000}
    video{width:100%; height:100%; object-fit:cover; background:#000}
    .loading-overlay{ position:absolute; inset:0; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity .25s; }
    .loading-overlay.active{opacity:1; pointer-events:auto}
    .spinner{ width:54px; height:54px; border-radius:50%; border:3px solid rgba(255,255,255,.15); border-top-color:#fff; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .channel-info{ position:absolute; top:18px; left:18px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 14px; z-index:50; opacity:0; transform:translateY(-8px); transition:opacity .25s, transform .25s; }
    .channel-info.show{opacity:1; transform:translateY(0)}
    .channel-name{font-weight:800}
    .channel-sub{font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center}
    .live-dot{width:8px;height:8px;border-radius:50%; background:var(--accent); box-shadow:0 0 0 0 rgba(255,149,0,.7); animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,149,0,.7)} 70%{box-shadow:0 0 0 8px rgba(255,149,0,0)} 100%{box-shadow:0 0 0 0 rgba(255,149,0,0)}}
    .status-bar{ position:absolute; right:18px; bottom:18px; display:flex; gap:10px; align-items:center; background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-size:12px; z-index:50; }
    .status-dot{width:10px;height:10px;border-radius:50%; background:var(--ok)}
    .status-dot.disconnected{background:var(--err)}
    .divider{opacity:.45}
    .display-id{ position:absolute; left:18px; bottom:18px; z-index:50; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-size:12px; color:#fff; }
    .error-message{ position:absolute; inset:auto 50% 50% auto; transform:translate(50%,-50%); background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.4); color:#fff; padding:14px 18px; border-radius:14px; display:none; z-index:80; text-align:center; }
    .error-message.show{display:block}
    .error-title{font-weight:800; margin-bottom:4px; color:var(--err)}
    .error-text{font-size:12px; color:#fff}
    .transition-overlay{position:absolute; inset:0; background:#000; z-index:40; opacity:0; pointer-events:none; transition:opacity .25s}
    .transition-overlay.active{opacity:1}
    .volume-control{ position:absolute; left:50%; bottom:100px; transform:translateX(-50%); display:flex; align-items:center; gap:12px; z-index:70; background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .2s; }
    .volume-control.show{opacity:1; pointer-events:auto}
    .vol-btn{ width:40px; height:40px; border-radius:50%; border:1px solid var(--border); background:transparent; color:#fff; font-size:18px; cursor:pointer; }
    .vol-track{width:160px; height:8px; border-radius:6px; background:rgba(255,255,255,.12); position:relative; overflow:hidden; border:1px solid var(--border)}
    .vol-fill{position:absolute; left:0; top:0; bottom:0; width:0%; background:var(--accent)}
    .vol-percent{font-weight:800; min-width:46px; text-align:right}
    .vol-icon{width:22px;height:22px; display:block}
    .bar{opacity:0; transition:opacity .15s}
    .icon-muted .bar, .icon-level-0 .bar{opacity:0}
    .icon-level-1 #bar1{opacity:1}
    .icon-level-2 #bar1, .icon-level-2 #bar2{opacity:1}
    .icon-level-3 #bar1, .icon-level-3 #bar2, #bar3{opacity:1}
    .icon-muted #x1, .icon-muted #x2{opacity:1}
    #x1,#x2{opacity:0; stroke:var(--err); stroke-width:2; stroke-linecap:round}
    .volume-float{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.92); border:1px solid var(--border); color:#fff; padding:26px 36px; border-radius:18px; font-weight:900; font-size:40px; z-index:90; animation:fadeHud 1.8s ease forwards; }
    @keyframes fadeHud{0%{opacity:0; transform:translate(-50%,-50%) scale(.96)} 15%{opacity:1; transform:translate(-50%,-50%) scale(1)} 85%{opacity:1} 100%{opacity:0}}
    @media (prefers-reduced-motion:reduce){ .transition-overlay,.channel-info,.loading-overlay{transition:none} }
  </style>
</head>
<body>
  <div class="volume-control" id="volumeHud" aria-live="polite">
    <button class="vol-btn" id="muteBtn" title="Mute/Unmute" aria-label="Mute/Unmute">
      <svg id="volSvg" class="vol-icon icon-muted" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 10v4h4l5 4V6l-5 4H3Z"/>
        <path id="bar1" class="bar" d="M16 9a3 3 0 0 1 0 6" />
        <path id="bar2" class="bar" d="M18.5 7a6 6 0 0 1 0 10" />
        <path id="bar3" class="bar" d="M21 5a9 9 0 0 1 0 14" />
        <line id="x1" x1="2" y1="2" x2="22" y2="22"/>
        <line id="x2" x1="22" y1="2" x2="2" y2="22"/>
      </svg>
    </button>
    <button class="vol-btn" id="volDown" title="Volume down" aria-label="Volume down">−</button>
    <div class="vol-track"><div class="vol-fill" id="volFill"></div></div>
    <button class="vol-btn" id="volUp" title="Volume up" aria-label="Volume up">+</button>
    <div class="vol-percent" id="volPct">0%</div>
  </div>

  <div class="video-container">
    <video id="videoPlayer" autoplay muted playsinline></video>
  </div>

  <div class="loading-overlay" id="loading"><div class="spinner"></div></div>

  <div class="channel-info" id="channelInfo">
    <div class="channel-name" id="chName">Channel</div>
    <div class="channel-sub"><span class="live-dot"></span><span>LIVE • CH <span id="chNum">1</span></span></div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="statusDot" title="Connection"></div>
    <span id="statusText">Connected</span>
    <span class="divider">•</span>
    <span id="clock">00:00</span>
  </div>

  <div class="display-id">Display: <b id="displayId">—</b></div>

  <div class="error-message" id="errToast">
    <div class="error-title">Stream Unavailable</div>
    <div class="error-text" id="errText">Reconnecting…</div>
  </div>

  <div class="transition-overlay" id="fade"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>

  <script>
    const CONFIG = {
      displayId: '(NEW-CODE)',
      dealershipName: '(NEW-NAME)',
      channels: [
        { id:1, name:'News',   url:'https://citynewsregional.akamaized.net/hls/live/1024052/Regional_Live_7/Video-2Mbps.m3u8', type:'hls' },
        { id:2, name:'Sports', url:'http://fl5.moveonjoy.com/TSN_5/index.m3u8', type:'hls' },
        { id:3, name:'Cooking',url:'https://gusto-xumo.amagi.tv/playlist.m3u8', type:'hls' },
        { id:4, name:'Nature', url:'https://aegis-cloudfront-1.tubi.video/dc8bda97-ce9e-4091-b4e8-11254dea4da6/playlist.m3u8', type:'hls' },
        { id:5, name:'Kids',   url:'https://c0c65b821b3542c3a4dca92702f59944.mediatailor.us-east-1.amazonaws.com/v1/master/04fd913bb278d8775298c26fdca9d9841f37601f/RakutenTV-eu_BabySharkTV/playlist.m3u8', type:'hls' }
      ]
    };

    let hls=null;
    window.currentChannel=1; window.currentVolume=0; window.isMuted=true; let lastVolume=50;
    const $ = (id)=>document.getElementById(id);

    document.addEventListener('DOMContentLoaded', ()=>{
      $('displayId').textContent = CONFIG.displayId;
      initVideo(); initVolumeUI(); tickClock(); setInterval(tickClock, 1000); loadChannel(1);
    });

    function initVideo(){
      const v=$('videoPlayer'); v.volume=0; v.muted=true;
      v.addEventListener('loadstart', ()=> showLoading(true));
      v.addEventListener('canplay',   ()=> showLoading(false));
      v.addEventListener('stalled',   ()=> showLoading(true));
      v.addEventListener('error',     onVideoError);
      $('volUp').onclick   = ()=> volumeUp();
      $('volDown').onclick = ()=> volumeDown();
      $('muteBtn').onclick = ()=> toggleMute();
    }
    function initVolumeUI(){
      const sv=localStorage.getItem('displayVolume'); const sm=localStorage.getItem('displayMuted');
      if(sv!==null){ window.currentVolume=parseInt(sv,10); lastVolume=window.currentVolume||50; }
      if(sm!==null){ window.isMuted=(sm==='true'); }
      const v=$('videoPlayer'); v.volume=(window.currentVolume||0)/100; v.muted=!!window.isMuted; renderVolumeUI();
    }
    function renderVolumeUI(){
      const pct=Math.max(0,Math.min(100,window.currentVolume|0));
      $('volFill').style.width=pct+'%'; $('volPct').textContent=(window.isMuted||pct===0)?'0%':(pct+'%');
      const cls=window.isMuted||pct===0?'icon-muted':pct<30?'icon-level-1':pct<70?'icon-level-2':'icon-level-3';
      $('volSvg').className.baseVal='vol-icon '+cls;
    }
    function toggleMute(){ window.isMuted?mute():unmute(); }
    function mute(){ const v=$('videoPlayer'); window.isMuted=true; v.muted=true; localStorage.setItem('displayMuted','true'); renderVolumeUI(); }
    function unmute(){ const v=$('videoPlayer'); if(window.currentVolume===0){ window.currentVolume=lastVolume||50; v.volume=window.currentVolume/100; } window.isMuted=false; v.muted=false; v.play().catch(()=>{}); localStorage.setItem('displayMuted','false'); renderVolumeUI(); }
    function setVolume(vol){ vol=Math.max(0,Math.min(100,vol|0)); const v=$('videoPlayer'); window.currentVolume=vol; if(vol>0) lastVolume=vol; v.volume=vol/100; if(vol===0){ window.isMuted=true; v.muted=true; localStorage.setItem('displayMuted','true'); } localStorage.setItem('displayVolume',String(vol)); renderVolumeUI(); }
    function volumeUp(){ if(window.isMuted) unmute(); setVolume(window.currentVolume+10); }
    function volumeDown(){ setVolume(window.currentVolume-10); }
    function showError(msg){ $('errText').textContent=msg; $('errToast').classList.add('show'); }
    function hideError(){ $('errToast').classList.remove('show'); }
    function showLoading(f){ const el=$('loading'); if(f){ el.classList.add('active'); } else { el.classList.remove('active'); hideError(); } }
    function setStatus(connected,msg){ const dot=$('statusDot'),txt=$('statusText'); dot.classList.toggle('disconnected',!connected); txt.textContent=connected?'Connected':('Disconnected'+(msg?` — ${msg}`:'')); }
    function tickClock(){ $('clock').textContent=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'}); }
    function updateChannelInfo(ch){ $('chName').textContent=ch.name||('Channel '+ch.id); $('chNum').textContent=ch.id; const box=$('channelInfo'); box.classList.add('show'); clearTimeout(box._t); box._t=setTimeout(()=>box.classList.remove('show'),4000); }
    function onHlsError(evt,data){ if(!data||!data.fatal) return; showError('Stream error'); }
    function onVideoError(){ showError('Playback error'); }
    function loadChannel(n){
      const ch=CONFIG.channels.find(c=>c.id===n); if(!ch) return;
      const v=$('videoPlayer'); showLoading(true);
      if(Hls.isSupported()){
        if(hls){ try{hls.destroy();}catch(e){} hls=null; }
        hls=new Hls({enableWorker:true,lowLatencyMode:true});
        hls.attachMedia(v);
        hls.loadSource(ch.url);
        hls.on(Hls.Events.MANIFEST_PARSED,()=>{ v.play().then(()=>{ v.volume=window.currentVolume/100; v.muted=window.isMuted; showLoading(false); }).catch(()=>{}); });
        hls.on(Hls.Events.ERROR,onHlsError);
      } else if(v.canPlayType('application/vnd.apple.mpegurl')){
        v.src=ch.url;
        v.play().then(()=>{ v.volume=window.currentVolume/100; v.muted=window.isMuted; showLoading(false); }).catch(()=>{});
      } else { showError('HLS not supported'); }
      updateChannelInfo(ch); window.currentChannel=n;
    }
    window.setStatus=setStatus;
    window.applyVolumeSettings=function(volume,muted){ if(typeof volume==='number') setVolume(volume); if(typeof muted==='boolean') muted?mute():un
    window.applyVolumeSettings = function (volume, muted) {
      if (typeof volume === 'number') setVolume(volume);
      if (typeof muted === 'boolean') (muted ? mute() : unmute());
    };

    // Allow external channel switches (e.g., from your admin UI)
    window.switchChannel = function (n) {
      const id = Number(n);
      if (Number.isFinite(id)) loadChannel(id);
    };

    // ---- UX helpers ----
    function flashHud() {
      const hud = $('volumeHud');
      hud.classList.add('show');
      clearTimeout(hud._t);
      hud._t = setTimeout(() => hud.classList.remove('show'), 1200);
    }

    // Show HUD when interacting with volume/mute buttons
    $('volUp').addEventListener('click', flashHud);
    $('volDown').addEventListener('click', flashHud);
    $('muteBtn').addEventListener('click', flashHud);

    // Tap/click anywhere to reveal the HUD briefly
    document.addEventListener('click', (e) => {
      if (e.target.closest('.vol-btn')) return; // ignore clicks on the buttons (already handled)
      flashHud();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      if (e.key === 'ArrowUp') { volumeUp(); flashHud(); }
      else if (e.key === 'ArrowDown') { volumeDown(); flashHud(); }
      else if (e.key === 'm' || e.key === 'M') { toggleMute(); flashHud(); }
      else if (/^[1-9]$/.test(e.key)) { switchChannel(parseInt(e.key, 10)); }
    });

    // Online/offline indicator (uses setStatus you've already defined)
    function refreshOnline() {
      setStatus(navigator.onLine, navigator.onLine ? '' : 'offline');
    }
    window.addEventListener('online', refreshOnline);
    window.addEventListener('offline', refreshOnline);
    refreshOnline();
  </script>
 <!-- Firebase (module) for the player: connects to RTDB and listens for channel/volume/muted -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, update, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    // If embedded in your admin preview (?embed=1) use in-memory auth so it doesn't affect normal sessions
    const EMBED = /\bembed=1\b/i.test(location.search) || (window.top !== window.self);

    const app = initializeApp(firebaseConfig, EMBED ? 'embed' : undefined);
    const auth = getAuth(app);
    if (EMBED) { await setPersistence(auth, inMemoryPersistence); }
    const db = getDatabase(app);

    // Anonymous sign-in for devices
    signInAnonymously(auth).catch(e => {
      console.error('[auth]', e);
      window.setStatus(false, 'anon auth failed');
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      const displayId = CONFIG.displayId;
      const dealershipName = CONFIG.dealershipName;

      if (EMBED) {
        // Preview mode: just listen to /displays/{id}
        const dref = ref(db, `displays/${displayId}`);
        onValue(dref, (snap) => {
          const d = snap.val(); if (!d) return;
          if (typeof d.channel === 'number' && d.channel !== window.currentChannel) window.loadChannel(d.channel);
          if (d.volume !== undefined || d.muted !== undefined) window.applyVolumeSettings(d.volume, d.muted);
          window.setStatus(true, '');
        }, (err) => {
          console.error('[listener]', err);
          window.setStatus(false, 'listener error');
        });
        return;
      }

      // Device mode: register device + ensure defaults exist
      try {
        await update(ref(db, `user/${user.uid}`), {
          role: 'device',
          name: displayId,
          dealershipId: dealershipName,
          updatedAt: Date.now(),
          createdAt: Date.now()
        });
      } catch (e) {}

      try {
        const dRef = ref(db, `displays/${displayId}`);
        const snap = await get(dRef);
        if (!snap.exists()) {
          await update(dRef, { channel: 1, volume: 50, muted: true, dealership: dealershipName, timestamp: Date.now() });
        }
      } catch (e) {}

      // Live control listener
      const dref = ref(db, `displays/${displayId}`);
      onValue(dref, (snap) => {
        const d = snap.val(); if (!d) return;
        if (typeof d.channel === 'number' && d.channel !== window.currentChannel) window.loadChannel(d.channel);
        if (d.volume !== undefined || d.muted !== undefined) window.applyVolumeSettings(d.volume, d.muted);
        window.setStatus(true, '');
      }, (err) => {
        console.error('[listener]', err);
        window.setStatus(false, 'listener error');
      });

      // Heartbeat
      try {
        const hbRef = ref(db, `displays/${displayId}`);
        const beat = async () => { try { await update(hbRef, { lastSeenAt: Date.now(), updatedAt: Date.now() }); } catch (e) {} };
        beat();
        setInterval(beat, 15000);
      } catch (e) {}
    });
  </script>
</body>
</html></template>
