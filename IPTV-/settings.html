gcloud config set project iptv-bfa-471617

mkdir -p ~/auth-purge && cd ~/auth-purge
npm init -y >/dev/null 2>&1
npm i firebase-admin@12 >/dev/null 2>&1

cat > purge-anon.js <<'JS'
const admin = require('firebase-admin');
admin.initializeApp({ credential: admin.credential.applicationDefault(), projectId: 'iptv-bfa' });
function tms(x){ const n=new Date(x||0).getTime(); return Number.isFinite(n)?n:0; }
const argv=process.argv.slice(2);function arg(n,d){const i=argv.findIndex(a=>a==='--'+n||a.startsWith('--'+n+'='));if(i<0)return d;const v=argv[i].includes('=')?argv[i].split('=')[1]:argv[i+1];return v??d;}
const days=Number(arg('days', 0))||0;const dryRun=argv.includes('--dry-run');
(async()=>{const cutoff=Date.now()-days*24*60*60*1000;let scanned=0,kept=0,next;const batch=[];
  console.log('Scanning… days='+days+', cutoff='+new Date(cutoff).toISOString()+', dryRun='+dryRun);
  do{const page=await admin.auth().listUsers(1000,next);
    for(const u of page.users){scanned++;const isAnon=!u.providerData||u.providerData.length===0;if(!isAnon){kept++;continue;}
      const last=Math.max(tms(u.metadata.lastSignInTime),tms(u.metadata.creationTime)); if(last<cutoff) batch.push(u.uid); else kept++; }
    next=page.pageToken; if(scanned%5000===0) console.log('…scanned='+scanned+', candidates='+batch.length);
  }while(next);
  console.log('Scan done. scanned='+scanned+', candidates='+batch.length+', kept='+kept);
  if(dryRun||!batch.length)return; let deleted=0,errors=0;
  for(let i=0;i+0<batch.length;i+=1000){const chunk=batch.slice(i,i+1000);const r=await admin.auth().deleteUsers(chunk);deleted+=r.successCount;errors+=r.failureCount;console.log('Deleted '+r.successCount+' (chunk '+(i+1)+'-'+Math.min(i+chunk.length,batch.length)+')');}
  console.log('Finished. Deleted='+deleted+', errors='+errors);
})(); 
JS

node purge-anon.js --days 0 --dry-run
node purge-anon.js --days 0
