<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sales Pinboard — 3-Row Layout + Live</title>
<style>
  :root{
    --roleW:160px; --typeW:120px; --rcolW:72px; --cellW:44px;
    --rowH:32px; /* JS recalculates so all rows fit exactly */
    --bg:#0b0f14; --panel:rgba(255,255,255,.94); --frame:rgba(255,255,255,.96);
    --ink:#0b0b0c; --muted:#5b6570; --line:#d0d3d9;
    --green:#1a7f37; --blue:#1b59d1; --red:#c42b2b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; color:var(--ink); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg)}

  /* Background (optional, never blocks) */
  .bg{position:fixed; inset:0; z-index:0; pointer-events:none}
  .bg img{width:100%; height:100%; object-fit:cover; filter:saturate(115%) brightness(.75)}
  .bg.hidden{display:none}

  .stage{width:100vw; height:100vh; position:relative; z-index:1; display:flex; flex-direction:column; background:var(--panel)}

  .chrome{display:flex; align-items:center; gap:16px; padding:10px 16px 6px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.9)}
  .title{font-weight:700}
  .spacer{flex:1}
  .asof{font-size:13px; color:var(--muted)}
  .asof strong{color:#000; font-size:16px; font-weight:800}
  .live{margin-left:10px; font-size:12px; font-weight:700; color:#0a7; display:none}

  .legend{display:flex; gap:14px; align-items:center; padding:8px 16px; background:rgba(255,255,255,.92); border-bottom:1px solid var(--line)}
  .tag{display:inline-flex; align-items:center; gap:8px; color:#0b0b0c}
  .dot{width:14px; height:14px; border-radius:4px; border:1px solid #bfc5cf}
  .dot.green{background:#e8f5ec; border-color:#a7d6b8}
  .dot.blue{ background:#e7efff; border-color:#b9ccff}
  .dot.red{  background:#f7e9ea; border-color:#efc9cd}

  .content{flex:1; padding:12px 16px 16px}
  .frame{height:100%; background:var(--frame); border:1px solid var(--line); border-radius:10px; overflow:hidden}

  table{border-collapse:separate; border-spacing:0; width:100%; table-layout:fixed}
  thead th{position:sticky; top:0; z-index:2; background:rgba(245,246,248,.92)}
  th,td{border-right:1px solid var(--line); border-bottom:1px solid var(--line); padding:6px 8px; text-align:center; vertical-align:middle}
  th:first-child,td:first-child{border-left:1px solid var(--line)}
  th{font-weight:600; color:#263238; font-size:13px}

  /* Left sticky columns */
  .name{position:sticky; left:0; z-index:1; background:var(--frame); text-align:left; font-weight:600; width:var(--roleW); cursor:pointer}
  .type{position:sticky; left:var(--roleW); z-index:1; background:var(--frame); width:var(--typeW); font-weight:600; text-align:left}

  /* Day cells + row height control */
  .daynum, td.cell{width:var(--cellW)}
  td.cell, td.type{height:var(--rowH)} /* <-- JS sets --rowH so all rows fit */
  tbody td{background:rgba(255,255,255,.94)}
  tbody tr:nth-child(odd) td{background:rgba(252,253,255,.90)}
  /* Remove any “today” highlight completely */
  .today{ /* intentionally empty to remove yellow highlight */ }

  /* Right summary columns: MTD, YTD */
  th.rcol, td.rcol{width:var(--rcolW); font-weight:700; background:rgba(251,251,253,.95)}

  /* Category coloring */
  .row-new  td.cell .num{color:var(--green)}
  .row-po   td.cell .num{color:var(--blue)}
  .row-wt   td.cell .num{color:var(--red)}
  .tag-new{color:var(--green)} .tag-po{color:var(--blue)} .tag-wt{color:var(--red)}
  .num{display:inline-block; min-width:18px; padding:0 4px; border-radius:6px; border:1px solid transparent}
  .row-new .num{background:#e8f5ec; border-color:#b7e2c7}
  .row-po  .num{background:#e7efff; border-color:#c2d5ff}
  .row-wt  .num{background:#f7e9ea; border-color:#f0c9cd}

  /* Editor */
  .editor{position:fixed; left:16px; bottom:16px; width:400px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; box-shadow:0 12px 24px rgba(0,0,0,.18); display:none; z-index:50}
  .editor h3{margin:0 0 8px; font-size:14px}
  .rows{display:grid; grid-template-columns:28px 1fr 110px; gap:10px 8px; align-items:center}
  .chip{min-width:22px; height:18px; padding:0 4px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; font-size:12px; border:1px solid transparent}
  .chip.g{color:var(--green); background:#e8f5ec; border-color:#b7e2c7}
  .chip.b{color:var(--blue);  background:#e7efff; border-color:#c2d5ff}
  .chip.wt{color:var(--red);   background:#f7e9ea; border-color:#f0c9cd}
  .rows label{font-weight:600; color:#2f2f31; text-align:left}
  .rows input{width:100%; padding:6px 8px; border:1px solid #aeb3bb; border-radius:8px}
  .rows input[type=number]{-moz-appearance:textfield}
  .rows input[type=number]::-webkit-outer-spin-button,.rows input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none; margin:0}
  details.box{margin-top:10px; border-top:1px solid var(--line); padding-top:10px}
  details.box summary{cursor:pointer; font-weight:600; color:#2f2f31}
  .nameRow{display:grid; grid-template-columns:1fr auto auto; gap:8px; margin-top:8px}
  .nameRow input,.monthRow select,.monthRow input{padding:6px 8px; border:1px solid #aeb3bb; border-radius:8px; width:100%}
  .monthRow{display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center; margin-top:8px}

  .foot{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .btn{appearance:none; border:1px solid #aeb3bb; background:#fff; padding:8px 10px; border-radius:8px; font-weight:600; cursor:pointer}
  .btn.primary{border-color:#0b6bcb; background:#0b6bcb; color:#fff}

  /* Debug banner (optional) */
  .dbg{position:fixed; right:8px; bottom:8px; font:12px/1.2 system-ui; background:rgba(0,0,0,.55); color:#fff; padding:6px 8px; border-radius:8px; display:none; z-index:99}
  .dbg.good{background:rgba(0,128,0,.55)} .dbg.bad{background:rgba(128,0,0,.55)}
</style>
</head>
<body>
  <!-- Background GIF. Uses bg.gif by default or ?gif=URL. Never blocks. -->
  <div class="bg" aria-hidden="true"><img id="bgimg" alt="" /></div>

  <div class="stage">
    <div class="chrome">
      <div class="title">Sales Pinboard</div>
      <div class="spacer"></div>
      <div class="asof" id="asof">—</div>
      <div class="live" id="live">LIVE</div>
    </div>

    <div class="legend">
      <span class="tag"><span class="dot green"></span> New Car</span>
      <span class="tag"><span class="dot blue"></span> Pre-Owned</span>
      <span class="tag"><span class="dot red"></span> Winter Tire</span>
    </div>

    <div class="content">
      <div class="frame">
        <table id="grid"></table>
      </div>
    </div>
  </div>

  <!-- Editor -->
  <div class="editor" id="editor" role="dialog" aria-modal="true">
    <h3 id="editorTitle">Edit</h3>
    <div class="rows">
      <div class="chip g">G</div><label for="inG">New</label><input id="inG" type="number" min="0" step="1" />
      <div class="chip b">B</div><label for="inB">Pre-Owned</label><input id="inB" type="number" min="0" step="1" />
      <div class="chip wt">WT</div><label for="inW">Winter Tire</label><input id="inW" type="number" min="0" step="1" />
    </div>

    <details class="box" id="nameMgr">
      <summary>Manage names</summary>
      <div class="nameRow">
        <input id="nameField" placeholder="Type a name…" />
        <button class="btn" id="addNameBtn" type="button">Add</button>
        <button class="btn" id="renameBtn" type="button">Rename selected</button>
      </div>
    </details>

    <details class="box" id="monthMgr">
      <summary>Change month</summary>
      <div class="monthRow">
        <select id="monthSel"></select>
        <input id="yearInput" type="number" placeholder="Year" />
        <button class="btn" id="applyMonthBtn" type="button">Apply</button>
      </div>
    </details>

    <div class="foot">
      <button class="btn" id="cancelEdit" type="button">Cancel</button>
      <button class="btn primary" id="saveEdit" type="button">Save</button>
    </div>
  </div>

  <!-- Debug banner -->
  <div id="dbg" class="dbg"></div>

<script>
/* ===== Older-engine friendly query parsing ===== */
function getQS(){
  var s = location.search.replace(/^\?/, ''); var o = {}; if (!s) return o;
  var a = s.split('&'); for (var i=0;i<a.length;i++){ var kv=a[i].split('='); o[decodeURIComponent(kv[0])] = decodeURIComponent((kv[1]||'').replace(/\+/g,' ')); }
  return o;
}

/* ===== Background (never blocks) ===== */
(function(){
  var qs = getQS(); var el = document.getElementById('bgimg');
  var url = qs.gif || 'bg.gif';
  el.onerror = function(){ var bg = document.querySelector('.bg'); if (bg) bg.classList.add('hidden'); };
  el.src = url;
})();

/* ===== Data / Live sync ===== */
var STORAGE_KEY = 'sales-pinboard-live-v1';
var defaultTeam = ['Yassir','Sumit','Connor','Mohamad','Jerry','Brittany','Arnold','House'];
var today = new Date();
var qs = getQS();
var FEED_URL = qs.feed || '';    // Google Apps Script URL
var POLL_MS  = Math.max(5000, parseInt(qs.poll || '30000', 10) || 30000);
var PUSH     = (qs.push === '1');
var PUSHKEY  = qs.pushkey || '';
var DEBUG    = (qs.debug === '1');

var state = { year: today.getFullYear(), month: today.getMonth(), names: defaultTeam.slice(), data: {} };
try { var saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null'); if (saved && typeof saved==='object'){ for (var k in saved) state[k]=saved[k]; } } catch(e){}

/* schema: state.data[name].MTD[day] = {g,b,w}; state.data[name].YTD[day] (optional) */

/* helpers */
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function ensureSkeleton(){
  var dim = daysInMonth(state.year, state.month);
  if (!state.names || !state.names.length) state.names = defaultTeam.slice();
  state.data = state.data || {};
  for (var i=0;i<state.names.length;i++){
    var n = state.names[i];
    if (!state.data[n]) state.data[n] = {MTD:{}, YTD:{}};
    if (!state.data[n].MTD) state.data[n].MTD = {};
    if (!state.data[n].YTD) state.data[n].YTD = {};
    for (var d=1; d<=dim; d++){
      if (!state.data[n].MTD[d]) state.data[n].MTD[d] = {g:0,b:0,w:0};
      if (!state.data[n].YTD[d]) state.data[n].YTD[d] = {g:0,b:0,w:0};
    }
    for (var k in state.data[n].MTD){ if (+k>dim) delete state.data[n].MTD[k]; }
    for (var k2 in state.data[n].YTD){ if (+k2>dim) delete state.data[n].YTD[k2]; }
  }
}
function computeTotalsFor(name){
  var dim = daysInMonth(state.year, state.month);
  var m = {g:0,b:0,w:0}, y = {g:0,b:0,w:0}, anyY=0;
  for (var d=1; d<=dim; d++){
    var vM = (state.data[name].MTD[d] || {g:0,b:0,w:0});
    m.g += vM.g|0; m.b += vM.b|0; m.w += vM.w|0;
    var vY = (state.data[name].YTD[d] || {g:0,b:0,w:0});
    y.g += vY.g|0; y.b += vY.b|0; y.w += vY.w|0;
    if ((vY.g|0)||(vY.b|0)||(vY.w|0)) anyY=1;
  }
  if (!anyY){ y = {g:m.g, b:m.b, w:m.w}; }
  return {mtd:m, ytd:y};
}

/* PUSH (simple POST) */
function save(localOnly){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  renderAsOf();
  if (!localOnly && PUSH && FEED_URL){
    var url = FEED_URL + (FEED_URL.indexOf('?')>-1 ? '&':'?') + 'key=' + encodeURIComponent(PUSHKEY);
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.setRequestHeader('Content-Type','text/plain;charset=utf-8');
    xhr.onreadystatechange = function(){
      if (DEBUG && xhr.readyState===4){ showDbg(xhr.status===200?'PUSH ok':'PUSH fail '+xhr.status, xhr.status===200); }
    };
    try { xhr.send(JSON.stringify(state)); } catch(e){}
  }
}

/* JSONP pull (no CORS) */
function jsonp(url, onsuccess, onerror){
  var cb = 'CB' + String(Math.random()).slice(2);
  window[cb] = function(payload){ cleanup(); onsuccess && onsuccess(payload); };
  function cleanup(){ try{ delete window[cb]; }catch(e){ window[cb]=undefined; } if (tag && tag.parentNode) tag.parentNode.removeChild(tag); }
  var tag = document.createElement('script');
  tag.src = url + (url.indexOf('?')>-1?'&':'?') + 'callback=' + cb + '&t=' + Date.now();
  tag.onerror = function(){ cleanup(); onerror && onerror(); };
  document.head.appendChild(tag);
}
function pullOnce(cb){
  if (!FEED_URL){ cb && cb(false); return; }
  jsonp(FEED_URL, function(remote){
    if (remote && remote.names && remote.data){
      var before = JSON.stringify(state);
      for (var k in remote) state[k] = remote[k];
      ensureSkeleton();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      var changed = (JSON.stringify(state)!==before);
      var live = document.getElementById('live'); if (live) live.style.display='inline-block';
      if (DEBUG) showDbg('PULL ok ' + new Date().toLocaleTimeString(), true);
      cb && cb(changed);
    } else { if (DEBUG) showDbg('PULL empty', false); cb && cb(false); }
  }, function(){ if (DEBUG) showDbg('PULL error', false); cb && cb(false); });
}

/* ===== Row auto-fit so the board contracts/extends to names ===== */
function autoFitRows(){
  var rows = (state.names ? state.names.length : 0) * 3; if (rows<1) rows=1;
  var stageH = window.innerHeight;

  var chrome = document.querySelector('.chrome');
  var legend = document.querySelector('.legend');
  var content = document.querySelector('.content');
  var thead = document.querySelector('#grid thead');

  var chromeH = chrome ? chrome.offsetHeight : 0;
  var legendH = legend ? legend.offsetHeight : 0;
  var padTop = parseInt(getComputedStyle(content).paddingTop,10) || 0;
  var padBot = parseInt(getComputedStyle(content).paddingBottom,10) || 0;
  var headerH = thead ? thead.offsetHeight : 34;

  // leave a small safety margin for borders
  var avail = stageH - chromeH - legendH - padTop - padBot - headerH - 6;
  var rowH = Math.floor(avail / rows);

  // keep readable bounds
  if (rowH > 56) rowH = 56;
  if (rowH < 22) rowH = 22;

  document.documentElement.style.setProperty('--rowH', rowH + 'px');
}

/* ===== Rendering ===== */
var gridEl = document.getElementById('grid');

function render(){
  ensureSkeleton();
  var dim = daysInMonth(state.year, state.month);

  // widths
  var frame = document.querySelector('.frame');
  var avail = frame.clientWidth;
  var fixedLeft = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--roleW'),10) +
                  parseInt(getComputedStyle(document.documentElement).getPropertyValue('--typeW'),10);
  var rcolW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--rcolW'),10);
  var suffixCols = 2; // MTD + YTD only
  var usable = avail - fixedLeft - suffixCols*rcolW - 2;
  var cellW = Math.max(30, Math.floor(usable / dim));
  document.documentElement.style.setProperty('--cellW', cellW + 'px');

  var html = '';
  html += '<thead><tr>';
  html += '<th class="name">Sales Specialist</th>';
  html += '<th class="type">Type</th>';
  for (var d=1; d<=dim; d++){
    var isToday = (state.year===today.getFullYear() && state.month===today.getMonth() && d===today.getDate());
    html += '<th class="daynum' + (isToday?' today':'') + '">' + d + '</th>'; // .today has no styling now
  }
  html += '<th class="rcol">MTD</th><th class="rcol">YTD</th>';
  html += '</tr></thead>';

  html += '<tbody>';
  for (var i=0;i<state.names.length;i++){
    var name = state.names[i];
    var totals = computeTotalsFor(name);
    var rows = [
      {key:'g', cls:'row-new', label:'New'},
      {key:'b', cls:'row-po',  label:'Pre-Owned'},
      {key:'w', cls:'row-wt',  label:'Winter Tire'}
    ];
    for (var r=0; r<rows.length; r++){
      var R = rows[r];
      html += '<tr class="'+R.cls+'">';
      if (r===0){
        html += '<td class="name nameCell" data-name="' + encodeURIComponent(name) + '" rowspan="3" title="Click to rename">' + name + '</td>';
      }
      html += '<td class="type"><span class="tag-'+(R.key==='g'?'new':R.key==='b'?'po':'wt')+'">'+R.label+'</span></td>';

      for (var d2=1; d2<=dim; d2++){
        var v = (state.data[name].MTD[d2] || {g:0,b:0,w:0});
        var n = v[R.key] || '';
        var isToday2 = (state.year===today.getFullYear() && state.month===today.getMonth() && d2===today.getDate());
        html += '<td class="cell' + (isToday2?' today':'') + '" data-name="' + encodeURIComponent(name) + '" data-cat="' + R.key + '" data-day="' + d2 + '">';
        html += n ? '<span class="num">'+ n +'</span>' : '<span class="num" style="visibility:hidden">0</span>';
        html += '</td>';
      }
      // Right-side MTD/YTD for this category
      var m = totals.mtd[R.key]||0, y = totals.ytd[R.key]||0;
      html += '<td class="rcol">' + m + '</td><td class="rcol">' + y + '</td>';
      html += '</tr>';
    }
  }
  html += '</tbody>';

  gridEl.innerHTML = html;

  // Bind clicks
  var tds = gridEl.querySelectorAll('td.cell');
  for (var j=0;j<tds.length;j++){ (function(td){ td.addEventListener('click', function(){ openEditor(td); }); })(tds[j]); }
  var nameTds = gridEl.querySelectorAll('td.nameCell');
  for (var k=0;k<nameTds.length;k++){ (function(td){ td.addEventListener('click', function(){ openRenameFromName(td); }); })(nameTds[k]); }

  autoFitRows(); /* <-- adjust row height to current number of names */
}

function renderAsOf(){
  var el = document.getElementById('asof');
  var d = new Date();
  var ts = d.toLocaleString(undefined,{hour:'numeric', minute:'2-digit'}) + ' on ' + d.toLocaleDateString(undefined,{year:'numeric', month:'long', day:'numeric'});
  var boardMonth = new Date(state.year, state.month, 1).toLocaleDateString(undefined,{month:'long', year:'numeric'});
  el.innerHTML = '<strong>' + boardMonth + '</strong> &nbsp;•&nbsp; Information current as of ' + ts;
}

/* ===== Editor / Names / Month ===== */
var editor = document.getElementById('editor');
var inG = document.getElementById('inG'), inB = document.getElementById('inB'), inW = document.getElementById('inW');
var editorTitle = document.getElementById('editorTitle');
var nameField = document.getElementById('nameField');
var monthSel = document.getElementById('monthSel'), yearInput = document.getElementById('yearInput');

var current = null, renameTarget = null;

function placeEditor(){ editor.style.display = 'block'; }
function openEditor(td){
  var name = decodeURIComponent(td.getAttribute('data-name'));
  var cat  = td.getAttribute('data-cat'); // 'g' | 'b' | 'w'
  var day  = +td.getAttribute('data-day');
  var v = (state.data[name].MTD[day] || {g:0,b:0,w:0});
  inG.value = v.g||0; inB.value = v.b||0; inW.value = v.w||0;
  var catName = (cat==='g'?'New':cat==='b'?'Pre-Owned':'Winter Tire');
  editorTitle.textContent = 'Edit — ' + name + ' • Day ' + day + ' (' + catName + ')';
  current = {name:name, day:day};
  renameTarget = null;
  placeEditor(); (cat==='g'?inG:cat==='b'?inB:inW).focus(); (cat==='g'?inG:cat==='b'?inB:inW).select();
}
function openRenameFromName(td){
  var name = decodeURIComponent(td.getAttribute('data-name'));
  current = {name:name, day:1};
  renameTarget = name;
  nameField.value = name;
  editorTitle.textContent = 'Rename — ' + name;
  placeEditor(); nameField.focus(); nameField.select();
}

document.getElementById('cancelEdit').onclick = function(){ editor.style.display='none'; renameTarget=null; };
document.getElementById('saveEdit').onclick = function(){
  if (!current) return;
  if (!state.data[current.name]) state.data[current.name] = {MTD:{}, YTD:{}};
  if (!state.data[current.name].MTD[current.day]) state.data[current.name].MTD[current.day] = {g:0,b:0,w:0};
  state.data[current.name].MTD[current.day] = { g:Number(inG.value||0), b:Number(inB.value||0), w:Number(inW.value||0) };
  save(false); render(); editor.style.display='none';
};

document.getElementById('addNameBtn').onclick = function(){
  var nm = (nameField.value||'').trim(); if (!nm) return;
  if (state.names.indexOf(nm)!==-1){ alert('Name already exists.'); return; }
  state.names.push(nm); ensureSkeleton(); save(false); render();
  nameField.value='';
};
document.getElementById('renameBtn').onclick = function(){
  var nm=(nameField.value||'').trim(); var src = renameTarget || (current && current.name); if (!nm||!src) return;
  if (state.names.indexOf(nm)!==-1){ alert('Name already exists.'); return; }
  var idx=state.names.indexOf(src); if (idx>=0){
    state.names[idx]=nm; state.data[nm]=state.data[src]; delete state.data[src];
    if(current) current.name=nm; if(renameTarget) renameTarget=nm; save(false); render(); nameField.value='';
  }
};

/* Month selector */
(function(){ var months=[],i; for(i=0;i<12;i++){ months.push(new Date(2000,i,1).toLocaleString(undefined,{month:'long'})); }
  var opts=''; for(i=0;i<12;i++){ opts+='<option value="'+i+'">'+months[i]+'</option>'; }
  monthSel.innerHTML=opts; monthSel.value=String(state.month); yearInput.value=String(state.year);
})();
document.getElementById('applyMonthBtn').onclick = function(){
  var m=Number(monthSel.value||state.month), y=Number(yearInput.value||state.year);
  if (isFinite(m)) state.month=m; if (isFinite(y)) state.year=y;
  ensureSkeleton(); save(false); render(); renderAsOf();
};

/* Keyboard shortcuts */
window.addEventListener('keydown', function(e){ if (editor.style.display==='block'){ if (e.key==='Escape') editor.style.display='none'; if (e.key==='Enter') document.getElementById('saveEdit').click(); }});

/* Debug banner */
function showDbg(msg, good){ var el=document.getElementById('dbg'); if (!DEBUG){ el.style.display='none'; return; } el.textContent=msg; el.className='dbg ' + (good?'good':'bad'); el.style.display='block'; }

/* Boot + polling */
renderAsOf(); render(); autoFitRows();

if (FEED_URL){
  pullOnce(function(changed){ if (changed){ render(); renderAsOf(); autoFitRows(); } });
  setInterval(function(){ pullOnce(function(ok){ if (ok){ render(); renderAsOf(); autoFitRows(); } }); }, POLL_MS);
}
window.addEventListener('resize', function(){ render(); autoFitRows(); });

/* JSONP helpers (kept last for older engines) */
function pullOnce(cb){
  if (!FEED_URL){ cb && cb(false); return; }
  jsonp(FEED_URL, function(remote){
    if (remote && remote.names && remote.data){
      var before = JSON.stringify(state);
      for (var k in remote) state[k]=remote[k];
      ensureSkeleton();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      var changed = (JSON.stringify(state)!==before);
      var live = document.getElementById('live'); if (live) live.style.display='inline-block';
      if (DEBUG) showDbg('PULL ok ' + new Date().toLocaleTimeString(), true);
      cb && cb(changed);
    } else { if (DEBUG) showDbg('PULL empty', false); cb && cb(false); }
  }, function(){ if (DEBUG) showDbg('PULL error', false); cb && cb(false); });
}
function jsonp(url, onsuccess, onerror){
  var cb = 'CB' + String(Math.random()).slice(2);
  window[cb] = function(payload){ cleanup(); onsuccess && onsuccess(payload); };
  function cleanup(){ try{ delete window[cb]; }catch(e){ window[cb]=undefined; } if (tag && tag.parentNode) tag.parentNode.removeChild(tag); }
  var tag = document.createElement('script');
  tag.src = url + (url.indexOf('?')>-1?'&':'?') + 'callback=' + cb + '&t=' + Date.now();
  tag.onerror = function(){ cleanup(); onerror && onerror(); };
  document.head.appendChild(tag);
}
</script>
</body>
</html>
