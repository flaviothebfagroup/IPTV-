<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>BFA IPTV â€” Remote</title>

  <!-- QR library -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0c;--fg:#fff;--muted:#9a9aa0;--panel:#121214;--border:rgba(255,255,255,.14);
      --accent:#ff9500;--tile:#17171a;--tileActive:#1d1d21;--shadow:0 18px 48px rgba(0,0,0,.45);
      --radius:18px;--radius-lg:22px;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444
    }
    body.light{
      --bg:#f5f5f7;--fg:#111;--muted:#6e6e73;--panel:#fff;--border:rgba(0,0,0,.12);
      --tile:#f2f2f7;--tileActive:#eaeaef;--shadow:0 14px 36px rgba(0,0,0,.10)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;margin:0}
    a{color:inherit;text-decoration:none}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .lhs{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{width:34px;height:34px;border-radius:10px;background:var(--tile) center/contain no-repeat;border:1px solid var(--border)}
    .title{font-weight:900;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .nav{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;padding:2px 0;mask-image:linear-gradient(90deg,transparent 0,black 16px,black calc(100% - 16px),transparent 100%)}
    .nav::-webkit-scrollbar{display:none}

    .btn{height:34px;padding:0 12px;border-radius:12px;border:1px solid var(--border);background:var(--tile);color:var(--fg);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap}
    .btn.primary{border-color:var(--accent);color:var(--accent);background:transparent}
    .btn.solid{background:var(--accent);color:#000;border-color:var(--accent)}
    .btn.danger{border-color:#ff6b6b;color:#ff6b6b;background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .muted{color:var(--muted);font-size:12px}

    /* Hamburger */
    #menuBtn{display:none}
    @media (max-width:900px){
      .nav{display:none}         /* hide inline nav on small screens */
      #menuBtn{display:inline-flex}
    }

    /* Shell */
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow)}
    h2{margin:0 0 8px}

    /* Inputs */
    .row3{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin:8px 0}
    .row3 .actions{display:flex;align-items:end;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .input,.select{width:100%;padding:10px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--fg);font-size:14px;outline:none}
    .input::placeholder{color:var(--muted)}

    /* Iframe */
    .frameWrap{margin-top:8px;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:var(--tile)}
    .frameBar{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-bottom:1px solid var(--border)}
    .frameBar .url{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .frame{width:100%;height:62vh;border:0}
    @media (max-height:700px){ .frame{height:58vh} }

    /* Dialogs / Hamburger menu sheet */
    dialog{border:0;padding:0;background:transparent}
    .sheet{background:var(--panel);border:1px solid var(--border);border-radius:18px;max-width:560px;width:92vw;padding:14px;margin:10vh auto 0;box-shadow:var(--shadow)}
    .sheet h3{margin:0 0 10px}
    .sheet .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:420px){ .sheet .grid{grid-template-columns:1fr} }
    .sheet .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}

    /* QR modal */
    .modal{background:var(--panel);border:1px solid var(--border);border-radius:18px;max-width:520px;width:96vw;padding:16px}
    .qrBox{display:grid;place-items:center;padding:12px;border:1px dashed var(--border);border-radius:12px;background:var(--tile)}
    .qrFooter{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    /* Toast */
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:9px 14px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;pointer-events:none;z-index:999}
    .toast.show{opacity:1}
    .toast.err{background:#ff453a;color:#fff}

    /* Small phones (mini) */
    @media (max-width:520px){
      .btn{height:32px;padding:0 10px;font-size:12px;border-radius:10px}
      .row3{grid-template-columns:1fr;gap:8px}
      .row3 .actions{justify-content:stretch}
      .row3 .actions .btn{flex:1}
      .frame{height:60vh}
      .frameBar .url{display:none}
      .wrap{padding:10px}
      .card{padding:12px}
      .topbar{padding:10px}
      .logo{width:30px;height:30px}
    }
    @media (max-width:360px){
      .title{font-size:14px}
      .btn{font-size:11px}
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="lhs">
      <a href="home.html" title="Home"><div id="brandLogo" class="logo"></div></a>
      <div class="title">BFA IPTV â€” Remote</div>
    </div>

    <!-- Desktop/tablet nav -->
    <div class="nav" aria-label="Primary">
      <a class="btn" href="home.html">Home</a>
      <a class="btn" href="dealerships.html">Dealerships</a>
      <a class="btn" href="displays.html">Displays</a>
      <a class="btn" href="users.html">Users</a>
      <a class="btn" href="analytics.html">Analytics</a>
      <a class="btn" href="links.html">Links</a>
      <a class="btn" href="schedule.html">Schedule</a>
      <button class="btn themeBtn">â˜€ï¸Ž/ðŸŒ™</button>
      <button class="btn primary signOutBtn">Sign out</button>
    </div>

    <!-- Hamburger (mobile) -->
    <button id="menuBtn" class="btn" aria-label="Menu" aria-expanded="false">â˜°</button>
  </div>

  <!-- Hamburger menu sheet -->
  <dialog id="menuDlg" aria-label="Menu">
    <div class="sheet">
      <h3>Menu</h3>
      <div class="grid" role="menu">
        <a class="btn" role="menuitem" href="home.html">Home</a>
        <a class="btn" role="menuitem" href="dealerships.html">Dealerships</a>
        <a class="btn" role="menuitem" href="displays.html">Displays</a>
        <a class="btn" role="menuitem" href="users.html">Users</a>
        <a class="btn" role="menuitem" href="analytics.html">Analytics</a>
        <a class="btn" role="menuitem" href="links.html">Links</a>
        <a class="btn" role="menuitem" href="schedule.html">Schedule</a>
      </div>
      <div class="row">
        <button class="btn themeBtn">â˜€ï¸Ž/ðŸŒ™</button>
        <button class="btn primary signOutBtn">Sign out</button>
        <button id="closeMenu" class="btn">Close</button>
      </div>
    </div>
  </dialog>

  <div class="wrap">
    <!-- Auth gate -->
    <div id="loginBox" class="card" style="max-width:520px;margin:24px auto;display:none">
      <h2>Admin Sign In</h2>
      <div class="row3" style="grid-template-columns:1fr 1fr auto">
        <div><div class="label">Email</div><input id="email" class="input" type="email" placeholder="you@company.com" autocomplete="email"/></div>
        <div><div class="label">Password</div><input id="password" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/></div>
        <div class="actions"><button id="loginBtn" class="btn solid">Sign in</button><button id="resetBtn" class="btn">Reset</button></div>
      </div>
      <div class="muted" style="font-size:12px">Requires <b>role: "admin"</b> in <code>/user/{uid}</code>.</div>
    </div>

    <div id="notAdmin" class="card" style="display:none;max-width:720px;margin:24px auto">
      <h2>Not authorized</h2>
      <div class="muted" style="font-size:12px">Ask an admin to set your role to <b>admin</b> in the database.</div>
    </div>

    <!-- Remote -->
    <div id="remotePg" style="display:none">
      <div class="card">
        <h2>Share the Remote</h2>
        <div class="row3" style="margin-top:6px">
          <div>
            <div class="label">Dealership (optional)</div>
            <input id="dealerId" class="input" placeholder="e.g., genesiswinnipeg"/>
          </div>
          <div>
            <div class="label">Display ID (optional)</div>
            <input id="displayId" class="input" placeholder="e.g., GW-001"/>
          </div>
          <div class="actions">
            <button id="btnOpen" class="btn">Open</button>
            <button id="btnShare" class="btn solid">Share</button>
            <button id="btnQR" class="btn">QR</button>
          </div>
        </div>

        <div class="frameWrap">
          <div class="frameBar">
            <div id="urlText" class="url">https://flaviothebfagroup.github.io/IPTV-/remote-control.html</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnCopy" class="btn">Copy</button>
              <button id="btnReloadFrame" class="btn">Reload</button>
            </div>
          </div>
          <iframe id="remoteFrame" class="frame" referrerpolicy="no-referrer-when-downgrade" loading="lazy"></iframe>
        </div>
        <div class="muted" style="margin-top:6px;font-size:12px">
          Tip: fill <b>Display ID</b> or <b>Dealership</b> to build a targeted link. People can scan the QR with their phone.
        </div>
      </div>
    </div>
  </div>

  <!-- QR modal -->
  <dialog id="qrDlg">
    <div class="modal">
      <h3 style="margin:0 0 8px">Scan to open remote</h3>
      <div id="qrBox" class="qrBox" style="min-height:220px"></div>
      <div id="qrUrl" class="muted" style="margin-top:10px;font-size:12px;word-break:break-all"></div>
      <div class="qrFooter">
        <button id="btnDownloadQR" class="btn">Download PNG</button>
        <button id="btnCloseQR" class="btn solid">Close</button>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword,
      onAuthStateChanged, sendPasswordResetEmail, signOut
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ====== CONFIG ======
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };
    const LOGO_URL = "https://flaviothebfagroup.github.io/IPTV-/icons/icon-512.png";
    const REMOTE_BASE = "https://flaviothebfagroup.github.io/IPTV-/remote-control.html";

    // ====== APP ======
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const $ = s => document.querySelector(s);
    function toast(msg, err=false){ const t=$('#toast'); t.textContent=msg; t.className='toast show'+(err?' err':''); setTimeout(()=>t.classList.remove('show'),2200); }

    // Theme + logo
    const savedTheme = localStorage.getItem('iptv_theme') || 'light';
    document.body.classList.toggle('light', savedTheme==='light');
    const toggleTheme = ()=>{
      const isLight = !document.body.classList.contains('light');
      document.body.classList.toggle('light', isLight);
      localStorage.setItem('iptv_theme', isLight ? 'light' : 'dark');
    };
    document.querySelectorAll('.themeBtn').forEach(b=> b.addEventListener('click', toggleTheme));
    $('#brandLogo').style.backgroundImage = `url("${LOGO_URL}")`;

    // Hamburger menu
    const menuBtn = $('#menuBtn');
    const menuDlg = $('#menuDlg');
    const closeMenu = $('#closeMenu');

    function openMenu(){
      menuDlg.showModal();
      menuBtn.setAttribute('aria-expanded','true');
    }
    function closeMenuFn(){
      if(menuDlg.open) menuDlg.close();
      menuBtn.setAttribute('aria-expanded','false');
    }
    menuBtn.addEventListener('click', openMenu);
    closeMenu.addEventListener('click', closeMenuFn);
    menuDlg.addEventListener('click', (e)=>{ if(e.target === menuDlg) closeMenuFn(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenuFn(); });

    // Sign out (both places)
    document.querySelectorAll('.signOutBtn').forEach(b=> b.addEventListener('click', ()=> signOut(auth)));

    // Auth
    $('#loginBtn').addEventListener('click', doLogin);
    $('#resetBtn').addEventListener('click', async ()=>{
      const email = $('#email').value.trim();
      if(!email) return toast('Enter email', true);
      try{ await sendPasswordResetEmail(auth, email); toast('Reset sent'); }catch(e){ toast('Reset failed', true); }
    });

    async function doLogin(){
      const email=$('#email').value.trim(), pass=$('#password').value;
      if(!email||!pass) return toast('Fill email & password', true);
      try{ await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth,email,pass); }
      catch(e){ console.error(e); toast('Sign-in failed', true); }
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ showGate('login'); return; }
      try{
        const u = (await get(ref(db, `user/${user.uid}`))).val()||{};
        if(u.role!=='admin'){ showGate('notAdmin'); return; }
      }catch(_){}
      showGate('ok');
      updateUrlAndFrame();
    });

    function showGate(which){
      $('#loginBox').style.display = which==='login' ? 'block':'none';
      $('#notAdmin').style.display = which==='notAdmin' ? 'block':'none';
      $('#remotePg').style.display = which==='ok' ? 'block':'none';
    }

    // ====== URL builder ======
    function buildRemoteUrl(){
      const d = $('#dealerId').value.trim();
      const x = $('#displayId').value.trim();
      let url = REMOTE_BASE;
      const params = new URLSearchParams();
      if(x) params.set('display', x);
      else if(d) params.set('dealership', d);
      const qs = params.toString();
      if(qs) url += `?${qs}`;
      return url;
    }

    function updateUrlAndFrame(){
      const url = buildRemoteUrl();
      $('#urlText').textContent = url;
      $('#remoteFrame').src = url;
    }

    ['dealerId','displayId'].forEach(id=> $('#'+id).addEventListener('input', updateUrlAndFrame));
    $('#btnReloadFrame').addEventListener('click', updateUrlAndFrame);
    $('#btnOpen').addEventListener('click', ()=> window.open(buildRemoteUrl(), '_blank','noopener'));

    // Share & copy
    $('#btnShare').addEventListener('click', async ()=>{
      const url = buildRemoteUrl();
      try{
        if(navigator.share){
          await navigator.share({ title:'BFA IPTV â€” Remote', url });
        }else{
          await navigator.clipboard.writeText(url);
          toast('Link copied');
        }
      }catch(e){
        await navigator.clipboard.writeText(url);
        toast('Link copied');
      }
    });

    $('#btnCopy').addEventListener('click', async ()=>{
      const url = buildRemoteUrl();
      try{ await navigator.clipboard.writeText(url); toast('Copied'); }catch(e){ toast('Copy failed', true); }
    });

    // QR Code
    let qr=null;
    $('#btnQR').addEventListener('click', ()=>{
      const url = buildRemoteUrl();
      $('#qrUrl').textContent = url;
      const box = $('#qrBox'); box.innerHTML='';
      qr = new QRCode(box, { text:url, width:220, height:220, colorDark:"#000000", colorLight:"#ffffff", correctLevel: QRCode.CorrectLevel.M });
      $('#qrDlg').showModal();
    });
    $('#btnCloseQR').addEventListener('click', ()=> $('#qrDlg').close());
    $('#btnDownloadQR').addEventListener('click', ()=>{
      const img = $('#qrBox').querySelector('canvas') || $('#qrBox').querySelector('img');
      if(!img) return;
      let dataURL = img.tagName==='CANVAS' ? img.toDataURL('image/png') : img.src;
      const a=document.createElement('a'); a.href=dataURL; a.download='bfa-remote-qr.png'; a.click();
    });
  </script>
</body>
</html>
