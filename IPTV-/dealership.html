<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BFA IPTV ‚Äî Dealerships</title>
  <link rel="stylesheet" href="assets/ui.css"/>
</head>
<body>
  <div class="topbar">
    <div class="lhs">
      <div id="brandLogo" class="logo" title="IPTV"></div>
      <div class="title">Dealerships</div>
    </div>
    <div class="rhs" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <a class="btn" href="home.html">‚Üê Home</a>
      <span id="adminEmail" class="muted"></span>
      <button id="themeBtn" class="btn">‚òÄÔ∏é/üåô</button>
      <a class="btn primary" href="display.html">Displays</a>
      <a class="btn primary" href="user.html">Users</a>
      <button id="signOutBtn" class="btn primary">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px">Dealerships</h2>
      <div class="small muted">Create, edit public name, rename ID (migrates displays & users), delete</div>

      <div class="row2" style="margin-top:12px">
        <div>
          <div class="label">New dealership name</div>
          <input id="dealerName" class="input" placeholder="e.g., Genesis Winnipeg" />
        </div>
        <div style="display:flex;align-items:end;gap:8px">
          <button id="addDealerBtn" class="btn solid">Add</button>
          <button id="dealersReload" class="btn">Reload</button>
        </div>
      </div>
      <div class="small muted">Creates <code>/dealership/{id}</code> and <code>/dealershipPublic/{id}</code>. ID is generated from name.</div>

      <ul id="dealerList" class="list" style="margin-top:10px"></ul>
      <div id="dealerEmpty" class="empty" style="display:none">No dealerships.</div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script type="module">
    import { setupTheme, guardAdminOrRedirect, auth, db, $, $$, htmlEscape, toast, makeDealerId, migrateDealerId } from './assets/core.js';
    import { signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { ref, get, set, update, remove, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    setupTheme();
    await guardAdminOrRedirect();
    document.getElementById('signOutBtn').addEventListener('click', ()=>signOut(auth));

    async function createDealership(name){
      const id = makeDealerId(name);
      const dealer = { name, createdAt: Date.now(), createdBy: auth.currentUser?.email || 'admin', displays: {} };
      await set(ref(db, `dealership/${id}`), dealer);
      await set(ref(db, `dealershipPublic/${id}`), { name });
    }

    async function countDisplaysForDealer(did){
      let n=0;
      try{
        const m=await get(ref(db,`dealership/${did}/displays`)); if(m.exists()) n=Object.keys(m.val()||{}).length;
        if(n===0){ const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(did)); const q=await get(qRef); if(q.exists()) n=Object.keys(q.val()||{}).length; }
      }catch(e){}
      return n;
    }

    async function refreshDealers(){
      const list = $('#dealerList'); list.innerHTML='';

      let map={};
      try{ const pub=await get(ref(db,'dealershipPublic')); if(pub.exists()) map=pub.val(); }catch(e){}
      if(!map || Object.keys(map).length===0){
        try{ const d=await get(ref(db,'dealership')); if(d.exists()){ const raw=d.val(); for(const id of Object.keys(raw)) map[id]={name:raw[id]?.name||id}; } }catch(e){}
      }
      const ids=Object.keys(map||{}).sort();
      $('#dealerEmpty').style.display = ids.length? 'none':'block';

      for(const id of ids){
        const name=map[id]?.name||id;
        const count=await countDisplaysForDealer(id);
        const li=document.createElement('li'); li.className='item';
        li.innerHTML=`
          <div class="col">
            <div class="split">
              <b>${htmlEscape(name)}</b>
              <span class="tag">${htmlEscape(id)}</span>
              <span class="small muted">${count} TV${count===1?'':'s'}</span>
            </div>
          </div>
          <div class="split">
            <a class="btn" href="display.html#${htmlEscape(id)}">Displays</a>
            <a class="btn" href="user.html#${htmlEscape(id)}">Users</a>
            <button class="btn" data-editname="${id}" data-name="${htmlEscape(name)}">Edit Name</button>
            <button class="btn" data-rename="${id}" data-name="${htmlEscape(name)}">Rename ID</button>
            <button class="btn danger" data-del="${id}">Delete</button>
          </div>`;
        list.appendChild(li);
      }

      // edit public name only
      list.querySelectorAll('[data-editname]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-editname');
          const current = btn.getAttribute('data-name');
          const next = prompt('Public display name', current||'');
          if(!next || next===current) return;
          try{
            await set(ref(db, `dealershipPublic/${id}`), { name: next });
            try{ await update(ref(db, `dealership/${id}`), { name: next }); }catch(_){}
            toast('Name updated');
            await refreshDealers();
          }catch(e){ console.error(e); toast('Update failed', true); }
        });
      });

      // rename ID (migrate)
      list.querySelectorAll('[data-rename]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-rename');
          const currentName = btn.getAttribute('data-name');
          const newId = prompt('New dealership ID (letters/numbers only):', id);
          if(!newId || newId===id) return;
          if(!confirm(`Migrate ${id} ‚Üí ${newId}? Displays and users will be updated.`)) return;
          try{ await migrateDealerId(id,newId,currentName); toast('Dealer ID renamed'); await refreshDealers(); }
          catch(e){ console.error(e); toast('Rename failed', true); }
        });
      });

      // delete
      list.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-del');
          const count=await countDisplaysForDealer(id);
          if(count>0){ alert(`This dealership still has ${count} display(s). Remove them first or migrate.`); return; }
          if(!confirm(`Delete ${id}?`)) return;
          try{ await remove(ref(db,`dealership/${id}`)); await remove(ref(db,`dealershipPublic/${id}`)); toast('Deleted'); await refreshDealers(); }
          catch(e){ console.error(e); toast('Delete failed', true); }
        });
      });
    }

    document.getElementById('addDealerBtn').addEventListener('click', async ()=>{
      const name = $('#dealerName').value.trim();
      if(!name) return toast('Enter a name', true);
      await createDealership(name).catch(()=>toast('Create failed',true));
      $('#dealerName').value='';
      await refreshDealers();
      toast('Dealership added');
    });
    document.getElementById('dealersReload').addEventListener('click', refreshDealers);

    refreshDealers();
  </script>
</body>
</html>
