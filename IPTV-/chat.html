<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BFA — Support Chat</title>

  <style>
    /* =========================================================
       Tokens (visual only — logic untouched)
    ========================================================= */
    :root{
      --accent:#ff9500;

      /* Gradient stops (your values) */
      --bg-start:#fff4e4;
      --bg-mid:#ffd293;
      --bg-end:#ff9500;

      --fg:#111;
      --muted:#6e6e73;

      /* Glass surfaces */
      --panel:rgba(255,255,255,.58);
      --tile:rgba(255,255,255,.46);
      --tileHover:rgba(255,149,0,.08);

      /* Borders + shadows */
      --border:rgba(15,23,42,.10);
      --borderStrong:rgba(15,23,42,.18);
      --shadow:0 14px 34px rgba(15,23,42,.08), 0 2px 8px rgba(15,23,42,.05);

      /* Glass tuning */
      --glass-blur:16px;
      --glass-sat:140%;
    }
    body.dark{
      --bg-start:#0b0c10;
      --bg-mid:#0d1016;
      --bg-end:#10141b;

      --fg:#f7f7f8;
      --muted:#a1a1a8;

      --panel:rgba(21,21,23,.56);
      --tile:rgba(26,26,29,.50);
      --tileHover:rgba(255,149,0,.10);

      --border:rgba(255,255,255,.10);
      --borderStrong:rgba(255,255,255,.20);
      --shadow:0 18px 46px rgba(0,0,0,.36), 0 2px 8px rgba(0,0,0,.22);

      --glass-blur:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;
      background:transparent; /* gradient is painted by ::before */
      overflow-x:hidden;
    }

    /* Full-viewport gradient (non-cropping) */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:linear-gradient(180deg,var(--bg-start) 0%, var(--bg-mid) 52%, var(--bg-end) 100%);
    }

    a{color:inherit;text-decoration:none}
    .muted{color:var(--muted)}

    /* =========================================================
       Topbar (frosted look, mobile-first)
    ========================================================= */
    .topbar{
      position:sticky; top:0; z-index:100;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px;
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    }
    .toprow{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logoImg{
      width:30px;height:30px;border-radius:8px;
      border:1px solid var(--border);
      background:#fff;
      display:block;
    }
    .logotxt{
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:42vw;
    }

    .actions{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .chip{
      height:36px;
      padding:0 12px;
      border-radius:9999px;
      border:1.5px solid var(--borderStrong);
      background:var(--tile);
      color:var(--fg);
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:transform .12s ease, filter .18s ease, border-color .18s ease;
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .chip:hover{border-color:var(--accent);transform:translateY(-1px);filter:brightness(1.03)}
    .chip.accent{background:transparent;border-color:var(--accent);color:var(--accent)}
    .ic{
      width:18px;height:18px;
      stroke:currentColor;
      stroke-width:2;
      fill:none;
      flex:0 0 auto;
    }

    /* =========================================================
       Centered chat card (mobile priority)
    ========================================================= */
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:14px;
      padding-bottom:calc(14px + env(safe-area-inset-bottom,0));
    }

    .chatCard{
      max-width:860px;
      margin:0 auto;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    }

    .chatHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,0));
    }
    body.dark .chatHead{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }

    .chatTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .chatTitle b{
      font-size:14px;
      font-weight:950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chatTitle span{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ✅ MOBILE FIX: use svh (safe viewport height) so container always has height */
    .chatBody{
      height: min(760px, calc(100svh - 168px));
      height: min(760px, calc(100vh - 168px)); /* fallback */
      background:rgba(255,255,255,.20);
    }
    body.dark .chatBody{ background:rgba(0,0,0,.12); }

    /* HubSpot inline embed containers */
    #hubspot-conversations-inline-parent,
    #hubspot-conversations-inline-iframe{
      width:100% !important;
      height:100% !important;
      border:0 !important;
      display:block !important;
    }

    /* Loading / fallback overlay */
    .loading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      text-align:center;
      color:var(--muted);
      font-size:13px;
    }
    .loading .box{
      max-width:520px;
      background:var(--tile);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 14px;
      box-shadow:0 10px 26px rgba(0,0,0,.10);
      backdrop-filter:blur(calc(var(--glass-blur) - 4px)) saturate(var(--glass-sat));
      -webkit-backdrop-filter:blur(calc(var(--glass-blur) - 4px)) saturate(var(--glass-sat));
    }
    .loading b{ color:var(--fg); }
    .loading .btnRow{ margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .miniBtn{
      height:34px;
      padding:0 12px;
      border-radius:9999px;
      border:1.5px solid var(--borderStrong);
      background:transparent;
      color:var(--fg);
      font-weight:900;
      cursor:pointer;
    }
    .miniBtn.primary{
      border-color:var(--accent);
      color:var(--accent);
    }

    @media (max-width:520px){
      .wrap{padding:12px}
      .chatCard{border-radius:18px}
      .chatBody{
        height: calc(100svh - 148px);
        height: calc(100vh - 148px);
      }
      .logotxt{max-width:46vw}
      .chip{padding:0 10px}
    }
  </style>

  <script>
    /**
     * HubSpot settings:
     * - inlineEmbedSelector mounts chat inside #chat
     * - loadImmediately: false (we control load for reliability)
     * - hideNewThreadLink: keeps the UI clean
     * - disableInitialInputFocus: avoids weird mobile keyboard popping immediately
     */
    window.hsConversationsSettings = {
      loadImmediately: false,
      inlineEmbedSelector: "#chat",
      hideNewThreadLink: true,
      disableInitialInputFocus: true
      // enableWidgetCookieBanner: true,  // optional
      // disableAttachment: true,         // optional
      // avoidInlineStyles: true          // optional
    };

    // Robust loader: handles cases where the SDK arrives late on mobile
    function ensureHubSpotLoaded({ openToNewThread = false } = {}) {
      const started = Date.now();
      const timeoutMs = 20000; // 20s

      const tick = () => {
        const api = window.HubSpotConversations;
        const hasWidget = api && api.widget && typeof api.widget.load === "function";

        if (hasWidget) {
          try {
            const status = api.widget.status ? api.widget.status() : { loaded: false };

            if (!status.loaded) {
              api.widget.load({ widgetOpen: true });
            }

            // If you want a fresh thread:
            if (openToNewThread && typeof api.widget.refresh === "function") {
              api.widget.refresh({ openToNewThread: true });
            }

            // In inline embed mode, open() is harmless but helps on some setups
            if (typeof api.widget.open === "function") {
              api.widget.open();
            }

            // hide loader
            document.getElementById("loading").style.display = "none";
            return;
          } catch (e) {
            // keep trying
          }
        }

        if (Date.now() - started > timeoutMs) {
          // show fallback help
          const msg = document.getElementById("fallbackMsg");
          if (msg) msg.style.display = "block";
          return;
        }

        setTimeout(tick, 300);
      };

      tick();
    }

    // Theme: query param ?dark=1 / ?light=1
    function initTheme() {
      const qs = new URLSearchParams(location.search);
      const forceDark = qs.get("dark") === "1";
      const forceLight = qs.get("light") === "1";
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (forceDark) document.body.classList.add("dark");
      else if (forceLight) document.body.classList.remove("dark");
      else if (prefersDark) document.body.classList.add("dark");
    }

    document.addEventListener("DOMContentLoaded", () => {
      initTheme();

      const qs = new URLSearchParams(location.search);
      const wantNew = qs.get("new") === "1";

      // Buttons
      const newBtn = document.getElementById("newChatBtn");
      const themeBtn = document.getElementById("themeBtn");
      const retryBtn = document.getElementById("retryBtn");

      newBtn.addEventListener("click", () => {
        ensureHubSpotLoaded({ openToNewThread: true });
      });

      themeBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
      });

      retryBtn.addEventListener("click", () => {
        document.getElementById("fallbackMsg").style.display = "none";
        ensureHubSpotLoaded({ openToNewThread: wantNew });
      });

      // Kick off load
      ensureHubSpotLoaded({ openToNewThread: wantNew });
    });

    // Use hsConversationsOnReady too (best practice)
    window.hsConversationsOnReady = [
      () => {
        const qs = new URLSearchParams(location.search);
        ensureHubSpotLoaded({ openToNewThread: qs.get("new") === "1" });
      }
    ];
  </script>

  <!-- HubSpot portal script (your existing one) -->
  <script async defer id="hs-script-loader" src="//js-na3.hs-scripts.com/342895404.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="toprow">
      <div class="brand">
        <img
          class="logoImg"
          src="/IPTV-/icons/icon-192.png"
          alt="BFA"
          onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2230%22 height=%2230%22 viewBox=%220 0 40 40%22%3E%3Crect width=%2240%22 height=%2240%22 rx=%229%22 fill=%22%23ff9500%22/%3E%3Ctext x=%2250%25%22 y=%2257%25%22 text-anchor=%22middle%22 font-size=%2214%22 font-family=%22system-ui%22 font-weight=%22900%22 fill=%22%23000%22%3EBFA%3C/text%3E%3C/svg%3E';"
        />
        <div class="logotxt">BFA Support</div>
      </div>

      <div class="actions">
        <button class="chip" id="newChatBtn" type="button" title="Start a new chat">
          <!-- Headset icon -->
          <svg class="ic" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 12a8 8 0 0 1 16 0"></path>
            <path d="M4 12v6a2 2 0 0 0 2 2h2v-6H6a2 2 0 0 1-2-2Z"></path>
            <path d="M20 12v6a2 2 0 0 1-2 2h-2v-6h2a2 2 0 0 0 2-2Z"></path>
            <path d="M12 20h1"></path>
          </svg>
          New
        </button>

        <button class="chip accent" id="themeBtn" type="button" title="Toggle dark mode">
          <svg class="ic" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M21 12.6A8.5 8.5 0 0 1 11.4 3a6.8 6.8 0 1 0 9.6 9.6Z"></path>
          </svg>
          Theme
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="chatCard">
      <div class="chatHead">
        <div class="chatTitle">
          <b>
            Live Chat Support
            <svg class="ic" viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;opacity:.9">
              <path d="M12 2a7 7 0 0 0-7 7v3a3 3 0 0 0 3 3h1v-6H8a1 1 0 0 0-1 1"></path>
              <path d="M12 2a7 7 0 0 1 7 7v3a3 3 0 0 1-3 3h-1v-6h2a1 1 0 0 1 1 1"></path>
              <path d="M12 19c2.2 0 4-1.3 4-3"></path>
            </svg>
          </b>
          <span class="muted">We usually reply quickly during business hours.</span>
        </div>
      </div>

      <div class="chatBody" style="position:relative;">
        <!-- HubSpot mounts here -->
        <div id="chat" style="width:100%;height:100%;"></div>

        <!-- Loader + fallback -->
        <div id="loading" class="loading">
          <div class="box">
            <b>Loading chat…</b><br/>
            <span class="muted">If it doesn’t appear in ~10 seconds, tap Retry.</span>

            <div class="btnRow" id="fallbackMsg" style="display:none;">
              <button class="miniBtn primary" id="retryBtn" type="button">Retry</button>
              <button class="miniBtn" type="button" onclick="location.href=location.href + (location.search ? '&' : '?') + 'new=1'">New thread</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</body>
</html>
