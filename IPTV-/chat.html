<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BFA Support — Live Chat</title>

<style>
  /* =========================================================
     Tokens (visual only)
  ========================================================= */
  :root{
    --accent:#ff9500;

    --bg-start:#fff4e4;
    --bg-mid:#ffd293;
    --bg-end:#ff9500;

    --fg:#111;
    --muted:#6e6e73;

    --panel:rgba(255,255,255,.58);
    --border:rgba(15,23,42,.10);
    --borderStrong:rgba(15,23,42,.18);
    --shadow:0 14px 34px rgba(15,23,42,.08), 0 2px 8px rgba(15,23,42,.05);

    --glass-blur:16px;
    --glass-sat:140%;
    --radius:18px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;
    background:transparent;
  }
  body::before{
    content:"";
    position:fixed; inset:0; z-index:-1; pointer-events:none;
    background:linear-gradient(180deg,var(--bg-start) 0%, var(--bg-mid) 52%, var(--bg-end) 100%);
  }

  a{color:inherit;text-decoration:none}
  .muted{color:var(--muted)}

  /* =========================================================
     Topbar
  ========================================================= */
  .topbar{
    position:sticky; top:0; z-index:100;
    background:var(--panel);
    border-bottom:1px solid var(--border);
    padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px;
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
  }
  .toprow{
    max-width:1100px;margin:0 auto;
    display:flex;align-items:center;gap:10px;
  }
  .brand{display:flex;align-items:center;gap:10px;min-width:0}
  .logo{
    width:34px;height:34px;border-radius:9px;
    border:1px solid var(--border);
    background:#fff center/cover no-repeat;
    flex:0 0 auto;
  }
  .logotxt{
    font-weight:900;letter-spacing:.2px;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    max-width:52vw;
  }

  .spacer{flex:1}

  /* Simple hamburger on right */
  #hamburger{
    border:0;background:transparent;
    color:var(--accent);
    width:42px;height:42px;border-radius:999px;
    display:inline-flex;align-items:center;justify-content:center;
    margin-left:auto;
  }
  #hamburger svg{width:22px;height:22px;stroke:var(--accent);stroke-width:2.6;fill:none}

  /* Desktop actions */
  .actions{display:flex;gap:8px;align-items:center}
  .chip{
    height:34px;min-width:34px;padding:0 12px;border-radius:9999px;
    border:1.5px solid var(--borderStrong);
    background:rgba(255,255,255,.46);
    color:var(--fg);font-weight:900;cursor:pointer;
    display:inline-flex;align-items:center;gap:8px;
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
  }
  .chip svg{width:18px;height:18px;stroke:currentColor;stroke-width:2;fill:none}

  @media (max-width:920px){
    .actions{display:none}
  }

  /* =========================================================
     Layout
  ========================================================= */
  .wrap{max-width:1100px;margin:0 auto;padding:16px; height:calc(100dvh - 68px);}
  @supports (height: 100svh){
    .wrap{ height:calc(100svh - 68px); }
  }

  .card{
    height:100%;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    overflow:hidden;

    display:flex;
    flex-direction:column;
  }

  .card-head{
    padding:16px 16px 12px;
    border-bottom:1px solid rgba(15,23,42,.08);
    display:flex;align-items:flex-start;gap:12px;
  }
  .card-title{
    font-size:34px;font-weight:950;line-height:1.05;margin:0;
    letter-spacing:-.02em;
  }
  .card-sub{margin-top:8px;color:var(--muted);font-weight:600}
  .online{
    margin-left:auto;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,.14);
    background:rgba(255,255,255,.58);
    display:flex;align-items:center;gap:10px;
    font-weight:900;
    white-space:nowrap;
  }
  .dot{width:10px;height:10px;border-radius:999px;background:#22c55e;box-shadow:0 0 10px rgba(34,197,94,.45)}

  /* Chat area */
  .chatArea{
    flex:1; min-height:0;
    position:relative;
    display:flex;
    flex-direction:column;
  }

  /* This is the ONLY “frame” we keep. No extra box-on-box. */
  #chatMount{
    flex:1; min-height:0;
    width:100%;
  }

  /* CRITICAL: force HubSpot inline iframe to fill */
  #hubspot-conversations-inline-parent{
    width:100% !important;
    height:100% !important;
    max-width:none !important;
    margin:0 !important;
    border-radius:0 !important;
    overflow:hidden !important;
    background:transparent !important;
  }
  #hubspot-conversations-inline-iframe{
    width:100% !important;
    height:100% !important;
    border:0 !important;
    display:block !important;
    background:transparent !important;
  }

  /* Mobile helper panel (shown if we choose non-inline mode or if user needs to tap open) */
  .helper{
    padding:16px;
    display:none;
  }
  .helper.show{display:block}
  .helperBox{
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.55);
    border-radius:16px;
    padding:14px;
    box-shadow:0 10px 24px rgba(15,23,42,.06);
  }
  .btnRow{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .btn{
    border:1.5px solid rgba(15,23,42,.18);
    background:rgba(255,255,255,.55);
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    display:inline-flex;align-items:center;gap:8px;
    cursor:pointer;
  }
  .btn.primary{
    border-color:var(--accent);
    background:rgba(255,149,0,.12);
    color:#111;
  }
  .btn svg{width:18px;height:18px;stroke:currentColor;stroke-width:2;fill:none}

  /* Toast */
  .toast{
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#ff453a;color:#fff;padding:10px 14px;border-radius:999px;
    font-weight:900; opacity:0; pointer-events:none; transition:opacity .22s ease;
    box-shadow:0 12px 26px rgba(0,0,0,.18);
    z-index:9999;
  }
  .toast.show{opacity:1}

  /* =========================================================
     Mobile sheet menu
  ========================================================= */
  #sheet{position:fixed; inset:0; z-index:9999; display:none;}
  #sheet.open{display:block}
  #sheet .back{position:absolute; inset:0; background:rgba(0,0,0,.42); backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px);}
  #sheet .panel{
    position:absolute; right:0; top:0; height:100%; width:min(86vw,360px);
    background:rgba(255,255,255,.92);
    border-left:1px solid rgba(15,23,42,.18);
    box-shadow:var(--shadow);
    padding:16px; display:flex; flex-direction:column; gap:12px;
    backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    -webkit-backdrop-filter:blur(var(--glass-blur)) saturate(var(--glass-sat));
    transform:translateX(100%); transition:transform .22s ease-out;
  }
  #sheet.open .panel{transform:translateX(0)}
  .sheetTitle{font-weight:950;font-size:16px}
</style>
</head>

<body>
  <header class="topbar">
    <div class="toprow">
      <div class="brand">
        <div class="logo" style="background-image:url('/IPTV-/icons/icon-192.png')"></div>
        <div class="logotxt">BFA Support</div>
      </div>

      <div class="spacer"></div>

      <div class="actions">
        <button class="chip" id="newBtn" type="button" title="New chat">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          New
        </button>
        <button class="chip" id="retryBtn" type="button" title="Retry loading chat">
          <svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-2.64-6.36"/><path d="M21 3v6h-6"/></svg>
          Retry
        </button>
      </div>

      <button id="hamburger" type="button" aria-label="Menu">
        <svg viewBox="0 0 24 24">
          <path d="M5 7h14M5 12h14M5 17h14"/>
        </svg>
      </button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="card-head">
        <div>
          <h1 class="card-title">Live Chat Support</h1>
          <div class="card-sub">We usually reply quickly during business hours. On mobile, tap <b>Open chat</b> if it doesn’t open automatically.</div>
        </div>
        <div class="online"><span class="dot"></span>Support Online</div>
      </div>

      <div class="chatArea">
        <!-- Mobile helper (used when inline embed isn't used or user needs a tap) -->
        <div class="helper" id="helper">
          <div class="helperBox">
            <div style="font-weight:950;font-size:18px">Open BFA Support Chat</div>
            <div class="muted" style="margin-top:6px" id="helperText">
              On iPhone/iPad, chat sometimes requires a tap to open.
            </div>
            <div class="btnRow">
              <button class="btn primary" id="openChatBtn" type="button">
                <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
                Open chat
              </button>
              <button class="btn" id="retryChatBtn" type="button">
                <svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-2.64-6.36"/><path d="M21 3v6h-6"/></svg>
                Retry
              </button>
            </div>
          </div>
        </div>

        <!-- Inline mount (desktop/tablet) -->
        <div id="chatMount"></div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">HubSpot chat script failed to load.</div>

  <!-- Mobile sheet -->
  <div id="sheet" aria-hidden="true">
    <div class="back" id="sheetBack"></div>
    <div class="panel">
      <div class="sheetTitle">Menu</div>
      <button class="btn" id="sheetNew" type="button">
        <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        New chat
      </button>
      <button class="btn" id="sheetRetry" type="button">
        <svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-2.64-6.36"/><path d="M21 3v6h-6"/></svg>
        Retry
      </button>
      <div class="muted" style="font-size:12px;line-height:1.3">
        If chat doesn’t load on some phones, it’s usually adblock/DNS blocking HubSpot domains.
      </div>
    </div>
  </div>

<script>
  // =========================================================
  // HubSpot loader + responsive behavior
  // =========================================================
  const PORTAL_ID = "342895404";
  const HUBLET = "na3";
  const SCRIPT_SRC = "https://js-" + HUBLET + ".hs-scripts.com/" + PORTAL_ID + ".js";

  const toast = document.getElementById('toast');
  const helper = document.getElementById('helper');
  const helperText = document.getElementById('helperText');
  const chatMount = document.getElementById('chatMount');

  const isSmallScreen = () => window.matchMedia("(max-width: 920px)").matches;

  // Desktop/tablet = inline embed; Mobile = normal widget (open on tap)
  function applyHsSettings(){
    const small = isSmallScreen();
    window.hsConversationsSettings = {
      loadImmediately: false,
      // Inline only on larger screens
      inlineEmbedSelector: small ? "" : "#chatMount",
      disableInitialInputFocus: true
    };
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 3600);
  }

  function ensureScriptLoaded(){
    return new Promise((resolve, reject)=>{
      // already loaded?
      if (window.HubSpotConversations) return resolve(true);

      // avoid duplicating tag
      const existing = document.getElementById('hs-script-loader');
      if (existing) {
        // wait a bit for it to appear
        const t0 = Date.now();
        const timer = setInterval(()=>{
          if (window.HubSpotConversations){
            clearInterval(timer);
            resolve(true);
          } else if (Date.now() - t0 > 12000){
            clearInterval(timer);
            reject(new Error("HubSpotConversations not available after wait"));
          }
        }, 250);
        return;
      }

      const s = document.createElement('script');
      s.id = "hs-script-loader";
      s.async = true;
      s.defer = true;
      s.src = SCRIPT_SRC;

      s.onload = () => resolve(true);
      s.onerror = () => reject(new Error("HubSpot script failed to load"));

      document.head.appendChild(s);
    });
  }

  function loadWidget(){
    if (!window.HubSpotConversations || !window.HubSpotConversations.widget) return false;
    try{
      window.HubSpotConversations.widget.load();
      return true;
    }catch(e){
      return false;
    }
  }

  function openWidget(){
    if (!window.HubSpotConversations || !window.HubSpotConversations.widget) return false;
    try{
      window.HubSpotConversations.widget.open();
      return true;
    }catch(e){
      return false;
    }
  }

  async function boot(){
    applyHsSettings();

    // On mobile, we keep the helper visible (tap-to-open is the most reliable path)
    helper.classList.toggle('show', isSmallScreen());

    try{
      await ensureScriptLoaded();

      // When ready, load the widget
      window.hsConversationsOnReady = window.hsConversationsOnReady || [];
      window.hsConversationsOnReady.push(function(){
        loadWidget();
      });

      // Also attempt a direct load (safe on most browsers)
      loadWidget();

      // Desktop/tablet inline: hide helper
      if (!isSmallScreen()){
        helper.classList.remove('show');
      } else {
        helperText.textContent = "On iPhone/iPad, tap Open chat to launch the full-screen chat.";
      }

      // If inline iframe exists, it will fill because of the CSS above.
      // If on mobile, user taps Open chat.
    }catch(err){
      helper.classList.add('show');
      helperText.textContent =
        "HubSpot chat couldn’t load. This is usually DNS/adblock/content blockers. " +
        "Allowlist: js-" + HUBLET + ".hs-scripts.com, js.hs-scripts.com, js.hs-analytics.net, api.usemessages.com";
      showToast("HubSpot chat failed to load (blocked by network/adblock?).");
    }
  }

  // Buttons
  document.getElementById('openChatBtn').addEventListener('click', async ()=>{
    try{
      await ensureScriptLoaded();
      loadWidget();
      const ok = openWidget();
      if (!ok) showToast("Tap again — iOS sometimes needs a second gesture.");
    }catch(e){
      showToast("HubSpot script blocked on this device/network.");
    }
  });

  function retryAll(){
    // Re-run boot (don’t spam scripts; ensureScriptLoaded handles existing)
    boot();
  }

  document.getElementById('retryChatBtn').addEventListener('click', retryAll);
  document.getElementById('retryBtn')?.addEventListener('click', retryAll);

  document.getElementById('newBtn')?.addEventListener('click', ()=>{
    // For “new chat” we can refresh, then open
    try{
      if (window.HubSpotConversations?.widget){
        window.HubSpotConversations.widget.refresh();
        window.HubSpotConversations.widget.open();
      }
    }catch(e){}
  });

  // Hamburger / sheet
  const sheet = document.getElementById('sheet');
  const sheetBack = document.getElementById('sheetBack');
  const hamburger = document.getElementById('hamburger');

  function openSheet(){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); }
  function closeSheet(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); }

  hamburger.addEventListener('click', openSheet);
  sheetBack.addEventListener('click', closeSheet);

  document.getElementById('sheetRetry').addEventListener('click', ()=>{ closeSheet(); retryAll(); });
  document.getElementById('sheetNew').addEventListener('click', ()=>{
    closeSheet();
    try{
      if (window.HubSpotConversations?.widget){
        window.HubSpotConversations.widget.refresh();
        window.HubSpotConversations.widget.open();
      }
    }catch(e){}
  });

  // Re-apply settings on resize (switch inline vs mobile mode)
  let resizeTimer = null;
  window.addEventListener('resize', ()=>{
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(()=>{ retryAll(); }, 250);
  });

  // boot
  boot();
</script>
</body>
</html>
