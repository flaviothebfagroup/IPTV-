<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BFA IPTV ‚Äî Users</title>
  <link rel="stylesheet" href="assets/ui.css"/>
</head>
<body>
  <div class="topbar">
    <div class="lhs">
      <div id="brandLogo" class="logo" title="IPTV"></div>
      <div class="title">Users</div>
    </div>
    <div class="rhs" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <a class="btn" href="home.html">‚Üê Home</a>
      <a class="btn" href="dealership.html">Dealerships</a>
      <a class="btn" href="display.html">Displays</a>
      <span id="adminEmail" class="muted"></span>
      <button id="themeBtn" class="btn">‚òÄÔ∏é/üåô</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px">Users</h2>
      <div class="row4">
        <div><div class="label">Email</div><input id="userEmail" class="input" placeholder="user@email.com" /></div>
        <div><div class="label">Name</div><input id="userName" class="input" placeholder="Full Name" /></div>
        <div><div class="label">Role</div>
          <select id="userRole" class="select">
            <option value="user">user</option><option value="admin">admin</option><option value="device">device</option>
          </select>
        </div>
        <div><div class="label">Dealership</div><select id="userDealer" class="select"><option value="">Dealership‚Ä¶</option></select></div>
      </div>
      <div class="row2">
        <button id="createUserBtn" class="btn solid">Create User (pwd: 123456789)</button>
        <button id="inviteUserBtn" class="btn">Send Reset (existing)</button>
      </div>
      <div class="row3">
        <div><div class="label">Search</div><input id="userSearch" class="input" placeholder="Search name or email‚Ä¶" /></div>
        <div><div class="label">Filter dealership</div><select id="filterDealer" class="select"><option value="">All dealerships</option></select></div>
        <div><div class="label">Filter role</div>
          <select id="filterRole" class="select">
            <option value="">All roles</option><option value="admin">admin</option><option value="device">device</option><option value="user">user</option><option value="disabled">disabled</option>
          </select>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin:8px 0;flex-wrap:wrap">
        <button id="findDupBtn" class="btn">Find duplicates</button>
        <button id="deleteDupBtn" class="btn danger">Delete selected duplicates</button>
        <span class="muted small">Duplicates = device users with the same name within a dealership. Green = currently active (updated last 10 min).</span>
      </div>
      <div id="dupBox" class="card" style="display:none;margin-bottom:10px">
        <h3 style="margin:0 0 6px">Duplicate candidates</h3>
        <div id="dupList" class="list"></div>
        <div class="small muted" id="dupEmpty" style="display:none">No duplicates found.</div>
      </div>

      <div class="group"><h3>Admins (<span id="countAdmins">0</span>)</h3><div class="user-grid" id="gridAdmins"></div></div>
      <div class="group"><h3>Device Users (<span id="countDevices">0</span>)</h3><div class="user-grid" id="gridDevices"></div></div>
      <div class="group"><h3>Regular Users (<span id="countUsers">0</span>)</h3><div class="user-grid" id="gridUsers"></div></div>
      <div class="group"><h3>Disabled (<span id="countDisabled">0</span>)</h3><div class="user-grid" id="gridDisabled"></div></div>
      <div id="userEmpty" class="empty" style="display:none">No users.</div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script type="module">
    import { setupTheme, guardAdminOrRedirect, auth, db, fb, $, $$, htmlEscape, toast, debounce } from './assets/core.js';
    import { ref, get, set, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { sendPasswordResetEmail, createUserWithEmailAndPassword, getAuth, signOut, initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    setupTheme();
    await guardAdminOrRedirect();

    // Load dealers for selects
    async function loadDealersMap(){
      let map={};
      try{ const pub=await get(ref(db,'dealershipPublic')); if(pub.exists()) map=Object.fromEntries(Object.entries(pub.val()).map(([k,v])=>[k,v?.name||k])); }catch(e){}
      if(!Object.keys(map).length){ try{ const d=await get(ref(db,'dealership')); if(d.exists()) map=Object.fromEntries(Object.entries(d.val()).map(([k,v])=>[k,v?.name||k])); }catch(e){} }
      const selF=$('#filterDealer'), selU=$('#userDealer'); const prevF=selF.value, prevU=selU.value;
      selF.innerHTML='<option value="">All dealerships</option>'; selU.innerHTML='<option value="">Dealership‚Ä¶</option>';
      for(const [id,name] of Object.entries(map).sort((a,b)=>a[1].localeCompare(b[1]))){
        const f=document.createElement('option'); f.value=id; f.textContent=name; selF.appendChild(f);
        const u=document.createElement('option'); u.value=id; u.textContent=name; selU.appendChild(u);
      }
      selF.value=location.hash? location.hash.slice(1): (prevF||'');
      selU.value=prevU||'';
      return map;
    }

    // Create user with secondary app, set default password
    async function createUserAdminSafe(){
      const email=$('#userEmail').value.trim();
      const name=$('#userName').value.trim();
      const role=$('#userRole').value;
      const did=$('#userDealer').value;
      if(!email||!name||!role||!did) return toast('Fill all user fields',true);

      const tempName='admin-helper-'+Date.now();
      const tempApp=initializeApp((await import('./assets/core.js')).firebaseConfig, tempName);
      const tempAuth=getAuth(tempApp);
      try{
        const defaultPwd='123456789';
        const cred=await createUserWithEmailAndPassword(tempAuth,email,defaultPwd);
        const uid=cred.user.uid;
        let dname=did; try{ const p=await get(ref(db,`dealershipPublic/${did}`)); if(p.exists()) dname=p.val()?.name||did; }catch(e){}
        let displays=[]; const ds=await get(ref(db,`dealership/${did}/displays`)); if(ds.exists()) displays=Object.keys(ds.val()||{});
        await set(ref(db,`user/${uid}`),{email,name,role,dealershipId:did,dealershipName:dname,displays,createdAt:Date.now()});
        toast('User created (pwd 123456789)'); await refreshUsers();
      }catch(e){ console.error(e); toast('Create failed',true); }
      finally{ try{ await (await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js')).deleteApp(tempApp);}catch(e){} }
    }

    $('#inviteUserBtn').addEventListener('click', async ()=>{
      const email=$('#userEmail').value.trim(); if(!email) return toast('Enter email',true);
      try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(e){ console.error(e); toast('Reset failed',true); }
    });
    $('#createUserBtn').addEventListener('click', createUserAdminSafe);

    $('#userSearch').addEventListener('input', debounce(refreshUsers, 200));
    $('#filterDealer').addEventListener('change', refreshUsers);
    $('#filterRole').addEventListener('change', refreshUsers);

    async function refreshUsers(){
      const search=($('#userSearch').value||'').toLowerCase();
      const fDid=$('#filterDealer').value;
      const fRole=$('#filterRole').value;
      const dealers=await loadDealersMap();

      let map={}; try{ const u=await get(ref(db,'user')); if(u.exists()) map=u.val(); }catch(e){}
      const rows=Object.entries(map).map(([uid,v])=>({uid,...v}));

      const filtered=rows.filter(r=>{
        if(fDid && r.dealershipId!==fDid) return false;
        if(fRole && (r.role||'user')!==fRole) return false;
        if(search && !((r.email||'').toLowerCase().includes(search) || (r.name||'').toLowerCase().includes(search))) return false;
        return true;
      });

      const groups={admin:[],device:[],user:[],disabled:[]};
      filtered.forEach(r=>{ const role=(r.role||'user');
        if(role==='admin') groups.admin.push(r);
        else if(role==='device') groups.device.push(r);
        else if(role==='disabled') groups.disabled.push(r);
        else groups.user.push(r);
      });

      $('#countAdmins').textContent=groups.admin.length;
      $('#countDevices').textContent=groups.device.length;
      $('#countUsers').textContent=groups.user.length;
      $('#countDisabled').textContent=groups.disabled.length;

      const total=groups.admin.length+groups.device.length+groups.user.length+groups.disabled.length;
      $('#userEmpty').style.display= total? 'none':'block';

      const renderGroup=(arr,gridId)=>{
        const grid=document.getElementById(gridId); grid.innerHTML='';
        arr.sort((a,b)=> (a.dealershipName||a.dealershipId||'').localeCompare(b.dealershipName||b.dealershipId||'') || (a.email||'').localeCompare(b.email||''));
        const now=Date.now();
        arr.forEach(r=>{
          const dealer=r.dealershipName||r.dealershipId||'‚Äî';
          const isDevice=(r.role==='device');
          const active=isDevice && r.updatedAt && (now-r.updatedAt) < 10*60*1000; // 10 min
          const card=document.createElement('div'); card.className='user-card';
          card.innerHTML=`
            <div class="user-header">
              <div class="user-name" title="Click to rename" data-rename="${r.uid}">
                ${isDevice ? `<i class="dot ${active?'ok':'err'}" title="${active?'Active now':'Inactive'}"></i>` : ''} ${htmlEscape(r.name||'No name')}
              </div>
              <span class="badge">${htmlEscape(r.role||'user')}</span>
            </div>
            <div class="small muted" style="display:flex;gap:8px;flex-wrap:wrap">
              <span>${htmlEscape(r.email||'')}</span>
              <span class="badge">${htmlEscape(dealer)}</span>
            </div>
            <div class="user-actions">
              <select data-uid="${r.uid}" class="select roleSel">
                ${['user','admin','device','disabled'].map(v=>`<option value="${v}" ${v===(r.role||'user')?'selected':''}>${v}</option>`).join('')}
              </select>
              <select data-uid="${r.uid}" class="select dealerSel">
                ${Object.entries(dealers).map(([id,nm])=>`<option value="${id}" ${id===(r.dealershipId||'')?'selected':''}>${nm}</option>`).join('')}
              </select>
              <button class="btn" data-reset="${htmlEscape(r.email||'')}">Reset password</button>
            </div>`;
          grid.appendChild(card);
        });

        // rename name
        grid.querySelectorAll('[data-rename]').forEach(el=>{
          el.addEventListener('click', async ()=>{
            const uid=el.getAttribute('data-rename'); const current=el.textContent.trim();
            const next=prompt('New name', current||''); if(!next || next===current) return;
            try{ await update(ref(db,`user/${uid}`),{name:next}); el.innerHTML = el.innerHTML.replace(current, htmlEscape(next)); toast('Name updated'); }catch(e){ toast('Update failed',true); }
          });
        });
        // role change
        grid.querySelectorAll('.roleSel').forEach(sel=>{
          sel.addEventListener('change', async (e)=>{ const uid=e.target.dataset.uid; const role=e.target.value;
            try{ await update(ref(db,`user/${uid}`),{role}); toast('Role updated'); await refreshUsers(); }catch(err){ toast('Update failed',true); }
          });
        });
        // move dealership
        grid.querySelectorAll('.dealerSel').forEach(sel=>{
          sel.addEventListener('change', async (e)=>{ const uid=e.target.dataset.uid; const did=e.target.value; const name=dealers[did]||did;
            try{ await update(ref(db,`user/${uid}`),{dealershipId:did,dealershipName:name}); toast('Moved'); }catch(err){ toast('Move failed',true); }
          });
        });
        // reset
        grid.querySelectorAll('[data-reset]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const email=btn.getAttribute('data-reset'); if(!email) return toast('No email',true);
            try{ await sendPasswordResetEmail(auth,email); toast('Reset sent'); }catch(err){ toast('Reset failed',true); }
          });
        });
      };

      renderGroup(groups.admin,'gridAdmins');
      renderGroup(groups.device,'gridDevices');
      renderGroup(groups.user,'gridUsers');
      renderGroup(groups.disabled,'gridDisabled');
    }

    // Duplicate finder
    const DUP_SEL = new Set();
    $('#findDupBtn').addEventListener('click', async ()=>{
      DUP_SEL.clear(); $('#dupList').innerHTML='';
      let map={}; try{ const u=await get(ref(db,'user')); if(u.exists()) map=u.val(); }catch(e){}
      const rows=Object.entries(map).map(([uid,v])=>({uid,...v})).filter(r=> (r.role==='device') && r.name && r.dealershipId);
      const groups={};
      rows.forEach(r=>{
        const key=(r.dealershipId||'')+'|'+(r.name||'').toLowerCase().trim();
        if(!groups[key]) groups[key]=[];
        groups[key].push(r);
      });
      const now=Date.now(); let any=false;
      for(const [key,arr] of Object.entries(groups)){
        if(arr.length<=1) continue;
        any=true;
        arr.sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));
        const holder=document.createElement('div'); holder.className='item';
        const [did,name]=key.split('|');
        const inner=arr.map(r=>{
          const active = (r.updatedAt && (now-r.updatedAt) < 10*60*1000);
          return `
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" data-uid="${r.uid}"/>
              <span>${active?'<i class="dot ok" title="Active now"></i>':'<i class="dot err" title="Inactive"></i>'}
                ${htmlEscape(r.name)} <span class="tag">${htmlEscape(did)}</span>
                <span class="badge">${active?'Likely active':'Likely unused'}</span>
              </span>
            </label>`;
        }).join('<br/>');
        holder.innerHTML = `<div class="col"><b>‚Äú${htmlEscape(name)}‚Äù in ${htmlEscape(did)}</b><div class="small muted">Select old/unused ones and delete</div></div><div>${inner}</div>`;
        $('#dupList').appendChild(holder);
      }
      $('#dupBox').style.display='block';
      $('#dupEmpty').style.display= any? 'none':'block';
      $('#dupList').querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change',()=>{ const uid=cb.dataset.uid; if(cb.checked) DUP_SEL.add(uid); else DUP_SEL.delete(uid); });
      });
    });

    $('#deleteDupBtn').addEventListener('click', async ()=>{
      if(!DUP_SEL.size) { toast('Pick duplicates to delete'); return; }
      if(!confirm(`Delete ${DUP_SEL.size} selected user(s)?`)) return;
      try{
        await Promise.all(Array.from(DUP_SEL).map(uid=> remove(ref(db,`user/${uid}`)).catch(()=>{})));
        DUP_SEL.clear(); toast('Deleted'); $('#dupBox').style.display='none'; await refreshUsers();
      }catch(e){ toast('Delete failed',true); }
    });

    refreshUsers();
  </script>
</body>
</html>
