<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
<title>BFA IPTV ‚Äî Backups (Simple)</title>

<style>
  :root{
    --accent:#ff9500; --fg:#111; --muted:#6e6e73; --bg:#fff;
    --panel:#fff; --tile:#f7f7f9; --border:rgba(0,0,0,.16); --border2:rgba(0,0,0,.12);
  }
  [data-theme="dark"]{
    --bg:#0b0b0c; --fg:#fff; --muted:#9a9aa0; --panel:#121214; --tile:#17171a; --border:rgba(255,255,255,.14); --border2:rgba(255,255,255,.18);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
  a{color:inherit;text-decoration:none}

  /* ===== NAVBAR (matches last layout) ===== */
  .topbar{position:sticky;top:0;z-index:100;background:var(--panel);border-bottom:1px solid var(--border);
          padding:calc(10px + env(safe-area-inset-top,0)) 14px 10px}
  .toprow{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px;position:relative}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:#fff center/cover no-repeat}
  .logotxt{font-weight:900;letter-spacing:.2px}

  .nav{display:flex;gap:10px;margin-left:auto;margin-right:auto}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:9999px;border:1px solid transparent;background:transparent;
        color:inherit;font-weight:800;font-size:14px;line-height:1;white-space:nowrap}
  .pill:hover{border-color:var(--accent)}
  .pill.is-active{outline:2px solid var(--accent)}
  .ic{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}

  .actions{display:flex;gap:8px;margin-left:auto;align-items:center}
  .round{height:36px;min-width:36px;padding:0 12px;border-radius:9999px;border:1px solid var(--border);background:var(--panel);font-weight:800;cursor:pointer;color:var(--fg)}
  .round:hover{border-color:var(--accent)}
  .email{max-width:240px;padding:6px 10px;border-radius:9999px;background:var(--panel);border:1px solid var(--border);color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  #hamburger{display:none;border:0;background:transparent;color:var(--accent);height:44px;min-width:44px;padding:0}
  #hamburger .ic{width:24px;height:24px;stroke:var(--accent);stroke-width:2.25}
  @media (max-width:920px){.nav{display:none}#hamburger{display:inline-flex;align-items:center;justify-content:center;position:absolute;right:0;top:50%;transform:translateY(-50%)}.actions{margin-left:0;padding-right:48px}.email{display:none}}

  .sheet{position:fixed;inset:0;z-index:120;display:none}
  .sheet.open{display:block}
  .sheet .back{position:absolute;inset:0;background:rgba(0,0,0,.28)}
  .panel{position:absolute;right:0;top:0;height:100%;width:min(86vw,360px);background:var(--panel);border-left:1px solid var(--border);box-shadow:0 8px 28px rgba(0,0,0,.1);padding:16px;display:flex;flex-direction:column;gap:14px}
  .panel .row{display:flex;align-items:center;justify-content:space-between}
  .panel nav{display:grid;gap:8px}
  .panel nav a{justify-content:flex-start}

  /* ===== PAGE ===== */
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border2);border-radius:18px;padding:16px;box-shadow:0 14px 36px rgba(0,0,0,.06);margin-bottom:12px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .input{height:44px;padding:0 14px;border:1px solid var(--border2);border-radius:12px;background:var(--panel);color:var(--fg);font-size:16px}
  .btn{height:44px;padding:0 18px;border-radius:9999px;border:1px solid var(--border2);background:var(--panel);color:var(--fg);font-weight:900;cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .btnSolid{height:44px;padding:0 18px;border-radius:9999px;background:var(--accent);border:0;color:#000;font-weight:900;cursor:pointer}
  .btnDanger{height:44px;padding:0 18px;border-radius:9999px;border:1px solid #ff6b6b;background:transparent;color:#ff6b6b;font-weight:900;cursor:pointer}

  /* ===== SIMPLE HEADER CONTROLS ===== */
  .hero{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.hero{grid-template-columns:1fr}}
  .big{font-size:18px}

  /* ===== TIMELINE ===== */
  .timeline{display:grid;gap:10px}
  .bcard{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px solid var(--border2);border-radius:16px;padding:14px;background:var(--panel)}
  .bmeta{display:flex;flex-direction:column;gap:6px}
  .btitle{font-weight:900}
  .bnote{font-size:13px;color:var(--muted)}
  .bicons{display:flex;gap:8px;align-items:center}
  .icbtn{display:inline-flex;align-items:center;justify-content:center;gap:10px;height:44px;padding:0 16px;border-radius:12px;border:1px solid var(--border2);background:var(--panel);cursor:pointer;font-weight:900}
  .icbtn svg{width:22px;height:22px}
  .icbtn.restore{background:var(--accent);color:#000;border-color:transparent}
  .pillTag{border:1px solid var(--border2);border-radius:9999px;padding:6px 10px;font-size:12px;color:var(--muted)}

  .toast{position:fixed;left:50%;bottom:26px;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;z-index:99}
  .toast.show{opacity:1} .toast.err{background:#ff453a;color:#fff}
</style>
</head>
<body>
<header class="topbar">
  <div class="toprow">
    <a class="brand" href="home.html"><span class="logo" id="brandLogo"></span><span class="logotxt">BFA IPTV</span></a>
    <nav class="nav" aria-label="Primary">
      <a class="pill" href="home.html" data-page="home"><svg class="ic" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg> Home</a>
      <a class="pill" href="dealerships.html" data-page="dealerships"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10"/></svg> Dealerships</a>
      <a class="pill" href="displays.html" data-page="displays"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="2"/><path d="M7 19h10"/></svg> Displays</a>
      <a class="pill" href="users.html" data-page="users"><svg class="ic" viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M2 22c0-4 4-7 7-7s7 3 7 7"/></svg> Users</a>
      <a class="pill" href="links.html" data-page="links"><svg class="ic" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l3-3a5 5 0 0 0-7-7l-1.5 1.5"/><path d="M14 11a5 5 0 0 0-7 0l-3 3a5 5 0 0 0 7 7L12.5 20"/></svg> Links</a>
      <a class="pill" href="analytics.html" data-page="analytics"><svg class="ic" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v-5"/><path d="M12 18V6"/><path d="M17 13V8"/></svg> Analytics</a>
      <a class="pill" href="schedule.html" data-page="schedule"><svg class="ic" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg> Schedule</a>
      <a class="pill is-active" href="backups.html" data-page="backups"><svg class="ic" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 2"/></svg> Backups</a>
      <a class="pill" href="more.html" data-page="more"><svg class="ic" viewBox="0 0 24 24"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg> More</a>
    </nav>
    <div class="actions">
      <span id="adminEmail" class="email"></span>
      <button id="themeBtn" class="round" title="Theme">Theme</button>
      <button id="logoutBtn" class="round">Logout</button>
      <button id="hamburger" aria-label="Menu"><svg class="ic" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg></button>
    </div>
  </div>

  <div id="sheet" class="sheet" aria-hidden="true">
    <div class="back"></div>
    <aside class="panel" role="dialog" aria-modal="true" aria-label="Menu">
      <div class="row">
        <div class="brand"><span class="logo" id="brandLogoM"></span><span class="logotxt">BFA IPTV</span></div>
        <button id="closeSheet" class="round" aria-label="Close"><svg class="ic" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
      </div>
      <nav aria-label="Mobile">
        <a class="pill" href="home.html" data-page="home">Home</a>
        <a class="pill" href="dealerships.html" data-page="dealerships">Dealerships</a>
        <a class="pill" href="displays.html" data-page="displays">Displays</a>
        <a class="pill" href="users.html" data-page="users">Users</a>
        <a class="pill" href="links.html" data-page="links">Links</a>
        <a class="pill" href="analytics.html" data-page="analytics">Analytics</a>
        <a class="pill" href="schedule.html" data-page="schedule">Schedule</a>
        <a class="pill is-active" href="backups.html" data-page="backups">Backups</a>
        <a class="pill" href="more.html" data-page="more">More</a>
        <button id="logoutBtnM" class="round" style="margin-top:8px">Logout</button>
      </nav>
    </aside>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="hero">
      <div class="row">
        <button id="btnQuickBackup" class="btnSolid big">üü† One‚ÄëClick Backup</button>
        <input id="noteInput" class="input" placeholder="Note (e.g., Before migration)"/>
        <input id="fileAdd" type="file" accept=".json" style="display:none"/>
        <button id="btnAddFromFile" class="btn">‚ûï Add from .json</button>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="btnSimple" class="btn">üë¥ Simple Mode</button>
        <button id="btnAdvanced" class="btn">üë®‚Äçüíª Advanced</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">Backups are saved locally in this browser (and can also be downloaded). Restores require admin login and confirmation.</div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px">Backups Timeline</h2>
    <div class="row" style="margin-bottom:8px">
      <span class="pillTag" id="countTag">0 items</span>
      <button id="btnExportAll" class="btn">‚§ì Export all (.zip soon)</button>
      <button id="btnClearAll" class="btnDanger">üóëÔ∏è Clear all (local)</button>
    </div>
    <div id="timeline" class="timeline"></div>
  </div>

  <!-- Advanced panel (hidden in Simple Mode) -->
  <div id="advancedPanel" class="card" style="display:none">
    <h2 style="margin:0 0 8px">Advanced (optional)</h2>
    <div class="row">
      <input id="ghOwner" class="input" placeholder="GitHub Owner"/>
      <input id="ghRepo"  class="input" placeholder="Repo (e.g., IPTV-)"/>
      <input id="ghBranch" class="input" placeholder="Branch (main)"/>
      <input id="ghToken" class="input" type="password" placeholder="GitHub token (contents:write)"/>
      <button id="btnSaveGh" class="btn">Save</button>
      <button id="btnTestGh" class="btn">Test</button>
    </div>
    <div class="muted">If set, backups will also be pushed to GitHub under <code>backups/YYYY/MM-DD/</code>.</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig={apiKey:"AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",authDomain:"iptv-bfa.firebaseapp.com",databaseURL:"https://iptv-bfa-default-rtdb.firebaseio.com",projectId:"iptv-bfa",storageBucket:"iptv-bfa.firebasestorage.app",messagingSenderId:"838790935867",appId:"1:838790935867:web:1860eac7dbeb7159e1b31e"};
  const LOGO="/IPTV-/icons/icon-512.png";

  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getDatabase(app);

  const $=s=>document.querySelector(s);
  const $$=s=>document.querySelectorAll(s);
  function toast(msg,err=false){const t=$('#toast');t.textContent=msg;t.className='toast show'+(err?' err':'');setTimeout(()=>t.classList.remove('show'),2200);}  

  // Theme + nav highlight
  const LS_THEME='iptv_admin_theme';
  document.documentElement.setAttribute('data-theme', (localStorage.getItem(LS_THEME)||'light'));
  $('#themeBtn').onclick=()=>{const cur=document.documentElement.getAttribute('data-theme');const nxt=cur==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',nxt);localStorage.setItem(LS_THEME,nxt)};
  try{ $('#brandLogo').style.backgroundImage=`url("${LOGO}")`; $('#brandLogoM').style.backgroundImage=`url("${LOGO}")`; }catch{}
  (function(){ const file=(location.pathname.split("/").pop()||"backups.html").toLowerCase();
    const map={"index.html":"home","home.html":"home","dealerships.html":"dealerships","displays.html":"displays","users.html":"users","links.html":"links","analytics.html":"analytics","schedule.html":"schedule","backups.html":"backups","more.html":"more"};
    const key=map[file]||""; if(key) $$(`[data-page="${key}"]`).forEach(a=>a.classList.add('is-active'));
  })();

  // Mobile sheet
  (function(){const sh=$('#sheet'), open=()=>{sh.classList.add('open');document.body.style.overflow='hidden'}, close=()=>{sh.classList.remove('open');document.body.style.overflow=''};$('#hamburger').onclick=open;$('#closeSheet').onclick=close;sh.querySelector('.back').onclick=close;const main=$('#logoutBtn'), mob=$('#logoutBtnM'); if(main&&mob){ mob.addEventListener('click',()=>main.click()); }})();

  // Auth gate
  onAuthStateChanged(auth,(user)=>{ if(!user){ location.href='home.html'; return;} $('#adminEmail').textContent=user.email||user.uid; });
  $('#logoutBtn').addEventListener('click',()=>signOut(auth));

  // ===== Simple/Advanced toggle =====
  const LS_SIMPLE='iptv_simple_mode';
  function applySimpleMode(){ const on=(localStorage.getItem(LS_SIMPLE)||'on')==='on'; $('#advancedPanel').style.display= on? 'none':'block'; toast(on? 'Simple Mode':'Advanced Mode'); }
  $('#btnSimple').onclick=()=>{localStorage.setItem(LS_SIMPLE,'on');applySimpleMode()};
  $('#btnAdvanced').onclick=()=>{localStorage.setItem(LS_SIMPLE,'off');applySimpleMode()};
  applySimpleMode();

  // ===== Local timeline storage =====
  const LS_TIMELINE='iptv_backups_timeline_v1';
  const timeline = {
    list(){ try{return JSON.parse(localStorage.getItem(LS_TIMELINE)||'[]')}catch{return []} },
    save(arr){ localStorage.setItem(LS_TIMELINE, JSON.stringify(arr)); },
    add(item){ const arr=this.list(); arr.push(item); arr.sort((a,b)=>b.ts-a.ts); this.save(arr); },
    remove(id){ this.save(this.list().filter(x=>x.id!==id)); },
    get(id){ return this.list().find(x=>x.id===id); }
  };

  function fmt(ts){ const d=new Date(ts); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`; }
  function render(){ const list=timeline.list(); $('#countTag').textContent=`${list.length} item${list.length!==1?'s':''}`; const box=$('#timeline'); box.innerHTML=''; if(!list.length){ box.innerHTML='<div class="muted">No backups yet. Click "One‚ÄëClick Backup".</div>'; return; }
    for(const it of list){ const div=document.createElement('div'); div.className='bcard'; div.innerHTML=`
      <div class="bmeta">
        <div class="btitle">üìÖ ${fmt(it.ts)} <span class="pillTag">${it.sections?.length||0} section(s)</span></div>
        <div class="bnote">${it.note? it.note.replace(/</g,'&lt;') : '‚Äî no note ‚Äî'}</div>
      </div>
      <div class="bicons">
        <button class="icbtn restore" data-res="${it.id}">‚è™ Restore</button>
        <button class="icbtn" data-dl="${it.id}">‚¨áÔ∏è Download</button>
        <button class="icbtn" data-del="${it.id}">üóëÔ∏è Delete</button>
      </div>`; box.appendChild(div); }
    box.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ const id=b.getAttribute('data-del'); if(confirm('Delete this backup from this browser?')){ timeline.remove(id); render(); toast('Deleted'); } });
    box.querySelectorAll('[data-dl]').forEach(b=> b.onclick=()=>{ const it=timeline.get(b.getAttribute('data-dl')); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(it.payload,null,2)],{type:'application/json'})); a.download=it.filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); });
    box.querySelectorAll('[data-res]').forEach(b=> b.onclick=async ()=>{ const it=timeline.get(b.getAttribute('data-res')); if(!it) return; const ok=confirm('Restore this backup to Firebase? This will overwrite same sections.'); if(!ok) return; try{
        const data=it.payload.data||{};
        const writes=[];
        if(data.dealershipPublic!==undefined) writes.push(set(ref(db,'dealershipPublic'), data.dealershipPublic));
        if(data.dealership!==undefined)      writes.push(set(ref(db,'dealership'), data.dealership));
        if(data.displays!==undefined)        writes.push(set(ref(db,'displays'), data.displays));
        if(data.user!==undefined)            writes.push(set(ref(db,'user'), data.user));
        if(data.links!==undefined)           writes.push(set(ref(db,'admin/quickLinks'), data.links));
        await Promise.all(writes);
        toast('Restore complete ‚úîÔ∏é');
      }catch(e){ toast('Restore failed ‚Äî check admin permissions / rules', true); }
    });
  }

  // ===== One‚ÄëClick Backup (fetch ‚Üí save local ‚Üí optional GitHub) =====
  function nowStamp(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}-${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}`; }
  async function doSnapshot(){
    const req = (path)=> get(ref(db,path)).then(s=>s.val()).catch(()=>null);
    const [dp, d, ds, us, links] = await Promise.all([
      req('dealershipPublic'), req('dealership'), req('displays'), req('user'), req('admin/quickLinks')
    ]);
    const sections=[]; if(dp) sections.push('dealershipPublic'); if(d) sections.push('dealership'); if(ds) sections.push('displays'); if(us) sections.push('user'); if(links) sections.push('links');
    const payload={ kind:'bfa-iptv.backup', version:'v1', exportedAt:new Date().toISOString(), exportedBy:auth.currentUser?.email||'admin', note:($('#noteInput').value||null), sections, data:{ ...(dp?{dealershipPublic:dp}:{ }), ...(d?{dealership:d}:{ }), ...(ds?{displays:ds}:{ }), ...(us?{user:us}:{ }), ...(links?{links}:{ }) } };
    const id = crypto.randomUUID();
    const fn = `bfa-backup-${nowStamp()}.json`;
    timeline.add({ id, ts:Date.now(), note:$('#noteInput').value||'', sections, filename:fn, payload });
    render();
    // auto download for safety
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'})); a.download=fn; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
    toast('Backup saved locally + downloaded');
    // optional GitHub push
    try{ await saveToGitHub(fn, payload); }catch{}
  }
  $('#btnQuickBackup').onclick=()=>doSnapshot();

  // Add from file
  $('#btnAddFromFile').onclick=()=>$('#fileAdd').click();
  $('#fileAdd').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return; try{ const txt=await f.text(); const payload=JSON.parse(txt); const id=crypto.randomUUID(); const ts=Date.now(); timeline.add({id, ts, note: payload.note||'', sections:payload.sections||[], filename:f.name||`import-${nowStamp()}.json`, payload}); render(); toast('Added to timeline'); }catch{ toast('Invalid JSON',true) }
  });

  // Clear all
  $('#btnClearAll').onclick=()=>{ if(confirm('Remove all backups stored in this browser?')){ localStorage.removeItem(LS_TIMELINE); render(); toast('Cleared'); } };
  $('#btnExportAll').onclick=()=>{ toast('Export .zip coming soon'); };

  // ===== GitHub optional =====
  const LS_GH='iptv_admin_gh_simple';
  const gh = JSON.parse(localStorage.getItem(LS_GH)||'{}');
  $('#ghOwner').value=gh.owner||''; $('#ghRepo').value=gh.repo||''; $('#ghBranch').value=gh.branch||'main'; $('#ghToken').value=gh.token||'';
  $('#btnSaveGh').onclick=()=>{ const obj={ owner:$('#ghOwner').value.trim(), repo:$('#ghRepo').value.trim(), branch:$('#ghBranch').value.trim()||'main', token:$('#ghToken').value.trim() }; localStorage.setItem(LS_GH, JSON.stringify(obj)); toast('GitHub settings saved'); };
  $('#btnTestGh').onclick=async()=>{ try{ const meta=await ghFetch(repoBase()); toast(`Repo OK: ${meta.full_name}`);}catch(e){ toast(`GitHub error: ${e.message}`,true);} };
  function ghHeaders(){ const t=(JSON.parse(localStorage.getItem(LS_GH)||'{}').token)||''; const h={'Accept':'application/vnd.github+json','Content-Type':'application/json'}; if(t) h['Authorization']=`Bearer ${t}`; return h; }
  async function ghFetch(url,opts={}){ const h=ghHeaders(); if(!h.Authorization) throw new Error('Add token'); const r=await fetch(url,{...opts,headers:{...h,...(opts.headers||{})}}); const t=await r.text(); let d; try{d=t?JSON.parse(t):{};}catch{d={raw:t}} if(!r.ok) throw new Error(d.message||r.statusText); return d; }
  function repoBase(){ const c=JSON.parse(localStorage.getItem(LS_GH)||'{}'); if(!c.owner||!c.repo) throw new Error('Owner/repo missing'); return `https://api.github.com/repos/${c.owner}/${c.repo}`; }
  async function getFileSha(path){ try{ const c=JSON.parse(localStorage.getItem(LS_GH)||'{}'); const d=await ghFetch(`${repoBase()}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(c.branch||'main')}`); return d.sha; }catch{ return null } }
  async function putFile(path, contentString, message){ const c=JSON.parse(localStorage.getItem(LS_GH)||'{}'); const sha=await getFileSha(path); const body={ message: message||`update: ${path}`, branch: c.branch||'main', content: btoa(unescape(encodeURIComponent(contentString))), ...(sha?{sha}:{}) }; return ghFetch(`${repoBase()}/contents/${encodeURIComponent(path)}`, {method:'PUT', body:JSON.stringify(body)}); }
  async function saveToGitHub(filename, payload){ try{ const c=JSON.parse(localStorage.getItem(LS_GH)||'{}'); if(!c.owner||!c.repo||!c.token) return; const d=new Date(); const folder=`backups/${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}/`; const path=`${folder}${filename}`; await putFile(path, JSON.stringify(payload,null,2), `backup: ${filename}`); toast('Also saved to GitHub ‚úîÔ∏é'); }catch(e){ toast('GitHub save skipped',true) } }

  // First paint
  render();
</script>
</body>
</html>
