<!DOCTYPE html>
bkText.textContent = b ? 'Working…' : 'Ready';
}


// Auth wiring
onAuthStateChanged(auth, user => {
if (user){
authDot.className = 'dot ok';
authText.textContent = 'Signed in';
userText.textContent = user.email || user.uid;
signinBtn.hidden = true; signoutBtn.hidden = false;
loadBackups();
} else {
authDot.className = 'dot err';
authText.textContent = 'Not signed in';
userText.textContent = 'Please sign in to use backups';
signinBtn.hidden = false; signoutBtn.hidden = true;
rows.innerHTML = '';
}
});


signinBtn.addEventListener('click', async () => {
try{ await signInWithPopup(auth, new GoogleAuthProvider()); }catch(e){ alert(e.message); }
});
signoutBtn.addEventListener('click', async () => { await signOut(auth); });


// Actions
backupBtn.addEventListener('click', async () => {
setBusy(true); log('Starting backup…');
try{
const { data } = await backupNow();
log('Backup complete: ' + data.id);
await loadBackups();
}catch(e){ console.error(e); alert(e.message || 'Backup failed'); log('Backup failed'); }
finally{ setBusy(false); }
});


refreshBtn.addEventListener('click', loadBackups);


async function loadBackups(){
setBusy(true);
try{
const { data } = await listBackups();
const items = data.items || [];
rows.innerHTML = '';
document.getElementById('countText').textContent = items.length + ' total';
for (const b of items){
const tr = document.createElement('tr');
const when = new Date(b.timestamp).toLocaleString();
const sizes = `${fmtSize(b.files.realtime?.size)} • ${fmtSize(b.files.github?.size)}`;
tr.innerHTML = `
<td>${when}</td>
<td>
<div>RTDB JSON</div>
<div>GitHub ZIP</div>
<div class="muted">${b.id}</div>
</td>
<td>${sizes}</td>
<td>
<div class="actions">
<a class="btn" href="${b.files.realtime?.url}" target="_blank" rel="noreferrer">DB</a>
<a class="btn" href="${b.files.github?.url}" target="_blank" rel="noreferrer">Code</a>
<a class="btn" href="${b.files.manifest?.url}" target="_blank" rel="noreferrer">Info</a>
</div>
</td>`;
rows.appendChild(tr);
}
if (!items.length){ rows.innerHTML = `<tr><td colspan="4" class="muted">No backups yet.</td></tr>` }
}catch(e){ console.error(e); alert(e.message || 'Failed to load backups'); }
finally{ setBusy(false); }
}


function fmtSize(n){ if(!n && n!==0) return '—'; const KB=1024, MB=KB*1024; return n>MB? (n/MB).toFixed(1)+' MB' : n>KB? (n/KB).toFixed(1)+' KB' : n+' B'; }
</script>


<!-- Inject header after page mounts -->
<script src="./assets/header.js"></script>
<script> injectHeader('site-header', { logo:'./icons/icon-192.png' }); </script>
</body>
</html>
