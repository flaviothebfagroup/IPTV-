<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BFA IPTV — Dealerships</title>

<style>
  :root{
    --bg:#f5f5f7;--fg:#111;--muted:#6e6e73;--panel:#fff;--border:rgba(0,0,0,.12);
    --tile:#f2f2f7;--tileActive:#ededf2;--shadow:0 14px 36px rgba(0,0,0,.10);
    --accent:#ff9500;--danger:#e11d48;
    --rad:16px; --pad:16px; --gap:10px; --btnH:40px; --btnFS:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif}
  a{color:inherit;text-decoration:none}

  /* Top */
  .top{position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px var(--pad);background:linear-gradient(0deg,transparent,rgba(0,0,0,.06));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .lhs{font-weight:900}
  .chip{display:inline-flex;align-items:center;justify-content:center;height:var(--btnH);padding:0 14px;border:1px solid var(--border);border-radius:9999px;background:var(--tile);font-weight:700;font-size:var(--btnFS);line-height:1;white-space:nowrap}

  /* Shell */
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:var(--pad);box-shadow:var(--shadow)}
  .muted{color:var(--muted);font-size:12px}

  /* Input bar */
  .inputbar{display:flex;align-items:center;gap:8px;margin-top:12px;flex-wrap:wrap}
  .input{
    flex:1;min-width:220px;height:var(--btnH);padding:0 14px;background:transparent;border:1px solid var(--border);
    border-radius:9999px;color:var(--fg);font-size:var(--btnFS);line-height:1;outline:none
  }

  /* Button — identical for <button> and <a> */
  .btn, a.btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    height:var(--btnH);padding:0 16px;border-radius:9999px;border:1px solid var(--border);
    background:var(--tile);color:var(--fg);font-weight:700;font-size:var(--btnFS);line-height:1;white-space:nowrap;
    cursor:pointer; text-decoration:none;
  }
  .btn:hover, a.btn:hover{border-color:var(--accent);background:var(--tileActive)}
  .btn:focus-visible, a.btn:focus-visible, .input:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .btn.danger, a.btn.danger{background:transparent;border-color:rgba(225,29,72,.35);color:var(--danger)}
  .btn.danger:hover, a.btn.danger:hover{background:#fff1f3;border-color:var(--danger)}

  /* List rows */
  .list{list-style:none;margin:14px 0 0;padding:0}
  .item{
    display:grid;grid-template-columns:1fr auto;gap:12px;
    align-items:center;background:var(--tile);border:1px solid var(--border);border-radius:16px;padding:12px;margin:10px 0;
  }
  .title{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .tag{padding:2px 8px;border:1px solid var(--border);border-radius:9999px;background:transparent;font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .spacer{height:6px}

  /* Make all action buttons visually consistent widths on larger screens */
  @media (min-width:681px){
    .actions .btn, .actions a.btn{min-width:110px;justify-content:center}
  }

  /* Mobile */
  @media (max-width:680px){
    .item{grid-template-columns:1fr}
    .actions{justify-content:flex-start}
    .btn, a.btn{width:auto}
  }

  /* Toast */
  .toast{position:fixed;left:50%;bottom:26px;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s;z-index:99}
  .toast.show{opacity:1}
  .toast.err{background:#ff453a;color:#fff}
</style>
</head>
<body>

<!-- Top bar -->
<div class="top">
  <div class="lhs">BFA IPTV — Admin</div>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <a class="chip" href="home.html">← Home</a>
    <span id="who" class="muted"></span>
    <button id="reloadBtn" class="btn">Reload</button>
    <button id="signOutBtn" class="btn">Sign out</button>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <h2 style="margin:0">Dealerships</h2>
    <div class="muted">Create, edit public name, migrate ID, delete.</div>

    <div class="inputbar">
      <input id="dealerName" class="input" placeholder="New dealership name (e.g., Genesis Winnipeg)" />
      <button id="addBtn" class="btn" title="Create in both nodes">Add</button>
      <button id="reloadList" class="btn">Reload</button>
    </div>
    <div class="muted spacer"></div>
    <div class="muted">Creates <code>/dealership/{ID}</code> and <code>/dealershipPublic/{ID}</code>. ID allows letters, numbers, CAPS, <b>-</b>, <b>_</b>.</div>

    <ul id="list" class="list"></ul>
    <div id="empty" class="muted" style="display:none">No dealerships.</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
/* ---------- Firebase ---------- */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getDatabase, ref, get, set, update, remove, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
  authDomain: "iptv-bfa.firebaseapp.com",
  databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
  projectId: "iptv-bfa",
  storageBucket: "iptv-bfa.firebasestorage.app",
  messagingSenderId: "838790935867",
  appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

/* ---------- helpers ---------- */
const $=s=>document.querySelector(s);
function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}
function toast(msg,err=false){const t=$("#toast");t.textContent=msg;t.className='toast show'+(err?' err':'');setTimeout(()=>t.classList.remove('show'),2200);}
function sanitizeId(raw){
  // allow A–Z a–z 0–9 - _
  let id=(raw||'').replace(/[^A-Za-z0-9\-_]/g,'').slice(0,40);
  if(!id){ id=(raw||'').normalize('NFKD').replace(/[^\w\-]+/g,'').slice(0,40); }
  return id;
}

/* ---------- auth gate ---------- */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href='home.html'; return; }
  $("#who").textContent = user.email||user.uid;
  const u = (await get(ref(db, 'user/'+user.uid))).val()||{};
  if(u.role!=='admin'){ alert('Admin only'); await signOut(auth); location.href='home.html'; return; }
  loadList();
});
$("#signOutBtn").addEventListener('click', ()=>signOut(auth).then(()=>location.href='home.html'));
$("#reloadBtn").addEventListener('click', loadList);
$("#reloadList").addEventListener('click', loadList);

/* ---------- CRUD ---------- */
async function loadList(){
  $("#list").innerHTML='';
  let map={};
  try{ const snap=await get(ref(db,'dealershipPublic')); map=snap.val()||{}; }catch(e){ map={}; }
  if(!Object.keys(map).length){
    try{
      const s2=await get(ref(db,'dealership')); const raw=s2.val()||{};
      for(const id of Object.keys(raw)) map[id]={name: raw[id]?.name || id};
    }catch(e){}
  }
  const ids=Object.keys(map).sort();
  $("#empty").style.display = ids.length? 'none':'block';

  for(const id of ids){
    const dName = map[id]?.name || id;
    const li=document.createElement('li'); li.className='item';
    const count = await countDisplaysForDealer(id);
    li.innerHTML=`
      <div class="title">
        <b>${esc(dName)}</b>
        <span class="tag">${esc(id)}</span>
        <span class="muted">${count} TV${count===1?'':'s'}</span>
      </div>
      <div class="actions">
        <a class="btn" href="displays.html?dealer=${encodeURIComponent(id)}">Displays</a>
        <a class="btn" href="users.html?dealer=${encodeURIComponent(id)}">Users</a>
        <button class="btn" data-edit="${esc(id)}" data-name="${esc(dName)}">Edit Name</button>
        <button class="btn" data-rename="${esc(id)}" data-name="${esc(dName)}">Rename ID</button>
        <button class="btn danger" data-del="${esc(id)}">Delete</button>
      </div>
    `;
    $("#list").appendChild(li);
  }

  // edit public name
  document.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-edit');
      const cur = btn.getAttribute('data-name')||id;
      const next = prompt('Public name', cur);
      if(!next || next===cur) return;
      try{
        await set(ref(db, 'dealershipPublic/'+id), { name: next });
        try{ await update(ref(db, 'dealership/'+id), { name: next }); }catch(_){}
        toast('Name updated'); loadList();
      }catch(e){ console.error(e); toast('Update failed',true); }
    });
  });

  // migrate ID
  document.querySelectorAll('[data-rename]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const oldId = btn.getAttribute('data-rename');
      const curName = btn.getAttribute('data-name')||oldId;
      const asked = prompt('New dealership ID (letters/numbers/-/_; CAPS allowed):', oldId);
      const newId = sanitizeId(asked||'');
      if(!newId || newId===oldId) return;
      if(!confirm(`Migrate ${oldId} → ${newId}? Displays and users will be updated.`)) return;

      try{
        const existsPub = (await get(ref(db,'dealershipPublic/'+newId))).exists();
        const existsMeta= (await get(ref(db,'dealership/'+newId))).exists();
        if(existsPub || existsMeta) { alert('Target ID already exists. Pick another.'); return; }

        const pubName = (await get(ref(db,'dealershipPublic/'+oldId))).val()?.name || curName || newId;
        await set(ref(db,'dealershipPublic/'+newId), { name: pubName });

        const meta = (await get(ref(db,'dealership/'+oldId))).val()||{};
        if(Object.keys(meta).length){ await set(ref(db,'dealership/'+newId), meta); }

        const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(oldId));
        const dSnap=await get(qRef); const dispMap=dSnap.val()||{};
        for(const did of Object.keys(dispMap)){
          await update(ref(db,'displays/'+did), { dealership:newId, timestamp: Date.now() });
          try{ await remove(ref(db,'dealership/'+oldId+'/displays/'+did)); }catch(_){}
          try{ await set(ref(db,'dealership/'+newId+'/displays/'+did), true); }catch(_){}
        }

        const uSnap=await get(ref(db,'user')); const users=uSnap.val()||{};
        for(const uid of Object.keys(users)){
          if(users[uid]?.dealershipId===oldId){
            await update(ref(db,'user/'+uid), { dealershipId:newId, dealershipName: pubName });
          }
        }

        await remove(ref(db,'dealershipPublic/'+oldId)).catch(()=>{});
        await remove(ref(db,'dealership/'+oldId)).catch(()=>{});

        toast('ID migrated'); loadList();
      }catch(e){ console.error(e); toast('Rename failed',true); }
    });
  });

  // delete
  document.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-del');
      const cnt = await countDisplaysForDealer(id);
      if(cnt>0){ alert(`This dealership still has ${cnt} display(s). Remove or migrate them first.`); return; }
      if(!confirm(`Delete ${id}?`)) return;
      try{
        await remove(ref(db,'dealershipPublic/'+id)).catch(()=>{});
        await remove(ref(db,'dealership/'+id)).catch(()=>{});
        toast('Deleted'); loadList();
      }catch(e){ console.error(e); toast('Delete failed',true); }
    });
  });
}

async function countDisplaysForDealer(id){
  try{
    const qRef=query(ref(db,'displays'),orderByChild('dealership'),equalTo(id));
    const s=await get(qRef); return Object.keys(s.val()||{}).length;
  }catch(e){ return 0; }
}

// create
$("#addBtn").addEventListener('click', async ()=>{
  const name=$("#dealerName").value.trim();
  if(!name) return toast('Enter a name', true);
  const suggested = name.replace(/\s+/g,'').replace(/[^A-Za-z0-9\-_]/g,'').slice(0,40);
  const id = sanitizeId(suggested || name);
  try{
    const exists = (await get(ref(db,'dealershipPublic/'+id))).exists() || (await get(ref(db,'dealership/'+id))).exists();
    if(exists){ toast('ID exists — choose a different name', true); return; }

    const meta = { name, createdAt: Date.now(), createdBy: auth.currentUser?.email||'admin', displays:{} };
    await set(ref(db,'dealership/'+id), meta);
    await set(ref(db,'dealershipPublic/'+id), { name });
    $("#dealerName").value='';
    toast('Dealership added');
    loadList();
  }catch(e){
    console.error(e); toast('Create failed (check rules)', true);
  }
});
</script>
</body>
</html>
