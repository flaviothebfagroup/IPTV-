<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>BFA IPTV ‚Äî Admin ‚Ä¢ Dealerships</title>
  <link rel="stylesheet" href="assets/core.css"/>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="lhs">
      <div id="brandLogo" class="logo" title="IPTV"></div>
      <div class="title">BFA IPTV ‚Äî Admin</div>
    </div>
    <div class="rhs" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <span id="adminEmail" class="muted"></span>
      <a href="home.html" class="crumb"><span>‚Üê</span><b>Home</b></a>
      <button id="themeBtn"  class="btn">‚òÄÔ∏é/üåô</button>
      <button id="signOutBtn" class="btn primary">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Login (shown when not authenticated admin) -->
    <div id="loginBox" class="card" style="max-width:520px;margin:40px auto;display:none">
      <h2 style="margin:0 0 12px">Admin Sign In</h2>
      <div class="row2">
        <div><div class="label">Email</div><input id="email" class="input" type="email" placeholder="you@company.com"/></div>
        <div><div class="label">Password</div><input id="password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
      </div>
      <div class="row2">
        <button id="loginBtn" class="btn solid">Sign in</button>
        <button id="resetBtn" class="btn">Send reset link</button>
      </div>
      <div class="small muted">Requires <b>role: "admin"</b> in <code>/user/{uid}</code>.</div>
    </div>

    <!-- Page root -->
    <div id="pageRoot" style="display:none">
      <div class="card">
        <h2 style="margin:0 0 8px">Dealerships</h2>
        <div class="small muted">Create, edit public name, <b>safe ID rename / merge</b>, delete</div>

        <div class="row2" style="margin-top:12px">
          <div>
            <div class="label">New dealership name</div>
            <input id="dealerName" class="input" placeholder="e.g., Genesis Winnipeg" />
          </div>
          <div style="display:flex;align-items:end;gap:8px">
            <button id="addDealerBtn" class="btn solid">Add</button>
            <button id="dealersReload" class="btn">Reload</button>
          </div>
        </div>
        <div class="small muted">Creates <code>/dealership/{id}</code> and tries <code>/dealershipPublic/{id}</code> (if rules allow). ID is generated from the name.</div>

        <ul id="dealerList" class="list" style="margin-top:10px"></ul>
        <div id="dealerEmpty" class="empty" style="display:none">No dealerships.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Page script -->
  <script type="module">
    import { initChrome, requireAdmin, db, auth, $, htmlEscape, toast,
             createDealership, getDealersMap, countDisplaysForDealer,
             migrateDealerId, updatePublicName, makeDealerId } from './assets/core.js';
    import { ref, remove } from './assets/core.js';

    initChrome();
    await requireAdmin();

    $('#addDealerBtn')?.addEventListener('click', async ()=>{
      const name=$('#dealerName').value.trim();
      if(!name) return toast('Enter a name', true);
      await createDealership(name);
      $('#dealerName').value='';
      await renderList();
      toast('Dealership added');
    });

    $('#dealersReload')?.addEventListener('click', renderList);

    async function renderList(){
      const list=$('#dealerList'); list.innerHTML='';
      const map=await getDealersMap();
      const ids=Object.keys(map).sort();
      $('#dealerEmpty').style.display = ids.length? 'none':'block';

      for(const id of ids){
        const name=map[id]?.name||id;
        const count=await countDisplaysForDealer(id);
        const li=document.createElement('li'); li.className='item';
        li.innerHTML=`
          <div class="col">
            <div class="split">
              <b>${htmlEscape(name)}</b>
              <span class="tag">${htmlEscape(id)}</span>
              <span class="small muted">${count} TV${count===1?'':'s'}</span>
            </div>
          </div>
          <div class="split">
            <a class="btn" href="displays.html?dealer=${encodeURIComponent(id)}">Displays</a>
            <a class="btn" href="users.html?dealer=${encodeURIComponent(id)}">Users</a>
            <button class="btn" data-editname="${id}" data-name="${htmlEscape(name)}">Edit Name</button>
            <button class="btn" data-rename="${id}" data-name="${htmlEscape(name)}">Rename ID</button>
            <button class="btn danger" data-del="${id}">Delete</button>
          </div>`;
        list.appendChild(li);
      }

      // edit public name
      list.querySelectorAll('[data-editname]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.getAttribute('data-editname');
          const current=btn.getAttribute('data-name');
          const next=prompt('Public display name', current||'');
          if(!next || next===current) return;
          try{ await updatePublicName(id,next); toast('Name updated'); await renderList(); }
          catch(e){ console.error(e); toast('Update failed',true); }
        });
      });

      // rename or merge
      list.querySelectorAll('[data-rename]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const oldId = btn.getAttribute('data-rename');
          const currentName = btn.getAttribute('data-name');
          const newIdRaw = prompt('New dealership ID (letters/numbers only):', oldId);
          const newId = (newIdRaw||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
          if(!newId || newId===oldId) return;
          // lightweight confirm when merging happens is handled in core (page already asked new ID)
          try{ await migrateDealerId(oldId,newId,currentName); toast('Dealer ID updated'); await renderList(); }
          catch(e){ toast(e.message||'Rename failed', true); }
        });
      });

      // delete
      list.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.getAttribute('data-del');
          const count=await countDisplaysForDealer(id);
          if(count>0){ alert(`This dealership still has ${count} display(s). Remove them first or migrate.`); return; }
          if(!confirm(`Delete ${id}?`)) return;
          try{
            await remove(ref(db,`dealership/${id}`));
            await remove(ref(db,`dealershipPublic/${id}`)).catch(()=>{});
            toast('Deleted'); await renderList();
          }catch(e){ console.error(e); toast('Delete failed',true); }
        });
      });
    }

    await renderList();
  </script>
</body>
</html>
