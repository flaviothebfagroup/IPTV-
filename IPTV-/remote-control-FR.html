<!DOCTYPE html>
<html lang="en">
<head>
  <!-- PWA / icons (optional) -->
  <link rel="manifest" href="https://flaviothebfagroup.github.io/IPTV-/manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" sizes="192x192" href="https://flaviothebfagroup.github.io/IPTV-/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="https://flaviothebfagroup.github.io/IPTV-/icons/icon-512.png">
  <link rel="apple-touch-icon" href="https://flaviothebfagroup.github.io/IPTV-/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="IPTV Remote">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>IPTV Remote — Liquid Glass</title>
  <style>
    :root { --bg:#0b0b0c; --fg:#fff; --muted:#9a9aa0; --panel:#121214; --border:rgba(255,255,255,.14); --accent:#ff9500; --tile:#17171a; --tileActive:#1d1d21; --shadow:0 18px 48px rgba(0,0,0,.45); }
    body.light { --bg:#f5f5f7; --fg:#111; --muted:#6e6e73; --panel:#fff; --border:rgba(0,0,0,.12); --accent:#ff9500; --tile:#f2f2f7; --tileActive:#eaeaef; --shadow:0 14px 36px rgba(0,0,0,.10); }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;display:flex;align-items:center;justify-content:center;padding:22px;transition:background .25s,color .25s}

    /* --- Header language pill (unchanged after login) --- */
    .lang-toggle{
      --seg-font:11px; --seg-pad-y:4px; --seg-pad-x:10px;
      display:inline-flex; align-items:center; gap:4px; padding:4px;
      background:var(--tile); border:1px solid var(--border); border-radius:999px;
      box-shadow:var(--shadow);
    }
    .seg-btn{
      font-size:var(--seg-font); font-weight:800; line-height:1;
      padding:var(--seg-pad-y) var(--seg-pad-x);
      border-radius:999px; border:none; cursor:pointer;
      background:transparent; color:var(--fg); opacity:.8;
    }
    .seg-btn.active{ background:var(--accent); color:#000; opacity:1; }
    .seg-btn:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }

    /* --- Minimal login language link --- */
    .lang-min{margin-top:12px; display:flex; justify-content:center;}
    .text-link{
      background:transparent; border:none; padding:8px 10px; cursor:pointer;
      font-size:12px; color:var(--muted);
    }
    .text-link:hover,.text-link:focus{ color:var(--fg); }
    .text-link:focus-visible{ outline:2px solid var(--accent); border-radius:10px; }

    /* Login */
    .login{width:100%;max-width:380px;text-align:center}
    .logo{width:110px;height:110px;margin:0 auto 12px;display:block;background:var(--accent);
      -webkit-mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;
      mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:28px;padding:24px;box-shadow:var(--shadow)}
    .login input{width:100%;padding:16px;margin-bottom:14px;background:transparent;border:1px solid var(--border);border-radius:14px;color:var(--fg);font-size:16px;text-align:center}
    .login input::placeholder{color:var(--muted)}
    .login button{width:100%;padding:14px;background:var(--accent);color:#000;border:none;border-radius:999px;font-size:16px;font-weight:700;cursor:pointer;pointer-events:auto}
    .link{margin-top:12px;font-size:14px;color:var(--muted)}
    .link a{color:var(--fg);text-decoration:none;border-bottom:1px dashed var(--border)}

    /* Keep login language control minimal & outlined */
    .login .text-link{
      width:auto; background:transparent !important;
      border:1px dashed var(--border); border-radius:999px;
      padding:6px 10px; color:var(--muted);
      display:inline-flex; align-items:center; gap:6px; font-weight:600;
      -webkit-appearance:none; appearance:none;
    }
    .login .text-link:hover{ color:var(--fg); border-style:solid; }

    /* Remote shell */
    .remote{display:none;width:100%;max-width:clamp(360px,92vw,440px);background:var(--panel);border:1px solid var(--border);border-radius:42px;padding:18px 18px 22px;box-shadow:var(--shadow)}

    /* Header (responsive, prevents overlaps) */
    .hdr{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; column-gap:10px; position:relative; z-index:2; }
    .pill{ justify-self:start;height:34px;padding:0 14px;border-radius:9999px;display:inline-flex;align-items:center;gap:8px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-size:13px;font-weight:700;cursor:pointer }
    .pill .icon{ display:none; margin-left:6px; }
    @media (max-width:380px){ .pill .text{ display:none; } .pill .icon{ display:inline; } }

    .display-name{ justify-self:center;font-size:13px;color:var(--muted);cursor:pointer;text-transform:uppercase;letter-spacing:.8px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap }
    .theme-holder{justify-self:end;display:flex;align-items:center;gap:8px}
    .theme-switch{position:relative;width:56px;height:30px;border-radius:999px;background:var(--tileActive);border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 8px;box-shadow:inset 0 -2px 8px rgba(0,0,0,.12),inset 0 2px 6px rgba(255,255,255,.06);cursor:pointer}
    .theme-switch .sun,.theme-switch .moon{font-size:14px;opacity:.55;transition:opacity .2s}
    .theme-switch .thumb{position:absolute;top:2px;left:2px;width:26px;height:26px;border-radius:50%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.25);transition:transform .25s}
    body.light .theme-switch .thumb{background:#000}
    .theme-switch.on{border-color:var(--accent);box-shadow:inset 0 -2px 8px rgba(0,0,0,.12),0 6px 18px rgba(255,149,0,.22)}
    .theme-switch.on .thumb{transform:translateX(26px)}
    .theme-switch.on .sun{opacity:1}.theme-switch.on .moon{opacity:.3}

    .rule{height:1px;background:var(--border);margin:12px 0 10px}

    /* Dial */
    .dial{width:min(78vw,360px);aspect-ratio:1/1;margin:0 auto 14px;position:relative;touch-action:none}
    .dial-ring{position:absolute;inset:0;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)),var(--tile);border:1px solid var(--border);box-shadow:none}
    .dial-ring::after{ content:""; position:absolute; inset:0; border-radius:50%; background: radial-gradient(60% 60% at var(--glow-x,60%) var(--glow-y,50%), rgba(255,149,0,.55), rgba(255,149,0,0) 60%); opacity:0; transition:opacity .25s ease; pointer-events:none; }
    .dial-ring.show-glow::after{ opacity:1; }

    .dial-center{ position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:56%;height:56%;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02)),var(--panel);border:1px solid var(--border);display:grid;place-items:center;text-align:center;overflow:hidden;box-shadow:none }
    #dialContent{position:relative;width:100%;height:100%;display:grid;place-items:center;z-index:1;pointer-events:none}
    .dial-select{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:56%;height:56%;border-radius:50%;background:transparent;border:0;cursor:pointer;z-index:2}

    .dial-center.flash{animation:ringFlash .22s ease-out; border-color: var(--accent);}
    @keyframes ringFlash{0%{border-color: var(--accent)}100%{border-color: var(--border)}}
    #dialContent.pulse{animation:dialPulse .26s ease-out;}
    @keyframes dialPulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
    .dial-num{font-size:clamp(68px,12vw,96px);font-weight:800;color:var(--accent);line-height:1}
    .dial-name{font-size:12px;letter-spacing:.6px;color:var(--muted);text-transform:uppercase;margin-top:-4px}

    /* CLICKABLE inner arrows (no visible circle) */
    .pad-arrow{ position:absolute; width:64px; height:64px; display:grid; place-items:center; background:transparent; border:none; color:var(--fg); font-size:18px; cursor:pointer; }
    #arrowUp{   left:50%; top:16%;  transform:translate(-50%,-50%); }
    #arrowDown{ left:50%; bottom:16%;transform:translate(-50%,50%); }
    #arrowLeft{ left:16%;  top:50%;  transform:translate(-50%,-50%); }
    #arrowRight{right:16%; top:50%;  transform:translate(50%,-50%); }

    /* Quick grid */
    .quick-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:14px 6px 6px}
    .quick-btn{height:66px;border:1px solid var(--border);border-radius:16px;background:var(--tile);color:var(--fg);font-weight:800;font-size:22px;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;transition:border-color .2s,background .2s,transform .16s}
    .quick-btn:active{transform:translateY(1px)}
    .quick-btn span{margin-top:2px;font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
    .quick-btn.active{border-color:var(--accent);background:var(--tileActive);transform:scale(1.06);box-shadow:0 0 0 2px rgba(255,149,0,.35), inset 0 0 0 1px var(--accent);}
    .quick-btn.pulsing{animation:tilePulse .24s ease-out;}
    @keyframes tilePulse{0%{transform:scale(1.06)}50%{transform:scale(1.12)}100%{transform:scale(1.06)}}
    .quick-btn.mute.muted{border-color:#ff453a;color:#ff453a}

    /* Volume */
    .volume-bar{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;max-width:340px;margin:6px auto 0}
    .vol-btn{width:54px;height:42px;border:1px solid var(--border);border-radius:12px;background:var(--tile);color:var(--fg);font-size:22px;cursor:pointer}
    .vol-track{position:relative;height:14px;border-radius:999px;background:var(--tile);border:1px solid var(--border);overflow:hidden}
    .vol-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,var(--accent),#ffb866)}

    /* Overlays */
    .chooser{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.35);z-index:999}
    .chooser.show{display:flex}
    .sheet{width:min(640px,94vw);max-height:66vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:14px 14px 10px;box-shadow:var(--shadow)}
    .sheet h4{margin:6px 8px 10px;font-size:14px;letter-spacing:.4px;color:var(--muted);text-transform:uppercase}
    .list{display:grid;gap:8px;padding:0 6px 10px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--tile);cursor:pointer}
    .item b{font-size:13px}
    .item small{color:var(--muted)}
    .item.active{border-color:var(--accent); box-shadow:0 0 0 2px rgba(255,149,0,.28)}

    .toast{position:fixed;top:50px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 20px;border-radius:999px;font-size:13px;font-weight:700;opacity:0;transition:opacity .25s;pointer-events:none;z-index:1000}
    .toast.show{opacity:1}

    .hint{display:none!important}

    @media (min-height:900px){.quick-btn{height:70px}.vol-btn{height:46px;width:60px}}
    @media (max-width:420px){body{padding:16px}.remote{padding:16px}.quick-btn{height:60px}}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div class="login" id="login">
    <div class="logo" role="img" aria-label="IPTV logo"></div>
    <div class="card" id="loginCard">
      <input type="email" id="email" placeholder="Email" autocomplete="email" />
      <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
      <button id="btnEnter" type="button">ENTER</button>

      <!-- Minimal language link (bottom of card) -->
      <div class="lang-min">
        <button id="langLink" class="text-link" aria-haspopup="dialog">🌐 <span id="langLinkText">Language: English</span></button>
      </div>
    </div>
    <div class="link" id="signupLink">Don’t have an account? <a id="signupA" href="https://flaviothebfagroup.github.io/IPTV-/signup.html">Create your account</a></div>
  </div>

  <!-- ENTER reliability hotfix -->
  <script>
    (function () {
      const btn   = document.getElementById('btnEnter');
      const email = document.getElementById('email');
      const pass  = document.getElementById('password');

      let fired = false;
      function callSignIn() {
        if (fired) return;
        fired = true;
        if (!email.value.trim() || !pass.value) { fired = false; return; }

        if (typeof window.signIn === 'function') {
          try { window.signIn(); } catch(e) { fired = false; }
          return;
        }
        let tries = 0;
        const iv = setInterval(() => {
          if (typeof window.signIn === 'function') {
            clearInterval(iv);
            try { window.signIn(); } catch(e) {}
          } else if (++tries > 50) {
            clearInterval(iv);
            console.warn('signIn not ready');
            fired = false;
          }
        }, 100);
      }

      if (btn) {
        btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); callSignIn(); }, {passive:false});
        btn.addEventListener('pointerup',  (e)=>{ e.preventDefault(); callSignIn(); });
        btn.addEventListener('click',      (e)=>{ e.preventDefault(); callSignIn(); });
      }
      [email, pass].forEach(el => el && el.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); callSignIn(); }
      }));
    })();
  </script>

  <!-- REMOTE -->
  <div class="remote" id="remote" style="display:none;">
    <div class="hdr">
      <button class="pill" id="btnSignOut" aria-label="Sign out">
        <span class="text">Sign out</span>
        <span class="icon" aria-hidden="true">⎋</span>
      </button>

      <div class="display-name" id="currentDisplay" title="Tap to select TV">DISPLAY</div>

      <div class="theme-holder" id="langMount">
        <div id="hdrSwitch" class="theme-switch"><span class="sun">☀️</span><span class="moon">🌙</span><i class="thumb"></i></div>

        <!-- Unchanged compact EN | FR pill in header -->
        <div class="lang-toggle" id="langToggle" role="group" aria-label="Language">
          <button type="button" class="seg-btn" data-lang="en" aria-pressed="false">EN</button>
          <button type="button" class="seg-btn" data-lang="fr" aria-pressed="false">FR</button>
        </div>
      </div>
    </div>

    <div class="rule"></div>

    <!-- Dial -->
    <div class="dial" id="dial" aria-label="Ring navigation">
      <div class="dial-ring" id="dialRing"></div>
      <button class="pad-arrow" id="arrowUp"    aria-label="Up">▲</button>
      <button class="pad-arrow" id="arrowDown"  aria-label="Down">▼</button>
      <button class="pad-arrow" id="arrowLeft"  aria-label="Left">◀︎</button>
      <button class="pad-arrow" id="arrowRight" aria-label="Right">▶︎</button>

      <div class="dial-center">
        <div id="dialContent">
          <div class="dial-num" id="dialNumber">1</div>
          <div class="dial-name" id="dialName">News</div>
        </div>
        <button class="dial-select" id="dialSelect" aria-label="Select"></button>
      </div>
    </div>

    <!-- Grid (1..5 + MUTE) -->
    <div class="quick-grid">
      <button class="quick-btn" id="qch-1"><strong>1</strong><span id="lbl-1">News</span></button>
      <button class="quick-btn" id="qch-2"><strong>2</strong><span id="lbl-2">News</span></button>
      <button class="quick-btn" id="qch-3"><strong>3</strong><span id="lbl-3">Sports</span></button>
      <button class="quick-btn" id="qch-4"><strong>4</strong><span id="lbl-4">Sports</span></button>
      <button class="quick-btn" id="qch-5"><strong>5</strong><span id="lbl-5">Cooking</span></button>
      <button class="quick-btn mute" id="q-mute"><strong>🔇</strong><span id="muteLabel">Mute</span></button>
    </div>

    <!-- Volume -->
    <div class="volume-bar">
      <button class="vol-btn" id="volMinus">−</button>
      <div class="vol-track"><div class="vol-fill" id="volFill"></div></div>
      <button class="vol-btn" id="volPlus">+</button>
    </div>
  </div>

  <!-- TV chooser overlay -->
  <div class="chooser" id="chooser">
    <div class="sheet">
      <h4 id="chooserTitle">All TVs</h4>
      <div class="list" id="displayList"></div>
    </div>
  </div>

  <!-- Language chooser overlay -->
  <div class="chooser" id="langChooser">
    <div class="sheet">
      <h4 id="langChooserTitle">Choose your language</h4>
      <div class="list" id="langList">
        <div class="item" data-lang="en"><b>English</b><small>EN</small></div>
        <div class="item" data-lang="fr"><b>Français</b><small>FR</small></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, setPersistence, browserLocalPersistence, signOut, onAuthStateChanged, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, get, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    /* ---------------- I18N ---------------- */
    const i18n = {
      en:{htmlLang:'en',emailPH:'Email',passwordPH:'Password',btnEnter:'ENTER',linkNoAccount:"Don’t have an account?",linkCreate:'Create your account',btnSignOut:'Sign out',displayTitle:'DISPLAY',titleTap:'Tap to select TV',chooserAll:'All TVs',chooserMine:'My TVs',themeLight:'Light mode',themeDark:'Dark mode',needCreds:'Enter email & password',invalidLogin:'Invalid login',loginFailed:'Login failed',selectDisplay:'Select a TV',updateDenied:'Update denied — check rules/display dealership',mutedLabel:'Mute',mutedOn:'Muted',toastMuted:'MUTED',toastUnmuted:'UNMUTED',dialAria:'Ring navigation',arrows:{Up:'Up',Down:'Down',Left:'Left',Right:'Right',Select:'Select'},CH:'CH',VOL:'VOL',channels:{1:'News',2:'Sports',3:'Cooking',4:'Nature',5:'Kids'},ariaLogo:'IPTV logo',langToast:'Language: English',langChooserTitle:'Choose your language',langLinkPrefix:'Language',langEnglish:'English',langFrench:'French'},
      fr:{htmlLang:'fr-CA',emailPH:'Courriel',passwordPH:'Mot de passe',btnEnter:'Se connecter',linkNoAccount:'Pas de compte ?',linkCreate:'Créez votre compte',btnSignOut:'Déconnexion',displayTitle:'ÉCRAN',titleTap:'Touchez pour choisir l’écran',chooserAll:'Tous les écrans',chooserMine:'Mes écrans',themeLight:'Mode clair',themeDark:'Mode sombre',needCreds:'Entrez votre courriel et votre mot de passe',invalidLogin:'Identifiants invalides',loginFailed:'Échec de la connexion',selectDisplay:'Sélectionnez un écran',updateDenied:'Mise à jour refusée — vérifiez les règles/la concession',mutedLabel:'Sourdine',mutedOn:'En sourdine',toastMuted:'SOURDINE',toastUnmuted:'SON ACTIVÉ',dialAria:'Navigation circulaire',arrows:{Up:'Haut',Down:'Bas',Left:'Gauche',Right:'Droite',Select:'Sélectionner'},CH:'CH',VOL:'VOL',channels:{1:'Nouvelles',2:'Sports',3:'Cuisine',4:'Nature',5:'Enfants'},ariaLogo:'logo IPTV',langToast:'Langue : Français',langChooserTitle:'Choisissez votre langue',langLinkPrefix:'Langue',langEnglish:'Anglais',langFrench:'Français'}
    };
    let lang = localStorage.getItem('iptv_lang') || ((navigator.language||'en').toLowerCase().startsWith('fr') ? 'fr' : 'en');
    const $  = (s)=>document.querySelector(s);
    const $id = (s)=>document.getElementById(s);
    function t(key){ return i18n[lang][key]; }
    function toast(msg){ const tEl=$('#toast'); tEl.textContent=msg; tEl.classList.add('show'); setTimeout(()=>tEl.classList.remove('show'),1400); }

    /* ---------- Per-element de-duped binder (fixes double-fire without blocking others) ---------- */
    const TAP_GUARD_MS = 280;
    const lastTapForEl = new WeakMap();
    function fastBind(el, handler){
      if(!el) return;
      const invoke = (e)=>{
        const now = performance.now ? performance.now() : Date.now();
        const last = lastTapForEl.get(el) || 0;
        if (now - last < TAP_GUARD_MS) { e.preventDefault(); return; }
        lastTapForEl.set(el, now);
        try { handler(e); } catch(_) {}
      };
      el.addEventListener('pointerup', (e)=>{ e.preventDefault(); invoke(e); }, {passive:false});
      el.addEventListener('touchend',  (e)=>{ e.preventDefault(); invoke(e); }, {passive:false});
      el.addEventListener('click',     (e)=>{ e.preventDefault(); invoke(e); });
      el.addEventListener('keydown',   (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); invoke(e); }});
    }

    /* ---------- Language chooser (login) ---------- */
    const langLink = $id('langLink'), langLinkText = $id('langLinkText');
    const langChooser = $id('langChooser'), langList = $id('langList');
    function openLangChooser(){ langList.querySelectorAll('.item').forEach(it=>it.classList.toggle('active', it.dataset.lang===lang)); langChooser.classList.add('show'); }
    function closeLangChooser(){ langChooser.classList.remove('show'); }
    langLink.addEventListener('click', openLangChooser);
    langChooser.addEventListener('click', (e)=>{ if(e.target.id==='langChooser'){ closeLangChooser(); } });
    langList.addEventListener('click', (e)=>{ const item=e.target.closest('.item'); if(!item) return; setLang(item.dataset.lang); closeLangChooser(); });

    /* ---------- Header segmented control ---------- */
    const langToggle  = $id('langToggle');
    const langButtons = Array.from(langToggle.querySelectorAll('.seg-btn'));
    function updateLangButtons(){ langButtons.forEach(b=>{ const on=b.dataset.lang===lang; b.classList.toggle('active',on); b.setAttribute('aria-pressed', on?'true':'false'); }); }
    langButtons.forEach(b=> fastBind(b, ()=> setLang(b.dataset.lang)));
    function setLang(newLang){ if(!newLang||newLang===lang) return; lang=newLang; localStorage.setItem('iptv_lang',lang); applyI18n(); updateLangButtons(); toast(i18n[lang].langToast); }

    /* ---------- Apply i18n ---------- */
    function applyI18n(){
      document.documentElement.lang = i18n[lang].htmlLang;
      $id('email').placeholder = t('emailPH');
      $id('password').placeholder = t('passwordPH');
      $id('btnEnter').textContent = t('btnEnter');
      $id('signupLink').childNodes[0].textContent = t('linkNoAccount') + ' ';
      $id('signupA').textContent = t('linkCreate');
      langLinkText.textContent = `${t('langLinkPrefix')}: ${lang==='fr'? i18n[lang].langFrench : i18n[lang].langEnglish}`;
      $id('langChooserTitle').textContent = t('langChooserTitle');
      const enRow = $('#langList .item[data-lang="en"]'); const frRow = $('#langList .item[data-lang="fr"]');
      if (enRow) { enRow.querySelector('b').textContent = i18n[lang].langEnglish; enRow.querySelector('small').textContent = 'EN'; }
      if (frRow) { frRow.querySelector('b').textContent = i18n[lang].langFrench; frRow.querySelector('small').textContent = 'FR'; }
      const sText = $('#btnSignOut .text'); if (sText) sText.textContent = t('btnSignOut');
      $id('currentDisplay').textContent = t('displayTitle'); $id('currentDisplay').title = t('titleTap');
      $id('chooserTitle').textContent = t('chooserAll');
      $id('dial').setAttribute('aria-label', t('dialAria'));
      $id('arrowUp').setAttribute('aria-label', i18n[lang].arrows.Up);
      $id('arrowDown').setAttribute('aria-label', i18n[lang].arrows.Down);
      $id('arrowLeft').setAttribute('aria-label', i18n[lang].arrows.Left);
      $id('arrowRight').setAttribute('aria-label', i18n[lang].arrows.Right);
      $id('dialSelect').setAttribute('aria-label', i18n[lang].arrows.Select);
      for (let i=1;i<=5;i++){ const el=$id('lbl-'+i); if(el) el.textContent=i18n[lang].channels[i]; }
      $id('muteLabel').textContent = muted ? t('mutedOn') : t('mutedLabel');
      paintDial(currentChannel);
    }

    /* ---------------- Firebase ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    setPersistence(auth, browserLocalPersistence).catch(console.warn);

    async function signIn(){
      const email = $id('email').value.trim();
      const password = $id('password').value;
      if(!email||!password){ toast(t('needCreds')); return; }
      try { await signInWithEmailAndPassword(auth,email,password); }
      catch(e){ console.error(e); toast(e?.code==='auth/invalid-credential'? t('invalidLogin') : t('loginFailed')); }
    }
    window.signIn = signIn;

    async function safeSignOut(){
      try { await signOut(auth); toast(lang==='fr'?'Déconnecté':'Signed out'); }
      catch(e){ console.error(e); toast(lang==='fr'?'Échec de la déconnexion':'Sign out failed'); }
    }
    fastBind($id('btnSignOut'), ()=> safeSignOut());

    // ---------- STATE ----------
    let dealershipId = null, displayIds = [], currentDisplay = null;
    let currentChannel = 1, previewChannel = 1;
    let volume = 50, muted = false;
    const IDX_TO_ID = ['qch-1','qch-2','qch-3','qch-4','qch-5','q-mute'];
    let focusedIndex = 0;
    let displayUnsub = null;
    let isAdmin = false;

    function updateVolumeUI(){ $id('volFill').style.width = volume + '%'; }
    function channelName(ch){ return (i18n[lang].channels[ch] || (lang==='fr' ? `Chaîne ${ch}` : `Channel ${ch}`)); }
    function paintDial(ch){ $id('dialNumber').textContent = ch; $id('dialName').textContent = channelName(ch); }

    const ring = $id('dialRing');
    function flashGlow(dir){
      if(!ring) return;
      const map = { right:['75%','50%'], left:['25%','50%'], up:['50%','25%'], down:['50%','75%'] };
      const [gx,gy] = map[dir] || ['60%','50%'];
      ring.style.setProperty('--glow-x', gx); ring.style.setProperty('--glow-y', gy);
      ring.classList.add('show-glow'); setTimeout(()=> ring.classList.remove('show-glow'), 260);
    }

    function animateDialTo(ch, dir){
      const content=$id('dialContent'); if(!content){ paintDial(ch); return; }
      const axis=(dir==='up'||dir==='down')?'Y':'X'; const amt=(dir==='left'||dir==='up')?-26:26;
      const out = content.animate([{transform:`translate${axis}(0px)`,opacity:1},{transform:`translate${axis}(${amt}px)`,opacity:.6}],{duration:130,easing:'ease-out'});
      out.finished.then(()=>{ paintDial(ch);
        content.animate([{transform:`translate${axis}(${-amt}px)`,opacity:.6},{transform:`translate${axis}(0px)`,opacity:1}],{duration:130,easing:'ease-out'});
      }).catch(()=>{});
    }

    function setActiveTileByIndex(i, dir){
      const clamped = Math.max(0, Math.min(IDX_TO_ID.length-1, i));
      if (clamped === focusedIndex) return;
      focusedIndex = clamped;
      IDX_TO_ID.forEach((id,idx)=>{ const el=$id(id); if(el){ el.classList.toggle('active', idx===focusedIndex); } });
      if (focusedIndex <= 4) {
        const nextCh = focusedIndex + 1;
        if (nextCh !== previewChannel) { previewChannel = nextCh; animateDialTo(previewChannel, dir || 'right'); flashGlow(dir || 'right'); }
      }
      const dcEl = document.querySelector('.dial-center'); if (dcEl){ dcEl.classList.remove('flash'); void dcEl.offsetWidth; dcEl.classList.add('flash'); }
    }

    function moveFocus(dx, dy){
      let col = focusedIndex % 3, row = Math.floor(focusedIndex / 3);
      let nCol = Math.max(0, Math.min(2, col + dx));
      let nRow = Math.max(0, Math.min(1, row + dy));
      let next = nRow*3 + nCol;
      if(next >= IDX_TO_ID.length) next = IDX_TO_ID.length-1;
      const dir = dx>0?'right':dx<0?'left':dy>0?'down':'up';
      setActiveTileByIndex(next, dir);
    }

    // ---------- THEME ----------
    const savedTheme = localStorage.getItem('iptv_theme') || 'light';
    document.body.classList.toggle('light', savedTheme==='light');
    syncThemeSwitch();
    fastBind($id('hdrSwitch'), ()=>{
      const isLight = !document.body.classList.contains('light');
      document.body.classList.toggle('light', isLight);
      localStorage.setItem('iptv_theme', isLight ? 'light' : 'dark');
      syncThemeSwitch(); toast(isLight ? i18n[lang].themeLight : i18n[lang].themeDark);
    });
    function syncThemeSwitch(){ const sw=$id('hdrSwitch'); sw && sw.classList.toggle('on', document.body.classList.contains('light')); }

    onAuthStateChanged(auth, async (user) => {
      if(user){
        $id('login').style.display='none'; $id('remote').style.display='block';
        await afterLogin(user);
      }else{
        $id('login').style.display='block'; $id('remote').style.display='none';
        closeChooser();
        currentDisplay=null; $id('currentDisplay').textContent=i18n[lang].displayTitle;
        if (displayUnsub) { displayUnsub(); displayUnsub=null; }
      }
    });

    async function afterLogin(user){
      let uSnap = await get(ref(db, `user/${user.uid}`));
      if(!uSnap.exists()) uSnap = await get(ref(db, `users/${user.uid}`));
      const u = uSnap.val() || {};
      dealershipId = u.dealershipId ?? u.dealership;
      isAdmin = (u.role === 'admin');

      await buildChooserList();

      const saved = localStorage.getItem('iptv_last_display');
      if(saved && displayIds.includes(saved)){ switchDisplay(saved); }
      else if(displayIds.length){ switchDisplay(displayIds[0]); }

      fastBind($id('currentDisplay'), ()=> openChooser());
      applyI18n(); updateLangButtons(); paintDial(currentChannel); updateVolumeUI();
    }

    async function buildChooserList(){
      displayIds = [];
      const listEl = $id('displayList'); listEl.innerHTML = '';
      if (isAdmin){
        const all = await get(ref(db,'displays'));
        const map = all.val() || {};
        const ids = Object.keys(map).sort();
        ids.forEach(id=>{
          const dealer = map[id]?.dealership || (lang==='fr'?'INCONNU':'UNKNOWN');
          displayIds.push(id);
          const row = document.createElement('div');
          row.className = 'item';
          row.innerHTML = `<b>${id}</b><small>${dealer}</small>`;
          row.addEventListener('click', ()=>{ closeChooser(); switchDisplay(id, null); });
          listEl.appendChild(row);
        });
        $id('chooserTitle').textContent = i18n[lang].chooserAll;
      }else{
        let dSnap = await get(ref(db, `dealership/${dealershipId}/displays`));
        if(!dSnap.exists()) dSnap = await get(ref(db, `dealerships/${dealershipId}/displays`));
        const map = dSnap.val() || {};
        Object.keys(map).forEach(id=>{
          displayIds.push(id);
          const row = document.createElement('div');
          row.className = 'item';
          row.innerHTML = `<b>${id}</b><small>${dealershipId}</small>`;
          row.addEventListener('click', ()=>{ closeChooser(); switchDisplay(id, null); });
          listEl.appendChild(row);
        });
        $id('chooserTitle').textContent = dealershipId ? dealershipId : i18n[lang].chooserMine;
      }
    }

    function openChooser(){ $id('chooser').classList.add('show'); }
    function closeChooser(){ $id('chooser').classList.remove('show'); }
    $id('chooser').addEventListener('click', (e)=>{ if(e.target.id==='chooser'){ closeChooser(); } });

    async function switchDisplay(id){
      if(!id) return;
      currentDisplay = id;
      localStorage.setItem('iptv_last_display', id);
      $id('currentDisplay').textContent = id;
      toast(id);

      if (!isAdmin && dealershipId) {
        try { await update(ref(db, `dealership/${dealershipId}/displays`), { [id]: true }); } catch(e){}
      }

      if (displayUnsub) { displayUnsub(); displayUnsub=null; }
      const dRef = ref(db, `displays/${id}`);
      const off = onValue(dRef, (snap)=>{
        const v = snap.val() || {};
        if (typeof v.channel === 'number') { currentChannel = v.channel; previewChannel = v.channel; paintDial(currentChannel); }
        if (typeof v.volume === 'number') { volume = v.volume; updateVolumeUI(); }
        if (typeof v.muted === 'boolean') {
          muted = v.muted;
          $id('q-mute').classList.toggle('muted', muted);
          $id('muteLabel').textContent = muted ? i18n[lang].mutedOn : i18n[lang].mutedLabel;
        }
      }, (err)=>{ console.warn('display read error', err); });
      displayUnsub = ()=>{ off(); };
    }

    function commitFocusedIfChannel(){
      if (focusedIndex <= 4) {
        const preview = focusedIndex + 1;
        if (preview !== currentChannel) {
          currentChannel = preview;
          paintDial(currentChannel);
          updateDisplay();
          const tileEl = $id(IDX_TO_ID[focusedIndex]);
          const dc = $id('dialContent');
          if (tileEl) { tileEl.classList.add('pulsing'); setTimeout(()=>tileEl.classList.remove('pulsing'), 260); }
          if (dc) { dc.classList.add('pulse'); setTimeout(()=>dc.classList.remove('pulse'), 280); }
          toast(`${i18n[lang].CH} ${currentChannel}`);
        }
      } else {
        toggleMute();
      }
    }

    for (let i=1;i<=5;i++){ fastBind($id(`qch-${i}`), ()=>{ setActiveTileByIndex(i-1, 'right'); commitFocusedIfChannel(); }); }
    fastBind($id('q-mute'), ()=> toggleMute());
    fastBind($id('dialSelect'), ()=> commitFocusedIfChannel());

    fastBind($id('arrowUp'),   ()=> moveFocus(0,-1));
    fastBind($id('arrowDown'), ()=> moveFocus(0, 1));
    fastBind($id('arrowLeft'), ()=> moveFocus(-1,0));
    fastBind($id('arrowRight'),()=> moveFocus( 1,0));

    // Bind volume controls (per-element guard keeps them responsive)
    fastBind($id('volPlus'),  ()=> volUp());
    fastBind($id('volMinus'), ()=> volDown());

    // Swipe focus with orange glow — ensure center button isn't hijacked
    const dial=$id('dial'); let sx=0, sy=0, tracking=false; const TH=28;
    dial.addEventListener('pointerdown',(e)=>{ 
      if ((e.target && e.target.id === 'dialSelect')) return;
      tracking=true; sx=e.clientX; sy=e.clientY; dial.setPointerCapture?.(e.pointerId);
    });
    dial.addEventListener('pointerup',(e)=>{ if(!tracking) return; tracking=false; const dx=e.clientX-sx, dy=e.clientY-sy;
      if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>TH){ moveFocus(dx>0?+1:-1,0); }
      else if(Math.abs(dy)>TH){ moveFocus(0, dy<0?-1:+1); }
    });
    dial.addEventListener('pointercancel',()=>{ tracking=false; });

    applyI18n(); updateLangButtons(); paintDial(currentChannel); updateVolumeUI();

    async function volUp(){ if(!currentDisplay){ toast(i18n[lang].selectDisplay); return; }
      volume=Math.min(100,volume+10); updateVolumeUI(); await updateDisplay(); toast(`${i18n[lang].VOL} ${volume}`); }
    async function volDown(){ if(!currentDisplay){ toast(i18n[lang].selectDisplay); return; }
      volume=Math.max(0,volume-10); updateVolumeUI(); await updateDisplay(); toast(`${i18n[lang].VOL} ${volume}`); }
    async function toggleMute(){ if(!currentDisplay){ toast(i18n[lang].selectDisplay); return; }
      muted=!muted; $id('q-mute').classList.toggle('muted', muted);
      $id('muteLabel').textContent = muted? i18n[lang].mutedOn : i18n[lang].mutedLabel;
      await updateDisplay(); toast(muted?i18n[lang].toastMuted:i18n[lang].toastUnmuted); }

    async function updateDisplay(){
      if(!currentDisplay){ console.warn('[update] no currentDisplay'); return; }
      const base = { channel:currentChannel, volume, muted, timestamp: Date.now() };
      const state = isAdmin ? base : { ...base, dealership: dealershipId };
      await update(ref(db,`displays/${currentDisplay}`), state).catch(err=>{
        console.error('Update failed:', err);
        toast(i18n[lang].updateDenied);
      });
    }
  </script>
</body>
</html>
