<!DOCTYPE html>
<html lang="en">
<head>
  <!-- keep these first -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- START: PWA + Icons -->
  <link rel="manifest" href="/IPTV-/manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png">
  <link rel="apple-touch-icon" href="/IPTV-/icons/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/IPTV-/icons/apple-touch-icon-120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/IPTV-/icons/apple-touch-icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/IPTV-/icons/apple-touch-icon-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/IPTV-/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="IPTV Remote">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <!-- END: PWA + Icons -->

  <title>IPTV — Create Account</title>

  <style>
    :root { --bg:#0b0b0c; --fg:#fff; --muted:#9a9aa0; --panel:#121214; --border:rgba(255,255,255,.14);
            --accent:#ff9500; --tile:#17171a; --tileActive:#1d1d21; --shadow:0 18px 48px rgba(0,0,0,.45); }
    body.light { --bg:#f5f5f7; --fg:#111; --muted:#6e6e73; --panel:#fff; --border:rgba(0,0,0,.12);
                 --accent:#ff9500; --tile:#f2f2f7; --tileActive:#eaeaef; --shadow:0 14px 36px rgba(0,0,0,.10); }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;
         display:flex;align-items:center;justify-content:center;padding:22px;transition:background .25s,color .25s}
    .wrap{width:100%;max-width:420px}
    .brand{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:16px}
    .logo{width:110px;height:110px;background:var(--accent);
      -webkit-mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;
      mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat}
    .title{font-size:22px;font-weight:800;letter-spacing:.4px}
    .subtitle{color:var(--muted);font-size:12px;letter-spacing:1px;text-transform:uppercase}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:28px;padding:22px 18px 18px;box-shadow:var(--shadow)}
    .field{display:flex;flex-direction:column;gap:8px;margin:12px 0}
    .label{font-size:12px;color:var(--muted);letter-spacing:.5px}
    .input, .select{width:100%;padding:14px 14px;background:transparent;border:1px solid var(--border);
       border-radius:14px;color:var(--fg);font-size:16px;text-align:center;outline:none;transition:border-color .18s, box-shadow .18s}
    .input::placeholder{color:var(--muted)}
    .input:focus,.select:focus{border-color:var(--accent); box-shadow:0 0 0 2px rgba(255,149,0,.25)}
    .select{appearance:none;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat:no-repeat;background-position:right 12px center;background-size:20px;padding-right:40px;color:var(--fg)}
    .helper{margin:8px 0 14px;text-align:center;color:var(--muted);font-size:11px;letter-spacing:.8px;text-transform:uppercase}
    .btn{width:100%;padding:14px;background:var(--accent);color:#000;border:none;border-radius:9999px;font-size:16px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(0,0,0,.35);border-top-color:#000;border-radius:50%;
             animation:spin .6s linear infinite;margin-left:10px;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .below{margin-top:16px;text-align:center;color:var(--muted);font-size:14px}
    .below a{color:var(--fg);text-decoration:none;border-bottom:1px dashed var(--border)}
    .toast{position:fixed;bottom:50px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 20px;border-radius:999px;
           font-size:13px;font-weight:700;opacity:0;transition:opacity .25s;pointer-events:none}
    .toast.show{opacity:1}
    .toast.error{background:#ff453a;color:#fff}
    .theme-note{display:block;text-align:center;margin-top:10px;color:var(--muted);font-size:11px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo" role="img" aria-label="IPTV logo"></div>
      <div class="title">Create your account</div>
      <div class="subtitle">Access your dealership remotes</div>
    </div>

    <div class="card">
      <div class="field"><input id="email" class="input" type="email" placeholder="Email" autocomplete="email"></div>
      <div class="field"><input id="password" class="input" type="password" placeholder="Password (6+ characters)" autocomplete="new-password"></div>
      <div class="field"><input id="name" class="input" type="text" placeholder="Your Name" autocomplete="name"></div>

      <div class="helper">Select Dealership</div>
      <div class="field">
        <select id="dealership" class="select">
          <option value="">Loading dealerships…</option>
        </select>
      </div>

      <button id="signupBtn" class="btn" onclick="signUp()">CREATE ACCOUNT</button>
      <small class="theme-note">Theme matches your remote (white/dark)</small>
    </div>

    <div class="below">
      Already have an account? <a href="https://flaviothebfagroup.github.io/IPTV-/remote-control.html">Sign in</a>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Theme sync -->
  <script>
    (function(){
      const saved = localStorage.getItem('iptv_theme') || 'light';
      document.body.classList.toggle('light', saved === 'light');
    })();
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // --- helpers ---
    const $ = (s)=>document.querySelector(s);
    function toast(msg, type=''){ const t=$('#toast'); t.textContent=msg; t.className='toast show'+(type==='error'?' error':''); setTimeout(()=>t.classList.remove('show'),2200); }

    // Load from /dealershipPublic (public-readable list)
    async function loadDealerships() {
      const select = $('#dealership');
      try {
        const snap = await get(ref(db, 'dealershipPublic'));
        select.innerHTML = '<option value="">Choose Dealership…</option>';
        if (snap.exists()) {
          const map = snap.val();
          Object.keys(map).forEach(id => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = map[id]?.name || id;
            select.appendChild(opt);
          });
        } else {
          select.innerHTML = '<option value="">No dealerships available</option>';
        }
      } catch (e) {
        console.error('loadDealerships', e);
        select.innerHTML = '<option value="">Can’t load dealerships</option>';
        toast('Check /dealershipPublic rules', 'error');
      }
    }
    window.addEventListener('DOMContentLoaded', loadDealerships);

    // Enter = submit
    ['#email','#password','#name','#dealership'].forEach(sel=>{
      const el=$(sel); el && el.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); signUp(); } });
    });

    // Sign up
    window.signUp = async function(){
      const email = $('#email').value.trim();
      const password = $('#password').value;
      const name = $('#name').value.trim();
      const select = $('#dealership');
      const dealershipId = select.value;
      const dealershipName = select.options[select.selectedIndex]?.textContent || '';

      if(!email || !password || !name) { toast('Fill all fields','error'); return; }
      if(password.length < 6) { toast('Password must be 6+ chars','error'); return; }
      if(!dealershipId) { toast('Choose dealership','error'); return; }

      const btn = $('#signupBtn');
      btn.disabled = true; btn.innerHTML = 'CREATING <span class="spinner"></span>';

      try {
        await setPersistence(auth, browserLocalPersistence);
        const cred = await createUserWithEmailAndPassword(auth, email, password);

        // Minimal profile that your rules expect:
        await set(ref(db, `user/${cred.user.uid}`), {
          email, name, role: 'user',
          dealershipId, dealershipName,
          createdAt: Date.now()
        });

        toast('Account created!');
        btn.innerHTML = 'SUCCESS — OPENING…';
        setTimeout(()=>{ window.location.href = 'https://flaviothebfagroup.github.io/IPTV-/remote-control.html'; }, 1000);
      } catch (err) {
        console.error('signup', err);
        const code = err?.code || '';
        if (code === 'auth/email-already-in-use')      toast('Email already registered','error');
        else if (code === 'auth/weak-password')        toast('Password too weak','error');
        else if (code === 'auth/invalid-email')        toast('Invalid email','error');
        else                                           toast('Signup failed', 'error');
        btn.disabled = false; btn.textContent = 'CREATE ACCOUNT';
      }
    };
  </script>
</body>
</html>
