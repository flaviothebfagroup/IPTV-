<!DOCTYPE html>
<html lang="en">
<head>
  <!-- PWA -->
<link rel="manifest" href="/IPTV-/manifest.webmanifest">
<meta name="theme-color" content="#000000">

<!-- App icons (Android + desktop) -->
<link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png">

<!-- iOS Add to Home Screen -->
<link rel="apple-touch-icon" sizes="180x180" href="/IPTV-/icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="IPTV Remote">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>IPTV - Sign Up</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: #000; color: #fff; font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .signup-box { width: 100%; max-width: 320px; text-align: center; }
    h1 { font-size: 48px; margin-bottom: 10px; }
    .subtitle { color: #666; font-size: 14px; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 2px; }
    .form { background: #111; border-radius: 30px; padding: 30px; }
    input, select { width: 100%; padding: 15px; margin-bottom: 15px; background: #000; border: 1px solid #222; border-radius: 12px; color: #fff; font-size: 16px; text-align: center; }
    input::placeholder { color: #444; }
    select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 15px center; background-size: 20px; padding-right: 40px; }
    select option { background: #000; color: #fff; }
    .or-divider { color: #444; margin: 15px 0; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
    button { width: 100%; padding: 15px; background: #fff; color: #000; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }
    button:active { background: #ccc; }
    .success-button { background: #0f0; }
    .link { margin-top: 30px; font-size: 14px; color: #666; }
    .link a { color: #fff; text-decoration: none; }
    .toast { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background: #0f0; color: #000; padding: 12px 24px; border-radius: 20px; font-size: 14px; font-weight: 600; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .toast.error { background: #f00; color: #fff; }
    .toast.show { opacity: 1; }
    button:disabled { background: #333; color: #666; }
    .loading-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #666; border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; margin-left: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .add-new { color: #0f0; font-size: 14px; cursor: pointer; margin-bottom: 15px; display: inline-block; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="signup-box">
    <h1 style="margin-bottom:10px"><img src="https://i.ibb.co/LzJwPhjg/ICON-IPTV.png" alt="IPTV" style="height:56px;width:auto" loading="lazy" /></h1>
    <p class="subtitle">Create Account</p>

    <div class="form">
      <input type="email" id="email" placeholder="Email" autocomplete="email" />
      <input type="password" id="password" placeholder="Password" autocomplete="new-password" />
      <input type="text" id="name" placeholder="Your Name" autocomplete="name" />

      <div class="or-divider">Select Dealership</div>
      <select id="dealership">
        <option value="">Loading dealerships...</option>
      </select>
      <input type="text" id="newDealership" placeholder="Enter Dealership Name" class="hidden" />

      <button id="signupBtn" onclick="signUp()">CREATE ACCOUNT</button>
    </div>

    <div class="link">Already have account? <a href="remote.html">Sign In</a></div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      createUserWithEmailAndPassword,
      setPersistence,
      browserLocalPersistence
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Helper: two-letter prefix from dealership name (handles CamelCase & spaces)
    function getTwoLetterPrefix(name) {
      const raw = (name || '').trim();
      if (!raw) return 'DS';
      let parts = raw.match(/[A-ZÀ-ÖØ-Ý][a-zà-öø-ÿ]*/g);
      if (!parts || parts.length < 2) parts = raw.match(/[A-Za-zÀ-ÖØ-öø-ÿ]+/g) || [];
      let first = parts[0] || '';
      let second = parts[1] || '';
      let prefix = '';
      if (first) prefix += first[0];
      if (second) prefix += second[0];
      if (prefix.length < 2 && first.length >= 2) prefix = first.slice(0, 2);
      return prefix.toUpperCase();
    }

    // Toast helper
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message; toast.className = 'toast show';
      if (type === 'error') toast.classList.add('error');
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    // Load dealerships from Firebase (SINGULAR 'dealership')
    async function loadDealerships() {
      try {
        const dealershipsRef = ref(database, 'dealership');
        const snapshot = await get(dealershipsRef);
        const select = document.getElementById('dealership');
        select.innerHTML = '<option value="">Choose Dealership...</option>';
        if (snapshot.exists()) {
          const dealerships = snapshot.val();
          for (const [id, dealership] of Object.entries(dealerships)) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = (dealership && dealership.name) ? dealership.name : id;
            select.appendChild(option);
          }
        }
        const newOption = document.createElement('option');
        newOption.value = 'new';
        newOption.textContent = '+ Add New Dealership';
        select.appendChild(newOption);
      } catch (error) {
        console.error('Error loading dealerships:', error);
        const select = document.getElementById('dealership');
        select.innerHTML = '<option value="">Choose Dealership...</option><option value="new">+ Add New Dealership</option>';
        showToast('Could not load dealerships', 'error');
      }
    }

    window.addEventListener('DOMContentLoaded', loadDealerships);

    // Toggle new dealership input
    document.getElementById('dealership').addEventListener('change', function () {
      const newDealershipInput = document.getElementById('newDealership');
      if (this.value === 'new') { newDealershipInput.classList.remove('hidden'); newDealershipInput.focus(); }
      else { newDealershipInput.classList.add('hidden'); }
    });

    // Sign Up
    window.signUp = async function () {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const name = document.getElementById('name').value.trim();
      const dealershipSelect = document.getElementById('dealership').value;
      const newDealershipName = document.getElementById('newDealership').value.trim();

      if (!email || !password || !name) { showToast('Please fill all fields', 'error'); return; }
      if (password.length < 6) { showToast('Password must be 6+ characters', 'error'); return; }

      // Determine dealershipId & name
      let dealershipId = dealershipSelect;
      let dealershipName = '';
      const isNew = dealershipSelect === 'new';

      if (isNew) {
        if (!newDealershipName) { showToast('Enter dealership name', 'error'); return; }
        dealershipName = newDealershipName;
        dealershipId = newDealershipName.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now();
      } else if (!dealershipSelect) {
        showToast('Select a dealership', 'error'); return;
      } else {
        dealershipId = dealershipSelect;
        const selectedOption = document.querySelector(`#dealership option[value="${dealershipSelect}"]`);
        dealershipName = selectedOption ? selectedOption.textContent : dealershipSelect;
      }

      const btn = document.getElementById('signupBtn');
      btn.disabled = true; btn.innerHTML = 'CREATING<span class="loading-spinner"></span>';

      try {
        // Keep user signed in across redirects
        await setPersistence(auth, browserLocalPersistence);

        // Create user (Auth)
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Displays for this user
        let userDisplays = [];

        if (isNew) {
          // Create ONLY ONE display (e.g., Bfa Group -> BG-001)
          const prefix = getTwoLetterPrefix(dealershipName);
          const displayId = `${prefix}-001`;
          userDisplays = [displayId];

          const dealershipData = {
            name: dealershipName,
            createdBy: email,
            createdAt: Date.now(), // <-- still present
            displays: { [displayId]: true }
          };

          // Write dealership node (singular)
          await set(ref(database, `dealership/${dealershipId}`), dealershipData);

          // Create global display state under /displays for this single screen
          await set(ref(database, `displays/${displayId}`), {
            channel: 1,
            volume: 0,
            muted: true,
            dealership: dealershipId,
            timestamp: Date.now()
          });
        } else {
          // Existing dealership → read its displays list
          const dealershipRef = ref(database, `dealership/${dealershipId}/displays`);
          const snapshot = await get(dealershipRef);
          userDisplays = snapshot.exists() ? Object.keys(snapshot.val()) : [];
        }

        // Create user profile under SINGULAR 'user'
        const userProfile = {
          email,
          name,
          role: 'user',
          dealershipId,
          dealershipName,
          displays: userDisplays,
          createdAt: Date.now()
        };
        await set(ref(database, `user/${user.uid}`), userProfile);

        showToast('Account created!');
        btn.innerHTML = 'SUCCESS! REDIRECTING...';
        btn.style.background = '#0f0';
        setTimeout(() => { window.location.href = 'remote.html'; }, 1200);
      } catch (error) {
        console.error('Signup error:', error);
        if (error.code === 'auth/email-already-in-use') showToast('Email already registered', 'error');
        else if (error.code === 'auth/weak-password') showToast('Password too weak', 'error');
        else if (error.code === 'auth/invalid-email') showToast('Invalid email address', 'error');
        else showToast('Signup failed: ' + error.message, 'error');
        btn.disabled = false; btn.innerHTML = 'CREATE ACCOUNT'; btn.style.background = '#fff';
      }
    };

    // Enter key to submit
    document.addEventListener('keypress', (e) => { if (e.key === 'Enter') signUp(); });
  </script>
</body>
</html>
