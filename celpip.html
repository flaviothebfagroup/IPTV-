<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CELPIP Speed-Study Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --accent: #00c2ff;
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --wrong: #f87171;
      --right: #34d399;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    h1 {
      margin-top: 0;
      text-align: center;
    }
    button {
      cursor: pointer;
      border: none;
      background: var(--accent);
      color: #0f172a;
      font-weight: 700;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      margin-top: 1rem;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    textarea {
      width: 100%;
      resize: vertical;
      min-height: 120px;
      font-size: 1rem;
      padding: 0.6rem;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f172a;
      color: var(--text);
    }
    .timer {
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .streak {
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .feedback {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 6px;
      font-weight: 600;
    }
    .feedback.right {
      background: var(--right);
      color: #0f172a;
    }
    .feedback.wrong {
      background: var(--wrong);
      color: #0f172a;
    }
    ol li {
      margin-bottom: 0.5rem;
    }
    details {
      margin-top: 1.5rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    summary {
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>CELPIP Speed-Study</h1>

    <div class="streak">Streak: <span id="streak">0</span> | Best: <span id="best">0</span></div>
    <div class="timer" id="timer">Press Start</div>

    <div id="writing" hidden>
      <h2>Writing Challenge</h2>
      <p id="writingPrompt"></p>
      <textarea id="writingBox" placeholder="Type a quick outline (≥40 words)…"></textarea>
      <button id="writingSubmit">Submit</button>
      <div id="writingFeedback" class="feedback" hidden></div>
    </div>

    <div id="reading" hidden>
      <h2>Reading Challenge</h2>
      <p id="passage"></p>
      <ol type="A" id="choices"></ol>
      <button id="nextReading">Next</button>
      <div id="readingFeedback" class="feedback" hidden></div>
    </div>

    <button id="startBtn">Start Game</button>

    <details>
      <summary>How to use & Tips</summary>
      <ul>
        <li>Each round = 1 writing task + 1 reading task.</li>
        <li>Writing timer 30 s: aim for ≥40 words; clarity score turns green ≥60.</li>
        <li>Reading timer 90 s per question; pick the best option.</li>
        <li>Streak increases only when both tasks in a round are passed.</li>
        <li>All data stays in your browser; export via console → localStorage.</li>
      </ul>
    </details>
  </div>

  <script>
    /* ===== DATA ===== */
    const writingPrompts = [
      "Write an email to your neighbour asking to water your plants for a week while you are away.",
      "A survey asks: 'Should the city build a new skate park?' Give your opinion and reasons.",
      "You left your bag on the bus. Write a letter to the transit company describing the bag and what to do if found.",
      "Your friend is moving to Canada. Write an email giving two pieces of advice for settling in.",
      "The library wants to cancel weekend story-time. Write an email explaining why it should continue."
    ];

    const readingSets = [
      {
        passage: `Many Canadian cities now offer "green bins" for organic waste. These bins accept food scraps, paper towels, and garden trimmings. The material is turned into compost, which is sold to farmers and gardeners. This program reduces landfill use and cuts greenhouse gases.`,
        question: "What is the main purpose of the green-bin program?",
        choices: [
          "To produce cheap compost for farmers",
          "To decrease landfill waste and emissions",
          "To collect garden trimmings only",
          "To replace garbage trucks"
        ],
        answer: 1
      },
      {
        passage: `Employers in Canada often look for "soft skills" such as teamwork, communication, and problem-solving. Technical knowledge is important, but the ability to work well with others can decide who gets promoted. Job seekers should give examples of these skills in interviews.`,
        question: "According to the passage, which factor most influences promotions?",
        choices: [
          "University degrees",
          "Years of experience",
          "Soft skills",
          "Technical certificates"
        ],
        answer: 2
      },
      {
        passage: `Community gardens are shared spaces where people grow vegetables and flowers. Plots are rented for a small fee, and tools are provided. These gardens increase access to fresh food and create friendships among neighbours. Some cities even offer beginner workshops each spring.`,
        question: "Which statement is true about community gardens?",
        choices: [
          "They are free for all residents",
          "They include training sessions",
          "They sell vegetables to supermarkets",
          "They are run by the federal government"
        ],
        answer: 1
      }
    ];

    /* ===== STATE ===== */
    let streak = 0;
    let best = +(localStorage.getItem("celpip-best") || 0);
    let timer = null;
    let seconds = 0;
    let currentWriting = "";
    let currentReading = null;
    let roundPassed = false;

    /* ===== DOM ===== */
    const els = {
      streak: document.getElementById("streak"),
      best: document.getElementById("best"),
      timer: document.getElementById("timer"),
      startBtn: document.getElementById("startBtn"),
      writing: document.getElementById("writing"),
      writingPrompt: document.getElementById("writingPrompt"),
      writingBox: document.getElementById("writingBox"),
      writingSubmit: document.getElementById("writingSubmit"),
      writingFeedback: document.getElementById("writingFeedback"),
      reading: document.getElementById("reading"),
      passage: document.getElementById("passage"),
      choices: document.getElementById("choices"),
      nextReading: document.getElementById("nextReading"),
      readingFeedback: document.getElementById("readingFeedback")
    };
    els.best.textContent = best;

    /* ===== UTILS ===== */
    function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function readability(text) {
      // Simple Flesch Reading Ease-ish (scaled 0-100)
      const words = text.trim().split(/\s+/).length || 1;
      const sentences = text.split(/[.!?]+/).filter(Boolean).length || 1;
      const syllables = text.replace(/[^a-zA-Z]/g, "")
        .split("")
        .filter(c => /[aeiouAEIOU]/.test(c)).length;
      const score = Math.max(
        0,
        Math.min(
          100,
          206.835 - 1.015 * (words / sentences) - 84.6 * (syllables / words)
        )
      );
      return Math.round(score);
    }

    /* ===== TIMING ===== */
    function runTimer(limit, onTick, onEnd) {
      clearInterval(timer);
      seconds = limit;
      onTick(seconds);
      timer = setInterval(() => {
        seconds--;
        onTick(seconds);
        if (seconds <= 0) {
          clearInterval(timer);
          onEnd();
        }
      }, 1000);
    }

    /* ===== WRITING ROUND ===== */
    function startWriting() {
      roundPassed = false;
      currentWriting = shuffle([...writingPrompts])[0];
      els.writingPrompt.textContent = currentWriting;
      els.writingBox.value = "";
      els.writingFeedback.hidden = true;
      els.writingSubmit.disabled = false;
      els.reading.hidden = true;
      els.writing.hidden = false;

      runTimer(
        30,
        (s) => (els.timer.textContent = `Writing time: ${s}s`),
        () => {
          els.writingSubmit.disabled = true;
          if (!els.writingBox.value.trim()) {
            els.writingFeedback.textContent = "Time up! No text entered.";
            els.writingFeedback.className = "feedback wrong";
            els.writingFeedback.hidden = false;
            setTimeout(startReading, 1500);
          }
        }
      );
    }

    els.writingSubmit.onclick = () => {
      clearInterval(timer);
      const text = els.writingBox.value.trim();
      if (text.split(/\s+/).length < 20) {
        els.writingFeedback.textContent =
          "Too short! Aim for at least 40 words.";
        els.writingFeedback.className = "feedback wrong";
        els.writingFeedback.hidden = false;
        setTimeout(startReading, 1500);
        return;
      }
      const score = readability(text);
      const pass = score >= 60;
      if (pass) roundPassed = true;
      els.writingFeedback.textContent = `Clarity score: ${score}/100 ${
        pass ? "✓ Pass" : "✗ Try shorter sentences"
      }`;
      els.writingFeedback.className = pass ? "feedback right" : "feedback wrong";
      els.writingFeedback.hidden = false;
      setTimeout(startReading, 1500);
    };

    /* ===== READING ROUND ===== */
    function startReading() {
      els.writing.hidden = true;
      els.reading.hidden = false;
      els.readingFeedback.hidden = true;
      currentReading = shuffle([...readingSets])[0];

      els.passage.textContent = currentReading.passage;
      els.choices.innerHTML = "";
      currentReading.choices.forEach((c, i) => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = c;
        btn.onclick = () => checkReading(i);
        li.appendChild(btn);
        els.choices.appendChild(li);
      });

      runTimer(
        90,
        (s) => (els.timer.textContent = `Reading time: ${s}s`),
        () => {
          els.readingFeedback.textContent = "Time up!";
          els.readingFeedback.className = "feedback wrong";
          els.readingFeedback.hidden = false;
          disableChoices();
          setTimeout(endRound, 1500);
        }
      );
    }

    function checkReading(idx) {
      clearInterval(timer);
      disableChoices();
      const correct = idx === currentReading.answer;
      if (!correct) roundPassed = false;
      els.readingFeedback.textContent = correct
        ? "Correct!"
        : `Wrong! Answer: ${["A", "B", "C", "D"][currentReading.answer]}`;
      els.readingFeedback.className = correct ? "feedback right" : "feedback wrong";
      els.readingFeedback.hidden = false;
      setTimeout(endRound, 1500);
    }

    function disableChoices() {
      [...els.choices.querySelectorAll("button")].forEach((b) => (b.disabled = true));
    }

    /* ===== ROUND END ===== */
    function endRound() {
      if (roundPassed) {
        streak++;
        if (streak > best) {
          best = streak;
          localStorage.setItem("celpip-best", best);
          els.best.textContent = best;
        }
      } else {
        streak = 0;
      }
      els.streak.textContent = streak;
      els.startBtn.textContent = "Next Round";
      els.startBtn.hidden = false;
      els.timer.textContent = "Round over";
      els.reading.hidden = true;
    }

    /* ===== START ===== */
    els.startBtn.onclick = () => {
      els.startBtn.hidden = true;
      startWriting();
    };
  </script>
</body>
</html>
