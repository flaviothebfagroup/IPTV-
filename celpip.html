<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CELPIP Writing Practice (Simple)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121926;
      --muted:#93a4b8;
      --text:#e9f0f7;
      --line:#223047;
      --accent:#ff9500;
      --ok:#34c759;
      --warn:#ffd60a;
      --bad:#ff453a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 10% 0%, #182234 0%, transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, #2a1f12 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--line);border-radius:14px;background:rgba(18,25,38,.78);
      backdrop-filter: blur(10px);
    }
    .title{display:flex;flex-direction:column;gap:2px}
    h1{font-size:18px;margin:0}
    .sub{font-size:13px;color:var(--muted)}
    .row{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px}
    @media (max-width: 920px){ .row{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(18,25,38,.78);
      backdrop-filter: blur(10px);
      padding:14px;
    }
    .toolbar{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
      margin-bottom:10px
    }
    .leftTools,.rightTools{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    label{font-size:12px;color:var(--muted)}
    select, button{
      border:1px solid var(--line);
      background:#0e1522;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
    }
    button.primary{border-color:rgba(255,149,0,.55); background:rgba(255,149,0,.12)}
    button:active{transform: translateY(1px)}
    .stats{display:grid;grid-template-columns: repeat(4,1fr); gap:10px; margin-top:10px}
    @media (max-width: 520px){ .stats{grid-template-columns: repeat(2,1fr);} }
    .pill{
      border:1px solid var(--line);
      background:#0d1421;
      border-radius:12px;
      padding:10px;
      min-height:52px;
    }
    .pill .k{font-size:12px;color:var(--muted)}
    .pill .v{font-size:16px;margin-top:4px}
    textarea{
      width:100%;
      min-height:340px;
      resize:vertical;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      background:#0b1220;
      color:var(--text);
      font-size:15px;
      line-height:1.45;
    }
    textarea:focus{border-color:rgba(255,149,0,.55); box-shadow:0 0 0 3px rgba(255,149,0,.08)}
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px 0}
    .sectionTitle h2{font-size:14px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      background:#0d1421;
      border-radius:12px;
      padding:10px;
    }
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 9px;border-radius:999px;border:1px solid var(--line);
      font-size:12px;color:var(--muted);background:#0b1220;
      margin-right:6px;margin-bottom:6px;
    }
    .badge.ok{border-color:rgba(52,199,89,.35); color:#b7f7c7}
    .badge.warn{border-color:rgba(255,214,10,.35); color:#fff1a8}
    .badge.bad{border-color:rgba(255,69,58,.35); color:#ffb3ad}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid var(--line);
      background:#0b1220;
      color:var(--text);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{border-color:rgba(255,149,0,.55)}
    .toast{
      position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
      background:rgba(18,25,38,.95);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease;
    }
    .toast.show{opacity:1}
    .smallBtn{padding:8px 10px;font-size:12px}
    .hr{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>CELPIP Writing Practice (Simple)</h1>
        <div class="sub">Write ‚Üí check structure ‚Üí copy prompt ‚Üí paste into ChatGPT for CLB feedback.</div>
      </div>
      <div class="rightTools">
        <button class="smallBtn" id="btnReset">Clear</button>
        <button class="smallBtn" id="btnSave">Save draft</button>
        <button class="smallBtn" id="btnLoad">Load</button>
      </div>
    </header>

    <div class="row">
      <!-- LEFT -->
      <div class="card">
        <div class="toolbar">
          <div class="leftTools">
            <div>
              <label for="task">Task</label><br/>
              <select id="task">
                <option value="task1">Task 1 (Email)</option>
                <option value="task2">Task 2 (Survey / Opinion)</option>
              </select>
            </div>
            <div>
              <label for="mode">Mode</label><br/>
              <select id="mode">
                <option value="easy">Easy (more hints)</option>
                <option value="hard">Hard (test-like)</option>
              </select>
            </div>
            <div>
              <label for="target">Target</label><br/>
              <select id="target">
                <option value="clb7">CLB 7</option>
                <option value="clb9" selected>CLB 9</option>
                <option value="clb10">CLB 10+</option>
              </select>
            </div>
          </div>

          <div class="rightTools">
            <button id="btnTemplate">Show template</button>
            <button id="btnQuickFix">Quick suggestions</button>
            <button class="primary" id="btnCopyPrompt">Copy ‚ÄúCheck with ChatGPT‚Äù prompt</button>
            <button class="primary" id="btnOpenChatGPT">Open ChatGPT</button>
          </div>
        </div>

        <textarea id="text" placeholder="Write your response here‚Ä¶"></textarea>

        <div class="stats">
          <div class="pill"><div class="k">Words</div><div class="v" id="words">0</div></div>
          <div class="pill"><div class="k">Sentences</div><div class="v" id="sentences">0</div></div>
          <div class="pill"><div class="k">Paragraphs</div><div class="v" id="paras">0</div></div>
          <div class="pill"><div class="k">Connectors used</div><div class="v" id="connectors">0</div></div>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">
          <h2>Structure Check</h2>
          <div class="muted" id="hintLine"></div>
        </div>
        <div class="chips" id="checks"></div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="sectionTitle">
          <h2>Tools (offline + simple)</h2>
          <div class="muted">Click chips to insert.</div>
        </div>

        <div class="item">
          <div class="muted">High-value connectors (helps coherence)</div>
          <div class="chips" id="connectorChips"></div>
        </div>

        <div class="item">
          <div class="muted">Upgraded vocabulary (swap simple words)</div>
          <div class="chips" id="vocabChips"></div>
        </div>

        <div class="item">
          <div class="muted">Top repeated words (aim to reduce)</div>
          <div class="chips" id="repeatChips"></div>
        </div>

        <div class="item">
          <div class="muted">Template / Feedback</div>
          <div class="list">
            <div id="templateBox" class="muted">Click ‚ÄúShow template‚Äù.</div>
            <div id="suggestionsBox" class="muted">Click ‚ÄúQuick suggestions‚Äù.</div>
          </div>
        </div>

        <div class="item">
          <div class="muted">How the ‚ÄúCheck with ChatGPT‚Äù button works</div>
          <div class="muted">
            It copies a prompt + your writing to your clipboard. Then you open ChatGPT and paste it.
            (No API keys, no complicated setup.)
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const el = (id) => document.getElementById(id);

    const text = el("text");
    const wordsEl = el("words");
    const sentencesEl = el("sentences");
    const parasEl = el("paras");
    const connectorsEl = el("connectors");
    const checksEl = el("checks");
    const templateBox = el("templateBox");
    const suggestionsBox = el("suggestionsBox");
    const hintLine = el("hintLine");

    const taskSel = el("task");
    const modeSel = el("mode");
    const targetSel = el("target");

    const connectorChips = el("connectorChips");
    const vocabChips = el("vocabChips");
    const repeatChips = el("repeatChips");

    const toast = el("toast");

    const CONNECTORS = [
      "However,", "Therefore,", "Moreover,", "In addition,", "For example,",
      "On the other hand,", "As a result,", "From my perspective,",
      "To be specific,", "That said,", "In conclusion,"
    ];

    // Simple offline ‚Äúupgrade‚Äù swaps (not perfect ‚Äî just helpful)
    const VOCAB_UPGRADES = [
      ["good", "beneficial"],
      ["bad", "unfavorable"],
      ["big", "significant"],
      ["small", "minor"],
      ["help", "assist"],
      ["need", "require"],
      ["think", "believe"],
      ["important", "essential"],
      ["problem", "issue"],
      ["fix", "resolve"],
      ["get", "obtain"],
      ["use", "utilize"]
    ];

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1400);
    }

    function insertAtCursor(str){
      const start = text.selectionStart;
      const end = text.selectionEnd;
      const before = text.value.slice(0, start);
      const after = text.value.slice(end);
      text.value = before + str + after;
      const pos = start + str.length;
      text.setSelectionRange(pos, pos);
      text.focus();
      updateAll();
    }

    function countWords(s){
      const w = s.trim().match(/\b[\w‚Äô'-]+\b/g);
      return w ? w.length : 0;
    }
    function countSentences(s){
      const m = s.trim().match(/[^.!?]+[.!?]+/g);
      if (!s.trim()) return 0;
      return m ? m.length : Math.max(1, s.split(/\n+/).filter(Boolean).length); // fallback
    }
    function countParagraphs(s){
      const paras = s.trim().split(/\n\s*\n/).filter(p => p.trim().length);
      return s.trim().length ? paras.length : 0;
    }

    function connectorCount(s){
      const lower = s.toLowerCase();
      let c = 0;
      for (const w of CONNECTORS){
        const token = w.toLowerCase().replace(",", "");
        if (lower.includes(token)) c++;
      }
      return c;
    }

    function buildChecks(){
      const s = text.value;
      const wc = countWords(s);
      const sc = countSentences(s);
      const pc = countParagraphs(s);
      const cc = connectorCount(s);

      wordsEl.textContent = wc;
      sentencesEl.textContent = sc;
      parasEl.textContent = pc;
      connectorsEl.textContent = cc;

      const mode = modeSel.value;
      const task = taskSel.value;

      // Suggested min words (practical targets)
      const minWords = (task === "task1") ? 150 : 200;
      const targetWords = (task === "task1") ? 180 : 240;

      hintLine.textContent = (mode === "easy")
        ? `Aim: ${minWords}+ words (sweet spot ~${targetWords}), 2+ paragraphs, clear purpose + details.`
        : `Test mode: write naturally; check word count + clarity.`;

      const checks = [];

      // Word count
      if (wc >= minWords) checks.push(["ok", `Word count ‚úÖ (${wc})`]);
      else if (wc >= Math.floor(minWords * 0.75)) checks.push(["warn", `Word count nearly there (${wc}/${minWords})`]);
      else checks.push(["bad", `Word count low (${wc}/${minWords})`]);

      // Paragraphs
      if (pc >= 2) checks.push(["ok", `Paragraphs ‚úÖ (${pc})`]);
      else checks.push(["warn", `Add paragraphs (aim 2+)`]);

      // Connectors
      if (cc >= 3) checks.push(["ok", `Connectors ‚úÖ (${cc})`]);
      else if (cc >= 1) checks.push(["warn", `Add 2‚Äì3 connectors`]);
      else checks.push(["warn", `Add connectors (However, Therefore, etc.)`]);

      // Task-specific
      if (task === "task1"){
        // email basics
        const hasGreeting = /dear|hello|hi\s/i.test(s);
        const hasClosing = /sincerely|best regards|thank you|kind regards/i.test(s);
        checks.push([hasGreeting ? "ok":"warn", hasGreeting ? "Greeting ‚úÖ" : "Add greeting (Dear‚Ä¶, Hello‚Ä¶)" ]);
        checks.push([hasClosing ? "ok":"warn", hasClosing ? "Closing ‚úÖ" : "Add closing (Thank you‚Ä¶, Sincerely‚Ä¶)" ]);
      } else {
        // opinion / survey basics
        const hasOpinion = /i believe|in my opinion|from my perspective|i think/i.test(s.toLowerCase());
        const hasExample = /for example|for instance|such as/i.test(s.toLowerCase());
        checks.push([hasOpinion ? "ok":"warn", hasOpinion ? "Opinion stated ‚úÖ" : "State your opinion clearly"]);
        checks.push([hasExample ? "ok":"warn", hasExample ? "Example/details ‚úÖ" : "Add 1 example/detail"]);
      }

      // Basic ‚Äúreadability‚Äù hint
      const avgSentLen = sc ? (wc / sc) : 0;
      if (avgSentLen > 26) checks.push(["warn", `Sentences a bit long (avg ~${avgSentLen.toFixed(1)} words). Split 1‚Äì2.`]);
      else checks.push(["ok", `Sentence length ‚úÖ (avg ~${avgSentLen.toFixed(1)})`]);

      checksEl.innerHTML = "";
      for (const [kind, label] of checks){
        const span = document.createElement("span");
        span.className = `badge ${kind}`;
        span.textContent = label;
        checksEl.appendChild(span);
      }
    }

    function buildConnectorChips(){
      connectorChips.innerHTML = "";
      for (const c of CONNECTORS){
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = c;
        chip.onclick = ()=>insertAtCursor((text.value && !text.value.endsWith(" ") ? " " : "") + c + " ");
        connectorChips.appendChild(chip);
      }
    }

    function buildVocabChips(){
      vocabChips.innerHTML = "";
      for (const [plain, upgraded] of VOCAB_UPGRADES){
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = `${plain} ‚Üí ${upgraded}`;
        chip.onclick = ()=>insertAtCursor(`${upgraded}`);
        vocabChips.appendChild(chip);
      }
    }

    function buildRepeats(){
      const s = text.value.toLowerCase();
      const words = (s.match(/\b[a-z‚Äô'-]+\b/g) || [])
        .filter(w => w.length > 3 && !["this","that","with","have","from","they","them","there","your","would","will","about","because"].includes(w));
      const freq = new Map();
      for (const w of words) freq.set(w, (freq.get(w)||0)+1);

      const top = [...freq.entries()]
        .sort((a,b)=>b[1]-a[1])
        .slice(0, 10)
        .filter(([,n])=>n>=3);

      repeatChips.innerHTML = "";
      if (!top.length){
        const span = document.createElement("span");
        span.className = "muted";
        span.textContent = "No heavy repeats (nice).";
        repeatChips.appendChild(span);
        return;
      }
      for (const [w,n] of top){
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = `${w} √ó${n}`;
        chip.onclick = ()=>insertAtCursor(`(${w})`);
        repeatChips.appendChild(chip);
      }
    }

    function showTemplate(){
      const task = taskSel.value;
      const mode = modeSel.value;

      if (task === "task1"){
        templateBox.innerHTML =
`<b>Task 1 (Email) template</b><br><br>
<b>Greeting</b><br>
Dear [Name],<br><br>
<b>Purpose</b><br>
I‚Äôm writing to [reason].<br><br>
<b>Details</b><br>
‚Ä¢ First detail (time/place).<br>
‚Ä¢ Second detail (what you need).<br>
‚Ä¢ Optional: short explanation / impact.<br><br>
<b>Request / Next step</b><br>
Could you please [request]?<br><br>
<b>Closing</b><br>
Thank you for your time.<br>
Sincerely,<br>
[Your Name]`;
      } else {
        templateBox.innerHTML =
`<b>Task 2 (Survey/Opinion) template</b><br><br>
<b>Position</b><br>
From my perspective, I believe [your opinion].<br><br>
<b>Reason 1 + example</b><br>
First, [reason]. For example, [specific example].<br><br>
<b>Reason 2 + example</b><br>
Moreover, [reason]. For instance, [detail].<br><br>
<b>Wrap-up</b><br>
Therefore, I recommend [recommendation].`;
      }

      if (mode === "easy"){
        templateBox.innerHTML += `<br><br><span class="muted">Easy tip: keep it 2‚Äì3 paragraphs, add 2‚Äì4 connectors, and include 1 concrete example.</span>`;
      } else {
        templateBox.innerHTML += `<br><br><span class="muted">Hard mode: don‚Äôt overthink‚Äîfocus on clarity + specific details.</span>`;
      }
    }

    function quickSuggestions(){
      const s = text.value.trim();
      if (!s){
        suggestionsBox.textContent = "Write something first üôÇ";
        return;
      }

      const task = taskSel.value;
      const target = targetSel.value;

      const tips = [];
      const wc = countWords(s);

      if (task === "task1"){
        tips.push("‚úÖ Email checklist: greeting + purpose + details + request + closing.");
        tips.push("Add 1‚Äì2 specifics (date/time/location) to sound real.");
      } else {
        tips.push("‚úÖ Opinion checklist: clear opinion + 2 reasons + 1 example + conclusion.");
        tips.push("Make your examples concrete (numbers, place, situation).");
      }

      if (target === "clb9"){
        tips.push("CLB 9 vibe: clear structure + good connectors + varied vocabulary (but still natural).");
      } else if (target === "clb10"){
        tips.push("CLB 10+ vibe: very clear logic + precise wording + almost no grammar mistakes.");
      } else {
        tips.push("CLB 7 vibe: keep it simple, correct, and organized.");
      }

      if (wc < ((task==="task1")?150:200)) tips.push("Word count is low ‚Äî add one more paragraph with details.");

      // ‚ÄúReading 5 fix‚Äù style: push clarity + paraphrase
      tips.push("Before you finish: re-read once and fix 3 things: articles (a/the), verb tense, and punctuation.");

      suggestionsBox.innerHTML = tips.map(t=>`‚Ä¢ ${t}`).join("<br>");
    }

    function buildChatGPTPrompt(){
      const writing = text.value.trim();
      const task = taskSel.value;
      const target = targetSel.value;

      const header =
`You are an official CELPIP Writing examiner and tutor.

Goal: estimate my CLB level and CELPIP level for this response, and help me improve.
Target: ${target.toUpperCase()}.

Please do ALL of the following:
1) Give an estimated CLB + CELPIP level for EACH criterion:
   - Task fulfillment / Content
   - Coherence & organization
   - Vocabulary range & precision
   - Grammar accuracy & variety
2) Give ONE overall estimated CELPIP level (1‚Äì12) and overall CLB.
3) List my TOP 5 fixes (most important first).
4) Give a stronger revised version (same meaning, natural English, not too fancy).
5) Give 10 ‚Äúupgrade phrases‚Äù I can reuse (connectors + polite phrases).

Here is the task type: ${task === "task1" ? "CELPIP Task 1 (Email)" : "CELPIP Task 2 (Survey/Opinion)"}.

My response:
"""`;

      const footer = `"""
Be strict but fair. If something is unclear, tell me exactly where and how to fix it.`;

      return header + "\n" + writing + "\n" + footer;
    }

    async function copyPrompt(){
      const writing = text.value.trim();
      if (!writing){
        showToast("Write something first.");
        return;
      }
      const prompt = buildChatGPTPrompt();
      try{
        await navigator.clipboard.writeText(prompt);
        showToast("Copied. Paste into ChatGPT.");
      } catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = prompt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast("Copied (fallback). Paste into ChatGPT.");
      }
    }

    function updateAll(){
      buildChecks();
      buildRepeats();
    }

    // Buttons
    el("btnTemplate").onclick = ()=>{ showTemplate(); showToast("Template updated."); };
    el("btnQuickFix").onclick = ()=>{ quickSuggestions(); showToast("Suggestions updated."); };
    el("btnCopyPrompt").onclick = copyPrompt;
    el("btnOpenChatGPT").onclick = ()=>{
      window.open("https://chatgpt.com/", "_blank", "noopener,noreferrer");
      showToast("ChatGPT opened. Paste the prompt.");
    };

    el("btnReset").onclick = ()=>{
      text.value = "";
      templateBox.textContent = "Click ‚ÄúShow template‚Äù.";
      suggestionsBox.textContent = "Click ‚ÄúQuick suggestions‚Äù.";
      updateAll();
      showToast("Cleared.");
    };

    el("btnSave").onclick = ()=>{
      localStorage.setItem("celpip_draft_v1", text.value);
      showToast("Saved.");
    };
    el("btnLoad").onclick = ()=>{
      const v = localStorage.getItem("celpip_draft_v1") || "";
      text.value = v;
      updateAll();
      showToast("Loaded.");
    };

    // Live updates
    text.addEventListener("input", updateAll);
    taskSel.addEventListener("change", ()=>{ showTemplate(); updateAll(); });
    modeSel.addEventListener("change", ()=>{ showTemplate(); updateAll(); });
    targetSel.addEventListener("change", updateAll);

    // Build chips
    buildConnectorChips();
    buildVocabChips();
    showTemplate();
    updateAll();
  </script>
</body>
</html>