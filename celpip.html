<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CELPIP Writing Practice — Test Mode</title>
  <style>
    :root{
      --bg:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#d1d5db;
      --btn:#f3f4f6;
      --btnBorder:#cbd5e1;
      --primary:#2563eb;
      --good:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;
      --shadow:0 1px 2px rgba(0,0,0,.06);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:var(--sans); background:var(--bg); color:var(--ink); }
    .topbar{
      position:sticky; top:0; z-index:10;
      background:#fff; border-bottom:1px solid var(--border); box-shadow:var(--shadow);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto; padding:10px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .title{ font-weight:800; font-size:14px; letter-spacing:.2px; }
    .meta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-size:12px; color:var(--muted); }
    .pill{
      border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:999px;
      display:flex; gap:8px; align-items:center;
    }
    .pill b{ color:var(--ink); font-family:var(--mono); font-size:12px; }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .grid{ display:grid; grid-template-columns:360px 1fr; gap:14px; align-items:start; }
    @media (max-width: 920px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--border); border-radius:10px; background:#fff; box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-hd{
      padding:12px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .card-hd h2{ margin:0; font-size:13px; font-weight:800; }
    .card-bd{ padding:12px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    select, textarea{
      width:100%; border:1px solid var(--border); border-radius:8px; padding:10px;
      font-family:var(--sans); font-size:13px; background:#fff; color:var(--ink); outline:none;
    }
    textarea{ min-height:340px; resize:vertical; line-height:1.45; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button{
      border:1px solid var(--btnBorder); background:var(--btn); border-radius:8px;
      padding:9px 10px; font-weight:800; font-size:12px; cursor:pointer; color:var(--ink);
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{ background:rgba(37,99,235,.10); border-color:rgba(37,99,235,.35); color:#1d4ed8; }
    button.good{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.35); color:#15803d; }
    button.bad{ background:rgba(220,38,38,.10); border-color:rgba(220,38,38,.35); color:#b91c1c; }
    .muted{ color:var(--muted); font-size:12px; }
    .divider{ height:1px; background:var(--border); margin:10px 0; }
    .prompt-title{ font-weight:900; font-size:13px; margin:0 0 6px 0; }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }
    .bullets{ margin:8px 0 0 0; padding-left:16px; font-size:12.5px; }
    .bullets li{ margin:5px 0; }
    .toast{
      padding:9px 10px; border:1px solid var(--border); border-radius:8px; font-size:12px; background:#fff;
    }
    .toast.good{ border-color:rgba(22,163,74,.35); }
    .toast.bad{ border-color:rgba(220,38,38,.35); }

    .checklist .item{
      display:flex; gap:8px; align-items:flex-start; padding:8px; border:1px solid var(--border);
      border-radius:8px; margin-bottom:8px; font-size:12px; background:#fff;
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:#e5e7eb; margin-top:3px; flex:0 0 10px; border:1px solid #d1d5db; }
    .dot.good{ background:var(--good); border-color:rgba(22,163,74,.6); }
    .dot.warn{ background:var(--warn); border-color:rgba(217,119,6,.6); }
    .dot.bad{ background:var(--bad); border-color:rgba(220,38,38,.6); }

    .scoreline{ font-family:var(--mono); font-size:12px; color:var(--muted); text-align:right; }
    .bar{ border:1px solid var(--border); border-radius:999px; height:10px; overflow:hidden; background:#f9fafb; }
    .bar > div{ height:100%; width:0%; background:rgba(37,99,235,.6); }

    /* Templates + quick inserts */
    .templateBox{
      border:1px solid var(--border); border-radius:8px; background:#fff; padding:10px;
    }
    .templatePreview{
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      background:#fff;
      border:1px dashed var(--border);
      border-radius:8px;
      padding:10px;
      max-height:160px;
      overflow:auto;
      line-height:1.35;
      margin-top:8px;
    }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .chip:hover{ background:#f9fafb; }

    /* Phone: Prompt/Write tabs + sticky bottom actions */
    .mobileTabs{ display:none; gap:8px; }
    .tabBtn{ flex:1; text-align:center; }
    .tabBtn.active{ border-color:rgba(37,99,235,.35); background:rgba(37,99,235,.10); color:#1d4ed8; }

    .pane{ display:block; }
    .stickyActions{
      display:none;
      position:sticky;
      bottom:0;
      background:#fff;
      border-top:1px solid var(--border);
      padding:10px 12px;
      box-shadow:0 -1px 2px rgba(0,0,0,.06);
      gap:8px;
      z-index:9;
    }

    @media (max-width: 920px){
      .mobileTabs{ display:flex; }
      .grid{ gap:10px; }
      .stickyActions{ display:flex; }
      textarea{ min-height:300px; }
      .wrap{ padding:10px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="title">CELPIP Writing Practice — Test Mode</div>
      <div class="meta">
        <div class="pill">Task: <b id="taskLabel">Task 1</b></div>
        <div class="pill">Timer: <b id="timer">27:00</b></div>
        <div class="pill">Words: <b id="words">0</b></div>
        <div class="pill">Target: <b id="target">150–200</b></div>
        <div class="pill">Autosave: <b id="autosave">On</b></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Mobile tabs -->
    <div class="mobileTabs">
      <button class="tabBtn active" id="tabPrompt">Prompt</button>
      <button class="tabBtn" id="tabWrite">Write</button>
    </div>

    <div class="grid">
      <!-- LEFT: prompt + checklist -->
      <div class="card pane" id="panePrompt">
        <div class="card-hd">
          <div>
            <h2>Prompt</h2>
            <div class="muted">Pick Task + prompt. Press Start.</div>
          </div>
        </div>
        <div class="card-bd">
          <div class="row">
            <div style="flex:1">
              <label for="taskSelect">Task</label>
              <select id="taskSelect">
                <option value="t1">Task 1 — Email (27 min)</option>
                <option value="t2">Task 2 — Opinion (26 min)</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="promptSelect">Prompt</label>
              <select id="promptSelect"></select>
            </div>
          </div>

          <div class="divider"></div>

          <p class="prompt-title" id="promptTitle">—</p>
          <div class="hint" id="promptDesc">—</div>
          <ul class="bullets" id="promptReq"></ul>

          <div class="divider"></div>

          <div class="row">
            <button class="good" id="startBtn">Start</button>
            <button id="pauseBtn">Pause</button>
            <button class="bad" id="resetBtn">Reset</button>
          </div>

          <div style="margin-top:10px" class="row">
            <button class="primary" id="newPromptBtn">New Prompt</button>
            <button id="checkBtnLeft">Check</button>
          </div>

          <div class="divider"></div>

          <div class="toast" id="status">
            Tip: Keep sentences short. Hit every bullet. That’s the score.
          </div>

          <div class="divider"></div>

          <h2 style="font-size:13px;margin:0 0 8px 0;">Templates (insert + study)</h2>
          <div class="templateBox">
            <div class="row">
              <button class="primary" id="insertTemplateBtn">Insert Template</button>
              <button id="copyTemplateBtn">Copy Template</button>
            </div>
            <div class="hint" style="margin-top:8px">
              Insert puts a full “test-ready skeleton” into your answer box. Then you just fill the blanks.
            </div>
            <div class="templatePreview" id="templatePreview">—</div>
          </div>

          <div class="divider"></div>

          <h2 style="font-size:13px;margin:0 0 8px 0;">Quick phrases (tap to insert)</h2>
          <div class="chips" id="chips"></div>

          <div class="divider"></div>

          <h2 style="font-size:13px;margin:0 0 8px 0;">Checklist (auto)</h2>
          <div class="checklist" id="checklist"></div>

          <div class="divider"></div>
          <div class="hint">
            Phone trick: write in <b>short sentences</b> and check the checklist before time ends.
          </div>
        </div>
      </div>

      <!-- RIGHT: writing -->
      <div class="card pane" id="paneWrite">
        <div class="card-hd">
          <div>
            <h2>Your Answer</h2>
            <div class="muted">Task 1: 2 short paragraphs. Task 2: 4 paragraphs.</div>
          </div>
          <div style="text-align:right">
            <div class="scoreline" id="lengthLine">Length: 0 words</div>
            <div class="bar"><div id="barFill"></div></div>
            <div class="scoreline" id="paraLine" style="margin-top:6px">Paragraphs: 0</div>
          </div>
        </div>
        <div class="card-bd">
          <textarea id="answer" placeholder="Type your response here..."></textarea>

          <div class="divider"></div>

          <div class="row">
            <button class="primary" id="checkBtn">Check</button>
            <button id="clearBtn" class="bad">Clear</button>
            <button id="saveBtn">Save Now</button>
            <button id="loadBtn">Load Saved</button>
          </div>

          <div class="hint" style="margin-top:10px">
            Exam habit: last 4 minutes = fix “I/you”, there/their, to/too, verb endings, and add a final “Therefore/Overall”.
          </div>
        </div>

        <!-- Sticky bottom actions on mobile -->
        <div class="stickyActions">
          <button class="good" id="startBtn2">Start</button>
          <button id="pauseBtn2">Pause</button>
          <button class="primary" id="checkBtn2">Check</button>
          <button class="bad" id="resetBtn2">Reset</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== Storage ======
  const STORE_KEY = "celpip_test_mode_v3_answer";
  const STORE_META = "celpip_test_mode_v3_meta";

  // ====== Data ======
  const DATA = {
    t1: {
      label: "Task 1",
      minutes: 27,
      targetMin: 150,
      targetMax: 200,
      templates: {
        "Standard (Complaint/Issue)": (p)=>`Dear ${p.to},\n\nI hope you’re doing well. I’m writing regarding ${p.topic}${p.id ? " ("+p.id+")" : ""}.\n\nFor the past [time], [problem]. To troubleshoot, I have already [what you tried], but the issue continues.\n\nCould you please [request action] and confirm the next steps? If possible, please confirm the expected timeline by [deadline]. I am available [availability].\n\nThank you for your assistance. I look forward to your response.\n\nKind regards,\n[Your Name]`,
        "Request/Permission (Work)": (p)=>`Dear ${p.to},\n\nI hope you’re doing well. I’m writing to request [request] on [day/date] due to [reason].\n\nI am scheduled to work [schedule], and I would like to [specific request] at [time].\n\nIf approved, I can [make-up plan] to ensure my work is completed. If needed, I can also [backup plan].\n\nThank you for your time and understanding. I look forward to your response.\n\nKind regards,\n[Your Name]`,
        "Customer Service (Refund/Replacement)": (p)=>`Dear ${p.to},\n\nI’m writing regarding ${p.topic}${p.id ? " ("+p.id+")" : ""}. The tracking/status shows [detail], but I have not received the item/service.\n\nTo troubleshoot, I have already [steps taken], but the issue remains.\n\nCould you please investigate and confirm [delivery/service details]? If the issue cannot be resolved by [deadline], I would like to request a [replacement/refund].\n\nThank you for your assistance. I look forward to your response.\n\nKind regards,\n[Your Name]`
      },
      prompts: [
        {
          title: "Heating issue in apartment",
          topic: "the heating in my apartment",
          to: "Samantha Reed",
          id: "Unit 1207",
          desc: "Heating has been inconsistent for about a month (cold at night). You tried adjusting the thermostat and emailed once already.",
          req: [
            "Explain the problem + how long it has happened",
            "Say what you already tried / what happened so far",
            "Request an inspection/repair and ask for a timeline"
          ],
          checks: [
            {label:"Greeting + closing", test:(t)=>/dear\s+\w+/i.test(t) && /(regards|sincerely|best regards|kind regards)/i.test(t), tip:"Start with Dear…, end with Kind/Best regards."},
            {label:"Problem + timeline", test:(t)=>/(past|for the past|over the last|since)/i.test(t) && /(week|weeks|month|months|night)/i.test(t), tip:"Add “For the past month…” + cold at night."},
            {label:"What you tried", test:(t)=>/(i have|i’ve)\s+(already\s+)?(tried|adjusted|emailed|called|checked)/i.test(t), tip:"Mention thermostat + emailed once."},
            {label:"Request inspection/repair", test:(t)=>/(inspect|inspection|technician|repair|fix)/i.test(t), tip:"Ask for inspection/repair."},
            {label:"Timeline request", test:(t)=>/(by|within|as soon as|this week|48 hours|schedule|appointment)/i.test(t), tip:"Ask for timeline (by Friday/this week)."}
          ]
        },
        {
          title: "Missing package marked delivered",
          topic: "a missing package that is marked as delivered",
          to: "Taylor Morgan",
          id: "Order #A47291",
          desc: "Tracking says Delivered, but you did not receive it. You checked lobby/mailroom and asked neighbours.",
          req: [
            "Explain what happened and what you already did",
            "Ask them to investigate and confirm where it was delivered",
            "Request replacement/refund + timeline"
          ],
          checks: [
            {label:"Greeting + closing", test:(t)=>/dear\s+\w+/i.test(t) && /(regards|sincerely|best regards|kind regards)/i.test(t), tip:"Start with Dear…, end with Kind/Best regards."},
            {label:"Mentions delivered but not received", test:(t)=>/(delivered)/i.test(t) && /(not received|didn’t receive|did not receive|missing)/i.test(t), tip:"Say delivered but missing."},
            {label:"What you tried", test:(t)=>/(lobby|mailroom|neighbo(u)?rs|checked)/i.test(t), tip:"Mention checking mailroom + neighbours."},
            {label:"Requests investigation/proof", test:(t)=>/(investigate|confirm|proof|photo|signature|carrier)/i.test(t), tip:"Ask for carrier + proof of delivery."},
            {label:"Requests solution + timeline", test:(t)=>/(refund|replacement)/i.test(t) && /(by|within|48|hours|days|timeline)/i.test(t), tip:"Ask for replacement/refund + deadline."}
          ]
        },
        {
          title: "Schedule conflict (medical appointment)",
          topic: "a schedule adjustment due to a medical appointment",
          to: "Garth",
          id: "",
          desc: "You’re scheduled to work Monday and Tuesday. You have a medical appointment Tuesday afternoon you can’t reschedule.",
          req: [
            "Explain the situation clearly",
            "Request leaving early / time off",
            "Offer to make up hours or swap shifts"
          ],
          checks: [
            {label:"Greeting + closing", test:(t)=>/dear\s+\w+/i.test(t) && /(regards|sincerely|best regards|kind regards)/i.test(t), tip:"Greeting + sign-off."},
            {label:"Mentions appointment + cannot reschedule", test:(t)=>/(medical|appointment)/i.test(t) && /(cannot|can’t)\s+be\s+rescheduled/i.test(t), tip:"Say medical appointment + cannot be rescheduled."},
            {label:"Requests schedule change", test:(t)=>/(leave early|time off|adjust|schedule)/i.test(t), tip:"Ask to leave early or time off."},
            {label:"Offers solution", test:(t)=>/(make up|compensate|swap|stay late|start early)/i.test(t), tip:"Offer to make up hours or swap."}
          ]
        }
      ]
    },

    t2: {
      label: "Task 2",
      minutes: 26,
      targetMin: 170,
      targetMax: 190,
      templates: {
        "CLB 9 Simple (10 sentences)": (p)=>`In my opinion, ${p.a} is the better choice because [reason 1] and [reason 2].\n\nFirst, [reason 1]. For example, [example with time/number/place]. As a result, [benefit 1].\n\nSecond, [reason 2]. For instance, [example 2]. Therefore, [benefit 2].\n\nAdmittedly, ${p.b} has benefits; however, ${p.a} helps more people overall. Overall, the city/company should choose ${p.a}.`,
        "Ultra-short sentences (tired mode)": (p)=>`In my opinion, ${p.a} is better.\nThis is because [reason 1] and [reason 2].\n\nFirst, [reason 1].\nFor example, [example with time/number].\nThis reduces [problem].\n\nSecond, [reason 2].\nFor instance, [example].\nThis improves [benefit].\n\nAdmittedly, ${p.b} helps some people.\nHowever, ${p.a} benefits more residents overall.`
      },
      prompts: [
        {
          title:"Affordable housing vs public transit",
          a:"improving public transit (more frequent and reliable service)",
          b:"building more affordable housing",
          desc:"City can fund only one project this year. Choose the best option for daily life.",
          req:[
            "Choose one option clearly",
            "Give 2 reasons",
            "Give 1 concrete example for each reason",
            "Add a counterpoint + conclusion"
          ],
          checks: [
            {label:"Clear opinion", test:(t)=>/(in my opinion|i believe|i think)/i.test(t), tip:"Start with In my opinion…"},
            {label:"Uses First + Second", test:(t)=>/\bfirst\b/i.test(t) && /\bsecond\b/i.test(t), tip:"Use First, Second."},
            {label:"Has examples", test:(t)=>/(for example|for instance)/i.test(t), tip:"Include at least one example."},
            {label:"Counterpoint + however", test:(t)=>/(admittedly|although|even though)/i.test(t) && /\bhowever\b/i.test(t), tip:"Use Admittedly… however…"},
            {label:"Conclusion", test:(t)=>/(therefore|overall)/i.test(t), tip:"End with Therefore/Overall."}
          ]
        },
        {
          title:"Repair roads vs improve transit",
          a:"improving public transit (more buses/subway frequency)",
          b:"repairing roads and highways (potholes/resurfacing)",
          desc:"Choose one option to improve daily life for residents.",
          req:[
            "Choose one option",
            "2 reasons + 2 examples",
            "Counterpoint + conclusion"
          ],
          checks: [
            {label:"Clear opinion", test:(t)=>/(in my opinion|i believe|i think)/i.test(t), tip:"State your choice clearly."},
            {label:"First + Second", test:(t)=>/\bfirst\b/i.test(t) && /\bsecond\b/i.test(t), tip:"Use First, Second."},
            {label:"Has examples", test:(t)=>/(for example|for instance)/i.test(t), tip:"Add examples with numbers/time."},
            {label:"Counterpoint + however", test:(t)=>/(admittedly|although|even though)/i.test(t) && /\bhowever\b/i.test(t), tip:"Admittedly… however…"},
            {label:"Conclusion", test:(t)=>/(therefore|overall)/i.test(t), tip:"End with Therefore/Overall."}
          ]
        }
      ]
    }
  };

  // ====== DOM ======
  const taskSelect = document.getElementById("taskSelect");
  const promptSelect = document.getElementById("promptSelect");
  const promptTitle = document.getElementById("promptTitle");
  const promptDesc  = document.getElementById("promptDesc");
  const promptReq   = document.getElementById("promptReq");
  const checklist   = document.getElementById("checklist");
  const answer      = document.getElementById("answer");
  const status      = document.getElementById("status");
  const taskLabel   = document.getElementById("taskLabel");
  const timerEl     = document.getElementById("timer");
  const wordsEl     = document.getElementById("words");
  const targetEl    = document.getElementById("target");
  const autosaveEl  = document.getElementById("autosave");
  const lengthLine  = document.getElementById("lengthLine");
  const barFill     = document.getElementById("barFill");
  const paraLine    = document.getElementById("paraLine");

  const startBtn  = document.getElementById("startBtn");
  const pauseBtn  = document.getElementById("pauseBtn");
  const resetBtn  = document.getElementById("resetBtn");
  const startBtn2 = document.getElementById("startBtn2");
  const pauseBtn2 = document.getElementById("pauseBtn2");
  const resetBtn2 = document.getElementById("resetBtn2");

  const newPromptBtn = document.getElementById("newPromptBtn");
  const copyTemplateBtn = document.getElementById("copyTemplateBtn");
  const insertTemplateBtn = document.getElementById("insertTemplateBtn");
  const templatePreview = document.getElementById("templatePreview");

  const checkBtn  = document.getElementById("checkBtn");
  const checkBtn2 = document.getElementById("checkBtn2");
  const checkBtnLeft = document.getElementById("checkBtnLeft");

  const clearBtn  = document.getElementById("clearBtn");
  const saveBtn   = document.getElementById("saveBtn");
  const loadBtn   = document.getElementById("loadBtn");

  const chips     = document.getElementById("chips");

  // Mobile tabs
  const tabPrompt = document.getElementById("tabPrompt");
  const tabWrite  = document.getElementById("tabWrite");
  const panePrompt= document.getElementById("panePrompt");
  const paneWrite = document.getElementById("paneWrite");

  function setTab(which){
    const isPrompt = which === "prompt";
    tabPrompt.classList.toggle("active", isPrompt);
    tabWrite.classList.toggle("active", !isPrompt);
    // On desktop both show; on mobile toggle visibility
    if(window.matchMedia("(max-width: 920px)").matches){
      panePrompt.style.display = isPrompt ? "block" : "none";
      paneWrite.style.display  = isPrompt ? "none" : "block";
    } else {
      panePrompt.style.display = "block";
      paneWrite.style.display  = "block";
    }
  }
  tabPrompt.addEventListener("click", ()=>setTab("prompt"));
  tabWrite.addEventListener("click", ()=>setTab("write"));
  window.addEventListener("resize", ()=>setTab(tabPrompt.classList.contains("active") ? "prompt" : "write"));

  // ====== Timer ======
  let remaining = 27 * 60; // seconds
  let timerId = null;
  let running = false;

  function fmt(secs){
    const m = String(Math.floor(secs/60)).padStart(2,"0");
    const s = String(secs%60).padStart(2,"0");
    return `${m}:${s}`;
  }
  function setTimerForTask(){
    const t = DATA[taskSelect.value];
    remaining = t.minutes * 60;
    timerEl.textContent = fmt(remaining);
  }
  function tick(){
    if(!running) return;
    if(remaining <= 0){
      running = false;
      clearInterval(timerId);
      timerId = null;
      status.className = "toast bad";
      status.textContent = "Time! Stop and move on (like the real test).";
      return;
    }
    remaining -= 1;
    timerEl.textContent = fmt(remaining);
    if(remaining === 5*60){
      status.className = "toast";
      status.textContent = "5 minutes left: finish last paragraph + conclusion + quick grammar scan.";
    }
  }
  function start(){
    if(running) return;
    running = true;
    status.className = "toast good";
    status.textContent = "Started. Clean + complete. Short sentences.";
    if(!timerId) timerId = setInterval(tick, 1000);
  }
  function pause(){
    running = false;
    status.className = "toast";
    status.textContent = "Paused.";
  }
  function reset(){
    running = false;
    if(timerId){ clearInterval(timerId); timerId=null; }
    setTimerForTask();
    status.className = "toast";
    status.textContent = "Reset. New attempt.";
  }

  // ====== Word/paragraph count ======
  function wordCount(text){
    const m = text.trim().match(/\b[\w’']+\b/g);
    return m ? m.length : 0;
  }
  function paragraphCount(text){
    const blocks = text
      .split(/\n\s*\n/g)
      .map(s=>s.trim())
      .filter(Boolean);
    return blocks.length;
  }
  function updateCounts(){
    const w = wordCount(answer.value);
    const p = paragraphCount(answer.value);
    wordsEl.textContent = w;
    lengthLine.textContent = `Length: ${w} words`;
    paraLine.textContent = `Paragraphs: ${p}`;

    const t = DATA[taskSelect.value];
    targetEl.textContent = `${t.targetMin}–${t.targetMax}`;

    // progress bar
    const min = t.targetMin, max = t.targetMax;
    let pct = 0;
    if(w <= min) pct = (min === 0 ? 0 : (w / min) * 60);
    else if(w >= max) pct = 100;
    else pct = 60 + ((w - min) / (max - min)) * 40;

    barFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    barFill.style.background =
      (w < min) ? "rgba(217,119,6,.65)" :
      (w > max) ? "rgba(220,38,38,.65)" :
      "rgba(22,163,74,.65)";
  }

  // ====== Prompt loading ======
  function loadPromptList(){
    promptSelect.innerHTML = "";
    const t = DATA[taskSelect.value];
    t.prompts.forEach((p, idx)=>{
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = p.title;
      promptSelect.appendChild(opt);
    });
  }

  function getPrompt(){
    const t = DATA[taskSelect.value];
    return t.prompts[Number(promptSelect.value) || 0];
  }

  function getDefaultTemplate(){
    const t = DATA[taskSelect.value];
    const p = getPrompt();
    const firstKey = Object.keys(t.templates)[0];
    return t.templates[firstKey](p);
  }

  let chosenTemplateKey = null;
  function renderTemplatePreview(){
    const t = DATA[taskSelect.value];
    const p = getPrompt();
    if(!chosenTemplateKey) chosenTemplateKey = Object.keys(t.templates)[0];
    const text = t.templates[chosenTemplateKey](p);
    templatePreview.textContent = text;
  }

  function renderPrompt(){
    const t = DATA[taskSelect.value];
    const p = getPrompt();

    taskLabel.textContent = t.label;
    promptTitle.textContent = p.title;
    promptDesc.textContent = p.desc;

    promptReq.innerHTML = "";
    p.req.forEach(r=>{
      const li = document.createElement("li");
      li.textContent = r;
      promptReq.appendChild(li);
    });

    renderChecklist();
    buildChips();
    chosenTemplateKey = Object.keys(t.templates)[0];
    renderTemplatePreview();
    setTimerForTask();
    updateCounts();
  }

  function newRandomPrompt(){
    const t = DATA[taskSelect.value];
    const idx = Math.floor(Math.random()*t.prompts.length);
    promptSelect.value = String(idx);
    renderPrompt();
    status.className = "toast";
    status.textContent = "New prompt loaded.";
  }

  // ====== Checklist ======
  function renderChecklist(results=null){
    checklist.innerHTML = "";
    const t = DATA[taskSelect.value];
    const p = getPrompt();

    p.checks.forEach((c, i)=>{
      const div = document.createElement("div");
      div.className = "item";

      const dot = document.createElement("span");
      dot.className = "dot";
      if(results){
        dot.className = "dot " + (results[i] ? "good" : "bad");
      }

      const txt = document.createElement("div");
      txt.innerHTML = `<div style="font-weight:900">${c.label}</div><div class="muted">${c.tip}</div>`;

      div.appendChild(dot);
      div.appendChild(txt);
      checklist.appendChild(div);
    });

    // length indicator
    const w = wordCount(answer.value);
    const min = t.targetMin, max = t.targetMax;

    const lenItem = document.createElement("div");
    lenItem.className = "item";
    const lenDot = document.createElement("span");
    lenDot.className = "dot";
    if(w === 0) lenDot.className = "dot";
    else if(w < min) lenDot.className = "dot warn";
    else if(w > max) lenDot.className = "dot bad";
    else lenDot.className = "dot good";

    const lenTxt = document.createElement("div");
    lenTxt.innerHTML = `<div style="font-weight:900">Length in target range</div>
                        <div class="muted">${min}–${max} words (now: ${w})</div>`;

    lenItem.appendChild(lenDot);
    lenItem.appendChild(lenTxt);
    checklist.appendChild(lenItem);
  }

  function check(){
    const t = DATA[taskSelect.value];
    const p = getPrompt();
    const text = answer.value;

    const results = p.checks.map(c=>c.test(text));
    renderChecklist(results);

    const w = wordCount(text);
    const lenOk = w >= t.targetMin && w <= t.targetMax;
    const pass = results.every(Boolean) && lenOk;

    if(pass){
      status.className = "toast good";
      status.textContent = "✅ Test-ready: bullets + good length. Now scan for big errors (I/you, there/their, to/too, verb endings).";
    }else{
      status.className = "toast";
      status.textContent = "Fix the red items first. Then re-check.";
    }
  }

  // ====== Insert at cursor ======
  function insertAtCursor(text){
    const el = answer;
    const start = el.selectionStart || 0;
    const end = el.selectionEnd || 0;
    const before = el.value.slice(0, start);
    const after = el.value.slice(end);
    el.value = before + text + after;
    const pos = start + text.length;
    el.focus();
    el.setSelectionRange(pos, pos);
    updateCounts();
  }

  function setAnswer(text){
    answer.value = text;
    answer.focus();
    answer.setSelectionRange(answer.value.length, answer.value.length);
    updateCounts();
  }

  // ====== Templates actions ======
  function copyTemplate(){
    const text = templatePreview.textContent || getDefaultTemplate();
    navigator.clipboard.writeText(text).then(()=>{
      status.className = "toast good";
      status.textContent = "Template copied. Paste it into your answer box and fill the blanks.";
    }).catch(()=>{
      status.className = "toast bad";
      status.textContent = "Copy blocked by browser. (Tip: long-press to select on phone.)";
    });
  }

  function insertTemplate(){
    const text = templatePreview.textContent || getDefaultTemplate();
    // Insert if empty; otherwise append with spacing
    if(answer.value.trim().length === 0) setAnswer(text);
    else insertAtCursor("\n\n" + text);
    setTab("write");
    status.className = "toast good";
    status.textContent = "Template inserted. Fill the blanks and keep sentences short.";
  }

  // ====== Quick phrases ======
  const PHRASES = {
    t1: [
      "I am writing regarding ",
      "For the past ",
      "To troubleshoot, I have already ",
      "Could you please ",
      "If possible, please confirm the timeline by ",
      "I am available ",
      "Thank you for your assistance.",
      "I look forward to your response.",
      "Kind regards,"
    ],
    t2: [
      "In my opinion, ",
      "First, ",
      "For example, ",
      "As a result, ",
      "Second, ",
      "For instance, ",
      "Therefore, ",
      "Admittedly, ",
      "However, ",
      "Overall, "
    ]
  };

  function buildChips(){
    chips.innerHTML = "";
    const list = PHRASES[taskSelect.value] || [];
    list.forEach(txt=>{
      const b = document.createElement("button");
      b.className = "chip";
      b.type = "button";
      b.textContent = txt.trim();
      b.addEventListener("click", ()=>{
        insertAtCursor(txt);
        setTab("write");
      });
      chips.appendChild(b);
    });

    // Also add a “Paragraph break” chip (useful on phone)
    const br = document.createElement("button");
    br.className = "chip";
    br.textContent = "↵ Paragraph";
    br.addEventListener("click", ()=>{
      insertAtCursor("\n\n");
      setTab("write");
    });
    chips.appendChild(br);
  }

  // ====== Autosave ======
  function saveNow(){
    const meta = { task: taskSelect.value, promptIndex: promptSelect.value, timestamp: Date.now() };
    localStorage.setItem(STORE_KEY, answer.value);
    localStorage.setItem(STORE_META, JSON.stringify(meta));
    status.className = "toast good";
    status.textContent = "Saved locally.";
  }
  function loadSaved(){
    const saved = localStorage.getItem(STORE_KEY);
    if(saved !== null){
      answer.value = saved;
      updateCounts();
      status.className = "toast good";
      status.textContent = "Loaded saved text.";
    }else{
      status.className = "toast bad";
      status.textContent = "No saved text found.";
    }
  }

  // ====== Events ======
  taskSelect.addEventListener("change", ()=>{
    loadPromptList();
    promptSelect.value = "0";
    renderPrompt();
  });
  promptSelect.addEventListener("change", renderPrompt);

  answer.addEventListener("input", ()=>{
    updateCounts();
    autosaveEl.textContent = "On";
    localStorage.setItem(STORE_KEY, answer.value);
  });

  // Timer buttons (both locations)
  startBtn.addEventListener("click", start);
  pauseBtn.addEventListener("click", pause);
  resetBtn.addEventListener("click", reset);
  startBtn2.addEventListener("click", start);
  pauseBtn2.addEventListener("click", pause);
  resetBtn2.addEventListener("click", reset);

  newPromptBtn.addEventListener("click", newRandomPrompt);

  copyTemplateBtn.addEventListener("click", copyTemplate);
  insertTemplateBtn.addEventListener("click", insertTemplate);

  checkBtn.addEventListener("click", check);
  checkBtn2.addEventListener("click", check);
  checkBtnLeft.addEventListener("click", check);

  clearBtn.addEventListener("click", ()=>{
    answer.value = "";
    updateCounts();
    renderChecklist();
    status.className = "toast";
    status.textContent = "Cleared.";
  });

  saveBtn.addEventListener("click", saveNow);
  loadBtn.addEventListener("click", loadSaved);

  // Tap template preview to cycle template styles (simple + phone-friendly)
  templatePreview.addEventListener("click", ()=>{
    const t = DATA[taskSelect.value];
    const keys = Object.keys(t.templates);
    const idx = Math.max(0, keys.indexOf(chosenTemplateKey));
    chosenTemplateKey = keys[(idx + 1) % keys.length];
    renderTemplatePreview();
    status.className = "toast";
    status.textContent = `Template switched to: ${chosenTemplateKey}`;
  });

  // keyboard shortcut on desktop
  document.addEventListener("keydown", (e)=>{
    if(e.ctrlKey && e.key === "Enter"){ e.preventDefault(); check(); }
  });

  // ====== Init ======
  function init(){
    loadPromptList();
    promptSelect.value = "0";
    renderPrompt();
    updateCounts();
    renderChecklist();
    setTab("prompt");

    // load autosaved draft
    const saved = localStorage.getItem(STORE_KEY);
    if(saved){
      answer.value = saved;
      updateCounts();
      status.className = "toast";
      status.textContent = "Loaded your last saved draft (autosave).";
    }
  }
  init();
</script>
</body>
</html>
