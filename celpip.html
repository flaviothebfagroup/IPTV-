<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>CELPIP Coach + CLB Scorer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --accent: #00c2ff;
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --wrong: #f87171;
      --right: #34d399;
      --warn: #fbbf24;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 2rem;
      max-width: 680px;
      width: 100%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      position: relative;
    }
    h1 { margin-top: 0; text-align: center; }
    button {
      cursor: pointer;
      border: none;
      background: var(--accent);
      color: #0f172a;
      font-weight: 700;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      margin-top: 1rem;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    textarea {
      width: 100%;
      resize: vertical;
      min-height: 140px;
      font-size: 1rem;
      padding: 0.6rem;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f172a;
      color: var(--text);
    }
    .timer { font-size: 1.2rem; text-align: center; margin-bottom: 1rem; }
    .streak { text-align: center; font-size: 1.1rem; margin-bottom: 0.5rem; }
    .feedback {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 6px;
      font-weight: 600;
    }
    .feedback.right { background: var(--right); color: #0f172a; }
    .feedback.wrong { background: var(--wrong); color: #0f172a; }
    .feedback.warn { background: var(--warn); color: #0f172a; }
    ol li { margin-bottom: 0.5rem; }
    details { margin-top: 1.5rem; font-size: 0.9rem; }
    summary { font-weight: 600; }

    /* coach panel */
    #coach {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: var(--card);
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      max-width: 280px;
      font-size: 0.85rem;
      display: none;
    }
    #coachToggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: var(--accent);
      color: #0f172a;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: grid;
      place-items: center;
      font-size: 1.4rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>CELPIP Coach + CLB Scorer</h1>
    <div class="streak">Streak: <span id="streak">0</span> | Best: <span id="best">0</span></div>
    <div class="timer" id="timer">Press Start</div>

    <!-- Writing -->
    <div id="writing" hidden>
      <h2>Writing Task</h2>
      <p id="writingPrompt"></p>
      <textarea id="writingBox" placeholder="Write your response (aim 120-150 words)…"></textarea>
      <button id="writingSubmit">Submit</button>
      <div id="writingFeedback" class="feedback" hidden></div>
      <details id="structHints" hidden>
        <summary>Structural hints for this task</summary>
        <ul id="hintsList"></ul>
      </details>
    </div>

    <!-- Reading -->
    <div id="reading" hidden>
      <h2>Reading Task</h2>
      <p id="passage"></p>
      <ol type="A" id="choices"></ol>
      <button id="nextReading">Next</button>
      <div id="readingFeedback" class="feedback" hidden></div>
    </div>

    <button id="startBtn">Start Game</button>
  </div>

  <!-- floating coach -->
  <button id="coachToggle">?</button>
  <div id="coach">
    <strong>CELPIP Quick Format</strong><br>
    <em>Writing (27 min)</em><br>
    • Email: 4 para – Purpose, Details, Action, Close<br>
    • Survey: 3 para – Opinion, Reason 1, Reason 2<br>
    • Word count: 120-150<br>
    <em>Reading (10 min)</em><br>
    • Skim first, then question<br>
    • 4-option MC, 1 correct<br>
    • Manage 90 s per Q
  </div>

  <script>
    /* ===== DATA ===== */
    const prompts = [
      {
        type: "email",
        text: "You recently bought a vacuum cleaner online. When it arrived, you noticed the box was missing an accessory that was advertised. Write an email to the customer-service department (120-150 words).",
        hints: [
          "Paragraph 1 – Purpose: I am writing to report a missing accessory…",
          "Paragraph 2 – Details: explain what was missing, give order number/date.",
          "Paragraph 3 – Action: say what you want (send part, refund, etc.).",
          "Paragraph 4 – Close: polite ending, thank them for help."
        ]
      },
      {
        type: "survey",
        text: "Your city is asking residents whether the community pool should stay open year-round. Give your opinion and two reasons (120-150 words).",
        hints: [
          "Paragraph 1 – State opinion (I strongly believe…)",
          "Paragraph 2 – Reason 1 + short example",
          "Paragraph 3 – Reason 2 + short example",
          "Keep tone consistent, avoid contractions in formal surveys."
        ]
      },
      {
        type: "email",
        text: "A friend has asked you to recommend a good place to learn English in your city. Write an email describing one school and explaining why it is suitable (120-150 words).",
        hints: [
          "Paragraph 1 – Purpose: I’m happy to recommend…",
          "Paragraph 2 – Details: location, price, special features.",
          "Paragraph 3 – Personal experience or second benefit.",
          "Paragraph 4 – Offer further help, friendly close."
        ]
      }
    ];

    const readingSets = [
      {
        passage: `Many Canadian cities now offer "green bins" for organic waste. These bins accept food scraps, paper towels, and garden trimmings. The material is turned into compost, which is sold to farmers and gardeners. This program reduces landfill use and cuts greenhouse gases.`,
        q: "What is the main purpose of the green-bin program?",
        choices: ["To produce cheap compost for farmers", "To decrease landfill waste and emissions", "To collect garden trimmings only", "To replace garbage trucks"],
        ans: 1
      },
      {
        passage: `Employers in Canada often look for "soft skills" such as teamwork, communication, and problem-solving. Technical knowledge is important, but the ability to work well with others can decide who gets promoted. Job seekers should give examples of these skills in interviews.`,
        q: "According to the passage, which factor most influences promotions?",
        choices: ["University degrees", "Years of experience", "Soft skills", "Technical certificates"],
        ans: 2
      },
      {
        passage: `Community gardens are shared spaces where people grow vegetables and flowers. Plots are rented for a small fee, and tools are provided. These gardens increase access to fresh food and create friendships among neighbours. Some cities even offer beginner workshops each spring.`,
        q: "Which statement is true about community gardens?",
        choices: ["They are free for all residents", "They include training sessions", "They sell vegetables to supermarkets", "They are run by the federal government"],
        ans: 1
      }
    ];

    /* ===== STATE ===== */
    let streak = 0, best = +(localStorage.getItem("celpip-best") || 0);
    let timer = null, seconds = 0;
    let currentW = null, currentR = null, roundPassed = false;

    /* ===== DOM ===== */
    const els = {
      streak: document.getElementById("streak"),
      best: document.getElementById("best"),
      timer: document.getElementById("timer"),
      startBtn: document.getElementById("startBtn"),
      writing: document.getElementById("writing"),
      writingPrompt: document.getElementById("writingPrompt"),
      writingBox: document.getElementById("writingBox"),
      writingSubmit: document.getElementById("writingSubmit"),
      writingFeedback: document.getElementById("writingFeedback"),
      structHints: document.getElementById("structHints"),
      hintsList: document.getElementById("hintsList"),
      reading: document.getElementById("reading"),
      passage: document.getElementById("passage"),
      choices: document.getElementById("choices"),
      nextReading: document.getElementById("nextReading"),
      readingFeedback: document.getElementById("readingFeedback"),
      coach: document.getElementById("coach"),
      coachToggle: document.getElementById("coachToggle")
    };
    els.best.textContent = best;

    /* ===== UTILS ===== */
    function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
    function clbScore(text) {
      const words = text.trim().split(/\s+/).filter(Boolean).length;
      const sentences = text.split(/[.!?]+/).filter(Boolean).length || 1;
      const syllables = text.replace(/[^a-zA-Z]/g, "").split("").filter(c => /[aeiouAEIOU]/.test(c)).length || 1;
      const avgSentLen = words / sentences;
      const spellErrors = (text.match(/(?:\b(?:teh|recieve|neighbour|acheive|embarass)\b)/gi) || []).length; // tiny demo list
      const vocab = new Set(text.toLowerCase().match(/\b[a-z]{3,}\b/g)).size;
      let score = 4; // floor
      if (words >= 120 && words <= 160) score++;
      if (avgSentLen <= 20 && avgSentLen >= 10) score++;
      if (vocab >= 35) score++;
      if (spellErrors === 0) score++;
      if (text.includes("?") || text.includes("!")) score++; // basic punctuation variety
      return Math.min(12, score);
    }

    /* ===== TIMER ===== */
    function runTimer(limit, onTick, onEnd) {
      clearInterval(timer);
      seconds = limit;
      onTick(seconds);
      timer = setInterval(() => {
        seconds--;
        onTick(seconds);
        if (seconds <= 0) { clearInterval(timer); onEnd(); }
      }, 1000);
    }

    /* ===== WRITING ===== */
    function startWriting() {
      roundPassed = false;
      currentW = shuffle([...prompts])[0];
      els.writingPrompt.textContent = currentW.text;
      els.writingBox.value = "";
      els.writingFeedback.hidden = true;
      els.structHints.hidden = true;
      els.writingSubmit.disabled = false;
      els.reading.hidden = true;
      els.writing.hidden = false;
      runTimer(27 * 60, s => {
        const min = String(Math.floor(s / 60)).padStart(2, "0");
        const sec = String(s % 60).padStart(2, "0");
        els.timer.textContent = `Writing: ${min}:${sec}`;
      }, () => {
        els.writingSubmit.disabled = true;
        if (!els.writingBox.value.trim()) {
          els.writingFeedback.textContent = "Time up! No text entered.";
          els.writingFeedback.className = "feedback wrong";
          els.writingFeedback.hidden = false;
          setTimeout(startReading, 1500);
        }
      });
    }

    els.writingSubmit.onclick = () => {
      clearInterval(timer);
      const text = els.writingBox.value.trim();
      const score = clbScore(text);
      const pass = score >= 7; // adjust to taste
      if (pass) roundPassed = true;
      els.writingFeedback.textContent = `Estimated CLB: ${score}/12 ${pass ? "✓ Pass" : "✗ Needs work"}`;
      els.writingFeedback.className = pass ? "feedback right" : "feedback wrong";
      els.writingFeedback.hidden = false;
      // show structural hints
      els.hintsList.innerHTML = currentW.hints.map(h => `<li>${h}</li>`).join("");
      els.structHints.hidden = false;
      setTimeout(startReading, 2500);
    };

    /* ===== READING ===== */
    function startReading() {
      els.writing.hidden = true;
      els.reading.hidden = false;
      els.readingFeedback.hidden = true;
      currentR = shuffle([...readingSets])[0];
      els.passage.textContent = currentR.passage;
      els.choices.innerHTML = "";
      currentR.choices.forEach((c, i) => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = c;
        btn.onclick = () => checkReading(i);
        li.appendChild(btn);
        els.choices.appendChild(li);
      });
      runTimer(90, s => els.timer.textContent = `Reading: ${s}s`, () => {
        els.readingFeedback.textContent = "Time up!";
        els.readingFeedback.className = "feedback wrong";
        els.readingFeedback.hidden = false;
        disableChoices();
        setTimeout(endRound, 1500);
      });
    }

    function checkReading(idx) {
      clearInterval(timer);
      disableChoices();
      const correct = idx === currentR.ans;
      if (!correct) roundPassed = false;
      els.readingFeedback.textContent = correct ? "Correct!" : `Wrong! Answer: ${["A", "B", "C", "D"][currentR.ans]}`;
      els.readingFeedback.className = correct ? "feedback right" : "feedback wrong";
      els.readingFeedback.hidden = false;
      setTimeout(endRound, 1500);
    }

    function disableChoices() { [...els.choices.querySelectorAll("button")].forEach(b => b.disabled = true); }

    /* ===== ROUND END ===== */
    function endRound() {
      if (roundPassed) {
        streak++;
        if (streak > best) { best = streak; localStorage.setItem("celpip-best", best); els.best.textContent = best; }
      } else streak = 0;
      els.streak.textContent = streak;
      els.startBtn.textContent = "Next Round";
      els.startBtn.hidden = false;
      els.timer.textContent = "Round over";
      els.reading.hidden = true;
    }

    /* ===== START ===== */
    els.startBtn.onclick = () => { els.startBtn.hidden = true; startWriting(); };

    /* ===== FLOATING COACH ===== */
    els.coachToggle.onclick = () => els.coach.style.display = els.coach.style.display === "block" ? "none" : "block";
  </script>
</body>
</html>
