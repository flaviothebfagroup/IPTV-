<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CELPIP Writing Practice — Test Mode</title>
  <style>
    :root{
      --bg:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#d1d5db;
      --panel:#ffffff;
      --btn:#f3f4f6;
      --btnBorder:#cbd5e1;
      --primary:#2563eb;   /* blue like typical test UI */
      --good:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;
      --shadow:0 1px 2px rgba(0,0,0,.06);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--ink);
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      background:#fff;
      border-bottom:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:10px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{
      font-weight:700;
      font-size:14px;
    }
    .meta{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .pill{
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      display:flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--ink)}
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--panel);
      box-shadow:var(--shadow);
    }
    .card-hd{
      padding:12px 12px 10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .card-hd h2{
      margin:0;
      font-size:13px;
      font-weight:700;
    }
    .card-bd{
      padding:12px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    select, input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:8px;
      padding:10px;
      font-family:var(--sans);
      font-size:13px;
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    textarea{
      min-height:340px;
      resize:vertical;
      line-height:1.45;
    }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{
      border:1px solid var(--btnBorder);
      background:var(--btn);
      border-radius:8px;
      padding:9px 10px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      color:var(--ink);
    }
    button.primary{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.35);
      color:#1d4ed8;
    }
    button.good{
      background:rgba(22,163,74,.10);
      border-color:rgba(22,163,74,.35);
      color:#15803d;
    }
    button.bad{
      background:rgba(220,38,38,.10);
      border-color:rgba(220,38,38,.35);
      color:#b91c1c;
    }
    .muted{color:var(--muted); font-size:12px}
    .prompt-title{
      font-weight:800;
      font-size:13px;
      margin:0 0 6px 0;
    }
    .bullets{
      margin:8px 0 0 0;
      padding-left:16px;
      font-size:12.5px;
      color:#111827;
    }
    .bullets li{margin:5px 0}
    .divider{height:1px;background:var(--border); margin:10px 0}
    .checklist .item{
      display:flex; gap:8px; align-items:flex-start;
      padding:8px 8px;
      border:1px solid var(--border);
      border-radius:8px;
      margin-bottom:8px;
      font-size:12px;
      background:#fff;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#e5e7eb;margin-top:3px;flex:0 0 10px;
      border:1px solid #d1d5db;
    }
    .dot.good{background:var(--good); border-color:rgba(22,163,74,.6)}
    .dot.warn{background:var(--warn); border-color:rgba(217,119,6,.6)}
    .dot.bad{background:var(--bad); border-color:rgba(220,38,38,.6)}
    .scoreline{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
    }
    .bar{
      border:1px solid var(--border);
      border-radius:999px;
      height:10px;
      overflow:hidden;
      background:#f9fafb;
    }
    .bar > div{
      height:100%;
      width:0%;
      background:rgba(37,99,235,.6);
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .toast{
      padding:9px 10px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:12px;
      background:#fff;
    }
    .toast.good{border-color:rgba(22,163,74,.35)}
    .toast.bad{border-color:rgba(220,38,38,.35)}
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      border:1px solid var(--border);
      padding:1px 6px;
      border-radius:6px;
      background:#fff;
      color:var(--ink);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="title">CELPIP Writing Practice — Test Mode</div>
      <div class="meta">
        <div class="pill">Task: <b id="taskLabel">Task 1</b></div>
        <div class="pill">Timer: <b id="timer">27:00</b></div>
        <div class="pill">Words: <b id="words">0</b></div>
        <div class="pill">Target: <b id="target">150–200</b></div>
        <div class="pill">Autosave: <b id="autosave">On</b></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: prompt + checklist -->
      <div class="card">
        <div class="card-hd">
          <div>
            <h2>Prompt</h2>
            <div class="muted">Pick Task + prompt. Then press Start.</div>
          </div>
        </div>
        <div class="card-bd">
          <div class="row">
            <div style="flex:1">
              <label for="taskSelect">Task</label>
              <select id="taskSelect">
                <option value="t1">Task 1 — Email (27 min)</option>
                <option value="t2">Task 2 — Opinion (26 min)</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="promptSelect">Prompt</label>
              <select id="promptSelect"></select>
            </div>
          </div>

          <div class="divider"></div>

          <p class="prompt-title" id="promptTitle">—</p>
          <div class="hint" id="promptDesc">—</div>
          <ul class="bullets" id="promptReq"></ul>

          <div class="divider"></div>

          <div class="row">
            <button class="good" id="startBtn">Start</button>
            <button id="pauseBtn">Pause</button>
            <button class="bad" id="resetBtn">Reset</button>
          </div>

          <div style="margin-top:10px" class="row">
            <button class="primary" id="newPromptBtn">New Prompt</button>
            <button id="copyTemplateBtn">Copy Template</button>
          </div>

          <div class="divider"></div>

          <div class="toast" id="status">
            Tip: Keep sentences short. Hit every bullet. That’s the score.
          </div>

          <div class="divider"></div>

          <h2 style="font-size:13px;margin:0 0 8px 0;">Checklist (auto)</h2>
          <div class="checklist" id="checklist"></div>

          <div class="divider"></div>
          <div class="hint">
            Shortcuts: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> = Check •
            <span class="kbd">Alt</span> + <span class="kbd">N</span> = New Prompt
          </div>
        </div>
      </div>

      <!-- RIGHT: writing -->
      <div class="card">
        <div class="card-hd">
          <div>
            <h2>Your Answer</h2>
            <div class="muted">Write like the real test. 2 paragraphs for Task 1, 4 paragraphs for Task 2.</div>
          </div>
          <div style="text-align:right">
            <div class="scoreline" id="lengthLine">Length: 0 words</div>
            <div class="bar" title="Word count progress"><div id="barFill"></div></div>
          </div>
        </div>
        <div class="card-bd">
          <textarea id="answer" placeholder="Type your response here..."></textarea>

          <div class="divider"></div>

          <div class="row">
            <button class="primary" id="checkBtn">Check</button>
            <button id="clearBtn" class="bad">Clear</button>
            <button id="saveBtn">Save Now</button>
            <button id="loadBtn">Load Saved</button>
          </div>

          <div class="hint" style="margin-top:10px">
            Test trick: if you’re tired, do **clean + complete**. Don’t chase fancy words.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== Data ======
  const STORE_KEY = "celpip_test_mode_v2_answer";
  const STORE_META = "celpip_test_mode_v2_meta";

  const DATA = {
    t1: {
      label: "Task 1",
      minutes: 27,
      targetMin: 150,
      targetMax: 200,
      template: (p)=>`Dear ${p.to},\n\nI hope you’re doing well. I’m writing regarding ${p.topic}${p.id ? " ("+p.id+")" : ""}.\n\nFor the past [time], [problem]. To troubleshoot, I have already [what you tried], but the issue continues.\n\nCould you please [request action] and confirm the next steps? If possible, please confirm the expected timeline by [deadline]. I am available [availability].\n\nThank you for your assistance. I look forward to your response.\n\nKind regards,\n[Your Name]`,
      prompts: [
        {
          title: "Heating issue in apartment",
          topic: "the heating in my apartment",
          to: "Samantha Reed",
          id: "Unit 1207",
          desc: "Your heating has been inconsistent for about a month (cold at night). You tried adjusting thermostat and emailed once already.",
          req: [
            "Explain the problem + how long it has happened",
            "Say what you already tried / what happened so far",
            "Request an inspection/repair and ask for a timeline"
          ],
          checks: [
            {label:"Greeting + closing", test:(t)=>/dear\s+\w+/i.test(t) && /(regards|sincerely|best regards|kind regards)/i.test(t), tip:"Start with Dear…, end with Kind/Best regards."},
            {label:"Problem + timeline", test:(t)=>/(past|for the past|over the last|since)/i.test(t) && /(week|weeks|month|months|night)/i.test(t), tip:"Add “For the past month…” + cold at night."},
            {label:"What you tried", test:(t)=>/(i have|i’ve)\s+(already\s+)?(tried|adjusted|emailed|called|checked)/i.test(t), tip:"Mention thermostat + emailed once."},
            {label:"Request inspection/repair", test:(t)=>/(inspect|inspection|technician|repair|fix)/i.test(t), tip:"Ask for inspection/repair."},
            {label:"Timeline request", test:(t)=>/(by|within|as soon as|this week|48 hours|schedule|appointment)/i.test(t), tip:"Ask for timeline (by Friday/this week)."}
          ]
        },
        {
          title: "Missing package marked delivered",
          topic: "a missing package that is marked as delivered",
          to: "Taylor Morgan",
          id: "Order #A47291",
          desc: "Tracking says Delivered, but you did not receive it. You checked lobby/mailroom and asked neighbours.",
          req: [
            "Explain what happened and what you already did",
            "Ask them to investigate and confirm where it was delivered",
            "Request replacement/refund + timeline"
          ],
          checks: [
            {label:"Greeting + closing", test:(t)=>/dear\s+\w+/i.test(t) && /(regards|sincerely|best regards|kind regards)/i.test(t), tip:"Start with Dear…, end with Kind/Best regards."},
            {label:"Mentions delivered but not received", test:(t)=>/(delivered)/i.test(t) && /(not received|didn’t receive|did not receive|missing)/i.test(t), tip:"Say delivered but missing."},
            {label:"What you tried", test:(t)=>/(lobby|mailroom|neighbo(u)?rs|checked)/i.test(t), tip:"Mention checking mailroom + neighbours."},
            {label:"Requests investigation/proof", test:(t)=>/(investigate|confirm|proof|photo|signature|carrier)/i.test(t), tip:"Ask for carrier + proof of delivery."},
            {label:"Requests solution + timeline", test:(t)=>/(refund|replacement)/i.test(t) && /(by|within|48|hours|days|timeline)/i.test(t), tip:"Ask for replacement/refund + deadline."}
          ]
        },
        {
          title: "Noise complaint (construction early)",
          topic: "early-morning construction noise",
          to: "Jordan Lee",
          id: "",
          desc: "Construction noise starts around 6:30 a.m., including weekends, for the past two weeks.",
          req: [
            "Explain the problem and duration",
            "Ask permitted construction hours (including weekends)",
            "Request a solution (later start / notice / enforce rules)"
          ],
          checks: [
            {label:"Greeting + closing", test:(t)=>/dear\s+\w+/i.test(t) && /(regards|sincerely|best regards|kind regards)/i.test(t), tip:"Greeting + sign-off."},
            {label:"Mentions early time + duration", test:(t)=>/(6:30|early|morning)/i.test(t) && /(two weeks|past two weeks|for the past)/i.test(t), tip:"Include 6:30 a.m. + two weeks."},
            {label:"Asks permitted hours", test:(t)=>/(permitted|allowed|hours|schedule)/i.test(t), tip:"Ask about allowed hours."},
            {label:"Requests solution", test:(t)=>/(request|please)\s+(notify|enforce|change|adjust|later)/i.test(t), tip:"Ask for notice or later start."}
          ]
        }
      ]
    },
    t2: {
      label: "Task 2",
      minutes: 26,
      targetMin: 170,
      targetMax: 190,
      template: (p)=>`In my opinion, ${p.a} is the better choice because [reason 1] and [reason 2].\n\nFirst, [reason 1]. For example, [example with time/number/place]. As a result, [benefit].\n\nSecond, [reason 2]. For instance, [example]. Therefore, [benefit].\n\nAdmittedly, ${p.b} has benefits; however, ${p.a} helps more people overall. Overall, the city/company should choose ${p.a}.`,
      prompts: [
        {
          title:"Affordable housing vs public transit",
          a:"improving public transit (more frequent and reliable service)",
          b:"building more affordable housing",
          desc:"City can fund only one project this year. Choose the best option for daily life.",
          req:[
            "Choose one option clearly",
            "Give 2 reasons",
            "Give 1 concrete example for each reason",
            "Add a counterpoint + conclusion"
          ],
          checks: [
            {label:"Clear opinion", test:(t)=>/(in my opinion|i believe|i think)/i.test(t), tip:"Start with In my opinion…"},
            {label:"Uses First + Second", test:(t)=>/\bfirst\b/i.test(t) && /\bsecond\b/i.test(t), tip:"Use First, Second."},
            {label:"Has examples", test:(t)=>/(for example|for instance)/i.test(t), tip:"Include at least one example."},
            {label:"Counterpoint + however", test:(t)=>/(admittedly|although|even though)/i.test(t) && /\bhowever\b/i.test(t), tip:"Use Admittedly… however…"},
            {label:"Conclusion", test:(t)=>/(therefore|overall)/i.test(t), tip:"End with Therefore/Overall."}
          ]
        },
        {
          title:"Repair roads vs improve transit",
          a:"improving public transit (more buses/subway frequency)",
          b:"repairing roads and highways (potholes/resurfacing)",
          desc:"Choose one option to improve daily life for residents.",
          req:[
            "Choose one option",
            "2 reasons + 2 examples",
            "Counterpoint + conclusion"
          ],
          checks: [
            {label:"Clear opinion", test:(t)=>/(in my opinion|i believe|i think)/i.test(t), tip:"State your choice clearly."},
            {label:"First + Second", test:(t)=>/\bfirst\b/i.test(t) && /\bsecond\b/i.test(t), tip:"Use First, Second."},
            {label:"Has examples", test:(t)=>/(for example|for instance)/i.test(t), tip:"Add examples with numbers/time."},
            {label:"Counterpoint + however", test:(t)=>/(admittedly|although|even though)/i.test(t) && /\bhowever\b/i.test(t), tip:"Admittedly… however…"},
            {label:"Conclusion", test:(t)=>/(therefore|overall)/i.test(t), tip:"End with Therefore/Overall."}
          ]
        }
      ]
    }
  };

  // ====== DOM ======
  const taskSelect = document.getElementById("taskSelect");
  const promptSelect = document.getElementById("promptSelect");
  const promptTitle = document.getElementById("promptTitle");
  const promptDesc  = document.getElementById("promptDesc");
  const promptReq   = document.getElementById("promptReq");
  const checklist   = document.getElementById("checklist");
  const answer      = document.getElementById("answer");
  const status      = document.getElementById("status");

  const taskLabel = document.getElementById("taskLabel");
  const timerEl   = document.getElementById("timer");
  const wordsEl   = document.getElementById("words");
  const targetEl  = document.getElementById("target");
  const autosaveEl= document.getElementById("autosave");
  const lengthLine= document.getElementById("lengthLine");
  const barFill   = document.getElementById("barFill");

  const startBtn  = document.getElementById("startBtn");
  const pauseBtn  = document.getElementById("pauseBtn");
  const resetBtn  = document.getElementById("resetBtn");
  const newPromptBtn = document.getElementById("newPromptBtn");
  const copyTemplateBtn = document.getElementById("copyTemplateBtn");

  const checkBtn  = document.getElementById("checkBtn");
  const clearBtn  = document.getElementById("clearBtn");
  const saveBtn   = document.getElementById("saveBtn");
  const loadBtn   = document.getElementById("loadBtn");

  // ====== Timer ======
  let remaining = 27 * 60; // seconds
  let timerId = null;
  let running = false;

  function fmt(secs){
    const m = String(Math.floor(secs/60)).padStart(2,"0");
    const s = String(secs%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  function setTimerForTask(){
    const t = DATA[taskSelect.value];
    remaining = t.minutes * 60;
    timerEl.textContent = fmt(remaining);
  }

  function tick(){
    if(!running) return;
    if(remaining <= 0){
      running = false;
      clearInterval(timerId);
      timerId = null;
      status.className = "toast bad";
      status.textContent = "Time! Stop and move on (like the real test).";
      return;
    }
    remaining -= 1;
    timerEl.textContent = fmt(remaining);

    // subtle warning at 5 minutes left
    if(remaining === 5*60){
      status.className = "toast";
      status.textContent = "5 minutes left: finish your last paragraph + conclusion.";
    }
  }

  function start(){
    if(running) return;
    running = true;
    status.className = "toast good";
    status.textContent = "Started. Focus on clean + complete.";
    if(!timerId) timerId = setInterval(tick, 1000);
  }

  function pause(){
    running = false;
    status.className = "toast";
    status.textContent = "Paused.";
  }

  function reset(){
    running = false;
    if(timerId){ clearInterval(timerId); timerId=null; }
    setTimerForTask();
    status.className = "toast";
    status.textContent = "Reset. New attempt.";
  }

  // ====== Word count ======
  function wordCount(text){
    const m = text.trim().match(/\b[\w’']+\b/g);
    return m ? m.length : 0;
  }

  function updateCounts(){
    const w = wordCount(answer.value);
    wordsEl.textContent = w;
    lengthLine.textContent = `Length: ${w} words`;

    const t = DATA[taskSelect.value];
    targetEl.textContent = `${t.targetMin}–${t.targetMax}`;

    // progress bar: map targetMin..targetMax to 0..100
    const min = t.targetMin, max = t.targetMax;
    let pct = 0;
    if(w <= min) pct = (w / min) * 60;          // up to 60% by reaching min
    else if(w >= max) pct = 100;
    else pct = 60 + ((w - min) / (max - min)) * 40; // 60..100 inside range

    barFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    barFill.style.background =
      (w < min) ? "rgba(217,119,6,.65)" :
      (w > max) ? "rgba(220,38,38,.65)" :
      "rgba(22,163,74,.65)";
  }

  // ====== Prompt loading ======
  function loadPromptList(){
    promptSelect.innerHTML = "";
    const t = DATA[taskSelect.value];
    t.prompts.forEach((p, idx)=>{
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = p.title;
      promptSelect.appendChild(opt);
    });
  }

  function renderPrompt(){
    const t = DATA[taskSelect.value];
    const p = t.prompts[Number(promptSelect.value) || 0];

    taskLabel.textContent = t.label;
    promptTitle.textContent = p.title;
    promptDesc.textContent = p.desc;

    promptReq.innerHTML = "";
    p.req.forEach(r=>{
      const li = document.createElement("li");
      li.textContent = r;
      promptReq.appendChild(li);
    });

    renderChecklist(); // reset dots
    setTimerForTask();
    updateCounts();
  }

  function newRandomPrompt(){
    const t = DATA[taskSelect.value];
    const idx = Math.floor(Math.random()*t.prompts.length);
    promptSelect.value = String(idx);
    renderPrompt();
    status.className = "toast";
    status.textContent = "New prompt loaded.";
  }

  // ====== Checklist ======
  function renderChecklist(results=null){
    checklist.innerHTML = "";
    const t = DATA[taskSelect.value];
    const p = t.prompts[Number(promptSelect.value) || 0];

    p.checks.forEach((c, i)=>{
      const div = document.createElement("div");
      div.className = "item";

      const dot = document.createElement("span");
      dot.className = "dot";
      if(results){
        dot.className = "dot " + (results[i] ? "good" : "bad");
      }

      const txt = document.createElement("div");
      txt.innerHTML = `<div style="font-weight:800">${c.label}</div><div class="muted">${c.tip}</div>`;

      div.appendChild(dot);
      div.appendChild(txt);
      checklist.appendChild(div);
    });

    // add length indicator item
    const w = wordCount(answer.value);
    const lenItem = document.createElement("div");
    lenItem.className = "item";
    const lenDot = document.createElement("span");
    lenDot.className = "dot";
    const min = t.targetMin, max = t.targetMax;
    if(w === 0) lenDot.className = "dot";
    else if(w < min) lenDot.className = "dot warn";
    else if(w > max) lenDot.className = "dot bad";
    else lenDot.className = "dot good";

    const lenTxt = document.createElement("div");
    lenTxt.innerHTML = `<div style="font-weight:800">Length in target range</div>
                        <div class="muted">${min}–${max} words (now: ${w})</div>`;

    lenItem.appendChild(lenDot);
    lenItem.appendChild(lenTxt);
    checklist.appendChild(lenItem);
  }

  function check(){
    const t = DATA[taskSelect.value];
    const p = t.prompts[Number(promptSelect.value) || 0];
    const text = answer.value;

    const results = p.checks.map(c=>c.test(text));
    renderChecklist(results);

    const w = wordCount(text);
    const lenOk = w >= t.targetMin && w <= t.targetMax;
    const pass = results.every(Boolean) && lenOk;

    if(pass){
      status.className = "toast good";
      status.textContent = "✅ Looks test-ready: you hit the bullets + good length. Now do a quick grammar scan.";
    }else{
      status.className = "toast";
      status.textContent = "Check the red items: fix those first. Then re-check.";
    }
  }

  // ====== Autosave ======
  function saveNow(){
    const meta = {
      task: taskSelect.value,
      promptIndex: promptSelect.value,
      timestamp: Date.now()
    };
    localStorage.setItem(STORE_KEY, answer.value);
    localStorage.setItem(STORE_META, JSON.stringify(meta));
    status.className = "toast good";
    status.textContent = "Saved locally.";
  }

  function loadSaved(){
    const saved = localStorage.getItem(STORE_KEY);
    if(saved !== null){
      answer.value = saved;
      updateCounts();
      status.className = "toast good";
      status.textContent = "Loaded saved text.";
    }else{
      status.className = "toast bad";
      status.textContent = "No saved text found.";
    }
  }

  function copyTemplate(){
    const t = DATA[taskSelect.value];
    const p = t.prompts[Number(promptSelect.value) || 0];
    const temp = t.template(p);
    navigator.clipboard.writeText(temp).then(()=>{
      status.className = "toast good";
      status.textContent = "Template copied. Paste it into the answer box and fill the blanks.";
    }).catch(()=>{
      status.className = "toast bad";
      status.textContent = "Could not copy (browser blocked). You can manually copy from the template popup.";
      alert(temp);
    });
  }

  // ====== Events ======
  taskSelect.addEventListener("change", ()=>{
    loadPromptList();
    promptSelect.value = "0";
    renderPrompt();
  });

  promptSelect.addEventListener("change", renderPrompt);

  answer.addEventListener("input", ()=>{
    updateCounts();
    // autosave lightly
    autosaveEl.textContent = "On";
    localStorage.setItem(STORE_KEY, answer.value);
  });

  startBtn.addEventListener("click", start);
  pauseBtn.addEventListener("click", pause);
  resetBtn.addEventListener("click", reset);

  newPromptBtn.addEventListener("click", newRandomPrompt);
  copyTemplateBtn.addEventListener("click", copyTemplate);

  checkBtn.addEventListener("click", check);
  clearBtn.addEventListener("click", ()=>{
    answer.value = "";
    updateCounts();
    renderChecklist();
    status.className = "toast";
    status.textContent = "Cleared.";
  });

  saveBtn.addEventListener("click", saveNow);
  loadBtn.addEventListener("click", loadSaved);

  // shortcuts
  document.addEventListener("keydown", (e)=>{
    if(e.ctrlKey && e.key === "Enter"){ e.preventDefault(); check(); }
    if(e.altKey && (e.key === "n" || e.key === "N")){ e.preventDefault(); newRandomPrompt(); }
  });

  // init
  loadPromptList();
  promptSelect.value = "0";
  renderPrompt();
  updateCounts();
  renderChecklist();

  // load previous text automatically if exists
  const saved = localStorage.getItem(STORE_KEY);
  if(saved){
    answer.value = saved;
    updateCounts();
    status.className = "toast";
    status.textContent = "Loaded your last saved draft (autosave).";
  }
</script>
</body>
</html>
