<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPTV Admin</title>

  <style>
    :root{
      --bg:#0b0b0c; --fg:#fff; --muted:#9a9aa0; --panel:#121214; --border:rgba(255,255,255,.14);
      --accent:#ff9500; --tile:#17171a; --tileActive:#1d1d21; --shadow:0 18px 48px rgba(0,0,0,.45);
      --good:#30d158; --bad:#ff453a; --pill:#1b1b1e;
    }
    body.light{
      --bg:#f5f5f7; --fg:#111; --muted:#6e6e73; --panel:#fff; --border:rgba(0,0,0,.12);
      --tile:#f2f2f7; --tileActive:#eaeaef; --shadow:0 14px 36px rgba(0,0,0,.10); --pill:#ececf1;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",system-ui,sans-serif}

    /* Header */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:50}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:32px;height:32px;background:var(--accent);
      -webkit-mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;
      mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat}
    .title{font-weight:800;letter-spacing:.3px}
    .right-actions{display:flex;gap:10px;align-items:center}
    .chip{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:transparent;color:var(--fg);font-size:12px}
    .btn{padding:10px 14px;border:none;border-radius:12px;background:var(--accent);color:#000;font-weight:800;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--fg)}
    .btn.small{padding:8px 12px;border-radius:10px;font-size:12px}

    /* Theme switch */
    .switch{position:relative;width:56px;height:30px;border-radius:999px;background:var(--tileActive);border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 8px;cursor:pointer}
    .switch .sun,.switch .moon{font-size:14px;opacity:.55;transition:opacity .2s}
    .switch .thumb{position:absolute;top:2px;left:2px;width:26px;height:26px;border-radius:50%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.25);transition:transform .25s}
    body.light .switch .thumb{background:#000}
    .switch.on{border-color:var(--accent);box-shadow:inset 0 -2px 8px rgba(0,0,0,.12),0 6px 18px rgba(255,149,0,.22)}
    .switch.on .thumb{transform:translateX(26px)}
    .switch.on .sun{opacity:1}.switch.on .moon{opacity:.3}

    /* Layout */
    .container{padding:18px;max-width:1240px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:18px}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--panel);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow)}
    .card h2{font-size:16px;margin:0;padding:14px 16px;border-bottom:1px solid var(--border)}
    .card .content{padding:14px 16px}

    /* Inputs */
    .row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
    .field{flex:1;min-width:220px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:transparent;color:var(--fg);outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,149,0,.25)}
    .helper{font-size:12px;color:var(--muted)}

    /* Lists */
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:14px;padding:10px;background:var(--tile)}
    .grow{flex:1}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--pill);border:1px solid var(--border);font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--good)} .dot.bad{background:var(--bad)}

    /* Quick links */
    .apps-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:720px){ .apps-grid{grid-template-columns:repeat(2,1fr)} }
    .appbtn{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--border);border-radius:14px;background:var(--tile);text-decoration:none;color:var(--fg);font-weight:700}
    .appbtn:hover{border-color:var(--accent)}
    .x{border:none;background:transparent;color:var(--muted);cursor:pointer}

    /* Gate / toast */
    .gate{position:fixed;inset:0;background:var(--bg);display:grid;place-items:center;padding:24px}
    .login{width:100%;max-width:360px}
    .login .logo{width:96px;height:96px;margin:0 auto 12px;background:var(--accent);
      -webkit-mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;
      mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat}
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 16px;border-radius:999px;font-weight:800;opacity:0;transition:opacity .25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><div class="logo"></div><div class="title">IPTV Admin</div></div>
    <div class="right-actions">
      <div id="userChip" class="chip">Not signed in</div>
      <button id="reloadBtn" class="btn secondary small">Reload</button>
      <div id="themeSwitch" class="switch" title="Toggle theme">
        <span class="sun">‚òÄÔ∏è</span><span class="moon">üåô</span><i class="thumb"></i>
      </div>
      <button id="signOutBtn" class="btn small">Sign out</button>
    </div>
  </div>

  <!-- Sign-in gate -->
  <div id="gate" class="gate" style="display:none;">
    <div class="login card" style="padding:16px">
      <div class="logo"></div>
      <div class="content">
        <div class="row">
          <div class="field"><div class="label">Email</div><input id="loginEmail" type="email" placeholder="admin@your.com"></div>
          <div class="field"><div class="label">Password</div><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        </div>
        <div class="row"><button id="signInBtn" class="btn" style="width:100%;">Sign in</button></div>
        <div class="helper">This page is admin-only</div>
      </div>
    </div>
  </div>

  <div class="container" id="main" style="display:none;">
    <div class="grid">
      <!-- Dealerships & screens -->
      <div class="card" id="dealCard">
        <h2>Dealerships</h2>
        <div class="content">
          <div class="row">
            <div class="field">
              <div class="label">Select dealership</div>
              <select id="dealSelect"><option>Loading‚Ä¶</option></select>
            </div>
            <div class="field">
              <div class="label">Name</div>
              <input id="dealName" placeholder="Dealership name">
            </div>
            <div class="field">
              <div class="label">Dealership ID (current)</div>
              <input id="dealIdCurrent" disabled>
            </div>
          </div>

          <div class="row">
            <button id="saveDealName" class="btn">Save name</button>
            <span class="helper">Mirrors to <code>/dealershipPublic</code></span>
          </div>

          <div class="row" style="margin-top:6px">
            <div class="field">
              <div class="label">Rename Dealership ID</div>
              <input id="dealIdNew" placeholder="new-id (letters/numbers/_ only)">
            </div>
            <div class="field" style="align-self:flex-end">
              <button id="renameDealBtn" class="btn secondary">Rename ID (migrate)</button>
            </div>
          </div>
          <div class="helper" style="margin-top:-4px">
            Migrates displays‚Äô <code>dealership</code>, users‚Äô <code>dealershipId</code>, and <code>dealershipPublic</code>.
          </div>

          <div class="row" style="margin-top:14px">
            <div class="label">Screens (live status + channel)</div>
            <div id="displayList" class="list"></div>
          </div>

          <div class="row" style="margin-top:8px">
            <div class="field">
              <div class="label">Add displayId</div>
              <input id="newDisplayId" placeholder="e.g., GW-002">
            </div>
            <div class="field" style="align-self:flex-end">
              <button id="addDisplayBtn" class="btn secondary">Add display</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Users -->
      <div class="card" id="userCard">
        <h2>Users</h2>
        <div class="content">
          <div class="row">
            <div class="field">
              <div class="label">Search</div>
              <input id="userSearch" placeholder="name or email">
            </div>
            <div class="field">
              <div class="label">Filter</div>
              <select id="userFilter">
                <option value="all">All</option>
                <option value="admin">Admins</option>
                <option value="user">Users</option>
                <option value="device">Devices</option>
              </select>
            </div>
          </div>
          <div id="userList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- Quick Links / Apps -->
    <div class="card" style="margin-top:18px;">
      <h2>Apps / Quick Links</h2>
      <div class="content">
        <div id="appsGrid" class="apps-grid"></div>
        <div class="row" style="margin-top:10px">
          <div class="field">
            <div class="label">Add link ‚Äî Label</div>
            <input id="appLabel" placeholder="e.g., Google Drive">
          </div>
          <div class="field">
            <div class="label">URL</div>
            <input id="appUrl" placeholder="https://">
          </div>
          <div class="field" style="align-self:flex-end">
            <button id="addAppBtn" class="btn secondary">Add link</button>
          </div>
        </div>
        <div class="helper">Defaults included. Custom links are saved at <code>/adminLinks</code>.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getDatabase, ref, get, set, update, remove, onValue
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ------------- Theme -------------
    const themeSwitch = document.getElementById('themeSwitch');
    const savedTheme = localStorage.getItem('iptv_theme') || 'light';
    document.body.classList.toggle('light', savedTheme==='light');
    syncSwitch();
    themeSwitch.addEventListener('click', ()=>{
      const toLight = !document.body.classList.contains('light');
      document.body.classList.toggle('light', toLight);
      localStorage.setItem('iptv_theme', toLight?'light':'dark');
      syncSwitch();
    });
    function syncSwitch(){ themeSwitch.classList.toggle('on', document.body.classList.contains('light')); }

    // ------------- UI helpers -------------
    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);
    function toast(msg){
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1600);
    }

    // ------------- Auth gate -------------
    const gate = $('#gate'), main = $('#main'), userChip = $('#userChip');
    $('#signInBtn').addEventListener('click', async ()=>{
      const email = $('#loginEmail').value.trim();
      const pass  = $('#loginPass').value;
      if(!email||!pass) return toast('Enter email & password');
      try{ await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ console.error(e); toast('Login failed'); }
    });
    $('#signOutBtn').addEventListener('click', ()=>signOut(auth));
    ['loginEmail','loginPass'].forEach(id=>{
      const el=document.getElementById(id);
      el.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#signInBtn').click(); } });
    });

    let isAdmin = false;
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        userChip.textContent = 'Not signed in';
        gate.style.display='grid'; main.style.display='none';
        return;
      }
      userChip.textContent = (user.email || 'Signed in');
      try{
        const us = await get(ref(db, 'user/'+user.uid));
        const u = us.exists()? us.val() : {};
        isAdmin = (u.role === 'admin');
      }catch(e){ isAdmin=false; }

      if(!isAdmin){
        gate.style.display='grid'; main.style.display='none';
        toast('Admin only');
        return;
      }
      gate.style.display='none'; main.style.display='block';
      bootstrap();
    });

    // ------------- Data -------------
    let dealers = {};        // dealership/{id}
    let users   = {};        // user/{uid}
    let selectedDid = null;

    // cache of displays live state (channel/volume/muted/timestamp/dealership)
    let displaysState = {};  // displays/{id} -> {channel, timestamp, ...}
    let displaysUnsub = null;

    async function bootstrap(){
      await Promise.all([loadDealers(), loadUsers(), subscribeDisplays()]);
      wireUsersUI();
      $('#reloadBtn').onclick = async ()=>{ await Promise.all([loadDealers(), loadUsers()]); toast('Reloaded'); };
      await loadApps();
    }

    // Live subscribe to displays so LIVE/CH updates in place
    async function subscribeDisplays(){
      if (displaysUnsub) displaysUnsub();
      const off = onValue(ref(db,'displays'), snap=>{
        displaysState = snap.exists()? snap.val() : {};
        // repaint screen list if a dealer is selected
        if (selectedDid) paintDealer(selectedDid);
      });
      displaysUnsub = ()=>off();
    }

    async function loadDealers(){
      const snap = await get(ref(db, 'dealership'));
      dealers = snap.exists()? snap.val() : {};
      const sel = $('#dealSelect');
      sel.innerHTML = '';
      Object.keys(dealers).sort().forEach(did=>{
        const opt = document.createElement('option');
        opt.value = did; opt.textContent = `${dealers[did].name || did}  (${did})`;
        sel.appendChild(opt);
      });
      selectedDid = selectedDid && dealers[selectedDid] ? selectedDid : Object.keys(dealers)[0] || null;
      sel.value = selectedDid || '';
      paintDealer(selectedDid);
      sel.onchange = ()=>{ selectedDid = sel.value; paintDealer(selectedDid); };
    }

    async function loadUsers(){
      const snap = await get(ref(db, 'user'));
      users = snap.exists()? snap.val() : {};
      paintUsers();
    }

    // ------------- Dealership UI -------------
    function paintDealer(did){
      const nameInput = $('#dealName');
      const idCur     = $('#dealIdCurrent');
      const listWrap  = $('#displayList');
      if(!did){ nameInput.value=''; idCur.value=''; listWrap.innerHTML='<div class="helper">No dealerships</div>'; return; }

      const d = dealers[did] || {};
      nameInput.value = d.name || '';
      idCur.value = did;

      // Displays from dealership map
      const map = (d.displays || {});
      const ids = Object.keys(map).sort();
      listWrap.innerHTML = '';

      if(!ids.length){
        listWrap.innerHTML = '<div class="helper">No screens yet</div>';
        return;
      }

      const now = Date.now();
      ids.forEach(displayId=>{
        const live = displaysState[displayId] || {};
        const fresh = (typeof live.timestamp === 'number') && (now - live.timestamp <= 45_000);
        const channel = (typeof live.channel === 'number') ? live.channel : '‚Äî';

        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="grow">
            <div style="font-weight:800">${displayId}</div>
            <div class="pill" title="${fresh ? 'Last seen ' + Math.round((now-live.timestamp)/1000) + 's ago' : 'No recent heartbeat'}" style="margin-top:6px;">
              <i class="dot ${fresh?'ok':'bad'}"></i>
              ${fresh ? `LIVE ‚Ä¢ CH ${channel}` : 'OFFLINE'}
            </div>
          </div>
          <button class="btn secondary small" data-act="open" data-id="${displayId}">Open in remote</button>
          <button class="btn secondary small" data-act="remove" data-id="${displayId}">Remove</button>
        `;
        listWrap.appendChild(row);
      });

      // row actions
      listWrap.querySelectorAll('button').forEach(btn=>{
        const act = btn.dataset.act, id = btn.dataset.id;
        if(act==='open'){
          btn.onclick = ()=> window.open(`remote-control.html#${encodeURIComponent(id)}`,'_blank');
        }else if(act==='remove'){
          btn.onclick = ()=> removeDisplay(did, id);
        }
      });
    }

    // Save dealership name + mirror to dealershipPublic
    document.getElementById('saveDealName').addEventListener('click', async ()=>{
      if(!selectedDid) return;
      const newName = $('#dealName').value.trim();
      try{
        await update(ref(db, `dealership/${selectedDid}`), { name:newName || selectedDid });
        await update(ref(db, `dealershipPublic/${selectedDid}`), { name:newName || selectedDid });
        dealers[selectedDid] = dealers[selectedDid] || {};
        dealers[selectedDid].name = newName || selectedDid;
        await loadDealers();
        toast('Name saved');
      }catch(e){ console.error(e); toast('Save failed'); }
    });

    // Add display to dealership + ensure state exists
    document.getElementById('addDisplayBtn').addEventListener('click', async ()=>{
      if(!selectedDid) return;
      const disp = $('#newDisplayId').value.trim();
      if(!disp) return toast('Enter a displayId');
      try{
        await update(ref(db, `dealership/${selectedDid}/displays`), { [disp]: true });
        const ds = await get(ref(db, `displays/${disp}`));
        if(!ds.exists()){
          await set(ref(db, `displays/${disp}`), {
            channel:1, volume:50, muted:false, dealership:selectedDid, timestamp: Date.now()
          });
        }else{
          await update(ref(db, `displays/${disp}`), { dealership: selectedDid, timestamp: Date.now() });
        }
        dealers[selectedDid].displays = dealers[selectedDid].displays || {};
        dealers[selectedDid].displays[disp] = true;
        $('#newDisplayId').value='';
        paintDealer(selectedDid);
        toast('Display added');
      }catch(e){ console.error(e); toast('Add failed'); }
    });

    async function removeDisplay(did, dispId){
      if(!confirm(`Remove ${dispId} from ${did}?`)) return;
      try{
        await update(ref(db, `dealership/${did}/displays/${dispId}`), null);
        if (dealers[did] && dealers[did].displays){ delete dealers[did].displays[dispId]; }
        paintDealer(did);
        toast('Removed from dealership');
      }catch(e){ console.error(e); toast('Remove failed'); }
    }

    // Rename dealershipId with migration
    document.getElementById('renameDealBtn').addEventListener('click', async ()=>{
      if(!selectedDid) return;
      const newId = $('#dealIdNew').value.trim();
      const newName = $('#dealName').value.trim() || selectedDid;
      if(!newId) return toast('Enter new ID');
      if(!/^[a-zA-Z0-9_]+$/.test(newId)) return toast('Use letters, numbers, underscore');
      if(newId === selectedDid) return toast('Same as current');
      if(!confirm(`Rename "${selectedDid}" to "${newId}"? This migrates displays & users.`)) return;

      try{
        const oldSnap = await get(ref(db, `dealership/${selectedDid}`));
        const oldData = oldSnap.exists()? oldSnap.val() : { name:newName, displays:{} };
        await set(ref(db, `dealership/${newId}`), { ...oldData, name:newName });

        const dispMap = oldData.displays || {};
        const dispIds = Object.keys(dispMap);
        if(dispIds.length){
          await update(ref(db, `dealership/${newId}/displays`), dispMap);
          for(const disp of dispIds){
            await update(ref(db, `displays/${disp}`), { dealership:newId, timestamp: Date.now() });
          }
        }

        const us = await get(ref(db, 'user'));
        if(us.exists()){
          const all = us.val();
          for(const [uid, u] of Object.entries(all)){
            if(u && u.dealershipId === selectedDid){
              await update(ref(db, `user/${uid}`), { dealershipId:newId, dealershipName:newName });
            }
          }
        }

        await update(ref(db, `dealershipPublic/${newId}`), { name:newName });
        await remove(ref(db, `dealershipPublic/${selectedDid}`)).catch(()=>{});
        await remove(ref(db, `dealership/${selectedDid}`));

        selectedDid = newId;
        await loadDealers();
        $('#dealIdNew').value='';
        toast('Renamed & migrated');
      }catch(e){ console.error(e); toast('Rename failed'); }
    });

    // ------------- Users UI -------------
    function wireUsersUI(){
      $('#userFilter').onchange = paintUsers;
      $('#userSearch').oninput  = ()=>{ paintUsers(); };
    }

    function paintUsers(){
      const wrap = $('#userList'); wrap.innerHTML='';
      const term = ($('#userSearch').value || '').toLowerCase();
      const filt = $('#userFilter').value;

      const arr = Object.entries(users).map(([uid, u])=>({uid, ...u}));
      arr.sort((a,b)=> (a.email||'').localeCompare(b.email||''));
      const filtered = arr.filter(u=>{
        if(filt==='admin'  && u.role!=='admin') return false;
        if(filt==='user'   && u.role!=='user')  return false;
        if(filt==='device' && u.role!=='device')return false;
        if(term){
          const blob = `${u.email||''} ${u.name||''} ${u.dealershipId||''}`.toLowerCase();
          if(!blob.includes(term)) return false;
        }
        return true;
      });

      if(!filtered.length){
        wrap.innerHTML = '<div class="helper">No users match</div>';
        return;
      }

      for(const u of filtered){
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="grow">
            <div style="font-weight:700">${u.email || '(no email)'} <span class="pill" style="margin-left:6px">${u.uid}</span></div>
            <div class="row" style="margin-top:8px">
              <div class="field">
                <div class="label">Name</div>
                <input data-k="name" value="${u.name || ''}" placeholder="Name">
              </div>
              <div class="field">
                <div class="label">Role</div>
                <select data-k="role">
                  <option value="user"   ${u.role==='user'?'selected':''}>user</option>
                  <option value="admin"  ${u.role==='admin'?'selected':''}>admin</option>
                  <option value="device" ${u.role==='device'?'selected':''}>device</option>
                </select>
              </div>
              <div class="field">
                <div class="label">Dealership ID</div>
                <input data-k="dealershipId" value="${u.dealershipId || ''}" placeholder="e.g., GenesisWinnipeg">
              </div>
            </div>
          </div>
          <button class="btn secondary small" data-act="reset">Reset password</button>
          <button class="btn small" data-act="save">Save</button>
        `;
        wrap.appendChild(row);

        const inName  = row.querySelector('input[data-k="name"]');
        const inRole  = row.querySelector('select[data-k="role"]');
        const inDeal  = row.querySelector('input[data-k="dealershipId"]');
        const btnSave = row.querySelector('button[data-act="save"]');
        const btnRes  = row.querySelector('button[data-act="reset"]');

        btnSave.onclick = async ()=>{
          try{
            const patch = {
              name: inName.value.trim(),
              role: inRole.value,
              dealershipId: inDeal.value.trim()
            };
            const dn = dealers[patch.dealershipId]?.name;
            if(dn) patch.dealershipName = dn;
            await update(ref(db, `user/${u.uid}`), patch);
            Object.assign(users[u.uid], patch);
            toast('User saved');
          }catch(e){ console.error(e); toast('Save failed'); }
        };

        btnRes.onclick = async ()=>{
          if(!u.email){ return toast('No email to reset'); }
          try{
            await sendPasswordResetEmail(auth, u.email);
            toast('Reset email sent');
          }catch(e){ console.error(e); toast('Reset failed'); }
        };
      }
    }

    // ------------- Apps / Quick links -------------
    const DEFAULT_APPS = [
      { label:'Gmail', url:'https://mail.google.com/mail/u/0/#inbox' },
      { label:'Outlook', url:'https://outlook.office.com/mail/' },
      { label:'Trello', url:'https://trello.com/b/jHjTIrZG/digital-team' },
      { label:'BSN Cloud', url:'https://app.bsn.cloud/#/dashboard' },
      { label:'Signagelive', url:'https://login.signagelive.com/' },
      { label:'GitHub', url:'https://github.com/flaviothebfagroup/IPTV-' },
      { label:'Firebase Console', url:'https://console.firebase.google.com/project/iptv-bfa/overview' }
    ];

    async function loadApps(){
      try{
        const snap = await get(ref(db,'adminLinks'));
        const extra = snap.exists()? snap.val() : {};
        paintApps([...DEFAULT_APPS, ...Object.values(extra)]);
      }catch(e){
        console.warn('apps', e);
        paintApps(DEFAULT_APPS);
      }
    }

    function paintApps(list){
      const g = $('#appsGrid'); g.innerHTML='';
      list.forEach((app,i)=>{
        const row = document.createElement('div');
        row.innerHTML = `
          <a class="appbtn" href="${app.url}" target="_blank" rel="noopener">
            <span>üîó</span><span class="grow">${app.label}</span>
          </a>
        `;
        g.appendChild(row);
      });

      // also render deletable custom links (load again to know keys)
      get(ref(db,'adminLinks')).then(snap=>{
        if(!snap.exists()) return;
        const extra = snap.val();
        Object.entries(extra).forEach(([key, app])=>{
          const row = document.createElement('div');
          row.innerHTML = `
            <a class="appbtn" href="${app.url}" target="_blank" rel="noopener">
              <span>üß©</span><span class="grow">${app.label}</span>
            </a>
            <button class="x" title="Remove" data-key="${key}">‚úï</button>
          `;
          g.appendChild(row);
        });
        g.querySelectorAll('button.x').forEach(b=>{
          b.onclick = async ()=>{
            await remove(ref(db, 'adminLinks/'+b.dataset.key));
            loadApps();
          };
        });
      }).catch(()=>{});
    }

    document.getElementById('addAppBtn').addEventListener('click', async ()=>{
      const label = $('#appLabel').value.trim();
      const url   = $('#appUrl').value.trim();
      if(!label || !url) return toast('Enter label and URL');
      try{
        const key = Date.now().toString(36);
        await set(ref(db, 'adminLinks/'+key), { label, url, key });
        $('#appLabel').value=''; $('#appUrl').value='';
        loadApps();
        toast('Link added');
      }catch(e){ console.error(e); toast('Add failed'); }
    });

  </script>
</body>
</html>


