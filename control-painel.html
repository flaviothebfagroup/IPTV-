<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>IPTV Remote</title>

  <!-- (optional) PWA bits â€“ safe to keep/remove -->
  <link rel="manifest" href="https://flaviothebfagroup.github.io/IPTV-/manifest.webmanifest">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --bg:#0b0b0c; --fg:#fff; --muted:#9a9aa0; --panel:#121214; --tile:#17171a;
      --border:rgba(255,255,255,.14); --accent:#ff9500; --tileActive:#1d1d21;
      --shadow:0 18px 48px rgba(0,0,0,.45);
    }
    body.light{ --bg:#f5f5f7; --fg:#111; --muted:#6e6e73; --panel:#fff;
      --tile:#f2f2f7; --tileActive:#eaeaef; --border:rgba(0,0,0,.12);
      --shadow:0 14px 36px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro",system-ui,sans-serif;
      display:flex; align-items:center; justify-content:center; padding:20px;
      transition:background .25s,color .25s;
    }

    /* Login */
    .login{width:100%; max-width:420px}
    .logo{width:110px; height:110px; margin:0 auto 18px; background:var(--accent);
      -webkit-mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;
              mask:url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center/contain no-repeat;}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:28px; padding:22px; box-shadow:var(--shadow)}
    .login input{width:100%; padding:14px; margin-bottom:12px; background:transparent; border:1px solid var(--border); border-radius:14px; color:var(--fg); text-align:center; font-size:16px}
    .login input::placeholder{color:var(--muted)}
    .login button{width:100%; padding:14px; background:var(--accent); color:#000; border:none; border-radius:999px; font-size:16px; font-weight:800; cursor:pointer}
    .link{margin-top:12px; text-align:center; color:var(--muted); font-size:14px}
    .link a{color:var(--fg); text-decoration:none; border-bottom:1px dashed var(--border)}

    /* Remote */
    .remote{display:none; width:min(92vw,440px); background:var(--panel); border:1px solid var(--border);
      border-radius:42px; padding:18px 18px 22px; box-shadow:var(--shadow)}
    .hdr{display:grid; grid-template-columns:1fr auto 1fr; align-items:center}
    .pill{justify-self:start; height:34px; padding:0 14px; border-radius:9999px; display:inline-flex; align-items:center; gap:8px; border:1px solid var(--accent); background:transparent; color:var(--accent); font-size:13px; font-weight:700; cursor:pointer}
    .display-name{justify-self:center; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.8px}
    .theme{justify-self:end}
    .rule{height:1px; background:var(--border); margin:12px 0 10px}

    /* Admin selectors */
    .admin-row{display:none; gap:8px; margin:8px 0 10px}
    .admin-row select{
      flex:1; padding:10px 12px; background:var(--tile); color:var(--fg);
      border:1px solid var(--border); border-radius:12px; font-size:14px;
    }

    /* Dial */
    .dial{position:relative; width:min(78vw,360px); aspect-ratio:1/1; margin:0 auto 14px; user-select:none}
    .ring{
      position:absolute; inset:0; border-radius:50%;
      background:radial-gradient(120px 120px at var(--gx,70%) 50%, rgba(255,149,0,.36), rgba(255,149,0,0) 62%),
                 linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)), var(--tile);
      border:1px solid var(--border);
    }
    .center{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:56%; height:56%; border-radius:50%;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), var(--panel);
      border:2px solid var(--accent); display:grid; place-items:center; text-align:center; overflow:hidden;
      cursor:pointer;
    }
    .dial-num{font-size:clamp(68px,12vw,96px); font-weight:800; color:var(--accent); line-height:1}
    .dial-name{font-size:12px; letter-spacing:.6px; color:var(--muted); text-transform:uppercase; margin-top:-4px}
    .nav{
      position:absolute; width:36px; height:36px; display:grid; place-items:center; border-radius:50%;
      background:transparent; border:1px solid var(--border); color:var(--fg); opacity:.7; cursor:pointer;
    }
    .nav.up{left:50%; top:6%; transform:translate(-50%,-50%)}
    .nav.down{left:50%; bottom:6%; transform:translate(-50%,50%)}
    .nav.left{left:6%; top:50%; transform:translate(-50%,-50%)}
    .nav.right{right:6%; top:50%; transform:translate(50%,-50%)}
    .nav:active{transform:scale(.98)}

    /* Grid */
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; padding:10px 6px 6px}
    .tile{
      height:66px; border:1px solid var(--border); border-radius:16px; background:var(--tile); color:var(--fg);
      font-weight:800; font-size:22px; display:flex; align-items:center; justify-content:center; flex-direction:column;
      cursor:pointer; transition:border-color .2s, background .2s, transform .16s;
    }
    .tile span{margin-top:2px; font-size:10px; color:var(--muted); letter-spacing:1px; text-transform:uppercase}
    .tile.active{border-color:var(--accent); background:var(--tileActive); box-shadow:0 0 0 2px rgba(255,149,0,.35), inset 0 0 0 1px var(--accent)}
    .tile:active{transform:translateY(1px)}
    .tile.mute.muted{border-color:#ff453a; color:#ff453a}

    /* Volume */
    .volbar{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px; max-width:340px; margin:8px auto 0}
    .vbtn{width:54px; height:42px; border:1px solid var(--border); border-radius:12px; background:var(--tile); color:var(--fg); font-size:22px; cursor:pointer}
    .track{position:relative; height:14px; border-radius:999px; background:var(--tile); border:1px solid var(--border); overflow:hidden}
    .fill{position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,var(--accent),#ffb866)}

    .toast{position:fixed; top:50px; left:50%; transform:translateX(-50%); background:var(--accent); color:#000; padding:10px 20px; border-radius:999px; font-size:13px; font-weight:700; opacity:0; transition:opacity .25s; pointer-events:none}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div class="login" id="login">
    <div class="logo" aria-label="IPTV logo"></div>
    <div class="card">
      <input id="email" type="email" placeholder="Email" autocomplete="email" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="btnEnter">ENTER</button>
      <div class="link">Forgot password? <a href="https://iptv-bfa.firebaseapp.com/__/auth/action?mode=resetPassword">Reset here</a></div>
    </div>
  </div>

  <!-- REMOTE -->
  <div class="remote" id="remote">
    <div class="hdr">
      <button class="pill" id="btnSignOut">Sign out</button>
      <div class="display-name" id="headerLabel">DISPLAY</div>
      <div class="theme"></div>
    </div>

    <!-- ADMIN SELECTORS -->
    <div class="admin-row" id="adminRow">
      <select id="selDealer"><option>Loading dealersâ€¦</option></select>
      <select id="selDisplay"><option>Loading displaysâ€¦</option></select>
    </div>

    <div class="rule"></div>

    <!-- Dial -->
    <div class="dial" id="dial" style="--gx:70%;">
      <div class="ring" id="ring"></div>

      <button class="nav up"    id="navUp">â–²</button>
      <button class="nav down"  id="navDown">â–¼</button>
      <button class="nav left"  id="navLeft">â—€ï¸Ž</button>
      <button class="nav right" id="navRight">â–¶ï¸Ž</button>

      <div class="center" id="centerBtn" title="Tap to confirm">
        <div>
          <div class="dial-num"  id="dialNumber">1</div>
          <div class="dial-name" id="dialName">News</div>
        </div>
      </div>
    </div>

    <!-- Quick grid -->
    <div class="grid">
      <button class="tile" id="q1"><strong>1</strong><span>News</span></button>
      <button class="tile" id="q2"><strong>2</strong><span>Sports</span></button>
      <button class="tile" id="q3"><strong>3</strong><span>Cooking</span></button>
      <button class="tile" id="q4"><strong>4</strong><span>Nature</span></button>
      <button class="tile" id="q5"><strong>5</strong><span>Kids</span></button>
      <button class="tile mute" id="qMute"><strong>ðŸ”‡</strong><span id="muteLabel">Mute</span></button>
    </div>

    <!-- Volume -->
    <div class="volbar">
      <button class="vbtn" id="vMinus">âˆ’</button>
      <div class="track"><div class="fill" id="vFill"></div></div>
      <button class="vbtn" id="vPlus">+</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth, setPersistence, browserLocalPersistence,
      signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getDatabase, ref, get, set, update, onValue, off
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    setPersistence(auth, browserLocalPersistence).catch(()=>{});

    // ---------- UI helpers ----------
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const toast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1400); };

    // Theme sync (optional)
    const savedTheme = localStorage.getItem('iptv_theme') || 'light';
    document.body.classList.toggle('light', savedTheme==='light');

    // ---------- State ----------
    const CHANNELS = {1:"News",2:"Sports",3:"Cooking",4:"Nature",5:"Kids"};
    let profile   = null;            // user profile {role, dealershipId, ...}
    let isAdmin   = false;
    let dealerId  = null;            // current dealership being controlled
    let displayId = null;            // current display
    let unsub     = null;            // current onValue unsubscribe

    let focusCh = 1;                 // highlighted number on dial
    let currentCh = 1;               // committed channel (what display has)
    let volume = 50, muted = false;

    // ---------- Login ----------
    async function doSignIn(){
      const email = $("#email").value.trim();
      const pass  = $("#password").value;
      if(!email || !pass){ toast("Enter email & password"); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        console.error(e); toast("Login failed");
      }
    }
    $("#btnEnter").addEventListener('click', doSignIn);
    $("#email").addEventListener('keydown', e=>{ if(e.key==='Enter') doSignIn(); });
    $("#password").addEventListener('keydown', e=>{ if(e.key==='Enter') doSignIn(); });

    $("#btnSignOut").addEventListener('click', ()=>signOut(auth));

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        $("#login").style.display='block';
        $("#remote").style.display='none';
        if(unsub) { unsub(); unsub=null; }
        return;
      }
      $("#login").style.display='none';
      $("#remote").style.display='block';

      // load profile (singular path)
      const ps = await get(ref(db, `user/${user.uid}`));
      profile  = ps.exists() ? ps.val() : {};
      isAdmin  = (profile.role === 'admin');
      dealerId = profile.dealershipId || null;

      $("#adminRow").style.display = isAdmin ? 'flex' : 'none';

      if(isAdmin){
        await loadDealersForAdmin();
      }else{
        $("#headerLabel").textContent = "DISPLAY";
        await loadDisplaysForDealer(dealerId);
      }
    });

    // ---------- Admin: load dealers + displays ----------
    async function loadDealersForAdmin(){
      const selD = $("#selDealer");
      selD.innerHTML = `<option value="">Choose dealershipâ€¦</option>`;

      // Primary: /dealership, Fallback: /dealershipPublic
      let snap = await get(ref(db, "dealership"));
      let list = [];
      if(snap.exists()){
        const v = snap.val();
        list = Object.keys(v).map(id => ({ id, name: v[id]?.name || id }));
      }else{
        const p = await get(ref(db, "dealershipPublic"));
        if(p.exists()){
          const v = p.val();
          list = Object.keys(v).map(id => {
            const node = v[id];
            return typeof node === 'string' ? ({id, name: node}) : ({id, name: node?.name || id});
          });
        }
      }
      list.sort((a,b)=>a.name.localeCompare(b.name));
      list.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = d.name;
        selD.appendChild(opt);
      });

      selD.onchange = async ()=>{
        dealerId = selD.value || null;
        await loadDisplaysForDealer(dealerId);
      };

      // preselect previous choice
      if(dealerId && list.find(x=>x.id===dealerId)){ selD.value = dealerId; }
      else if(list.length){ dealerId = list[0].id; selD.value = dealerId; }
      await loadDisplaysForDealer(dealerId);
    }

    async function loadDisplaysForDealer(did){
      const selX = $("#selDisplay");
      selX.innerHTML = `<option value="">Loadingâ€¦</option>`;

      let ids = [];

      // Prefer listing from /displays filtered by dealership (works for admin & users)
      const snap = await get(ref(db, "displays"));
      if(snap.exists()){
        const all = snap.val();
        ids = Object.keys(all).filter(id => all[id]?.dealership === did);
      }

      // Fallback for regular users if empty: from /dealership/{id}/displays
      if(!ids.length){
        const ds = await get(ref(db, `dealership/${did}/displays`));
        if(ds.exists()) ids = Object.keys(ds.val() || {});
      }

      // paint dropdown or tell user
      selX.innerHTML = "";
      if(!ids.length){
        const o = document.createElement('option');
        o.value = ""; o.textContent = "No TVs found";
        selX.appendChild(o);
        $("#headerLabel").textContent = "DISPLAY";
        return;
      }
      ids.sort();
      ids.forEach(id=>{
        const o = document.createElement('option');
        o.value = id; o.textContent = id;
        selX.appendChild(o);
      });

      selX.onchange = ()=> switchDisplay(selX.value);
      // pick last used or first
      const saved = localStorage.getItem('iptv_last_display');
      if(saved && ids.includes(saved)){ selX.value = saved; await switchDisplay(saved); }
      else { selX.value = ids[0]; await switchDisplay(ids[0]); }
    }

    async function switchDisplay(id){
      if(!id) return;
      displayId = id;
      localStorage.setItem('iptv_last_display', id);
      $("#headerLabel").textContent = id;

      if(unsub){ unsub(); unsub=null; }
      const r = ref(db, `displays/${id}`);
      const offFn = onValue(r, (s)=>{
        const v = s.val() || {};
        if(typeof v.channel === 'number'){ currentCh = v.channel; focusCh = v.channel; paintDial(); }
        if(typeof v.volume  === 'number'){ volume = v.volume; paintVolume(); }
        if(typeof v.muted   === 'boolean'){ muted = v.muted; paintMute(); }
      }, (err)=>{ console.warn('read error', err); toast('Disconnected'); });
      unsub = ()=>{ off(r); offFn(); };
    }

    // ---------- Paint helpers ----------
    function paintDial(){
      $("#dialNumber").textContent = focusCh;
      $("#dialName").textContent   = CHANNELS[focusCh] || `Channel ${focusCh}`;
      // tiles
      for(let i=1;i<=5;i++){
        $("#q"+i).classList.toggle('active', i===focusCh);
      }
      // move glow
      const x = 14 + (focusCh-1)*18; // 14% .. 86%
      $("#dial").style.setProperty('--gx', x+'%');
    }
    function paintVolume(){ $("#vFill").style.width = volume + "%"; }
    function paintMute(){
      $("#qMute").classList.toggle('muted', muted);
      $("#muteLabel").textContent = muted ? "Muted" : "Mute";
    }

    // ---------- Focus & Commit ----------
    function move(delta){
      const next = Math.max(1, Math.min(5, focusCh + delta));
      if(next !== focusCh){ focusCh = next; paintDial(); }
    }
    function commit(){
      if(!displayId) { toast("Select a TV"); return; }
      currentCh = focusCh;
      const state = { channel: currentCh, volume, muted, timestamp: Date.now() };
      // Never change dealership in writes
      update(ref(db, `displays/${displayId}`), state).catch(e=>{
        console.error(e); toast("Update denied");
      });
      toast(`CH ${currentCh}`);
    }

    // arrows
    $("#navLeft").addEventListener('click',  ()=>move(-1));
    $("#navRight").addEventListener('click', ()=>move(+1));
    $("#navUp").addEventListener('click',    ()=>move(-1));
    $("#navDown").addEventListener('click',  ()=>move(+1));
    // center commit
    $("#centerBtn").addEventListener('click', commit);

    // swipe on ring
    (function(){
      const ring = $("#ring");
      let sx=0, sy=0, tracking=false;
      ring.addEventListener('pointerdown', (e)=>{ tracking=true; sx=e.clientX; sy=e.clientY; ring.setPointerCapture(e.pointerId); });
      ring.addEventListener('pointerup', (e)=>{ if(!tracking) return; tracking=false;
        const dx=e.clientX-sx, dy=e.clientY-sy;
        if(Math.abs(dx)>Math.abs(dy)){
          if(Math.abs(dx)>24) move(dx>0?+1:-1);
        }else{
          if(Math.abs(dy)>24) move(dy<0?-1:+1);
        }
      });
      ring.addEventListener('pointercancel', ()=>tracking=false);
    })();

    // tiles
    for(let i=1;i<=5;i++){ $("#q"+i).addEventListener('click', ()=>{ focusCh=i; paintDial(); commit(); }); }
    $("#qMute").addEventListener('click', ()=>{ muted=!muted; paintMute(); commitVolumeOnly(); });

    // volume
    $("#vPlus").addEventListener('click', ()=>{ volume=Math.min(100,volume+10); paintVolume(); commitVolumeOnly(); });
    $("#vMinus").addEventListener('click', ()=>{ volume=Math.max(0,volume-10); paintVolume(); commitVolumeOnly(); });
    function commitVolumeOnly(){
      if(!displayId) { toast("Select a TV"); return; }
      const body = { volume, muted, timestamp: Date.now() };
      update(ref(db, `displays/${displayId}`), body).catch(()=>toast("Update denied"));
    }

    // initial paint
    paintDial(); paintVolume(); paintMute();
  </script>
</body>
</html>
