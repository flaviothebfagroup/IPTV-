<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>IPTV Remote — Dealership Scoped (5 Channels)</title>

  <!-- PWA -->
  <link rel="manifest" href="/IPTV-/manifest.webmanifest">
  <meta name="theme-color" content="#000000" />
  <link rel="icon" type="image/png" sizes="192x192" href="/IPTV-/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/IPTV-/icons/icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/IPTV-/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="IPTV Remote">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    /* ===== Design tokens (Liquid Glass, Apple-like) ===== */
    :root {
      --bg: #0b0b0c;           /* page background */
      --fg: #ffffff;           /* foreground text */
      --muted: #a1a1a6;        /* secondary text */
      --panel: #111214e6;      /* translucent panel */
      --border: rgba(255,255,255,0.09);
      --line: rgba(255,255,255,0.14); /* inner hairline */
      --btn: rgba(255,255,255,0.08);
      --btn-active: rgba(255,255,255,0.16);
      --accent: #ff9500;       /* Apple orange */
      --shadow: none;
      --blur: 16px;
      --radius-lg: 56px;       /* remote shell */
      --radius-md: 22px;       /* cards/buttons */
      --space: 16px;           /* 8pt grid */
    }
    body.light {
      --bg: #f5f5f7;
      --fg: #111111;
      --muted: #6e6e73;
      --panel: #ffffffee;
      --border: rgba(0,0,0,0.06);
      --line: rgba(0,0,0,0.08);
      --btn: #f2f2f7;
      --btn-active: #e5e5ea;
      --accent: #ff7a00;
      --shadow: none;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; transition: background .25s, color .25s; }

    /* ===== Login ===== */
    .login { width: 100%; max-width: 360px; text-align: center; }
    .logo { width: 110px; height: 110px; margin: 0 auto 18px; display: block; filter: none; }
    .logo.mono { background: var(--accent); -webkit-mask: url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center / contain no-repeat; mask: url('https://i.ibb.co/LzJwPhjg/ICON-IPTV.png') center / contain no-repeat; }
    .login .card { background: var(--panel); border: 1px solid var(--border); border-radius: 28px; padding: 22px 22px 18px; box-shadow: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
    .login input { width: 100%; padding: 16px; margin-bottom: 14px; background: var(--btn); border: 1px solid var(--border); border-radius: 14px; color: var(--fg); font-size: 16px; text-align: center; }
    .login input::placeholder { color: var(--muted); }
    .login button { width: 100%; padding: 14px; background: var(--accent); color: #000; border: none; border-radius: 999px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: none; }
    .link { margin-top: 12px; font-size: 14px; color: var(--muted); }
    .link a { color: var(--fg); text-decoration: none; border-bottom: 1px dashed var(--border); }

    /* ===== Remote shell ===== */
    .remote { display: none; width: 100%; max-width: clamp(320px, 92vw, 440px); background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; box-shadow: none; position: relative; backdrop-filter: none; -webkit-backdrop-filter: none; }
    .remote.active { display: block; }

    .power { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .pill { height: 36px; padding: 0 16px; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid var(--border); background: var(--btn); color: var(--fg); font-size: 13px; font-weight: 600; backdrop-filter: none; }
    .pill.danger { background: #ff453a; color: #fff; border-color: #ff453a; }
    .display-name { font-size: 14px; color: var(--muted); cursor: pointer; }

    /* ===== Screen (Liquid Glass) ===== */
    .screen { position: relative; background: var(--panel); border: 1px solid var(--border); border-radius: 32px; padding: 24px; margin: 12px 0 18px; text-align: center; overflow: hidden; }
    .screen:before { display: none; }
    .screen:after { display: none; }
    .channel-number { font-size: 52px; font-weight: 700; line-height: 1; color: var(--accent); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace; text-shadow: none; }
    .channel-title { font-size: 12px; color: var(--muted); margin-top: 8px; letter-spacing: 1.2px; text-transform: uppercase; }

    /* ===== Keypad (5 channels + theme tile bottom-right) ===== */
    .numpad { display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: 1fr; gap: 14px; margin-bottom: 20px; align-items: stretch; justify-items: stretch; }
    .num-btn { aspect-ratio: 1.4; background: var(--btn); border: 1px solid var(--border); border-radius: 9999px; color: var(--fg); font-size: 24px; font-weight: 900; cursor: pointer; position: relative; transition: transform .08s ease, background .2s, border-color .2s, color .2s; backdrop-filter: none; -webkit-backdrop-filter: none; }
    .num-btn:before { display: none; }
    .num-btn:active { transform: translateY(1px); background: var(--btn-active); }
    .num-btn span { display: block; font-size: 10px; margin-top: 4px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .num-btn.active { background: var(--btn-active); color: var(--fg); border-color: var(--accent); box-shadow: none; }

    /* Theme tile in old #6 slot */
    .num-btn.theme { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; }
    .num-btn.theme .icon-row { display:flex; align-items:center; justify-content:center; gap:8px; }
    .num-btn.theme .icon { font-size:22px; line-height:1; }
    /* show Sun in light mode (on), Moon in dark mode */
    #tile-theme .icon.sun { display:none; }
    #tile-theme .icon.moon { display:inline-block; }
    #tile-theme.on .icon.sun { display:inline-block; }
    #tile-theme.on .icon.moon { display:none; }
    .num-btn.theme .label { font-size:10px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }

    /* ===== Controls ===== */
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 8px; }
    .control-group { text-align: center; }
    .control-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 8px; }
    .control-btns { display: flex; flex-direction: column; gap: 10px; }
    .ctrl-btn { padding: 14px; background: var(--btn); border: 1px solid var(--border); border-radius: 9999px; color: var(--fg); font-size: 24px; cursor: pointer; transition: background .2s, border-color .2s; backdrop-filter: none; }
    .ctrl-btn:active { background: var(--btn-active); transform: translateY(1px); }

    /* ===== Mute ===== */
    .mute-btn { width: 100%; padding: 14px; background: var(--btn); border: 1px solid var(--border); border-radius: 9999px; color: var(--fg); font-size: 13px; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; margin-top: 6px; backdrop-filter: none; box-shadow: none; }
    .mute-btn.muted { background: #ff453a; border-color: #ff453a; color: #fff; }

    /* ===== Display selector ===== */
    .displays { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; background: rgba(20,20,22,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 28px; opacity: 0; pointer-events: none; transition: opacity .25s; box-shadow: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
    .displays.show { opacity: 1; pointer-events: all; }
    .display-btn { padding: 8px 14px; background: var(--btn); border: 1px solid var(--border); border-radius: 9999px; color: var(--fg); font-size: 12px; cursor: pointer; }
    .display-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

    /* ===== Toast ===== */
    .toast { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 10px 20px; border-radius: 999px; font-size: 13px; font-weight: 700; opacity: 0; transition: opacity .25s; pointer-events: none; box-shadow: none; }
    .toast.show { opacity: 1; }

    /* ===== Accessibility & Motion ===== */
    .num-btn, .ctrl-btn, .mute-btn, .display-btn { outline: none; }
    .num-btn:focus-visible, .ctrl-btn:focus-visible, .mute-btn:focus-visible, .display-btn:focus-visible { box-shadow: 0 0 0 3px rgba(255,149,0,0.35); }
    @media (hover:hover) { .num-btn:hover, .ctrl-btn:hover, .display-btn:hover { border-color: var(--accent); } }
    @media (prefers-reduced-motion: reduce) { * { transition: none !important; } }
    /* Tweaks: rounder UI + mobile responsiveness */
    .display-btn { border-radius: 999px; }

    @media (max-width: 480px) {
      body { padding: 16px; }
      .remote { padding: 18px; }
      .screen { padding: 18px; border-radius: 32px; }
      .channel-number { font-size: 44px; }
      .numpad { gap: 12px; }
      .num-btn { aspect-ratio: 1.25; font-size: 22px; border-radius: 9999px; }
      .ctrl-btn { padding: 12px; font-size: 22px; border-radius: 9999px; }
      .mute-btn { padding: 12px; border-radius: 9999px; }
    }
      .remote { padding: 18px; }
      .screen { padding: 18px; border-radius: 28px; }
      .channel-number { font-size: 44px; }
      .numpad { gap: 12px; }
      .num-btn { aspect-ratio: 1.25; font-size: 22px; border-radius: 24px; }
      .ctrl-btn { padding: 12px; font-size: 22px; }
      .mute-btn { padding: 12px; }
    }

    @media (max-width: 360px) {
      .remote { max-width: 96vw; }
      .num-btn { aspect-ratio: 1.2; font-size: 20px; }
    }
      .num-btn { aspect-ratio: 1.2; font-size: 20px; }
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="login" id="login">
    <div class="logo mono" role="img" aria-label="IPTV logo"></div>
    <div class="card">
      <input type="email" id="email" placeholder="Email" autocomplete="email" />
      <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
      <button onclick="signIn()">ENTER</button>
      <div class="link">Don’t have an account? <a href="https://flaviothebfagroup.github.io/IPTV-/signup.html">Create your account</a></div>
    </div>
  </div>

  <!-- Remote -->
  <div class="remote" id="remote">
    <div class="power">
      <button class="pill danger" onclick="powerOff()">Sign out</button>
      <div class="display-name" id="currentDisplay" onclick="showDisplays()">DISPLAY</div>
    </div>

    <div class="screen">
      <div class="channel-number" id="channelDisplay">1</div>
      <div class="channel-title" id="channelTitle">News</div>
    </div>

    <!-- First 5 channels + theme tile in bottom-right (old #6 spot) -->
    <div class="numpad">
      <button class="num-btn" id="btn-ch-1" onclick="setChannel(1)">1<span>News</span></button>
      <button class="num-btn" id="btn-ch-2" onclick="setChannel(2)">2<span>Sports</span></button>
      <button class="num-btn" id="btn-ch-3" onclick="setChannel(3)">3<span>Cooking</span></button>
      <button class="num-btn" id="btn-ch-4" onclick="setChannel(4)">4<span>Nature</span></button>
      <button class="num-btn" id="btn-ch-5" onclick="setChannel(5)">5<span>Kids</span></button>
      <!-- Theme toggle tile -->
      <button class="num-btn theme" id="tile-theme" aria-pressed="false" onclick="toggleThemeTile()">
        <div class="icon-row">
          <span class="icon sun">☀️</span>
          <span class="icon moon">🌙</span>
        </div>
        <span class="label" id="modeLabel">Dark</span>
      </button>
    </div>

    <div class="controls">
      <div class="control-group">
        <div class="control-label">VOL</div>
        <div class="control-btns">
          <button class="ctrl-btn" onclick="volUp()">+</button>
          <button class="ctrl-btn" onclick="volDown()">−</button>
        </div>
      </div>
      <div class="control-group">
        <div class="control-label">CH</div>
        <div class="control-btns">
          <button class="ctrl-btn" onclick="chUp()">▲</button>
          <button class="ctrl-btn" onclick="chDown()">▼</button>
        </div>
      </div>
    </div>

    <button class="mute-btn" id="muteBtn" onclick="toggleMute()">MUTE</button>
  </div>

  <!-- Display selector -->
  <div class="displays" id="displays"></div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBLSRS9PELXoI0wRafYKG5tx_UoRSawQaY",
      authDomain: "iptv-bfa.firebaseapp.com",
      databaseURL: "https://iptv-bfa-default-rtdb.firebaseio.com",
      projectId: "iptv-bfa",
      storageBucket: "iptv-bfa.firebasestorage.app",
      messagingSenderId: "838790935867",
      appId: "1:838790935867:web:1860eac7dbeb7159e1b31e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- State (declare early) ---
    let dealershipId = null;
    let displayIds = [];
    let currentDisplay = null;
    let currentChannel = 1;
    let volume = 50;
    let muted = false;

    // Channel labels
    const CHANNELS = { 1: 'News', 2: 'Sports', 3: 'Cooking', 4: 'Nature', 5: 'Kids' };

    // --- Theme (tile) init ---
    const savedTheme = localStorage.getItem('iptv_theme') || 'dark';
    if (savedTheme === 'light') document.body.classList.add('light');
    initThemeTile();

    function initThemeTile(){
      const tile = document.getElementById('tile-theme');
      if (!tile) return;
      const isLight = document.body.classList.contains('light');
      tile.classList.toggle('on', isLight);
      tile.setAttribute('aria-pressed', isLight ? 'true' : 'false');
      const label = document.getElementById('modeLabel');
      if (label) label.textContent = isLight ? 'Light' : 'Dark';
    }

    window.toggleThemeTile = function(){
      haptic();
      const isLight = !document.body.classList.contains('light');
      applyTheme(isLight);
    }

    function applyTheme(isLight){
      document.body.classList.toggle('light', isLight);
      localStorage.setItem('iptv_theme', isLight ? 'light' : 'dark');
      const tile = document.getElementById('tile-theme');
      if (tile){ tile.classList.toggle('on', isLight); tile.setAttribute('aria-pressed', isLight ? 'true' : 'false'); }
      const label = document.getElementById('modeLabel');
      if (label) label.textContent = isLight ? 'Light' : 'Dark';
      toast(isLight ? 'White mode' : 'Dark mode');
    }

    // --- UI helpers ---
    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
    function haptic(){ if (navigator.vibrate){ try{ navigator.vibrate(12); }catch(e){} } }

    function highlightSelectedChannel(){
      for (let i=1;i<=5;i++){
        const b=document.getElementById('btn-ch-'+i);
        if (b){
          const on = (i===currentChannel);
          b.classList.toggle('active', on);
          b.setAttribute('aria-pressed', on ? 'true' : 'false');
        }
      }
    }

    // set initial title & highlight
    document.getElementById('channelTitle').textContent = CHANNELS[currentChannel];
    highlightSelectedChannel();

    // --- Auth ---
    window.signIn = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try { await signInWithEmailAndPassword(auth, email, password); }
      catch (e) { console.error(e); toast('Invalid login'); }
    };

    window.powerOff = () => { signOut(auth); };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('remote').classList.add('active');
        await afterLogin(user);
      } else {
        document.getElementById('login').style.display = 'block';
        document.getElementById('remote').classList.remove('active');
        document.getElementById('displays').innerHTML = '';
        document.getElementById('currentDisplay').textContent = 'DISPLAY';
        currentDisplay = null;
      }
    });

    // --- After login: load dealership TVs ---
    async function afterLogin(user){
      const uSnap = await get(ref(db, `user/${user.uid}`));
      const u = uSnap.val() || {};
      dealershipId = u.dealershipId ?? u.dealership; // fallback
      if (!dealershipId) { toast('No dealership assigned'); return; }

      onValue(ref(db, `dealership/${dealershipId}/displays`), (snap) => {
        const map = snap.val() || {};
        displayIds = Object.keys(map).filter(k => map[k]);
        renderDisplayButtons(displayIds);
        if (!currentDisplay || !displayIds.includes(currentDisplay)) {
          currentDisplay = displayIds[0] || null;
          document.getElementById('currentDisplay').textContent = currentDisplay || 'NO TV';
        }
      });
    }

    function renderDisplayButtons(ids){
      const wrap = document.getElementById('displays');
      wrap.innerHTML = '';
      ids.forEach((id) => {
        const btn = document.createElement('button');
        btn.className = 'display-btn' + (id === currentDisplay ? ' active' : '');
        btn.textContent = id;
        btn.onclick = () => switchDisplay(id, btn);
        wrap.appendChild(btn);
      });
    }

    window.showDisplays = () => {
      const displays = document.getElementById('displays');
      displays.classList.add('show');
      setTimeout(() => displays.classList.remove('show'), 3000);
    };

    window.switchDisplay = (id, btn) => {
      currentDisplay = id;
      document.getElementById('currentDisplay').textContent = id;
      document.querySelectorAll('.display-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      document.getElementById('displays').classList.remove('show');
      toast(id);
    };

    // --- Channel & volume ---
    window.setChannel = async (ch) => {
      haptic();
      currentChannel = ch;
      document.getElementById('channelDisplay').textContent = ch;
      document.getElementById('channelTitle').textContent = CHANNELS[ch] || `Channel ${ch}`;
      highlightSelectedChannel();
      await updateDisplay();
      toast(`CH ${ch}`);
    };

    window.chUp = () => { if (!displayIds.length) return; currentChannel = currentChannel >= 5 ? 1 : currentChannel + 1; window.setChannel(currentChannel); };
    window.chDown = () => { if (!displayIds.length) return; currentChannel = currentChannel <= 1 ? 5 : currentChannel - 1; window.setChannel(currentChannel); };

    window.volUp = async () => { if (!displayIds.length) return; haptic(); volume = Math.min(100, volume + 10); await updateDisplay(); toast(`VOL ${volume}`); };
    window.volDown = async () => { if (!displayIds.length) return; haptic(); volume = Math.max(0, volume - 10); await updateDisplay(); toast(`VOL ${volume}`); };

    window.toggleMute = async () => { if (!displayIds.length) return; haptic(); muted = !muted; document.getElementById('muteBtn').classList.toggle('muted', muted); await updateDisplay(); toast(muted ? 'MUTED' : 'UNMUTED'); };

    async function updateDisplay(){
      if (!currentDisplay) { toast('Select a TV'); return; }
      const state = { channel: currentChannel, volume, muted, timestamp: Date.now() };
      await set(ref(db, `displays/${currentDisplay}`), state);
    }

    // Enter to login
    document.getElementById('password').addEventListener('keypress', (e) => { if (e.key === 'Enter') signIn(); });

    // ===== Runtime self-tests (debug) =====
    (function selfTest(){
      try {
        console.assert(typeof window.signIn === 'function', 'signIn should be defined');
        console.assert(typeof window.toggleThemeTile === 'function', 'toggleThemeTile should be defined');
        console.assert(typeof CHANNELS[1] === 'string' && typeof CHANNELS[5] === 'string', 'CHANNELS labels exist');
        console.assert(document.getElementById('tile-theme'), 'Theme tile exists');
        console.assert(document.getElementById('modeLabel'), 'Theme label exists');
        console.log('%cRemote UI self-test passed','color:#0f0');
      } catch (err) {
        console.error('Self-test failed', err);
      }
    })();
  </script>
</body>
</html>
